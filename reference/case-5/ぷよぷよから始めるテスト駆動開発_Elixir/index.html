
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="テスト駆動開発の手法を用いてPhoenix LiveViewでぷよぷよゲームを実装する過程を解説">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発 (Elixir Phoenix LiveView版) - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#elixir-phoenix-liveview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発 (Elixir Phoenix LiveView版)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="elixir-phoenix-liveview">ぷよぷよから始めるテスト駆動開発 (Elixir Phoenix LiveView版)<a class="headerlink" href="#elixir-phoenix-liveview" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、Elixir Phoenix LiveViewでぷよぷよゲームを作っていきましょう。</p>
<blockquote>
<p>テスト駆動開発とは、プログラミングの手法の一種で、「テストファースト」の原則に従い、実装前にテストを書くことで、コードの品質を高め、設計を改善していく開発手法です。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方、そしてPhoenix LiveViewの強力な機能を学んでいきます。</p>
<h3 id="phoenix-liveview">なぜPhoenix LiveViewなのか？<a class="headerlink" href="#phoenix-liveview" title="Permanent link">&para;</a></h3>
<p>Phoenix LiveViewは、リアルタイムでインタラクティブなWebアプリケーションを、JavaScriptをほとんど書かずに実装できるフレームワークです。以下の特徴があります：</p>
<ul>
<li><strong>リアルタイム性</strong>: WebSocketを使った双方向通信</li>
<li><strong>サーバーサイドレンダリング</strong>: サーバー側でHTMLを生成し、差分のみをクライアントに送信</li>
<li><strong>状態管理の簡潔さ</strong>: サーバー側で状態を管理するため、クライアント側の複雑な状態管理が不要</li>
<li><strong>高パフォーマンス</strong>: Elixirの並行処理とErlang VMの力</li>
<li><strong>テストのしやすさ</strong>: サーバーサイドロジックとして統一的にテスト可能</li>
</ul>
<p>ぷよぷよのようなゲームは、状態の更新が頻繁に発生します。LiveViewのリアルタイム性と状態管理の簡潔さは、このようなアプリケーションに最適です。</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発では、以下の3つのステップを繰り返すサイクルで開発を進めます：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます</li>
<li><strong>Green（緑）</strong>: テストが通るように、最小限のコードを実装します</li>
<li><strong>Refactor（リファクタリング）</strong>: コードの品質を改善します</li>
</ol>
<blockquote>
<p>テスト駆動開発のリズム：赤、緑、リファクタリング。まず失敗するテストを書き（赤）、次にテストが通るようにする（緑）、そして重複を除去する（リファクタリング）。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h2 id="0">イテレーション0: プロジェクトのセットアップ<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>テスト駆動開発を始める前に、まず開発環境を整えましょう。このイテレーションでは、Phoenix LiveViewプロジェクトをセットアップし、開発に必要なツールを準備します。</p>
<h3 id="_3">前提条件<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>以下のツールがインストールされていることを確認してください：</p>
<ul>
<li><strong>Elixir 1.14以上</strong>: <code>elixir --version</code>で確認</li>
<li><strong>Erlang/OTP 25以上</strong>: <code>erl -version</code>で確認</li>
<li><strong>PostgreSQL</strong>: データベースとして使用（開発用）</li>
<li><strong>Node.js</strong>: アセット管理に使用</li>
</ul>
<h3 id="1-phoenix">ステップ1: Phoenixプロジェクトの作成<a class="headerlink" href="#1-phoenix" title="Permanent link">&para;</a></h3>
<p>まず、Phoenix Frameworkのインストーラーをインストールします：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Phoenixインストーラーのインストール</span>
mix<span class="w"> </span>archive.install<span class="w"> </span>hex<span class="w"> </span>phx_new
</code></pre></div>
<p>次に、新しいPhoenixプロジェクトを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトの作成</span>
mix<span class="w"> </span>phx.new<span class="w"> </span>puyo_puyo<span class="w"> </span>--live

<span class="c1"># プロジェクトディレクトリに移動</span>
<span class="nb">cd</span><span class="w"> </span>puyo_puyo

<span class="c1"># 依存関係のインストール</span>
mix<span class="w"> </span>deps.get

<span class="c1"># データベースのセットアップ</span>
mix<span class="w"> </span>ecto.setup
</code></pre></div>
<p><strong>オプションの説明</strong>:
- <code>--live</code>: LiveViewのサポートを含めたプロジェクトを生成します</p>
<h3 id="2">ステップ2: プロジェクト構成の確認<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>作成されたプロジェクトの構成を確認しましょう：</p>
<div class="highlight"><pre><span></span><code>puyo_puyo/
├── assets/              # フロントエンドアセット (CSS, JS)
├── config/              # 設定ファイル
│   ├── config.exs       # 共通設定
│   ├── dev.exs          # 開発環境設定
│   ├── prod.exs         # 本番環境設定
│   └── test.exs         # テスト環境設定
├── lib/
│   ├── puyo_puyo/       # アプリケーションロジック
│   │   ├── application.ex
│   │   ├── repo.ex      # Ectoリポジトリ
│   │   └── ...
│   └── puyo_puyo_web/   # Webレイヤー
│       ├── components/  # Phoenixコンポーネント
│       ├── controllers/ # コントローラー
│       ├── live/        # LiveViewモジュール
│       ├── endpoint.ex  # HTTPエンドポイント
│       ├── router.ex    # ルーティング
│       └── ...
├── priv/
│   └── repo/
│       └── migrations/  # データベースマイグレーション
├── test/                # テストファイル
│   ├── puyo_puyo/
│   ├── puyo_puyo_web/
│   ├── support/
│   └── test_helper.exs
├── mix.exs              # プロジェクト定義と依存関係
└── mix.lock             # 依存関係のロックファイル
</code></pre></div>
<h3 id="3">ステップ3: 開発ツールの追加<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p>プロジェクトに開発支援ツールを追加します。<code>mix.exs</code>を編集して、依存関係を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.MixProject</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Mix.Project</span>

<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">[</span>
<span class="w">      </span><span class="ss">app</span><span class="p">:</span><span class="w"> </span><span class="ss">:puyo_puyo</span><span class="p">,</span>
<span class="w">      </span><span class="ss">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="ss">elixir</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.14&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="ss">elixirc_paths</span><span class="p">:</span><span class="w"> </span><span class="n">elixirc_paths</span><span class="p">(</span><span class="nc">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">()),</span>
<span class="w">      </span><span class="ss">start_permanent</span><span class="p">:</span><span class="w"> </span><span class="nc">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:prod</span><span class="p">,</span>
<span class="w">      </span><span class="ss">aliases</span><span class="p">:</span><span class="w"> </span><span class="n">aliases</span><span class="p">(),</span>
<span class="w">      </span><span class="ss">deps</span><span class="p">:</span><span class="w"> </span><span class="n">deps</span><span class="p">(),</span>

<span class="w">      </span><span class="c1"># テストカバレッジの設定</span>
<span class="w">      </span><span class="ss">test_coverage</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="ss">tool</span><span class="p">:</span><span class="w"> </span><span class="nc">ExCoveralls</span><span class="p">],</span>
<span class="w">      </span><span class="ss">preferred_cli_env</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="ss">coveralls</span><span class="p">:</span><span class="w"> </span><span class="ss">:test</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;coveralls.detail&quot;</span><span class="p">:</span><span class="w"> </span><span class="ss">:test</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;coveralls.html&quot;</span><span class="p">:</span><span class="w"> </span><span class="ss">:test</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 省略...</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">deps</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:phoenix</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.7.10&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:phoenix_ecto</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 4.4&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:ecto_sql</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 3.10&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:postgrex</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&gt;= 0.0.0&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:phoenix_html</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 3.3&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:phoenix_live_reload</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="ss">:dev</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:phoenix_live_view</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.20.1&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:floki</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&gt;= 0.30.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="ss">:test</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:phoenix_live_dashboard</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.8.2&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:esbuild</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.8&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">runtime</span><span class="p">:</span><span class="w"> </span><span class="nc">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:dev</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:tailwind</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.2.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">runtime</span><span class="p">:</span><span class="w"> </span><span class="nc">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:dev</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:swoosh</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.3&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:finch</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.13&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:telemetry_metrics</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.6&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:telemetry_poller</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.0&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:gettext</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.20&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:jason</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.2&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:dns_cluster</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.1.1&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:plug_cowboy</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 2.5&quot;</span><span class="p">},</span>

<span class="w">      </span><span class="c1"># 開発・テストツール</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:credo</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.7&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="ss">:dev</span><span class="p">,</span><span class="w"> </span><span class="ss">:test</span><span class="p">],</span><span class="w"> </span><span class="ss">runtime</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:excoveralls</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.18&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="ss">:test</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:mix_test_watch</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="ss">:dev</span><span class="p">,</span><span class="w"> </span><span class="ss">:test</span><span class="p">],</span><span class="w"> </span><span class="ss">runtime</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:dialyxir</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.4&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="ss">:dev</span><span class="p">],</span><span class="w"> </span><span class="ss">runtime</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 省略...</span>
<span class="k">end</span>
</code></pre></div>
<p><strong>追加したツール</strong>:
- <strong>Credo</strong>: 静的コード解析ツール（コードの品質チェック）
- <strong>ExCoveralls</strong>: テストカバレッジツール（どれだけテストされているかを測定）
- <strong>mix_test_watch</strong>: ファイル監視ツール（ファイル変更時に自動テスト実行）
- <strong>Dialyxir</strong>: 型解析ツール（型エラーの検出）</p>
<p>依存関係をインストールします：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>deps.get
</code></pre></div>
<h3 id="4-credo">ステップ4: Credoの設定<a class="headerlink" href="#4-credo" title="Permanent link">&para;</a></h3>
<p>Credoの設定ファイルを生成し、プロジェクトのコーディング規約を設定します：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>credo<span class="w"> </span>gen.config
</code></pre></div>
<p>生成された <code>.credo.exs</code> ファイルで、プロジェクトに合わせたルールを調整できます。デフォルトの設定でも十分に機能します。</p>
<h3 id="5">ステップ5: コードフォーマッタの設定<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<p>Elixirには標準で <code>mix format</code> が含まれています。<code>.formatter.exs</code> ファイルで設定を確認します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .formatter.exs</span>
<span class="p">[</span>
<span class="w">  </span><span class="ss">import_deps</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="ss">:ecto</span><span class="p">,</span><span class="w"> </span><span class="ss">:ecto_sql</span><span class="p">,</span><span class="w"> </span><span class="ss">:phoenix</span><span class="p">],</span>
<span class="w">  </span><span class="ss">subdirectories</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;priv/*/migrations&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="ss">plugins</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nc">Phoenix.LiveView.HTMLFormatter</span><span class="p">],</span>
<span class="w">  </span><span class="ss">inputs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*.{heex,ex,exs}&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;{config,lib,test}/**/*.{heex,ex,exs}&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;priv/*/seeds.exs&quot;</span><span class="p">]</span>
<span class="p">]</span>
</code></pre></div>
<h3 id="6">ステップ6: 開発用タスクの作成<a class="headerlink" href="#6" title="Permanent link">&para;</a></h3>
<p>開発効率を向上させるため、カスタムMixタスクを作成します。</p>
<p><code>lib/mix/tasks/check.ex</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Mix.Tasks.Check</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">開発時の基本チェックを実行するタスクです。</span>

<span class="sh">  以下のチェックを実行します：</span>
<span class="sh">  - mix format --check-formatted (フォーマットチェック)</span>
<span class="sh">  - mix credo --strict (静的解析)</span>
<span class="sh">  - mix test (テスト実行)</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>

<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Mix.Task</span>

<span class="w">  </span><span class="na">@shortdoc</span><span class="w"> </span><span class="s2">&quot;基本的なコード品質チェック&quot;</span>

<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">run</span><span class="p">(</span><span class="n">_args</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nc">Mix</span><span class="o">.</span><span class="n">shell</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;==&gt; 基本チェックを開始します&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># フォーマットチェック</span>
<span class="w">    </span><span class="nc">Mix</span><span class="o">.</span><span class="n">shell</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">==&gt; フォーマットチェック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nc">Mix.Task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;--check-formatted&quot;</span><span class="p">])</span>
<span class="w">    </span><span class="nc">Mix</span><span class="o">.</span><span class="n">shell</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ フォーマットチェック 完了&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 静的解析</span>
<span class="w">    </span><span class="nc">Mix</span><span class="o">.</span><span class="n">shell</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">==&gt; 静的解析&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nc">Mix.Task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;credo&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;--strict&quot;</span><span class="p">])</span>
<span class="w">    </span><span class="nc">Mix</span><span class="o">.</span><span class="n">shell</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ 静的解析 完了&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># テスト実行</span>
<span class="w">    </span><span class="nc">Mix</span><span class="o">.</span><span class="n">shell</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">==&gt; テスト実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nc">Mix.Task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span>
<span class="w">    </span><span class="nc">Mix</span><span class="o">.</span><span class="n">shell</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✓ テスト実行 完了&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="nc">Mix</span><span class="o">.</span><span class="n">shell</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🎉 基本チェックが完了しました！&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="7">ステップ7: 動作確認<a class="headerlink" href="#7" title="Permanent link">&para;</a></h3>
<p>サーバーを起動して、プロジェクトが正しくセットアップされているか確認します：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>phx.server
</code></pre></div>
<p>ブラウザで <code>http://localhost:4000</code> にアクセスし、Phoenixのウェルカムページが表示されることを確認します。</p>
<h3 id="8">ステップ8: 開発ガイドの作成<a class="headerlink" href="#8" title="Permanent link">&para;</a></h3>
<p>チーム開発のため、開発手順をドキュメント化します。</p>
<p><code>DEVELOPMENT.md</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="gh"># 開発ガイド</span>

<span class="gu">## セットアップ</span>

\`\`\`bash
<span class="gh"># 依存関係のインストール</span>
mix deps.get

<span class="gh"># データベースのセットアップ</span>
mix ecto.setup

<span class="gh"># フロントエンドアセットのセットアップ</span>
cd assets &amp;&amp; npm install &amp;&amp; cd ..
\`\`\`

<span class="gu">## 使用可能なコマンド</span>

<span class="gu">### 基本コマンド</span>
<span class="k">-</span><span class="w"> </span><span class="sb">`mix phx.server`</span> - サーバー起動
<span class="k">-</span><span class="w"> </span><span class="sb">`mix test`</span> - テスト実行
<span class="k">-</span><span class="w"> </span><span class="sb">`mix format`</span> - コード整形
<span class="k">-</span><span class="w"> </span><span class="sb">`mix credo`</span> - 静的解析
<span class="k">-</span><span class="w"> </span><span class="sb">`mix coveralls.html`</span> - カバレッジレポート生成

<span class="gu">### 統合コマンド</span>
<span class="k">-</span><span class="w"> </span><span class="sb">`mix check`</span> - 基本チェック (format, credo, test)

<span class="gu">### 自動化</span>
<span class="k">-</span><span class="w"> </span><span class="sb">`mix test.watch`</span> - ファイル変更時の自動テスト実行

<span class="gu">## 開発フロー</span>

<span class="k">1.</span> <span class="gs">**コードを書く**</span>
<span class="k">2.</span> <span class="gs">**フォーマット**</span>: <span class="sb">`mix format`</span>
<span class="k">3.</span> <span class="gs">**チェック**</span>: <span class="sb">`mix check`</span>
<span class="k">4.</span> <span class="gs">**コミット**</span>

<span class="gu">## コミットメッセージ規約</span>

Angularコミットメッセージ規約に従います：

\`\`\`
&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;
\`\`\`

<span class="gs">**主要なタイプ**</span>:
<span class="k">-</span><span class="w"> </span><span class="sb">`feat`</span>: 新機能の追加
<span class="k">-</span><span class="w"> </span><span class="sb">`fix`</span>: バグの修正
<span class="k">-</span><span class="w"> </span><span class="sb">`docs`</span>: ドキュメントのみの変更
<span class="k">-</span><span class="w"> </span><span class="sb">`test`</span>: テストの追加や修正
<span class="k">-</span><span class="w"> </span><span class="sb">`refactor`</span>: バグ修正や機能追加以外のコード変更
<span class="k">-</span><span class="w"> </span><span class="sb">`chore`</span>: ビルドプロセスやツールの変更

<span class="gu">## 品質基準</span>

<span class="k">-</span><span class="w"> </span><span class="gs">**フォーマット**</span>: Elixir標準フォーマッタに準拠
<span class="k">-</span><span class="w"> </span><span class="gs">**静的解析**</span>: Credoのルールをクリア
<span class="k">-</span><span class="w"> </span><span class="gs">**テストカバレッジ**</span>: 80%以上を目標
<span class="k">-</span><span class="w"> </span><span class="gs">**全テスト**</span>: パスすること
</code></pre></div>
<h3 id="9">ステップ9: 初回コミット<a class="headerlink" href="#9" title="Permanent link">&para;</a></h3>
<p>Gitリポジトリを初期化し、初回コミットを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gitリポジトリの初期化（まだの場合）</span>
git<span class="w"> </span>init

<span class="c1"># .gitignoreの確認（Phoenixが自動生成）</span>
<span class="c1"># 必要に応じて追加設定</span>

<span class="c1"># すべてのファイルをステージング</span>
git<span class="w"> </span>add<span class="w"> </span>-A

<span class="c1"># 初回コミット</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;chore: Phoenix LiveViewプロジェクトの初期セットアップ</span>

<span class="s2">- Phoenix 1.7プロジェクトの作成</span>
<span class="s2">- LiveViewサポートの有効化</span>
<span class="s2">- 開発ツールの追加（Credo, ExCoveralls, mix_test_watch, Dialyxir）</span>
<span class="s2">- カスタムMixタスク（mix check）の作成</span>
<span class="s2">- 開発ガイド（DEVELOPMENT.md）の作成</span>
<span class="s2">- 開発環境の整備完了&quot;</span>
</code></pre></div>
<h3 id="10">ステップ10: 基本チェックの実行<a class="headerlink" href="#10" title="Permanent link">&para;</a></h3>
<p>セットアップが完了したので、基本チェックを実行します：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>check
</code></pre></div>
<p>すべてのチェックが通ることを確認します。</p>
<h3 id="_4">まとめ<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>イテレーション0で以下を達成しました：</p>
<h4 id="_5">得られたもの<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Phoenix LiveViewプロジェクトのセットアップ</strong></li>
<li>LiveView対応のPhoenix 1.7プロジェクト</li>
<li>データベース設定とマイグレーション環境</li>
<li>
<p>アセット管理の設定</p>
</li>
<li>
<p><strong>開発ツールの整備</strong></p>
</li>
<li>Credo（静的コード解析）</li>
<li>ExCoveralls（テストカバレッジ）</li>
<li>mix_test_watch（自動テスト実行）</li>
<li>
<p>Dialyxir（型解析）</p>
</li>
<li>
<p><strong>開発フローの確立</strong></p>
</li>
<li>コードフォーマッタの設定</li>
<li>統合チェックタスク（mix check）</li>
<li>コミットメッセージ規約</li>
<li>
<p>開発ガイドの作成</p>
</li>
<li>
<p><strong>テスト駆動開発の準備</strong></p>
</li>
<li>ExUnitテスト環境</li>
<li>LiveViewテストのサポート</li>
<li>カバレッジ測定環境</li>
</ol>
<h4 id="_6">プロジェクト構成<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>puyo_puyo/
├── lib/
│   ├── mix/
│   │   └── tasks/
│   │       └── check.ex          # 統合チェックタスク
│   ├── puyo_puyo/                # ビジネスロジック層
│   └── puyo_puyo_web/            # Web層（LiveView）
├── test/                         # テストファイル
├── config/                       # 設定ファイル
├── .credo.exs                    # Credo設定
├── .formatter.exs                # フォーマッタ設定
├── mix.exs                       # プロジェクト定義
├── DEVELOPMENT.md                # 開発ガイド
└── README.md                     # プロジェクト説明
</code></pre></div>
<h4 id="_7">次のステップ<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>開発環境が整いました。次のイテレーションでは、以下を実装していきます：</p>
<ul>
<li><strong>イテレーション1</strong>: ゲームの初期化とLiveViewの基本構造</li>
<li><strong>イテレーション2</strong>: ステージの実装（盤面の表示と管理）</li>
<li><strong>イテレーション3</strong>: プレイヤーの実装（ぷよの移動と回転）</li>
<li><strong>イテレーション4</strong>: ゲームループの実装（重力と落下）</li>
<li><strong>イテレーション5</strong>: 消去判定の実装（同色4つ以上の判定）</li>
<li><strong>イテレーション6</strong>: 連鎖反応の実装（連鎖とスコア計算）</li>
<li><strong>イテレーション7</strong>: ゲームオーバーの実装（終了判定と演出）</li>
</ul>
<p>これらをテスト駆動開発のサイクルに従って、一つずつ実装していきましょう！</p>
<p>Elixir Phoenix LiveViewの世界で「動作するきれいなコード」を書き始める準備が整いました。開発を楽しんでください！</p>
<hr />
<h2 id="1-liveview">イテレーション1: ゲームの初期化とLiveViewの基本構造<a class="headerlink" href="#1-liveview" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの初期化」とLiveViewの基本構造を実装します。</p>
<blockquote>
<p>イテレーション開発とは、ソフトウェアを小さな機能単位で繰り返し開発していく手法です。各イテレーションで計画、設計、実装、テスト、評価のサイクルを回すことで、リスクを早期に発見し、フィードバックを得ながら開発を進めることができます。</p>
<p>— Craig Larman 『アジャイル開発とスクラム』</p>
</blockquote>
<h3 id="_8">ユーザーストーリー<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>TODOリストは、テスト駆動開発の重要なプラクティスの一つです。実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>LiveViewモジュールを作成する（ゲームの状態を管理するLiveViewモジュール）</li>
<li>ゲームの初期状態を定義する（ゲームモード、スコア、ステージ情報など）</li>
<li>テンプレートを作成する（プレイヤーが視覚的にゲームを認識できるようにする）</li>
<li>ルーティングを設定する（<code>/game</code>パスでゲームにアクセスできるようにする）</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「LiveViewモジュールの作成」から始めましょう！</p>
<h3 id="liveview">テスト: LiveViewモジュールの作成<a class="headerlink" href="#liveview" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「LiveViewモジュールを作成する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、LiveViewモジュールの初期化をテストするコードを書いてみましょう。LiveViewテストでは、<code>mount/3</code>コールバックが正しく動作し、必要な状態が設定されることを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo_web/live/game_live_test.exs</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.GameLiveTest</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.ConnCase</span>

<span class="w">  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Phoenix.LiveViewTest</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;GameLive&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;mounts successfully&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">_view</span><span class="p">,</span><span class="w"> </span><span class="n">html</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">live</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/game&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">html</span><span class="w"> </span><span class="o">=~</span><span class="w"> </span><span class="s2">&quot;ぷよぷよゲーム&quot;</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;initializes game state on mount&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">_html</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">live</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/game&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># LiveViewの状態を取得</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">has_element?</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">game-container&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># 初期状態の確認</span>
<span class="w">      </span><span class="c1"># mode: :start (ゲーム開始状態)</span>
<span class="w">      </span><span class="c1"># score: 0 (スコアは0)</span>
<span class="w">      </span><span class="c1"># chain: 0 (連鎖数は0)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;displays game board&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">_html</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">live</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/game&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># ゲームボードが表示されていることを確認</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">has_element?</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">game-board&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;displays score information&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="n">_html</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">live</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/game&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># スコア情報が表示されていることを確認</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">has_element?</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">score&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">has_element?</span><span class="p">(</span><span class="n">view</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">chain&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>このテストでは、<code>GameLive</code>モジュールが正しくマウントされ、必要な初期状態が設定されることを確認しています。</p>
<h3 id="liveview_1">実装: LiveViewモジュールの作成<a class="headerlink" href="#liveview_1" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo_web/live/game_live_test.exs
</code></pre></div>
<div class="highlight"><pre><span></span><code>Error: cannot find module PuyoPuyoWeb.GameLive
</code></pre></div>
<p>おっと！まだ<code>GameLive</code>モジュールを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<blockquote>
<p>失敗するテスト</p>
<p>テストが失敗することを確認してから実装に取り掛かろう。そうすれば、テストが正しく機能していることがわかる。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストが通るように最小限のコードを実装していきましょう。「最小限」というのがポイントです。この段階では、テストが通ることだけを目指して、必要最低限のコードを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo_web/live/game_live.ex</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.GameLive</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">PuyoPuyoWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span>

<span class="w">  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">ぷよぷよゲームのLiveViewモジュール</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>

<span class="w">  </span><span class="c1"># ゲームモードの定義</span>
<span class="w">  </span><span class="na">@type</span><span class="w"> </span><span class="n">game_mode</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="ss">:start</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:check_fall</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:fall</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:check_erase</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:erasing</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:playing</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:game_over</span>

<span class="w">  </span><span class="c1"># ゲーム設定</span>
<span class="w">  </span><span class="na">@stage_rows</span><span class="w"> </span><span class="mi">12</span>
<span class="w">  </span><span class="na">@stage_cols</span><span class="w"> </span><span class="mi">6</span>
<span class="w">  </span><span class="na">@puyo_size</span><span class="w"> </span><span class="mi">32</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># ゲームの初期状態を設定</span>
<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">socket</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:mode</span><span class="p">,</span><span class="w"> </span><span class="ss">:start</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:score</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:chain</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:stage_rows</span><span class="p">,</span><span class="w"> </span><span class="na">@stage_rows</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:stage_cols</span><span class="p">,</span><span class="w"> </span><span class="na">@stage_cols</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:puyo_size</span><span class="p">,</span><span class="w"> </span><span class="na">@puyo_size</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:board</span><span class="p">,</span><span class="w"> </span><span class="n">init_board</span><span class="p">())</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div id=&quot;game-container&quot; class=&quot;flex gap-8 p-8&quot;&gt;</span>
<span class="sh">      &lt;div id=&quot;game-board&quot; class=&quot;relative bg-gray-100 border-2 border-gray-800 rounded-lg&quot;&gt;</span>
<span class="sh">        &lt;div class=&quot;grid&quot; style={&quot;grid-template-columns: repeat(#{@stage_cols}, #{@puyo_size}px);&quot;}&gt;</span>
<span class="sh">          &lt;%= for row &lt;- 0..(@stage_rows - 1) do %&gt;</span>
<span class="sh">            &lt;%= for col &lt;- 0..(@stage_cols - 1) do %&gt;</span>
<span class="sh">              &lt;div</span>
<span class="sh">                class=&quot;border border-gray-300&quot;</span>
<span class="sh">                style={&quot;width: #{@puyo_size}px; height: #{@puyo_size}px;&quot;}</span>
<span class="sh">              &gt;</span>
<span class="sh">                &lt;%= render_puyo(@board[row][col]) %&gt;</span>
<span class="sh">              &lt;/div&gt;</span>
<span class="sh">            &lt;% end %&gt;</span>
<span class="sh">          &lt;% end %&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">      &lt;/div&gt;</span>

<span class="sh">      &lt;div id=&quot;info-panel&quot; class=&quot;bg-white p-6 rounded-lg shadow-lg&quot;&gt;</span>
<span class="sh">        &lt;h2 class=&quot;text-2xl font-bold mb-4&quot;&gt;ぷよぷよゲーム&lt;/h2&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;スコア&lt;/h3&gt;</span>
<span class="sh">          &lt;p id=&quot;score&quot; class=&quot;text-3xl font-bold text-blue-600&quot;&gt;&lt;%= @score %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;連鎖数&lt;/h3&gt;</span>
<span class="sh">          &lt;p id=&quot;chain&quot; class=&quot;text-3xl font-bold text-red-600&quot;&gt;&lt;%= @chain %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mt-6 text-sm text-gray-600&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;font-semibold mb-2&quot;&gt;操作方法&lt;/h3&gt;</span>
<span class="sh">          &lt;ul class=&quot;space-y-1&quot;&gt;</span>
<span class="sh">            &lt;li&gt;← →: 移動&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;↑: 回転&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;↓: 高速落下&lt;/li&gt;</span>
<span class="sh">          &lt;/ul&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">      &lt;/div&gt;</span>
<span class="sh">    &lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># プライベート関数</span>

<span class="w">  </span><span class="c1"># 空のボードを初期化</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">init_board</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="na">@stage_rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="ss">into</span><span class="p">:</span><span class="w"> </span><span class="p">%{}</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="na">@stage_cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="ss">into</span><span class="p">:</span><span class="w"> </span><span class="p">%{},</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">})}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ぷよの描画（0は空、1-4はぷよの種類）</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">render_puyo</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">render_puyo</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
<span class="w">    </span><span class="n">assigns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="ss">color</span><span class="p">:</span><span class="w"> </span><span class="n">color</span><span class="p">}</span>

<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div class=&quot;w-full h-full rounded-full&quot; style={&quot;background-color: #{@color}; border: 2px solid rgba(0,0,0,0.2);&quot;}&gt;&lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ぷよの色を返す</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">FF0000&quot;</span><span class="w">  </span><span class="c1"># 赤</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">00FF00&quot;</span><span class="w">  </span><span class="c1"># 緑</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">0000FF&quot;</span><span class="w">  </span><span class="c1"># 青</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">FFFF00&quot;</span><span class="w">  </span><span class="c1"># 黄</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_9">ルーティングの設定<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>LiveViewモジュールを作成したら、ルーティングを設定して、<code>/game</code>パスでアクセスできるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo_web/router.ex</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.Router</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">PuyoPuyoWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:router</span>

<span class="w">  </span><span class="c1"># 既存のパイプライン...</span>

<span class="w">  </span><span class="n">scope</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">PuyoPuyoWeb</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:browser</span>

<span class="w">    </span><span class="n">get</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">PageController</span><span class="p">,</span><span class="w"> </span><span class="ss">:home</span>

<span class="w">    </span><span class="c1"># ぷよぷよゲームのルート</span>
<span class="w">    </span><span class="n">live</span><span class="w"> </span><span class="s2">&quot;/game&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">GameLive</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 既存のスコープ...</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="liveview_2">解説: LiveViewの初期化<a class="headerlink" href="#liveview_2" title="Permanent link">&para;</a></h3>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<blockquote>
<p>テストが通ったら、次はリファクタリングだ。でも、その前に少し立ち止まって、今書いたコードについて考えてみよう。</p>
<p>— Martin Fowler 『リファクタリング』</p>
</blockquote>
<p>実装したLiveViewモジュールについて、少し解説しておきましょう。</p>
<h4 id="phoenix-liveview_1">Phoenix LiveViewの仕組み<a class="headerlink" href="#phoenix-liveview_1" title="Permanent link">&para;</a></h4>
<p>Phoenix LiveViewは、サーバーサイドでHTMLをレンダリングし、WebSocketを通じてクライアントに差分だけを送信する仕組みです。主な特徴は：</p>
<ol>
<li><strong>サーバー側で状態管理</strong>: <code>socket.assigns</code>に状態を保存</li>
<li><strong>自動的な差分更新</strong>: 状態が変わると、変更された部分だけがクライアントに送信される</li>
<li><strong>リアルタイム通信</strong>: WebSocketによる双方向通信</li>
</ol>
<h4 id="mount3">mount/3コールバック<a class="headerlink" href="#mount3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">socket</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:mode</span><span class="p">,</span><span class="w"> </span><span class="ss">:start</span><span class="p">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:score</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:chain</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># ...</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p><code>mount/3</code>は、LiveViewが初期化されるときに呼ばれるコールバックです。ここで：</p>
<ul>
<li><strong>ゲームモード</strong>: <code>:start</code>（ゲーム開始状態）</li>
<li><strong>スコア</strong>: <code>0</code></li>
<li><strong>連鎖数</strong>: <code>0</code></li>
<li><strong>ボード</strong>: 空のボード（12行 × 6列）</li>
</ul>
<p>を初期化しています。</p>
<h4 id="render1">render/1関数<a class="headerlink" href="#render1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">  &lt;div id=&quot;game-container&quot;&gt;</span>
<span class="sh">    ...</span>
<span class="sh">  &lt;/div&gt;</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="k">end</span>
</code></pre></div>
<p><code>render/1</code>関数は、LiveViewのUIを定義します。<code>~H</code>シジルは、HEExテンプレート（HTML + Elixir）を表します。</p>
<p>このテンプレートでは：</p>
<ul>
<li><strong>ゲームボード</strong>: グリッドレイアウトで6×12のセルを表示</li>
<li><strong>情報パネル</strong>: スコア、連鎖数、操作方法を表示</li>
</ul>
<h4 id="_10">状態の管理<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>LiveViewでは、<code>assign/3</code>関数を使って状態を管理します：</p>
<div class="highlight"><pre><span></span><code><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:score</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>
<p>状態が変更されると、LiveViewは自動的に<code>render/1</code>を再実行し、変更された部分だけをクライアントに送信します。これにより、効率的なリアルタイム更新が実現されます。</p>
<h3 id="_11">テスト実行と確認<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo_web/live/game_live_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します。また、サーバーを起動して、ブラウザで確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>phx.server
</code></pre></div>
<p>ブラウザで <code>http://localhost:4000/game</code> にアクセスすると、ゲームボードとスコア情報が表示されるはずです。</p>
<h3 id="_12">コミット<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>機能が完成したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>-A
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: ゲームの初期化とLiveViewの基本構造を実装</span>

<span class="s2">- GameLiveモジュールの作成</span>
<span class="s2">- mount/3コールバックでの初期状態設定</span>
<span class="s2">- HEExテンプレートの作成（ゲームボード、情報パネル）</span>
<span class="s2">- ルーティングの設定（/game）</span>
<span class="s2">- LiveViewテストの作成</span>
<span class="s2">- 空のボード（12行 × 6列）の表示</span>
<span class="s2">- スコアと連鎖数の表示</span>

<span class="s2">イテレーション1完了&quot;</span>
</code></pre></div>
<h3 id="_13">まとめ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>イテレーション1で以下を達成しました：</p>
<h4 id="_14">得られたもの<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>LiveViewの基本構造</strong></li>
<li>GameLiveモジュールの作成</li>
<li>mount/3コールバックでの初期化</li>
<li>
<p>HEExテンプレートによる画面表示</p>
</li>
<li>
<p><strong>ゲームの初期状態</strong></p>
</li>
<li>ゲームモード（:start）</li>
<li>スコア（0）</li>
<li>連鎖数（0）</li>
<li>
<p>空のボード（12行 × 6列）</p>
</li>
<li>
<p><strong>画面表示</strong></p>
</li>
<li>グリッドレイアウトのゲームボード</li>
<li>スコアと連鎖数の情報パネル</li>
<li>
<p>操作方法の表示</p>
</li>
<li>
<p><strong>ルーティング</strong></p>
</li>
<li>
<p><code>/game</code>パスでゲームにアクセス可能</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>LiveViewテストによる動作確認</li>
<li>マウント、初期化、表示のテスト</li>
</ol>
<h4 id="phoenix-liveview_2">Phoenix LiveViewの利点<a class="headerlink" href="#phoenix-liveview_2" title="Permanent link">&para;</a></h4>
<p>今回の実装で、Phoenix LiveViewの以下の利点を体感できました：</p>
<ol>
<li><strong>シンプルな状態管理</strong>: サーバー側で状態を管理するため、クライアント側の複雑な状態管理が不要</li>
<li><strong>自動的な更新</strong>: 状態が変わると、自動的に画面が更新される</li>
<li><strong>統一的なテスト</strong>: サーバーサイドロジックとして統一的にテスト可能</li>
<li><strong>少ないJavaScript</strong>: JavaScriptをほとんど書かずにインタラクティブなUIを実装</li>
</ol>
<h4 id="_15">次のステップ<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>基本的な構造ができました。次のイテレーションでは、以下を実装していきます：</p>
<ul>
<li><strong>イテレーション2</strong>: ステージの実装（ぷよの配置と管理）</li>
<li><strong>イテレーション3</strong>: プレイヤーの実装（ぷよの移動と回転）</li>
<li><strong>イテレーション4</strong>: ゲームループの実装（重力と落下）</li>
</ul>
<p>これらをテスト駆動開発のサイクルに従って、一つずつ実装していきましょう！</p>
<hr />
<h2 id="2_1">イテレーション2: ステージの実装<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h2>
<p>イテレーション1で基本的な構造ができました。次は、ゲームの中核となる「ステージ」の実装です。ステージは、ぷよの配置、消去判定、落下処理など、ぷよぷよゲームの重要なロジックを担当します。</p>
<blockquote>
<p>ドメインモデル</p>
<p>ドメイン駆動設計では、ビジネスロジックをドメインモデルとして分離します。ゲームにおいては、ステージ、プレイヤー、スコアなどがドメインモデルにあたります。これらをWebレイヤー（LiveView）から分離することで、テストしやすく、保守しやすいコードになります。</p>
<p>— Eric Evans 『ドメイン駆動設計』</p>
</blockquote>
<h3 id="_16">ユーザーストーリー<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ステージ上のぷよを管理し、同じ色のぷよが4つ以上つながったら消去できる</p>
</blockquote>
<p>このストーリーには、いくつかの機能が含まれています：</p>
<ol>
<li>ぷよの配置と取得</li>
<li>同じ色のぷよの接続判定（4つ以上）</li>
<li>ぷよの消去</li>
<li>消去後の落下</li>
</ol>
<p>それでは、これらの機能を一つずつテスト駆動開発で実装していきましょう！</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<blockquote>
<p>TODOリストは、大きな問題を小さな問題に分割するための強力なツールです。複雑な問題に直面したとき、それを管理可能な小さなタスクに分解することで、一歩一歩確実に前進できます。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ステージの実装」というユーザーストーリーを実現するために、以下のタスクが必要です：</p>
<ul>
<li>Stageモジュールを作成する（ビジネスロジック層）</li>
<li>ぷよの配置・取得機能を実装する</li>
<li>消去判定を実装する（DFSアルゴリズム）</li>
<li>ぷよの消去処理を実装する</li>
<li>落下処理を実装する</li>
<li>重力を適用する処理を実装する</li>
<li>GameLiveと統合する</li>
</ul>
<p>これらのタスクを一つずつ実装していきます。まずは「ぷよの配置・取得」から始めましょう！</p>
<h3 id="_17">テスト: ぷよの配置と取得<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>まず、ステージ上にぷよを配置し、取得する機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/stage_test.exs</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.StageTest</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo.Stage</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Stage.new/1&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;creates a new stage with default dimensions&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>

<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">12</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;creates a new stage with custom dimensions&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">cols</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>

<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">10</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;initializes board with all zeros&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>

<span class="w">      </span><span class="c1"># すべてのセルが0（空）であることを確認</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Stage.set_puyo/4 and Stage.get_puyo/3&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])}</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;sets and gets a puyo at specified position&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># ぷよを設定（x=1, y=10, type=1 [赤]）</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># ぷよを取得して確認</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;returns 0 for empty cell&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># 空のセルを取得</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;returns 0 for out of bounds position&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># 範囲外の座標を指定</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="stage">実装: Stage モジュール<a class="headerlink" href="#stage" title="Permanent link">&para;</a></h3>
<p>テストを実行すると失敗します（Red）。では、テストが通るように最小限のコードを実装しましょう（Green）。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/stage.ex</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.Stage</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">ぷよぷよゲームのステージを管理するモジュール</span>

<span class="sh">  ステージは12行×6列のボードで構成され、以下の機能を提供します：</span>
<span class="sh">  - ぷよの配置と取得</span>
<span class="sh">  - 消去判定（4つ以上の同色ぷよの接続判定）</span>
<span class="sh">  - ぷよの消去</span>
<span class="sh">  - 落下処理（重力）</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>

<span class="w">  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">          </span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">cols</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">board</span><span class="p">:</span><span class="w"> </span><span class="p">%{</span><span class="n">non_neg_integer</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">%{</span><span class="n">non_neg_integer</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">()}}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p">[</span><span class="ss">:rows</span><span class="p">,</span><span class="w"> </span><span class="ss">:cols</span><span class="p">,</span><span class="w"> </span><span class="ss">:board</span><span class="p">]</span>

<span class="w">  </span><span class="na">@default_rows</span><span class="w"> </span><span class="mi">12</span>
<span class="w">  </span><span class="na">@default_cols</span><span class="w"> </span><span class="mi">6</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">新しいステージを作成します</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Options</span>
<span class="sh">    * `:rows` - ステージの行数（デフォルト: 12）</span>
<span class="sh">    * `:cols` - ステージの列数（デフォルト: 6）</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">      iex&gt; stage.rows</span>
<span class="sh">      12</span>
<span class="sh">      iex&gt; stage.cols</span>
<span class="sh">      6</span>

<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">new</span><span class="p">(</span><span class="n">keyword</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">:rows</span><span class="p">,</span><span class="w"> </span><span class="na">@default_rows</span><span class="p">)</span>
<span class="w">    </span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">:cols</span><span class="p">,</span><span class="w"> </span><span class="na">@default_cols</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># ボードを初期化（すべて0で埋める）</span>
<span class="w">    </span><span class="n">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="ss">into</span><span class="p">:</span><span class="w"> </span><span class="p">%{}</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="p">{</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="ss">into</span><span class="p">:</span><span class="w"> </span><span class="p">%{},</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">})}</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">    </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">cols</span><span class="p">:</span><span class="w"> </span><span class="n">cols</span><span class="p">,</span><span class="w"> </span><span class="ss">board</span><span class="p">:</span><span class="w"> </span><span class="n">board</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">指定した位置のぷよを取得します</span>

<span class="sh">  範囲外の座標を指定した場合は0（空）を返します</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">      iex&gt; stage = PuyoPuyo.Stage.set_puyo(stage, 1, 10, 1)</span>
<span class="sh">      iex&gt; PuyoPuyo.Stage.get_puyo(stage, 1, 10)</span>
<span class="sh">      1</span>

<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">board</span><span class="p">:</span><span class="w"> </span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">cols</span><span class="p">:</span><span class="w"> </span><span class="n">cols</span><span class="p">},</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 範囲外チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">board</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">指定した位置にぷよを設定します</span>

<span class="sh">  新しいステージを返します（不変データ構造）</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">      iex&gt; stage = PuyoPuyo.Stage.set_puyo(stage, 1, 10, 1)</span>
<span class="sh">      iex&gt; PuyoPuyo.Stage.get_puyo(stage, 1, 10)</span>
<span class="sh">      1</span>

<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">board</span><span class="p">:</span><span class="w"> </span><span class="n">board</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 指定した位置のぷよを更新</span>
<span class="w">    </span><span class="n">updated_row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">y</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span>
<span class="w">    </span><span class="n">updated_board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">updated_row</span><span class="p">)</span>

<span class="w">    </span><span class="p">%{</span><span class="n">stage</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">board</span><span class="p">:</span><span class="w"> </span><span class="n">updated_board</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="elixir">解説: Elixirの不変データ構造<a class="headerlink" href="#elixir" title="Permanent link">&para;</a></h3>
<p>実装したStageモジュールについて、いくつか重要なポイントを解説します。</p>
<h4 id="_18">構造体の定義<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defstruct</span><span class="w"> </span><span class="p">[</span><span class="ss">:rows</span><span class="p">,</span><span class="w"> </span><span class="ss">:cols</span><span class="p">,</span><span class="w"> </span><span class="ss">:board</span><span class="p">]</span>
</code></pre></div>
<p>Elixirの構造体は、モジュール内で<code>defstruct</code>を使って定義します。構造体は、特定の構造を持つマップです。</p>
<h4 id="_19">不変データ構造<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">board</span><span class="p">:</span><span class="w"> </span><span class="n">board</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">updated_row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">y</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span>
<span class="w">  </span><span class="n">updated_board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">updated_row</span><span class="p">)</span>
<span class="w">  </span><span class="p">%{</span><span class="n">stage</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">board</span><span class="p">:</span><span class="w"> </span><span class="n">updated_board</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>Elixirでは、すべてのデータが不変（immutable）です。<code>set_puyo/4</code>は元のステージを変更せず、新しいステージを返します。これにより：</p>
<ol>
<li><strong>予測可能性</strong>: 関数が元のデータを変更しないため、バグが減る</li>
<li><strong>並行処理の安全性</strong>: データ競合が発生しない</li>
<li><strong>テストのしやすさ</strong>: 副作用がないため、テストが容易</li>
</ol>
<h4 id="_20">パターンマッチング<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">board</span><span class="p">:</span><span class="w"> </span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">cols</span><span class="p">:</span><span class="w"> </span><span class="n">cols</span><span class="p">},</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
</code></pre></div>
<p>関数の引数でパターンマッチングを使うことで、構造体のフィールドに直接アクセスできます。</p>
<h3 id="_21">テスト実行<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/stage_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_22">テスト: 消去判定<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>次に、同じ色のぷよが4つ以上つながっているかを判定する機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/stage_test.exs（続き）</span>
<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Stage.check_erase/1&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;detects 4 connected puyos as erasable&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 2×2の正方形に赤ぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 消去判定</span>
<span class="w">    </span><span class="p">{</span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">_positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 4つのぷよが消去対象になっていることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;does not erase different colored puyos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 市松模様に赤と緑のぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># 赤</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1"># 緑</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1"># 緑</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># 赤</span>

<span class="w">    </span><span class="c1"># 消去判定</span>
<span class="w">    </span><span class="p">{</span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 消去対象がないことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;does not erase 3 or fewer connected puyos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># L字型に赤ぷよを3つ配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 消去判定</span>
<span class="w">    </span><span class="p">{</span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 消去対象がないことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;detects vertical line of 4 puyos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 縦に4つの赤ぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 消去判定</span>
<span class="w">    </span><span class="p">{</span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">_positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 4つのぷよが消去対象になっていることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;detects horizontal line of 4 puyos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 横に4つの赤ぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 消去判定</span>
<span class="w">    </span><span class="p">{</span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">_positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 4つのぷよが消去対象になっていることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_23">実装: 消去判定（深さ優先探索）<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>消去判定には、深さ優先探索（DFS: Depth-First Search）アルゴリズムを使用します。これは、接続しているぷよを再帰的に探索する効率的な方法です。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/stage.ex（続き）</span>
<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">消去判定を行います</span>

<span class="sh">4つ以上接続している同色のぷよを検出します。</span>
<span class="sh">深さ優先探索（DFS）アルゴリズムを使用して、接続しているぷよを探索します。</span>

<span class="err">##</span><span class="sh"> Returns</span>

<span class="sh">  {消去するぷよの数, 消去するぷよの位置リスト}</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; stage = stage</span>
<span class="sh">    ...&gt; |&gt; PuyoPuyo.Stage.set_puyo(1, 10, 1)</span>
<span class="sh">    ...&gt; |&gt; PuyoPuyo.Stage.set_puyo(2, 10, 1)</span>
<span class="sh">    ...&gt; |&gt; PuyoPuyo.Stage.set_puyo(1, 11, 1)</span>
<span class="sh">    ...&gt; |&gt; PuyoPuyo.Stage.set_puyo(2, 11, 1)</span>
<span class="sh">    iex&gt; {count, _positions} = PuyoPuyo.Stage.check_erase(stage)</span>
<span class="sh">    iex&gt; count</span>
<span class="sh">    4</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">check_erase</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p">{</span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="p">[{</span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">()}]}</span>
<span class="kd">def</span><span class="w"> </span><span class="n">check_erase</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">cols</span><span class="p">:</span><span class="w"> </span><span class="n">cols</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># 訪問済みセルを記録するMapSet</span>
<span class="w">  </span><span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MapSet</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">  </span><span class="c1"># 消去対象のぷよの位置を記録するリスト</span>
<span class="w">  </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">  </span><span class="c1"># 全セルをチェック</span>
<span class="w">  </span><span class="p">{</span><span class="n">_visited</span><span class="p">,</span><span class="w"> </span><span class="n">erase_positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">erase_positions</span><span class="p">},</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">visited_acc</span><span class="p">,</span><span class="w"> </span><span class="n">erase_acc</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="n">visited_acc</span><span class="p">,</span><span class="w"> </span><span class="n">erase_acc</span><span class="p">},</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">visited_inner</span><span class="p">,</span><span class="w"> </span><span class="n">erase_inner</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">puyo_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span>
<span class="w">        </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">}</span>

<span class="w">        </span><span class="c1"># ぷよがあり、まだ訪問していない場合</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">puyo_type</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nc">MapSet</span><span class="o">.</span><span class="n">member?</span><span class="p">(</span><span class="n">visited_inner</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="c1"># 接続しているぷよを探索</span>
<span class="w">          </span><span class="p">{</span><span class="n">visited_after_search</span><span class="p">,</span><span class="w"> </span><span class="n">connected</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">search_connected</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">,</span><span class="w"> </span><span class="n">visited_inner</span><span class="p">)</span>

<span class="w">          </span><span class="c1"># 4つ以上接続している場合は消去対象に追加</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">connected</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="p">{</span><span class="n">visited_after_search</span><span class="p">,</span><span class="w"> </span><span class="n">erase_inner</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">connected</span><span class="p">}</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="p">{</span><span class="n">visited_after_search</span><span class="p">,</span><span class="w"> </span><span class="n">erase_inner</span><span class="p">}</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="p">{</span><span class="n">visited_inner</span><span class="p">,</span><span class="w"> </span><span class="n">erase_inner</span><span class="p">}</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span><span class="p">)</span>

<span class="w">  </span><span class="p">{</span><span class="n">length</span><span class="p">(</span><span class="n">erase_positions</span><span class="p">),</span><span class="w"> </span><span class="n">erase_positions</span><span class="p">}</span>
<span class="k">end</span>

<span class="c1"># 深さ優先探索で接続しているぷよを探索</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">search_connected</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="nc">MapSet</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span>
<span class="w">        </span><span class="p">{</span><span class="nc">MapSet</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="p">[{</span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">()}]}</span>
<span class="kd">defp</span><span class="w"> </span><span class="n">search_connected</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">}</span>

<span class="w">  </span><span class="c1"># 訪問済みにマーク</span>
<span class="w">  </span><span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MapSet</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">)</span>
<span class="w">  </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">position</span><span class="p">]</span>

<span class="w">  </span><span class="c1"># 4方向を探索</span>
<span class="w">  </span><span class="n">directions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">}]</span>

<span class="w">  </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">directions</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">connected</span><span class="p">},</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="p">{</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">visited_acc</span><span class="p">,</span><span class="w"> </span><span class="n">connected_acc</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="n">next_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dx</span>
<span class="w">    </span><span class="n">next_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span>
<span class="w">    </span><span class="n">next_position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">next_x</span><span class="p">,</span><span class="w"> </span><span class="n">next_y</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># 範囲内、同じ色、未訪問の場合は再帰的に探索</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">next_x</span><span class="p">,</span><span class="w"> </span><span class="n">next_y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">puyo_type</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nc">MapSet</span><span class="o">.</span><span class="n">member?</span><span class="p">(</span><span class="n">visited_acc</span><span class="p">,</span><span class="w"> </span><span class="n">next_position</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="n">visited_after_recursion</span><span class="p">,</span><span class="w"> </span><span class="n">connected_from_recursion</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">search_connected</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">next_x</span><span class="p">,</span><span class="w"> </span><span class="n">next_y</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">,</span><span class="w"> </span><span class="n">visited_acc</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span><span class="n">visited_after_recursion</span><span class="p">,</span><span class="w"> </span><span class="n">connected_acc</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">connected_from_recursion</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">{</span><span class="n">visited_acc</span><span class="p">,</span><span class="w"> </span><span class="n">connected_acc</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="dfs">解説: 深さ優先探索（DFS）<a class="headerlink" href="#dfs" title="Permanent link">&para;</a></h3>
<p>深さ優先探索は、グラフや木構造の探索アルゴリズムの一つです。ぷよぷよの消去判定では、同じ色のぷよが接続しているかを調べるために使用します。</p>
<h4 id="_24">アルゴリズムの流れ<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>全セルをチェック</strong>: ボード上のすべてのセルを順番に調べます</li>
<li><strong>未訪問のぷよを発見</strong>: ぷよがあり、まだ訪問していないセルを見つけます</li>
<li><strong>接続探索開始</strong>: そのぷよと同じ色で接続しているぷよを再帰的に探索します</li>
<li><strong>4方向をチェック</strong>: 各ぷよから上下左右の4方向を調べます</li>
<li><strong>同色かつ未訪問</strong>: 同じ色で未訪問のぷよがあれば、再帰的に探索を続けます</li>
<li><strong>接続数判定</strong>: 接続しているぷよが4つ以上なら、消去対象として記録します</li>
</ol>
<h4 id="_25">訪問済み管理<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MapSet</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MapSet</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">)</span>
</code></pre></div>
<p><code>MapSet</code>を使って訪問済みのセルを管理します。これにより：</p>
<ul>
<li><strong>重複探索の防止</strong>: 同じセルを何度も訪問しない</li>
<li><strong>効率的な検索</strong>: O(1)の時間で訪問済みかチェックできる</li>
</ul>
<h3 id="_26">テスト実行<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/stage_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_27">テスト: ぷよの消去と落下<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>次に、ぷよの消去と落下処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/stage_test.exs（続き）</span>
<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Stage.erase_puyos/2&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;erases puyos at specified positions&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># ステージにぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 消去判定</span>
<span class="w">    </span><span class="p">{</span><span class="n">_count</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 消去実行</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">erase_puyos</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># ぷよが消去されていることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Stage.fall/1&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;makes puyos fall after erasure&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># ステージにぷよを配置</span>
<span class="w">    </span><span class="c1"># 下に赤ぷよ4つ（2×2）、その上の列(x=2)に緑ぷよ2つ</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># 赤</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># 赤</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># 赤</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># 赤</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">   </span><span class="c1"># 緑</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">   </span><span class="c1"># 緑</span>

<span class="w">    </span><span class="c1"># 消去判定と実行</span>
<span class="w">    </span><span class="p">{</span><span class="n">_count</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">erase_puyos</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 落下処理</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">fall</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 上にあった緑ぷよが落下していることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_28">実装: ぷよの消去と落下<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/stage.ex（続き）</span>
<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">指定した位置のぷよを消去します</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; stage = stage |&gt; PuyoPuyo.Stage.set_puyo(1, 10, 1)</span>
<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.erase_puyos(stage, [{1, 10}])</span>
<span class="sh">    iex&gt; PuyoPuyo.Stage.get_puyo(stage, 1, 10)</span>
<span class="sh">    0</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">erase_puyos</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="p">[{</span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">()}])</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="kd">def</span><span class="w"> </span><span class="n">erase_puyos</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">},</span><span class="w"> </span><span class="n">stage_acc</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage_acc</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">ぷよを落下させます</span>

<span class="sh">各列で、下から上に向かってぷよをチェックし、</span>
<span class="sh">下に空きがある場合は落下させます。</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; stage = stage</span>
<span class="sh">    ...&gt; |&gt; PuyoPuyo.Stage.set_puyo(1, 5, 1)</span>
<span class="sh">    ...&gt; |&gt; PuyoPuyo.Stage.set_puyo(1, 10, 0)</span>
<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.fall(stage)</span>
<span class="sh">    iex&gt; PuyoPuyo.Stage.get_puyo(stage, 1, 11)</span>
<span class="sh">    1</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">fall</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="kd">def</span><span class="w"> </span><span class="n">fall</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">cols</span><span class="p">:</span><span class="w"> </span><span class="n">cols</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># 各列を処理</span>
<span class="w">  </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">stage_acc</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="c1"># 下から上に向かって処理</span>
<span class="w">    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="o">..</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage_acc</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">stage_inner</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="n">puyo_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage_inner</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">puyo_type</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># 現在のぷよの下が空いている場合、落下させる</span>
<span class="w">        </span><span class="n">fall_puyo_in_column</span><span class="p">(</span><span class="n">stage_inner</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">stage_inner</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># 指定した列のぷよを可能な限り落下させる</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">fall_puyo_in_column</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="kd">defp</span><span class="w"> </span><span class="n">fall_puyo_in_column</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="n">rows</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">start_row</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># 落下先を探す</span>
<span class="w">  </span><span class="n">fall_to_row</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce_while</span><span class="p">((</span><span class="n">start_row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">..</span><span class="p">(</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">start_row</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">_acc</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="p">{</span><span class="ss">:cont</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span><span class="ss">:halt</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># 落下先が異なる場合は移動</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">fall_to_row</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">start_row</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">fall_to_row</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">start_row</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">stage</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_29">解説: パイプライン演算子<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>Elixirでは、パイプライン演算子（<code>|&gt;</code>）を使って、関数呼び出しを連鎖させることができます。</p>
<div class="highlight"><pre><span></span><code><span class="n">stage</span>
<span class="o">|&gt;</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">fall_to_row</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span>
<span class="o">|&gt;</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">start_row</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>これは以下と同じ意味です：</p>
<div class="highlight"><pre><span></span><code><span class="n">stage2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">fall_to_row</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span>
<span class="n">stage3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">start_row</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>パイプライン演算子を使うことで：</p>
<ol>
<li><strong>可読性の向上</strong>: データの変換の流れが明確になる</li>
<li><strong>変数の削減</strong>: 中間変数を定義する必要がない</li>
<li><strong>関数型スタイル</strong>: データ変換のパイプラインとして表現できる</li>
</ol>
<h3 id="_30">テスト実行<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/stage_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_31">テスト: 重力の適用<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>最後に、1フレームごとに1マスずつぷよを落下させる「重力」機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/stage_test.exs（続き）</span>
<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Stage.apply_gravity/1&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;makes floating puyo fall one row&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 浮いている青ぷよを配置（下に空きがある）</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 重力を適用</span>
<span class="w">    </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 青ぷよが1マス落ちていることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;returns false when no puyo falls&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># すべてのぷよが支えられている状態</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 重力を適用</span>
<span class="w">    </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 何も落ちていないことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;makes multiple floating puyos fall&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 複数の浮いているぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 重力を適用</span>
<span class="w">    </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 全てのぷよが1マス落ちていることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;stops puyo at bottom&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 最下段の1つ上にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 重力を適用（1マス落ちる）</span>
<span class="w">    </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1"># もう一度重力を適用（もう落ちない）</span>
<span class="w">    </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;stops puyo on other puyo&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 土台のぷよと、その上の浮いているぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># 土台</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">   </span><span class="c1"># 浮いているぷよ</span>

<span class="w">    </span><span class="c1"># 重力を適用（1マス落ちる）</span>
<span class="w">    </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>

<span class="w">    </span><span class="c1"># もう一度重力を適用（土台のぷよの上で停止）</span>
<span class="w">    </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_32">実装: 重力の適用<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/stage.ex（続き）</span>
<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">重力を適用します（1フレームで1マス落下）</span>

<span class="sh">すべてのぷよに対して、下に移動できる場合は1マス落下させます。</span>

<span class="err">##</span><span class="sh"> Returns</span>

<span class="sh">  {ぷよが落下したかどうか, 新しいステージ}</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.set_puyo(stage, 1, 5, 1)</span>
<span class="sh">    iex&gt; {has_fallen, stage} = PuyoPuyo.Stage.apply_gravity(stage)</span>
<span class="sh">    iex&gt; has_fallen</span>
<span class="sh">    true</span>
<span class="sh">    iex&gt; PuyoPuyo.Stage.get_puyo(stage, 1, 6)</span>
<span class="sh">    1</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p">{</span><span class="n">boolean</span><span class="p">(),</span><span class="w"> </span><span class="n">t</span><span class="p">()}</span>
<span class="kd">def</span><span class="w"> </span><span class="n">apply_gravity</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">rows</span><span class="p">:</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">cols</span><span class="p">:</span><span class="w"> </span><span class="n">cols</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># 下から上に向かって処理（下のぷよから先に処理する）</span>
<span class="w">  </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">new_stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="o">..</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">},</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">fallen_acc</span><span class="p">,</span><span class="w"> </span><span class="n">stage_acc</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="c1"># 左から右に処理</span>
<span class="w">      </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="n">fallen_acc</span><span class="p">,</span><span class="w"> </span><span class="n">stage_acc</span><span class="p">},</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">fallen_inner</span><span class="p">,</span><span class="w"> </span><span class="n">stage_inner</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">puyo_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage_inner</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span>

<span class="w">        </span><span class="c1"># ぷよがあり、下が空いている場合</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">puyo_type</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage_inner</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="c1"># 1マス落下</span>
<span class="w">          </span><span class="n">new_stage_inner</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">stage_inner</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">set_puyo</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">          </span><span class="p">{</span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="n">new_stage_inner</span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="p">{</span><span class="n">fallen_inner</span><span class="p">,</span><span class="w"> </span><span class="n">stage_inner</span><span class="p">}</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span><span class="p">)</span>

<span class="w">  </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">new_stage</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_33">解説: ゲームループとの統合<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p><code>apply_gravity/1</code>は、ゲームループの中で毎フレーム呼ばれることを想定しています。</p>
<ul>
<li><strong>戻り値</strong>: <code>{has_fallen, new_stage}</code> のタプルを返します</li>
<li><code>has_fallen</code>: ぷよが落下したかどうかのフラグ</li>
<li>
<p><code>new_stage</code>: 重力適用後の新しいステージ</p>
</li>
<li>
<p><strong>使用例</strong>（ゲームループ内）:
  <div class="highlight"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="p">{</span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="n">new_stage</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="c1"># まだ落下中</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:cont</span><span class="p">,</span><span class="w"> </span><span class="n">new_stage</span><span class="p">}</span>
<span class="w">  </span><span class="p">{</span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="n">new_stage</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="c1"># 落下完了、次の処理へ</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:halt</span><span class="p">,</span><span class="w"> </span><span class="n">new_stage</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></p>
</li>
</ul>
<h3 id="_34">テスト実行<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/stage_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="liveview_3">LiveViewとの統合<a class="headerlink" href="#liveview_3" title="Permanent link">&para;</a></h3>
<p>Stageモジュールが完成したので、GameLiveと統合します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo_web/live/game_live.ex（更新）</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.GameLive</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">PuyoPuyoWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo.Stage</span>

<span class="w">  </span><span class="c1"># ... 既存のコード ...</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># Stageモジュールを使用</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>

<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">socket</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:mode</span><span class="p">,</span><span class="w"> </span><span class="ss">:start</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:score</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:chain</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:stage</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div id=&quot;game-container&quot; class=&quot;flex gap-8 p-8&quot;&gt;</span>
<span class="sh">      &lt;div id=&quot;game-board&quot; class=&quot;relative bg-gray-100 border-2 border-gray-800 rounded-lg&quot;&gt;</span>
<span class="sh">        &lt;div class=&quot;grid&quot; style={&quot;grid-template-columns: repeat(#{@stage.cols}, 32px);&quot;}&gt;</span>
<span class="sh">          &lt;%= for row &lt;- 0..(@stage.rows - 1) do %&gt;</span>
<span class="sh">            &lt;%= for col &lt;- 0..(@stage.cols - 1) do %&gt;</span>
<span class="sh">              &lt;div</span>
<span class="sh">                class=&quot;border border-gray-300&quot;</span>
<span class="sh">                style=&quot;width: 32px; height: 32px;&quot;</span>
<span class="sh">              &gt;</span>
<span class="sh">                &lt;%= render_puyo(Stage.get_puyo(@stage, col, row)) %&gt;</span>
<span class="sh">              &lt;/div&gt;</span>
<span class="sh">            &lt;% end %&gt;</span>
<span class="sh">          &lt;% end %&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">      &lt;/div&gt;</span>

<span class="sh">      &lt;div id=&quot;info-panel&quot; class=&quot;bg-white p-6 rounded-lg shadow-lg&quot;&gt;</span>
<span class="sh">        &lt;h2 class=&quot;text-2xl font-bold mb-4&quot;&gt;ぷよぷよゲーム&lt;/h2&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;スコア&lt;/h3&gt;</span>
<span class="sh">          &lt;p id=&quot;score&quot; class=&quot;text-3xl font-bold text-blue-600&quot;&gt;&lt;%= @score %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;連鎖数&lt;/h3&gt;</span>
<span class="sh">          &lt;p id=&quot;chain&quot; class=&quot;text-3xl font-bold text-red-600&quot;&gt;&lt;%= @chain %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mt-6 text-sm text-gray-600&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;font-semibold mb-2&quot;&gt;操作方法&lt;/h3&gt;</span>
<span class="sh">          &lt;ul class=&quot;space-y-1&quot;&gt;</span>
<span class="sh">            &lt;li&gt;← →: 移動&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;↑: 回転&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;↓: 高速落下&lt;/li&gt;</span>
<span class="sh">          &lt;/ul&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">      &lt;/div&gt;</span>
<span class="sh">    &lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ... 既存のプライベート関数 ...</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_35">テスト実行（統合テスト）<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>最後に、すべてのテストを実行して、統合が正しく動作することを確認します：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_36">コミット<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>機能が完成したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>-A
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: ステージモジュールの実装</span>

<span class="s2">- Stageモジュールの作成（lib/puyo_puyo/stage.ex）</span>
<span class="s2">- 不変データ構造によるステージ状態管理</span>
<span class="s2">- ぷよの配置・取得機能（set_puyo/4, get_puyo/3）</span>
<span class="s2">- 消去判定機能（check_erase/1）</span>
<span class="s2">  - 深さ優先探索（DFS）アルゴリズム</span>
<span class="s2">  - 4つ以上の同色ぷよの接続判定</span>
<span class="s2">- ぷよの消去機能（erase_puyos/2）</span>
<span class="s2">- 落下処理（fall/1）</span>
<span class="s2">- 重力適用（apply_gravity/1）</span>
<span class="s2">  - 1フレームで1マス落下</span>
<span class="s2">- GameLiveとの統合</span>
<span class="s2">- 包括的なテストカバレッジ（11テストケース）</span>

<span class="s2">イテレーション2完了&quot;</span>
</code></pre></div>
<h3 id="_37">まとめ<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>イテレーション2で以下を達成しました：</p>
<h4 id="_38">得られたもの<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Stageモジュール</strong></li>
<li>ビジネスロジック層の分離</li>
<li>不変データ構造による状態管理</li>
<li>
<p>構造体とパターンマッチングの活用</p>
</li>
<li>
<p><strong>ぷよの配置・取得機能</strong></p>
</li>
<li><code>set_puyo/4</code>: ぷよを設定</li>
<li><code>get_puyo/3</code>: ぷよを取得</li>
<li>
<p>範囲外チェック</p>
</li>
<li>
<p><strong>消去判定機能</strong></p>
</li>
<li>深さ優先探索（DFS）アルゴリズム</li>
<li>MapSetによる訪問済み管理</li>
<li>
<p>4つ以上の同色ぷよの検出</p>
</li>
<li>
<p><strong>消去と落下機能</strong></p>
</li>
<li><code>erase_puyos/2</code>: ぷよの消去</li>
<li><code>fall/1</code>: 消去後の落下処理</li>
<li>
<p><code>apply_gravity/1</code>: 1フレームごとの重力適用</p>
</li>
<li>
<p><strong>LiveViewとの統合</strong></p>
</li>
<li>GameLiveでStageモジュールを使用</li>
<li>サーバーサイドでのステージ状態管理</li>
</ol>
<h4 id="_39">学んだこと<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>不変データ構造</strong></li>
<li>Elixirのすべてのデータは不変</li>
<li>新しいデータを返すことで状態を更新</li>
<li>
<p>予測可能で安全なコード</p>
</li>
<li>
<p><strong>パターンマッチング</strong></p>
</li>
<li>関数の引数でパターンマッチング</li>
<li>構造体のフィールドに直接アクセス</li>
<li>
<p>条件分岐の簡潔な表現</p>
</li>
<li>
<p><strong>パイプライン演算子</strong></p>
</li>
<li><code>|&gt;</code> でデータ変換を連鎖</li>
<li>可読性の向上</li>
<li>
<p>関数型プログラミングのスタイル</p>
</li>
<li>
<p><strong>深さ優先探索（DFS）</strong></p>
</li>
<li>グラフ探索の基本アルゴリズム</li>
<li>再帰的な実装</li>
<li>
<p>訪問済み管理の重要性</p>
</li>
<li>
<p><strong>テスト駆動開発</strong></p>
</li>
<li>Red-Green-Refactorサイクル</li>
<li>小さなステップで確実に</li>
<li>包括的なテストケース</li>
</ol>
<h4 id="_40">次のステップ<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<p>ステージの基本機能が完成しました。次のイテレーションでは、以下を実装していきます：</p>
<ul>
<li><strong>イテレーション3</strong>: プレイヤーの実装（ぷよの移動と回転）</li>
<li><strong>イテレーション4</strong>: ゲームループの実装（重力と落下）</li>
<li><strong>イテレーション5</strong>: スコアと連鎖の実装</li>
<li><strong>イテレーション6</strong>: ゲームオーバーの実装</li>
</ul>
<p>これらをテスト駆動開発のサイクルに従って、一つずつ実装していきましょう！</p>
<hr />
<h2 id="3_1">イテレーション3: プレイヤーの実装<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h2>
<p>イテレーション2でステージの実装が完了しました。次は、プレイヤーが操作する「落ちてくるぷよペア」の実装です。このイテレーションでは、プレイヤーの移動、回転、着地といった操作に関するロジックを実装します。</p>
<blockquote>
<p>単一責任の原則</p>
<p>クラスを変更する理由は1つ以上存在してはならない。</p>
<p>— Robert C. Martin 『Clean Architecture』</p>
</blockquote>
<p>今回実装するPlayerモジュールは、「プレイヤーが操作するぷよペアの状態と振る舞い」という単一の責任を持ちます。ステージの管理はStageモジュールが、スコアの管理はScoreモジュールが担当し、それぞれが明確に分離されています。</p>
<h3 id="_41">ユーザーストーリー<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよペアを左右に移動し、回転できる</p>
</blockquote>
<p>このストーリーには、以下の機能が含まれています：</p>
<ol>
<li>ぷよペアの生成（軸ぷよと次ぷよの2つ）</li>
<li>左右への移動</li>
<li>回転（壁キック処理を含む）</li>
<li>着地判定と着地処理</li>
</ol>
<p>それでは、これらの機能を一つずつテスト駆動開発で実装していきましょう！</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>「プレイヤーの実装」というユーザーストーリーを実現するために、以下のタスクが必要です：</p>
<ul>
<li>Playerモジュールを作成する（ビジネスロジック層）</li>
<li>ぷよペアの生成機能を実装する</li>
<li>左右移動機能を実装する（境界チェック、衝突判定）</li>
<li>回転機能を実装する（壁キック処理）</li>
<li>着地判定と着地処理を実装する</li>
<li>GameLiveと統合する（キーボード入力）</li>
<li>ゲームループと統合する</li>
</ul>
<p>これらのタスクを一つずつ実装していきます。まずは「ぷよペアの生成」から始めましょう！</p>
<h3 id="_42">テスト: ぷよペアの生成<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>まず、プレイヤーが操作する「ぷよペア」を生成する機能をテストします。ぷよペアは、軸ぷよ（回転の中心）と次ぷよ（軸ぷよに対して相対位置を持つ）の2つで構成されます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/player_test.exs</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.PlayerTest</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo</span><span class="o">.</span><span class="p">{</span><span class="nc">Player</span><span class="p">,</span><span class="w"> </span><span class="nc">Stage</span><span class="p">}</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Player.new/1&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;creates a new player with default position&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># 初期位置はx=2, y=0</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="c1"># 初期回転状態は0（上向き）</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="c1"># 未着地</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">landed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;creates a player with random puyo types&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># ぷよの種類は1-4の範囲</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_type</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">4</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">next_puyo_type</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">4</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Player.can_spawn?/1&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;returns true when spawn position is empty&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_spawn?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;returns false when spawn position is occupied&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">      </span><span class="c1"># 初期位置(2, 0)にぷよを配置</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_spawn?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="player">実装: Player モジュールの基本構造<a class="headerlink" href="#player" title="Permanent link">&para;</a></h3>
<p>テストを実行すると失敗します（Red）。では、テストが通るように最小限のコードを実装しましょう（Green）。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/player.ex</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.Player</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">ぷよぷよゲームのプレイヤー（操作するぷよペア）を管理するモジュール</span>

<span class="sh">  プレイヤーは、軸ぷよと次ぷよの2つのぷよで構成されます。</span>
<span class="sh">  軸ぷよを中心に回転し、左右に移動できます。</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo.Stage</span>

<span class="w">  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">          </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="n">integer</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">puyo_type</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">next_puyo_type</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">,</span>
<span class="w">          </span><span class="ss">landed</span><span class="p">:</span><span class="w"> </span><span class="n">boolean</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="ss">:puyo_x</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:puyo_y</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:puyo_type</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:next_puyo_type</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:rotation</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:landed</span>
<span class="w">  </span><span class="p">]</span>

<span class="w">  </span><span class="c1"># 初期位置</span>
<span class="w">  </span><span class="na">@initial_x</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="na">@initial_y</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="c1"># ぷよの種類の範囲</span>
<span class="w">  </span><span class="na">@min_puyo_type</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="na">@max_puyo_type</span><span class="w"> </span><span class="mi">4</span>

<span class="w">  </span><span class="c1"># 回転状態ごとの2つ目のぷよのオフセット</span>
<span class="w">  </span><span class="c1"># 0: 上, 1: 右, 2: 下, 3: 左</span>
<span class="w">  </span><span class="na">@offset_x</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">  </span><span class="na">@offset_y</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">新しいプレイヤーを作成します</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">      iex&gt; player = PuyoPuyo.Player.new(stage)</span>
<span class="sh">      iex&gt; player.puyo_x</span>
<span class="sh">      2</span>

<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">new</span><span class="p">(</span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">new</span><span class="p">(</span><span class="n">_stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">      </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="na">@initial_x</span><span class="p">,</span>
<span class="w">      </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="na">@initial_y</span><span class="p">,</span>
<span class="w">      </span><span class="ss">puyo_type</span><span class="p">:</span><span class="w"> </span><span class="n">random_puyo_type</span><span class="p">(),</span>
<span class="w">      </span><span class="ss">next_puyo_type</span><span class="p">:</span><span class="w"> </span><span class="n">random_puyo_type</span><span class="p">(),</span>
<span class="w">      </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="ss">landed</span><span class="p">:</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">プレイヤーが生成可能かチェックします</span>

<span class="sh">  初期位置にぷよが存在しないかを確認します。</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">      iex&gt; player = PuyoPuyo.Player.new(stage)</span>
<span class="sh">      iex&gt; PuyoPuyo.Player.can_spawn?(player, stage)</span>
<span class="sh">      true</span>

<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">can_spawn?</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">boolean</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">can_spawn?</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="n">y</span><span class="p">},</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ランダムなぷよの種類を生成</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">random_puyo_type</span><span class="p">()</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">()</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">random_puyo_type</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="na">@min_puyo_type</span><span class="o">..</span><span class="na">@max_puyo_type</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_43">解説: ぷよペアの設計<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>実装したPlayerモジュールについて、いくつか重要なポイントを解説します。</p>
<h4 id="_44">ぷよペアの構成<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defstruct</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="ss">:puyo_x</span><span class="p">,</span><span class="w">           </span><span class="c1"># 軸ぷよのX座標</span>
<span class="w">  </span><span class="ss">:puyo_y</span><span class="p">,</span><span class="w">           </span><span class="c1"># 軸ぷよのY座標</span>
<span class="w">  </span><span class="ss">:puyo_type</span><span class="p">,</span><span class="w">        </span><span class="c1"># 軸ぷよの種類</span>
<span class="w">  </span><span class="ss">:next_puyo_type</span><span class="p">,</span><span class="w">   </span><span class="c1"># 次ぷよの種類</span>
<span class="w">  </span><span class="ss">:rotation</span><span class="p">,</span><span class="w">         </span><span class="c1"># 回転状態（0-3）</span>
<span class="w">  </span><span class="ss">:landed</span><span class="w">            </span><span class="c1"># 着地フラグ</span>
<span class="p">]</span>
</code></pre></div>
<p>ぷよペアは、以下の情報を持ちます：</p>
<ul>
<li><strong>軸ぷよ</strong>: 回転の中心となるぷよ</li>
<li><strong>次ぷよ</strong>: 軸ぷよに対して相対的な位置を持つぷよ</li>
<li><strong>回転状態</strong>: 0（上）、1（右）、2（下）、3（左）の4つの状態</li>
</ul>
<h4 id="_45">オフセット配列<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="na">@offset_x</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="na">@offset_y</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<p>回転状態に応じた2つ目のぷよの相対位置を定義します：</p>
<ul>
<li><strong>回転0（上）</strong>: (0, -1) - 軸ぷよの上</li>
<li><strong>回転1（右）</strong>: (1, 0) - 軸ぷよの右</li>
<li><strong>回転2（下）</strong>: (0, 1) - 軸ぷよの下</li>
<li><strong>回転3（左）</strong>: (-1, 0) - 軸ぷよの左</li>
</ul>
<h4 id="_46">ランダムなぷよの生成<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defp</span><span class="w"> </span><span class="n">random_puyo_type</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="nc">Enum</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="na">@min_puyo_type</span><span class="o">..</span><span class="na">@max_puyo_type</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p><code>Enum.random/1</code>を使って、1-4のランダムなぷよの種類を生成します。</p>
<h3 id="_47">テスト実行<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/player_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_48">テスト: 左右移動<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>次に、プレイヤーのぷよペアを左右に移動する機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/player_test.exs（続き）</span>
<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Player.move_left/2&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;moves player left&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">initial_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">initial_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;does not move left beyond left boundary&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 左端まで移動</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># さらに左に移動しようとする</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 位置が変わらないことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;does not move left when collision with puyo&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 左隣にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">initial_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 位置が変わらないことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">initial_x</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;does not move left when second puyo would collide&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 横向き（回転状態1）にする</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># 2つ目のぷよの左隣（軸ぷよの位置）にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 左に移動しようとする</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 移動できないことを確認（2つ目のぷよの位置に既にぷよがある）</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="na">@initial_x</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Player.move_right/2&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;moves player right&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">initial_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">initial_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;does not move right beyond right boundary&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 右端まで移動（列数は6なので、x=5が右端）</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># さらに右に移動しようとする</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 位置が変わらないことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;does not move right when collision with puyo&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 右隣にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">initial_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 位置が変わらないことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">initial_x</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_49">実装: 左右移動<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/player.ex（続き）</span>
<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">プレイヤーを左に移動します</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; player = PuyoPuyo.Player.new(stage)</span>
<span class="sh">    iex&gt; player = PuyoPuyo.Player.move_left(player, stage)</span>
<span class="sh">    iex&gt; player.puyo_x</span>
<span class="sh">    1</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">move_left</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="kd">def</span><span class="w"> </span><span class="n">move_left</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="n">rotation</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">next_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">second_puyo_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_x</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>
<span class="w">  </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># 範囲チェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">next_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 衝突チェック</span>
<span class="w">    </span><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">next_x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="n">second_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_clear</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">next_x</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">player</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">player</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">プレイヤーを右に移動します</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; player = PuyoPuyo.Player.new(stage)</span>
<span class="sh">    iex&gt; player = PuyoPuyo.Player.move_right(player, stage)</span>
<span class="sh">    iex&gt; player.puyo_x</span>
<span class="sh">    3</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">move_right</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="kd">def</span><span class="w"> </span><span class="n">move_right</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="n">rotation</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">next_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">second_puyo_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_x</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>
<span class="w">  </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># 範囲チェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">next_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 衝突チェック</span>
<span class="w">    </span><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">next_x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="n">second_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_clear</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">next_x</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">player</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">player</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_50">解説: 衝突判定<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>左右移動の実装では、以下の3つのチェックを行います：</p>
<ol>
<li><strong>範囲チェック</strong>: 移動先がステージの範囲内か</li>
<li><strong>軸ぷよの衝突チェック</strong>: 移動先に既にぷよが存在しないか</li>
<li><strong>次ぷよの衝突チェック</strong>: 次ぷよの移動先に既にぷよが存在しないか</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">next_x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>
<span class="n">second_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>
</code></pre></div>
<p>範囲外の場合は衝突なしとして扱い（<code>else: true</code>）、範囲内の場合のみ衝突チェックを行います。</p>
<h3 id="_51">テスト実行<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/player_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_52">テスト: 回転<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>次に、プレイヤーのぷよペアを回転する機能をテストします。回転では「壁キック」という処理が重要になります。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/player_test.exs（続き）</span>
<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Player.rotate_right/2&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;rotates player right&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 初期状態は0（上向き）</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1"># 右回転</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>

<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>

<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;does not rotate when collision&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 右側にぷよを配置（回転すると右側に次ぷよが来る）</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">initial_rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 回転できないことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">initial_rotation</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;performs wall kick when rotating at right edge&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 右端に移動</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># 右回転すると、次ぷよが右端外になるが、壁キックで左に1マス移動</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 回転成功し、軸ぷよが左に1マス移動していることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_53">実装: 回転と壁キック<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>回転機能では、「壁キック」という処理が重要になります。壁キックとは、回転した結果が壁やステージの外側に出てしまう場合に、自動的に位置を調整する処理です。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/player.ex（続き）</span>
<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">プレイヤーを右回転します</span>

<span class="sh">壁キック処理を含みます。回転後に壁やぷよに衝突する場合は、</span>
<span class="sh">自動的に位置を調整します。</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; player = PuyoPuyo.Player.new(stage)</span>
<span class="sh">    iex&gt; player = PuyoPuyo.Player.rotate_right(player, stage)</span>
<span class="sh">    iex&gt; player.rotation</span>
<span class="sh">    1</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">rotate_right</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="kd">def</span><span class="w"> </span><span class="n">rotate_right</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="n">rotation</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># 新しい回転状態</span>
<span class="w">  </span><span class="n">new_rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rem</span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># 回転可能かチェック（壁キック処理を含む）</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">check_rotation_with_wall_kick</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">new_x</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">new_x</span><span class="p">}</span>

<span class="w">    </span><span class="ss">:error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="n">player</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 回転可能かチェック（壁キック処理を含む）</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">check_rotation_with_wall_kick</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">()}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:error</span>
<span class="kd">defp</span><span class="w"> </span><span class="n">check_rotation_with_wall_kick</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="n">y</span><span class="p">},</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># 2つ目のぷよの位置を計算</span>
<span class="w">  </span><span class="n">second_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">)</span>
<span class="w">  </span><span class="n">second_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># 壁キック処理</span>
<span class="w">  </span><span class="n">adjusted_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">cond</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 右端で右回転した場合（2つ目のぷよが右にくる場合）</span>
<span class="w">    </span><span class="n">second_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1"># 左端で左回転した場合（2つ目のぷよが左にくる場合）</span>
<span class="w">    </span><span class="n">second_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1"># 壁キック不要</span>
<span class="w">    </span><span class="no">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 壁キック後の位置を再計算</span>
<span class="w">  </span><span class="n">adjusted_second_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adjusted_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># 範囲チェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">adjusted_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">adjusted_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">adjusted_second_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">adjusted_second_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 衝突チェック</span>
<span class="w">    </span><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">adjusted_x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>
<span class="w">    </span><span class="n">second_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">second_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">adjusted_second_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_clear</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">adjusted_x</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="ss">:error</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="ss">:error</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_54">解説: 壁キック処理<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>壁キック処理は、ぷよぷよにおいて重要な操作性の改善です。</p>
<h4 id="_55">壁キックの目的<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h4>
<p>回転した結果が壁の外に出てしまう場合でも、自動的に位置を調整することで、プレイヤーが意図した回転を実行できるようにします。</p>
<h4 id="_56">壁キックの処理<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">adjusted_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">cond</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># 右端で右回転した場合（2つ目のぷよが右にくる場合）</span>
<span class="w">  </span><span class="n">second_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="c1"># 左端で左回転した場合（2つ目のぷよが左にくる場合）</span>
<span class="w">  </span><span class="n">second_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="c1"># 壁キック不要</span>
<span class="w">  </span><span class="no">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>
</code></pre></div>
<ul>
<li><strong>右端での回転</strong>: 2つ目のぷよが右端外に出る場合、軸ぷよを1マス左に移動</li>
<li><strong>左端での回転</strong>: 2つ目のぷよが左端外に出る場合、軸ぷよを1マス右に移動</li>
</ul>
<h4 id="_57">結果の返し方<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="n">check_rotation_with_wall_kick</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">new_x</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">new_x</span><span class="p">}</span>
<span class="w">  </span><span class="ss">:error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">player</span>
<span class="k">end</span>
</code></pre></div>
<p><code>{:ok, value}</code> | <code>:error</code> パターンを使って、回転の成功・失敗を表現します。これはElixirでよく使われる慣用的なパターンです。</p>
<h3 id="_58">テスト実行<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/player_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_59">テスト: 着地判定と着地処理<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>次に、ぷよペアの着地判定と着地処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/player_test.exs（続き）</span>
<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Player.can_move_down?/2&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;returns true when can move down&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_move_down?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;returns false when at bottom&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 最下段に移動</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="p">}</span>

<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_move_down?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;returns false when puyo below&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 下にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_move_down?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;checks second puyo when it is below&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 下向き（回転状態2）にする</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># 2つ目のぷよの下にぷよを配置</span>
<span class="w">    </span><span class="c1"># 2つ目のぷよは (puyo_x, puyo_y + 1) にあるので、</span>
<span class="w">    </span><span class="c1"># その下 (puyo_x, puyo_y + 2) にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_move_down?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Player.land/2&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">setup</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;places puyos on stage&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">}</span>

<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">land</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 軸ぷよが配置されていることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_type</span>

<span class="w">    </span><span class="c1"># 2つ目のぷよが配置されていることを確認（上向きなのでy-1）</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">next_puyo_type</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;places second puyo at correct rotated position&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 横向き（回転状態1）にする</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">}</span>

<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">land</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 軸ぷよが配置されていることを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_type</span>

<span class="w">    </span><span class="c1"># 2つ目のぷよが配置されていることを確認（右向きなのでx+1）</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">next_puyo_type</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_60">実装: 着地判定と着地処理<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/player.ex（続き）</span>
<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">下に移動できるかチェックします</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; player = PuyoPuyo.Player.new(stage)</span>
<span class="sh">    iex&gt; PuyoPuyo.Player.can_move_down?(player, stage)</span>
<span class="sh">    true</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">can_move_down?</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">boolean</span><span class="p">()</span>
<span class="kd">def</span><span class="w"> </span><span class="n">can_move_down?</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="n">rotation</span><span class="p">},</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">second_puyo_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_x</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>
<span class="w">  </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># 2つ目のぷよが下向き（offsetY == 1）の場合</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 2つ目のぷよの下端チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="no">false</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># 2つ目のぷよの下にぷよがあるかチェック</span>
<span class="w">      </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="c1"># 軸ぷよの下端チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="no">false</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># 軸ぷよの下にぷよがあるかチェック</span>
<span class="w">      </span><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>

<span class="w">      </span><span class="c1"># 2つ目のぷよの下端と衝突チェック</span>
<span class="w">      </span><span class="n">second_puyo_clear</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="no">false</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">      </span><span class="n">axis_puyo_clear</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_clear</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">プレイヤーのぷよペアをステージに配置します</span>

<span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">    iex&gt; stage = PuyoPuyo.Stage.new([])</span>
<span class="sh">    iex&gt; player = PuyoPuyo.Player.new(stage)</span>
<span class="sh">    iex&gt; player = %{player | puyo_y: 10}</span>
<span class="sh">    iex&gt; stage = PuyoPuyo.Player.land(player, stage)</span>
<span class="sh">    iex&gt; PuyoPuyo.Stage.get_puyo(stage, player.puyo_x, player.puyo_y)</span>
<span class="sh">    player.puyo_type</span>

<span class="sh">&quot;&quot;&quot;</span>
<span class="na">@spec</span><span class="w"> </span><span class="n">land</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
<span class="kd">def</span><span class="w"> </span><span class="n">land</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_type</span><span class="p">:</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">,</span><span class="w"> </span><span class="ss">next_puyo_type</span><span class="p">:</span><span class="w"> </span><span class="n">next_puyo_type</span><span class="p">,</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="n">rotation</span><span class="p">},</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">second_puyo_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_x</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>
<span class="w">  </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>

<span class="w">  </span><span class="n">stage</span>
<span class="w">  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyo_type</span><span class="p">)</span>
<span class="w">  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">second_puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="p">,</span><span class="w"> </span><span class="n">next_puyo_type</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_61">解説: 着地判定の複雑さ<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>着地判定では、回転状態に応じて異なるチェックが必要になります。</p>
<h4 id="_62">下向きの場合<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="na">@offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># 2つ目のぷよの下端チェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="no">false</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">end</span>
</code></pre></div>
<p>2つ目のぷよが下向きの場合、2つ目のぷよの下だけをチェックすればよい（軸ぷよは2つ目のぷよの上にあるため）。</p>
<h4 id="_63">その他の方向の場合<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 軸ぷよの下にぷよがあるかチェック</span>
<span class="n">axis_puyo_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>

<span class="c1"># 2つ目のぷよの下端と衝突チェック</span>
<span class="n">second_puyo_clear</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="no">false</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">second_puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">end</span>

<span class="n">axis_puyo_clear</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">second_puyo_clear</span>
</code></pre></div>
<p>上、右、左向きの場合、軸ぷよと2つ目のぷよの両方の下をチェックする必要があります。</p>
<h3 id="_64">テスト実行<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/player_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="liveview_4">LiveViewとの統合: キーボード入力<a class="headerlink" href="#liveview_4" title="Permanent link">&para;</a></h3>
<p>Playerモジュールが完成したので、GameLiveと統合してキーボード入力を処理できるようにします。</p>
<p>Phoenix LiveViewでは、<code>phx-window-keydown</code>イベントを使ってキーボード入力を受け取ることができます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo_web/live/game_live.ex（更新）</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.GameLive</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">PuyoPuyoWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo</span><span class="o">.</span><span class="p">{</span><span class="nc">Stage</span><span class="p">,</span><span class="w"> </span><span class="nc">Player</span><span class="p">}</span>

<span class="w">  </span><span class="c1"># ... 既存のコード ...</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([])</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">socket</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:mode</span><span class="p">,</span><span class="w"> </span><span class="ss">:playing</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:score</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:chain</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:stage</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:player</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">)</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div</span>
<span class="sh">      id=&quot;game-container&quot;</span>
<span class="sh">      class=&quot;flex gap-8 p-8&quot;</span>
<span class="sh">      phx-window-keydown=&quot;keydown&quot;</span>
<span class="sh">      phx-throttle=&quot;100&quot;</span>
<span class="sh">    &gt;</span>
<span class="sh">      &lt;div id=&quot;game-board&quot; class=&quot;relative bg-gray-100 border-2 border-gray-800 rounded-lg&quot;&gt;</span>
<span class="sh">        &lt;div class=&quot;grid&quot; style={&quot;grid-template-columns: repeat(#{@stage.cols}, 32px);&quot;}&gt;</span>
<span class="sh">          &lt;%= for row &lt;- 0..(@stage.rows - 1) do %&gt;</span>
<span class="sh">            &lt;%= for col &lt;- 0..(@stage.cols - 1) do %&gt;</span>
<span class="sh">              &lt;div</span>
<span class="sh">                class=&quot;border border-gray-300&quot;</span>
<span class="sh">                style=&quot;width: 32px; height: 32px;&quot;</span>
<span class="sh">              &gt;</span>
<span class="sh">                &lt;%= render_puyo(Stage.get_puyo(@stage, col, row)) %&gt;</span>
<span class="sh">              &lt;/div&gt;</span>
<span class="sh">            &lt;% end %&gt;</span>
<span class="sh">          &lt;% end %&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;!-- プレイヤーのぷよペアを描画 --&gt;</span>
<span class="sh">        &lt;%= if @mode == :playing do %&gt;</span>
<span class="sh">          &lt;%= render_player_puyo(@player, 0) %&gt;</span>
<span class="sh">          &lt;%= render_player_puyo(@player, 1) %&gt;</span>
<span class="sh">        &lt;% end %&gt;</span>
<span class="sh">      &lt;/div&gt;</span>

<span class="sh">      &lt;div id=&quot;info-panel&quot; class=&quot;bg-white p-6 rounded-lg shadow-lg&quot;&gt;</span>
<span class="sh">        &lt;h2 class=&quot;text-2xl font-bold mb-4&quot;&gt;ぷよぷよゲーム&lt;/h2&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;スコア&lt;/h3&gt;</span>
<span class="sh">          &lt;p id=&quot;score&quot; class=&quot;text-3xl font-bold text-blue-600&quot;&gt;&lt;%= @score %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;連鎖数&lt;/h3&gt;</span>
<span class="sh">          &lt;p id=&quot;chain&quot; class=&quot;text-3xl font-bold text-red-600&quot;&gt;&lt;%= @chain %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mt-6 text-sm text-gray-600&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;font-semibold mb-2&quot;&gt;操作方法&lt;/h3&gt;</span>
<span class="sh">          &lt;ul class=&quot;space-y-1&quot;&gt;</span>
<span class="sh">            &lt;li&gt;← →: 移動&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;↑: 回転&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;↓: 高速落下&lt;/li&gt;</span>
<span class="sh">          &lt;/ul&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">      &lt;/div&gt;</span>
<span class="sh">    &lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># キーボードイベントの処理</span>
<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;keydown&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="s2">&quot;key&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># キー入力の処理</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ArrowLeft&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">player</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">stage</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:player</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ArrowRight&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">player</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">stage</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:player</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ArrowUp&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">player</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">stage</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:player</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">_key</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">socket</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># プレイヤーのぷよを描画</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">render_player_puyo</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">}</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_type</span><span class="p">}</span>

<span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">          </span><span class="n">offset_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="p">)</span>
<span class="w">          </span><span class="n">offset_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">next_puyo_type</span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>

<span class="w">    </span><span class="n">assigns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="ss">x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ss">y</span><span class="p">:</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="ss">color</span><span class="p">:</span><span class="w"> </span><span class="n">color</span><span class="p">}</span>

<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div</span>
<span class="sh">      class=&quot;absolute rounded-full&quot;</span>
<span class="sh">      style={&quot;</span>
<span class="sh">        left: #{@x * 32}px;</span>
<span class="sh">        top: #{@y * 32}px;</span>
<span class="sh">        width: 32px;</span>
<span class="sh">        height: 32px;</span>
<span class="sh">        background-color: #{@color};</span>
<span class="sh">        border: 2px solid rgba(0,0,0,0.2);</span>
<span class="sh">        z-index: 10;</span>
<span class="sh">      &quot;}</span>
<span class="sh">    &gt;</span>
<span class="sh">    &lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ... 既存のプライベート関数 ...</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="phoenix-liveview_3">解説: Phoenix LiveViewのイベント処理<a class="headerlink" href="#phoenix-liveview_3" title="Permanent link">&para;</a></h3>
<h4 id="_65">キーボードイベントのバインディング<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">phx</span><span class="o">-</span><span class="n">window</span><span class="o">-</span><span class="n">keydown</span><span class="o">=</span><span class="s2">&quot;keydown&quot;</span>
<span class="n">phx</span><span class="o">-</span><span class="n">throttle</span><span class="o">=</span><span class="s2">&quot;100&quot;</span>
</code></pre></div>
<ul>
<li><code>phx-window-keydown="keydown"</code>: ウィンドウ全体のキーダウンイベントを<code>keydown</code>という名前でLiveViewに送信</li>
<li><code>phx-throttle="100"</code>: イベントを100ms間隔でスロットル（連続入力の制御）</li>
</ul>
<h4 id="_66">イベントハンドラー<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;keydown&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="s2">&quot;key&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p><code>handle_event/3</code>コールバックで、クライアントから送信されたイベントを処理します。</p>
<h4 id="_67">状態の更新<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ArrowLeft&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">player</span>
<span class="w">  </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">stage</span>
<span class="w">  </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">  </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:player</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<ul>
<li><code>socket.assigns</code>から現在の状態を取得</li>
<li>Playerモジュールの関数を呼び出して新しい状態を取得</li>
<li><code>assign/3</code>で新しい状態をsocketに設定</li>
</ul>
<p>Phoenix LiveViewは、状態が変更されると自動的に<code>render/1</code>を再実行し、変更された部分だけをクライアントに送信します。</p>
<h3 id="_68">テスト実行（統合テスト）<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>最後に、すべてのテストを実行して、統合が正しく動作することを確認します：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_69">動作確認<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>サーバーを起動して、ブラウザで確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>phx.server
</code></pre></div>
<p>ブラウザで <code>http://localhost:4000/game</code> にアクセスし、以下を確認します：</p>
<ul>
<li>画面上部にぷよペアが表示される</li>
<li>矢印キー←→でぷよペアが左右に移動する</li>
<li>矢印キー↑でぷよペアが回転する</li>
<li>壁際で回転すると壁キックが動作する</li>
</ul>
<h3 id="_70">コミット<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>機能が完成したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>-A
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: プレイヤーモジュールの実装</span>

<span class="s2">- Playerモジュールの作成（lib/puyo_puyo/player.ex）</span>
<span class="s2">- ぷよペアの生成（軸ぷよと次ぷよ）</span>
<span class="s2">- 左右移動機能（move_left/2, move_right/2）</span>
<span class="s2">  - 境界チェック</span>
<span class="s2">  - 衝突判定（軸ぷよと次ぷよの両方）</span>
<span class="s2">- 回転機能（rotate_right/2）</span>
<span class="s2">  - 壁キック処理</span>
<span class="s2">  - {:ok, value} | :error パターン</span>
<span class="s2">- 着地判定（can_move_down?/2）</span>
<span class="s2">  - 回転状態に応じた判定ロジック</span>
<span class="s2">- 着地処理（land/2）</span>
<span class="s2">- GameLiveとの統合</span>
<span class="s2">  - phx-window-keydown イベントバインディング</span>
<span class="s2">  - handle_event/3 コールバック</span>
<span class="s2">  - プレイヤーぷよの描画</span>
<span class="s2">- 包括的なテストカバレッジ（13テストケース）</span>

<span class="s2">イテレーション3完了&quot;</span>
</code></pre></div>
<h3 id="_71">まとめ<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>イテレーション3で以下を達成しました：</p>
<h4 id="_72">得られたもの<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Playerモジュール</strong></li>
<li>ぷよペアの状態管理</li>
<li>軸ぷよと次ぷよの構成</li>
<li>
<p>回転状態（0-3）の管理</p>
</li>
<li>
<p><strong>移動機能</strong></p>
</li>
<li><code>move_left/2</code>: 左移動</li>
<li><code>move_right/2</code>: 右移動</li>
<li>境界チェックと衝突判定</li>
<li>
<p>軸ぷよと次ぷよの両方をチェック</p>
</li>
<li>
<p><strong>回転機能</strong></p>
</li>
<li><code>rotate_right/2</code>: 右回転</li>
<li>壁キック処理（自動位置調整）</li>
<li>
<p><code>{:ok, value}</code> | <code>:error</code> パターン</p>
</li>
<li>
<p><strong>着地機能</strong></p>
</li>
<li><code>can_move_down?/2</code>: 下に移動可能かチェック</li>
<li><code>land/2</code>: ステージにぷよペアを配置</li>
<li>
<p>回転状態に応じた着地判定</p>
</li>
<li>
<p><strong>LiveViewとの統合</strong></p>
</li>
<li><code>phx-window-keydown</code> イベント</li>
<li><code>handle_event/3</code> コールバック</li>
<li>リアルタイムな状態更新</li>
<li>プレイヤーぷよの描画</li>
</ol>
<h4 id="_73">学んだこと<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>Elixirのパターンマッチング</strong>
   <div class="highlight"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="n">check_rotation_with_wall_kick</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">new_x</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">rotation</span><span class="p">:</span><span class="w"> </span><span class="n">new_rotation</span><span class="p">,</span><span class="w"> </span><span class="ss">puyo_x</span><span class="p">:</span><span class="w"> </span><span class="n">new_x</span><span class="p">}</span>
<span class="w">  </span><span class="ss">:error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">player</span>
<span class="k">end</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Phoenix LiveViewのイベント処理</strong></p>
</li>
<li>クライアントからサーバーへのイベント送信</li>
<li>サーバーサイドでの状態更新</li>
<li>
<p>自動的な画面更新</p>
</li>
<li>
<p><strong>壁キック処理</strong></p>
</li>
<li>プレイヤー体験の向上</li>
<li><code>cond</code>式による条件分岐</li>
<li>
<p>段階的な位置調整</p>
</li>
<li>
<p><strong>単一責任の原則</strong></p>
</li>
<li>Playerモジュール: プレイヤーの操作</li>
<li>Stageモジュール: ステージの管理</li>
<li>
<p>GameLive: UIと統合</p>
</li>
<li>
<p><strong>テスト駆動開発</strong></p>
</li>
<li>エッジケースの洗い出し</li>
<li>境界条件のテスト</li>
<li>統合テストによる動作確認</li>
</ol>
<h4 id="_74">次のステップ<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h4>
<p>プレイヤーの基本操作が完成しました。次のイテレーションでは、以下を実装していきます：</p>
<ul>
<li><strong>イテレーション4</strong>: ゲームループの実装（重力と自動落下）</li>
<li><strong>イテレーション5</strong>: スコアと連鎖の実装</li>
<li><strong>イテレーション6</strong>: ゲームオーバーの実装</li>
</ul>
<p>これらをテスト駆動開発のサイクルに従って、一つずつ実装していきましょう！</p>
<hr />
<h2 id="4">イテレーション4: ゲームループの実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>イテレーション3でプレイヤーの操作が完成しました。次は、「ゲームが自動的に進行する」機能の実装です。このイテレーションでは、ゲームループ、重力による自動落下、ゲームモードの状態遷移を実装します。</p>
<blockquote>
<p>ゲームループ</p>
<p>ゲームループは、ゲームの心臓部です。時間の経過とともにゲームの状態を更新し、画面を再描画する処理を繰り返すことで、動きのあるゲームを実現します。</p>
<p>— Robert Nystrom 『Game Programming Patterns』</p>
</blockquote>
<h3 id="_75">ユーザーストーリー<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよペアが自動的に落下し、着地後は自動的に次のぷよペアが生成される</p>
</blockquote>
<p>このストーリーには、以下の機能が含まれています：</p>
<ol>
<li>定期的な更新処理（ゲームループ）</li>
<li>重力による自動落下</li>
<li>着地判定と着地処理</li>
<li>新しいぷよペアの自動生成</li>
<li>ゲームモードの状態遷移</li>
</ol>
<p>それでは、これらの機能を一つずつテスト駆動開発で実装していきましょう！</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>「ゲームループの実装」というユーザーストーリーを実現するために、以下のタスクが必要です：</p>
<ul>
<li>ゲームモードを定義する（新ぷよ、プレイ中、消去確認など）</li>
<li>Gameモジュールを作成する（ゲームの状態管理）</li>
<li>Process.send_afterを使ったゲームループを実装する</li>
<li>handle_info/2コールバックで定期更新を実装する</li>
<li>デルタ時間ベースの更新を実装する</li>
<li>重力を適用する処理を実装する（1フレームで1マス落下）</li>
<li>着地後の処理を実装する</li>
<li>GameLiveと統合する</li>
</ul>
<p>これらのタスクを一つずつ実装していきます。まずは「ゲームモードの定義」から始めましょう！</p>
<h3 id="_76">ゲームモードの設計<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>まず、ゲームの状態を表すゲームモードを設計します。ぷよぷよのゲームは、以下のような状態遷移を持ちます：</p>
<div class="highlight"><pre><span></span><code>新ぷよ → プレイ中 → 消去確認 → 落下確認 → 落下中 → 消去確認 → ... → 新ぷよ
                                  ↓
                             ゲームオーバー
</code></pre></div>
<h4 id="_77">ゲームモードの種類<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h4>
<ul>
<li><strong><code>:new_puyo</code>（新ぷよ）</strong>: 新しいぷよペアを生成する状態</li>
<li><strong><code>:playing</code>（プレイ中）</strong>: プレイヤーがぷよを操作している状態</li>
<li><strong><code>:check_erase</code>（消去確認）</strong>: ぷよの消去判定を行う状態</li>
<li><strong><code>:check_fall</code>（落下確認）</strong>: 浮いているぷよがあるかチェックする状態</li>
<li><strong><code>:falling</code>（落下中）</strong>: ぷよが落下している状態</li>
<li><strong><code>:game_over</code>（ゲームオーバー）</strong>: ゲーム終了状態</li>
</ul>
<h3 id="game">テスト: Gameモジュールの初期化<a class="headerlink" href="#game" title="Permanent link">&para;</a></h3>
<p>まず、ゲームの状態を管理するGameモジュールをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/game_test.exs</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.GameTest</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo.Game</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Game.new/0&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;creates a new game with initial state&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="w">      </span><span class="c1"># 初期モードは:new_puyo</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:new_puyo</span>
<span class="w">      </span><span class="c1"># 連鎖数は0</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="c1"># ステージが初期化されている</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="no">nil</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Game.update/2&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;spawns new puyo in :new_puyo mode&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="w">      </span><span class="c1"># 更新を実行</span>
<span class="w">      </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="mf">16.0</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># プレイ中モードに移行</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:playing</span>
<span class="w">      </span><span class="c1"># プレイヤーが生成されている</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="no">nil</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;transitions to :game_over when cannot spawn&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="w">      </span><span class="c1"># 初期位置(2, 0)にぷよを配置してゲームオーバーを引き起こす</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">PuyoPuyo.Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span>

<span class="w">      </span><span class="c1"># 更新を実行</span>
<span class="w">      </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="mf">16.0</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># ゲームオーバーモードに移行</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:game_over</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="game_1">実装: Gameモジュールの基本構造<a class="headerlink" href="#game_1" title="Permanent link">&para;</a></h3>
<p>テストを実行すると失敗します（Red）。では、テストが通るように最小限のコードを実装しましょう（Green）。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo/game.ex</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.Game</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">ぷよぷよゲームの状態を管理するモジュール</span>

<span class="sh">  ゲームモード、連鎖数、各コンポーネントの状態を管理します。</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo</span><span class="o">.</span><span class="p">{</span><span class="nc">Stage</span><span class="p">,</span><span class="w"> </span><span class="nc">Player</span><span class="p">}</span>

<span class="w">  </span><span class="na">@type</span><span class="w"> </span><span class="n">game_mode</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:playing</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:check_erase</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:check_fall</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:falling</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:game_over</span>

<span class="w">  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">          </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="n">game_mode</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span>
<span class="w">          </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span>
<span class="w">          </span><span class="ss">last_update</span><span class="p">:</span><span class="w"> </span><span class="n">integer</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="ss">:mode</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:chain</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:stage</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:player</span><span class="p">,</span>
<span class="w">    </span><span class="ss">:last_update</span>
<span class="w">  </span><span class="p">]</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">新しいゲームを作成します</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; game = PuyoPuyo.Game.new()</span>
<span class="sh">      iex&gt; game.mode</span>
<span class="sh">      :new_puyo</span>

<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">new</span><span class="p">()</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">      </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">,</span>
<span class="w">      </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">([]),</span>
<span class="w">      </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span>
<span class="w">      </span><span class="ss">last_update</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">monotonic_time</span><span class="p">(</span><span class="ss">:millisecond</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">ゲームの状態を更新します</span>

<span class="sh">  デルタ時間（ミリ秒）を受け取り、ゲームモードに応じて処理を実行します。</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; game = PuyoPuyo.Game.new()</span>
<span class="sh">      iex&gt; game = PuyoPuyo.Game.update(game, 16.0)</span>
<span class="sh">      iex&gt; game.mode</span>
<span class="sh">      :playing</span>

<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">float</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="n">mode</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="ss">:new_puyo</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handle_new_puyo</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

<span class="w">      </span><span class="ss">:playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handle_playing</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span>

<span class="w">      </span><span class="ss">:check_erase</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handle_check_erase</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

<span class="w">      </span><span class="ss">:check_fall</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handle_check_fall</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

<span class="w">      </span><span class="ss">:falling</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handle_falling</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>

<span class="w">      </span><span class="ss">:game_over</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">game</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 新ぷよモードの処理</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">handle_new_puyo</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_new_puyo</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_spawn?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># ぷよペアを生成できる場合</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:playing</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># ゲームオーバー</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:game_over</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># プレイ中モードの処理</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">handle_playing</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">float</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_playing</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># プレイヤーを更新（重力を適用）</span>
<span class="w">    </span><span class="p">{</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">landed</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_player_gravity</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">landed</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># 着地した場合、ぷよをステージに配置</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">land</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">,</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># プレイヤーに重力を適用</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">update_player_gravity</span><span class="p">(</span><span class="nc">Player</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">float</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p">{</span><span class="nc">Player</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">boolean</span><span class="p">()}</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">update_player_gravity</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 簡易的な実装：一定時間ごとに1マス落下</span>
<span class="w">    </span><span class="c1"># 実際はプレイヤーに落下タイマーを持たせるべき</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_move_down?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># 下に移動できる場合、Y座標を1増やす</span>
<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">puyo_y</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="no">false</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># 下に移動できない場合、着地</span>
<span class="w">      </span><span class="p">{</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 消去確認モードの処理</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">handle_check_erase</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_check_erase</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># 消去対象がある場合</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">erase_puyos</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">)</span>
<span class="w">      </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># 消去対象がない場合</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># 着地直後で消去なし→落下確認（浮いているぷよを落とす）</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="c1"># 連鎖後で消去なし→連鎖終了</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 落下確認モードの処理</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">handle_check_fall</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_check_fall</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="n">has_fallen</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># ぷよが落下した場合、落下中モードへ</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:falling</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># 落下するぷよがない場合</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># 着地後の初回落下で落下なし→新ぷよへ</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="c1"># 連鎖中の落下で落下なし→消去確認で最後のチェック</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 落下中モードの処理</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">handle_falling</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_falling</span><span class="p">(</span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># 落下アニメーション用（簡略化のため、すぐに落下確認に戻る）</span>
<span class="w">    </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_78">解説: ゲームモードの状態遷移<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>実装したGameモジュールについて、重要なポイントを解説します。</p>
<h4 id="_79">ゲームモードによる処理の分岐<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="n">mode</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="ss">:new_puyo</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_new_puyo</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">    </span><span class="ss">:playing</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_playing</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span>
<span class="w">    </span><span class="ss">:check_erase</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_check_erase</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># ...</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><code>case</code>式でゲームモードに応じた処理を振り分けます。各モードは独立した関数として実装されており、単一責任の原則に従っています。</p>
<h4 id="_80">状態遷移の例<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defp</span><span class="w"> </span><span class="n">handle_new_puyo</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_spawn?</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:playing</span><span class="p">,</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:game_over</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>新ぷよモードでは：
1. 新しいプレイヤーを生成
2. 生成可能なら<code>:playing</code>モードへ移行
3. 生成不可能なら<code>:game_over</code>モードへ移行</p>
<h4 id="_81">連鎖数の管理<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defp</span><span class="w"> </span><span class="n">handle_check_erase</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="p">{</span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>連鎖数は、消去が発生するたびに増加します。消去がなくなったら連鎖終了として連鎖数を0にリセットします。</p>
<h3 id="_82">テスト実行<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/game_test.exs
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="liveview_5">LiveViewとの統合: ゲームループ<a class="headerlink" href="#liveview_5" title="Permanent link">&para;</a></h3>
<p>Gameモジュールが完成したので、GameLiveと統合してゲームループを実装します。</p>
<p>Phoenix LiveViewでは、<code>Process.send_after/3</code>を使ってサーバーサイドでゲームループを実装できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyo_puyo_web/live/game_live.ex（更新）</span>
<span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.GameLive</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">PuyoPuyoWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo</span><span class="o">.</span><span class="p">{</span><span class="nc">Stage</span><span class="p">,</span><span class="w"> </span><span class="nc">Player</span><span class="p">,</span><span class="w"> </span><span class="nc">Game</span><span class="p">}</span>

<span class="w">  </span><span class="c1"># ゲームループの更新間隔（ミリ秒）</span>
<span class="w">  </span><span class="na">@game_tick_interval</span><span class="w"> </span><span class="mi">16</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># ゲームを初期化</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">socket</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:score</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># ゲームループを開始（LiveView接続完了後に開始）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">connected?</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">schedule_game_tick</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div</span>
<span class="sh">      id=&quot;game-container&quot;</span>
<span class="sh">      class=&quot;flex gap-8 p-8&quot;</span>
<span class="sh">      phx-window-keydown=&quot;keydown&quot;</span>
<span class="sh">      phx-throttle=&quot;100&quot;</span>
<span class="sh">    &gt;</span>
<span class="sh">      &lt;div id=&quot;game-board&quot; class=&quot;relative bg-gray-100 border-2 border-gray-800 rounded-lg&quot;&gt;</span>
<span class="sh">        &lt;div class=&quot;grid&quot; style={&quot;grid-template-columns: repeat(#{@game.stage.cols}, 32px);&quot;}&gt;</span>
<span class="sh">          &lt;%= for row &lt;- 0..(@game.stage.rows - 1) do %&gt;</span>
<span class="sh">            &lt;%= for col &lt;- 0..(@game.stage.cols - 1) do %&gt;</span>
<span class="sh">              &lt;div</span>
<span class="sh">                class=&quot;border border-gray-300&quot;</span>
<span class="sh">                style=&quot;width: 32px; height: 32px;&quot;</span>
<span class="sh">              &gt;</span>
<span class="sh">                &lt;%= render_puyo(Stage.get_puyo(@game.stage, col, row)) %&gt;</span>
<span class="sh">              &lt;/div&gt;</span>
<span class="sh">            &lt;% end %&gt;</span>
<span class="sh">          &lt;% end %&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;!-- プレイヤーのぷよペアを描画 --&gt;</span>
<span class="sh">        &lt;%= if @game.mode == :playing &amp;&amp; @game.player do %&gt;</span>
<span class="sh">          &lt;%= render_player_puyo(@game.player, 0) %&gt;</span>
<span class="sh">          &lt;%= render_player_puyo(@game.player, 1) %&gt;</span>
<span class="sh">        &lt;% end %&gt;</span>

<span class="sh">        &lt;!-- ゲームオーバー画面 --&gt;</span>
<span class="sh">        &lt;%= if @game.mode == :game_over do %&gt;</span>
<span class="sh">          &lt;div class=&quot;absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center&quot;&gt;</span>
<span class="sh">            &lt;div class=&quot;bg-white p-8 rounded-lg text-center&quot;&gt;</span>
<span class="sh">              &lt;h2 class=&quot;text-3xl font-bold mb-4&quot;&gt;ゲームオーバー&lt;/h2&gt;</span>
<span class="sh">              &lt;p class=&quot;text-xl mb-4&quot;&gt;スコア: &lt;%= @score %&gt;&lt;/p&gt;</span>
<span class="sh">              &lt;button</span>
<span class="sh">                phx-click=&quot;restart&quot;</span>
<span class="sh">                class=&quot;bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded&quot;</span>
<span class="sh">              &gt;</span>
<span class="sh">                もう一度プレイ</span>
<span class="sh">              &lt;/button&gt;</span>
<span class="sh">            &lt;/div&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">        &lt;% end %&gt;</span>
<span class="sh">      &lt;/div&gt;</span>

<span class="sh">      &lt;div id=&quot;info-panel&quot; class=&quot;bg-white p-6 rounded-lg shadow-lg&quot;&gt;</span>
<span class="sh">        &lt;h2 class=&quot;text-2xl font-bold mb-4&quot;&gt;ぷよぷよゲーム&lt;/h2&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;スコア&lt;/h3&gt;</span>
<span class="sh">          &lt;p id=&quot;score&quot; class=&quot;text-3xl font-bold text-blue-600&quot;&gt;&lt;%= @score %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;連鎖数&lt;/h3&gt;</span>
<span class="sh">          &lt;p id=&quot;chain&quot; class=&quot;text-3xl font-bold text-red-600&quot;&gt;&lt;%= @game.chain %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mb-4&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;text-lg font-semibold&quot;&gt;モード&lt;/h3&gt;</span>
<span class="sh">          &lt;p class=&quot;text-sm text-gray-600&quot;&gt;&lt;%= format_mode(@game.mode) %&gt;&lt;/p&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;div class=&quot;mt-6 text-sm text-gray-600&quot;&gt;</span>
<span class="sh">          &lt;h3 class=&quot;font-semibold mb-2&quot;&gt;操作方法&lt;/h3&gt;</span>
<span class="sh">          &lt;ul class=&quot;space-y-1&quot;&gt;</span>
<span class="sh">            &lt;li&gt;← →: 移動&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;↑: 回転&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;↓: 高速落下&lt;/li&gt;</span>
<span class="sh">          &lt;/ul&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">      &lt;/div&gt;</span>
<span class="sh">    &lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ゲームループのティック</span>
<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_info</span><span class="p">(</span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>

<span class="w">    </span><span class="c1"># ゲームを更新</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>

<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 次のティックをスケジュール</span>
<span class="w">    </span><span class="n">schedule_game_tick</span><span class="p">()</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># キーボードイベントの処理</span>
<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;keydown&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="s2">&quot;key&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>

<span class="w">    </span><span class="c1"># プレイ中のみキー入力を処理</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:playing</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">game</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># リスタートイベントの処理</span>
<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">game</span><span class="p">:</span><span class="w"> </span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># プライベート関数</span>

<span class="w">  </span><span class="c1"># ゲームループをスケジュール</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">schedule_game_tick</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nc">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span><span class="w"> </span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># キー入力の処理</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ArrowLeft&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ArrowRight&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ArrowUp&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_key_input</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">,</span><span class="w"> </span><span class="n">_key</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">player</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ゲームモードのフォーマット</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:new_puyo</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;新ぷよ生成中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:playing</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;プレイ中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:check_erase</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;消去確認中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:check_fall</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;落下確認中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:falling</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;落下中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:game_over</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ゲームオーバー&quot;</span>

<span class="w">  </span><span class="c1"># プレイヤーのぷよを描画</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">render_player_puyo</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">}</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_type</span><span class="p">}</span>

<span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">          </span><span class="n">offset_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="p">)</span>
<span class="w">          </span><span class="n">offset_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">rotation</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span><span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset_x</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset_y</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="o">.</span><span class="n">next_puyo_type</span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>

<span class="w">    </span><span class="n">assigns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="ss">x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ss">y</span><span class="p">:</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="ss">color</span><span class="p">:</span><span class="w"> </span><span class="n">color</span><span class="p">}</span>

<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div</span>
<span class="sh">      class=&quot;absolute rounded-full&quot;</span>
<span class="sh">      style={&quot;</span>
<span class="sh">        left: #{@x * 32}px;</span>
<span class="sh">        top: #{@y * 32}px;</span>
<span class="sh">        width: 32px;</span>
<span class="sh">        height: 32px;</span>
<span class="sh">        background-color: #{@color};</span>
<span class="sh">        border: 2px solid rgba(0,0,0,0.2);</span>
<span class="sh">        z-index: 10;</span>
<span class="sh">      &quot;}</span>
<span class="sh">    &gt;</span>
<span class="sh">    &lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ぷよの描画（0は空、1-4はぷよの種類）</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">render_puyo</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">render_puyo</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
<span class="w">    </span><span class="n">assigns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="ss">color</span><span class="p">:</span><span class="w"> </span><span class="n">color</span><span class="p">}</span>

<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div class=&quot;w-full h-full rounded-full&quot; style={&quot;background-color: #{@color}; border: 2px solid rgba(0,0,0,0.2);&quot;}&gt;&lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># ぷよの色を返す</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">FF0000&quot;</span><span class="w">  </span><span class="c1"># 赤</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">00FF00&quot;</span><span class="w">  </span><span class="c1"># 緑</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">0000FF&quot;</span><span class="w">  </span><span class="c1"># 青</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">puyo_color</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;</span><span class="err">#</span><span class="s2">FFFF00&quot;</span><span class="w">  </span><span class="c1"># 黄</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="phoenix-liveview_4">解説: Phoenix LiveViewのゲームループ<a class="headerlink" href="#phoenix-liveview_4" title="Permanent link">&para;</a></h3>
<h4 id="processsend_after3">Process.send_after/3を使ったループ<a class="headerlink" href="#processsend_after3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defp</span><span class="w"> </span><span class="n">schedule_game_tick</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="nc">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span><span class="w"> </span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p><code>Process.send_after/3</code>を使って、一定間隔（16ms ≈ 60FPS）で<code>:game_tick</code>メッセージを自分自身に送信します。</p>
<h4 id="handle_info2">handle_info/2コールバック<a class="headerlink" href="#handle_info2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">handle_info</span><span class="p">(</span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>
<span class="w">  </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>
<span class="w">  </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)</span>
<span class="w">  </span><span class="n">schedule_game_tick</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p><code>:game_tick</code>メッセージを受け取ったら：
1. ゲームを更新
2. 状態をsocketに設定
3. 次のティックをスケジュール
4. LiveViewが自動的に画面を更新</p>
<h4 id="connected1">connected?/1による遅延開始<a class="headerlink" href="#connected1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">connected?</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">schedule_game_tick</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div>
<p><code>connected?/1</code>は、LiveViewがWebSocket接続を確立したかをチェックします。初回レンダリング時は<code>false</code>で、WebSocket接続後に<code>true</code>になります。これにより、サーバーサイドレンダリング時にゲームループが開始されるのを防ぎます。</p>
<h4 id="_83">ゲームモードによる描画制御<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:playing</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">player</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="n">render_player_puyo</span><span class="p">(</span><span class="na">@game</span><span class="o">.</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="n">render_player_puyo</span><span class="p">(</span><span class="na">@game</span><span class="o">.</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">%</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
</code></pre></div>
<p>プレイ中モードでプレイヤーが存在する場合のみ、ぷよペアを描画します。</p>
<h3 id="_84">テスト: 連鎖反応<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>次に、連鎖反応が正しく動作するかをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/puyo_puyo/game_test.exs（続き）</span>
<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Game chain reaction&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;chain reaction occurs when erasable puyos fall&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">stage</span>

<span class="w">    </span><span class="c1"># 赤ぷよを2×2の正方形に配置（消去対象）</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 青ぷよを配置（赤ぷよ消去後に落下して連鎖を起こす）</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1"># 横に1つ</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">   </span><span class="c1"># 上から縦に3つ</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># 1回目の更新：消去確認（赤ぷよが消去される）</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="mf">16.0</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:check_fall</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1"># 2回目の更新：落下確認（青ぷよが落下）</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="mf">16.0</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:falling</span>

<span class="w">    </span><span class="c1"># 落下が完了するまで更新を繰り返す</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repeat_update_until_mode</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 3回目の消去確認（青ぷよが4つ揃って消去）</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="mf">16.0</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 連鎖が発生したことを確認</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># ヘルパー関数</span>
<span class="kd">defp</span><span class="w"> </span><span class="n">repeat_update_until_mode</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">target_mode</span><span class="p">,</span><span class="w"> </span><span class="n">max_iterations</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce_while</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="n">max_iterations</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">game_acc</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">game_acc</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">target_mode</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:halt</span><span class="p">,</span><span class="w"> </span><span class="n">game_acc</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:cont</span><span class="p">,</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game_acc</span><span class="p">,</span><span class="w"> </span><span class="mf">16.0</span><span class="p">)}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="_85">テスト実行（統合テスト）<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>最後に、すべてのテストを実行して、統合が正しく動作することを確認します：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>すべてのテストが通ることを確認します（Green）。</p>
<h3 id="_86">動作確認<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>サーバーを起動して、ブラウザで確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>phx.server
</code></pre></div>
<p>ブラウザで <code>http://localhost:4000/game</code> にアクセスし、以下を確認します：</p>
<ul>
<li>ぷよペアが自動的に落下する</li>
<li>矢印キーでぷよペアを操作できる</li>
<li>着地後、自動的に次のぷよペアが生成される</li>
<li>同じ色のぷよが4つつながると消去される</li>
<li>消去後に上のぷよが落下する</li>
<li>連鎖が発生する</li>
</ul>
<h3 id="_87">コミット<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<p>機能が完成したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>-A
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: ゲームループとゲームモードの実装</span>

<span class="s2">- Gameモジュールの作成（lib/puyo_puyo/game.ex）</span>
<span class="s2">- ゲームモードの定義（:new_puyo, :playing, :check_erase, :check_fall, :falling, :game_over）</span>
<span class="s2">- 状態遷移の実装</span>
<span class="s2">  - 新ぷよ生成</span>
<span class="s2">  - プレイ中の処理</span>
<span class="s2">  - 消去確認と実行</span>
<span class="s2">  - 落下確認と実行</span>
<span class="s2">- Process.send_afterを使ったゲームループ</span>
<span class="s2">  - handle_info/2コールバック</span>
<span class="s2">  - 16ms間隔の定期更新（60FPS）</span>
<span class="s2">- デルタ時間ベースの更新</span>
<span class="s2">- 重力の自動適用</span>
<span class="s2">- 連鎖反応の実装</span>
<span class="s2">- GameLiveとの統合</span>
<span class="s2">  - ゲームループの開始</span>
<span class="s2">  - モード表示</span>
<span class="s2">  - ゲームオーバー画面</span>
<span class="s2">  - リスタート機能</span>
<span class="s2">- 包括的なテストカバレッジ（連鎖テストを含む）</span>

<span class="s2">イテレーション4完了&quot;</span>
</code></pre></div>
<h3 id="_88">まとめ<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h3>
<p>イテレーション4で以下を達成しました：</p>
<h4 id="_89">得られたもの<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Gameモジュール</strong></li>
<li>ゲームの状態管理</li>
<li>ゲームモードによる処理の分岐</li>
<li>
<p>連鎖数の管理</p>
</li>
<li>
<p><strong>ゲームモード</strong></p>
</li>
<li><code>:new_puyo</code>: 新しいぷよペア生成</li>
<li><code>:playing</code>: プレイヤー操作</li>
<li><code>:check_erase</code>: 消去判定</li>
<li><code>:check_fall</code>: 落下確認</li>
<li><code>:falling</code>: 落下中</li>
<li>
<p><code>:game_over</code>: ゲーム終了</p>
</li>
<li>
<p><strong>ゲームループ</strong></p>
</li>
<li><code>Process.send_after/3</code>による定期更新</li>
<li><code>handle_info/2</code>コールバック</li>
<li>16ms間隔の更新（60FPS）</li>
<li>
<p><code>connected?/1</code>による遅延開始</p>
</li>
<li>
<p><strong>状態遷移</strong></p>
</li>
<li>新ぷよ → プレイ中 → 消去確認 → 落下確認 → ...</li>
<li>連鎖反応の実装</li>
<li>
<p>ゲームオーバー判定</p>
</li>
<li>
<p><strong>LiveViewとの統合</strong></p>
</li>
<li>サーバーサイドゲームループ</li>
<li>自動的な画面更新</li>
<li>モード表示</li>
<li>リスタート機能</li>
</ol>
<h4 id="_90">学んだこと<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>Process.send_after/3</strong>
   <div class="highlight"><pre><span></span><code><span class="nc">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span><span class="w"> </span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>
</code></pre></div>
   自分自身に遅延メッセージを送信することで、定期的な処理を実現</p>
</li>
<li>
<p><strong>handle_info/2コールバック</strong>
   <div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">handle_info</span><span class="p">(</span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1"># ゲームを更新</span>
<span class="w">  </span><span class="n">schedule_game_tick</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
   メッセージを受け取って処理するコールバック</p>
</li>
<li>
<p><strong>ゲームループのパターン</strong></p>
</li>
<li>更新（Update）: 状態の変更</li>
<li>描画（Render）: LiveViewが自動的に実行</li>
<li>
<p>ループ（Loop）: Process.send_afterで実現</p>
</li>
<li>
<p><strong>状態遷移パターン</strong>
   <div class="highlight"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="ss">:new_puyo</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_new_puyo</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:playing</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_playing</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div>
   パターンマッチングによる状態遷移の実装</p>
</li>
<li>
<p><strong>connected?/1による制御</strong></p>
</li>
<li>初回レンダリングとWebSocket接続後の処理を分離</li>
<li>サーバーサイドレンダリング時の不要な処理を防ぐ</li>
</ol>
<h4 id="_91">次のステップ<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h4>
<p>ゲームの基本的な流れが完成しました。次のイテレーションでは、以下を実装していきます：</p>
<ul>
<li><strong>イテレーション5</strong>: スコアシステムの実装（スコア計算、連鎖ボーナス）</li>
<li><strong>イテレーション6</strong>: UI/UXの改善（アニメーション、エフェクト）</li>
</ul>
<p>これらをテスト駆動開発のサイクルに従って、一つずつ実装していきましょう！</p>
<hr />
<h2 id="5_1">イテレーション5: スコアシステムの実装<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h2>
<p>ゲームの基本的な流れが完成しましたが、ぷよぷよの醍醐味の一つは「スコア」と「連鎖ボーナス」です！プレイヤーは高いスコアを目指してプレイするため、スコアシステムはゲームの面白さを大きく左右します。このイテレーションでは、スコア計算と連鎖ボーナスの実装に焦点を当てます。</p>
<h3 id="_92">ユーザーストーリー<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよを消去したときにスコアが加算され、連鎖が発生すると高い連鎖ボーナスが得られる</p>
</blockquote>
<p>「スコアシステムがあるとゲームがもっと面白くなりますね！」そうです！スコアと連鎖ボーナスは、プレイヤーのモチベーションを高める重要な要素です。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<blockquote>
<p>TODOリストは、実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>スコアシステムを実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>Scoreモジュールの作成</li>
<li>スコア計算ロジックの実装（基本点 + 連鎖ボーナス）</li>
<li>Gameモジュールとの統合（消去時のスコア記録）</li>
<li>LiveViewでのスコア表示</li>
<li>スコアのテスト作成</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="score">テスト: Scoreモジュール<a class="headerlink" href="#score" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、Scoreモジュールの基本的な機能をテストしましょう。スコア計算のロジックが正しく動作することを確認します。</p>
<h4 id="testpuyo_puyoscore_testexs">test/puyo_puyo/score_test.exs<a class="headerlink" href="#testpuyo_puyoscore_testexs" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.ScoreTest</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo.Score</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Score.new/0&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;creates a new score with zero values&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Score.record_erase/3&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;calculates score from erase count&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">      </span><span class="c1"># 4個消去、連鎖なし（1連鎖目）</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># 基本点 = 4 × 10 = 40</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">40</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;adds chain bonus for multiple chains&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">      </span><span class="c1"># 1連鎖目: 4個消去</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="c1"># 基本点 = 4 × 10 = 40</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">40</span>

<span class="w">      </span><span class="c1"># 2連鎖目: 4個消去</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="c1"># 基本点 = 4 × 10 = 40</span>
<span class="w">      </span><span class="c1"># 連鎖ボーナス = 2 × 2 × 50 = 200</span>
<span class="w">      </span><span class="c1"># 合計 = 40 + (40 + 200) = 280</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">280</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;calculates higher bonus for longer chains&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">      </span><span class="c1"># 1連鎖目: 4個消去</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="c1"># 2連鎖目: 4個消去</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="c1"># 3連鎖目: 4個消去</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="w">      </span><span class="c1"># 基本点 = 40 + (40 + 200) + (40 + 450) = 770</span>
<span class="w">      </span><span class="c1"># 3連鎖のボーナス = 3 × 3 × 50 = 450</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">770</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Score.end_chain/1&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;resets current chain to zero&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>

<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">end_chain</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="c1"># スコアは保持される</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Score.reset/1&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;resets both score and chain to zero&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">assert</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li><strong>Score.new/0</strong>: 初期化時にスコアと連鎖数が0であること</li>
<li><strong>Score.record_erase/3</strong>: 消去数からスコアを正しく計算すること</li>
<li>基本点 = 消去数 × 10</li>
<li>連鎖ボーナス = 連鎖数 × 連鎖数 × 50（2連鎖以上の場合）</li>
<li><strong>Score.end_chain/1</strong>: 連鎖終了時に連鎖数をリセットすること</li>
<li><strong>Score.reset/1</strong>: スコアと連鎖数の両方をリセットすること</li>
</ol>
<p>「スコア計算のロジックはどうなっているんですか？」良い質問ですね！スコア計算は以下のようになっています：</p>
<div class="highlight"><pre><span></span><code>獲得点 = 基本点 + 連鎖ボーナス
基本点 = 消去数 × 10
連鎖ボーナス = (連鎖数 ≥ 2 の場合) 連鎖数 × 連鎖数 × 50
</code></pre></div>
<p>例えば、2連鎖で4個消去すると：
- 基本点 = 4 × 10 = 40
- 連鎖ボーナス = 2 × 2 × 50 = 200
- 獲得点 = 40 + 200 = 240</p>
<p>「なるほど、連鎖が長くなるほどボーナスが大きくなるんですね！」そうです！では、このテストが通るように実装していきましょう。</p>
<h3 id="score_1">実装: Scoreモジュール<a class="headerlink" href="#score_1" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、Scoreモジュールを実装していきましょう。</p>
<blockquote>
<p>最小限の実装</p>
<p>テストを通すために、どれだけのコードを書けばよいだろうか——テストが通る最小限のコードだけを書こう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h4 id="libpuyo_puyoscoreex">lib/puyo_puyo/score.ex<a class="headerlink" href="#libpuyo_puyoscoreex" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.Score</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">スコア管理モジュール</span>

<span class="sh">  ぷよの消去とスコア計算を行います。</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>

<span class="w">  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">    </span><span class="ss">current_score</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span>
<span class="w">    </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">defstruct</span><span class="w"> </span><span class="ss">current_score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">新しいスコアを作成します。</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; score = Score.new()</span>
<span class="sh">      iex&gt; score.current_score</span>
<span class="sh">      0</span>
<span class="sh">      iex&gt; score.current_chain</span>
<span class="sh">      0</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">new</span><span class="p">()</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">      </span><span class="ss">current_score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">消去を記録してスコアを計算します。</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> スコア計算式</span>

<span class="sh">  - 基本点 = 消去数 × 10</span>
<span class="sh">  - 連鎖ボーナス = (連鎖数 ≥ 2 の場合) 連鎖数 × 連鎖数 × 50</span>
<span class="sh">  - 獲得点 = 基本点 + 連鎖ボーナス</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; score = Score.new()</span>
<span class="sh">      iex&gt; score = Score.record_erase(score, 4, 1)</span>
<span class="sh">      iex&gt; score.current_score</span>
<span class="sh">      40</span>

<span class="sh">      iex&gt; score = Score.new()</span>
<span class="sh">      iex&gt; score = Score.record_erase(score, 4, 1)</span>
<span class="sh">      iex&gt; score = Score.record_erase(score, 4, 2)</span>
<span class="sh">      iex&gt; score.current_score</span>
<span class="sh">      280</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">record_erase</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">record_erase</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># スコア計算</span>
<span class="w">    </span><span class="n">base_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="n">chain_bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">gained_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_points</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">chain_bonus</span>

<span class="w">    </span><span class="p">%{</span><span class="n">score</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="ss">current_score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gained_points</span><span class="p">,</span>
<span class="w">      </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">連鎖を終了します。</span>

<span class="sh">  連鎖数を0にリセットしますが、スコアは保持されます。</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; score = Score.new()</span>
<span class="sh">      iex&gt; score = Score.record_erase(score, 4, 2)</span>
<span class="sh">      iex&gt; score = Score.end_chain(score)</span>
<span class="sh">      iex&gt; score.current_chain</span>
<span class="sh">      0</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">end_chain</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">end_chain</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="p">%{</span><span class="n">score</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">スコアをリセットします。</span>

<span class="sh">  スコアと連鎖数の両方を0にリセットします。</span>

<span class="sh">  </span><span class="err">##</span><span class="sh"> Examples</span>

<span class="sh">      iex&gt; score = Score.new()</span>
<span class="sh">      iex&gt; score = Score.record_erase(score, 4, 2)</span>
<span class="sh">      iex&gt; score = Score.reset(score)</span>
<span class="sh">      iex&gt; score.current_score</span>
<span class="sh">      0</span>
<span class="sh">      iex&gt; score.current_chain</span>
<span class="sh">      0</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">reset</span><span class="p">(</span><span class="n">t</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">reset</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{})</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">new</span><span class="p">()</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>「実装のポイントはどこですか？」良い質問ですね！以下のポイントに注目してください：</p>
<ol>
<li>
<p><strong>構造体の定義</strong>
   <div class="highlight"><pre><span></span><code><span class="kd">defstruct</span><span class="w"> </span><span class="ss">current_score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">          </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
   現在のスコアと連鎖数を保持する構造体を定義しています。</p>
</li>
<li>
<p><strong>スコア計算ロジック</strong>
   <div class="highlight"><pre><span></span><code><span class="n">base_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span>
<span class="n">chain_bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="n">gained_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_points</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">chain_bonus</span>
</code></pre></div>
   基本点と連鎖ボーナスを計算し、獲得点を算出しています。</p>
</li>
<li>
<p><strong>イミュータブルな更新</strong>
   <div class="highlight"><pre><span></span><code><span class="p">%{</span><span class="n">score</span><span class="w"> </span><span class="o">|</span>
<span class="w">  </span><span class="ss">current_score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gained_points</span><span class="p">,</span>
<span class="w">  </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span>
<span class="p">}</span>
</code></pre></div>
   既存の構造体を変更するのではなく、新しい構造体を作成して返しています。</p>
</li>
</ol>
<p>「なるほど、Elixirのイミュータブルな特性を活かした実装なんですね！」そうです！では、テストを実行して確認しましょう。</p>
<h3 id="_93">テストの実行<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/score_test.exs
</code></pre></div>
<p>テストが全て通ることを確認してください。</p>
<div class="highlight"><pre><span></span><code>Compiling 1 file (.ex)
.....

Finished in 0.03 seconds (0.00s async, 0.03s sync)
5 tests, 0 failures
</code></pre></div>
<p>「全てのテストが通りました！」素晴らしい！これで、Scoreモジュールの基本的な機能が完成しました。</p>
<h3 id="game_2">Gameモジュールとの統合<a class="headerlink" href="#game_2" title="Permanent link">&para;</a></h3>
<p>「次は何をすればいいですか？」次は、GameモジュールにScoreを統合して、消去が発生したときにスコアを記録するようにします。</p>
<h4 id="testpuyo_puyogame_testexs">test/puyo_puyo/game_test.exs（追加）<a class="headerlink" href="#testpuyo_puyogame_testexs" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Game with score&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;records score when puyos are erased&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">stage</span>

<span class="w">    </span><span class="c1"># 赤ぷよを2×2の正方形に配置（消去対象）</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># 消去確認を実行</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># スコアが記録されていることを確認</span>
<span class="w">    </span><span class="c1"># 基本点 = 4 × 10 = 40</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">40</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="s2">&quot;adds chain bonus when chain occurs&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">stage</span>

<span class="w">    </span><span class="c1"># 赤ぷよを2×2の正方形に配置（消去対象）</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 青ぷよを配置（赤ぷよ消去後に落下して連鎖を起こす）</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1"># 横に1つ</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1"># 上から縦に3つ</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">}</span>

<span class="w">    </span><span class="c1"># 連鎖が完了するまで更新を繰り返す</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce_while</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">      </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">acc</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="p">{</span><span class="ss">:halt</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span><span class="ss">:cont</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># 2連鎖分のスコアが記録されていることを確認</span>
<span class="w">    </span><span class="c1"># 1連鎖目: 4 × 10 = 40</span>
<span class="w">    </span><span class="c1"># 2連鎖目: 4 × 10 + 2 × 2 × 50 = 40 + 200 = 240</span>
<span class="w">    </span><span class="c1"># 合計: 40 + 240 = 280</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">280</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># 連鎖終了でリセット</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li><strong>単純な消去</strong>: 4個消去したときにスコアが正しく記録されること</li>
<li><strong>連鎖発生</strong>: 連鎖が発生したときに連鎖ボーナスが加算されること</li>
</ol>
<p>「連鎖終了時に連鎖数がリセットされるのはどうしてですか？」良い質問ですね！連鎖は一連の流れが終わったらリセットする必要があります。次の新しいぷよが生成されるときには、連鎖カウントは0から始まります。</p>
<h3 id="game_3">実装: Gameモジュールの更新<a class="headerlink" href="#game_3" title="Permanent link">&para;</a></h3>
<p>「では、Gameモジュールを更新してスコアを統合しましょう！」そうですね。以下の変更を加えます：</p>
<h4 id="libpuyo_puyogameex">lib/puyo_puyo/game.ex（更新）<a class="headerlink" href="#libpuyo_puyogameex" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.Game</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">ゲーム全体の状態とロジックを管理するモジュール</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>

<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo</span><span class="o">.</span><span class="p">{</span><span class="nc">Stage</span><span class="p">,</span><span class="w"> </span><span class="nc">Player</span><span class="p">,</span><span class="w"> </span><span class="nc">Score</span><span class="p">}</span>

<span class="w">  </span><span class="na">@type</span><span class="w"> </span><span class="n">game_mode</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:playing</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:check_erase</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:check_fall</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:falling</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:game_over</span>

<span class="w">  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">    </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="n">game_mode</span><span class="p">(),</span>
<span class="w">    </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">non_neg_integer</span><span class="p">(),</span>
<span class="w">    </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span>
<span class="w">    </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span>
<span class="w">    </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span>
<span class="w">    </span><span class="ss">last_update</span><span class="p">:</span><span class="w"> </span><span class="n">integer</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">defstruct</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">,</span>
<span class="w">            </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span>
<span class="w">            </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span>
<span class="w">            </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span>
<span class="w">            </span><span class="ss">last_update</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">新しいゲームを作成します。</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">new</span><span class="p">()</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="w">    </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">      </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">,</span>
<span class="w">      </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span>
<span class="w">      </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">,</span>
<span class="w">      </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="p">,</span>
<span class="w">      </span><span class="ss">last_update</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">monotonic_time</span><span class="p">(</span><span class="ss">:millisecond</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="sh">ゲーム状態を更新します。</span>
<span class="w">  </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">(),</span><span class="w"> </span><span class="n">number</span><span class="p">())</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">t</span><span class="p">()</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="n">mode</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="ss">:new_puyo</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_new_puyo</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">      </span><span class="ss">:playing</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_playing</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span>
<span class="w">      </span><span class="ss">:check_erase</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_check_erase</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">      </span><span class="ss">:check_fall</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_check_fall</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">      </span><span class="ss">:falling</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle_falling</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">      </span><span class="ss">:game_over</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">game</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 新しいぷよを生成</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_new_puyo</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">can_generate_new_puyo?</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">generate_new_puyo</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="p">)</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:playing</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:game_over</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># プレイ中の処理</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_playing</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">has_landed?</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># プレイヤーのぷよをステージに固定</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">fix_puyo_to_stage</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 消去確認</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_check_erase</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">erase_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">erase_result</span><span class="o">.</span><span class="n">erase_puyo_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># 連鎖数を増加</span>
<span class="w">      </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">      </span><span class="c1"># スコアを記録</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">erase_result</span><span class="o">.</span><span class="n">erase_puyo_count</span><span class="p">,</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># ぷよを消去</span>
<span class="w">      </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">erase_result</span><span class="o">.</span><span class="n">erase_info</span><span class="p">)</span>

<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># 消去するぷよがない場合</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># 連鎖が発生していない場合は落下確認へ</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="c1"># 連鎖終了</span>
<span class="w">        </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">end_chain</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 落下確認</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_check_fall</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">has_floating_puyo?</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:falling</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># 連鎖中の場合は再度消去確認へ</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="c1"># 連鎖していない場合は新ぷよへ</span>
<span class="w">        </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># 落下中</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">handle_falling</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">has_floating_puyo?</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:falling</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_erase</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>「どこが変更されたんですか？」主な変更点は以下の通りです：</p>
<ol>
<li>
<p><strong>Score構造体の追加</strong>
   <div class="highlight"><pre><span></span><code><span class="kd">defstruct</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">,</span>
<span class="w">          </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">          </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span>
<span class="w">          </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span>
<span class="w">          </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">  </span><span class="c1"># 追加</span>
<span class="w">          </span><span class="ss">last_update</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div></p>
</li>
<li>
<p><strong>初期化時にScoreを作成</strong>
   <div class="highlight"><pre><span></span><code><span class="kd">def</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">  </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
<span class="w">  </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="w">  </span><span class="c1"># 追加</span>

<span class="w">  </span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{</span>
<span class="w">    </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">,</span>
<span class="w">    </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span>
<span class="w">    </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">,</span>
<span class="w">    </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w">  </span><span class="c1"># 追加</span>
<span class="w">    </span><span class="ss">last_update</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">monotonic_time</span><span class="p">(</span><span class="ss">:millisecond</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></p>
</li>
<li>
<p><strong>消去確認時にスコアを記録</strong>
   <div class="highlight"><pre><span></span><code><span class="kd">defp</span><span class="w"> </span><span class="n">handle_check_erase</span><span class="p">(</span><span class="err">%</span><span class="bp">__MODULE__</span><span class="p">{}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">erase_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">erase_result</span><span class="o">.</span><span class="n">erase_puyo_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1"># スコアを記録（追加）</span>
<span class="w">    </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">record_erase</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">erase_result</span><span class="o">.</span><span class="n">erase_puyo_count</span><span class="p">,</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span>

<span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">erase_result</span><span class="o">.</span><span class="n">erase_info</span><span class="p">)</span>

<span class="w">    </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">stage</span><span class="p">:</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="p">,</span><span class="w"> </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">chain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:check_fall</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="c1"># 連鎖終了時にスコアをリセット（追加）</span>
<span class="w">      </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Score</span><span class="o">.</span><span class="n">end_chain</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
<span class="w">      </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="ss">mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:new_puyo</span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div></p>
</li>
</ol>
<p>「なるほど、消去が発生したときにスコアを記録し、連鎖が終了したときに連鎖数をリセットしているんですね！」そうです！では、テストを実行して確認しましょう。</p>
<h3 id="_94">テストの実行<a class="headerlink" href="#_94" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test/puyo_puyo/game_test.exs
</code></pre></div>
<p>新しいテストが通ることを確認してください。</p>
<div class="highlight"><pre><span></span><code>Compiling 1 file (.ex)
.......

Finished in 0.05 seconds (0.00s async, 0.05s sync)
7 tests, 0 failures
</code></pre></div>
<p>「全てのテストが通りました！」素晴らしい！これで、Gameモジュールとの統合が完了しました。</p>
<h3 id="liveview_6">LiveViewでのスコア表示<a class="headerlink" href="#liveview_6" title="Permanent link">&para;</a></h3>
<p>「最後に、画面にスコアを表示したいです！」もちろんです！LiveViewを更新してスコアを表示しましょう。</p>
<h4 id="libpuyo_puyo_weblivegame_liveex">lib/puyo_puyo_web/live/game_live.ex（更新）<a class="headerlink" href="#libpuyo_puyo_weblivegame_liveex" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.GameLive</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">PuyoPuyoWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span>
<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo.Game</span>

<span class="w">  </span><span class="na">@game_tick_interval</span><span class="w"> </span><span class="mi">16</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">socket</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:game_tick_interval</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">connected?</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">schedule_game_tick</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_info</span><span class="p">(</span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>

<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)</span>
<span class="w">    </span><span class="n">schedule_game_tick</span><span class="p">()</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;keydown&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="s2">&quot;key&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">player</span>

<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="s2">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
<span class="w">        </span><span class="s2">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_right</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
<span class="w">        </span><span class="s2">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
<span class="w">        </span><span class="s2">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">set_fast_fall</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p">)</span>
<span class="w">        </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">player</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;keyup&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="s2">&quot;key&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>
<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">player</span>

<span class="w">    </span><span class="n">player</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="s2">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">set_fast_fall</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="no">false</span><span class="p">)</span>
<span class="w">        </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">player</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div class=&quot;game-container&quot; phx-window-keydown=&quot;keydown&quot; phx-window-keyup=&quot;keyup&quot;&gt;</span>
<span class="sh">      &lt;div class=&quot;game-header&quot;&gt;</span>
<span class="sh">        &lt;h1&gt;ぷよぷよ&lt;/h1&gt;</span>
<span class="sh">        &lt;div class=&quot;game-info&quot;&gt;</span>
<span class="sh">          &lt;div class=&quot;score-display&quot;&gt;</span>
<span class="sh">            &lt;span class=&quot;label&quot;&gt;スコア:&lt;/span&gt;</span>
<span class="sh">            &lt;span class=&quot;value&quot; id=&quot;score&quot;&gt;&lt;%= @game.score.current_score %&gt;&lt;/span&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">          &lt;div class=&quot;chain-display&quot;&gt;</span>
<span class="sh">            &lt;span class=&quot;label&quot;&gt;連鎖:&lt;/span&gt;</span>
<span class="sh">            &lt;span class=&quot;value&quot; id=&quot;chain&quot;&gt;&lt;%= @game.score.current_chain %&gt;&lt;/span&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">          &lt;div class=&quot;mode-display&quot;&gt;</span>
<span class="sh">            &lt;span class=&quot;label&quot;&gt;モード:&lt;/span&gt;</span>
<span class="sh">            &lt;span class=&quot;value&quot;&gt;&lt;%= format_mode(@game.mode) %&gt;&lt;/span&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">      &lt;/div&gt;</span>

<span class="sh">      &lt;div class=&quot;game-stage&quot;&gt;</span>
<span class="sh">        &lt;%= for y &lt;- 0..(@game.stage.config.stage_rows - 1) do %&gt;</span>
<span class="sh">          &lt;div class=&quot;stage-row&quot;&gt;</span>
<span class="sh">            &lt;%= for x &lt;- 0..(@game.stage.config.stage_cols - 1) do %&gt;</span>
<span class="sh">              &lt;% puyo_type = get_puyo_at(@game, x, y) %&gt;</span>
<span class="sh">              &lt;div class={&quot;stage-cell puyo-#{puyo_type}&quot;}&gt;</span>
<span class="sh">                &lt;%= if puyo_type &gt; 0 do %&gt;</span>
<span class="sh">                  &lt;div class=&quot;puyo&quot;&gt;&lt;/div&gt;</span>
<span class="sh">                &lt;% end %&gt;</span>
<span class="sh">              &lt;/div&gt;</span>
<span class="sh">            &lt;% end %&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">        &lt;% end %&gt;</span>
<span class="sh">      &lt;/div&gt;</span>

<span class="sh">      &lt;div class=&quot;game-controls&quot;&gt;</span>
<span class="sh">        &lt;button phx-click=&quot;restart&quot;&gt;リスタート&lt;/button&gt;</span>
<span class="sh">      &lt;/div&gt;</span>
<span class="sh">    &lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:new_puyo</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;新ぷよ&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:playing</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;プレイ中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:check_erase</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;消去確認&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:check_fall</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;落下確認&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:falling</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;落下中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:game_over</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ゲームオーバー&quot;</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">get_puyo_at</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:playing</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># プレイ中はプレイヤーのぷよも表示</span>
<span class="w">      </span><span class="n">player_puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">get_puyo_at</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">player_puyo</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="n">player_puyo</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>「どこが変更されたんですか？」主な変更点は以下の通りです：</p>
<ol>
<li>
<p><strong>スコア表示の追加</strong>
   <div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;score-display&quot;</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">span</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="o">&gt;</span><span class="err">スコア</span><span class="ss">:&lt;</span><span class="o">/</span><span class="n">span</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">span</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="o">&gt;&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;chain-display&quot;</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">span</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="o">&gt;</span><span class="err">連鎖</span><span class="ss">:&lt;</span><span class="o">/</span><span class="n">span</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">span</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;chain&quot;</span><span class="o">&gt;&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_chain</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>レイアウトの改善</strong>
   <div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;game-header&quot;</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">ぷよぷよ</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;game-info&quot;</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;!--</span><span class="w"> </span><span class="err">スコア、連鎖、モード表示</span><span class="w"> </span><span class="o">--&gt;</span>
<span class="w">  </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
</ol>
<p>「スコアと連鎖が表示されるようになったんですね！」そうです！これで、プレイヤーはリアルタイムでスコアと連鎖数を確認できるようになりました。</p>
<h3 id="css">CSSの更新<a class="headerlink" href="#css" title="Permanent link">&para;</a></h3>
<p>「スコア表示をもっと見やすくしたいです！」もちろんです！CSSを追加して、スコア表示を見やすくしましょう。</p>
<h4 id="assetscssappcss">assets/css/app.css（追加）<a class="headerlink" href="#assetscssappcss" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">.</span><span class="nc">game-header</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">game-header</span><span class="w"> </span><span class="nt">h1</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">game-info</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">  </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f0f0f0</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">score-display</span><span class="o">,</span>
<span class="p">.</span><span class="nc">chain-display</span><span class="o">,</span>
<span class="p">.</span><span class="nc">mode-display</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">  </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">score-display</span><span class="w"> </span><span class="p">.</span><span class="nc">label</span><span class="o">,</span>
<span class="p">.</span><span class="nc">chain-display</span><span class="w"> </span><span class="p">.</span><span class="nc">label</span><span class="o">,</span>
<span class="p">.</span><span class="nc">mode-display</span><span class="w"> </span><span class="p">.</span><span class="nc">label</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#555</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">score-display</span><span class="w"> </span><span class="p">.</span><span class="nc">value</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">1.5</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#ff6b6b</span><span class="p">;</span>
<span class="w">  </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">right</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">chain-display</span><span class="w"> </span><span class="p">.</span><span class="nc">value</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">1.5</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#4ecdc4</span><span class="p">;</span>
<span class="w">  </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">right</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">mode-display</span><span class="w"> </span><span class="p">.</span><span class="nc">value</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#95a5a6</span><span class="p">;</span>
<span class="w">  </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「これで見た目もよくなりました！」そうですね！それでは、サーバーを起動して動作を確認しましょう。</p>
<h3 id="_95">動作確認<a class="headerlink" href="#_95" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>phx.server
</code></pre></div>
<p>ブラウザで <code>http://localhost:4000</code> にアクセスして、以下を確認してください：</p>
<ol>
<li>画面上部にスコアと連鎖数が表示されること</li>
<li>ぷよを消去するとスコアが加算されること</li>
<li>連鎖が発生すると連鎖ボーナスが加算されること</li>
<li>連鎖終了後、連鎖数が0にリセットされること</li>
</ol>
<p>「実際に動かしてみたら、連鎖が発生するとスコアがどんどん上がっていきました！」素晴らしい！それがぷよぷよの面白さですね。</p>
<h3 id="_96">コミット<a class="headerlink" href="#_96" title="Permanent link">&para;</a></h3>
<p>それでは、ここまでの変更をコミットしましょう。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: スコアシステムの実装</span>

<span class="s2">- Scoreモジュールの作成</span>
<span class="s2">- スコア計算ロジック（基本点 + 連鎖ボーナス）</span>
<span class="s2">- Gameモジュールとの統合</span>
<span class="s2">- LiveViewでのスコア表示</span>
<span class="s2">- スコア表示のCSS追加</span>
<span class="s2">- 包括的なテストケース</span>
<span class="s2">&quot;</span>
</code></pre></div>
<h3 id="_97">まとめ<a class="headerlink" href="#_97" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を実装しました：</p>
<h4 id="_98">実装内容<a class="headerlink" href="#_98" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>Scoreモジュール</strong>
   <div class="highlight"><pre><span></span><code><span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyo.Score</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kd">defstruct</span><span class="w"> </span><span class="ss">current_score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">record_erase</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">erase_count</span><span class="p">,</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">end_chain</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">reset</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></p>
</li>
<li>
<p><strong>スコア計算ロジック</strong></p>
</li>
<li>基本点 = 消去数 × 10</li>
<li>連鎖ボーナス = 連鎖数 × 連鎖数 × 50（2連鎖以上）</li>
<li>
<p>獲得点 = 基本点 + 連鎖ボーナス</p>
</li>
<li>
<p><strong>Gameモジュールとの統合</strong></p>
</li>
<li>消去時のスコア記録</li>
<li>
<p>連鎖終了時の連鎖数リセット</p>
</li>
<li>
<p><strong>LiveViewでのスコア表示</strong></p>
</li>
<li>スコアと連鎖数の表示</li>
<li>
<p>リアルタイム更新</p>
</li>
<li>
<p><strong>包括的なテスト</strong></p>
</li>
<li>Scoreモジュールの単体テスト</li>
<li>Gameモジュールとの統合テスト</li>
</ol>
<h4 id="_99">学んだこと<a class="headerlink" href="#_99" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>スコア計算のロジック</strong>
   <div class="highlight"><pre><span></span><code><span class="n">base_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erase_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span>
<span class="n">chain_bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="n">gained_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_points</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">chain_bonus</span>
</code></pre></div></p>
</li>
<li>
<p><strong>構造体の更新パターン</strong>
   <div class="highlight"><pre><span></span><code><span class="p">%{</span><span class="n">score</span><span class="w"> </span><span class="o">|</span>
<span class="w">  </span><span class="ss">current_score</span><span class="p">:</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gained_points</span><span class="p">,</span>
<span class="w">  </span><span class="ss">current_chain</span><span class="p">:</span><span class="w"> </span><span class="n">chain</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>LiveViewでの動的な表示</strong>
   <div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">span</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="o">&gt;&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>連鎖ボーナスの重要性</strong></p>
</li>
<li>1連鎖: 40点</li>
<li>2連鎖: 40 + (40 + 200) = 280点</li>
<li>3連鎖: 40 + (40 + 200) + (40 + 450) = 770点</li>
</ol>
<p>連鎖が長くなるほど、爆発的にスコアが伸びる！</p>
<ol>
<li><strong>ゲームデザインの原則</strong></li>
<li>プレイヤーに明確なフィードバックを提供</li>
<li>高度なプレイに対して報酬を与える</li>
<li>視覚的に情報を伝える</li>
</ol>
<h4 id="_100">次のステップ<a class="headerlink" href="#_100" title="Permanent link">&para;</a></h4>
<p>スコアシステムが完成しました！次のイテレーションでは、以下を実装していきます：</p>
<ul>
<li><strong>イテレーション6</strong>: UI/UXの改善（ゲームオーバー表示、見た目の改善）</li>
</ul>
<p>これでゲームとしての基本的な機能は全て揃いました。次は、プレイヤー体験を向上させるための改善を追加していきましょう！</p>
<hr />
<h2 id="6-uiux">イテレーション6: UI/UXの改善<a class="headerlink" href="#6-uiux" title="Permanent link">&para;</a></h2>
<p>ゲームの基本的な機能は全て実装できました！しかし、ゲームをより楽しく、使いやすくするためには、UI/UXの改善が重要です。このイテレーションでは、ゲームオーバー表示の改善、見た目の改善、そして全体的な仕上げを行います。</p>
<h3 id="_101">ユーザーストーリー<a class="headerlink" href="#_101" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになったことが明確に分かり、簡単にリスタートできる</p>
</blockquote>
<p>「ゲームオーバーの表示が分かりやすいといいですね！」そうです！ゲームの状態が明確に分かることは、良いユーザー体験の基本です。</p>
<h3 id="todo_5">TODOリスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>UI/UXを改善するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームオーバー表示の実装</li>
<li>ゲームオーバー時のオーバーレイUI</li>
<li>リスタートボタンの改善</li>
<li>見た目の改善（色、レイアウト、アニメーション）</li>
<li>レスポンシブ対応</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。</p>
<h3 id="_102">ゲームオーバー表示の改善<a class="headerlink" href="#_102" title="Permanent link">&para;</a></h3>
<p>「現在のゲームオーバー表示はどうなっていますか？」現在は、モード表示に「ゲームオーバー」と表示されるだけです。これをもっと目立つように、オーバーレイで表示しましょう。</p>
<h4 id="libpuyo_puyo_weblivegame_liveex_1">lib/puyo_puyo_web/live/game_live.ex（更新）<a class="headerlink" href="#libpuyo_puyo_weblivegame_liveex_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">defmodule</span><span class="w"> </span><span class="nc">PuyoPuyoWeb.GameLive</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="kn">use</span><span class="w"> </span><span class="nc">PuyoPuyoWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span>
<span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">PuyoPuyo</span><span class="o">.</span><span class="p">{</span><span class="nc">Game</span><span class="p">,</span><span class="w"> </span><span class="nc">Player</span><span class="p">,</span><span class="w"> </span><span class="nc">Stage</span><span class="p">}</span>

<span class="w">  </span><span class="na">@game_tick_interval</span><span class="w"> </span><span class="mi">16</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">socket</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="ss">:game_tick_interval</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">connected?</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">schedule_game_tick</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_info</span><span class="p">(</span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>

<span class="w">    </span><span class="c1"># ゲームオーバーでない場合のみ更新</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:game_over</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">game</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)</span>
<span class="w">    </span><span class="n">schedule_game_tick</span><span class="p">()</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_params</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Game</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;keydown&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="s2">&quot;key&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>

<span class="w">    </span><span class="c1"># ゲームオーバー時は操作を受け付けない</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:game_over</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">player</span>

<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="s2">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_left</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
<span class="w">          </span><span class="s2">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">move_right</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
<span class="w">          </span><span class="s2">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
<span class="w">          </span><span class="s2">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">set_fast_fall</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p">)</span>
<span class="w">          </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">player</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">      </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">handle_event</span><span class="p">(</span><span class="s2">&quot;keyup&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">%{</span><span class="s2">&quot;key&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">game</span>

<span class="w">    </span><span class="c1"># ゲームオーバー時は操作を受け付けない</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:game_over</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">player</span>

<span class="w">      </span><span class="n">player</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="s2">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">set_fast_fall</span><span class="p">(</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="no">false</span><span class="p">)</span>
<span class="w">          </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">player</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">      </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%{</span><span class="n">game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">player</span><span class="p">:</span><span class="w"> </span><span class="n">player</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:game</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">)}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="sx">~H</span><span class="sh">&quot;&quot;&quot;</span>
<span class="sh">    &lt;div class=&quot;game-container&quot; phx-window-keydown=&quot;keydown&quot; phx-window-keyup=&quot;keyup&quot;&gt;</span>
<span class="sh">      &lt;div class=&quot;game-header&quot;&gt;</span>
<span class="sh">        &lt;h1&gt;ぷよぷよ&lt;/h1&gt;</span>
<span class="sh">        &lt;div class=&quot;game-info&quot;&gt;</span>
<span class="sh">          &lt;div class=&quot;score-display&quot;&gt;</span>
<span class="sh">            &lt;span class=&quot;label&quot;&gt;スコア:&lt;/span&gt;</span>
<span class="sh">            &lt;span class=&quot;value&quot; id=&quot;score&quot;&gt;&lt;%= @game.score.current_score %&gt;&lt;/span&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">          &lt;div class=&quot;chain-display&quot;&gt;</span>
<span class="sh">            &lt;span class=&quot;label&quot;&gt;連鎖:&lt;/span&gt;</span>
<span class="sh">            &lt;span class=&quot;value&quot; id=&quot;chain&quot;&gt;&lt;%= @game.score.current_chain %&gt;&lt;/span&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">          &lt;div class=&quot;mode-display&quot;&gt;</span>
<span class="sh">            &lt;span class=&quot;label&quot;&gt;モード:&lt;/span&gt;</span>
<span class="sh">            &lt;span class=&quot;value&quot;&gt;&lt;%= format_mode(@game.mode) %&gt;&lt;/span&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">      &lt;/div&gt;</span>

<span class="sh">      &lt;div class=&quot;game-stage-wrapper&quot;&gt;</span>
<span class="sh">        &lt;div class=&quot;game-stage&quot;&gt;</span>
<span class="sh">          &lt;%= for y &lt;- 0..(@game.stage.config.stage_rows - 1) do %&gt;</span>
<span class="sh">            &lt;div class=&quot;stage-row&quot;&gt;</span>
<span class="sh">              &lt;%= for x &lt;- 0..(@game.stage.config.stage_cols - 1) do %&gt;</span>
<span class="sh">                &lt;% puyo_type = get_puyo_at(@game, x, y) %&gt;</span>
<span class="sh">                &lt;div class={&quot;stage-cell puyo-#{puyo_type}&quot;}&gt;</span>
<span class="sh">                  &lt;%= if puyo_type &gt; 0 do %&gt;</span>
<span class="sh">                    &lt;div class=&quot;puyo&quot;&gt;&lt;/div&gt;</span>
<span class="sh">                  &lt;% end %&gt;</span>
<span class="sh">                &lt;/div&gt;</span>
<span class="sh">              &lt;% end %&gt;</span>
<span class="sh">            &lt;/div&gt;</span>
<span class="sh">          &lt;% end %&gt;</span>
<span class="sh">        &lt;/div&gt;</span>

<span class="sh">        &lt;%= if @game.mode == :game_over do %&gt;</span>
<span class="sh">          &lt;div class=&quot;game-over-overlay&quot;&gt;</span>
<span class="sh">            &lt;div class=&quot;game-over-content&quot;&gt;</span>
<span class="sh">              &lt;h2&gt;GAME OVER&lt;/h2&gt;</span>
<span class="sh">              &lt;div class=&quot;final-score&quot;&gt;</span>
<span class="sh">                &lt;p&gt;最終スコア&lt;/p&gt;</span>
<span class="sh">                &lt;p class=&quot;score-value&quot;&gt;&lt;%= @game.score.current_score %&gt;&lt;/p&gt;</span>
<span class="sh">              &lt;/div&gt;</span>
<span class="sh">              &lt;button phx-click=&quot;restart&quot; class=&quot;restart-button&quot;&gt;</span>
<span class="sh">                もう一度プレイ</span>
<span class="sh">              &lt;/button&gt;</span>
<span class="sh">            &lt;/div&gt;</span>
<span class="sh">          &lt;/div&gt;</span>
<span class="sh">        &lt;% end %&gt;</span>
<span class="sh">      &lt;/div&gt;</span>

<span class="sh">      &lt;div class=&quot;game-controls&quot;&gt;</span>
<span class="sh">        &lt;div class=&quot;control-info&quot;&gt;</span>
<span class="sh">          &lt;h3&gt;操作方法&lt;/h3&gt;</span>
<span class="sh">          &lt;ul&gt;</span>
<span class="sh">            &lt;li&gt;&lt;kbd&gt;←&lt;/kbd&gt; &lt;kbd&gt;→&lt;/kbd&gt; 左右移動&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;&lt;kbd&gt;↑&lt;/kbd&gt; 回転&lt;/li&gt;</span>
<span class="sh">            &lt;li&gt;&lt;kbd&gt;↓&lt;/kbd&gt; 高速落下&lt;/li&gt;</span>
<span class="sh">          &lt;/ul&gt;</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="sh">        &lt;button phx-click=&quot;restart&quot; class=&quot;control-button&quot;&gt;リスタート&lt;/button&gt;</span>
<span class="sh">      &lt;/div&gt;</span>
<span class="sh">    &lt;/div&gt;</span>
<span class="w">    </span><span class="sh">&quot;&quot;&quot;</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:new_puyo</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;新ぷよ&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:playing</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;プレイ中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:check_erase</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;消去確認&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:check_fall</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;落下確認&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:falling</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;落下中&quot;</span>
<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">format_mode</span><span class="p">(</span><span class="ss">:game_over</span><span class="p">),</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ゲームオーバー&quot;</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">get_puyo_at</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:playing</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># プレイ中はプレイヤーのぷよも表示</span>
<span class="w">      </span><span class="n">player_puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Player</span><span class="o">.</span><span class="n">get_puyo_at</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">player_puyo</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="n">player_puyo</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="nc">Stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="n">schedule_game_tick</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nc">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span><span class="w"> </span><span class="ss">:game_tick</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>「どこが変更されたんですか？」主な変更点は以下の通りです：</p>
<ol>
<li>
<p><strong>ゲームオーバー時の更新停止</strong>
   <div class="highlight"><pre><span></span><code><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:game_over</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="nc">Game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">game</span><span class="p">,</span><span class="w"> </span><span class="na">@game_tick_interval</span><span class="p">)</span>
<span class="k">else</span>
<span class="w">  </span><span class="n">game</span>
<span class="k">end</span>
</code></pre></div></p>
</li>
<li>
<p><strong>ゲームオーバー時の操作無効化</strong>
   <div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:game_over</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">}</span>
<span class="k">else</span>
<span class="w">  </span><span class="c1"># 通常の操作処理</span>
<span class="k">end</span>
</code></pre></div></p>
</li>
<li>
<p><strong>ゲームオーバーオーバーレイの追加</strong>
   <div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:game_over</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;game-over-overlay&quot;</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;game-over-content&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="nc">GAME</span><span class="w"> </span><span class="nc">OVER</span><span class="o">&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;final-score&quot;</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">最終スコア</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">p</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;score-value&quot;</span><span class="o">&gt;&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="n">phx</span><span class="o">-</span><span class="n">click</span><span class="o">=</span><span class="s2">&quot;restart&quot;</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;restart-button&quot;</span><span class="o">&gt;</span>
<span class="w">        </span><span class="err">もう一度プレイ</span>
<span class="w">      </span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">%</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>操作方法の表示</strong>
   <div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;control-info&quot;</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="err">操作方法</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">kbd</span><span class="o">&gt;</span><span class="err">←</span><span class="o">&lt;/</span><span class="n">kbd</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">kbd</span><span class="o">&gt;</span><span class="err">→</span><span class="o">&lt;/</span><span class="n">kbd</span><span class="o">&gt;</span><span class="w"> </span><span class="err">左右移動</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">kbd</span><span class="o">&gt;</span><span class="err">↑</span><span class="o">&lt;/</span><span class="n">kbd</span><span class="o">&gt;</span><span class="w"> </span><span class="err">回転</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">kbd</span><span class="o">&gt;</span><span class="err">↓</span><span class="o">&lt;/</span><span class="n">kbd</span><span class="o">&gt;</span><span class="w"> </span><span class="err">高速落下</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
</ol>
<p>「なるほど、ゲームオーバー時には専用の画面が表示されるんですね！」そうです！次は、CSSを追加して見た目を改善しましょう。</p>
<h3 id="css_1">CSSの大幅改善<a class="headerlink" href="#css_1" title="Permanent link">&para;</a></h3>
<p>「見た目をもっとよくしたいです！」もちろんです！CSSを大幅に改善して、ゲームをもっと魅力的にしましょう。</p>
<h4 id="assetscssappcss_1">assets/css/app.css（更新）<a class="headerlink" href="#assetscssappcss_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c">/* ========================================</span>
<span class="c">   ゲーム全体のレイアウト</span>
<span class="c">   ======================================== */</span>

<span class="p">.</span><span class="nc">game-container</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">max-width</span><span class="p">:</span><span class="w"> </span><span class="mi">800</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Segoe UI&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">Tahoma</span><span class="p">,</span><span class="w"> </span><span class="n">Geneva</span><span class="p">,</span><span class="w"> </span><span class="n">Verdana</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">linear-gradient</span><span class="p">(</span><span class="mi">135</span><span class="kt">deg</span><span class="p">,</span><span class="w"> </span><span class="mh">#667eea</span><span class="w"> </span><span class="mi">0</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#764ba2</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">);</span>
<span class="w">  </span><span class="k">min-height</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">vh</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* ========================================</span>
<span class="c">   ヘッダー</span>
<span class="c">   ======================================== */</span>

<span class="p">.</span><span class="nc">game-header</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mf">0.95</span><span class="p">);</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="mi">6</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">game-header</span><span class="w"> </span><span class="nt">h1</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">15</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">2.5</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">game-info</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">  </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">linear-gradient</span><span class="p">(</span><span class="mi">135</span><span class="kt">deg</span><span class="p">,</span><span class="w"> </span><span class="mh">#f5f7fa</span><span class="w"> </span><span class="mi">0</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#c3cfe2</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">);</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">flex-wrap</span><span class="p">:</span><span class="w"> </span><span class="kc">wrap</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">score-display</span><span class="o">,</span>
<span class="p">.</span><span class="nc">chain-display</span><span class="o">,</span>
<span class="p">.</span><span class="nc">mode-display</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">  </span><span class="k">flex-direction</span><span class="p">:</span><span class="w"> </span><span class="kc">column</span><span class="p">;</span>
<span class="w">  </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">score-display</span><span class="w"> </span><span class="p">.</span><span class="nc">label</span><span class="o">,</span>
<span class="p">.</span><span class="nc">chain-display</span><span class="w"> </span><span class="p">.</span><span class="nc">label</span><span class="o">,</span>
<span class="p">.</span><span class="nc">mode-display</span><span class="w"> </span><span class="p">.</span><span class="nc">label</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#555</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-transform</span><span class="p">:</span><span class="w"> </span><span class="kc">uppercase</span><span class="p">;</span>
<span class="w">  </span><span class="k">letter-spacing</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">score-display</span><span class="w"> </span><span class="p">.</span><span class="nc">value</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#ff6b6b</span><span class="p">;</span>
<span class="w">  </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">chain-display</span><span class="w"> </span><span class="p">.</span><span class="nc">value</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#4ecdc4</span><span class="p">;</span>
<span class="w">  </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">mode-display</span><span class="w"> </span><span class="p">.</span><span class="nc">value</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">1.1</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#7f8c8d</span><span class="p">;</span>
<span class="w">  </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* ========================================</span>
<span class="c">   ゲームステージ</span>
<span class="c">   ======================================== */</span>

<span class="p">.</span><span class="nc">game-stage-wrapper</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">position</span><span class="p">:</span><span class="w"> </span><span class="kc">relative</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">  </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="n">fit-content</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">game-stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mf">0.95</span><span class="p">);</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="w"> </span><span class="mi">16</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">  </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">stage-row</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">  </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">stage-cell</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">linear-gradient</span><span class="p">(</span><span class="mi">135</span><span class="kt">deg</span><span class="p">,</span><span class="w"> </span><span class="mh">#e0e0e0</span><span class="w"> </span><span class="mi">0</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#f5f5f5</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">);</span>
<span class="w">  </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#ccc</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">  </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">transition</span><span class="p">:</span><span class="w"> </span><span class="kc">all</span><span class="w"> </span><span class="mf">0.1</span><span class="kt">s</span><span class="w"> </span><span class="kc">ease</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="kt">%</span><span class="p">;</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span>
<span class="w">    </span><span class="kc">inset</span><span class="w"> </span><span class="mi">-2</span><span class="kt">px</span><span class="w"> </span><span class="mi">-2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">),</span>
<span class="w">    </span><span class="kc">inset</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span><span class="p">),</span>
<span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="w">  </span><span class="k">position</span><span class="p">:</span><span class="w"> </span><span class="kc">relative</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">puyo</span><span class="p">::</span><span class="nd">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">content</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">position</span><span class="p">:</span><span class="w"> </span><span class="kc">absolute</span><span class="p">;</span>
<span class="w">  </span><span class="k">top</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">left</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mf">0.6</span><span class="p">);</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="kt">%</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* ぷよの色 */</span>
<span class="p">.</span><span class="nc">puyo-1</span><span class="w"> </span><span class="p">.</span><span class="nc">puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">radial-gradient</span><span class="p">(</span><span class="kc">circle</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">30</span><span class="kt">%</span><span class="w"> </span><span class="mi">30</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#ff6b6b</span><span class="p">,</span><span class="w"> </span><span class="mh">#c92a2a</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">puyo-2</span><span class="w"> </span><span class="p">.</span><span class="nc">puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">radial-gradient</span><span class="p">(</span><span class="kc">circle</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">30</span><span class="kt">%</span><span class="w"> </span><span class="mi">30</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#4ecdc4</span><span class="p">,</span><span class="w"> </span><span class="mh">#0d7377</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">puyo-3</span><span class="w"> </span><span class="p">.</span><span class="nc">puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">radial-gradient</span><span class="p">(</span><span class="kc">circle</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">30</span><span class="kt">%</span><span class="w"> </span><span class="mi">30</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#ffd93d</span><span class="p">,</span><span class="w"> </span><span class="mh">#f6b93b</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">puyo-4</span><span class="w"> </span><span class="p">.</span><span class="nc">puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">radial-gradient</span><span class="p">(</span><span class="kc">circle</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">30</span><span class="kt">%</span><span class="w"> </span><span class="mi">30</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#95e1d3</span><span class="p">,</span><span class="w"> </span><span class="mh">#38ada9</span><span class="p">);</span>
<span class="p">}</span>

<span class="c">/* ========================================</span>
<span class="c">   ゲームオーバーオーバーレイ</span>
<span class="c">   ======================================== */</span>

<span class="p">.</span><span class="nc">game-over-overlay</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">position</span><span class="p">:</span><span class="w"> </span><span class="kc">absolute</span><span class="p">;</span>
<span class="w">  </span><span class="k">top</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">left</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">right</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.85</span><span class="p">);</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">  </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">animation</span><span class="p">:</span><span class="w"> </span><span class="n">fadeIn</span><span class="w"> </span><span class="mf">0.3</span><span class="kt">s</span><span class="w"> </span><span class="kc">ease-in-out</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="k">keyframes</span><span class="w"> </span><span class="nt">fadeIn</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">from</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nt">to</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">game-over-content</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">  </span><span class="k">animation</span><span class="p">:</span><span class="w"> </span><span class="n">slideIn</span><span class="w"> </span><span class="mf">0.5</span><span class="kt">s</span><span class="w"> </span><span class="kc">ease-out</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="k">keyframes</span><span class="w"> </span><span class="nt">slideIn</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">from</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateY</span><span class="p">(</span><span class="mi">-30</span><span class="kt">px</span><span class="p">);</span>
<span class="w">    </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nt">to</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">game-over-content</span><span class="w"> </span><span class="nt">h2</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#ff6b6b</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="kt">px</span><span class="w"> </span><span class="mi">3</span><span class="kt">px</span><span class="w"> </span><span class="mi">6</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">  </span><span class="k">letter-spacing</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">final-score</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">final-score</span><span class="w"> </span><span class="nt">p</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f5f5f5</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">final-score</span><span class="w"> </span><span class="p">.</span><span class="nc">score-value</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#ffd93d</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">restart-button</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="kt">px</span><span class="w"> </span><span class="mi">40</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">linear-gradient</span><span class="p">(</span><span class="mi">135</span><span class="kt">deg</span><span class="p">,</span><span class="w"> </span><span class="mh">#667eea</span><span class="w"> </span><span class="mi">0</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#764ba2</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">);</span>
<span class="w">  </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="mi">15</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span>
<span class="w">  </span><span class="k">transition</span><span class="p">:</span><span class="w"> </span><span class="kc">all</span><span class="w"> </span><span class="mf">0.3</span><span class="kt">s</span><span class="w"> </span><span class="kc">ease</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">restart-button</span><span class="p">:</span><span class="nd">hover</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateY</span><span class="p">(</span><span class="mi">-2</span><span class="kt">px</span><span class="p">);</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">6</span><span class="kt">px</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">restart-button</span><span class="p">:</span><span class="nd">active</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span>
<span class="p">}</span>

<span class="c">/* ========================================</span>
<span class="c">   コントロール</span>
<span class="c">   ======================================== */</span>

<span class="p">.</span><span class="nc">game-controls</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mf">0.95</span><span class="p">);</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="mi">6</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">  </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">space-between</span><span class="p">;</span>
<span class="w">  </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">  </span><span class="k">flex-wrap</span><span class="p">:</span><span class="w"> </span><span class="kc">wrap</span><span class="p">;</span>
<span class="w">  </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">control-info</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">flex</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">control-info</span><span class="w"> </span><span class="nt">h3</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="kt">rem</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">control-info</span><span class="w"> </span><span class="nt">ul</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">list-style</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">control-info</span><span class="w"> </span><span class="nt">li</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#555</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">0.95</span><span class="kt">rem</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">control-info</span><span class="w"> </span><span class="nt">kbd</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">inline-block</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="kt">px</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">linear-gradient</span><span class="p">(</span><span class="mi">135</span><span class="kt">deg</span><span class="p">,</span><span class="w"> </span><span class="mh">#f5f7fa</span><span class="w"> </span><span class="mi">0</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#c3cfe2</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">);</span>
<span class="w">  </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#aaa</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="kc">monospace</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">control-button</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="kt">px</span><span class="w"> </span><span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">1.1</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="nb">linear-gradient</span><span class="p">(</span><span class="mi">135</span><span class="kt">deg</span><span class="p">,</span><span class="w"> </span><span class="mh">#4ecdc4</span><span class="w"> </span><span class="mi">0</span><span class="kt">%</span><span class="p">,</span><span class="w"> </span><span class="mh">#44a08d</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">);</span>
<span class="w">  </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">  </span><span class="k">transition</span><span class="p">:</span><span class="w"> </span><span class="kc">all</span><span class="w"> </span><span class="mf">0.3</span><span class="kt">s</span><span class="w"> </span><span class="kc">ease</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">control-button</span><span class="p">:</span><span class="nd">hover</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateY</span><span class="p">(</span><span class="mi">-2</span><span class="kt">px</span><span class="p">);</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">6</span><span class="kt">px</span><span class="w"> </span><span class="mi">15</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">control-button</span><span class="p">:</span><span class="nd">active</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="p">}</span>

<span class="c">/* ========================================</span>
<span class="c">   レスポンシブ対応</span>
<span class="c">   ======================================== */</span>

<span class="p">@</span><span class="k">media</span><span class="w"> </span><span class="o">(</span><span class="nt">max-width</span><span class="o">:</span><span class="w"> </span><span class="nt">600px</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">.</span><span class="nc">game-container</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">.</span><span class="nc">game-header</span><span class="w"> </span><span class="nt">h1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">.</span><span class="nc">game-info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">.</span><span class="nc">score-display</span><span class="w"> </span><span class="p">.</span><span class="nc">value</span><span class="o">,</span>
<span class="w">  </span><span class="p">.</span><span class="nc">chain-display</span><span class="w"> </span><span class="p">.</span><span class="nc">value</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">1.5</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">.</span><span class="nc">stage-cell</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">.</span><span class="nc">puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">.</span><span class="nc">game-over-content</span><span class="w"> </span><span class="nt">h2</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">.</span><span class="nc">final-score</span><span class="w"> </span><span class="p">.</span><span class="nc">score-value</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">rem</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">.</span><span class="nc">game-controls</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">flex-direction</span><span class="p">:</span><span class="w"> </span><span class="kc">column</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「すごい！CSSが大幅に改善されましたね！」そうです！主な改善点は以下の通りです：</p>
<ol>
<li><strong>グラデーション背景</strong></li>
<li>全体の背景にグラデーション</li>
<li>
<p>ボタンやぷよにも立体的なグラデーション</p>
</li>
<li>
<p><strong>ぷよの立体感</strong></p>
</li>
<li><code>box-shadow</code>と<code>radial-gradient</code>で立体的に</li>
<li>
<p>ハイライト効果の追加</p>
</li>
<li>
<p><strong>ゲームオーバーアニメーション</strong></p>
</li>
<li>フェードイン＆スライドインアニメーション</li>
<li>
<p>目立つオーバーレイ表示</p>
</li>
<li>
<p><strong>ボタンのホバー効果</strong></p>
</li>
<li><code>transform</code>で浮き上がる効果</li>
<li>
<p>スムーズなトランジション</p>
</li>
<li>
<p><strong>レスポンシブ対応</strong></p>
</li>
<li>モバイルでも快適にプレイ可能</li>
</ol>
<h3 id="_103">動作確認<a class="headerlink" href="#_103" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>mix<span class="w"> </span>phx.server
</code></pre></div>
<p>ブラウザで <code>http://localhost:4000</code> にアクセスして、以下を確認してください：</p>
<ol>
<li>全体的な見た目が改善されていること</li>
<li>ぷよが立体的に表示されること</li>
<li>ゲームオーバー時にオーバーレイが表示されること</li>
<li>リスタートボタンが動作すること</li>
<li>操作方法が表示されていること</li>
</ol>
<p>「実際に動かしてみたら、すごく綺麗になりました！」素晴らしい！ゲームの見た目が良くなると、プレイヤーの体験も大きく向上しますね。</p>
<h3 id="_104">コミット<a class="headerlink" href="#_104" title="Permanent link">&para;</a></h3>
<p>それでは、ここまでの変更をコミットしましょう。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: UI/UXの大幅改善</span>

<span class="s2">- ゲームオーバーオーバーレイの実装</span>
<span class="s2">- ゲームオーバー時の操作無効化</span>
<span class="s2">- ゲームオーバー時の更新停止</span>
<span class="s2">- 最終スコア表示</span>
<span class="s2">- CSSの大幅改善</span>
<span class="s2">  - グラデーション背景</span>
<span class="s2">  - ぷよの立体感（box-shadow, radial-gradient）</span>
<span class="s2">  - アニメーション効果（fadeIn, slideIn）</span>
<span class="s2">  - ボタンのホバー効果</span>
<span class="s2">  - レスポンシブ対応</span>
<span class="s2">- 操作方法の表示</span>
<span class="s2">- リスタートボタンの改善</span>
<span class="s2">&quot;</span>
</code></pre></div>
<h3 id="_105">まとめ<a class="headerlink" href="#_105" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を実装しました：</p>
<h4 id="_106">実装内容<a class="headerlink" href="#_106" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>ゲームオーバー表示の改善</strong>
   <div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:game_over</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;game-over-overlay&quot;</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;game-over-content&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="nc">GAME</span><span class="w"> </span><span class="nc">OVER</span><span class="o">&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;final-score&quot;</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="err">最終スコア</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">p</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;score-value&quot;</span><span class="o">&gt;&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">current_score</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="n">phx</span><span class="o">-</span><span class="n">click</span><span class="o">=</span><span class="s2">&quot;restart&quot;</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;restart-button&quot;</span><span class="o">&gt;</span>
<span class="w">        </span><span class="err">もう一度プレイ</span>
<span class="w">      </span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">%</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>ゲームオーバー時の制御</strong></p>
</li>
<li>更新処理の停止</li>
<li>操作の無効化</li>
<li>
<p>オーバーレイ表示</p>
</li>
<li>
<p><strong>CSSアニメーション</strong>
   <div class="highlight"><pre><span></span><code><span class="p">@</span><span class="k">keyframes</span><span class="w"> </span><span class="nt">fadeIn</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">from</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="nt">to</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="k">keyframes</span><span class="w"> </span><span class="nt">slideIn</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">from</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateY</span><span class="p">(</span><span class="mi">-30</span><span class="kt">px</span><span class="p">);</span>
<span class="w">    </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nt">to</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>ぷよの立体的な表現</strong>
   <div class="highlight"><pre><span></span><code><span class="p">.</span><span class="nc">puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">box-shadow</span><span class="p">:</span>
<span class="w">    </span><span class="kc">inset</span><span class="w"> </span><span class="mi">-2</span><span class="kt">px</span><span class="w"> </span><span class="mi">-2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">),</span>
<span class="w">    </span><span class="kc">inset</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span><span class="p">),</span>
<span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>操作方法の表示</strong></p>
</li>
<li>キーボード操作をわかりやすく表示</li>
<li><code>&lt;kbd&gt;</code>タグでキーを視覚化</li>
</ol>
<h4 id="_107">学んだこと<a class="headerlink" href="#_107" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>LiveViewでの条件付きレンダリング</strong>
   <div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="err">%</span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="na">@game</span><span class="o">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:game_over</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;!--</span><span class="w"> </span><span class="err">ゲームオーバー表示</span><span class="w"> </span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="err">%</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="err">%</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>CSSアニメーションの基本</strong></p>
</li>
<li><code>@keyframes</code>でアニメーション定義</li>
<li><code>animation</code>プロパティで適用</li>
<li>
<p><code>transition</code>でスムーズな変化</p>
</li>
<li>
<p><strong>グラデーションの活用</strong></p>
</li>
<li><code>linear-gradient</code>で線形グラデーション</li>
<li><code>radial-gradient</code>で放射状グラデーション</li>
<li>
<p>立体感の演出</p>
</li>
<li>
<p><strong>レスポンシブデザイン</strong>
   <div class="highlight"><pre><span></span><code><span class="p">@</span><span class="k">media</span><span class="w"> </span><span class="o">(</span><span class="nt">max-width</span><span class="o">:</span><span class="w"> </span><span class="nt">600px</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c">/* モバイル用のスタイル */</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>ユーザー体験の重要性</strong></p>
</li>
<li>明確なフィードバック</li>
<li>直感的な操作</li>
<li>視覚的な魅力</li>
</ol>
<h3 id="_108">完成！<a class="headerlink" href="#_108" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！Elixir Phoenix LiveViewを使ったぷよぷよゲームが完成しました！</p>
<h4 id="_109">実装した機能<a class="headerlink" href="#_109" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>イテレーション0</strong>: プロジェクトセットアップ</li>
<li><strong>イテレーション1</strong>: Config、PuyoImage、Stageの実装</li>
<li><strong>イテレーション2</strong>: ステージの実装（消去判定、落下処理）</li>
<li><strong>イテレーション3</strong>: プレイヤーの実装（移動、回転、落下）</li>
<li><strong>イテレーション4</strong>: ゲームループの実装（状態管理、連鎖）</li>
<li><strong>イテレーション5</strong>: スコアシステムの実装</li>
<li><strong>イテレーション6</strong>: UI/UXの改善</li>
</ol>
<h4 id="_110">技術スタック<a class="headerlink" href="#_110" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Elixir</strong>: 関数型プログラミング言語</li>
<li><strong>Phoenix</strong>: Webフレームワーク</li>
<li><strong>LiveView</strong>: リアルタイムWebアプリケーションフレームワーク</li>
<li><strong>ExUnit</strong>: テストフレームワーク</li>
<li><strong>CSS3</strong>: アニメーション、グラデーション</li>
</ul>
<h4 id="_111">アーキテクチャの特徴<a class="headerlink" href="#_111" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>関数型プログラミング</strong></li>
<li>イミュータブルなデータ構造</li>
<li>パターンマッチング</li>
<li>
<p>パイプライン演算子</p>
</li>
<li>
<p><strong>Actor モデル</strong></p>
</li>
<li>Process.send_after/3でのメッセージング</li>
<li>handle_info/2でのメッセージ処理</li>
<li>
<p>状態の独立性</p>
</li>
<li>
<p><strong>テスト駆動開発</strong></p>
</li>
<li>Red → Green → Refactor</li>
<li>包括的なテストカバレッジ</li>
<li>
<p>ドキュメントとしてのテスト</p>
</li>
<li>
<p><strong>LiveView の強み</strong></p>
</li>
<li>サーバーサイドレンダリング</li>
<li>WebSocketによるリアルタイム更新</li>
<li>最小限のJavaScript</li>
</ol>
<h3 id="_112">次のステップ<a class="headerlink" href="#_112" title="Permanent link">&para;</a></h3>
<p>ゲームとしては完成しましたが、さらに改善できる点はたくさんあります：</p>
<h4 id="_113">機能拡張<a class="headerlink" href="#_113" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>ハイスコア機能</strong></li>
<li>データベースへの保存</li>
<li>ランキング表示</li>
<li>
<p>プレイヤー名の登録</p>
</li>
<li>
<p><strong>サウンド効果</strong></p>
</li>
<li>ぷよ消去時の効果音</li>
<li>連鎖時の効果音</li>
<li>
<p>BGM</p>
</li>
<li>
<p><strong>追加のゲームモード</strong></p>
</li>
<li>タイムアタック</li>
<li>エンドレスモード</li>
<li>
<p>対戦モード</p>
</li>
<li>
<p><strong>アニメーション強化</strong></p>
</li>
<li>ぷよ消去時のアニメーション</li>
<li>連鎖時のエフェクト</li>
<li>スコア表示時のアニメーション</li>
</ol>
<h4 id="_114">パフォーマンス最適化<a class="headerlink" href="#_114" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>フレームレート調整</strong></li>
<li>可変フレームレート</li>
<li>
<p>パフォーマンスモニタリング</p>
</li>
<li>
<p><strong>状態管理の最適化</strong></p>
</li>
<li>GenServerへの移行</li>
<li>
<p>状態の永続化</p>
</li>
<li>
<p><strong>テストの拡充</strong></p>
</li>
<li>プロパティベーステスト</li>
<li>パフォーマンステスト</li>
<li>E2Eテスト</li>
</ol>
<h3 id="_115">おわりに<a class="headerlink" href="#_115" title="Permanent link">&para;</a></h3>
<p>このチュートリアルでは、Elixir Phoenix LiveViewを使ってぷよぷよゲームを実装しました。テスト駆動開発のサイクルに従い、小さなステップで着実に機能を追加していきました。</p>
<p><strong>学んだ主なこと：</strong></p>
<ol>
<li><strong>Elixirの基本</strong></li>
<li>関数型プログラミング</li>
<li>パターンマッチング</li>
<li>
<p>イミュータブルなデータ構造</p>
</li>
<li>
<p><strong>Phoenix LiveView</strong></p>
</li>
<li>サーバーサイドレンダリング</li>
<li>リアルタイム更新</li>
<li>
<p>イベントハンドリング</p>
</li>
<li>
<p><strong>テスト駆動開発</strong></p>
</li>
<li>Red → Green → Refactor</li>
<li>小さなステップ</li>
<li>
<p>継続的なリファクタリング</p>
</li>
<li>
<p><strong>ゲーム開発</strong></p>
</li>
<li>状態管理</li>
<li>ゲームループ</li>
<li>
<p>ユーザー体験</p>
</li>
<li>
<p><strong>UI/UX設計</strong></p>
</li>
<li>レスポンシブデザイン</li>
<li>アニメーション</li>
<li>視覚的フィードバック</li>
</ol>
<p>「ここまで長い道のりでしたが、楽しく学べました！」素晴らしい！これで、Elixir Phoenix LiveViewを使った本格的なWebアプリケーション開発の基礎が身につきました。この経験を活かして、さらに素晴らしいアプリケーションを作っていってください！</p>
<p>Happy coding with Elixir and Phoenix LiveView! 🎉</p>
<h2 id="_116">参考資料<a class="headerlink" href="#_116" title="Permanent link">&para;</a></h2>
<h3 id="_117">公式ドキュメント<a class="headerlink" href="#_117" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://www.phoenixframework.org/">Phoenix Framework</a></li>
<li><a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html">Phoenix LiveView</a></li>
<li><a href="https://elixir-lang.org/docs.html">Elixir公式ドキュメント</a></li>
<li><a href="https://hexdocs.pm/mix/Mix.html">Mix documentation</a></li>
</ul>
<h3 id="_118">使用ツール<a class="headerlink" href="#_118" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://github.com/rrrene/credo">Credo</a> - 静的コード解析</li>
<li><a href="https://github.com/parroty/excoveralls">ExCoveralls</a> - コードカバレッジ</li>
<li><a href="https://github.com/lpil/mix-test.watch">mix_test_watch</a> - ファイル監視</li>
<li><a href="https://github.com/jeremyjh/dialyxir">Dialyxir</a> - 型解析</li>
</ul>
<h3 id="_119">参考記事<a class="headerlink" href="#_119" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://github.com/angular/angular/blob/master/CONTRIBUTING.md#commit">Angularコミットメッセージ規約</a></li>
<li><a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#module-bindings">Phoenix LiveView入門</a></li>
</ul>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>