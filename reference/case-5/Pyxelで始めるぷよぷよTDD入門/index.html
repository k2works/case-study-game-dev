
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Pyxel で始めるぷよぷよテスト駆動開発入門 - Python でレトロゲーム開発を学ぶ - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pyxel-python" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pyxel で始めるぷよぷよテスト駆動開発入門 - Python でレトロゲーム開発を学ぶ
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="pyxel-python">Pyxel で始めるぷよぷよテスト駆動開発入門 - Python でレトロゲーム開発を学ぶ<a class="headerlink" href="#pyxel-python" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、Python と Pyxel でぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの？」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_2">本記事の特徴<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>本記事は、既存の TypeScript 版「ぷよぷよから始めるテスト駆動開発入門」を Python+Pyxel 版として再構成したものです。以下の特徴があります：</p>
<ul>
<li><strong>レトロゲーム開発</strong>: Pyxel を使った 8bit スタイルのゲーム開発</li>
<li><strong>現代的 Python 環境</strong>: uv、Ruff、mypy などの最新ツールチェーン</li>
<li><strong>TDD の実践</strong>: テスト駆動開発を実ゲーム開発で体験</li>
<li><strong>段階的学習</strong>: イテレーションごとに機能を追加していく</li>
</ul>
<h3 id="_3">テスト駆動開発のサイクル<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_4">開発環境<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>言語</strong>: Python 3.10+ — 「Pythonって初心者向けじゃないの？」と思われるかもしれませんが、型ヒントを使うことで、大規模な開発でもバグを減らしやすくなるんです。</li>
<li><strong>ゲームエンジン</strong>: Pyxel — 日本で開発されたレトロゲームエンジンです。シンプルで直感的な API が特徴です。</li>
<li><strong>パッケージマネージャ</strong>: uv — 次世代の高速 Python パッケージマネージャーです。pip よりも圧倒的に速いんです！</li>
<li><strong>テストフレームワーク</strong>: pytest — Python の標準的なテストフレームワークです。</li>
<li><strong>静的解析</strong>: Ruff — 従来の flake8、pylint、black を置き換える統合ツールです。</li>
<li><strong>型チェック</strong>: mypy — 静的型チェッカーで、Python に型安全性をもたらします。</li>
<li><strong>タスクランナー</strong>: tox — 「同じ作業の繰り返しって退屈じゃないですか？」そんな反復的なタスクを自動化してくれます。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ？昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション0: 環境の構築で解説します。</p>
<h2 id="_5">要件<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">ユーザーストーリー<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。
ユーザーストーリーには形式が定められておらず、標準的な記法もない。とはいえ、次のような形式でストーリーを考えてみると便利である。「＜ユーザーの種類＞として、＜機能や性能＞がほしい。それは＜ビジネス価値＞のためだ」という形のテンプレートに従うと、
たとえば次のようなストーリーを書ける。「本の購入者として、ＩＳＢＮで本を検索したい。それは探している本をすばやく見つけるためだ」</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう：</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜ん！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PCでプレイするなら必須ですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_7">ユースケース図<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>ユーザーストーリーを整理したところで、「これらの機能がどのように関連しているのか、全体像が見えるといいな」と思いませんか？そんなときに役立つのが「ユースケース図」です。
「ユースケース図って何？」と思われるかもしれませんね。ユースケース図は、システムと外部アクター（ここではプレイヤーとシステム自体）の相互作用を視覚的に表現するための図です。「絵に描いて整理すると分かりやすい」というやつですね。</p>
<blockquote>
<p>ユースケースは、システムの振る舞いに関する利害関係者の契約を表現するものです。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<p>「百聞は一見にしかず」というように、実際に見てみるのが一番分かりやすいですよね。では、私たちのぷよぷよゲームのユースケース図を見てみましょう：</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjU4OXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODI2cHg7aGVpZ2h0OjU4OXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgyNiA1ODkiIHdpZHRoPSI4MjZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU3NiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxNS4wNyIgeD0iMTEyIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1My45OTkzIiB4PSIzNDIuNTM1MyIgeT0iMjEuOTk1MSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MDc7JiMxMjQyNDsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfU3RhcnROZXdHYW1lIj48ZWxsaXBzZSBjeD0iMjE0LjAyNTkiIGN5PSI0NjkuOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMTUxLjAyNjIiIHk9IjQ3NC42NDM2Ij4mIzI2MDMyOyYjMTIzNzU7JiMxMjM1NjsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDM0OyYjMzgyODM7JiMyMjk4Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9SZXN0YXJ0R2FtZSI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iNTQwLjk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI1NDUuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQzNDsmIzEyNTIyOyYjMTI0NzM7JiMxMjQ3OTsmIzEyNTQwOyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1vdmVQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfTW92ZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjE5OS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNTguMDMyNyIgeT0iMjAzLjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMjQwMzg7JiMyMTQ5MTsmIzEyMzk1OyYjMzEyMjc7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUm90YXRlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfUm90YXRlUHV5byI+PGVsbGlwc2UgY3g9IjIxNC4wMjczIiBjeT0iMTMzLjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTc5LjAyNzQiIHk9IjEzNy42NTIxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzIyMjM4OyYjMzY1Nzg7PC90ZXh0PjwvZz48IS0tZW50aXR5IFF1aWNrRHJvcFB1eW8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X1F1aWNrRHJvcFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjY3LjAwMDUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3Mi4yNTI0IiByeT0iMTYuODUwNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjE1OC4wMzI3IiB5PSI3MS42NDg5Ij4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzMyMDMyOyYjMjYwODk7JiMxMjM2NzsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZhbGxQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZhbGxQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfRmFsbFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI1MiIgY3k9IjMyOS45OTUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI2Ni43MjUyIiByeT0iMTUuNzQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIxNjUuMDI1NCIgeT0iMzM0LjY0MzUiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMzMyNTg7JiMzMDAwMTsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEVyYXNlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJFcmFzZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9FcmFzZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI3MyIgY3k9IjI2NS4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjE3OS4wMjc0IiB5PSIyNjkuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyODA0MDsmIzIxNDM1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjI3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9DaGFpblJlYWN0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTIiIGN5PSIyNTYuOTk1IiBmaWxsPSIjRjFGMUYxIiByeD0iNjYuNzI1MiIgcnk9IjE1Ljc0NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMzg3LjAzNTQiIHk9IjI2MS42NDM1Ij4mIzM2ODk5OyYjMzc3ODI7JiMyMTQ1MzsmIzI0NTQwOyYjMTI0MzQ7JiMzMDMzMDsmIzI5OTgzOzwvdGV4dD48L2c+PCEtLWVudGl0eSBaZW5rZXNoaUJvbnVzLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ilplbmtlc2hpQm9udXMiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0iZW50MDAxMyIgaWQ9ImVudGl0eV9aZW5rZXNoaUJvbnVzIj48ZWxsaXBzZSBjeD0iNDM2LjA0MzEiIGN5PSIzMjYuOTk4NiIgZmlsbD0iI0YxRjFGMSIgcng9IjgzLjk5MzEiIHJ5PSIxOS4xOTg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iMzY2LjA0MzQiIHk9IjMzMS42NDcxIj4mIzIwODQwOyYjMjgwNDA7JiMxMjM3NTsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ5MDsmIzEyNDczOyYjMTI0MzQ7JiMyOTU1NDsmIzI0NDcxOzwvdGV4dD48L2c+PCEtLWVudGl0eSBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSIyOSIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJlbnRpdHlfRGlzcGxheVNjb3JlIj48ZWxsaXBzZSBjeD0iNjQxLjU1NDIiIGN5PSIyNTYuMDAyOCIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1OTkuNTU0NCIgeT0iMjYwLjY1MTMiPiYjMTI0NzM7JiMxMjQ2NzsmIzEyNDUwOyYjMTI0MzQ7JiMzNDkyMDsmIzMxMDM0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzNCIgZGF0YS11aWQ9ImVudDAwMTUiIGlkPSJlbnRpdHlfS2V5Ym9hcmRDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjA0MjQiIGN5PSIxMDAuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMzgwLjA0MjciIHk9IjEwNC42NDg5Ij4mIzEyNDYxOyYjMTI1NDA7JiMxMjUwODsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5MTsmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IEdhbWVPdmVyQ2hlY2stLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR2FtZU92ZXJDaGVjayIgZGF0YS1zb3VyY2UtbGluZT0iMzkiIGRhdGEtdWlkPSJlbnQwMDE2IiBpZD0iZW50aXR5X0dhbWVPdmVyQ2hlY2siPjxlbGxpcHNlIGN4PSIyMTQuMDI1OSIgY3k9IjM5OC45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIxNTEuMDI2MiIgeT0iNDAzLjY0MzYiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0NTg7JiMxMjU0MDsmIzEyNDk2OyYjMTI1NDA7JiMyMTAyODsmIzIzNDUwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBHYW1lT3ZlckFuaW1hdGlvbi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHYW1lT3ZlckFuaW1hdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iNDAiIGRhdGEtdWlkPSJlbnQwMDE3IiBpZD0iZW50aXR5X0dhbWVPdmVyQW5pbWF0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTkiIGN5PSIzOTguOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMzczLjAzNjIiIHk9IjQwMy42NDM2Ij4mIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDU4OyYjMTI1NDA7JiMxMjQ5NjsmIzEyNTQwOyYjMjg0MzY7JiMyMDk4Njs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUGxheWVyLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlBsYXllciIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJlbnRpdHlfUGxheWVyIj48ZWxsaXBzZSBjeD0iNDAuOTk5OCIgY3k9IjEzNi4zNSIgZmlsbD0iI0YxRjFGMSIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNDAuOTk5OCwxNDQuMzUgTDQwLjk5OTgsMTcxLjM1IE0yNy45OTk4LDE1Mi4zNSBMNTMuOTk5OCwxNTIuMzUgTTQwLjk5OTgsMTcxLjM1IEwyNy45OTk4LDE4Ni4zNSBNNDAuOTk5OCwxNzEuMzUgTDUzLjk5OTgsMTg2LjM1IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI2IiB5PSIyMDAuODQ1MSI+JiMxMjUwMzsmIzEyNTI0OyYjMTI0NTI7JiMxMjUxNjsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTeXN0ZW0tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImVudGl0eV9TeXN0ZW0iPjxlbGxpcHNlIGN4PSI3OTEuMDY5OSIgY3k9IjQzNi4zNSIgZmlsbD0iI0YxRjFGMSIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNzkxLjA2OTksNDQ0LjM1IEw3OTEuMDY5OSw0NzEuMzUgTTc3OC4wNjk5LDQ1Mi4zNSBMODA0LjA2OTksNDUyLjM1IE03OTEuMDY5OSw0NzEuMzUgTDc3OC4wNjk5LDQ4Ni4zNSBNNzkxLjA2OTksNDcxLjM1IEw4MDQuMDY5OSw0ODYuMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9Ijc2My4wNyIgeT0iNTAwLjg0NTEiPiYjMTI0NzE7JiMxMjQ3MzsmIzEyNDg2OyYjMTI1MTI7PC90ZXh0PjwvZz48IS0tbGluayBQbGF5ZXIgdG8gU3RhcnROZXdHYW1lLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSI0NSIgZGF0YS11aWQ9ImxuazE4IiBpZD0ibGlua19QbGF5ZXJfU3RhcnROZXdHYW1lIj48cGF0aCBkPSJNNTMuMDcsMjA0LjUgQzUzLjA3LDI4Ni4zIDUzLjA3LDQ3MCA1My4wNyw0NzAgQzUzLjA3LDQ3MCA4OC44OSw0NzAgMTI5LjksNDcwIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVN0YXJ0TmV3R2FtZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTM1LjksNDcwLDEyNi45LDQ2NiwxMzAuOSw0NzAsMTI2LjksNDc0LDEzNS45LDQ3MCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSZXN0YXJ0R2FtZSIgZGF0YS1zb3VyY2UtbGluZT0iNDYiIGRhdGEtdWlkPSJsbmsxOSIgaWQ9ImxpbmtfUGxheWVyX1Jlc3RhcnRHYW1lIj48cGF0aCBkPSJNMjkuMDcsMjA0LjM3IEMyOS4wNywyOTkuOTQgMjkuMDcsNTQxIDI5LjA3LDU0MSBDMjkuMDcsNTQxIDc5LjE4LDU0MSAxMjkuNTksNTQxIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJlc3RhcnRHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNTksNTQxLDEyNi41OSw1MzcsMTMwLjU5LDU0MSwxMjYuNTksNTQ1LDEzNS41OSw1NDEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIE1vdmVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iTW92ZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjQ3IiBkYXRhLXVpZD0ibG5rMjAiIGlkPSJsaW5rX1BsYXllcl9Nb3ZlUHV5byI+PHBhdGggZD0iTTc2LjQzLDE5My4xNSBDOTYuNCwxOTMuMTUgMTE2LjAzLDE5My4xNSAxMzkuNzUsMTkzLjE1IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLU1vdmVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDUuNzUsMTkzLjE1LDEzNi43NSwxODkuMTUsMTQwLjc1LDE5My4xNSwxMzYuNzUsMTk3LjE1LDE0NS43NSwxOTMuMTUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIFJvdGF0ZVB1eW8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSI0OCIgZGF0YS11aWQ9ImxuazIxIiBpZD0ibGlua19QbGF5ZXJfUm90YXRlUHV5byI+PHBhdGggZD0iTTc2LjQzLDE0MC45NyBDMTAzLjMyLDE0MC45NyAxMzQuNDgsMTQwLjk3IDE2My40LDE0MC45NyIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1Sb3RhdGVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNjkuNCwxNDAuOTcsMTYwLjQsMTM2Ljk3LDE2NC40LDE0MC45NywxNjAuNCwxNDQuOTcsMTY5LjQsMTQwLjk3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBRdWlja0Ryb3BQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iNDkiIGRhdGEtdWlkPSJsbmsyMiIgaWQ9ImxpbmtfUGxheWVyX1F1aWNrRHJvcFB1eW8iPjxwYXRoIGQ9Ik03Ni40NSwxMzQuNDEgQzEwOC45NSwxMzQuNDEgMTUyLjA3LDEzNC40MSAxNTIuMDcsMTM0LjQxIEMxNTIuMDcsMTM0LjQxIDE1Mi4wNywxMDAuNDkgMTUyLjA3LDgyLjA5IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVF1aWNrRHJvcFB1eW8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1Mi4wNyw3Ni4wOSwxNDguMDcsODUuMDksMTUyLjA3LDgxLjA5LDE1Ni4wNyw4NS4wOSwxNTIuMDcsNzYuMDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNTAiIGRhdGEtdWlkPSJsbmsyMyIgaWQ9ImxpbmtfUGxheWVyX0tleWJvYXJkQ29udHJvbCI+PHBhdGggZD0iTTQxLjA3LDEyNy40OSBDNDEuMDcsMTExLjcgNDEuMDcsOTcuMDUgNDEuMDcsOTcuMDUgQzQxLjA3LDk3LjA1IDI0NC42OSw5Ny4wNSAzNTguNTIsOTcuMDUiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjQuNTIsOTcuMDUsMzU1LjUyLDkzLjA1LDM1OS41Miw5Ny4wNSwzNTUuNTIsMTAxLjA1LDM2NC41Miw5Ny4wNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIEVyYXNlUHV5byB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRXJhc2VQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjUzIiBkYXRhLXVpZD0ibG5rMjQiIGlkPSJsaW5rX0VyYXNlUHV5b19TeXN0ZW0iPjxwYXRoIGQ9Ik0yNzIuODMsMjY1LjMyIEMzMDQuMjYsMjY1LjMyIDMzMi4wNywyNjUuMzIgMzMyLjA3LDI2NS4zMiBDMzMyLjA3LDI2NS4zMiAzMzIuMDcsNDM3LjUxIDMzMi4wNyw0MzcuNTEgQzMzMi4wNyw0MzcuNTEgNjYyLjYzLDQzNy41MSA3NjIuNyw0MzcuNTEiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjY2LjgzLDI2NS4zMiwyNzUuODMsMjY5LjMyLDI3MS44MywyNjUuMzIsMjc1LjgzLDI2MS4zMiwyNjYuODMsMjY1LjMyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRmFsbFB1eW8gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkZhbGxQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU0IiBkYXRhLXVpZD0ibG5rMjUiIGlkPSJsaW5rX0ZhbGxQdXlvX1N5c3RlbSI+PHBhdGggZD0iTTI4Ny4wNSwzMzAgQzMwNC4yOCwzMzAgMzEyLjA3LDMzMCAzMTIuMDcsMzMwIEMzMTIuMDcsMzMwIDMxMi4wNyw0NDIuMzQgMzEyLjA3LDQ0Mi4zNCBDMzEyLjA3LDQ0Mi4zNCA2NjAuMjEsNDQyLjM0IDc2Mi44OSw0NDIuMzQiIGZpbGw9Im5vbmUiIGlkPSJGYWxsUHV5by1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyODEuMDUsMzMwLDI5MC4wNSwzMzQsMjg2LjA1LDMzMCwyOTAuMDUsMzI2LDI4MS4wNSwzMzAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBDaGFpblJlYWN0aW9uIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJDaGFpblJlYWN0aW9uIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU1IiBkYXRhLXVpZD0ibG5rMjYiIGlkPSJsaW5rX0NoYWluUmVhY3Rpb25fU3lzdGVtIj48cGF0aCBkPSJNNTAzLjczLDI2My4zNSBDNTMwLjU5LDI2My4zNSA1NTAuMDcsMjYzLjM1IDU1MC4wNywyNjMuMzUgQzU1MC4wNywyNjMuMzUgNTUwLjA3LDQzMi42OCA1NTAuMDcsNDMyLjY4IEM1NTAuMDcsNDMyLjY4IDY5OS4zOCw0MzIuNjggNzYyLjk1LDQzMi42OCIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDk3LjczLDI2My4zNSw1MDYuNzMsMjY3LjM1LDUwMi43MywyNjMuMzUsNTA2LjczLDI1OS4zNSw0OTcuNzMsMjYzLjM1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgWmVua2VzaGlCb251cyB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iWmVua2VzaGlCb251cyIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NiIgZGF0YS11aWQ9ImxuazI3IiBpZD0ibGlua19aZW5rZXNoaUJvbnVzX1N5c3RlbSI+PHBhdGggZD0iTTUyNi4xOCwzMjcgQzYzMS4xNiwzMjcgNzkxLjA3LDMyNyA3OTEuMDcsMzI3IEM3OTEuMDcsMzI3IDc5MS4wNywzODYuNTEgNzkxLjA3LDQyNy42NSIgZmlsbD0ibm9uZSIgaWQ9Ilplbmtlc2hpQm9udXMtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTIwLjE4LDMyNyw1MjkuMTgsMzMxLDUyNS4xOCwzMjcsNTI5LjE4LDMyMyw1MjAuMTgsMzI3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRGlzcGxheVNjb3JlIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJEaXNwbGF5U2NvcmUiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTciIGRhdGEtdWlkPSJsbmsyOCIgaWQ9ImxpbmtfRGlzcGxheVNjb3JlX1N5c3RlbSI+PHBhdGggZD0iTTcwOS4zNywyNTYgQzc1NS42NywyNTYgODA1LjA3LDI1NiA4MDUuMDcsMjU2IEM4MDUuMDcsMjU2IDgwNS4wNywzNjYuODYgODA1LjA3LDQyNy40OCIgZmlsbD0ibm9uZSIgaWQ9IkRpc3BsYXlTY29yZS1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MDMuMzcsMjU2LDcxMi4zNywyNjAsNzA4LjM3LDI1Niw3MTIuMzcsMjUyLDcwMy4zNywyNTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckNoZWNrIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJHYW1lT3ZlckNoZWNrIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU4IiBkYXRhLXVpZD0ibG5rMjkiIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfU3lzdGVtIj48cGF0aCBkPSJNMjE0LjA3LDQyMy40OCBDMjE0LjA3LDQzNy4wNyAyMTQuMDcsNDQ3LjE3IDIxNC4wNyw0NDcuMTcgQzIxNC4wNyw0NDcuMTcgNjQ3LDQ0Ny4xNyA3NjIuODUsNDQ3LjE3IiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJDaGVjay1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMTQuMDcsNDE3LjQ4LDIxMC4wNyw0MjYuNDgsMjE0LjA3LDQyMi40OCwyMTguMDcsNDI2LjQ4LDIxNC4wNyw0MTcuNDgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckFuaW1hdGlvbiB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTkiIGRhdGEtdWlkPSJsbmszMCIgaWQ9ImxpbmtfR2FtZU92ZXJBbmltYXRpb25fU3lzdGVtIj48cGF0aCBkPSJNNTIwLjI4LDM5OSBDNjIwLjk2LDM5OSA3NzcuMDcsMzk5IDc3Ny4wNywzOTkgQzc3Ny4wNywzOTkgNzc3LjA3LDQxMi41MiA3NzcuMDcsNDI3LjQxIiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJBbmltYXRpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTE0LjI4LDM5OSw1MjMuMjgsNDAzLDUxOS4yOCwzOTksNTIzLjI4LDM5NSw1MTQuMjgsMzk5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIE1vdmVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNb3ZlUHV5byIgZGF0YS1lbnRpdHktMj0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2MiIgZGF0YS11aWQ9ImxuazMxIiBpZD0ibGlua19Nb3ZlUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yNzMuMDcsMTg5LjE2IEMyNzMuMDcsMTY2LjA2IDI3My4wNywxMTAuMjUgMjczLjA3LDExMC4yNSBDMjczLjA3LDExMC4yNSAzMjQuOSwxMTAuMjUgMzcxLjY3LDExMC4yNSIgZmlsbD0ibm9uZSIgaWQ9Ik1vdmVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc3LjY3LDExMC4yNSwzNjguNjcsMTA2LjI1LDM3Mi42NywxMTAuMjUsMzY4LjY3LDExNC4yNSwzNzcuNjcsMTEwLjI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjg2LjkxIiB5PSIxMjMuMzE2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBSb3RhdGVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSb3RhdGVQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjYzIiBkYXRhLXVpZD0ibG5rMzIiIGlkPSJsaW5rX1JvdGF0ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjE0LjA3LDExNy45OCBDMjE0LjA3LDExMC43NiAyMTQuMDcsMTAzLjY1IDIxNC4wNywxMDMuNjUgQzIxNC4wNywxMDMuNjUgMjk0LjI0LDEwMy42NSAzNTkuMiwxMDMuNjUiIGZpbGw9Im5vbmUiIGlkPSJSb3RhdGVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY1LjIsMTAzLjY1LDM1Ni4yLDk5LjY1LDM2MC4yLDEwMy42NSwzNTYuMiwxMDcuNjUsMzY1LjIsMTAzLjY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjIwLjQ3IiB5PSI5OS43MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFF1aWNrRHJvcFB1eW8gdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlF1aWNrRHJvcFB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNjQiIGRhdGEtdWlkPSJsbmszMyIgaWQ9ImxpbmtfUXVpY2tEcm9wUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yODAuMDcsNzQuMTYgQzI4MC4wNyw4MS4wNiAyODAuMDcsOTAuNDUgMjgwLjA3LDkwLjQ1IEMyODAuMDcsOTAuNDUgMzI1Ljg1LDkwLjQ1IDM2OS43NCw5MC40NSIgZmlsbD0ibm9uZSIgaWQ9IlF1aWNrRHJvcFB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNzUuNzQsOTAuNDUsMzY2Ljc0LDg2LjQ1LDM3MC43NCw5MC40NSwzNjYuNzQsOTQuNDUsMzc1Ljc0LDkwLjQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzIwLjc2IiB5PSI4Ni41MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIEVyYXNlUHV5byB0byBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkVyYXNlUHV5byIgZGF0YS1lbnRpdHktMj0iQ2hhaW5SZWFjdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iNjciIGRhdGEtdWlkPSJsbmszNCIgaWQ9ImxpbmtfRXJhc2VQdXlvX0NoYWluUmVhY3Rpb24iPjxwYXRoIGQ9Ik0yNjAuNTcsMjU3LjkgQzI5Mi4xLDI1Ny45IDMyOC4yNiwyNTcuOSAzNjMuMzUsMjU3LjkiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tdG8tQ2hhaW5SZWFjdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY5LjM1LDI1Ny45LDM2MC4zNSwyNTMuOSwzNjQuMzUsMjU3LjksMzYwLjM1LDI2MS45LDM2OS4zNSwyNTcuOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjI1MC45NiIgeT0iMjUzLjk2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIENoYWluUmVhY3Rpb24gdG8gRGlzcGxheVNjb3JlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkNoYWluUmVhY3Rpb24iIGRhdGEtZW50aXR5LTI9IkRpc3BsYXlTY29yZSIgZGF0YS1zb3VyY2UtbGluZT0iNjgiIGRhdGEtdWlkPSJsbmszNSIgaWQ9ImxpbmtfQ2hhaW5SZWFjdGlvbl9EaXNwbGF5U2NvcmUiPjxwYXRoIGQ9Ik00OTMuNTYsMjQ4LjY1IEM1MjMuMDEsMjQ4LjY1IDU1Mi42NSwyNDguNjUgNTgxLjU4LDI0OC42NSIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tdG8tRGlzcGxheVNjb3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1ODcuNTgsMjQ4LjY1LDU3OC41OCwyNDQuNjUsNTgyLjU4LDI0OC42NSw1NzguNTgsMjUyLjY1LDU4Ny41OCwyNDguNjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1NDEuNTciIHk9IjI0NC43MTY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBaZW5rZXNoaUJvbnVzIHRvIERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJaZW5rZXNoaUJvbnVzIiBkYXRhLWVudGl0eS0yPSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9IjY5IiBkYXRhLXVpZD0ibG5rMzYiIGlkPSJsaW5rX1plbmtlc2hpQm9udXNfRGlzcGxheVNjb3JlIj48cGF0aCBkPSJNNTE0LjA3LDMxOS42NyBDNTE0LjA3LDMwMS41MyA1MTQuMDcsMjU2IDUxNC4wNywyNTYgQzUxNC4wNywyNTYgNTQxLjE5LDI1NiA1NzMuNjgsMjU2IiBmaWxsPSJub25lIiBpZD0iWmVua2VzaGlCb251cy10by1EaXNwbGF5U2NvcmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU3OS42OCwyNTYsNTcwLjY4LDI1Miw1NzQuNjgsMjU2LDU3MC42OCwyNjAsNTc5LjY4LDI1NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjUxNi4wNCIgeT0iMjY5LjA2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIEdhbWVPdmVyQ2hlY2sgdG8gR2FtZU92ZXJBbmltYXRpb24tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJDaGVjayIgZGF0YS1lbnRpdHktMj0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtc291cmNlLWxpbmU9IjcwIiBkYXRhLXVpZD0ibG5rMzciIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfR2FtZU92ZXJBbmltYXRpb24iPjxwYXRoIGQ9Ik0yOTIuMywzOTkgQzMxMy41MiwzOTkgMzMwLjUsMzk5IDM1MS43MywzOTkiIGZpbGw9Im5vbmUiIGlkPSJHYW1lT3ZlckNoZWNrLXRvLUdhbWVPdmVyQW5pbWF0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNTcuNzMsMzk5LDM0OC43MywzOTUsMzUyLjczLDM5OSwzNDguNzMsNDAzLDM1Ny43MywzOTkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIyNjEuMDEiIHk9IjQxMi4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tU1JDPVtiTEpUSlhEMTZCdFZmelhtdXJMdjA0RDg1OUdCZW9CU1VKVGtudFJKeEt3cEVxS1JHczl0MUllOEQxTlJBQVkwb0EtWVcxNmJfM3BDVEJoak1wV3BJeFNwNTU5Q0RmbERWRVZpVHh1cFB5UTJKeDZFYVV3T1lJSk11d08zM01tWU10REpmZnExM2FaaDZNMmFHMEFFdWZtNVRMdTZUaUEyNGkwb1JPWHA2UVdaMW9VSGZqdEdZUlRBbDFfNEVvRi1DU2RscWpxRm1VY00xV29DN0JzNy0xTllWb0ZVNmw3UFN6b1owclNWamEwRUVYNzJFb0pVTi05RjRkelBiNFRwQmVQZkpPa3dDcW9VT0doZFJzLVZEX0FOTFU4QjNRQzRuNGRlaTR5a3dYbUx4QXU0blNiY1VSTnZ5V2pKSF9ucmxpdnV0Ynh1ZU1MVFEwMk5UUWNOVnY5eVhVSFZJSXJBcFY4Q3RQVzlYTTdXdTBWbXNIMThtcFBCMVhEX01fblFNRTROMTZpNGtmbWRJRUZRMVBMWWVsaFJzVGg5cWhLYWpZbWVxU0RyRWR6MHlabDFIZk5FbDFFVHhnQ25FOXBEZVNsV1l2eVFyVExHM3k4ME51S0JWWXROQXJpYUZ6eWVkakotWDZDX29mZjZRajExNlM3ZjYyNFFseE5KX3BUOE9zZXhNRFlKc2pxNWJkTTVrbGhsMGZzaDJqR1RYdkxLNjZsUWQybEotTGJ3amlIN1VOeUtCN21NdTg0YUNFcUgyQ0FtSG1Hd2lTZC1vQlZTTm44cEowa2pmTTFzZHZ2TTFGQ25qNUZHSlBndGFQcnJ2SnJkazBDSF81OVpQSkRPRW5CZUdURkRpNm9GNmlaZnQ2aXd5UExFQnJ4RjdFLXhxMUVnVWF0bzZzNTRIOUR4Q0ZTNDBJUy1XNnBpOEVrSTNNYVZZc2pzWW1BeUJKd0F4NHFCUS1tV1l1T3lrR183ZTNFR1g0UWcyd3ItbDQyZFpYSlFCVGpDMHM3eUVEVkExQWZOMGJDTm9qSjJVcTZGblZoTGVvUWpvdVQ5TWV3SUJxRlJFUFRNckoxQlhPa3NOZDJvaEo5QWRqdU5ZeEtrZ3JQZXZKS2JUTjkxMlBMU2FGQ1pob2l4UzVhWHliV2t5aW96Y1EzNTdJUXlUa1BmQlBGcXRqd0VTVk1SVWJ5VlY4d1g3VV9scnpoTVRTU2dYZFE3WXFsbDh0RXBMWXM3ZGQ5ZlJLX3YzckpaRURzcTNJaVJYdW9sclpYUUNLcTVncVB0MFFpY1N0MmRrbWhaN20wMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p>この図を見ると、プレイヤーとシステムの役割分担がよくわかりますね。プレイヤーはゲームの開始や操作を担当し、システムはぷよの消去判定やスコア計算などの内部処理を担当しています。また、キーボード操作は「拡張（extend）」関係にあり、ぷよの移動や回転などの基本操作を異なる入力方法で実現していることがわかります（TypeScript 版ではタッチ操作もサポートしていましたが、Python+Pyxel 版ではキーボード操作に集中します）。</p>
<p>このようにユースケース図を作成することで、システムの全体像を把握し、実装すべき機能の関連性を明確にすることができます。それでは、実際のコード実装に進んでいきましょう！</p>
<p>誤解しないでもらいたいのですが本来ユースケースとはテキストで記述するものでありユースケース図は概要を把握するための手段に過ぎないということです。</p>
<blockquote>
<p>楕円、矢印、人型おアイコンから構成されているUMLのユースケース図は、ユースケースを把握するための表記法ではありません。
楕円や矢印は、ユースケースをのパッケージや分解を表すもので、内容を表すものではありません。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<h2 id="_8">リリース計画<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>要件もわかった、プログラミング開始だ！ちょっと待ってください、何事も計画を立てる事は大事なことです。ユースケース図を見てください、結構いろんなことがありますよね。何から取り組みますか？
「スコアの表示」ですか？「ゲームオーバー判定」ですか？でもまずは「新しいゲームを開始」しないとつながりとして難しいですよね。もちろん実際にプログラミングしながら順番を考えてもいいですけど間違った順番で進めると直すのが大変ですよね。
それにこれからどんなものを作るのかは事前にある程度イメージを固めておきたいものです（いきなり「ゲームオーバー」になるゲームはやりたくないですよね）。</p>
<blockquote>
<p>計画づくりとは「なにをいつまでに作ればいいのか？」という質問に答える作業だと私は考えている</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>今回の目的はぷよぷよゲームを遊べるための最小限の機能の実装です。目的を実現するためにやるべきことをイテレーションという単位でまとめましょう。「全部やること洗い出すの？そんな先のことはわからないよ！」と思いますよね。安心してください今決めることは大まかな作業の流れと前後関係の整理だけです。
細かい部分は各イテレーションでおいおい明確になってきます。その手助けをしてくれるのがテスト駆動開発なのです。</p>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>今回はユーザーストーリーとユースケース図から以下のイテレーション計画に従ってぷよぷよゲームをリリースします。</p>
<ul>
<li><strong>イテレーション0</strong>: 環境の構築と Pyxel 入門</li>
<li><strong>イテレーション1</strong>: ゲーム開始の実装</li>
<li><strong>イテレーション2</strong>: ぷよの移動の実装</li>
<li><strong>イテレーション3</strong>: ぷよの回転の実装</li>
<li><strong>イテレーション4</strong>: ぷよの自由落下の実装</li>
<li><strong>イテレーション5</strong>: ぷよの高速落下の実装</li>
<li><strong>イテレーション6</strong>: ぷよの消去の実装</li>
<li><strong>イテレーション7</strong>: 連鎖反応の実装</li>
<li><strong>イテレーション8</strong>: 全消しボーナスの実装</li>
<li><strong>イテレーション9</strong>: ゲームオーバーの実装</li>
</ul>
<p>では、ぷよぷよゲーム開発スタートです！</p>
<h2 id="0-pyxel">イテレーション0: 環境の構築と Pyxel 入門<a class="headerlink" href="#0-pyxel" title="Permanent link">&para;</a></h2>
<p>...と言いたいところですがまずは環境の構築をしなければなりません。「プログラミングなんてどの言語でやるか決めるぐらいでしょ？」と思うかもしれませんが家を建てるときにしっかりとした基礎工事が必要なように開発環境もしっかりとした準備が必要です。
家を建てた後に基礎がダメだと困ったことになりますからね。</p>
<h3 id="_9">ソフトウェア開発の三種の神器<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本章では開発環境のセットアップとして、これら三種の神器を準備していきます。環境構築は退屈に感じるかもしれませんが、これらのツールがあることで、安心してコードを書くことができるようになります。一緒に進んでいきましょう！</p>
<h3 id="git">バージョン管理: Git とコミットメッセージ<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>バージョン管理システムとして Git を使います。Git については既に使用していると仮定しますが、コミットメッセージについて1つだけ重要なルールを確認しておきましょう。</p>
<h4 id="_10">コミットメッセージの書き方<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>私たちのプロジェクトでは、<a href="https://www.conventionalcommits.org/ja/">Conventional Commits</a>の書式に従ってコミットメッセージを書きます。具体的には、それぞれのコミットメッセージはヘッダ、ボディ、フッタで構成されます。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p>ヘッダは必須で、スコープは任意です。コミットメッセージのタイトルは50文字までにしましょう（GitHub上で読みやすくなります）。</p>
<p>コミットのタイプは次を用います：</p>
<ul>
<li><strong>feat</strong>: 新しい機能</li>
<li><strong>fix</strong>: バグ修正</li>
<li><strong>docs</strong>: ドキュメント変更のみ</li>
<li><strong>style</strong>: コードに影響を与えない変更（空白、フォーマットなど）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更</li>
<li><strong>test</strong>: テストの追加や修正</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更</li>
</ul>
<p>例えば：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化機能を追加&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: メソッドの抽出&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよ消去のテストケースを追加&#39;</span>
</code></pre></div>
<h3 id="_11">テスティング: パッケージマネージャとテスト環境<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>良いコードを書くためには、コードが正しく動作することを確認するテストが欠かせません。そのためのツールをセットアップしていきましょう。</p>
<h4 id="uv">パッケージマネージャ: uv<a class="headerlink" href="#uv" title="Permanent link">&para;</a></h4>
<p>外部ライブラリやツールを管理するために <strong>uv</strong> を使います。</p>
<blockquote>
<p>uvとは、Pythonプロジェクトの依存関係を管理し、仮想環境を自動で作成・管理する高速なPythonパッケージマネージャーです。従来のpipやpoetryよりも高速で、プロジェクトの初期化から依存関係の管理まで一元的に行えます。</p>
<p>— Pythonパッケージ管理</p>
</blockquote>
<p><strong>uv</strong> でプロジェクトを初期化しましょう。まず、プロジェクトディレクトリを作成します：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>puyo-puyo-python
<span class="nb">cd</span><span class="w"> </span>puyo-puyo-python
</code></pre></div>
<p>次に、<strong>uv</strong> でプロジェクトを初期化します：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>init
</code></pre></div>
<p>これで <code>pyproject.toml</code> が作成されます。これは <strong>uv</strong> がパッケージの依存関係とプロジェクト設定を管理するためのファイルです。</p>
<p>内容を確認してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="k">[project]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;puyo-puyo-python&quot;</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Pyxelで始めるぷよぷよテスト駆動開発入門&quot;</span>
<span class="n">readme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;README.md&quot;</span>
<span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.10&quot;</span>
<span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
</code></pre></div>
<h4 id="pyxel">Pyxel のインストール<a class="headerlink" href="#pyxel" title="Permanent link">&para;</a></h4>
<p>まず、ゲームエンジンである Pyxel をインストールします：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>add<span class="w"> </span>pyxel
</code></pre></div>
<p>これで Pyxel がプロジェクトに追加されました。<code>pyproject.toml</code> を確認すると、dependencies に pyxel が追加されているはずです：</p>
<div class="highlight"><pre><span></span><code><span class="k">[project]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;puyo-puyo-python&quot;</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Pyxelで始めるぷよぷよテスト駆動開発入門&quot;</span>
<span class="n">readme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;README.md&quot;</span>
<span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.10&quot;</span>
<span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;pyxel&gt;=2.2.16&quot;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>
<h4 id="_12">開発依存関係のインストール<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>次に、開発に必要なツールをインストールします：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>add<span class="w"> </span>--dev<span class="w"> </span>pytest<span class="w"> </span>pytest-cov<span class="w"> </span>ruff<span class="w"> </span>mypy<span class="w"> </span>tox
</code></pre></div>
<p>これで以下のツールがインストールされました：</p>
<ul>
<li><strong>pytest</strong>: テストフレームワーク</li>
<li><strong>pytest-cov</strong>: コードカバレッジ計測</li>
<li><strong>ruff</strong>: リンター・フォーマッター</li>
<li><strong>mypy</strong>: 静的型チェッカー</li>
<li><strong>tox</strong>: タスクランナー</li>
</ul>
<p><code>pyproject.toml</code> に開発依存関係が追加されます：</p>
<div class="highlight"><pre><span></span><code><span class="k">[project.optional-dependencies]</span>
<span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;pytest&gt;=8.4.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;pytest-cov&gt;=6.2.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;ruff&gt;=0.12.3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;mypy&gt;=1.17.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;tox&gt;=4.27.0&quot;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>
<h3 id="pyxel_1">Pyxel の基本<a class="headerlink" href="#pyxel_1" title="Permanent link">&para;</a></h3>
<p>Pyxel は日本で開発されたレトロゲームエンジンです。8bit スタイルのゲーム作成に特化しており、以下の特徴があります：</p>
<ul>
<li><strong>シンプルな API</strong>: 初心者にも分かりやすい直感的なインターフェース</li>
<li><strong>レトロスタイル</strong>: 16色パレット、8bit 音源によるノスタルジックなゲーム体験</li>
<li><strong>高いパフォーマンス</strong>: Rust ベースで動作が軽快</li>
<li><strong>日本語サポート</strong>: 日本語ドキュメントとコミュニティ</li>
<li><strong>教育目的に最適</strong>: ゲーム開発の基礎を学ぶのに理想的</li>
</ul>
<h4 id="pyxel_2">最小限の Pyxel アプリケーション<a class="headerlink" href="#pyxel_2" title="Permanent link">&para;</a></h4>
<p>Pyxel の基本を理解するために、最小限のアプリケーションを作成してみましょう。<code>lib/hello_pyxel.py</code> というファイルを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pyxel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">App</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Hello Pyxel&quot;</span><span class="p">)</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">btnp</span><span class="p">(</span><span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_Q</span><span class="p">):</span>
            <span class="n">pyxel</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="s2">&quot;Hello, Pyxel!&quot;</span><span class="p">,</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Press Q to quit&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

<span class="n">App</span><span class="p">()</span>
</code></pre></div>
<p>このコードを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>lib/hello_pyxel.py
</code></pre></div>
<p>ウィンドウが表示され、「Hello, Pyxel!」というテキストが色を変えながら表示されます。Q キーを押すとプログラムが終了します。</p>
<h4 id="pyxel_3">Pyxel の基本的な構造<a class="headerlink" href="#pyxel_3" title="Permanent link">&para;</a></h4>
<p>Pyxel のアプリケーションは、以下の基本構造を持ちます：</p>
<ol>
<li><strong>初期化（init）</strong>: ウィンドウサイズやタイトルを設定</li>
<li><strong>ゲームループ（run）</strong>: <code>update</code> と <code>draw</code> を繰り返し実行</li>
<li><strong>更新（update）</strong>: ゲーム状態の更新（入力処理、物理演算など）</li>
<li><strong>描画（draw）</strong>: 画面への描画</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pyxel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">App</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 1. 初期化: ウィンドウを160x120ピクセルで作成</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;My App&quot;</span><span class="p">)</span>
        <span class="c1"># 2. ゲームループ開始</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 3. 更新: 毎フレーム呼ばれる（60FPS）</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 4. 描画: 毎フレーム呼ばれる（60FPS）</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 画面をクリア（色0 = 黒）</span>
</code></pre></div>
<h4 id="pyxel-api">Pyxel の主要な API<a class="headerlink" href="#pyxel-api" title="Permanent link">&para;</a></h4>
<p>Pyxel でよく使う API を紹介します：</p>
<p><strong>ウィンドウ制御</strong>:
<div class="highlight"><pre><span></span><code><span class="n">pyxel</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># ウィンドウ初期化</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">draw</span><span class="p">)</span>              <span class="c1"># ゲームループ開始</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>                         <span class="c1"># アプリケーション終了</span>
</code></pre></div></p>
<p><strong>描画</strong>:
<div class="highlight"><pre><span></span><code><span class="n">pyxel</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>                       <span class="c1"># 画面クリア</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">pset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>                <span class="c1"># ピクセル描画</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>      <span class="c1"># 直線描画</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>          <span class="c1"># 四角形（輪郭）</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">rectb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>         <span class="c1"># 四角形（塗りつぶし）</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">circ</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>             <span class="c1"># 円（輪郭）</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">circb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>            <span class="c1"># 円（塗りつぶし）</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>             <span class="c1"># テキスト描画</span>
</code></pre></div></p>
<p><strong>入力</strong>:
<div class="highlight"><pre><span></span><code><span class="n">pyxel</span><span class="o">.</span><span class="n">btn</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>                       <span class="c1"># キーが押されているか</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">btnp</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>                      <span class="c1"># キーが押された瞬間か</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">btnr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>                      <span class="c1"># キーが離された瞬間か</span>
</code></pre></div></p>
<p><strong>その他</strong>:
<div class="highlight"><pre><span></span><code><span class="n">pyxel</span><span class="o">.</span><span class="n">frame_count</span>                    <span class="c1"># フレーム数（ゲーム開始からの経過フレーム）</span>
</code></pre></div></p>
<h4 id="_13">キーコード<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>Pyxel で使用できる主なキーコード：</p>
<div class="highlight"><pre><span></span><code><span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_SPACE</span>    <span class="c1"># スペースキー</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_ENTER</span>    <span class="c1"># エンターキー</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_LEFT</span>     <span class="c1"># 左矢印キー</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_RIGHT</span>    <span class="c1"># 右矢印キー</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_UP</span>       <span class="c1"># 上矢印キー</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_DOWN</span>     <span class="c1"># 下矢印キー</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_Q</span>        <span class="c1"># Qキー</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_A</span>        <span class="c1"># Aキー</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_Z</span>        <span class="c1"># Zキー</span>
</code></pre></div>
<h4 id="_14">カラーパレット<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>Pyxel は 16 色のカラーパレットを持ちます：</p>
<table>
<thead>
<tr>
<th>番号</th>
<th>色</th>
<th>番号</th>
<th>色</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>黒</td>
<td>8</td>
<td>赤</td>
</tr>
<tr>
<td>1</td>
<td>濃紺</td>
<td>9</td>
<td>オレンジ</td>
</tr>
<tr>
<td>2</td>
<td>紫</td>
<td>10</td>
<td>黄色</td>
</tr>
<tr>
<td>3</td>
<td>緑</td>
<td>11</td>
<td>黄緑</td>
</tr>
<tr>
<td>4</td>
<td>茶色</td>
<td>12</td>
<td>水色</td>
</tr>
<tr>
<td>5</td>
<td>濃灰色</td>
<td>13</td>
<td>灰色</td>
</tr>
<tr>
<td>6</td>
<td>薄灰色</td>
<td>14</td>
<td>ピンク</td>
</tr>
<tr>
<td>7</td>
<td>白</td>
<td>15</td>
<td>薄ピンク</td>
</tr>
</tbody>
</table>
<p>これで Pyxel の基本を理解できました！</p>
<h3 id="_15">プロジェクト構造の作成<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>ぷよぷよゲームのプロジェクト構造を作成します：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>lib<span class="w"> </span><span class="nb">test</span>
touch<span class="w"> </span>lib/__init__.py
touch<span class="w"> </span>test/__init__.py
</code></pre></div>
<p>最終的なディレクトリ構造：</p>
<div class="highlight"><pre><span></span><code>puyo-puyo-python/
├── lib/
│   ├── __init__.py
│   └── (ゲームのソースコード)
├── test/
│   ├── __init__.py
│   └── (テストコード)
├── pyproject.toml
├── tox.ini
└── README.md
</code></pre></div>
<h3 id="_16">自動化: 品質管理ツールのセットアップ<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<h4 id="ruff">静的コード解析: Ruff<a class="headerlink" href="#ruff" title="Permanent link">&para;</a></h4>
<p>良いコードを書き続けるためにはコードの品質を維持していく必要があります。Python 用の静的コード解析ツール <strong>Ruff</strong> を使って確認してみましょう。</p>
<p>Ruff は高速でモダンな Python リンター・フォーマッターで、従来の flake8、pylint、black などを置き換える統合ツールです。</p>
<p>設定ファイル <code>.ruff.toml</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="n">line-length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">88</span>
<span class="n">target-version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;py310&quot;</span>

<span class="k">[lint]</span>
<span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># pycodestyle errors</span>
<span class="w">    </span><span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># pycodestyle warnings</span>
<span class="w">    </span><span class="s2">&quot;F&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># pyflakes</span>
<span class="w">    </span><span class="s2">&quot;I&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># isort</span>
<span class="w">    </span><span class="s2">&quot;B&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># flake8-bugbear</span>
<span class="w">    </span><span class="s2">&quot;C4&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># flake8-comprehensions</span>
<span class="w">    </span><span class="s2">&quot;UP&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># pyupgrade</span>
<span class="p">]</span>
<span class="n">ignore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="k">[format]</span>
<span class="n">quote-style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;double&quot;</span>
<span class="n">indent-style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;space&quot;</span>
<span class="n">skip-magic-trailing-comma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="n">line-ending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>

<span class="k">[lint.per-file-ignores]</span>
<span class="s2">&quot;test/**/*.py&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;E501&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1"># Allow long lines in tests</span>

<span class="k">[lint.mccabe]</span>
<span class="n">max-complexity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="c1"># 循環的複雑度の制限</span>
</code></pre></div>
<blockquote>
<p>循環的複雑度 (Cyclomatic complexity) とは、ソフトウェア測定法の一つであり、コードがどれぐらい複雑であるかをメソッド単位で数値にして表す指標。</p>
</blockquote>
<p>リンターを実行してみます：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>check<span class="w"> </span>.
</code></pre></div>
<p>自動修正も可能です：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>check<span class="w"> </span>.<span class="w"> </span>--fix
</code></pre></div>
<h4 id="ruff-format">コードフォーマッタ: Ruff format<a class="headerlink" href="#ruff-format" title="Permanent link">&para;</a></h4>
<p>良いコードであるためにはフォーマットも大切な要素です。</p>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>— リーダブルコード</p>
</blockquote>
<p><strong>Ruff</strong> はリンターとしてだけでなく、コードフォーマッターとしても機能します。従来の black の代替として使えます。</p>
<p>フォーマットをチェック：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>format<span class="w"> </span>--check<span class="w"> </span>.
</code></pre></div>
<p>自動フォーマット：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>format<span class="w"> </span>.
</code></pre></div>
<h4 id="pytest-cov">コードカバレッジ: pytest-cov<a class="headerlink" href="#pytest-cov" title="Permanent link">&para;</a></h4>
<p>静的コードコード解析による品質の確認はできました。では動的なテストに関してはどうでしょうか？<strong>コードカバレッジ</strong> を確認する必要があります。</p>
<blockquote>
<p>コード網羅率（コードもうらりつ、英: Code coverage）コードカバレッジは、ソフトウェアテストで用いられる尺度の1つである。プログラムのソースコードがテストされた割合を意味する。この場合のテストはコードを見ながら行うもので、ホワイトボックステストに分類される。</p>
<p>— ウィキペディア</p>
</blockquote>
<p>Python 用コードカバレッジ検出プログラムとして <strong>pytest-cov</strong> を使います。これは先程 <strong>uv</strong> でインストール済みです。</p>
<p><code>pyproject.toml</code> にテストとカバレッジの設定を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">[tool.pytest.ini_options]</span>
<span class="n">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="n">python_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;test_*.py&quot;</span><span class="p">]</span>
<span class="n">python_classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Test*&quot;</span><span class="p">]</span>
<span class="n">python_functions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;test_*&quot;</span><span class="p">]</span>
<span class="n">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;--cov=lib --cov-report=html --cov-report=term-missing&quot;</span>

<span class="k">[tool.coverage.run]</span>
<span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;lib&quot;</span><span class="p">]</span>

<span class="k">[tool.coverage.report]</span>
<span class="n">exclude_lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;pragma: no cover&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;def __repr__&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;raise AssertionError&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;raise NotImplementedError&quot;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>
<p>テストを実施します（まだテストがないのでエラーになります）：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>test/<span class="w"> </span>-v<span class="w"> </span>--cov<span class="o">=</span>lib<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>
<p>テスト実行後に <code>htmlcov</code> というフォルダが作成されます。その中の <code>index.html</code> を開くとカバレッジ状況を確認できます。</p>
<h4 id="mypy">型チェック: mypy<a class="headerlink" href="#mypy" title="Permanent link">&para;</a></h4>
<p>Python は動的型付け言語ですが、型ヒントを使って静的型チェックを行うことで、より安全で保守性の高いコードを書くことができます。</p>
<blockquote>
<p>mypy とは、Python のための静的型チェッカーです。型ヒント（Type Hints）を使用してコードの型安全性を検証し、実行前に型エラーを検出できます。</p>
<p>— Python 型チェック</p>
</blockquote>
<p><strong>mypy</strong> を使って型チェックを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>mypy<span class="w"> </span>lib<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>mypy の設定は <code>pyproject.toml</code> で管理できます：</p>
<div class="highlight"><pre><span></span><code><span class="k">[tool.mypy]</span>
<span class="n">python_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;3.10&quot;</span>
<span class="n">warn_return_any</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">warn_unused_configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">disallow_untyped_defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</code></pre></div>
<p>型チェック機能により、以下のようなメリットがあります：</p>
<ul>
<li>実行前に型エラーを検出</li>
<li>IDE での補完機能の向上</li>
<li>コードの可読性と保守性の向上</li>
<li>リファクタリング時の安全性向上</li>
</ul>
<h4 id="tox">タスクランナー: tox<a class="headerlink" href="#tox" title="Permanent link">&para;</a></h4>
<p>ここまででテストの実行、静的コード解析、コードフォーマット、コードカバレッジを実施することができるようになりました。でもコマンドを実行するのにそれぞれコマンドを覚えておくのは面倒ですよね。いちいち調べるのが面倒なことは全部 <strong>タスクランナー</strong> にやらせるようにしましょう。</p>
<blockquote>
<p>タスクランナーとは、アプリケーションのビルドなど、一定の手順で行う作業をコマンド一つで実行できるように予めタスクとして定義したものです。</p>
<p>— Python ビルドツール</p>
</blockquote>
<p>Python のタスクランナーは <strong>tox</strong> です。</p>
<blockquote>
<p>tox は Python におけるタスクランナーです。tox コマンドと起点となる tox.ini というタスクを記述するファイルを用意することで、複数の Python 環境でのテスト実行や、タスクの一覧表示を行えます。</p>
<p>— Python ビルドツール</p>
</blockquote>
<p><code>tox.ini</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">[tox]</span>
<span class="na">envlist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">py310,lint,type,coverage</span>
<span class="na">skip_missing_interpreters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>

<span class="k">[testenv]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">pytest</span>
<span class="w">    </span><span class="na">pytest-cov</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pytest {posargs}</span>

<span class="k">[testenv:test]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">pytest</span>
<span class="w">    </span><span class="na">pytest-cov</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pytest --cov=lib --cov-report=html --cov-report=term-missing --verbose</span>

<span class="k">[testenv:lint]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">ruff</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">ruff check .</span>
<span class="w">    </span><span class="na">ruff format --check .</span>

<span class="k">[testenv:format]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">ruff</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">ruff format .</span>

<span class="k">[testenv:type]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">mypy</span>
<span class="w">    </span><span class="na">pytest</span>
<span class="w">    </span><span class="na">pyxel</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">mypy lib test</span>

<span class="k">[testenv:coverage]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">pytest</span>
<span class="w">    </span><span class="na">pytest-cov</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pytest --cov=lib --cov-report=html --cov-report=term-missing</span>
</code></pre></div>
<p>タスクを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># すべての品質チェックとテストを実行</span>
uv<span class="w"> </span>run<span class="w"> </span>tox

<span class="c1"># 個別タスクの実行</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span><span class="nb">test</span><span class="w">        </span><span class="c1"># テストのみ</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>lint<span class="w">        </span><span class="c1"># リンターのみ</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span><span class="nb">type</span><span class="w">        </span><span class="c1"># 型チェックのみ</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>coverage<span class="w">    </span><span class="c1"># カバレッジレポートのみ</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>format<span class="w">      </span><span class="c1"># フォーマットのみ</span>
</code></pre></div>
<h3 id="_17">最終的な開発ワークフロー<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>これで <a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a> の準備が完了しました。最終的な開発ワークフローは以下のようになります：</p>
<ol>
<li><strong>開発開始</strong>: <code>uv run tox</code> を実行して品質チェック</li>
<li><strong>コード作成</strong>: テスト駆動開発のサイクル（Red-Green-Refactor）</li>
<li><strong>品質確認</strong>: 各ツールが自動で品質をチェック</li>
<li><strong>コミット</strong>: 品質チェックを通ったコードを Git にコミット</li>
</ol>
<h3 id="_18">使用可能なコマンド一覧<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># すべての品質チェックとテストを実行（推奨）</span>
uv<span class="w"> </span>run<span class="w"> </span>tox

<span class="c1"># 個別タスクの実行</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span><span class="nb">test</span><span class="w">        </span><span class="c1"># テストのみ</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>lint<span class="w">        </span><span class="c1"># リンターのみ</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span><span class="nb">type</span><span class="w">        </span><span class="c1"># 型チェックのみ</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>coverage<span class="w">    </span><span class="c1"># カバレッジレポートのみ</span>
uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>format<span class="w">      </span><span class="c1"># フォーマットのみ</span>

<span class="c1"># 個別コマンドの実行</span>
uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w">            </span><span class="c1"># テスト実行</span>
uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>check<span class="w"> </span>.<span class="w">       </span><span class="c1"># リンター実行</span>
uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>format<span class="w"> </span>.<span class="w">      </span><span class="c1"># フォーマッター実行</span>
uv<span class="w"> </span>run<span class="w"> </span>mypy<span class="w"> </span>lib<span class="w"> </span><span class="nb">test</span><span class="w">      </span><span class="c1"># 型チェック実行</span>
</code></pre></div>
<h3 id="_19">構築した環境の特徴<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>uv</strong>: 高速な Python パッケージマネージャーと仮想環境管理</li>
<li><strong>Pyxel</strong>: レトロゲーム開発エンジン</li>
<li><strong>Ruff</strong>: 従来の flake8、pylint、black を置き換える統合リンター・フォーマッター</li>
<li><strong>mypy</strong>: 静的型チェックによる型安全性の確保</li>
<li><strong>pytest + pytest-cov</strong>: テスト実行とカバレッジ計測</li>
<li><strong>tox</strong>: 複数環境での品質チェックとタスク管理</li>
</ul>
<p>この環境により、次回の開発からは最初にコマンドラインで <code>uv run tox</code> を実行すれば良いコードを書くためのタスクを自動で実行してくれるようになるので、コードを書くことに集中できるようになりました。</p>
<h3 id="_20">コミット履歴<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>今回のセットアップ作業で作成されたコミット：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>init
git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: プロジェクト初期化とPyxel環境セットアップ&#39;</span>
</code></pre></div>
<p>では、次のイテレーションに進むとしましょう。</p>
<hr />
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション(反復)で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_21">ユーザーストーリー<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ゲームの初期化処理を実装する(ゲームの状態や必要なコンポーネントを設定する)</li>
<li>ゲーム画面を表示する(プレイヤーが視覚的にゲームを認識できるようにする)</li>
<li>新しいぷよを生成する(ゲーム開始時に最初のぷよを作成する)</li>
<li>ゲームループを開始する(ゲームの継続的な更新と描画を行う)</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ゲームの初期化処理」から始めましょう！</p>
<h3 id="_22">テスト: ゲームの初期化<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「ゲームの初期化処理を実装する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ゲームの初期化処理をテストするコードを書いてみましょう。何をテストすべきでしょうか？ゲームが初期化されたとき、必要なコンポーネントが正しく作成され、ゲームの状態が適切に設定されていることを確認する必要がありますね。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_game.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.game</span><span class="w"> </span><span class="kn">import</span> <span class="n">Game</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.stage</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.puyoimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuyoImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.player</span><span class="w"> </span><span class="kn">import</span> <span class="n">Player</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.score</span><span class="w"> </span><span class="kn">import</span> <span class="n">Score</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestGame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲームクラスのテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">game</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;各テストで使用するゲームインスタンス&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Game</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_ゲームを初期化すると_必要なコンポーネントが作成される</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">:</span> <span class="n">Game</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ゲームを初期化すると、必要なコンポーネントが作成される&quot;&quot;&quot;</span>
        <span class="n">game</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">Config</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">puyo_image</span><span class="p">,</span> <span class="n">PuyoImage</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span> <span class="n">Stage</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">player</span><span class="p">,</span> <span class="n">Player</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">Score</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_ゲームを初期化すると_ゲームモードがstartになる</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">:</span> <span class="n">Game</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ゲームを初期化すると、ゲームモードがstartになる&quot;&quot;&quot;</span>
        <span class="n">game</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span>
</code></pre></div>
<p>このテストでは、<code>Game</code>クラスの<code>initialize</code>メソッドが正しく動作することを確認しています。具体的には、必要なコンポーネント(Config, PuyoImage, Stage, Player, Score)が作成され、ゲームモードが'start'に設定されることを検証しています。</p>
<p><strong>TypeScript版との違い</strong>:
- <code>beforeEach</code> → pytest の <code>@pytest.fixture</code> に置き換え
- <code>describe</code> → Python のクラスベーステストに置き換え
- <code>it</code> → <code>test_</code> プレフィックスを持つメソッドに置き換え
- <code>expect(...).toBeInstanceOf(...)</code> → <code>isinstance(...)</code> 関数と <code>assert</code> に置き換え
- DOM操作 → PyxelにはDOM概念がないため削除
- キャメルケース → スネークケースに統一</p>
<h3 id="_23">実装: ゲームの初期化<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest
</code></pre></div>
<div class="highlight"><pre><span></span><code>ModuleNotFoundError: No module named &#39;lib.game&#39;
</code></pre></div>
<p>おっと！まだ<code>Game</code>クラスを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red(赤)」の状態です。テストが失敗することを確認できました。</p>
<blockquote>
<p>アサートファースト</p>
<p>ではテストはどこから書き始めるべきだろうか。それはテストの終わりにパスすべきアサーションを書くところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストが通るように最小限のコードを実装していきましょう。「最小限」というのがポイントです。この段階では、テストが通ることだけを目指して、必要最低限のコードを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/game.py</span>
<span class="sd">&quot;&quot;&quot;ゲームメインクラス&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.puyoimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuyoImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.stage</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.player</span><span class="w"> </span><span class="kn">import</span> <span class="n">Player</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.score</span><span class="w"> </span><span class="kn">import</span> <span class="n">Score</span>

<span class="n">GameMode</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;checkFall&quot;</span><span class="p">,</span> <span class="s2">&quot;fall&quot;</span><span class="p">,</span> <span class="s2">&quot;checkErase&quot;</span><span class="p">,</span> <span class="s2">&quot;erasing&quot;</span><span class="p">,</span> <span class="s2">&quot;newPuyo&quot;</span><span class="p">,</span> <span class="s2">&quot;playing&quot;</span><span class="p">,</span> <span class="s2">&quot;gameOver&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Game</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ぷよぷよゲームのメインクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ゲームの初期化&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span> <span class="n">GameMode</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;各コンポーネントの初期化&quot;&quot;&quot;</span>
        <span class="c1"># 各コンポーネントの初期化</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span> <span class="o">=</span> <span class="n">PuyoImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="n">Player</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">Score</span><span class="p">()</span>

        <span class="c1"># ゲームモードを設定</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span>
</code></pre></div>
<p><strong>TypeScript版からの主な変更</strong>:
- 型アノテーション: <code>GameMode</code> は <code>Literal</code> 型を使用
- プライベート変数: Python には真のプライベート変数がないため、<code>_</code> プレフィックスは使わず、パブリック属性として扱う
- コンストラクタ: <code>constructor()</code> → <code>__init__()</code>
- 型ヒント: すべての属性とメソッドに型ヒントを追加
- docstring: クラスとメソッドに説明を追加</p>
<h3 id="_24">解説: ゲームの初期化<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green(緑)」の状態です。</p>
<p>実装したゲームの初期化処理について、少し解説しておきましょう。この処理では、主に以下のことを行っています：</p>
<ol>
<li>各コンポーネント(Config, PuyoImage, Stage, Player, Score)のインスタンスを作成</li>
<li>ゲームモードを'start'に設定</li>
</ol>
<p>これにより、ゲームを開始するための準備が整います。各コンポーネントの役割を理解しておくと、今後の実装がスムーズになりますよ：</p>
<ul>
<li><strong>Config</strong>: ゲームの設定値を管理します(画面サイズ、ぷよの大きさなど)</li>
<li><strong>PuyoImage</strong>: ぷよの画像を管理します(各色のぷよの描画を担当)</li>
<li><strong>Stage</strong>: ゲームのステージ(盤面)を管理します(ぷよの配置状態、消去判定など)</li>
<li><strong>Player</strong>: プレイヤーの入力と操作を管理します(キーボード入力の処理、ぷよの移動など)</li>
<li><strong>Score</strong>: スコアの計算と表示を管理します(連鎖数に応じたスコア計算など)</li>
</ul>
<p>このように、責任を明確に分けることで、コードの保守性が高まります。これはオブジェクト指向設計の基本原則の一つ、「単一責任の原則」に従っています。</p>
<blockquote>
<p>単一責任の原則(SRP)：クラスを変更する理由は1つだけであるべき。</p>
<p>— Robert C. Martin 『Clean Architecture』</p>
</blockquote>
<h3 id="_25">テスト: ゲームループの開始<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>次に、ゲームループを開始するテストを書きます。Pyxelでは<code>pyxel.run()</code>メソッドがゲームループを管理しますが、この呼び出しを直接テストすると無限ループに入ってしまうため、モックを使用してテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_game.py (続き)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestGame</span><span class="p">:</span>
    <span class="c1"># ... 既存のテストメソッド ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_ゲームループを開始すると_pyxel_runが呼ばれる</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">:</span> <span class="n">Game</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ゲームループを開始すると、pyxel.runが呼ばれる&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;pyxel.run&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run</span><span class="p">:</span>
            <span class="n">game</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="c1"># pyxel.runが呼び出されたことを確認</span>
            <span class="n">mock_run</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
            <span class="c1"># updateとdrawメソッドが引数として渡されたことを確認</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">mock_run</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># update method</span>
            <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># draw method</span>
</code></pre></div>
<p>このテストでは、<code>Game</code>クラスの<code>run</code>メソッドが<code>pyxel.run()</code>を正しく呼び出すことを確認しています。</p>
<p><strong>TypeScript版との違い</strong>:
- <code>requestAnimationFrame</code>のモック → <code>pyxel.run()</code>のモック
- <code>window.requestAnimationFrame</code> → <code>pyxel.run()</code>
- モック実装: <code>vi.fn()</code> → <code>unittest.mock.patch()</code></p>
<h3 id="_26">実装: ゲームループの開始<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/game.py (続き)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxel</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Game</span><span class="p">:</span>
    <span class="c1"># ... 既存のコード ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ゲームループを開始&quot;&quot;&quot;</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ゲーム状態の更新(60FPSで呼ばれる)&quot;&quot;&quot;</span>
        <span class="c1"># 現時点では空実装</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;画面描画(60FPSで呼ばれる)&quot;&quot;&quot;</span>
        <span class="c1"># 現時点では空実装</span>
        <span class="k">pass</span>
</code></pre></div>
<p><strong>TypeScript版からの主な変更</strong>:
- <code>loop()</code> メソッド → <code>run()</code> メソッド
- <code>requestAnimationFrame(this.loop.bind(this))</code> → <code>pyxel.run(self.update, self.draw)</code>
- <code>bind(this)</code> 不要: Pythonでは<code>self</code>は自動的にメソッドにバインドされる
- 更新と描画を分離: Pyxelは<code>update</code>と<code>draw</code>を分けて管理</p>
<h3 id="_27">解説: ゲームループの開始<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>さて、今回実装した「ゲームループ」について少し詳しく解説しましょう。「ゲームループって何？」と思われるかもしれませんね。</p>
<p>ゲームループは、その名の通り、ゲームの状態を更新し、画面を描画するための繰り返し処理なんです。心臓がずっと鼓動を続けるように、このループが継続的に実行されることで、ゲームが生き生きと動き続けるんですよ。</p>
<p>ここで使っている<code>pyxel.run()</code>というメソッド、これがとても賢いんです！Pyxelは自動的に60FPSでゲームループを実行し、<code>update</code>メソッドと<code>draw</code>メソッドを順番に呼び出してくれます。</p>
<p><strong>Pyxelのゲームループの仕組み</strong>:</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────┐
│  pyxel.run(update, draw)            │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 1. update() を実行          │   │
│  │    - ゲーム状態を更新       │   │
│  │    - 入力処理               │   │
│  │    - 物理演算など           │   │
│  └─────────────────────────────┘   │
│           ↓                         │
│  ┌─────────────────────────────┐   │
│  │ 2. draw() を実行            │   │
│  │    - 画面クリア             │   │
│  │    - すべての描画           │   │
│  │    - 画面更新               │   │
│  └─────────────────────────────┘   │
│           ↓                         │
│  (60FPS で繰り返し)                │
└─────────────────────────────────────┘
</code></pre></div>
<p>TypeScript版の<code>requestAnimationFrame</code>とは異なり、Pyxelでは：</p>
<ol>
<li><strong>更新と描画の分離</strong>: <code>update</code>と<code>draw</code>を明確に分けることで、ロジックと描画を整理できます</li>
<li><strong>自動的な60FPS</strong>: フレームレート管理を気にする必要がありません</li>
<li><strong>シンプルなAPI</strong>: <code>bind(this)</code>のような複雑な仕組みは不要です</li>
</ol>
<p>このゲームループが基盤となって、これから様々な機能を追加していきますよ！</p>
<h3 id="_28">実装: エントリーポイント<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>最後に、ゲームを起動するエントリーポイント <code>main.py</code> を実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># main.py</span>
<span class="sd">&quot;&quot;&quot;ぷよぷよゲームのエントリーポイント&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.game</span><span class="w"> </span><span class="kn">import</span> <span class="n">Game</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;メイン関数&quot;&quot;&quot;</span>
    <span class="c1"># Pyxelウィンドウの初期化</span>
    <span class="n">pyxel</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ぷよぷよ TDD&quot;</span><span class="p">)</span>

    <span class="c1"># ゲームのインスタンスを作成</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">Game</span><span class="p">()</span>

    <span class="c1"># ゲームを初期化</span>
    <span class="n">game</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="c1"># ゲームループを開始</span>
    <span class="n">game</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>このコードでは、以下の手順でゲームを開始します：</p>
<ol>
<li><code>pyxel.init()</code> でPyxelウィンドウを初期化(160x120ピクセル)</li>
<li><code>Game</code> クラスのインスタンスを作成</li>
<li><code>initialize()</code> メソッドで各コンポーネントを初期化</li>
<li><code>run()</code> メソッドでゲームループを開始</li>
</ol>
<p><strong>TypeScript版との違い</strong>:
- <code>main.ts</code> → <code>main.py</code>
- モジュールインポート: ES6 import → Python import
- エントリーポイント: 即時実行 → <code>if __name__ == "__main__":</code> パターン
- Pyxel初期化: TypeScript版にはないPyxel固有の初期化処理</p>
<h3 id="_29">依存クラスの実装<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>必要な依存クラス(Config, PuyoImage, Stage, Player, Score)も最小限の実装を作成します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/config.py</span>
<span class="sd">&quot;&quot;&quot;ゲーム設定クラス&quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲームの設定値を管理するクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;設定値の初期化&quot;&quot;&quot;</span>
        <span class="c1"># 最小限の実装</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyoimage.py</span>
<span class="sd">&quot;&quot;&quot;ぷよ画像管理クラス&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PuyoImage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ぷよの画像を管理するクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        画像管理の初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            config: ゲーム設定</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 最小限の実装</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/stage.py</span>
<span class="sd">&quot;&quot;&quot;ゲームステージクラス&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.puyoimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuyoImage</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲームステージ(盤面)を管理するクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ステージの初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            config: ゲーム設定</span>
<span class="sd">            puyo_image: ぷよ画像管理</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 最小限の実装</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py</span>
<span class="sd">&quot;&quot;&quot;プレイヤークラス&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.stage</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.puyoimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuyoImage</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;プレイヤーの入力と操作を管理するクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        プレイヤーの初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            config: ゲーム設定</span>
<span class="sd">            stage: ゲームステージ</span>
<span class="sd">            puyo_image: ぷよ画像管理</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 最小限の実装</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/score.py</span>
<span class="sd">&quot;&quot;&quot;スコア管理クラス&quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Score</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;スコアの計算と管理を行うクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;スコアの初期化&quot;&quot;&quot;</span>
        <span class="c1"># 最小限の実装</span>
        <span class="k">pass</span>
</code></pre></div>
<p>これらのクラスは現時点では空の実装ですが、後続のイテレーションで徐々に機能を追加していきます。</p>
<p><strong>TypeScript版との違い</strong>:
- 型アノテーション: すべてのメソッドに型ヒントを追加
- docstring: 各クラスとメソッドに説明を追加
- 未使用引数: TypeScriptの <code>_config</code> → Pythonでは通常の引数名を使用(Ruffが未使用を検出)</p>
<h3 id="ruff_1">Ruff設定の調整<a class="headerlink" href="#ruff_1" title="Permanent link">&para;</a></h3>
<p>未使用の引数に関するRuffエラーを回避するため、<code>.ruff.toml</code>に以下の設定を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .ruff.toml</span>
<span class="k">[lint]</span>
<span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;F&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;I&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;B&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;C4&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;UP&quot;</span><span class="p">]</span>
<span class="n">ignore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ARG002&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1"># 未使用のメソッド引数を許可</span>

<span class="k">[lint.mccabe]</span>
<span class="n">max-complexity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span>
</code></pre></div>
<p>この設定により、コンストラクタなどで将来使う予定の引数が未使用でもエラーにならなくなります。</p>
<p><strong>TypeScript版との違い</strong>:
- ESLint設定 → Ruff設定
- <code>argsIgnorePattern: '^_'</code> → <code>ignore = ["ARG002"]</code></p>
<h3 id="_30">テストの確認<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下の結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code>================================ test session starts ================================
collected 3 items

test/test_game.py::TestGame::test_ゲームを初期化すると_必要なコンポーネントが作成される PASSED
test/test_game.py::TestGame::test_ゲームを初期化すると_ゲームモードがstartになる PASSED
test/test_game.py::TestGame::test_ゲームループを開始すると_pyxel_runが呼ばれる PASSED

================================ 3 passed in 0.12s ==================================
</code></pre></div>
<p>すべての品質チェックを実行：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>tox
</code></pre></div>
<h3 id="_31">画面の確認<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>ではここで実際に動作する画面を確認しましょう。</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>main.py
</code></pre></div>
<p>Pyxelウィンドウが開き、160x120ピクセルのゲーム画面が表示されます。現時点では空の黒い画面ですが、これがゲームの土台となります。</p>
<p>おめでとうございます！リリースに向けて最初の第一歩を踏み出すことができました。これから機能を追加するごとにどんどん実際のゲームの完成に近づく事が確認できます、楽しみですね。</p>
<p>「機能は別々に作りこんで最後に画面と統合するんじゃないの？」と思うもしれません。そういうアプローチもありますが画面イメージが最後まで確認できないともし間違っていたら手戻りが大変です。それに動作するプログラムがどんどん成長するのを見るのは楽しいですからね。</p>
<blockquote>
<p>トップダウンでもボトムアップでもなく、エンドツーエンドで構築していく</p>
<p>エンドツーエンドで小さな機能を構築し、そこから作業を進めながら問題について学習していく。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅(第2版)</p>
</blockquote>
<h3 id="1_1">イテレーション1のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>Game クラスの初期化</strong></li>
<li>必要なコンポーネント(Config, PuyoImage, Stage, Player, Score)の作成</li>
<li>
<p>ゲームモードの設定</p>
</li>
<li>
<p><strong>ゲームループの実装</strong></p>
</li>
<li><code>pyxel.run()</code> を使用した60FPSゲームループ</li>
<li>
<p><code>update()</code> と <code>draw()</code> メソッドの分離</p>
</li>
<li>
<p><strong>エントリーポイントの実装</strong></p>
</li>
<li><code>main.py</code> でPyxel初期化とゲーム起動</li>
<li>
<p>Pyxelウィンドウでの動作確認が可能に</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ゲーム初期化のテスト(2テスト)</li>
<li>ゲームループのテスト(1テスト)</li>
<li>すべてのテストが成功</li>
</ol>
<p><strong>TypeScript版からの主な変更点</strong>:
- Vitest → pytest
- requestAnimationFrame → pyxel.run()
- DOM操作 → Pyxel描画API(今後実装)
- ESLint → Ruff
- npm → uv
- class構文 → Pythonのclass構文(型ヒント付き)</p>
<p>次のイテレーションでは、ぷよの移動機能を実装していきます。</p>
<hr />
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームの基本的な構造ができましたね。「ゲームが始まったけど、ぷよが動かないと面白くないよね？」と思いませんか？そこで次は、ぷよを左右に移動できるようにしていきましょう！</p>
<h3 id="_32">ユーザーストーリー<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「ぷよぷよって、落ちてくるぷよを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「左右の移動」を実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。
「ぷよを左右に移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>プレイヤーの入力を検出する(キーボードの左右キーが押されたことを検知する)</li>
<li>ぷよを左右に移動する処理を実装する(実際にぷよの位置を変更する)</li>
<li>移動可能かどうかのチェックを実装する(画面の端や他のぷよにぶつかる場合は移動できないようにする)</li>
<li>移動後の表示を更新する(画面上でぷよの位置が変わったことを表示する)</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_33">テスト: プレイヤーの入力検出<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、プレイヤーの入力を検出する部分からテストしていきましょう。キーボードの左右キーが押されたときに、それを正しく検知できるかどうかをテストします。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_player.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.player</span><span class="w"> </span><span class="kn">import</span> <span class="n">Player</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.stage</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.puyoimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuyoImage</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestPlayer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;プレイヤークラスのテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テスト用のコンポーネントをセットアップ&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">puyo_image</span> <span class="o">=</span> <span class="n">PuyoImage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">)</span>
        <span class="n">player</span> <span class="o">=</span> <span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">player</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_左キーが押されると_左向きの移動フラグが立つ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;左キーが押されると、左向きの移動フラグが立つ&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># Pyxelのキー入力をシミュレート</span>
        <span class="c1"># 実際のPyxelではpyxel.btn()を使うが、テストではinput_key_leftを直接設定</span>
        <span class="n">player</span><span class="o">.</span><span class="n">input_key_left</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">input_key_left</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_右キーが押されると_右向きの移動フラグが立つ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;右キーが押されると、右向きの移動フラグが立つ&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="n">player</span><span class="o">.</span><span class="n">input_key_right</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">input_key_right</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_キー入力をクリアできる</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;キー入力フラグをクリアできる&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># まず左キーフラグを立てる</span>
        <span class="n">player</span><span class="o">.</span><span class="n">input_key_left</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">input_key_left</span> <span class="ow">is</span> <span class="kc">True</span>

        <span class="c1"># 次にクリア</span>
        <span class="n">player</span><span class="o">.</span><span class="n">input_key_left</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">input_key_left</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>
<p>「このテストは何をしているんですか？」このテストでは、キーボードの左右キーが押されたときと離されたときに、<code>Player</code>クラスの中の対応するフラグが正しく設定されるかどうかを確認しています。</p>
<p><strong>TypeScript版との違い</strong>:
- <code>KeyboardEvent</code>のシミュレート → Pyxelでは<code>pyxel.btn()</code>を使うが、テストではフラグを直接操作
- DOM操作不要 → Pyxelには DOM概念がない
- <code>document.dispatchEvent</code> → 不要(フラグの直接設定でテスト)</p>
<p>「テストを実行するとどうなるんでしょう？」まだ実装していないので、当然テストは失敗するはずです。これがテスト駆動開発の「Red(赤)」の状態です。では、テストが通るように実装していきましょう！</p>
<h3 id="_34">実装: プレイヤーの入力検出<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>「失敗するテストができたので、次は実装ですね！」そうです！テストが通るように、最小限のコードを実装していきましょう。</p>
<blockquote>
<p>仮実装を経て本実装へ</p>
<p>失敗するテストを書いてから、最初に行う実装はどのようなものだろうか - ベタ書きの値を返そう。
それでテストが通るようになったら、ベタ書きの値をだんだん本物の式や変数に置き換えていく。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py</span>
<span class="sd">&quot;&quot;&quot;プレイヤークラス&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.stage</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.puyoimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuyoImage</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;プレイヤーの入力と操作を管理するクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        プレイヤーの初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            config: ゲーム設定</span>
<span class="sd">            stage: ゲームステージ</span>
<span class="sd">            puyo_image: ぷよ画像管理</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span> <span class="o">=</span> <span class="n">puyo_image</span>

        <span class="c1"># キー入力フラグ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key_left</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key_right</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key_up</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key_down</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_input</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;キー入力状態を更新&quot;&quot;&quot;</span>
        <span class="c1"># Pyxelのキー入力をチェック</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key_left</span> <span class="o">=</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">btn</span><span class="p">(</span><span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key_right</span> <span class="o">=</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">btn</span><span class="p">(</span><span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_RIGHT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key_up</span> <span class="o">=</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">btn</span><span class="p">(</span><span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_UP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key_down</span> <span class="o">=</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">btn</span><span class="p">(</span><span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_DOWN</span><span class="p">)</span>
</code></pre></div>
<p>「なるほど！Pyxelの<code>pyxel.btn()</code>を使ってキーの状態をチェックしているんですね。」そうです！Pyxelでは、<code>pyxel.btn(pyxel.KEY_LEFT)</code>のようにキーの状態をチェックできます。キーが押されている間は<code>True</code>、押されていない間は<code>False</code>を返します。</p>
<p><strong>TypeScript版との大きな違い</strong>:</p>
<p>TypeScript版では:
<div class="highlight"><pre><span></span><code><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">onKeyDown</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">onKeyUp</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
</code></pre></div></p>
<p>Python/Pyxel版では:
<div class="highlight"><pre><span></span><code><span class="c1"># イベントリスナー不要！</span>
<span class="c1"># update_input()を毎フレーム呼ぶだけ</span>
<span class="bp">self</span><span class="o">.</span><span class="n">input_key_left</span> <span class="o">=</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">btn</span><span class="p">(</span><span class="n">pyxel</span><span class="o">.</span><span class="n">KEY_LEFT</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Pyxelの利点</strong>:
1. <strong>イベントリスナー不要</strong>: <code>addEventListener</code>のような複雑な仕組みが不要
2. <strong>bind不要</strong>: <code>this</code>のバインディング問題が存在しない
3. <strong>シンプル</strong>: <code>pyxel.btn()</code>を呼ぶだけで現在の状態を取得</p>
<p>「テストは通りましたか？」はい、これでテストは通るはずです！これがテスト駆動開発の「Green(緑)」の状態です。次は、ぷよを実際に移動させる機能をテストしていきましょう。</p>
<h3 id="_35">テスト: ぷよの移動<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>「次は何をテストしますか？」次は、ぷよを左右に移動する機能をテストしましょう。ぷよが左右に移動できるか、そして画面の端に到達したときに移動が制限されるかをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_player.py (続き)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestPlayer</span><span class="p">:</span>
    <span class="c1"># ... 既存のテストメソッド ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_左に移動できる場合_左に移動する</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;左に移動できる場合、左に移動する&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 初期位置を記録</span>
        <span class="n">initial_x</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span>

        <span class="c1"># 左に移動</span>
        <span class="n">player</span><span class="o">.</span><span class="n">move_left</span><span class="p">()</span>

        <span class="c1"># 位置が1つ左に移動していることを確認</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="n">initial_x</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_右に移動できる場合_右に移動する</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;右に移動できる場合、右に移動する&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 初期位置を記録</span>
        <span class="n">initial_x</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span>

        <span class="c1"># 右に移動</span>
        <span class="n">player</span><span class="o">.</span><span class="n">move_right</span><span class="p">()</span>

        <span class="c1"># 位置が1つ右に移動していることを確認</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="n">initial_x</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_左端にいる場合_左に移動できない</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;左端にいる場合、左に移動できない&quot;&quot;&quot;</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 左端に移動</span>
        <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># 左に移動を試みる</span>
        <span class="n">player</span><span class="o">.</span><span class="n">move_left</span><span class="p">()</span>

        <span class="c1"># 位置が変わっていないことを確認</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_右端にいる場合_右に移動できない</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;右端にいる場合、右に移動できない&quot;&quot;&quot;</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 右端に移動(ステージの幅 - 1)</span>
        <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># 右に移動を試みる</span>
        <span class="n">player</span><span class="o">.</span><span class="n">move_right</span><span class="p">()</span>

        <span class="c1"># 位置が変わっていないことを確認</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の4つのケースを確認しています：</p>
<ol>
<li>通常の状態で左に移動できるか</li>
<li>通常の状態で右に移動できるか</li>
<li>左端にいるときに左に移動しようとしても位置が変わらないか</li>
<li>右端にいるときに右に移動しようとしても位置が変わらないか</li>
</ol>
<p>「なるほど、画面の端を超えて移動できないようにするんですね！」そうです！ゲームの画面外にぷよが出てしまうと困りますからね。では、このテストが通るように実装していきましょう。</p>
<h3 id="_36">実装: ぷよの移動<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを移動させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py (続き)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="c1"># 定数定義</span>
    <span class="n">INITIAL_PUYO_X</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># ぷよの初期X座標(中央)</span>
    <span class="n">INITIAL_PUYO_Y</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># ぷよの初期Y座標(一番上)</span>
    <span class="n">MIN_PUYO_TYPE</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ぷよの種類の最小値</span>
    <span class="n">MAX_PUYO_TYPE</span> <span class="o">=</span> <span class="mi">4</span>   <span class="c1"># ぷよの種類の最大値</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ... 既存の初期化コード ...</span>

        <span class="c1"># ぷよの状態</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INITIAL_PUYO_X</span>  <span class="c1"># ぷよのX座標</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INITIAL_PUYO_Y</span>  <span class="c1"># ぷよのY座標</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>                 <span class="c1"># 現在のぷよの種類</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_puyo_type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># 次のぷよの種類</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>                  <span class="c1"># 現在の回転状態</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_new_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;新しいぷよを作成&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INITIAL_PUYO_X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INITIAL_PUYO_Y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_random_puyo_type</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_puyo_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_random_puyo_type</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_random_puyo_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ランダムなぷよの種類を生成&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MIN_PUYO_TYPE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_PUYO_TYPE</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">move_left</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;左に移動&quot;&quot;&quot;</span>
        <span class="c1"># 左端でなければ左に移動</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">move_right</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;右に移動&quot;&quot;&quot;</span>
        <span class="c1"># 右端でなければ右に移動</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
<p>「ぷよの位置や種類を管理するプロパティがたくさんありますね！」そうですね。ぷよの状態を管理するために、いくつかのプロパティを定義しています：</p>
<ul>
<li><code>puyo_x</code>と<code>puyo_y</code>：ぷよの位置(X座標とY座標)</li>
<li><code>puyo_type</code>と<code>next_puyo_type</code>：現在のぷよと次のぷよの種類</li>
<li><code>rotation</code>：ぷよの回転状態</li>
</ul>
<p>「移動の処理はシンプルですね！」そうですね。<code>move_left</code>メソッドでは左端(X座標が0)でなければX座標を1減らし、<code>move_right</code>メソッドでは右端(X座標がステージの幅-1)でなければX座標を1増やしています。これで、ぷよが画面の端を超えて移動することはなくなりました。</p>
<p><strong>TypeScript版との違い</strong>:
- <code>puyoX</code> → <code>puyo_x</code> (スネークケース)
- <code>Math.floor(Math.random() * 4) + 1</code> → <code>random.randint(1, 4)</code>
- private定数は大文字のクラス変数として定義</p>
<p>「これでテストは通りましたか？」はい、これでテストは通るはずです！これでぷよを左右に移動させる基本的な機能が実装できました。</p>
<p>「でも、まだ実際にキー入力に応じて移動する処理が実装されていませんよね？」鋭い指摘ですね！確かに、キーが押されたことを検知するフラグと、ぷよを移動させるメソッドはできましたが、それらを連携させる部分はまだ実装していません。これは画面表示と合わせて実装していきますね。</p>
<p>「なるほど、少しずつ機能を追加していくんですね！」そうです！テスト駆動開発では、小さな機能を一つずつ確実に実装していくことで、複雑なシステムを構築していきます。</p>
<h3 id="_37">実装: ぷよの画面表示<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>「テストは通ったけど、実際にぷよが動いているところを見たいですね！」そうですね！それでは、ぷよを画面に表示して、実際にキーボードで操作できるようにしましょう。</p>
<h4 id="config">Config クラスの拡張<a class="headerlink" href="#config" title="Permanent link">&para;</a></h4>
<p>まず、画面表示に必要な設定を Config クラスに追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/config.py</span>
<span class="sd">&quot;&quot;&quot;ゲーム設定クラス&quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲームの設定値を管理するクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;設定値の初期化&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>        <span class="c1"># ステージの列数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span>       <span class="c1"># ステージの行数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>        <span class="c1"># ぷよのサイズ(ピクセル)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_bg_color</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c1"># ステージの背景色(Pyxel色番号)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_border_color</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># ステージの枠線色</span>
</code></pre></div>
<p><strong>TypeScript版との違い</strong>:
- Canvas用のカラーコード(<code>'#2a2a2a'</code>) → Pyxelの16色パレット番号(<code>1</code>)
- <code>stageCols</code> → <code>stage_cols</code> (スネークケース)</p>
<h4 id="puyoimage">PuyoImage クラスの実装<a class="headerlink" href="#puyoimage" title="Permanent link">&para;</a></h4>
<p>次に、ぷよを描画するための PuyoImage クラスを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/puyoimage.py</span>
<span class="sd">&quot;&quot;&quot;ぷよ画像管理クラス&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PuyoImage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ぷよの画像を管理するクラス&quot;&quot;&quot;</span>

    <span class="c1"># Pyxel 16色パレットを使用</span>
    <span class="n">COLORS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">1</span><span class="p">,</span>   <span class="c1"># 0: 空 (ダークブルー)</span>
        <span class="mi">8</span><span class="p">,</span>   <span class="c1"># 1: 赤</span>
        <span class="mi">11</span><span class="p">,</span>  <span class="c1"># 2: 緑</span>
        <span class="mi">12</span><span class="p">,</span>  <span class="c1"># 3: 青</span>
        <span class="mi">10</span><span class="p">,</span>  <span class="c1"># 4: 黄色</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        画像管理の初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            config: ゲーム設定</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">puyo_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ぷよを描画</span>

<span class="sd">        Args:</span>
<span class="sd">            x: X座標(グリッド単位)</span>
<span class="sd">            y: Y座標(グリッド単位)</span>
<span class="sd">            puyo_type: ぷよの種類(0-4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">puyo_size</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLORS</span><span class="p">[</span><span class="n">puyo_type</span><span class="p">]</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">puyo_type</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COLORS</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLORS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 円の中心座標と半径を計算</span>
        <span class="n">center_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">size</span> <span class="o">+</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">center_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">size</span> <span class="o">+</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span>  <span class="c1"># 少し小さめにして余白を作る</span>

        <span class="c1"># ぷよを円形で描画</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">circ</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>

        <span class="c1"># 枠線を描画(黒)</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">circb</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>「ぷよを円形で描画しているんですね！」そうです！Pyxelの<code>pyxel.circ()</code>メソッドを使って、ぷよを円形で描画しています。</p>
<p><strong>TypeScript版との違い</strong>:
- <code>ctx.arc()</code> → <code>pyxel.circ()</code> (塗りつぶし円)
- <code>ctx.stroke()</code> → <code>pyxel.circb()</code> (円の枠線)
- RGB文字列(<code>'#ff0000'</code>) → Pyxelの16色パレット番号(<code>8</code>=赤)
- Canvas APIの複雑な描画コード → シンプルな1行の関数呼び出し</p>
<p><strong>Pyxelの描画の利点</strong>:
1. <strong>シンプル</strong>: <code>circ(x, y, r, col)</code> 一発で円を描画
2. <strong>軽量</strong>: Canvasのコンテキスト管理が不要
3. <strong>直感的</strong>: パレット番号で色を指定</p>
<h4 id="stage">Stage クラスの実装<a class="headerlink" href="#stage" title="Permanent link">&para;</a></h4>
<p>続いて、ゲームのステージを管理する Stage クラスを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/stage.py</span>
<span class="sd">&quot;&quot;&quot;ゲームステージクラス&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.puyoimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuyoImage</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲームステージ(盤面)を管理するクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ステージの初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            config: ゲーム設定</span>
<span class="sd">            puyo_image: ぷよ画像管理</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span> <span class="o">=</span> <span class="n">puyo_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_field</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_field</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;フィールドを初期化(全て0=空)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">):</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ステージとフィールドのぷよを描画&quot;&quot;&quot;</span>
        <span class="c1"># フィールドのぷよを描画</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">):</span>
                <span class="n">puyo_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">puyo_type</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">puyo_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">puyo_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定位置にぷよを描画</span>

<span class="sd">        Args:</span>
<span class="sd">            x: X座標</span>
<span class="sd">            y: Y座標</span>
<span class="sd">            puyo_type: ぷよの種類</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">puyo_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">puyo_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        フィールドにぷよを配置</span>

<span class="sd">        Args:</span>
<span class="sd">            x: X座標</span>
<span class="sd">            y: Y座標</span>
<span class="sd">            puyo_type: ぷよの種類</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">puyo_type</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        フィールドからぷよの種類を取得</span>

<span class="sd">        Args:</span>
<span class="sd">            x: X座標</span>
<span class="sd">            y: Y座標</span>

<span class="sd">        Returns:</span>
<span class="sd">            ぷよの種類(-1: 範囲外, 0: 空, 1-4: ぷよ)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 範囲外</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
</code></pre></div>
<p>「PyxelにはCanvasがないんですね！」そうです！Pyxelでは、<code>pyxel.init()</code>で初期化したウィンドウに直接描画します。Canvas要素の生成やDOM操作は一切不要です。</p>
<p><strong>TypeScript版との大きな違い</strong>:</p>
<p>TypeScript版:
<div class="highlight"><pre><span></span><code><span class="c1">// Canvas要素を作成</span>
<span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>
<span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">)</span>
<span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span>
</code></pre></div></p>
<p>Python/Pyxel版:
<div class="highlight"><pre><span></span><code><span class="c1"># Canvas不要！pyxel.init()で既に画面が用意されている</span>
<span class="c1"># 直接 pyxel.circ() などで描画するだけ</span>
</code></pre></div></p>
<p><strong>Pyxelの利点</strong>:
1. <strong>Canvas管理不要</strong>: DOM操作やCanvas生成が不要
2. <strong>ctxチェック不要</strong>: テスト環境でのnullチェックが不要
3. <strong>シンプル</strong>: Pyxelが画面管理を全て担当</p>
<h4 id="player">Player クラスの拡張<a class="headerlink" href="#player" title="Permanent link">&para;</a></h4>
<p>Player クラスに描画と更新のメソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py (追加部分)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="c1"># ... 既存のコード ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;現在のぷよを描画&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">draw_puyo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;キー入力に応じて移動&quot;&quot;&quot;</span>
        <span class="c1"># キー入力状態を更新</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_input</span><span class="p">()</span>

        <span class="c1"># キー入力に応じて移動</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key_left</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_left</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_key_left</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 移動後フラグをクリア</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key_right</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_right</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_key_right</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 移動後フラグをクリア</span>
</code></pre></div>
<p><strong>TypeScript版との違い</strong>:
- <code>update()</code>内で<code>update_input()</code>を呼ぶ(Pyxelでは毎フレームキー状態を更新)
- フラグのクリアは同じ(連続移動を防ぐため)</p>
<h4 id="game">Game クラスの更新<a class="headerlink" href="#game" title="Permanent link">&para;</a></h4>
<p>最後に、Game クラスのゲームループで描画と更新を行うようにします：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/game.py (更新部分)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Game</span><span class="p">:</span>
    <span class="c1"># ... 既存のコード ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;各コンポーネントの初期化&quot;&quot;&quot;</span>
        <span class="c1"># 各コンポーネントの初期化</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span> <span class="o">=</span> <span class="n">PuyoImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="n">Player</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">Score</span><span class="p">()</span>

        <span class="c1"># ゲームモードを設定</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;newPuyo&quot;</span>  <span class="c1"># &#39;start&#39; → &#39;newPuyo&#39; に変更</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ゲーム状態の更新(60FPSで呼ばれる)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># モードに応じた処理</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;newPuyo&quot;</span><span class="p">:</span>
            <span class="c1"># 新しいぷよを作成</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;playing&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;playing&quot;</span><span class="p">:</span>
            <span class="c1"># プレイ中の処理(キー入力に応じた移動)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;画面描画(60FPSで呼ばれる)&quot;&quot;&quot;</span>
        <span class="c1"># 画面クリア(背景色)</span>
        <span class="n">pyxel</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_bg_color</span><span class="p">)</span>

        <span class="c1"># ステージを描画</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="c1"># プレイヤーのぷよを描画</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;playing&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</code></pre></div>
<p><strong>TypeScript版との違い</strong>:
- <code>ctx.clearRect()</code> → <code>pyxel.cls(color)</code> (画面全体をクリア)
- Canvas操作 → Pyxel描画関数の直接呼び出し
- <code>requestAnimationFrame</code> → <code>pyxel.run(update, draw)</code> (イテレーション1で実装済み)</p>
<h4 id="_38">動作確認<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h4>
<p>「これで実際に動かせますね！」はい！Pyxelを起動して、ブラウザならぬPyxelウィンドウで確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>main.py
</code></pre></div>
<p>Pyxelウィンドウが開き、ステージが表示され、円形のぷよが表示されます。左右の矢印キーを押すと、ぷよが左右に移動します！</p>
<p>「動きました！」素晴らしい！これで、テストだけでなく実際の動作も確認できるようになりましたね。</p>
<p><strong>TypeScript版との体験の違い</strong>:
- ブラウザを開く → Pyxelウィンドウが直接起動
- <code>http://localhost:3000/</code> → ネイティブアプリケーション
- ブラウザの開発者ツール → Pyxel固有のデバッグ方法</p>
<h4 id="_39">テスト環境への対応<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<p>「PyxelでもテストとI実行環境の違いに対応が必要ですか？」良い質問ですね。Pyxelの場合、<code>pyxel.init()</code>を呼ばなければ描画機能は使えませんが、テストではそれを避けたいです。</p>
<p>幸い、今回の実装では：</p>
<ol>
<li><strong>Stage.draw()</strong>: フィールドの配列を走査して描画するだけ。<code>pyxel.init()</code>がなくても<code>pyxel.circ()</code>は呼べる(何も描画されないだけ)</li>
<li><strong>Player.update()</strong>: キー入力の更新と移動ロジック。描画は含まない</li>
<li><strong>テストの分離</strong>: テストでは描画メソッドを呼ばず、ロジックだけをテスト</li>
</ol>
<p>TypeScript版のような<code>ctx</code>のnullチェックは不要です！</p>
<p><strong>TypeScript版での対応</strong>:
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="c1">// テスト環境対応</span>
</code></pre></div></p>
<p><strong>Python/Pyxel版</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># 不要！pyxel.circ()はいつでも呼べる</span>
<span class="c1"># (pyxel.init()がなければ何も起きないだけ)</span>
</code></pre></div></p>
<h3 id="2_1">イテレーション2のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>Player クラスのキー入力検出機能</strong></li>
<li>4方向のキー入力フラグ(input_key_left, input_key_right, input_key_up, input_key_down)の実装</li>
<li>update_input()メソッド: pyxel.btn()によるキー状態取得</li>
<li>
<p>テスト: キー入力フラグの設定とクリア(3テスト)</p>
</li>
<li>
<p><strong>Player クラスのぷよ移動機能</strong></p>
</li>
<li>ぷよの状態管理(puyo_x, puyo_y, puyo_type, next_puyo_type, rotation)</li>
<li>create_new_puyo()メソッド: 新しいぷよを生成</li>
<li>move_left/move_right()メソッド: ぷよを左右に移動(境界チェック付き)</li>
<li>_get_random_puyo_type()メソッド: ランダムなぷよの種類を生成</li>
<li>マジックナンバーの定数化(INITIAL_PUYO_X, INITIAL_PUYO_Y, MIN_PUYO_TYPE, MAX_PUYO_TYPE)</li>
<li>
<p>テスト: ぷよの移動と境界チェック(4テスト)</p>
</li>
<li>
<p><strong>Config クラスの拡張</strong></p>
</li>
<li>stage_cols: ステージの列数(6)</li>
<li>stage_rows: ステージの行数(12)</li>
<li>puyo_size: ぷよのサイズ(32ピクセル)</li>
<li>stage_bg_color: ステージの背景色(Pyxel色番号)</li>
<li>
<p>stage_border_color: ステージの枠線色</p>
</li>
<li>
<p><strong>PuyoImage クラスの実装</strong></p>
</li>
<li>COLORS配列: ぷよの種類ごとの色定義(Pyxel 16色パレット)</li>
<li>draw()メソッド: pyxel.circ()/pyxel.circb()を使用した円形ぷよの描画</li>
<li>
<p>Canvas API不要のシンプルな実装</p>
</li>
<li>
<p><strong>Stage クラスの実装</strong></p>
</li>
<li>field配列: ステージ上のぷよ配置情報を管理</li>
<li>_initialize_field(): 初期化処理</li>
<li>draw()/draw_puyo(): ステージとぷよの描画</li>
<li>set_puyo()/get_puyo(): フィールドへのぷよの配置と取得</li>
<li>
<p>Canvas要素の生成・DOM操作が一切不要</p>
</li>
<li>
<p><strong>Player クラスの拡張</strong></p>
</li>
<li>draw()メソッド: プレイヤーが操作中のぷよを描画</li>
<li>
<p>update()メソッド: キー入力に応じてぷよを移動</p>
</li>
<li>
<p><strong>Game クラスの拡張</strong></p>
</li>
<li>update()メソッド: ゲーム状態の更新(newPuyo → playing の状態遷移)</li>
<li>draw()メソッド: pyxel.cls()で画面クリア、ステージとプレイヤーのぷよを描画</li>
<li>
<p>ゲームモードを'start'から'newPuyo'に変更</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>キー入力検出のテスト(3テスト)</li>
<li>ぷよの移動テスト(4テスト)</li>
<li>
<p>合計7テストすべて成功</p>
</li>
<li>
<p><strong>TDDサイクルの実践</strong></p>
</li>
<li>Red: 失敗するテストを先に作成</li>
<li>Green: テストを通す最小限の実装</li>
<li>
<p>Refactor: マジックナンバーの定数化、ランダム生成ロジックの抽出</p>
</li>
<li>
<p><strong>TypeScript版からの主な変更点</strong></p>
<ul>
<li><strong>キー入力</strong>: <code>addEventListener</code>/<code>bind(this)</code> → シンプルな<code>pyxel.btn()</code></li>
<li><strong>描画</strong>: Canvas API(<code>ctx.arc()</code>, <code>ctx.fill()</code>) → Pyxel描画関数(<code>pyxel.circ()</code>)</li>
<li><strong>画面管理</strong>: Canvas要素の生成・DOM操作 → <code>pyxel.init()</code>のみ</li>
<li><strong>色指定</strong>: RGB文字列(<code>'#ff0000'</code>) → Pyxelの16色パレット番号(<code>8</code>)</li>
<li><strong>テスト環境対応</strong>: ctxのnullチェック → 不要(pyxel描画関数はいつでも呼べる)</li>
<li><strong>命名規則</strong>: キャメルケース → スネークケース</li>
</ul>
</li>
<li>
<p><strong>Pyxelの利点を実感</strong></p>
<ul>
<li>イベントリスナー不要でシンプルなキー入力処理</li>
<li>Canvas管理不要で直感的な描画</li>
<li>DOM操作完全不要でWebの複雑さから解放</li>
<li>テスト環境と実行環境の違いが小さい</li>
</ul>
</li>
</ol>
<p>次のイテレーションでは、ぷよの回転機能を実装していきます。</p>
<hr />
<h2 id="3">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_40">ユーザーストーリー<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、この2つのぷよの相対的な位置関係を変えることです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを回転させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの回転処理を実装する(時計回り・反時計回りの回転)</li>
<li>回転可能かどうかのチェックを実装する(他のぷよや壁にぶつかる場合は回転できないようにする)</li>
<li>壁キック処理を実装する(壁際での回転を可能にする特殊処理)</li>
<li>回転後の表示を更新する(画面上でぷよの位置が変わったことを表示する)</li>
</ul>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_41">テスト: ぷよの回転<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは基本的な回転機能のテストから書いていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_player.py (続き)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestPlayer</span><span class="p">:</span>
    <span class="c1"># ... 既存のテストメソッド ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_時計回りに回転すると_回転状態が1増える</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;時計回りに回転すると、回転状態が1増える&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 初期回転状態を記録</span>
        <span class="n">initial_rotation</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span>

        <span class="c1"># 時計回りに回転</span>
        <span class="n">player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">()</span>

        <span class="c1"># 回転状態が1増えていることを確認</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="p">(</span><span class="n">initial_rotation</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_反時計回りに回転すると_回転状態が1減る</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;反時計回りに回転すると、回転状態が1減る&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 初期回転状態を記録</span>
        <span class="n">initial_rotation</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span>

        <span class="c1"># 反時計回りに回転</span>
        <span class="n">player</span><span class="o">.</span><span class="n">rotate_left</span><span class="p">()</span>

        <span class="c1"># 回転状態が1減っていることを確認(負の値にならないように調整)</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="p">(</span><span class="n">initial_rotation</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_回転状態が4になると0に戻る</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;回転状態が4になると0に戻る&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 回転状態を3に設定</span>
        <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># 時計回りに回転</span>
        <span class="n">player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">()</span>

        <span class="c1"># 回転状態が0になっていることを確認</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>時計回りに回転すると、回転状態が1増えるか</li>
<li>反時計回りに回転すると、回転状態が1減るか(ただし、負の値にならないように調整)</li>
<li>回転状態が最大値(3)から時計回りに回転すると、0に戻るか(循環するか)</li>
</ol>
<p>「回転状態って何ですか？」回転状態は、ぷよの向きを表す値です。0から3までの値を取り、それぞれ以下の状態を表します：
- 0: 2つ目のぷよが上にある状態
- 1: 2つ目のぷよが右にある状態
- 2: 2つ目のぷよが下にある状態
- 3: 2つ目のぷよが左にある状態</p>
<p>「なるほど、4方向の回転を表現するんですね！」そうです！では、このテストが通るように実装していきましょう。</p>
<h3 id="_42">実装: ぷよの回転<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを回転させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py (続き)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="c1"># ... 既存のコード ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rotate_right</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;時計回りに回転(0→1→2→3→0)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rotate_left</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;反時計回りに回転(0→3→2→1→0)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。回転処理自体はとてもシンプルです。<code>rotate_right</code>メソッドでは回転状態を1増やし、<code>rotate_left</code>メソッドでは回転状態を1減らしています(ただし、負の値にならないように3を足して4で割った余りを取っています)。</p>
<p>「なぜ反時計回りの場合は単純に1減らすのではなく、3を足して4で割るんですか？」鋭い質問ですね！Pythonでも、負の数の剰余演算の結果について注意が必要です。Pythonでは<code>-1 % 4</code>は<code>3</code>になりますが、明示的に正の値を保証するため、3を足して(これは1を引くのと同じ効果があります)から4で割ることで、確実に0から3の範囲内に収めているんです。</p>
<p><strong>TypeScript版との違い</strong>:
- <code>rotateRight()</code> → <code>rotate_right()</code> (スネークケース)
- ロジックは同じ</p>
<p>「テストは通りましたか？」はい、これでテストは通るはずです！これで基本的な回転機能が実装できました。しかし、まだ壁際での回転(壁キック)処理が実装されていませんね。次はそれをテストしていきましょう。</p>
<h3 id="_43">テスト: 壁キック処理<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>「壁キック処理のテストはどうやって書くんですか？」壁キック処理は、ぷよが壁際にあるときに回転すると自動的に位置を調整する機能です。これをテストするには、ぷよを壁際に配置し、回転させたときに適切に位置が調整されるかを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_player.py (続き)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestPlayer</span><span class="p">:</span>
    <span class="c1"># ... 既存のテストメソッド ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_右端で右回転すると_左に移動して回転する_壁キック</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;右端で右回転すると、左に移動して回転する(壁キック)&quot;&quot;&quot;</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 右端に移動</span>
        <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 上向き</span>

        <span class="c1"># 右回転(2つ目のぷよが右にくる)</span>
        <span class="n">player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">()</span>

        <span class="c1"># 壁キックにより左に移動していることを確認</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_左端で左回転すると_右に移動して回転する_壁キック</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;左端で左回転すると、右に移動して回転する(壁キック)&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="n">setup_components</span>

        <span class="c1"># 新しいぷよを作成</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># 左端に移動</span>
        <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 上向き</span>

        <span class="c1"># 左回転(2つ目のぷよが左にくる)</span>
        <span class="n">player</span><span class="o">.</span><span class="n">rotate_left</span><span class="p">()</span>

        <span class="c1"># 壁キックにより右に移動していることを確認</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>右端にいるときに時計回りに回転すると、左に1マス移動して回転するか</li>
<li>左端にいるときに反時計回りに回転すると、右に1マス移動して回転するか</li>
</ol>
<p>「なるほど、壁にめり込まないように自動的に位置を調整するんですね！」そうです！これがいわゆる「壁キック」と呼ばれる処理です。プレイヤーの操作性を向上させるための工夫なんですよ。では、このテストが通るように実装していきましょう。</p>
<h3 id="_44">実装: 壁キック処理<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、壁キック処理を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py (続き)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="c1"># ... 既存のコード ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rotate_right</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;時計回りに回転(0→1→2→3→0)&quot;&quot;&quot;</span>
        <span class="c1"># 時計回りに回転</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>

        <span class="c1"># 右端で右回転した場合(2つ目のぷよが右にくる場合)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># 左に移動(壁キック)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># 左端で左回転した場合(2つ目のぷよが左にくる場合)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 右に移動(壁キック)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rotate_left</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;反時計回りに回転(0→3→2→1→0)&quot;&quot;&quot;</span>
        <span class="c1"># 反時計回りに回転</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>

        <span class="c1"># 右端で右回転した場合(2つ目のぷよが右にくる場合)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># 左に移動(壁キック)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># 左端で左回転した場合(2つ目のぷよが左にくる場合)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 右に移動(壁キック)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
<p>「なるほど、回転後に壁にめり込む場合は位置を調整するんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li>まず通常の回転処理を行う</li>
<li>回転後、ぷよが壁にめり込む状況になっていないかチェックする</li>
<li>めり込む場合は、ぷよの位置を調整する(壁キック)</li>
</ol>
<p>「でも、<code>rotate_right</code>と<code>rotate_left</code>で同じ壁キック処理が重複していますね？」鋭い指摘です！確かに重複していますね。これはリファクタリングの良い候補です。共通の壁キック処理を抽出して、コードの重複を減らすことができるでしょう。しかし、今回はテストが通ることを優先して、リファクタリングは次のステップで行うことにしましょう。</p>
<p><strong>TypeScript版との違い</strong>:
- ロジックは同一
- メソッド名がスネークケース</p>
<p>「テストは通りましたか？」はい、これでテストは通るはずです！これでぷよを回転させる機能と、壁際での特殊処理(壁キック)が実装できました。</p>
<h3 id="_45">実装: 回転後の描画更新<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>「回転したけど、画面に反映されるんですか？」良い質問ですね！回転状態に応じて2つ目のぷよの位置を計算して描画する必要があります。Player クラスの draw メソッドを更新しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py (更新)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="c1"># ... 既存のコード ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;現在のぷよを描画&quot;&quot;&quot;</span>
        <span class="c1"># 現在のぷよ(軸ぷよ)を描画</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">draw_puyo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_type</span><span class="p">)</span>

        <span class="c1"># 2つ目のぷよの位置を回転状態に応じて計算</span>
        <span class="n">offset_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>  <span class="c1"># 回転状態ごとのX方向オフセット</span>
        <span class="n">offset_y</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>  <span class="c1"># 回転状態ごとのY方向オフセット</span>
        <span class="n">next_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">+</span> <span class="n">offset_x</span>
        <span class="n">next_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+</span> <span class="n">offset_y</span>

        <span class="c1"># 2つ目のぷよを描画</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">draw_puyo</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_puyo_type</span><span class="p">)</span>
</code></pre></div>
<p>「配列を使って回転状態からオフセットを計算しているんですね！」そうです！回転状態(0-3)をインデックスとして使うことで、効率的に2つ目のぷよの相対位置を計算できます。</p>
<p><strong>TypeScript版との違い</strong>:
- ロジックは同じ
- <code>nextPuyoType</code> → <code>next_puyo_type</code></p>
<h3 id="_46">実装: 回転キーの統合<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>最後に、Player クラスの update メソッドに回転処理を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py (更新)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="c1"># ... 既存のコード ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;キー入力に応じて移動・回転&quot;&quot;&quot;</span>
        <span class="c1"># キー入力状態を更新</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_input</span><span class="p">()</span>

        <span class="c1"># キー入力に応じて移動</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key_left</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_left</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_key_left</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 移動後フラグをクリア</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key_right</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_right</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_key_right</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 移動後フラグをクリア</span>

        <span class="c1"># キー入力に応じて回転</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key_up</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_key_up</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 回転後フラグをクリア</span>
</code></pre></div>
<p>これで、プレイヤーが上キーを押すとぷよが時計回りに回転するようになりました！</p>
<h3 id="3_1">イテレーション3のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの回転機能と壁際での特殊処理を実装しました。以下がイテレーション3で実施した内容のまとめです：</p>
<ol>
<li><strong>回転状態の管理</strong></li>
<li>rotation プロパティ: 0(上)、1(右)、2(下)、3(左) の 4 状態で管理</li>
<li>
<p>回転状態に応じた 2 つ目のぷよの位置計算(offset_x, offset_y 配列使用)</p>
</li>
<li>
<p><strong>回転メソッドの実装</strong></p>
</li>
<li>rotate_right()メソッド: 時計回りに回転(rotation を +1)</li>
<li>
<p>rotate_left()メソッド: 反時計回りに回転(rotation を +3、つまり -1 と同等)</p>
</li>
<li>
<p><strong>壁キック処理</strong></p>
</li>
<li>回転後に 2 つ目のぷよが壁外に出る場合、軸ぷよの位置を自動調整</li>
<li>左壁キック: rotation == 3 かつ puyo_x == 0 のとき puyo_x を +1</li>
<li>
<p>右壁キック: rotation == 1 かつ puyo_x == stage_cols - 1 のとき puyo_x を -1</p>
</li>
<li>
<p><strong>描画の更新</strong></p>
</li>
<li>draw()メソッドで回転状態に応じた 2 つ目のぷよの描画</li>
<li>
<p>配列インデックスによる効率的なオフセット計算</p>
</li>
<li>
<p><strong>キー入力の統合</strong></p>
</li>
<li>update()メソッドで上キー(input_key_up)による回転処理</li>
<li>
<p>回転後フラグをクリア</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>回転機能のテスト(3テスト)<ul>
<li>時計回りに回転すると回転状態が 1 増える</li>
<li>反時計回りに回転すると回転状態が 1 減る</li>
<li>回転状態が 4 になると 0 に戻る</li>
</ul>
</li>
<li>壁キック処理のテスト(2テスト)<ul>
<li>右端で右回転すると左にキックする</li>
<li>左端で左回転すると右にキックする</li>
</ul>
</li>
<li>
<p>合計 12 テスト(既存7 + 新規5)すべて成功</p>
</li>
<li>
<p><strong>TDDサイクルの実践</strong></p>
</li>
<li>Red: 回転・壁キックのテストを先に作成し失敗を確認</li>
<li>Green: 各機能を実装してテストを通過</li>
<li>
<p>Refactor: (今回は重複コードがあるが、次回のイテレーションで改善予定)</p>
</li>
<li>
<p><strong>TypeScript版からの主な変更点</strong></p>
</li>
<li>メソッド名: キャメルケース → スネークケース</li>
<li>ロジックは同じ(Python/Pyxelでも配列インデックスによるオフセット計算が有効)</li>
</ol>
<p><strong>注意</strong>: このイテレーションでは壁との境界チェックのみを実装しており、既存のぷよとの衝突判定はまだ実装されていません。そのため、回転や移動時に着地済みのぷよを上書きしてしまう問題があります。この問題は後のイテレーションで修正します。</p>
<p>このイテレーションにより、ぷよを自由に回転させながら左右に移動できるようになり、ぷよぷよの基本的な操作性が実現できました。</p>
<p>次のイテレーションでは、ぷよの自由落下機能を実装していきます。</p>
<hr />
<h2 id="4">イテレーション4: ぷよの自由落下の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよって自動で落ちていくよね？」そうですね！ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきます。今回は、その「自由落下」機能を実装していきましょう！</p>
<h3 id="_47">ユーザーストーリー<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとしてぷよを自由落下させることができる</p>
</blockquote>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを自由落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>落下タイマーの実装（一定時間ごとに落下処理を実行する仕組み）</li>
<li>自動落下処理の実装（タイマーが発火したときにぷよを1マス下に移動する）</li>
<li>落下可能判定の実装（下に移動できるかどうかをチェックする）</li>
<li>着地処理の実装（ぷよが着地したときの処理）</li>
<li>ゲームループとの統合（ゲームの更新処理に自由落下を組み込む）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_48">テスト: 落下タイマー<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、一定時間ごとに落下処理が実行される仕組みをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_player.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestFreeFall</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;自由落下のテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">player_with_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Player</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;新しいぷよを作成したPlayerを返す&quot;&quot;&quot;</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">player</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_puyo_falls_after_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;指定時間が経過すると、ぷよが1マス下に落ちる&quot;&quot;&quot;</span>
        <span class="c1"># 初期位置を記録</span>
        <span class="n">initial_y</span> <span class="o">=</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span>

        <span class="c1"># 落下間隔(1000ms = 1秒)</span>
        <span class="n">drop_interval</span> <span class="o">=</span> <span class="mi">1000</span>

        <span class="c1"># ゲームの更新処理を実行（落下間隔分）</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="n">drop_interval</span><span class="p">)</span>

        <span class="c1"># 位置が1つ下に移動していることを確認</span>
        <span class="k">assert</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">==</span> <span class="n">initial_y</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_puyo_does_not_fall_before_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;指定時間未満では、ぷよは落ちない&quot;&quot;&quot;</span>
        <span class="c1"># 初期位置を記録</span>
        <span class="n">initial_y</span> <span class="o">=</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span>

        <span class="c1"># 落下間隔</span>
        <span class="n">drop_interval</span> <span class="o">=</span> <span class="mi">1000</span>

        <span class="c1"># タイマーを半分だけ進める</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="n">drop_interval</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># 位置が変わっていないことを確認</span>
        <span class="k">assert</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">==</span> <span class="n">initial_y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_puyo_does_not_fall_at_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;下端に達した場合、それ以上落ちない&quot;&quot;&quot;</span>
        <span class="c1"># 下端の1つ上に配置</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 子ぷよが下</span>

        <span class="c1"># 落下処理を実行（2回で下端）</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

        <span class="c1"># 位置が下端にあることを確認（それ以上落ちない）</span>
        <span class="k">assert</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>
<p>「Pyxelではどうやって時間を扱うんですか？」Pyxelには <code>pyxel.frame_count</code> がありますが、ここではより柔軟に制御できるように、<code>deltaTime</code> を使った更新方式を採用します。これはTypeScript版と同じアプローチです。</p>
<p>「テストを書いたら、次は実装ですね！」その通りです。Red（失敗）→ Green（成功）→ Refactor（改善）のサイクルで進めていきましょう。</p>
<h3 id="_49">実装: 落下タイマー<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ... 既存のコード ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_timer</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># 落下タイマー（ミリ秒）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span>  <span class="c1"># 落下間隔（1秒）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">landed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 着地フラグ</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_with_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;時間経過に基づく更新処理&quot;&quot;&quot;</span>
        <span class="c1"># タイマーを進める</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_timer</span> <span class="o">+=</span> <span class="n">delta_time</span>

        <span class="c1"># 落下間隔を超えたら落下処理を実行</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_timer</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_interval</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_timer</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># タイマーをリセット</span>

        <span class="c1"># 既存のupdate処理も実行</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_drop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;重力を適用する（ぷよを1マス下に落とす）&quot;&quot;&quot;</span>
        <span class="c1"># 下に移動できるかチェック</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_move_down</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 着地した場合の処理</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fix_to_stage</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_can_move_down</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;下に移動できるかチェックする&quot;&quot;&quot;</span>
        <span class="c1"># 2つ目のぷよの位置を計算</span>
        <span class="n">offset_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
        <span class="n">offset_y</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
        <span class="n">next_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">+</span> <span class="n">offset_x</span>
        <span class="n">next_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+</span> <span class="n">offset_y</span>

        <span class="c1"># 2つ目のぷよが下にある場合（rotation=2）</span>
        <span class="k">if</span> <span class="n">offset_y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># 2つ目のぷよが下端を超えないかチェック</span>
            <span class="k">if</span> <span class="n">next_y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># 2つ目のぷよの下にぷよがあるかチェック</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 2つ目のぷよが下以外にある場合</span>
            <span class="c1"># 軸ぷよの下端チェック</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># 軸ぷよの下にぷよがあるかチェック</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># 2つ目のぷよが下端を超えないかチェック</span>
            <span class="k">if</span> <span class="n">next_y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># 2つ目のぷよの下にぷよがあるかチェック</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fix_to_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ステージに固定する&quot;&quot;&quot;</span>
        <span class="c1"># 軸ぷよをステージに固定</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_type</span><span class="p">)</span>

        <span class="c1"># 2つ目のぷよの位置を計算</span>
        <span class="n">offset_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
        <span class="n">offset_y</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
        <span class="n">next_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">+</span> <span class="n">offset_x</span>
        <span class="n">next_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+</span> <span class="n">offset_y</span>

        <span class="c1"># 2つ目のぷよをステージに固定</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_puyo_type</span><span class="p">)</span>

        <span class="c1"># 着地フラグを立てる</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">landed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_landed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;着地したかどうかを返す&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">landed</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_new_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;新しいぷよを作成&quot;&quot;&quot;</span>
        <span class="c1"># ... 既存のコード ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">landed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 着地フラグをリセット</span>
</code></pre></div>
<p>「タイマーを使って一定間隔で落下させるんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li><code>drop_timer</code> でタイマーを管理</li>
<li><code>update_with_delta()</code> メソッドで経過時間を加算</li>
<li>一定間隔（<code>drop_interval</code>）を超えたら <code>_drop()</code> を実行</li>
<li><code>_drop()</code> で下に移動できるかチェックし、移動または着地処理を実行</li>
</ol>
<h3 id="_50">テスト: 着地判定<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>「ぷよが着地したときの処理もテストしたいです！」いいですね！次は、ぷよが着地したときの振る舞いをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_player.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestLanding</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;着地判定のテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">player_with_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Player</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;新しいぷよを作成したPlayerを返す&quot;&quot;&quot;</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">player</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_puyo_lands_at_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ぷよが下端に着地したら固定される&quot;&quot;&quot;</span>
        <span class="c1"># ぷよを下端の1つ上に配置</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 子ぷよが下</span>

        <span class="c1"># 落下処理を実行</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

        <span class="c1"># 着地していることを確認</span>
        <span class="k">assert</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">has_landed</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_puyo_lands_on_another_puyo</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Config</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ぷよが他のぷよの上に着地したら固定される&quot;&quot;&quot;</span>
        <span class="c1"># ステージに既存のぷよを配置</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># ぷよを既存のぷよの2つ上に配置</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 子ぷよが下</span>

        <span class="c1"># 落下処理を実行</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

        <span class="c1"># 着地していることを確認</span>
        <span class="k">assert</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">has_landed</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_landing_flag_is_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ぷよが着地したら着地フラグが立つ&quot;&quot;&quot;</span>
        <span class="c1"># 下端に配置</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># 着地処理を実行</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">_fix_to_stage</span><span class="p">()</span>

        <span class="c1"># 着地フラグが立っていることを確認</span>
        <span class="k">assert</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">has_landed</span><span class="p">()</span>
</code></pre></div>
<h3 id="_51">テスト: 重力判定<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>「ステージに配置されたぷよにも重力が働くんですよね？」その通りです！着地したぷよの下のぷよが消えたりした場合、上のぷよは落下する必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_stage.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestGravity</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;重力判定のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_floating_puyo_falls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;個別のぷよに重力が作用する&quot;&quot;&quot;</span>
        <span class="c1"># Y=黄色(1) B=青色(2)</span>
        <span class="c1"># 位置 (3, 9), (3, 10), (3, 11) に黄色（下端から3段積み）</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 位置 (4, 2) に青色 (浮いている)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># 重力を適用</span>
        <span class="n">has_fallen</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">()</span>

        <span class="c1"># 青ぷよが1マス落ちていることを確認</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="c1"># 黄色ぷよは変わらない（下端に積み重なっているので動かない）</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="c1"># 落下があったことを確認</span>
        <span class="k">assert</span> <span class="n">has_fallen</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_no_gravity_when_no_floating_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;浮いているぷよがない場合、何も変化しない&quot;&quot;&quot;</span>
        <span class="c1"># 位置 (3, 11) に黄色（下端）</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 重力を適用</span>
        <span class="n">has_fallen</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">()</span>

        <span class="c1"># 変化なし</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="c1"># 落下がないことを確認</span>
        <span class="k">assert</span> <span class="n">has_fallen</span> <span class="ow">is</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_floating_puyos_fall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;複数の浮いているぷよに重力が作用する&quot;&quot;&quot;</span>
        <span class="c1"># 位置 (2, 2), (3, 2), (4, 2) に赤色 (浮いている)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 重力を適用</span>
        <span class="n">has_fallen</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">()</span>

        <span class="c1"># すべて1マス落ちている</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="c1"># 落下があったことを確認</span>
        <span class="k">assert</span> <span class="n">has_fallen</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>
<h3 id="stage_1">実装: 重力処理（Stageクラス）<a class="headerlink" href="#stage_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/stage.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_gravity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ステージ上のぷよに重力を適用（1マスずつ落とす）</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: 落下したぷよがあれば True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># フィールドのコピーを作成（移動前の状態を保存）</span>
        <span class="n">original_field</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>

        <span class="n">has_fallen</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># 下から上に向かって各列をスキャン（列ごとに処理）</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">original_field</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">color</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># 元のフィールドで下に空きがあるかチェック</span>
                    <span class="k">if</span> <span class="n">original_field</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># 1マス下に移動</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">has_fallen</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">has_fallen</span>
</code></pre></div>
<p>「リストの <code>[:]</code> を使うとコピーができるんですね！」そうです！ただし、2次元リストの場合は各行もコピーする必要があるので、リスト内包表記を使っています。</p>
<h3 id="_52">ゲームループとの統合<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>「実際のゲームではどうやって使うんですか？」Gameクラスで時間管理とモード遷移を行います。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/game.py（続き）</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="n">GameMode</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
    <span class="s2">&quot;start&quot;</span><span class="p">,</span>
    <span class="s2">&quot;checkFall&quot;</span><span class="p">,</span>
    <span class="s2">&quot;falling&quot;</span><span class="p">,</span>
    <span class="s2">&quot;checkErase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;erasing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;newPuyo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;playing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gameOver&quot;</span>
<span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Game</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ... 既存のコード ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span> <span class="n">GameMode</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pyxelの更新関数（60FPS）&quot;&quot;&quot;</span>
        <span class="c1"># 経過時間を計算（ミリ秒）</span>
        <span class="c1"># Pyxelは60FPSなので、1フレーム = 1000/60 ≈ 16.67ms</span>
        <span class="n">delta_time</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="mf">60.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># モードに応じた処理</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;newPuyo&quot;</span><span class="p">:</span>
            <span class="c1"># 新しいぷよを作成</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;playing&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;playing&quot;</span><span class="p">:</span>
            <span class="c1"># プレイ中の処理（キー入力と自由落下）</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="n">delta_time</span><span class="p">)</span>

            <span class="c1"># 着地したら重力チェックに移行</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">has_landed</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkFall&quot;</span><span class="p">:</span>
            <span class="c1"># 重力を適用</span>
            <span class="n">has_fallen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">has_fallen</span><span class="p">:</span>
                <span class="c1"># ぷよが落下した場合、fallingモードへ</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;falling&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 落下するぷよがない場合、次のぷよを出す</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;newPuyo&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;falling&quot;</span><span class="p">:</span>
            <span class="c1"># 落下アニメーション用（一定フレーム待機）</span>
            <span class="c1"># 簡略化のため、すぐにcheckFallに戻る</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>
</code></pre></div>
<p>「Pyxelは60FPSで動くから、1フレームあたり約16.67ミリ秒なんですね！」その通りです。Pyxelでは <code>pyxel.run()</code> が内部で60FPSのループを管理してくれます。</p>
<h3 id="4_1">イテレーション4のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの自由落下と着地処理、重力判定を実装しました。以下がイテレーション4で実施した内容のまとめです：</p>
<ol>
<li><strong>自由落下機能</strong></li>
<li><code>drop_timer</code> と <code>drop_interval</code> でタイミング管理</li>
<li><code>update_with_delta()</code> メソッドで時間経過に応じた落下処理</li>
<li>
<p>1秒間隔（1000ms）で1マスずつ落下</p>
</li>
<li>
<p><strong>着地判定</strong></p>
</li>
<li><code>_can_move_down()</code> メソッド: 下に移動できるかチェック</li>
<li>下端チェック: <code>puyo_y &gt;= stage_rows - 1</code></li>
<li>軸ぷよの下にぷよがあるかチェック</li>
<li>
<p>2つ目のぷよの下にぷよがあるかチェック</p>
</li>
<li>
<p><strong>ステージへの固定</strong></p>
</li>
<li><code>_fix_to_stage()</code> メソッド: 着地したぷよをステージに配置</li>
<li>軸ぷよと2つ目のぷよを両方固定</li>
<li>
<p>着地フラグ（<code>landed</code>）を立てる</p>
</li>
<li>
<p><strong>着地フラグの管理</strong></p>
</li>
<li><code>landed</code> プロパティで着地状態を管理</li>
<li><code>has_landed()</code> メソッドで外部から着地状態を確認</li>
<li>
<p><code>create_new_puyo()</code> で着地フラグをリセット</p>
</li>
<li>
<p><strong>次のぷよ生成</strong></p>
</li>
<li>Gameクラスで着地を検知</li>
<li><code>checkFall</code> モードで重力を適用</li>
<li>
<p>重力適用後、次のぷよを出現</p>
</li>
<li>
<p><strong>重力処理（Stageクラス）</strong></p>
</li>
<li><code>apply_gravity()</code> メソッド: ステージ上のぷよに重力を適用</li>
<li>フィールドのコピーを作成して移動前の状態を保存</li>
<li>下から上に向かって各列をスキャン</li>
<li>1マスずつ落下（一度の呼び出しで1マス）</li>
<li>
<p>落下したぷよがあれば <code>True</code> を返す</p>
</li>
<li>
<p><strong>ゲームフロー</strong></p>
</li>
<li>newPuyo → playing → (着地) → checkFall → falling → checkFall → ... → newPuyo</li>
<li>checkFall: 重力を適用して落下するぷよがあるかチェック</li>
<li>
<p>falling: 落下アニメーション（簡略化のため即座にcheckFallに戻る）</p>
</li>
<li>
<p><strong>Pyxelでの時間管理</strong></p>
</li>
<li>Pyxelは60FPS固定</li>
<li>1フレーム = 1000/60 ≈ 16.67ミリ秒</li>
<li><code>update()</code> 内で <code>delta_time</code> を計算</li>
<li>
<p>TypeScript版の <code>requestAnimationFrame</code> の <code>currentTime</code> 引数と同等の仕組み</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>自由落下のテスト(3テスト)<ul>
<li>指定時間が経過すると、ぷよが1マス下に落ちる</li>
<li>指定時間未満では、ぷよは落ちない</li>
<li>下端に達した場合、それ以上落ちない</li>
</ul>
</li>
<li>着地のテスト(3テスト)<ul>
<li>ぷよが下端に着地したら固定される</li>
<li>ぷよが他のぷよの上に着地したら固定される</li>
<li>ぷよが着地したら着地フラグが立つ</li>
</ul>
</li>
<li>重力判定のテスト(3テスト)<ul>
<li>個別のぷよに重力が作用する</li>
<li>浮いているぷよがない場合、何も変化しない</li>
<li>複数の浮いているぷよに重力が作用する</li>
</ul>
</li>
<li>Gameクラスのテスト(1テスト)<ul>
<li>ぷよが着地したら次のぷよが出る</li>
</ul>
</li>
<li>
<p>合計 22 テスト(既存12 + 新規10)すべて成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>deltaTime による時間ベースの更新</li>
<li>Pyxelの60FPS固定ループの活用</li>
<li>着地判定の複合的なチェック（下端、軸ぷよ、2つ目のぷよ）</li>
<li>ゲームモードによる状態遷移</li>
<li>フィールドコピーによる安全な重力適用</li>
</ul>
</li>
<li>
<p><strong>TypeScript版からの主な変更点</strong></p>
<ul>
<li><code>requestAnimationFrame</code> の <code>currentTime</code> → 固定60FPSでの <code>delta_time</code> 計算</li>
<li>配列コピー: <code>field.map(row =&gt; [...row])</code> → <code>[row[:] for row in field]</code></li>
<li>プライベートメソッド: <code>private</code> キーワード → <code>_</code> プレフィックス</li>
</ul>
</li>
</ol>
<p>このイテレーションにより、ぷよが自動的に落下し、着地後に次のぷよが出現するようになり、ぷよぷよの基本的なゲームループが完成しました。</p>
<hr />
<h2 id="5">イテレーション5: ぷよの高速落下の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよってもっと早く落とせたよね？」そうですね！ぷよぷよでは、プレイヤーが下キーを押すことで、ぷよを素早く落下させることができます。今回は、その「高速落下」機能を実装していきましょう！</p>
<h3 id="_53">ユーザーストーリー<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよを素早く落下させることができる</p>
</blockquote>
<p>「早く次のぷよを落としたい！」というときに、下キーを押して素早く落下させる機能は、ゲームのテンポを良くするために重要ですね。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを素早く落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>下キー入力の検出を実装する（キーボードの下キーが押されたことを検知する）</li>
<li>高速落下処理を実装する（下キーが押されているときは落下速度を上げる）</li>
<li>落下可能かどうかのチェックを実装する（下に障害物がある場合は落下できないようにする）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_54">テスト: 高速落下<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、下キーが押されたときに落下速度が上がることと、ぷよが下に移動できるかどうかをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_player.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestFastDrop</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;高速落下のテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">player_with_puyo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Player</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;新しいぷよを作成したPlayerを返す&quot;&quot;&quot;</span>
        <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">player</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_drop_speed_increases_when_down_key_pressed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;下キーが押されていると、落下速度が上がる&quot;&quot;&quot;</span>
        <span class="c1"># 通常の落下速度</span>
        <span class="n">normal_drop_speed</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># 下キーを押す</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">input_key_down</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># 高速落下の速度を取得</span>
        <span class="n">fast_drop_speed</span> <span class="o">=</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">get_drop_speed</span><span class="p">()</span>

        <span class="c1"># 高速落下の速度が通常より速いことを確認</span>
        <span class="k">assert</span> <span class="n">fast_drop_speed</span> <span class="o">&gt;</span> <span class="n">normal_drop_speed</span>
        <span class="k">assert</span> <span class="n">fast_drop_speed</span> <span class="o">==</span> <span class="mi">10</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_puyo_moves_down_when_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;下に移動できる場合、下に移動する&quot;&quot;&quot;</span>
        <span class="c1"># 初期位置を記録</span>
        <span class="n">initial_y</span> <span class="o">=</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span>

        <span class="c1"># 下に移動</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">move_down</span><span class="p">()</span>

        <span class="c1"># 移動成功</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="c1"># 位置が1つ下に移動していることを確認</span>
        <span class="k">assert</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">==</span> <span class="n">initial_y</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_puyo_cannot_move_down_at_bottom</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">player_with_puyo</span><span class="p">:</span> <span class="n">Player</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Config</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;下に障害物がある場合、下に移動できない&quot;&quot;&quot;</span>
        <span class="c1"># ステージの一番下に移動</span>
        <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># 下に移動を試みる</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">move_down</span><span class="p">()</span>

        <span class="c1"># 移動できないことを確認</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">player_with_puyo</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>
<p>「Pyxelでは下キーの検出が簡単ですよね？」その通りです！Pyxelでは <code>pyxel.btn(pyxel.KEY_DOWN)</code> で下キーの状態を取得できます。イテレーション2で実装した <code>update_input()</code> メソッドが既に下キーの状態を <code>input_key_down</code> に保存しています。</p>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>下キーが押されていると、落下速度が通常より速くなるか</li>
<li>通常の状態で下に移動できるか</li>
<li>ステージの一番下にいるときに下に移動しようとしても移動できないか</li>
</ol>
<p>「なるほど、ゲームの端を超えて移動できないようにするんですね！」そうです！ゲームの画面外にぷよが出てしまうと困りますからね。では、このテストが通るように実装していきましょう。</p>
<h3 id="_55">実装: 高速落下<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、高速落下の機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_drop_speed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;落下速度を取得</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: 下キーが押されていれば10、そうでなければ1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 下キーが押されていれば高速落下</span>
        <span class="k">return</span> <span class="mf">10.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key_down</span> <span class="k">else</span> <span class="mf">1.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">move_down</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;下に移動</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: 移動できた場合True、できなかった場合False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 下に移動できるかチェック</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_move_down</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。高速落下の処理自体はとてもシンプルです。<code>get_drop_speed()</code> メソッドでは、下キーが押されているかどうかを確認し、押されていれば通常の10倍の速度で落下するようにしています。また、<code>move_down()</code> メソッドでは、ぷよがステージの下端に到達していなければ下に移動できるようにしています。</p>
<p>「なぜ <code>move_down()</code> メソッドは <code>bool</code> を返すんですか？」良い質問ですね！<code>move_down()</code> メソッドは、ぷよが実際に下に移動できたかどうかを返します。これは、ぷよが着地したかどうかを判定するために使われます。ぷよが下に移動できなかった場合（<code>False</code> が返された場合）、それはぷよが着地したことを意味します。</p>
<p>「これでテストは通りましたか？」はい、これでテストは通るはずです！これでぷよを素早く落下させる基本的な機能が実装できました。プレイヤーがキーボードの下キーを押すと、ぷよが素早く落下し、ステージの下端や他のぷよに衝突すると停止するようになりました。</p>
<p>「でも、まだ実際にキー入力に応じて落下速度が変わる処理が実装されていませんよね？」鋭い指摘ですね！確かに、キーが押されたことを検知するフラグと、落下速度を変更するメソッドはできましたが、それらを連携させる部分はまだ実装していません。</p>
<h3 id="_56">実装: ゲームループとの統合<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>ゲームループで高速落下の速度を反映するように <code>update_with_delta()</code> メソッドを修正します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/player.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_with_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;時間経過に基づく更新処理&quot;&quot;&quot;</span>
        <span class="c1"># タイマーを進める（高速落下の速度を反映）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_timer</span> <span class="o">+=</span> <span class="n">delta_time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_drop_speed</span><span class="p">()</span>

        <span class="c1"># 落下間隔を超えたら落下処理を実行</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_timer</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_interval</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_timer</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># タイマーをリセット</span>

        <span class="c1"># 既存のupdate処理も実行</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</code></pre></div>
<p>「なるほど！<code>delta_time</code> に <code>get_drop_speed()</code> を掛けることで、下キーが押されているときはタイマーが10倍速く進むんですね！」その通りです！これで下キーを押している間は通常の10倍の速さでぷよが落下するようになりました。</p>
<h3 id="5_1">イテレーション5のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの高速落下機能を実装しました。以下がイテレーション5で実施した内容のまとめです：</p>
<ol>
<li><strong>高速落下機能</strong></li>
<li><code>get_drop_speed()</code> メソッド：下キーが押されているかチェック</li>
<li>押されていれば通常の10倍の速度（10）を返す</li>
<li>
<p>押されていなければ通常速度（1）を返す</p>
</li>
<li>
<p><strong>move_down メソッド</strong></p>
</li>
<li>下に移動できるかチェック</li>
<li>移動できれば <code>puyo_y</code> を1増やして <code>True</code> を返す</li>
<li>移動できなければ <code>False</code> を返す</li>
<li>
<p><code>_can_move_down()</code> を使って安全に移動判定</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong></p>
</li>
<li><code>update_with_delta()</code> メソッドを修正</li>
<li><code>drop_timer</code> に <code>delta_time * get_drop_speed()</code> を加算</li>
<li>
<p>高速落下時はタイマーが10倍速く進む</p>
</li>
<li>
<p><strong>Pyxelでのキー入力</strong></p>
</li>
<li>既存の <code>update_input()</code> メソッドで下キーの状態を管理</li>
<li><code>pyxel.btn(pyxel.KEY_DOWN)</code> で下キーの状態を取得</li>
<li>
<p>TypeScript版の <code>addEventListener</code> より簡潔</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>高速落下のテスト(3テスト)<ul>
<li>下キーが押されていると、落下速度が上がる</li>
<li>下に移動できる場合、下に移動する</li>
<li>下に障害物がある場合、下に移動できない</li>
</ul>
</li>
<li>
<p>合計 25 テスト(既存22 + 新規3)すべて成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>速度倍率による時間制御</li>
<li>boolean 返り値による移動成功判定</li>
<li>既存の <code>_can_move_down()</code> メソッドの再利用</li>
</ol>
<p>このイテレーションにより、プレイヤーが下キーを押すことでぷよを素早く落下させることができるようになり、ゲームのテンポが向上しました。今回は「ぷよを素早く落下させる」という基本機能を実装しました。次のイテレーションでは、「ぷよを消去する」機能を実装していきましょう！</p>
<hr />
<h2 id="6">イテレーション6: ぷよの消去の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを4つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_57">ユーザーストーリー<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを4つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。これを実装することで、ゲームとしての面白さが大きく向上しますね。</p>
<h3 id="todo_5">TODOリスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li>4つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li>ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li>ゲームループとの統合（ゲームの更新処理に消去処理を組み込む）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_58">テスト: ぷよの接続判定<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが4つ以上つながっているかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_stage.py（新規作成または追加）</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.puyoimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PuyoImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.stage</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stage</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestStageErase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ぷよの消去テスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stageインスタンスを返す&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_four_connected_puyos_are_erasable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;同じ色のぷよが4つつながっていると、消去対象になる&quot;&quot;&quot;</span>
        <span class="c1"># ステージにぷよを配置（1は赤ぷよ）</span>
        <span class="c1"># 2×2の正方形に赤ぷよを配置</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 消去判定</span>
        <span class="n">erase_info</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>

        <span class="c1"># 4つのぷよが消去対象になっていることを確認</span>
        <span class="k">assert</span> <span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_different_color_puyos_are_not_erasable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;異なる色のぷよは消去対象にならない&quot;&quot;&quot;</span>
        <span class="c1"># ステージにぷよを配置（1は赤ぷよ、2は青ぷよ）</span>
        <span class="c1"># 市松模様に配置</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 消去判定</span>
        <span class="n">erase_info</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>

        <span class="c1"># 消去対象がないことを確認</span>
        <span class="k">assert</span> <span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_three_connected_puyos_are_not_erasable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;3つ以下のつながりは消去対象にならない&quot;&quot;&quot;</span>
        <span class="c1"># ステージにぷよを配置（1は赤ぷよ）</span>
        <span class="c1"># L字型に3つ配置</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 消去判定</span>
        <span class="n">erase_info</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>

        <span class="c1"># 消去対象がないことを確認</span>
        <span class="k">assert</span> <span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>同じ色のぷよが4つつながっている場合、それらが消去対象になるか</li>
<li>異なる色のぷよが隣接している場合、それらは消去対象にならないか</li>
<li>3つ以下のぷよは消去対象にならないか</li>
</ol>
<p>「ステージにぷよを配置しているのはわかりますが、視覚的に確認できますか？」良い質問ですね！最初のテストでは2×2の正方形に赤ぷよを配置し、2つ目のテストでは市松模様に赤と青のぷよを配置しています。では、このテストが通るように実装していきましょう。</p>
<h3 id="_59">実装: 型定義と接続判定<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、まず型定義とぷよの接続判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/stage.py（続き）</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ErasePosition</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;消去位置情報&quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EraseInfo</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;消去情報&quot;&quot;&quot;</span>
    <span class="n">erase_puyo_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">erase_info</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ErasePosition</span><span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">:</span>
    <span class="c1"># ... 既存のコード ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_erase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EraseInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;消去判定を行う</span>

<span class="sd">        Returns:</span>
<span class="sd">            EraseInfo: 消去情報</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 消去情報</span>
        <span class="n">erase_info</span><span class="p">:</span> <span class="n">EraseInfo</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;erase_info&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="c1"># 一時的なチェック用ボード</span>
        <span class="n">checked</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 全マスをチェック</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">):</span>
                <span class="c1"># ぷよがあり、まだチェックしていない場合</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">checked</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span>
                    <span class="c1"># 接続しているぷよを探索</span>
                    <span class="n">puyo_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                    <span class="n">connected</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_search_connected_puyo</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">puyo_type</span><span class="p">,</span> <span class="n">checked</span><span class="p">,</span> <span class="n">connected</span>
                    <span class="p">)</span>

                    <span class="c1"># 4つ以上つながっている場合は消去対象</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">puyo_x</span><span class="p">,</span> <span class="n">puyo_y</span> <span class="ow">in</span> <span class="n">connected</span><span class="p">:</span>
                            <span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">puyo_x</span><span class="p">,</span>
                                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">puyo_y</span><span class="p">,</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">puyo_type</span>
                            <span class="p">})</span>
                        <span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">erase_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_search_connected_puyo</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">start_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">puyo_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">checked</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]],</span>
        <span class="n">connected</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;接続しているぷよを探索（深さ優先探索）</span>

<span class="sd">        Args:</span>
<span class="sd">            start_x: 探索開始X座標</span>
<span class="sd">            start_y: 探索開始Y座標</span>
<span class="sd">            puyo_type: 探索するぷよの種類</span>
<span class="sd">            checked: チェック済みフラグの2次元配列</span>
<span class="sd">            connected: 接続しているぷよの座標リスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 探索済みにする</span>
        <span class="n">checked</span><span class="p">[</span><span class="n">start_y</span><span class="p">][</span><span class="n">start_x</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">connected</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_x</span><span class="p">,</span> <span class="n">start_y</span><span class="p">))</span>

        <span class="c1"># 4方向を探索</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>   <span class="c1"># 右</span>
            <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># 左</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>   <span class="c1"># 下</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># 上</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">directions</span><span class="p">:</span>
            <span class="n">next_x</span> <span class="o">=</span> <span class="n">start_x</span> <span class="o">+</span> <span class="n">dx</span>
            <span class="n">next_y</span> <span class="o">=</span> <span class="n">start_y</span> <span class="o">+</span> <span class="n">dy</span>

            <span class="c1"># ボード内かつ同じ色のぷよがあり、まだチェックしていない場合</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">next_x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="ow">and</span>
                <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">next_y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">next_y</span><span class="p">][</span><span class="n">next_x</span><span class="p">]</span> <span class="o">==</span> <span class="n">puyo_type</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">checked</span><span class="p">[</span><span class="n">next_y</span><span class="p">][</span><span class="n">next_x</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># 再帰的に探索</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_search_connected_puyo</span><span class="p">(</span>
                    <span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">,</span> <span class="n">puyo_type</span><span class="p">,</span> <span class="n">checked</span><span class="p">,</span> <span class="n">connected</span>
                <span class="p">)</span>
</code></pre></div>
<h3 id="_60">解説: ぷよの接続判定<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>ぷよの接続判定では、以下のことを行っています。</p>
<ol>
<li>ボード上の全マスを順番にチェック</li>
<li>まだチェックしていないぷよがある場合、そのぷよと同じ色で接続しているぷよを探索</li>
<li>接続しているぷよが4つ以上ある場合、それらを消去対象として記録</li>
</ol>
<p>接続しているぷよの探索には<a href="https://ja.wikipedia.org/wiki/%E6%B7%B1%E3%81%95%E5%84%AA%E5%85%88%E6%8E%A2%E7%B4%A2">深さ優先探索（DFS）アルゴリズム</a>を使用しています。このアルゴリズムでは、あるぷよから始めて、上下左右に隣接する同じ色のぷよを再帰的に探索していきます。探索済みのぷよは <code>checked</code> 配列でマークし、重複してカウントしないようにしています。</p>
<p>「Pythonの再帰は大丈夫ですか？」良い質問ですね！Pythonのデフォルトの再帰制限は1000ですが、通常のぷよぷよのフィールドサイズ（6列×12行=72マス）では全く問題ありません。</p>
<h3 id="_61">テスト: ぷよの消去<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>次に、ぷよの消去処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_stage.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestStageEraseAndFall</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ぷよの消去と落下のテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stageインスタンスを返す&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_erase_target_puyos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;消去対象のぷよを消去する&quot;&quot;&quot;</span>
        <span class="c1"># ステージにぷよを配置</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 消去判定</span>
        <span class="n">erase_info</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>

        <span class="c1"># 消去実行</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span>

        <span class="c1"># ぷよが消去されていることを確認</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_puyos_fall_after_erase</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Config</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;消去後、上にあるぷよが落下する&quot;&quot;&quot;</span>
        <span class="c1"># ステージにぷよを配置</span>
        <span class="c1"># 下に赤ぷよ4つ（消去される）、その上に青ぷよ2つ</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># 消去判定と実行</span>
        <span class="n">erase_info</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span>

        <span class="c1"># 青ぷよが消去前の位置にないことを確認</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># 重力を適用（落下するまで繰り返す）</span>
        <span class="k">while</span> <span class="n">stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">():</span>
            <span class="k">pass</span>

        <span class="c1"># 上にあった青ぷよが落下していることを確認</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>
<p>このテストでは、消去対象のぷよが正しく消去されることと、消去後に上にあるぷよが落下することをテストしています。</p>
<h3 id="_62">実装: ぷよの消去<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/stage.py（続き）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">erase_boards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">erase_info</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ErasePosition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;消去対象のぷよを消去</span>

<span class="sd">        Args:</span>
<span class="sd">            erase_info: 消去するぷよの位置情報リスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 消去対象のぷよを消去</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">erase_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]][</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
<p>「シンプルですね！」そうです！消去処理自体はとてもシンプルです。消去対象の座標リストを受け取り、それらの位置のぷよを0（空）にするだけです。</p>
<p>「落下処理はイテレーション4で実装した <code>apply_gravity()</code> を使えばいいんですね！」その通りです！既存のメソッドを再利用することで、コードの重複を避けられます。</p>
<h3 id="_63">実装: ゲームループとの統合<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>ゲームループに消去処理を統合します。Gameクラスの <code>update()</code> メソッドを修正して、消去判定と消去処理を組み込みます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lib/game.py（update メソッドの一部）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Game</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pyxelの更新関数（60FPS）&quot;&quot;&quot;</span>
        <span class="c1"># 経過時間を計算（ミリ秒）</span>
        <span class="n">delta_time</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="mf">60.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># モードに応じた処理</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;newPuyo&quot;</span><span class="p">:</span>
            <span class="c1"># 新しいぷよを作成</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;playing&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;playing&quot;</span><span class="p">:</span>
            <span class="c1"># プレイ中の処理（キー入力と自由落下）</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="n">delta_time</span><span class="p">)</span>

            <span class="c1"># 着地したら重力チェックに移行</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">has_landed</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkFall&quot;</span><span class="p">:</span>
            <span class="c1"># 重力を適用</span>
            <span class="n">has_fallen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">has_fallen</span><span class="p">:</span>
                <span class="c1"># ぷよが落下した場合、fallingモードへ</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;falling&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 落下するぷよがない場合、消去チェックへ</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkErase&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;falling&quot;</span><span class="p">:</span>
            <span class="c1"># 落下アニメーション用（一定フレーム待機）</span>
            <span class="c1"># 簡略化のため、すぐにcheckFallに戻る</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkErase&quot;</span><span class="p">:</span>
            <span class="c1"># 消去判定</span>
            <span class="n">erase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># 消去対象がある場合、消去処理へ</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;erasing&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 消去対象がない場合、次のぷよを出す</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;newPuyo&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;erasing&quot;</span><span class="p">:</span>
            <span class="c1"># 消去アニメーション用（一定フレーム待機）</span>
            <span class="c1"># 簡略化のため、すぐにcheckFallに戻る（消去後の重力適用）</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>
</code></pre></div>
<p>「ゲームの流れがどう変わったんですか？」良い質問ですね！ゲームフローは以下のように拡張されました：</p>
<p><strong>新しいゲームフロー</strong>:
<div class="highlight"><pre><span></span><code>newPuyo → playing → (着地) → checkFall → (重力適用) →
  ├─ 落下した → falling → checkFall
  └─ 落下なし → checkErase →
      ├─ 消去あり → erasing → checkFall（消去後の重力適用）
      └─ 消去なし → newPuyo
</code></pre></div></p>
<p>このフローにより、以下が実現されます：</p>
<ol>
<li><strong>着地後の重力適用</strong>: ぷよが着地したら、まず重力を適用して浮いているぷよを落とす</li>
<li><strong>消去判定</strong>: 重力適用後、落下するぷよがなくなったら消去判定</li>
<li><strong>消去処理</strong>: 4つ以上つながったぷよがあれば消去</li>
<li><strong>消去後の重力適用</strong>: 消去後、再び重力を適用（これが連鎖の基礎になる）</li>
</ol>
<h3 id="6_1">イテレーション6のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの消去機能を実装しました。以下がイテレーション6で実施した内容のまとめです：</p>
<ol>
<li><strong>型定義</strong></li>
<li><code>ErasePosition</code>: 消去位置情報を表すTypedDict</li>
<li><code>EraseInfo</code>: 消去情報全体を表すTypedDict</li>
<li>
<p>TypeScript版の <code>interface</code> を Python の <code>TypedDict</code> で実装</p>
</li>
<li>
<p><strong>接続判定機能</strong></p>
</li>
<li><code>check_erase()</code> メソッド：4つ以上つながったぷよを検出</li>
<li><code>_search_connected_puyo()</code> メソッド：深さ優先探索で接続ぷよを探索</li>
<li>
<p>再帰的な探索でつながったぷよをすべて発見</p>
</li>
<li>
<p><strong>消去処理機能</strong></p>
</li>
<li><code>erase_boards()</code> メソッド：消去対象のぷよを削除</li>
<li>
<p>シンプルに座標リストを受け取って0で上書き</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong></p>
</li>
<li><code>checkErase</code> モード：消去判定を実行</li>
<li><code>erasing</code> モード：消去アニメーション後、重力チェックへ</li>
<li>
<p>ゲームフローの拡張：着地 → 重力 → 消去 → 重力 → 次のぷよ</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ぷよの接続判定(3テスト)<ul>
<li>同じ色のぷよが4つつながっていると、消去対象になる</li>
<li>異なる色のぷよは消去対象にならない</li>
<li>3つ以下のつながりは消去対象にならない</li>
</ul>
</li>
<li>ぷよの消去処理(2テスト)<ul>
<li>消去対象のぷよを消去する</li>
<li>消去後、上にあるぷよが落下する</li>
</ul>
</li>
<li>
<p>合計 30 テスト(既存25 + 新規5)すべて成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>深さ優先探索（DFS）アルゴリズム</li>
<li>再帰的な探索処理</li>
<li>ゲームモードによる状態管理</li>
<li>
<p>消去と重力の連携処理</p>
</li>
<li>
<p><strong>TypeScript版からの主な変更点</strong></p>
</li>
<li><code>interface</code> → <code>TypedDict</code>（型定義）</li>
<li><code>const directions = [{dx, dy}, ...]</code> → <code>directions = [(dx, dy), ...]</code>（タプルのリスト）</li>
<li><code>for (const direction of directions)</code> → <code>for dx, dy in directions:</code></li>
<li><code>connected: {x, y}[]</code> → <code>connected: list[tuple[int, int]]</code>（座標リストの表現）</li>
</ol>
<p>このイテレーションにより、同じ色のぷよを4つ以上つなげると消去できるようになり、ぷよぷよの基本的なゲームルールが実装できました。次のイテレーションでは、連鎖反応を実装していきます！</p>
<hr />
<h2 id="7">イテレーション7: 連鎖反応の実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>「連鎖ができるようになると、もっと面白くなりますよね？」そうですね！ぷよぷよの面白さの核心は連鎖反応です。今回は、連鎖反応がどのように実現されているのかを確認していきましょう！</p>
<h3 id="_64">ユーザーストーリー<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで確認するユーザーストーリーを見てみましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよが消去された後に落下したぷよが再び消去されると連鎖が発生する</p>
</blockquote>
<p>「つまり、消去 → 落下 → 消去 → 落下 → ... という連続反応ですね！」そうです！連鎖反応により、プレイヤーは戦略的な配置を考えるようになります。</p>
<h3 id="todo_6">TODOリスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」実は、イテレーション6で実装したゲームループが、すでに連鎖反応を実現しているんです！</p>
<p>このイテレーションでは、以下のタスクを行います：</p>
<ul>
<li>連鎖反応がゲームループで実現されていることを確認する</li>
<li>連鎖のテストケースを追加する</li>
</ul>
<p>「新しい実装は必要ないんですか？」そうなんです。イテレーション6で作成したゲームループの仕組みが、自然に連鎖反応を実現しているんです。</p>
<h3 id="_65">テスト: 連鎖反応の確認<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>まず、連鎖反応をテストするテストケースを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_game.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_chain_reaction_occurs_after_erase_and_fall</span><span class="p">(</span>
    <span class="n">game</span><span class="p">:</span> <span class="n">Game</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する&quot;&quot;&quot;</span>
    <span class="c1"># ゲームのステージにぷよを配置</span>
    <span class="c1"># 赤ぷよの2×2と、その上に青ぷよが縦に3つ、さらに青ぷよが1つ横に</span>
    <span class="c1"># 0 0 0 0 0 0</span>
    <span class="c1"># 0 0 0 0 0 0</span>
    <span class="c1"># 0 0 0 0 0 0</span>
    <span class="c1"># 0 0 0 0 0 0</span>
    <span class="c1"># 0 0 0 0 0 0</span>
    <span class="c1"># 0 0 2 0 0 0</span>
    <span class="c1"># 0 0 2 0 0 0</span>
    <span class="c1"># 0 0 2 0 0 0</span>
    <span class="c1"># 0 1 1 2 0 0</span>
    <span class="c1"># 0 1 1 0 0 0</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 赤</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 赤</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 赤</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 赤</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 青（横）</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># 青（上）</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># 青（上）</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># 青（上）</span>

    <span class="c1"># checkErase モードに設定</span>
    <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkErase&quot;</span>

    <span class="c1"># 1回目の消去判定と消去実行</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># checkErase → erasing</span>
    <span class="k">assert</span> <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;erasing&quot;</span>

    <span class="c1"># 消去後の重力チェック</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># erasing → checkFall</span>
    <span class="k">assert</span> <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkFall&quot;</span>

    <span class="c1"># 重力適用（青ぷよが落下）</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># checkFall → falling（落下あり）</span>
    <span class="k">assert</span> <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;falling&quot;</span>

    <span class="c1"># 落下アニメーション</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># falling → checkFall</span>
    <span class="k">assert</span> <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkFall&quot;</span>

    <span class="c1"># 落下完了まで繰り返し</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;checkErase&quot;</span> <span class="ow">and</span> <span class="n">iterations</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># checkErase モードに到達している</span>
    <span class="k">assert</span> <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkErase&quot;</span>

    <span class="c1"># 2回目の消去判定（連鎖）</span>
    <span class="n">chain_erase_info</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>

    <span class="c1"># 連鎖が発生していることを確認（青ぷよが4つつながっている）</span>
    <span class="k">assert</span> <span class="n">chain_erase_info</span><span class="p">[</span><span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のシナリオを確認しています：</p>
<ol>
<li>まず、特定のパターンでぷよを配置します（赤ぷよの2×2の正方形と、その上に青ぷよが縦に3つ並んでいる状態）</li>
<li>最初の消去判定で赤ぷよの正方形が消えます</li>
<li>消去後に落下処理を行うと、上にあった青ぷよが落下します</li>
<li>落下した結果、新たに青ぷよが4つつながり、連鎖が発生することを確認します</li>
</ol>
<p>「なるほど、連鎖の仕組みがテストで表現されているんですね！」そうです！このテストは、ぷよぷよの連鎖の基本的な仕組みを表現しています。では、このテストが通るか確認してみましょう。</p>
<h3 id="_66">実装: 連鎖判定<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>「既存のゲームループを見てみると、実は連鎖反応は既に実装されています！」そうなんです。イテレーション6で実装したゲームループの仕組みが、そのまま連鎖反応を実現しているんです。</p>
<p>「え？本当ですか？」はい。ゲームループの実装を見てみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/game.py の update メソッド（抜粋）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲーム状態を更新する&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># モードに応じた処理</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;newPuyo&quot;</span><span class="p">:</span>
        <span class="c1"># 新しいぷよを作成</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;playing&quot;</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;playing&quot;</span><span class="p">:</span>
        <span class="c1"># プレイ中の処理（キー入力と自由落下）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="n">delta_time</span><span class="p">)</span>

        <span class="c1"># 着地したら重力チェックに移行</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">has_landed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkFall&quot;</span><span class="p">:</span>
        <span class="c1"># 重力を適用</span>
        <span class="n">has_fallen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">apply_gravity</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">has_fallen</span><span class="p">:</span>
            <span class="c1"># ぷよが落下した場合、falling モードへ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;falling&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 落下するぷよがない場合、消去チェックへ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkErase&quot;</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;falling&quot;</span><span class="p">:</span>
        <span class="c1"># 落下アニメーション用（一定フレーム待機）</span>
        <span class="c1"># 簡略化のため、すぐに checkFall に戻る</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkErase&quot;</span><span class="p">:</span>
        <span class="c1"># 消去判定</span>
        <span class="n">erase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 消去対象がある場合、消去処理へ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;erasing&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 消去対象がない場合、次のぷよを出す</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;newPuyo&quot;</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;erasing&quot;</span><span class="p">:</span>
        <span class="c1"># 消去アニメーション用（一定フレーム待機）</span>
        <span class="c1"># 簡略化のため、すぐに checkFall に戻る（消去後の重力適用）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>
</code></pre></div>
<p>「このゲームループの何が連鎖反応を実現しているんですか？」重要なのは、<code>erasing</code> モード後に <code>checkFall</code> に戻るという点です。連鎖が発生する流れを見てみましょう：</p>
<h4 id="_67">連鎖の流れ<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>1回目の消去</strong>：
   <div class="highlight"><pre><span></span><code>checkErase → ぷよが消去される → erasing → checkFall
</code></pre></div></p>
</li>
<li>
<p><strong>重力適用</strong>：
   <div class="highlight"><pre><span></span><code>checkFall → 上のぷよが落下 → falling → checkFall → 落下完了 → checkErase
</code></pre></div></p>
</li>
<li>
<p><strong>2回目の消去（連鎖）</strong>：
   <div class="highlight"><pre><span></span><code>checkErase → 落下後に新しい消去パターン発見 → erasing → checkFall
</code></pre></div></p>
</li>
<li>
<p><strong>連鎖終了</strong>：
   <div class="highlight"><pre><span></span><code>checkFall → 落下なし → checkErase → 消去なし → newPuyo
</code></pre></div></p>
</li>
</ol>
<p>「つまり、<code>erasing → checkFall → checkErase</code> のサイクルが連鎖を作っているんですね！」そのとおりです！このサイクルが、消去対象がなくなるまで繰り返されることで、連鎖反応が実現されています。</p>
<h3 id="_68">テスト実行<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>それでは、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>pytest<span class="w"> </span>tests/test_game.py::test_chain_reaction_occurs_after_erase_and_fall<span class="w"> </span>-v
</code></pre></div>
<p>「テストは通ったんですか？」はい！既存の実装で連鎖反応のテストがパスしました。イテレーション6で実装したゲームループが、自然に連鎖反応を実現していたんです。</p>
<h3 id="7_1">イテレーション7のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>連鎖反応はゲームループの構造から生まれる</strong>：</li>
<li><code>erasing → checkFall → checkErase</code> のサイクルが連鎖を実現</li>
<li>消去対象がなくなるまで自動的に繰り返される</li>
<li>
<p>新しいコードを追加せずに、既存の状態遷移だけで実現</p>
</li>
<li>
<p><strong>テストファースト開発の利点</strong>：</p>
</li>
<li>テストを先に書くことで、既存実装の動作を確認できた</li>
<li>新しいコードを追加せずに、テストだけで機能の動作を検証</li>
<li>
<p>実装が正しく動作していることを確認</p>
</li>
<li>
<p><strong>シンプルな設計の力</strong>：</p>
</li>
<li>複雑な連鎖ロジックを追加せずに、既存の状態遷移だけで実現</li>
<li>各モードが単一責任を持つことで、組み合わせが自然に連鎖を生む</li>
<li>
<p>モードの状態遷移が直感的でわかりやすい</p>
</li>
<li>
<p><strong>ゲーム状態の遷移図</strong>：</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>newPuyo → playing → (着地) → checkFall → (重力適用) →
  ├─ 落下した → falling → checkFall
  └─ 落下なし → checkErase →
      ├─ 消去あり → erasing → checkFall（消去後の重力適用）
      └─ 消去なし → newPuyo
</code></pre></div>
<p>この状態遷移が、連鎖反応の基盤となっています。次のイテレーションでは、全消しボーナスを実装して、プレイヤーに特別な達成感を提供していきます！</p>
<h2 id="8">イテレーション8: 全消しボーナスの実装<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>「連鎖ができるようになったけど、ぷよぷよには全消しボーナスもありますよね？」そうですね！ぷよぷよには、盤面上のぷよをすべて消すと得られる「全消し（ぜんけし）ボーナス」という特別な報酬があります。今回は、その全消しボーナスを実装していきましょう！</p>
<h3 id="_69">ユーザーストーリー<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、盤面上のぷよをすべて消したときに全消しボーナスを獲得できる</p>
</blockquote>
<p>「やった！全部消えた！」という達成感と共に、特別なボーナスポイントを獲得できる機能を実装します。これにより、プレイヤーは全消しを狙った戦略を考えるようになりますね。</p>
<h3 id="todo_7">TODOリスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「全消しボーナスを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>全消し判定を実装する（盤面上のぷよがすべて消えたかどうかを判定する）</li>
<li>全消しボーナスの計算を実装する（全消し時に加算するボーナス点を計算する）</li>
<li>ゲームループと統合する（全消し判定のタイミングを適切に設定する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_70">テスト: 全消し判定<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、全消し判定をテストしましょう。盤面上のぷよがすべて消えたかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_stage.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_all_puyos_erased_is_zenkeshi</span><span class="p">(</span><span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;盤面上のぷよがすべて消えると全消しになる&quot;&quot;&quot;</span>
    <span class="c1"># ステージにぷよを配置</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 消去判定と実行</span>
    <span class="n">erase_info</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span>

    <span class="c1"># 全消し判定</span>
    <span class="n">is_zenkeshi</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_zenkeshi</span><span class="p">()</span>

    <span class="c1"># 全消しになっていることを確認</span>
    <span class="k">assert</span> <span class="n">is_zenkeshi</span> <span class="ow">is</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_puyos_remaining_is_not_zenkeshi</span><span class="p">(</span><span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;盤面上にぷよが残っていると全消しにならない&quot;&quot;&quot;</span>
    <span class="c1"># ステージにぷよを配置</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 消えないぷよ</span>

    <span class="c1"># 消去判定と実行</span>
    <span class="n">erase_info</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span>

    <span class="c1"># 全消し判定</span>
    <span class="n">is_zenkeshi</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">check_zenkeshi</span><span class="p">()</span>

    <span class="c1"># 全消しになっていないことを確認</span>
    <span class="k">assert</span> <span class="n">is_zenkeshi</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>盤面上のぷよがすべて消えた場合、全消しと判定されるか</li>
<li>盤面上にぷよが残っている場合、全消しと判定されないか</li>
</ol>
<p>「最初のテストでは、2×2の正方形に赤ぷよを配置して、それらが消えた後に全消しになるんですね？」そうです！最初のテストでは、2×2の正方形に赤ぷよを配置し、それらが消去された後に盤面が空になるので、全消しと判定されるはずです。</p>
<p>「2つ目のテストでは、消えないぷよが残るようにしているんですね？」その通りです！2つ目のテストでは、2×2の正方形に赤ぷよを配置した上で、別の場所に青ぷよを1つ配置しています。赤ぷよは消えますが、青ぷよは消えないので、全消しにはならないはずです。</p>
<h3 id="_71">実装: 全消し判定<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、全消し判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/stage.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_zenkeshi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;全消し判定を行う</span>

<span class="sd">    Returns:</span>
<span class="sd">        全消しの場合True、それ以外はFalse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 盤面上にぷよがあるかチェック</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。全消し判定の実装自体はとてもシンプルです。盤面上のすべてのマスを順番にチェックし、ぷよがある（値が0でない）マスが見つかった時点で<code>False</code>を返します。すべてのマスをチェックして、ぷよが見つからなければ<code>True</code>を返します。</p>
<p>「二重ループを使って、すべてのマスをチェックしているんですね！」その通りです！外側のループで行（y座標）を、内側のループで列（x座標）を順番にチェックしています。これにより、盤面上のすべてのマスを効率的にチェックできます。</p>
<h3 id="_72">解説: 全消し判定<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>全消し判定では、以下のことを行っています：</p>
<ol>
<li>盤面上のすべてのマスをチェック</li>
<li>ぷよがある（値が0でない）マスがあれば全消しではない</li>
<li>すべてのマスが空（値が0）であれば全消し</li>
</ol>
<p>「全消し判定はいつ行われるんですか？」良い質問ですね！全消し判定は、ぷよの消去処理後に行われます。ぷよが消えた後、盤面上にぷよが残っていないかをチェックするんです。</p>
<h3 id="_73">テスト: 全消しボーナス<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>「全消しボーナスはどのようにテストすればいいですか？」全消しボーナスは、全消し時に特別なボーナス点が加算されることをテストする必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_score.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_zenkeshi_bonus_is_added</span><span class="p">(</span><span class="n">score</span><span class="p">:</span> <span class="n">Score</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;全消しするとボーナスが加算される&quot;&quot;&quot;</span>
    <span class="c1"># 初期スコアを確認</span>
    <span class="n">initial_score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">get_score</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">initial_score</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># 全消しボーナス加算</span>
    <span class="n">score</span><span class="o">.</span><span class="n">add_zenkeshi_bonus</span><span class="p">()</span>

    <span class="c1"># 全消しボーナスが加算されていることを確認</span>
    <span class="k">assert</span> <span class="n">score</span><span class="o">.</span><span class="n">get_score</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">initial_score</span>
    <span class="k">assert</span> <span class="n">score</span><span class="o">.</span><span class="n">get_score</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3600</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、全消しボーナスが加算されると、スコアが増加することを確認しています。具体的には：</p>
<ol>
<li>まず初期スコア（0点）を確認します</li>
<li>次に全消しボーナスを加算します</li>
<li>最後に、スコアが増加していること、そして3600点になっていることを確認します</li>
</ol>
<p>このテストでは、全消しボーナスが正しく加算されることをテストしています。</p>
<h3 id="_74">実装: 全消しボーナス<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/score.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_zenkeshi_bonus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;全消しボーナスを加算する&quot;&quot;&quot;</span>
    <span class="c1"># 全消しボーナス（固定値）</span>
    <span class="n">zenkeshi_bonus</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="n">zenkeshi_bonus</span>

    <span class="c1"># スコア表示の更新</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</code></pre></div>
<h3 id="_75">解説: 全消しボーナス<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>全消しボーナスでは、以下のことを行っています：</p>
<ol>
<li>全消しボーナスの計算（固定値3600点）</li>
<li>スコアへの加算</li>
<li>スコア表示の更新</li>
</ol>
<p>全消しボーナスは、盤面上のぷよをすべて消去した場合に加算される特別なボーナスです。これにより、プレイヤーは全消しを狙った戦略を考えるようになります。</p>
<h3 id="_76">実装: ゲームループとの統合<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>「全消しボーナスはいつ判定されるんですか？」良い質問ですね！全消しボーナスは、ゲームループの<code>checkErase</code>モードで消去対象がない場合に判定されます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/game.py の update メソッド（抜粋）</span>
<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;checkErase&quot;</span><span class="p">:</span>
    <span class="c1"># 消去判定</span>
    <span class="n">erase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">check_erase</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_puyo_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 消去対象がある場合、消去処理へ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">erase_boards</span><span class="p">(</span><span class="n">erase_info</span><span class="p">[</span><span class="s2">&quot;erase_info&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;erasing&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 消去対象がない場合、全消し判定</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">check_zenkeshi</span><span class="p">():</span>
            <span class="c1"># 全消しボーナスを加算</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">add_zenkeshi_bonus</span><span class="p">()</span>
        <span class="c1"># 次のぷよを出す</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;newPuyo&quot;</span>
</code></pre></div>
<p>「なるほど！消去するぷよがなくなったタイミングで全消しチェックをするんですね。」そのとおりです。ゲームの流れは以下のようになります：</p>
<ol>
<li>ぷよが着地 → <code>checkFall</code></li>
<li>重力適用 → <code>falling</code> → <code>checkFall</code>（繰り返し）</li>
<li>落下なし → <code>checkErase</code></li>
<li>消去判定：</li>
<li>消去あり → <code>erasing</code> → <code>checkFall</code>（重力再適用）</li>
<li>消去なし → 全消し判定 → <code>newPuyo</code></li>
</ol>
<h3 id="_77">テスト: 全消しボーナスの統合<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>「全消しボーナスの統合テストも追加したんですか？」はい、ゲームループ全体が正しく動作することを確認するテストを追加しました。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_game.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_zenkeshi_bonus_is_added_when_all_puyos_erased</span><span class="p">(</span>
    <span class="n">game</span><span class="p">:</span> <span class="n">Game</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="n">Score</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;盤面上のぷよをすべて消すと全消しボーナスが加算される&quot;&quot;&quot;</span>
    <span class="c1"># 初期スコア確認</span>
    <span class="n">initial_score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">get_score</span><span class="p">()</span>

    <span class="c1"># 盤面に4つのぷよを配置（すべて消去される）</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># checkErase モードに設定</span>
    <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkErase&quot;</span>

    <span class="c1"># 消去判定と処理</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># checkErase → erasing（消去実行）</span>

    <span class="c1"># 消去後の重力チェック</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># erasing → checkFall</span>

    <span class="c1"># 重力適用（落下なし）</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># checkFall → checkErase</span>

    <span class="c1"># 2回目の消去判定（全消し判定が実行される）</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># checkErase → newPuyo（全消しボーナス加算）</span>

    <span class="c1"># スコアが増加していることを確認</span>
    <span class="k">assert</span> <span class="n">score</span><span class="o">.</span><span class="n">get_score</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">initial_score</span>
    <span class="c1"># 消去スコア(320) + 全消しボーナス(3600) = 3920</span>
    <span class="k">assert</span> <span class="n">score</span><span class="o">.</span><span class="n">get_score</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3920</span>
</code></pre></div>
<p>「このテストでは、4つのぷよを消去して全消しになるシナリオを確認しているんですね！」そうです。全消しボーナスが正しく加算されることと、スコアが3920点（消去スコア320 + 全消しボーナス3600）になることを検証しています。</p>
<h3 id="8_1">イテレーション8のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>全消し判定の実装</strong>：</li>
<li>二重ループでフィールド全体をスキャン</li>
<li>ぷよが1つでも残っていれば全消しではない</li>
<li>
<p>シンプルなロジックで確実な判定を実現</p>
</li>
<li>
<p><strong>全消しボーナスの設計</strong>：</p>
</li>
<li>固定値（3600点）のボーナスを付与</li>
<li>プレイヤーに特別な達成感を与える仕組み</li>
<li>
<p>戦略的な深みを追加</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong>：</p>
</li>
<li><code>checkErase</code>モードで消去対象がない場合に全消し判定</li>
<li>既存の状態遷移に自然に組み込む</li>
<li>
<p>統合テストでエンドツーエンドの動作を確認</p>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
</li>
<li>全消しになるケースとならないケースの両方をテスト</li>
<li>境界条件（空の盤面、1つだけ残る）を確認</li>
<li>実装前にテストで仕様を明確化</li>
<li>
<p>統合テストで全体の動作を保証</p>
</li>
<li>
<p><strong>Pythonでの実装ポイント</strong>：</p>
</li>
<li><code>check_zenkeshi()</code> メソッドで全消し判定</li>
<li><code>add_zenkeshi_bonus()</code> メソッドでボーナス加算</li>
<li>ゲームループの <code>checkErase</code> モードで統合</li>
</ol>
<p>このイテレーションで、全消しボーナスという特別な報酬システムが実装できました。次のイテレーションでは、ゲームの終了条件となるゲームオーバー判定を実装していきます！</p>
<h2 id="9">イテレーション9: ゲームオーバーの実装<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>「ゲームが終わる条件も必要ですよね？」そうですね！どんなゲームにも終わりがあります。ぷよぷよでは、新しいぷよを配置できなくなったときにゲームオーバーとなります。今回は、そのゲームオーバー判定と演出を実装していきましょう！</p>
<h3 id="_78">ユーザーストーリー<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。ゲームオーバーになったことを明確に伝え、適切な演出を行うことで、プレイヤーに達成感や次回への意欲を持ってもらうことができます。</p>
<h3 id="todo_8">TODOリスト<a class="headerlink" href="#todo_8" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ゲームオーバーを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出する）</li>
<li>ゲームオーバー演出を実装する（ゲームオーバー時に特別な表示を追加する）</li>
<li>ゲームループと統合する（ゲームオーバー時の状態遷移を実装する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_79">テスト: ゲームオーバー判定<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバー判定をテストしましょう。新しいぷよを配置できない状態を検出する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_player.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_cannot_place_new_puyo_is_game_over</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;新しいぷよを配置できない場合、ゲームオーバーになる&quot;&quot;&quot;</span>
    <span class="c1"># ステージの上部にぷよを配置</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 新しいぷよの生成（通常は中央上部に配置される）</span>
    <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

    <span class="c1"># ゲームオーバー判定</span>
    <span class="n">is_game_over</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="n">check_game_over</span><span class="p">()</span>

    <span class="c1"># ゲームオーバーになっていることを確認</span>
    <span class="k">assert</span> <span class="n">is_game_over</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、新しいぷよを配置できない状態がゲームオーバーと判定されるかを確認しています。具体的には：</p>
<ol>
<li>ステージの上部（新しいぷよが配置される位置）にぷよを配置します</li>
<li>新しいぷよを生成します</li>
<li>ゲームオーバー判定を行い、ゲームオーバーになっていることを確認します</li>
</ol>
<p>「なるほど、新しいぷよの配置位置にすでにぷよがあると、ゲームオーバーになるんですね！」そうです！ぷよぷよでは、新しいぷよを配置する位置（通常はステージの中央上部）にすでにぷよがある場合、これ以上ゲームを続行できないため、ゲームオーバーとなります。では、このテストが通るように実装していきましょう。</p>
<h3 id="_80">実装: ゲームオーバー判定<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームオーバー判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/player.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_game_over</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲームオーバー判定を行う</span>

<span class="sd">    Returns:</span>
<span class="sd">        ゲームオーバーの場合True、それ以外はFalse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 新しいぷよの配置位置（中央上部）</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Player</span><span class="o">.</span><span class="n">INITIAL_PUYO_X</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Player</span><span class="o">.</span><span class="n">INITIAL_PUYO_Y</span>

    <span class="c1"># 配置位置にすでにぷよがある場合はゲームオーバー</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="p">)</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。ゲームオーバー判定の実装自体はとてもシンプルです。新しいぷよの配置位置（中央上部）を確認し、その位置にすでにぷよがあるかどうかをチェックしています。</p>
<p>「<code>x + 1</code>もチェックしているのはなぜですか？」良い質問ですね！ぷよぷよでは、新しいぷよは2つ連なった状態で登場します。通常、1つは中央（x）に、もう1つはその右隣（x + 1）に配置されます。そのため、どちらかの位置にすでにぷよがある場合は、新しいぷよを配置できないと判断します。</p>
<h3 id="_81">解説: ゲームオーバー判定<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー判定では、以下のことを行っています：</p>
<ol>
<li>新しいぷよの配置位置（中央上部）を確認</li>
<li>その位置またはその右隣にすでにぷよがある場合、ゲームオーバーと判定</li>
</ol>
<p>「ゲームオーバー判定はいつ行われるんですか？」良い質問ですね！ゲームオーバー判定は、新しいぷよを生成するタイミングで行われます。新しいぷよを生成しようとしたときに、配置位置にすでにぷよがあれば、ゲームオーバーとなります。</p>
<h3 id="_82">テスト: ゲームオーバー演出<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>「ゲームオーバー演出はどのようにテストすればいいですか？」ゲームオーバー演出は、ゲームの状態（モード）が変わることをテストするといいでしょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_game.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_game_mode_changes_to_game_over_when_game_is_over</span><span class="p">(</span>
    <span class="n">game</span><span class="p">:</span> <span class="n">Game</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲームオーバーになると、ゲームモードがgameOverに変わる&quot;&quot;&quot;</span>
    <span class="c1"># ステージの上部にぷよを配置</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># ゲームモードを設定</span>
    <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;newPuyo&quot;</span>

    <span class="c1"># ゲームループを実行</span>
    <span class="n">game</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ゲームモードがgameOverになっていることを確認</span>
    <span class="k">assert</span> <span class="n">game</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;gameOver&quot;</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、ゲームオーバー条件が満たされた場合に、ゲームの状態（モード）が<code>gameOver</code>に変わることを確認しています。具体的には：</p>
<ol>
<li>ステージの上部にぷよを配置して、ゲームオーバー条件を作ります</li>
<li>ゲームモードを<code>newPuyo</code>（新しいぷよを生成するモード）に設定します</li>
<li>ゲームループを実行します</li>
<li>ゲームモードが<code>gameOver</code>に変わっていることを確認します</li>
</ol>
<p>「なるほど、ゲームの状態遷移をテストしているんですね！」そうです！ゲームオーバーになると、ゲームの状態が変わり、それに応じた演出が行われるようになります。では、このテストが通るように実装していきましょう。</p>
<h3 id="_83">実装: ゲームループとの統合<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p>「ゲームオーバー判定はいつ行われるんですか？」良い質問ですね！ゲームオーバー判定は、新しいぷよを生成するタイミングで行われます。具体的には、<code>newPuyo</code> モードで新しいぷよを作成した直後にチェックします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/game.py の update メソッド（抜粋）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲーム状態を更新する&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># モードに応じた処理</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;newPuyo&quot;</span><span class="p">:</span>
        <span class="c1"># 新しいぷよを作成</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>

        <span class="c1"># ゲームオーバー判定</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">check_game_over</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;gameOver&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;playing&quot;</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;playing&quot;</span><span class="p">:</span>
        <span class="c1"># プレイ中の処理（キー入力と自由落下）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">update_with_delta</span><span class="p">(</span><span class="n">delta_time</span><span class="p">)</span>

        <span class="c1"># 着地したら重力チェックに移行</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">has_landed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;checkFall&quot;</span>

    <span class="c1"># ... 他のモード処理</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;gameOver&quot;</span><span class="p">:</span>
        <span class="c1"># ゲームオーバー演出（何もしない）</span>
        <span class="k">pass</span>
</code></pre></div>
<p>「なるほど、新しいぷよを作った直後にチェックするんですね！」そうです。新しいぷよを配置しようとした時点で、配置位置にすでにぷよがあれば、それ以上ゲームを続けられないと判断します。</p>
<h3 id="_84">実装: ゲームオーバー演出<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>「Pyxel でゲームオーバー演出はどのように実装するんですか？」Pyxel では、<code>pyxel.text()</code> を使ってゲームオーバーメッセージを画面に表示します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/game.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲーム画面を描画する&quot;&quot;&quot;</span>
    <span class="n">pyxel</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ステージを描画</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="c1"># プレイヤーのぷよを描画（ゲームオーバー以外）</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;gameOver&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="c1"># スコアを描画</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="c1"># ゲームオーバー演出</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;gameOver&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_game_over</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">draw_game_over</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ゲームオーバー画面を描画する&quot;&quot;&quot;</span>
    <span class="c1"># 画面中央に「GAME OVER」を表示</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;GAME OVER&quot;</span>
    <span class="n">text_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">FONT_WIDTH</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pyxel</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">text_width</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># 背景（黒）</span>
    <span class="n">pyxel</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># テキスト（赤）</span>
    <span class="n">pyxel</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</code></pre></div>
<p>「影付きのテキストを描画しているんですね！」そうです！まず黒色でテキストを描画し、その上に赤色でテキストを描画することで、影のような効果を作っています。これにより、「GAME OVER」のテキストが見やすくなります。</p>
<h3 id="pyxel_4">解説: Pyxel での文字列描画<a class="headerlink" href="#pyxel_4" title="Permanent link">&para;</a></h3>
<p>Pyxel でのテキスト描画では、以下のポイントがあります：</p>
<ol>
<li>
<p><strong>文字列の幅計算</strong>：
   <div class="highlight"><pre><span></span><code><span class="n">text_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">FONT_WIDTH</span>
</code></pre></div>
   <code>pyxel.FONT_WIDTH</code>（4ピクセル）に文字数を掛けて幅を計算します。</p>
</li>
<li>
<p><strong>中央配置の計算</strong>：
   <div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pyxel</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">text_width</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pyxel</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
</code></pre></div>
   画面幅から文字列幅を引いて2で割ることで、中央のX座標を求めます。</p>
</li>
<li>
<p><strong>影付きテキスト</strong>：
   <div class="highlight"><pre><span></span><code><span class="n">pyxel</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 影（黒）</span>
<span class="n">pyxel</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>          <span class="c1"># 本体（赤）</span>
</code></pre></div>
   影を少しずらして描画することで、立体感を出します。</p>
</li>
</ol>
<h3 id="9_1">イテレーション9のまとめ<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>ゲームオーバー判定の実装</strong>：</li>
<li>新しいぷよの配置位置を確認</li>
<li>配置位置にぷよがあればゲームオーバー</li>
<li>
<p>2つのぷよ（軸と連結）両方をチェック</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong>：</p>
</li>
<li><code>newPuyo</code>モードで新しいぷよ生成後に判定</li>
<li>ゲームオーバー時は<code>gameOver</code>モードに遷移</li>
<li>
<p>状態遷移をテストで検証</p>
</li>
<li>
<p><strong>Pyxel でのゲームオーバー演出</strong>：</p>
</li>
<li><code>pyxel.text()</code> で文字列を描画</li>
<li>中央配置の計算方法</li>
<li>影付きテキストの実装</li>
<li>
<p><code>draw()</code> メソッドでの条件分岐</p>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
</li>
<li>ゲームオーバー判定のテスト</li>
<li>状態遷移のテスト</li>
<li>
<p>実装前にテストで仕様を明確化</p>
</li>
<li>
<p><strong>Pythonでの実装ポイント</strong>：</p>
</li>
<li><code>check_game_over()</code> メソッドでゲームオーバー判定</li>
<li><code>draw_game_over()</code> メソッドでゲームオーバー画面描画</li>
<li>モード管理でゲームの状態を制御</li>
</ol>
<p>このイテレーションで、ゲームの終了条件とゲームオーバー演出が実装できました。これで基本的なぷよぷよゲームが完成しました！しかし、プレイテストをすると重大なバグが見つかりました。次のイテレーションでは、このバグを修正していきます！</p>
<h2 id="10">イテレーション10: 衝突判定の修正<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<p>「ゲームで遊んでいると、おかしな動きをすることがありますね...」そうなんです！実際にゲームをプレイテストした結果、重大なバグが発見されました。このイテレーションでは、TDDの重要な教訓である「テストされていない機能は動作しない」を再確認しながら、バグを修正していきましょう！</p>
<h3 id="_85">発見されたバグ<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>ゲームをプレイテストした結果、以下の重大なバグが発見されました：</p>
<ol>
<li><strong>回転時の衝突判定の欠落</strong></li>
<li>縦にしたぷよ（rotation=2）が既に着地したぷよの位置に回転できてしまう</li>
<li>
<p>回転によって既存のぷよを上書きしてしまう</p>
</li>
<li>
<p><strong>移動時の衝突判定の欠落</strong></p>
</li>
<li>左右に移動する際、既に着地したぷよの位置に移動できてしまう</li>
<li>移動によって既存のぷよを上書きしてしまう</li>
</ol>
<h3 id="_86">なぜテストで検出されなかったのか<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>イテレーション2で移動機能、イテレーション3で回転機能を実装した際、以下のテストケースしか作成していませんでした：</p>
<ul>
<li>壁際での移動・回転（境界チェックのテスト）</li>
<li>回転状態の遷移（0→1→2→3→0）</li>
</ul>
<p><strong>欠けていたテストケース</strong>：
- 既存のぷよがある位置への回転
- 既存のぷよがある位置への移動</p>
<p>これは TDD における重要な教訓です。「テストされていない機能は動作しない」という原則を再確認できました。</p>
<h3 id="_87">テスト: 移動時の衝突判定<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<p>「まずはテストから書きましょう！」そうですね。バグを修正する前に、バグを再現するテストを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_player.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_cannot_move_left_to_existing_puyo</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;既存のぷよがある位置には左に移動できない&quot;&quot;&quot;</span>
    <span class="c1"># 軸ぷよを (3, 5) に配置（上向き rotation=0）</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># 左側に障害物を配置</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 左に移動を試みる</span>
    <span class="n">player</span><span class="o">.</span><span class="n">move_left</span><span class="p">()</span>

    <span class="c1"># 移動していないことを確認</span>
    <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="mi">3</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_cannot_move_right_to_existing_puyo</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;既存のぷよがある位置には右に移動できない&quot;&quot;&quot;</span>
    <span class="c1"># 軸ぷよを (2, 5) に配置（上向き rotation=0）</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># 右側に障害物を配置</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 右に移動を試みる</span>
    <span class="n">player</span><span class="o">.</span><span class="n">move_right</span><span class="p">()</span>

    <span class="c1"># 移動していないことを確認</span>
    <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="mi">2</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_cannot_move_when_next_puyo_hits_obstacle</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2つ目のぷよの位置に障害物がある場合も移動できない&quot;&quot;&quot;</span>
    <span class="c1"># 軸ぷよを (2, 5) に配置、右向き (rotation=1)</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 2つ目のぷよは右側(3, 5)</span>

    <span class="c1"># 2つ目のぷよの右側（3, 5 の右 = 4, 5）に障害物を配置</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 右に移動を試みる</span>
    <span class="n">player</span><span class="o">.</span><span class="n">move_right</span><span class="p">()</span>

    <span class="c1"># 移動していないことを確認</span>
    <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>
<h3 id="_88">テスト: 回転時の衝突判定<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h3>
<p>次に、回転時の衝突判定のテストを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_player.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_cannot_rotate_to_existing_puyo</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;既存のぷよがある位置には回転できない&quot;&quot;&quot;</span>
    <span class="c1"># 軸ぷよを (2, 5) に配置（上向き rotation=0）</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># 右側（回転先）に障害物を配置</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">set_puyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 現在の回転状態を記録</span>
    <span class="n">before_rotation</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span>

    <span class="c1"># 右回転を試みる（0 → 1 で右向きになる）</span>
    <span class="n">player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">()</span>

    <span class="c1"># 回転していないことを確認</span>
    <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="n">before_rotation</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_can_rotate_when_destination_is_empty</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Player</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;回転後の位置が空いていれば回転できる&quot;&quot;&quot;</span>
    <span class="c1"># 軸ぷよを (2, 5) に配置（上向き rotation=0）</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># 右回転を試みる（0 → 1）</span>
    <span class="n">player</span><span class="o">.</span><span class="n">rotate_right</span><span class="p">()</span>

    <span class="c1"># 回転していることを確認</span>
    <span class="k">assert</span> <span class="n">player</span><span class="o">.</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
<p>「これらのテストを実行すると失敗しますね！」そうです。これがバグを再現するテストです（Red）。では、実装を修正していきましょう。</p>
<h3 id="_89">実装: 移動時の衝突判定<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h3>
<p><code>can_move_to()</code> メソッドを新規追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/player.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_can_move_to</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">axis_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">axis_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">next_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">next_y</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;移動可能かチェックする（内部メソッド）</span>

<span class="sd">    Args:</span>
<span class="sd">        axis_x: 軸ぷよのX座標</span>
<span class="sd">        axis_y: 軸ぷよのY座標</span>
<span class="sd">        next_x: 2つ目のぷよのX座標</span>
<span class="sd">        next_y: 2つ目のぷよのY座標</span>

<span class="sd">    Returns:</span>
<span class="sd">        移動可能ならTrue、それ以外はFalse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 軸ぷよの範囲チェック</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">axis_x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span>
        <span class="n">axis_x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="ow">or</span>
        <span class="n">axis_y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span>
        <span class="n">axis_y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># 2つ目のぷよの範囲チェック</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">next_x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span>
        <span class="n">next_x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="ow">or</span>
        <span class="n">next_y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span>
        <span class="n">next_y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># 軸ぷよの衝突チェック</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">axis_x</span><span class="p">,</span> <span class="n">axis_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># 2つ目のぷよの衝突チェック</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p>次に、<code>move_left()</code> と <code>move_right()</code> メソッドを修正します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/player.py（修正）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">move_left</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ぷよを左に移動する&quot;&quot;&quot;</span>
    <span class="c1"># 移動後の位置を計算</span>
    <span class="n">new_axis_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># 2つ目のぷよの位置を計算</span>
    <span class="n">offset_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
    <span class="n">offset_y</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
    <span class="n">new_next_x</span> <span class="o">=</span> <span class="n">new_axis_x</span> <span class="o">+</span> <span class="n">offset_x</span>
    <span class="n">new_next_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+</span> <span class="n">offset_y</span>

    <span class="c1"># 移動可能かチェック</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_move_to</span><span class="p">(</span><span class="n">new_axis_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span> <span class="n">new_next_x</span><span class="p">,</span> <span class="n">new_next_y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">-=</span> <span class="mi">1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">move_right</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ぷよを右に移動する&quot;&quot;&quot;</span>
    <span class="c1"># 移動後の位置を計算</span>
    <span class="n">new_axis_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># 2つ目のぷよの位置を計算</span>
    <span class="n">offset_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
    <span class="n">offset_y</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
    <span class="n">new_next_x</span> <span class="o">=</span> <span class="n">new_axis_x</span> <span class="o">+</span> <span class="n">offset_x</span>
    <span class="n">new_next_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+</span> <span class="n">offset_y</span>

    <span class="c1"># 移動可能かチェック</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_move_to</span><span class="p">(</span><span class="n">new_axis_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span><span class="p">,</span> <span class="n">new_next_x</span><span class="p">,</span> <span class="n">new_next_y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
<h3 id="_90">実装: 回転時の衝突判定<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h3>
<p><code>can_rotate_to()</code> メソッドを新規追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/player.py（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_can_rotate_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;回転可能かチェックする（内部メソッド）</span>

<span class="sd">    Args:</span>
<span class="sd">        next_x: 回転後の2つ目のぷよのX座標</span>
<span class="sd">        next_y: 回転後の2つ目のぷよのY座標</span>

<span class="sd">    Returns:</span>
<span class="sd">        回転可能ならTrue、それ以外はFalse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 範囲外チェック</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">next_x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span>
        <span class="n">next_x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span> <span class="ow">or</span>
        <span class="n">next_y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span>
        <span class="n">next_y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_rows</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># 既存のぷよとの衝突チェック</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">get_puyo</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p>次に、<code>_perform_rotation()</code> メソッドを修正します（イテレーション3で実装したメソッド）：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src/player.py（修正）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_perform_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_rotation</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;回転処理を実行する（内部メソッド）</span>

<span class="sd">    Args:</span>
<span class="sd">        new_rotation: 新しい回転状態</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 回転後の2つ目のぷよの位置を計算</span>
    <span class="n">offset_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">new_rotation</span><span class="p">]</span>
    <span class="n">offset_y</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="n">new_rotation</span><span class="p">]</span>
    <span class="n">new_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span>
    <span class="n">next_x</span> <span class="o">=</span> <span class="n">new_x</span> <span class="o">+</span> <span class="n">offset_x</span>
    <span class="n">next_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+</span> <span class="n">offset_y</span>

    <span class="c1"># 壁キック処理</span>
    <span class="k">if</span> <span class="n">next_x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 左壁に当たる場合、右にキック</span>
        <span class="n">new_x</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">next_x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stage_cols</span><span class="p">:</span>
        <span class="c1"># 右壁に当たる場合、左にキック</span>
        <span class="n">new_x</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># 回転後の位置を再計算</span>
    <span class="n">final_next_x</span> <span class="o">=</span> <span class="n">new_x</span> <span class="o">+</span> <span class="n">offset_x</span>
    <span class="n">final_next_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">+</span> <span class="n">offset_y</span>

    <span class="c1"># 回転後の位置が有効かチェック</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_rotate_to</span><span class="p">(</span><span class="n">final_next_x</span><span class="p">,</span> <span class="n">final_next_y</span><span class="p">):</span>
        <span class="c1"># 回転できない場合は何もしない</span>
        <span class="k">return</span>

    <span class="c1"># 回転を確定</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">puyo_x</span> <span class="o">=</span> <span class="n">new_x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">new_rotation</span>
</code></pre></div>
<h3 id="_91">既存テストの修正<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h3>
<p>既存の回転・移動テストが失敗していた原因は、プレイヤーが Y=0（画面最上部）に配置されており、上向き（rotation=0）の 2 つ目のぷよが Y=-1（画面外）に配置されてしまうためでした。</p>
<p>テストのセットアップを修正します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/test_player.py（修正）</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">player</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">:</span> <span class="n">PuyoImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Player</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Playerのフィクスチャ&quot;&quot;&quot;</span>
    <span class="n">player</span> <span class="o">=</span> <span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">puyo_image</span><span class="p">)</span>
    <span class="n">player</span><span class="o">.</span><span class="n">create_new_puyo</span><span class="p">()</span>
    <span class="c1"># 移動可能な位置に配置</span>
    <span class="n">player</span><span class="o">.</span><span class="n">puyo_y</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">return</span> <span class="n">player</span>
</code></pre></div>
<p>「テストを実行してみましょう！」はい、これでテストが通るはずです（Green）！</p>
<h3 id="_92">解説: 衝突判定の実装<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h3>
<p>今回追加した衝突判定では、以下のことを行っています：</p>
<ol>
<li><strong>移動時の衝突判定</strong>：</li>
<li>軸ぷよと2つ目のぷよ、両方の移動先をチェック</li>
<li>
<p>範囲外チェックと既存ぷよとの衝突チェック</p>
</li>
<li>
<p><strong>回転時の衝突判定</strong>：</p>
</li>
<li>回転後の2つ目のぷよの位置をチェック</li>
<li>壁キック処理後の最終位置をチェック</li>
</ol>
<h3 id="_93">学んだ教訓<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h3>
<p>このイテレーションから、以下の重要な教訓を学びました：</p>
<ol>
<li><strong>テストカバレッジの重要性</strong></li>
<li>機能を実装したら、その機能の「正常系」だけでなく「異常系」もテストする</li>
<li>
<p>境界値テストだけでなく、衝突判定のような制約条件もテストする</p>
</li>
<li>
<p><strong>プレイテストの重要性</strong></p>
</li>
<li>自動テストでカバーできない部分は手動テストで補完</li>
<li>
<p>実際にゲームを遊んでみることで、テストケースの漏れに気づける</p>
</li>
<li>
<p><strong>TDD のサイクルを守る</strong></p>
</li>
<li>Red（失敗するテストを書く）</li>
<li>Green（テストを通す最小限の実装）</li>
<li>Refactor（リファクタリング）</li>
<li>
<p><strong>重要</strong>: テストを書かずに実装すると、バグを見逃す可能性が高い</p>
</li>
<li>
<p><strong>バグ発見時の対応</strong></p>
</li>
<li>まずテストを書いてバグを再現（Red）</li>
<li>テストが失敗することを確認</li>
<li>バグを修正してテストを通す（Green）</li>
<li>同様のバグを防ぐためのテストを追加</li>
</ol>
<h3 id="10_1">イテレーション10のまとめ<a class="headerlink" href="#10_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>バグの発見と修正</strong>：</li>
<li>プレイテストによる重大なバグの発見</li>
<li>
<p>移動・回転時の衝突判定の欠落</p>
</li>
<li>
<p><strong>TDDの原則の再確認</strong>：</p>
</li>
<li>「テストされていない機能は動作しない」</li>
<li>
<p>バグ修正時も TDD サイクルに従う</p>
</li>
<li>
<p><strong>実装の改善</strong>：</p>
</li>
<li><code>_can_move_to()</code> メソッドで移動時の衝突判定</li>
<li><code>_can_rotate_to()</code> メソッドで回転時の衝突判定</li>
<li>
<p>軸ぷよと2つ目のぷよ、両方のチェック</p>
</li>
<li>
<p><strong>テストの拡充</strong>：</p>
</li>
<li>移動時の衝突判定テスト（3ケース）</li>
<li>回転時の衝突判定テスト（2ケース）</li>
<li>既存テストの修正（初期位置の調整）</li>
</ol>
<p>これで、ぷよぷよゲームの基本的な機能がすべて実装され、重要なバグも修正されました。次は、これまでの実装を振り返り、TDDの学びをまとめていきましょう！</p>
<h2 id="_94">ふりかえり<a class="headerlink" href="#_94" title="Permanent link">&para;</a></h2>
<p>ぷよぷよゲームの実装を完了することができたので、これまでのふりかえりをしておきましょう。</p>
<h3 id="keep">Keep（続けること）<a class="headerlink" href="#keep" title="Permanent link">&para;</a></h3>
<p>まず <strong>TODOリスト</strong> を作成して <strong>テストファースト</strong> で１つずつ小さなステップで開発を進めていきました。テスト駆動開発の「Red-Green-Refactor」サイクルに従うことで、コードの品質を保ちながら、段階的に機能を追加していくことができました。</p>
<p>各イテレーションでは、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に進めていきました。この流れは非常に効果的で、実装の方針が明確になり、必要最小限のコードで機能を実現することができました。</p>
<p>特に以下の点は今後も続けていきたいプラクティスです：</p>
<ol>
<li>ユーザーストーリーからTODOリストへの分解</li>
<li>テストファーストの原則に従った実装</li>
<li>小さなステップでの開発</li>
<li>リファクタリングによるコードの継続的な改善</li>
<li>プレイテストによる品質確認</li>
</ol>
<h3 id="problem">Problem（課題）<a class="headerlink" href="#problem" title="Permanent link">&para;</a></h3>
<p>開発を進める中で、いくつかの課題も見えてきました。</p>
<p>まず、テストの粒度をどの程度にするかという判断が難しい場面がありました。細かすぎるテストは冗長になり、大きすぎるテストは問題の特定が難しくなります。</p>
<p>また、テストケースの漏れを完全に防ぐことは難しいことがわかりました。イテレーション10で発見した衝突判定のバグは、テストケースの不足が原因でした。</p>
<p>ゲームロジックの複雑さが増すにつれて、テストの維持も難しくなりました。特に、ゲームの状態遷移やモード管理のテストは工夫が必要でした。</p>
<h3 id="try">Try（挑戦）<a class="headerlink" href="#try" title="Permanent link">&para;</a></h3>
<p>今後は以下のことに挑戦していきたいと思います：</p>
<ol>
<li>より網羅的なテスト戦略の構築 - 正常系と異常系のバランス</li>
<li>プレイテストと自動テストの組み合わせ</li>
<li>より複雑なゲーム機能への挑戦</li>
<li>パフォーマンス最適化とそのテスト手法の習得</li>
</ol>
<p>これらの知識と経験は、他のプロジェクトにも応用できるものです。テスト駆動開発は、コードの品質を高め、保守性を向上させるための強力な手法です。ぜひ、自分のプロジェクトにも取り入れてみてください。</p>
<blockquote>
<p>私がかつて発見した、そして多くの人に気づいてもらいたい効果とは、反復可能な振る舞いを規則にまで還元することで、規則の適用は機会的に反復可能になるということだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h2 id="_95">参考資料<a class="headerlink" href="#_95" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://amzn.asia/d/6425grx">テスト駆動開発入門</a></li>
<li><a href="https://www.amazon.co.jp/dp/4798124583">実践テスト駆動開発</a></li>
<li><a href="https://puyo.sega.jp/program/">ぷよぷよプログラミング</a></li>
<li><a href="https://github.com/kitao/pyxel/blob/main/docs/README.ja.md">Pyxel 公式ドキュメント</a></li>
<li><a href="https://docs.python.org/ja/3/">Python 公式ドキュメント</a></li>
<li><a href="https://github.com/astral-sh/uv">uv ドキュメント</a></li>
<li><a href="https://docs.astral.sh/ruff/">Ruff ドキュメント</a></li>
<li><a href="https://docs.pytest.org/">pytest ドキュメント</a></li>
<li><a href="https://mypy.readthedocs.io/">mypy ドキュメント</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>