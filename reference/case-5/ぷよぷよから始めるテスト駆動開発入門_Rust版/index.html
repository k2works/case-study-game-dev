
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 - Rust macroquad/bevy版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#-rust-macroquadbevy" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 - Rust macroquad/bevy版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="-rust-macroquadbevy">ぷよぷよから始めるテスト駆動開発入門 - Rust macroquad/bevy版<a class="headerlink" href="#-rust-macroquadbevy" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、ぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの？」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>言語</strong>: Rust — 「なぜRust？」と思われるかもしれませんが、Rustは型安全性とメモリ安全性を保証しながら、高速なゲームを作れる素晴らしい言語なんです。</li>
<li><strong>ゲームエンジン</strong>: macroquad/bevy — 「ゲームエンジン？難しそう...」と思うかもしれませんが、シンプルで学びやすいmacroquadと、強力なECS（Entity Component System）を持つbevyから選べます。</li>
<li><strong>テストフレームワーク</strong>: Cargo test — Rustに標準で付属している強力なテストランナーです。テスト駆動開発には欠かせないツールですね。</li>
<li><strong>タスクランナー</strong>: cargo-make — 「同じ作業の繰り返しって退屈じゃないですか？」そんな反復的なタスクを自動化してくれます。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ？昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション0: 環境の構築で解説します。</p>
<h2 id="_4">要件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">ユーザーストーリー<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。
ユーザーストーリーには形式が定められておらず、標準的な記法もない。とはいえ、次のような形式でストーリーを考えてみると便利である。「＜ユーザーの種類＞として、＜機能や性能＞がほしい。それは＜ビジネス価値＞のためだ」という形のテンプレートに従うと、
たとえば次のようなストーリーを書ける。「本の購入者として、ＩＳＢＮで本を検索したい。それは探している本をすばやく見つけるためだ」</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう：</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜ん！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PCでプレイするなら必須ですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_6">ユースケース図<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>ユーザーストーリーを整理したところで、「これらの機能がどのように関連しているのか、全体像が見えるといいな」と思いませんか？そんなときに役立つのが「ユースケース図」です。
「ユースケース図って何？」と思われるかもしれませんね。ユースケース図は、システムと外部アクター（ここではプレイヤーとシステム自体）の相互作用を視覚的に表現するための図です。「絵に描いて整理すると分かりやすい」というやつですね。</p>
<blockquote>
<p>ユースケースは、システムの振る舞いに関する利害関係者の契約を表現するものです。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<p>「百聞は一見にしかず」というように、実際に見てみるのが一番分かりやすいですよね。では、私たちのぷよぷよゲームのユースケース図を見てみましょう：</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjU4OXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODI2cHg7aGVpZ2h0OjU4OXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgyNiA1ODkiIHdpZHRoPSI4MjZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU3NiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxNS4wNyIgeD0iMTEyIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1My45OTkzIiB4PSIzNDIuNTM1MyIgeT0iMjEuOTk1MSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MDc7JiMxMjQyNDsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfU3RhcnROZXdHYW1lIj48ZWxsaXBzZSBjeD0iMjE0LjAyNTkiIGN5PSI0NjkuOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMTUxLjAyNjIiIHk9IjQ3NC42NDM2Ij4mIzI2MDMyOyYjMTIzNzU7JiMxMjM1NjsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDM0OyYjMzgyODM7JiMyMjk4Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9SZXN0YXJ0R2FtZSI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iNTQwLjk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI1NDUuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQzNDsmIzEyNTIyOyYjMTI0NzM7JiMxMjQ3OTsmIzEyNTQwOyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1vdmVQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfTW92ZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjE5OS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNTguMDMyNyIgeT0iMjAzLjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMjQwMzg7JiMyMTQ5MTsmIzEyMzk1OyYjMzEyMjc7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUm90YXRlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfUm90YXRlUHV5byI+PGVsbGlwc2UgY3g9IjIxNC4wMjczIiBjeT0iMTMzLjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTc5LjAyNzQiIHk9IjEzNy42NTIxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzIyMjM4OyYjMzY1Nzg7PC90ZXh0PjwvZz48IS0tZW50aXR5IFF1aWNrRHJvcFB1eW8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X1F1aWNrRHJvcFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjY3LjAwMDUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3Mi4yNTI0IiByeT0iMTYuODUwNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjE1OC4wMzI3IiB5PSI3MS42NDg5Ij4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzMyMDMyOyYjMjYwODk7JiMxMjM2NzsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZhbGxQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZhbGxQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfRmFsbFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI1MiIgY3k9IjMyOS45OTUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI2Ni43MjUyIiByeT0iMTUuNzQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIxNjUuMDI1NCIgeT0iMzM0LjY0MzUiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMzMyNTg7JiMzMDAwMTsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEVyYXNlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJFcmFzZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9FcmFzZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI3MyIgY3k9IjI2NS4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjE3OS4wMjc0IiB5PSIyNjkuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyODA0MDsmIzIxNDM1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjI3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9DaGFpblJlYWN0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTIiIGN5PSIyNTYuOTk1IiBmaWxsPSIjRjFGMUYxIiByeD0iNjYuNzI1MiIgcnk9IjE1Ljc0NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMzg3LjAzNTQiIHk9IjI2MS42NDM1Ij4mIzM2ODk5OyYjMzc3ODI7JiMyMTQ1MzsmIzI0NTQwOyYjMTI0MzQ7JiMzMDMzMDsmIzI5OTgzOzwvdGV4dD48L2c+PCEtLWVudGl0eSBaZW5rZXNoaUJvbnVzLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ilplbmtlc2hpQm9udXMiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0iZW50MDAxMyIgaWQ9ImVudGl0eV9aZW5rZXNoaUJvbnVzIj48ZWxsaXBzZSBjeD0iNDM2LjA0MzEiIGN5PSIzMjYuOTk4NiIgZmlsbD0iI0YxRjFGMSIgcng9IjgzLjk5MzEiIHJ5PSIxOS4xOTg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iMzY2LjA0MzQiIHk9IjMzMS42NDcxIj4mIzIwODQwOyYjMjgwNDA7JiMxMjM3NTsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ5MDsmIzEyNDczOyYjMTI0MzQ7JiMyOTU1NDsmIzI0NDcxOzwvdGV4dD48L2c+PCEtLWVudGl0eSBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSIyOSIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJlbnRpdHlfRGlzcGxheVNjb3JlIj48ZWxsaXBzZSBjeD0iNjQxLjU1NDIiIGN5PSIyNTYuMDAyOCIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1OTkuNTU0NCIgeT0iMjYwLjY1MTMiPiYjMTI0NzM7JiMxMjQ2NzsmIzEyNDUwOyYjMTI0MzQ7JiMzNDkyMDsmIzMxMDM0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzNCIgZGF0YS11aWQ9ImVudDAwMTUiIGlkPSJlbnRpdHlfS2V5Ym9hcmRDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjA0MjQiIGN5PSIxMDAuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMzgwLjA0MjciIHk9IjEwNC42NDg5Ij4mIzEyNDYxOyYjMTI1NDA7JiMxMjUwODsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5MTsmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IEdhbWVPdmVyQ2hlY2stLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR2FtZU92ZXJDaGVjayIgZGF0YS1zb3VyY2UtbGluZT0iMzkiIGRhdGEtdWlkPSJlbnQwMDE2IiBpZD0iZW50aXR5X0dhbWVPdmVyQ2hlY2siPjxlbGxpcHNlIGN4PSIyMTQuMDI1OSIgY3k9IjM5OC45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIxNTEuMDI2MiIgeT0iNDAzLjY0MzYiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0NTg7JiMxMjU0MDsmIzEyNDk2OyYjMTI1NDA7JiMyMTAyODsmIzIzNDUwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBHYW1lT3ZlckFuaW1hdGlvbi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHYW1lT3ZlckFuaW1hdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iNDAiIGRhdGEtdWlkPSJlbnQwMDE3IiBpZD0iZW50aXR5X0dhbWVPdmVyQW5pbWF0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTkiIGN5PSIzOTguOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMzczLjAzNjIiIHk9IjQwMy42NDM2Ij4mIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDU4OyYjMTI1NDA7JiMxMjQ5NjsmIzEyNTQwOyYjMjg0MzY7JiMyMDk4Njs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUGxheWVyLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlBsYXllciIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJlbnRpdHlfUGxheWVyIj48ZWxsaXBzZSBjeD0iNDAuOTk5OCIgY3k9IjEzNi4zNSIgZmlsbD0iI0YxRjFGMSIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNDAuOTk5OCwxNDQuMzUgTDQwLjk5OTgsMTcxLjM1IE0yNy45OTk4LDE1Mi4zNSBMNTMuOTk5OCwxNTIuMzUgTTQwLjk5OTgsMTcxLjM1IEwyNy45OTk4LDE4Ni4zNSBNNDAuOTk5OCwxNzEuMzUgTDUzLjk5OTgsMTg2LjM1IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI2IiB5PSIyMDAuODQ1MSI+JiMxMjUwMzsmIzEyNTI0OyYjMTI0NTI7JiMxMjUxNjsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTeXN0ZW0tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImVudGl0eV9TeXN0ZW0iPjxlbGxpcHNlIGN4PSI3OTEuMDY5OSIgY3k9IjQzNi4zNSIgZmlsbD0iI0YxRjFGMSIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNzkxLjA2OTksNDQ0LjM1IEw3OTEuMDY5OSw0NzEuMzUgTTc3OC4wNjk5LDQ1Mi4zNSBMODA0LjA2OTksNDUyLjM1IE03OTEuMDY5OSw0NzEuMzUgTDc3OC4wNjk5LDQ4Ni4zNSBNNzkxLjA2OTksNDcxLjM1IEw4MDQuMDY5OSw0ODYuMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9Ijc2My4wNyIgeT0iNTAwLjg0NTEiPiYjMTI0NzE7JiMxMjQ3MzsmIzEyNDg2OyYjMTI1MTI7PC90ZXh0PjwvZz48IS0tbGluayBQbGF5ZXIgdG8gU3RhcnROZXdHYW1lLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSI0NSIgZGF0YS11aWQ9ImxuazE4IiBpZD0ibGlua19QbGF5ZXJfU3RhcnROZXdHYW1lIj48cGF0aCBkPSJNNTMuMDcsMjA0LjUgQzUzLjA3LDI4Ni4zIDUzLjA3LDQ3MCA1My4wNyw0NzAgQzUzLjA3LDQ3MCA4OC44OSw0NzAgMTI5LjksNDcwIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVN0YXJ0TmV3R2FtZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTM1LjksNDcwLDEyNi45LDQ2NiwxMzAuOSw0NzAsMTI2LjksNDc0LDEzNS45LDQ3MCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSZXN0YXJ0R2FtZSIgZGF0YS1zb3VyY2UtbGluZT0iNDYiIGRhdGEtdWlkPSJsbmsxOSIgaWQ9ImxpbmtfUGxheWVyX1Jlc3RhcnRHYW1lIj48cGF0aCBkPSJNMjkuMDcsMjA0LjM3IEMyOS4wNywyOTkuOTQgMjkuMDcsNTQxIDI5LjA3LDU0MSBDMjkuMDcsNTQxIDc5LjE4LDU0MSAxMjkuNTksNTQxIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJlc3RhcnRHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNTksNTQxLDEyNi41OSw1MzcsMTMwLjU5LDU0MSwxMjYuNTksNTQ1LDEzNS41OSw1NDEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIE1vdmVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iTW92ZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjQ3IiBkYXRhLXVpZD0ibG5rMjAiIGlkPSJsaW5rX1BsYXllcl9Nb3ZlUHV5byI+PHBhdGggZD0iTTc2LjQzLDE5My4xNSBDOTYuNCwxOTMuMTUgMTE2LjAzLDE5My4xNSAxMzkuNzUsMTkzLjE1IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLU1vdmVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDUuNzUsMTkzLjE1LDEzNi43NSwxODkuMTUsMTQwLjc1LDE5My4xNSwxMzYuNzUsMTk3LjE1LDE0NS43NSwxOTMuMTUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIFJvdGF0ZVB1eW8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSI0OCIgZGF0YS11aWQ9ImxuazIxIiBpZD0ibGlua19QbGF5ZXJfUm90YXRlUHV5byI+PHBhdGggZD0iTTc2LjQzLDE0MC45NyBDMTAzLjMyLDE0MC45NyAxMzQuNDgsMTQwLjk3IDE2My40LDE0MC45NyIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1Sb3RhdGVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNjkuNCwxNDAuOTcsMTYwLjQsMTM2Ljk3LDE2NC40LDE0MC45NywxNjAuNCwxNDQuOTcsMTY5LjQsMTQwLjk3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBRdWlja0Ryb3BQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iNDkiIGRhdGEtdWlkPSJsbmsyMiIgaWQ9ImxpbmtfUGxheWVyX1F1aWNrRHJvcFB1eW8iPjxwYXRoIGQ9Ik03Ni40NSwxMzQuNDEgQzEwOC45NSwxMzQuNDEgMTUyLjA3LDEzNC40MSAxNTIuMDcsMTM0LjQxIEMxNTIuMDcsMTM0LjQxIDE1Mi4wNywxMDAuNDkgMTUyLjA3LDgyLjA5IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVF1aWNrRHJvcFB1eW8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1Mi4wNyw3Ni4wOSwxNDguMDcsODUuMDksMTUyLjA3LDgxLjA5LDE1Ni4wNyw4NS4wOSwxNTIuMDcsNzYuMDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNTAiIGRhdGEtdWlkPSJsbmsyMyIgaWQ9ImxpbmtfUGxheWVyX0tleWJvYXJkQ29udHJvbCI+PHBhdGggZD0iTTQxLjA3LDEyNy40OSBDNDEuMDcsMTExLjcgNDEuMDcsOTcuMDUgNDEuMDcsOTcuMDUgQzQxLjA3LDk3LjA1IDI0NC42OSw5Ny4wNSAzNTguNTIsOTcuMDUiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjQuNTIsOTcuMDUsMzU1LjUyLDkzLjA1LDM1OS41Miw5Ny4wNSwzNTUuNTIsMTAxLjA1LDM2NC41Miw5Ny4wNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIEVyYXNlUHV5byB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRXJhc2VQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjUzIiBkYXRhLXVpZD0ibG5rMjQiIGlkPSJsaW5rX0VyYXNlUHV5b19TeXN0ZW0iPjxwYXRoIGQ9Ik0yNzIuODMsMjY1LjMyIEMzMDQuMjYsMjY1LjMyIDMzMi4wNywyNjUuMzIgMzMyLjA3LDI2NS4zMiBDMzMyLjA3LDI2NS4zMiAzMzIuMDcsNDM3LjUxIDMzMi4wNyw0MzcuNTEgQzMzMi4wNyw0MzcuNTEgNjYyLjYzLDQzNy41MSA3NjIuNyw0MzcuNTEiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjY2LjgzLDI2NS4zMiwyNzUuODMsMjY5LjMyLDI3MS44MywyNjUuMzIsMjc1LjgzLDI2MS4zMiwyNjYuODMsMjY1LjMyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRmFsbFB1eW8gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkZhbGxQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU0IiBkYXRhLXVpZD0ibG5rMjUiIGlkPSJsaW5rX0ZhbGxQdXlvX1N5c3RlbSI+PHBhdGggZD0iTTI4Ny4wNSwzMzAgQzMwNC4yOCwzMzAgMzEyLjA3LDMzMCAzMTIuMDcsMzMwIEMzMTIuMDcsMzMwIDMxMi4wNyw0NDIuMzQgMzEyLjA3LDQ0Mi4zNCBDMzEyLjA3LDQ0Mi4zNCA2NjAuMjEsNDQyLjM0IDc2Mi44OSw0NDIuMzQiIGZpbGw9Im5vbmUiIGlkPSJGYWxsUHV5by1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyODEuMDUsMzMwLDI5MC4wNSwzMzQsMjg2LjA1LDMzMCwyOTAuMDUsMzI2LDI4MS4wNSwzMzAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBDaGFpblJlYWN0aW9uIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJDaGFpblJlYWN0aW9uIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU1IiBkYXRhLXVpZD0ibG5rMjYiIGlkPSJsaW5rX0NoYWluUmVhY3Rpb25fU3lzdGVtIj48cGF0aCBkPSJNNTAzLjczLDI2My4zNSBDNTMwLjU5LDI2My4zNSA1NTAuMDcsMjYzLjM1IDU1MC4wNywyNjMuMzUgQzU1MC4wNywyNjMuMzUgNTUwLjA3LDQzMi42OCA1NTAuMDcsNDMyLjY4IEM1NTAuMDcsNDMyLjY4IDY5OS4zOCw0MzIuNjggNzYyLjk1LDQzMi42OCIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDk3LjczLDI2My4zNSw1MDYuNzMsMjY3LjM1LDUwMi43MywyNjMuMzUsNTA2LjczLDI1OS4zNSw0OTcuNzMsMjYzLjM1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgWmVua2VzaGlCb251cyB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iWmVua2VzaGlCb251cyIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NiIgZGF0YS11aWQ9ImxuazI3IiBpZD0ibGlua19aZW5rZXNoaUJvbnVzX1N5c3RlbSI+PHBhdGggZD0iTTUyNi4xOCwzMjcgQzYzMS4xNiwzMjcgNzkxLjA3LDMyNyA3OTEuMDcsMzI3IEM3OTEuMDcsMzI3IDc5MS4wNywzODYuNTEgNzkxLjA3LDQyNy42NSIgZmlsbD0ibm9uZSIgaWQ9Ilplbmtlc2hpQm9udXMtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTIwLjE4LDMyNyw1MjkuMTgsMzMxLDUyNS4xOCwzMjcsNTI5LjE4LDMyMyw1MjAuMTgsMzI3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRGlzcGxheVNjb3JlIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJEaXNwbGF5U2NvcmUiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTciIGRhdGEtdWlkPSJsbmsyOCIgaWQ9ImxpbmtfRGlzcGxheVNjb3JlX1N5c3RlbSI+PHBhdGggZD0iTTcwOS4zNywyNTYgQzc1NS42NywyNTYgODA1LjA3LDI1NiA4MDUuMDcsMjU2IEM4MDUuMDcsMjU2IDgwNS4wNywzNjYuODYgODA1LjA3LDQyNy40OCIgZmlsbD0ibm9uZSIgaWQ9IkRpc3BsYXlTY29yZS1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MDMuMzcsMjU2LDcxMi4zNywyNjAsNzA4LjM3LDI1Niw3MTIuMzcsMjUyLDcwMy4zNywyNTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckNoZWNrIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJHYW1lT3ZlckNoZWNrIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU4IiBkYXRhLXVpZD0ibG5rMjkiIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfU3lzdGVtIj48cGF0aCBkPSJNMjE0LjA3LDQyMy40OCBDMjE0LjA3LDQzNy4wNyAyMTQuMDcsNDQ3LjE3IDIxNC4wNyw0NDcuMTcgQzIxNC4wNyw0NDcuMTcgNjQ3LDQ0Ny4xNyA3NjIuODUsNDQ3LjE3IiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJDaGVjay1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMTQuMDcsNDE3LjQ4LDIxMC4wNyw0MjYuNDgsMjE0LjA3LDQyMi40OCwyMTguMDcsNDI2LjQ4LDIxNC4wNyw0MTcuNDgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckFuaW1hdGlvbiB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTkiIGRhdGEtdWlkPSJsbmszMCIgaWQ9ImxpbmtfR2FtZU92ZXJBbmltYXRpb25fU3lzdGVtIj48cGF0aCBkPSJNNTIwLjI4LDM5OSBDNjIwLjk2LDM5OSA3NzcuMDcsMzk5IDc3Ny4wNywzOTkgQzc3Ny4wNywzOTkgNzc3LjA3LDQxMi41MiA3NzcuMDcsNDI3LjQxIiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJBbmltYXRpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTE0LjI4LDM5OSw1MjMuMjgsNDAzLDUxOS4yOCwzOTksNTIzLjI4LDM5NSw1MTQuMjgsMzk5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIE1vdmVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNb3ZlUHV5byIgZGF0YS1lbnRpdHktMj0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2MiIgZGF0YS11aWQ9ImxuazMxIiBpZD0ibGlua19Nb3ZlUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yNzMuMDcsMTg5LjE2IEMyNzMuMDcsMTY2LjA2IDI3My4wNywxMTAuMjUgMjczLjA3LDExMC4yNSBDMjczLjA3LDExMC4yNSAzMjQuOSwxMTAuMjUgMzcxLjY3LDExMC4yNSIgZmlsbD0ibm9uZSIgaWQ9Ik1vdmVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc3LjY3LDExMC4yNSwzNjguNjcsMTA2LjI1LDM3Mi42NywxMTAuMjUsMzY4LjY3LDExNC4yNSwzNzcuNjcsMTEwLjI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjg2LjkxIiB5PSIxMjMuMzE2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBSb3RhdGVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSb3RhdGVQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjYzIiBkYXRhLXVpZD0ibG5rMzIiIGlkPSJsaW5rX1JvdGF0ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjE0LjA3LDExNy45OCBDMjE0LjA3LDExMC43NiAyMTQuMDcsMTAzLjY1IDIxNC4wNywxMDMuNjUgQzIxNC4wNywxMDMuNjUgMjk0LjI0LDEwMy42NSAzNTkuMiwxMDMuNjUiIGZpbGw9Im5vbmUiIGlkPSJSb3RhdGVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY1LjIsMTAzLjY1LDM1Ni4yLDk5LjY1LDM2MC4yLDEwMy42NSwzNTYuMiwxMDcuNjUsMzY1LjIsMTAzLjY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjIwLjQ3IiB5PSI5OS43MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFF1aWNrRHJvcFB1eW8gdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlF1aWNrRHJvcFB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNjQiIGRhdGEtdWlkPSJsbmszMyIgaWQ9ImxpbmtfUXVpY2tEcm9wUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yODAuMDcsNzQuMTYgQzI4MC4wNyw4MS4wNiAyODAuMDcsOTAuNDUgMjgwLjA3LDkwLjQ1IEMyODAuMDcsOTAuNDUgMzI1Ljg1LDkwLjQ1IDM2OS43NCw5MC40NSIgZmlsbD0ibm9uZSIgaWQ9IlF1aWNrRHJvcFB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNzUuNzQsOTAuNDUsMzY2Ljc0LDg2LjQ1LDM3MC43NCw5MC40NSwzNjYuNzQsOTQuNDUsMzc1Ljc0LDkwLjQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzIwLjc2IiB5PSI4Ni41MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIEVyYXNlUHV5byB0byBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkVyYXNlUHV5byIgZGF0YS1lbnRpdHktMj0iQ2hhaW5SZWFjdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iNjciIGRhdGEtdWlkPSJsbmszNCIgaWQ9ImxpbmtfRXJhc2VQdXlvX0NoYWluUmVhY3Rpb24iPjxwYXRoIGQ9Ik0yNjAuNTcsMjU3LjkgQzI5Mi4xLDI1Ny45IDMyOC4yNiwyNTcuOSAzNjMuMzUsMjU3LjkiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tdG8tQ2hhaW5SZWFjdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY5LjM1LDI1Ny45LDM2MC4zNSwyNTMuOSwzNjQuMzUsMjU3LjksMzYwLjM1LDI2MS45LDM2OS4zNSwyNTcuOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjI1MC45NiIgeT0iMjUzLjk2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIENoYWluUmVhY3Rpb24gdG8gRGlzcGxheVNjb3JlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkNoYWluUmVhY3Rpb24iIGRhdGEtZW50aXR5LTI9IkRpc3BsYXlTY29yZSIgZGF0YS1zb3VyY2UtbGluZT0iNjgiIGRhdGEtdWlkPSJsbmszNSIgaWQ9ImxpbmtfQ2hhaW5SZWFjdGlvbl9EaXNwbGF5U2NvcmUiPjxwYXRoIGQ9Ik00OTMuNTYsMjQ4LjY1IEM1MjMuMDEsMjQ4LjY1IDU1Mi42NSwyNDguNjUgNTgxLjU4LDI0OC42NSIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tdG8tRGlzcGxheVNjb3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1ODcuNTgsMjQ4LjY1LDU3OC41OCwyNDQuNjUsNTgyLjU4LDI0OC42NSw1NzguNTgsMjUyLjY1LDU4Ny41OCwyNDguNjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1NDEuNTciIHk9IjI0NC43MTY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBaZW5rZXNoaUJvbnVzIHRvIERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJaZW5rZXNoaUJvbnVzIiBkYXRhLWVudGl0eS0yPSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9IjY5IiBkYXRhLXVpZD0ibG5rMzYiIGlkPSJsaW5rX1plbmtlc2hpQm9udXNfRGlzcGxheVNjb3JlIj48cGF0aCBkPSJNNTE0LjA3LDMxOS42NyBDNTE0LjA3LDMwMS41MyA1MTQuMDcsMjU2IDUxNC4wNywyNTYgQzUxNC4wNywyNTYgNTQxLjE5LDI1NiA1NzMuNjgsMjU2IiBmaWxsPSJub25lIiBpZD0iWmVua2VzaGlCb251cy10by1EaXNwbGF5U2NvcmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU3OS42OCwyNTYsNTcwLjY4LDI1Miw1NzQuNjgsMjU2LDU3MC42OCwyNjAsNTc5LjY4LDI1NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjUxNi4wNCIgeT0iMjY5LjA2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIEdhbWVPdmVyQ2hlY2sgdG8gR2FtZU92ZXJBbmltYXRpb24tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJDaGVjayIgZGF0YS1lbnRpdHktMj0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtc291cmNlLWxpbmU9IjcwIiBkYXRhLXVpZD0ibG5rMzciIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfR2FtZU92ZXJBbmltYXRpb24iPjxwYXRoIGQ9Ik0yOTIuMywzOTkgQzMxMy41MiwzOTkgMzMwLjUsMzk5IDM1MS43MywzOTkiIGZpbGw9Im5vbmUiIGlkPSJHYW1lT3ZlckNoZWNrLXRvLUdhbWVPdmVyQW5pbWF0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNTcuNzMsMzk5LDM0OC43MywzOTUsMzUyLjczLDM5OSwzNDguNzMsNDAzLDM1Ny43MywzOTkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIyNjEuMDEiIHk9IjQxMi4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tU1JDPVtiTEpUSlhEMTZCdFZmelhtdXJMdjA0RDg1OUdCZW9CU1VKVGtudFJKeEt3cEVxS1JHczl0MUllOEQxTlJBQVkwb0EtWVcxNmJfM3BDVEJoak1wV3BJeFNwNTU5Q0RmbERWRVZpVHh1cFB5UTJKeDZFYVV3T1lJSk11d08zM01tWU10REpmZnExM2FaaDZNMmFHMEFFdWZtNVRMdTZUaUEyNGkwb1JPWHA2UVdaMW9VSGZqdEdZUlRBbDFfNEVvRi1DU2RscWpxRm1VY00xV29DN0JzNy0xTllWb0ZVNmw3UFN6b1owclNWamEwRUVYNzJFb0pVTi05RjRkelBiNFRwQmVQZkpPa3dDcW9VT0doZFJzLVZEX0FOTFU4QjNRQzRuNGRlaTR5a3dYbUx4QXU0blNiY1VSTnZ5V2pKSF9ucmxpdnV0Ynh1ZU1MVFEwMk5UUWNOVnY5eVhVSFZJSXJBcFY4Q3RQVzlYTTdXdTBWbXNIMThtcFBCMVhEX01fblFNRTROMTZpNGtmbWRJRUZRMVBMWWVsaFJzVGg5cWhLYWpZbWVxU0RyRWR6MHlabDFIZk5FbDFFVHhnQ25FOXBEZVNsV1l2eVFyVExHM3k4ME51S0JWWXROQXJpYUZ6eWVkakotWDZDX29mZjZRajExNlM3ZjYyNFFseE5KX3BUOE9zZXhNRFlKc2pxNWJkTTVrbGhsMGZzaDJqR1RYdkxLNjZsUWQybEotTGJ3amlIN1VOeUtCN21NdTg0YUNFcUgyQ0FtSG1Hd2lTZC1vQlZTTm44cEowa2pmTTFzZHZ2TTFGQ25qNUZHSlBndGFQcnJ2SnJkazBDSF81OVpQSkRPRW5CZUdURkRpNm9GNmlaZnQ2aXd5UExFQnJ4RjdFLXhxMUVnVWF0bzZzNTRIOUR4Q0ZTNDBJUy1XNnBpOEVrSTNNYVZZc2pzWW1BeUJKd0F4NHFCUS1tV1l1T3lrR183ZTNFR1g0UWcyd3ItbDQyZFpYSlFCVGpDMHM3eUVEVkExQWZOMGJDTm9qSjJVcTZGblZoTGVvUWpvdVQ5TWV3SUJxRlJFUFRNckoxQlhPa3NOZDJvaEo5QWRqdU5ZeEtrZ3JQZXZKS2JUTjkxMlBMU2FGQ1pob2l4UzVhWHliV2t5aW96Y1EzNTdJUXlUa1BmQlBGcXRqd0VTVk1SVWJ5VlY4d1g3VV9scnpoTVRTU2dYZFE3WXFsbDh0RXBMWXM3ZGQ5ZlJLX3YzckpaRURzcTNJaVJYdW9sclpYUUNLcTVncVB0MFFpY1N0MmRrbWhaN20wMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p>この図を見ると、プレイヤーとシステムの役割分担がよくわかりますね。プレイヤーはゲームの開始や操作を担当し、システムはぷよの消去判定やスコア計算などの内部処理を担当しています。また、キーボード操作は「拡張（extend）」関係にあり、ぷよの移動や回転などの基本操作を入力方法で実現していることがわかります。</p>
<p>このようにユースケース図を作成することで、システムの全体像を把握し、実装すべき機能の関連性を明確にすることができます。それでは、実際のコード実装に進んでいきましょう！</p>
<p>誤解しないでもらいたいのですが本来ユースケースとはテキストで記述するものでありユースケース図は概要を把握するための手段に過ぎないということです。</p>
<blockquote>
<p>楕円、矢印、人型おアイコンから構成されているUMLのユースケース図は、ユースケースを把握するための表記法ではありません。
楕円や矢印は、ユースケースをのパッケージや分解を表すもので、内容を表すものではありません。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<h2 id="_7">リリース計画<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>要件もわかった、プログラミング開始だ！ちょっと待ってください、何事も計画を立てる事は大事なことです。ユースケース図を見てください、結構いろんなことがありますよね。何から取り組みますか？
「スコアの表示」ですか？「ゲームオーバー判定」ですか？でもまずは「新しいゲームを開始」しないとつながりとして難しいですよね。もちろん実際にプログラミングしながら順番を考えてもいいですけど間違った順番で進めると直すのが大変ですよね。
それにこれからどんなものを作るのかは事前にある程度イメージを固めておきたいものです（いきなり「ゲームオーバー」になるゲームはやりたくないですよね）。</p>
<blockquote>
<p>計画づくりとは「なにをいつまでに作ればいいのか？」という質問に答える作業だと私は考えている</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>今回の目的はぷよぷよゲームを遊べるための最小限の機能の実装です。目的を実現するためにやるべきことをイテレーションという単位でまとめましょう。「全部やること洗い出すの？そんな先のことはわからないよ！」と思いますよね。安心してください今決めることは大まかな作業の流れと前後関係の整理だけです。
細かい部分は各イテレーションでおいおい明確になってきます。その手助けをしてくれるのがテスト駆動開発なのです。</p>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>今回はユーザーストーリーとユースケース図から以下のイテレーション計画に従ってぷよぷよゲームをリリースします。</p>
<ul>
<li>イテレーション1: ゲーム開始の実装</li>
<li>イテレーション2: ぷよの移動の実装</li>
<li>イテレーション3: ぷよの回転の実装</li>
<li>イテレーション4: ぷよの自由落下の実装</li>
<li>イテレーション5: ぷよの高速落下の実装</li>
<li>イテレーション6: ぷよの消去の実装</li>
<li>イテレーション7: 連鎖反応の実装</li>
<li>イテレーション8: 全消しボーナスの実装</li>
<li>イテレーション9: ゲームオーバーの実装</li>
</ul>
<p>では、ぷよぷよゲーム開発スタートです！</p>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>...と言いたいところですがまずは環境の構築をしなければなりません。「プログラミングなんてどの言語でやるか決めるぐらいでしょ？」と思うかもしれませんが家を建てるときにしっかりとした基礎工事が必要なように開発環境もしっかりとした準備が必要です。
家を建てた後に基礎がダメだと困ったことになりますからね。</p>
<h3 id="_8">ソフトウェア開発の三種の神器<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本章では開発環境のセットアップとして、これら三種の神器を準備していきます。環境構築は退屈に感じるかもしれませんが、これらのツールがあることで、安心してコードを書くことができるようになります。一緒に進めていきましょう！</p>
<h3 id="git">バージョン管理: Gitとコミットメッセージ<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>バージョン管理システムとして Git を使います。Git については既に使用していると仮定しますが、コミットメッセージについて1つだけ重要なルールを確認しておきましょう。</p>
<h4 id="_9">コミットメッセージの書き方<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>私たちのプロジェクトでは、<a href="https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#type">Angularルール</a>の書式に従ってコミットメッセージを書きます。具体的には、それぞれのコミットメッセージはヘッダ、ボディ、フッタで構成されます。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p>ヘッダは必須で、スコープは任意です。コミットメッセージのタイトルは50文字までにしましょう（GitHub上で読みやすくなります）。</p>
<p>コミットのタイプは次を用います：</p>
<ul>
<li><strong>feat</strong>: 新しい機能（A new feature）</li>
<li><strong>fix</strong>: バグ修正（A bug fix）</li>
<li><strong>docs</strong>: ドキュメント変更のみ（Documentation only changes）</li>
<li><strong>style</strong>: コードに影響を与えない変更（white-space, formatting, missing semi-colons, etc）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更（A code change that neither fixes a bug nor adds a feature）</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更（A code change that improves performance）</li>
<li><strong>test</strong>: テストの追加や修正（Adding missing or correcting existing tests）</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更（Changes to the build process or auxiliary tools and libraries）</li>
</ul>
<p>例えば：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化機能を追加&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: メソッドの抽出&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよ消去のテストケースを追加&#39;</span>
</code></pre></div>
<p>コミットメッセージにつけるプリフィックスに関しては <a href="https://qiita.com/numanomanu/items/45dd285b286a1f7280ed">【今日からできる】コミットメッセージに 「プレフィックス」をつけるだけで、開発効率が上がった話</a>を参照ください。</p>
<h3 id="_10">テスティング: パッケージマネージャとテスト環境<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>良いコードを書くためには、コードが正しく動作することを確認するテストが欠かせません。そのためのツールをセットアップしていきましょう。</p>
<h4 id="cargo">パッケージマネージャ: Cargo<a class="headerlink" href="#cargo" title="Permanent link">&para;</a></h4>
<p>外部ライブラリやツールを管理するために <strong>Cargo</strong> を使います。</p>
<blockquote>
<p>Cargoとは、Rustで記述されたサードパーティ製のライブラリ（クレート）を管理するためのツールで、Rustエコシステムの中核を担っています。RubyのBundlerやRubyGemsに相当する機能を提供します。</p>
<p>—  The Rust Programming Language</p>
</blockquote>
<p><strong>Cargo</strong> はRustの標準的なパッケージマネージャとして、プロジェクトの初期化から依存関係の管理まで一貫して行えます。</p>
<p>まず、新しいプロジェクトを作成します：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>init<span class="w"> </span>--name<span class="w"> </span>puyo_puyo_game
</code></pre></div>
<p>これで <code>Cargo.toml</code> が作成されます。このファイルでプロジェクトの依存関係を管理します：</p>
<div class="highlight"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;puyo_puyo_game&quot;</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2021&quot;</span>

<span class="k">[dependencies]</span>
<span class="n">macroquad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.4&quot;</span>

<span class="k">[dev-dependencies]</span>
</code></pre></div>
<p>必要なクレートをインストールするには：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>add<span class="w"> </span>macroquad
</code></pre></div>
<p>これで、ゲーム開発に必要なライブラリがインストールされます。</p>
<blockquote>
<p>Cargo.tomlとは、作成したアプリケーションがどのクレートに依存しているか、そしてインストールしているバージョンはいくつかという情報を管理するためのファイルです。Cargo.lockはバージョンの固定化を行います。</p>
<p>—  The Rust Programming Language</p>
</blockquote>
<p><strong>Cargo</strong> を使ってクレートを管理しましょう。開発用マシンを変えた時にも同じコマンド <code>cargo build</code> を実行するだけで、必要な依存関係が自動的にインストールされます。便利ですよね！</p>
<h3 id="_11">自動化: コード品質の自動管理<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質を自動的にチェックし、維持していく仕組みが必要です。ここでは、静的コード解析、コードフォーマット、コードカバレッジ、そしてタスクランナーを設定します。</p>
<h4 id="clippy">静的コード解析: Clippy<a class="headerlink" href="#clippy" title="Permanent link">&para;</a></h4>
<p>静的コード解析ツールとして <strong>Clippy</strong> を使います。Clippyは、コードを実行せずに潜在的な問題を検出するツールです。</p>
<blockquote>
<p>Clippyとは、Rust用の静的コード解析ツールで、コードの品質を向上させるための警告やヒントを提供します。</p>
<p>—  Clippy Documentation</p>
</blockquote>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>clippy
</code></pre></div>
<p>このコマンドを実行すると、コードスタイルやベストプラクティスに違反している箇所が指摘されます。より厳格なチェックを行うには：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>clippy<span class="w"> </span>--<span class="w"> </span>-D<span class="w"> </span>warnings
</code></pre></div>
<p>警告レベルをエラーとして扱うことで、より厳格なコード品質を維持できます。</p>
<p>プロジェクトのルートに <code>clippy.toml</code> を作成して、Clippyの設定をカスタマイズできます。サイクロマティック複雑度を7に設定します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># clippy.toml</span>
<span class="n">cognitive-complexity-threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span>
</code></pre></div>
<p>「サイクロマティック複雑度って何ですか？」良い質問ですね。サイクロマティック複雑度は、コードの複雑さを測る指標です。if文、ループ、match文などの分岐が多いほど値が大きくなります。複雑度が高いとテストが書きにくく、バグが混入しやすくなります。7という値は、「これ以上複雑になったら関数を分割しましょう」という目安です。</p>
<blockquote>
<p>循環的複雑度（Cyclomatic complexity、CC）は、プログラムの複雑さを測るソフトウェア測定法のひとつである。1976年にトーマス・J・マッケイブによって開発された。</p>
<p>— Wikipedia 『循環的複雑度』</p>
</blockquote>
<h4 id="rustfmt">コードフォーマッタ: rustfmt<a class="headerlink" href="#rustfmt" title="Permanent link">&para;</a></h4>
<p>コードのフォーマットを統一するために <strong>rustfmt</strong> を使います。</p>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>—  リーダブルコード</p>
</blockquote>
<p>フォーマットの自動修正は以下のコマンドで実行できます：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>fmt
</code></pre></div>
<p>フォーマットのチェックのみ（修正しない）を行うには：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>fmt<span class="w"> </span>--<span class="w"> </span>--check
</code></pre></div>
<p>フォーマットの設定は <code>rustfmt.toml</code> ファイルで細かくカスタマイズできます。</p>
<h4 id="cargo-tarpaulin">コードカバレッジ: cargo-tarpaulin<a class="headerlink" href="#cargo-tarpaulin" title="Permanent link">&para;</a></h4>
<p>テストがコードのどれだけをカバーしているかを確認するために、<strong>cargo-tarpaulin</strong> を使います。</p>
<blockquote>
<p>コード網羅率（コードもうらりつ、英: Code coverage）は、ソフトウェアテストで用いられる尺度の1つである。プログラムのソースコードがテストされた割合を意味する。</p>
</blockquote>
<p>まず、cargo-tarpaulinをインストールします：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>install<span class="w"> </span>cargo-tarpaulin
</code></pre></div>
<p>カバレッジレポートを生成するには：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>tarpaulin<span class="w"> </span>--out<span class="w"> </span>Html
</code></pre></div>
<p>実行後、<code>coverage</code> フォルダ内の <code>index.html</code> を開くと、視覚的にカバレッジ状況を確認できます。</p>
<p>設定ファイル <code>tarpaulin.toml</code> を作成して、カバレッジの設定をカスタマイズすることもできます：</p>
<div class="highlight"><pre><span></span><code><span class="k">[run]</span>
<span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Html&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Lcov&quot;</span><span class="p">]</span>
</code></pre></div>
<h4 id="cargo-make">タスクランナー: cargo-make<a class="headerlink" href="#cargo-make" title="Permanent link">&para;</a></h4>
<p>複数のコマンドを覚えるのは大変です。タスクランナーの <strong>cargo-make</strong> を使って、よく使うコマンドをタスクとして登録し、簡単に実行できるようにします。</p>
<blockquote>
<p>cargo-makeは、Rust開発者向けのタスクランナーです。プロジェクト固有のタスクを定義し、複雑なワークフローを自動化できます。TOMLファイルでタスクを設定し、条件分岐やクロスプラットフォーム対応も可能です。</p>
</blockquote>
<p>まず、cargo-makeをインストールします：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>install<span class="w"> </span>cargo-make
</code></pre></div>
<p><code>Makefile.toml</code> を作成し、以下のように設定します：</p>
<div class="highlight"><pre><span></span><code><span class="k">[config]</span>
<span class="n">default_to_workspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="c1"># テストタスク</span>
<span class="k">[tasks.test]</span>
<span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo&quot;</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>

<span class="c1"># テストカバレッジタスク</span>
<span class="k">[tasks.coverage]</span>
<span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo&quot;</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;tarpaulin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--out&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Html&quot;</span><span class="p">]</span>

<span class="c1"># 静的コード解析タスク</span>
<span class="k">[tasks.lint]</span>
<span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo&quot;</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;clippy&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-D&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span>

<span class="c1"># コードフォーマットタスク</span>
<span class="k">[tasks.format]</span>
<span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo&quot;</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">]</span>

<span class="c1"># フォーマットチェックタスク</span>
<span class="k">[tasks.format-check]</span>
<span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo&quot;</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--check&quot;</span><span class="p">]</span>

<span class="c1"># ビルドタスク</span>
<span class="k">[tasks.build]</span>
<span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo&quot;</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;build&quot;</span><span class="p">]</span>

<span class="c1"># 実行タスク</span>
<span class="k">[tasks.run]</span>
<span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo&quot;</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]</span>

<span class="c1"># 全体チェックタスク（自動修正付き）</span>
<span class="k">[tasks.check-all]</span>
<span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="p">]</span>

<span class="c1"># 全体チェックタスク（自動修正なし）</span>
<span class="k">[tasks.verify]</span>
<span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;format-check&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="p">]</span>

<span class="c1"># ウォッチタスク（ファイル変更を監視して自動実行）</span>
<span class="k">[tasks.watch]</span>
<span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo&quot;</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;watch&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-x&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-x&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;clippy&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-x&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fmt&quot;</span><span class="p">]</span>
<span class="n">install_crate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cargo-watch&quot;</span>

<span class="c1"># デフォルトタスク</span>
<span class="k">[tasks.default]</span>
<span class="n">alias</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;test&quot;</span>
</code></pre></div>
<p>登録されたタスクを確認するには：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>make<span class="w"> </span>--list-all-steps
</code></pre></div>
<p>特定のタスクを実行するには：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>make<span class="w"> </span><span class="nb">test</span><span class="w">        </span><span class="c1"># テスト実行</span>
cargo<span class="w"> </span>make<span class="w"> </span>lint<span class="w">        </span><span class="c1"># 静的解析</span>
cargo<span class="w"> </span>make<span class="w"> </span>format<span class="w">      </span><span class="c1"># フォーマット</span>
cargo<span class="w"> </span>make<span class="w"> </span>check-all<span class="w">   </span><span class="c1"># 全体チェック（自動修正付き）</span>
cargo<span class="w"> </span>make<span class="w"> </span>verify<span class="w">      </span><span class="c1"># 全体チェック（自動修正なし）</span>
</code></pre></div>
<h4 id="cargo-watch">タスクの自動実行: cargo-watch<a class="headerlink" href="#cargo-watch" title="Permanent link">&para;</a></h4>
<p>ファイルを編集するたびに手動でコマンドを実行するのは面倒です。<strong>cargo-watch</strong> を使って、ファイルの変更を検知して自動的にテストやフォーマットを実行できるようにします。</p>
<p>まず、cargo-watchをインストールします：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>install<span class="w"> </span>cargo-watch
</code></pre></div>
<p>ウォッチモードを起動するには：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>make<span class="w"> </span>watch
</code></pre></div>
<p>このコマンドを実行すると、ファイルを保存するたびに自動的に以下が実行されます：</p>
<ol>
<li>テストの実行</li>
<li>Clippyによる静的解析</li>
<li>rustfmtによるフォーマット</li>
</ol>
<p>「保存するだけで自動的にチェックしてくれるなんて便利！」と思いませんか？これで開発中に品質を維持しやすくなりますね。</p>
<h3 id="_12">プロジェクト構成<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>最後に、プロジェクトのフォルダ構成を確認しておきましょう：</p>
<div class="highlight"><pre><span></span><code>puyo_puyo_game/
├── src/
│   ├── main.rs           # エントリーポイント
│   ├── lib.rs            # ライブラリのルート
│   ├── board.rs          # ボード（盤面）モジュール
│   ├── puyo.rs           # ぷよモジュール
│   ├── puyo_pair.rs      # ぷよペアモジュール
│   └── game_logic.rs     # ゲームロジックモジュール
├── tests/
│   └── integration_test.rs  # 統合テスト
├── Cargo.toml            # プロジェクト設定
├── Makefile.toml         # タスク定義
├── clippy.toml           # Clippy設定（複雑度チェック）
├── tarpaulin.toml        # カバレッジ設定
└── rustfmt.toml          # フォーマット設定
</code></pre></div>
<p>「モジュールって何？」と思われるかもしれませんね。Rustでは、コードを小さな部品（モジュール）に分割して管理します。これにより、コードの見通しが良くなり、テストも書きやすくなるんです。</p>
<h3 id="_13">セットアップの確認<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>環境構築が完了したら、すべてが正しく動作するか確認しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># すべてのチェックを実行</span>
cargo<span class="w"> </span>make<span class="w"> </span>check-all
</code></pre></div>
<p>このコマンドが成功すれば、環境構築は完了です！「やった！これで開発の準備が整いましたね！」</p>
<p>セットアップが完了したので、ここで最初のコミットをしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: プロジェクトの初期セットアップ&#39;</span>
</code></pre></div>
<h3 id="0_1">イテレーション0のまとめ<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで準備した内容：</p>
<ol>
<li><strong>バージョン管理</strong></li>
<li>Gitのセットアップ</li>
<li>
<p>コミットメッセージ規約（Angularルール）</p>
</li>
<li>
<p><strong>テスティング環境</strong></p>
</li>
<li>Cargo（パッケージマネージャ）</li>
<li>macroquad（ゲームフレームワーク）</li>
<li>
<p>標準テストフレームワーク</p>
</li>
<li>
<p><strong>自動化ツール</strong></p>
</li>
<li>Clippy（静的コード解析、サイクロマティック複雑度7に設定）</li>
<li>rustfmt（コードフォーマッタ）</li>
<li>cargo-tarpaulin（コードカバレッジ）</li>
<li>cargo-make（タスクランナー）</li>
<li>
<p>cargo-watch（ファイル監視）</p>
</li>
<li>
<p><strong>プロジェクト構成</strong></p>
</li>
<li>モジュール構造の設計</li>
<li>設定ファイルの準備（clippy.toml、tarpaulin.toml、rustfmt.toml、Makefile.toml）</li>
</ol>
<h3 id="_14">学んだこと<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ソフトウェア開発の三種の神器</strong>: バージョン管理、テスティング、自動化の重要性</li>
<li><strong>Rustエコシステム</strong>: Cargo、Clippy、rustfmtなどの標準ツール</li>
<li><strong>タスク自動化</strong>: 反復的な作業を自動化してミスを減らす</li>
<li><strong>品質維持</strong>: 静的解析とフォーマットでコードの品質を保つ</li>
<li><strong>複雑度管理</strong>: サイクロマティック複雑度を7に制限することで、テスタブルで保守しやすいコードを維持</li>
</ul>
<p>「準備完了！これから本格的にぷよぷよゲームを作っていきますよ！」</p>
<p>次のイテレーションでは、ゲーム開始の実装に進みます！</p>
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_15">ユーザーストーリー<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ゲームの初期化処理を実装する（ゲームの状態や必要なコンポーネントを設定する）</li>
<li>ゲーム画面を表示する（プレイヤーが視覚的にゲームを認識できるようにする）</li>
<li>ゲームウィンドウを作成する（macroquadでウィンドウを開く）</li>
<li>ゲームループを開始する（ゲームの継続的な更新と描画を行う）</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ゲームの初期化処理」から始めましょう！</p>
<h3 id="_16">テスト: ゲームの初期化<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「ゲームの初期化処理を実装する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ゲームの初期化処理をテストするコードを書いてみましょう。何をテストすべきでしょうか？ゲームが初期化されたとき、必要なコンポーネントが正しく作成され、ゲームの状態が適切に設定されていることを確認する必要がありますね。</p>
<p>Rustでは、ユニットテストは各ソースファイルの末尾に <code>#[cfg(test)]</code> モジュールとして配置するのが作法です。まず、モジュール構成を定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/lib.rs</span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">game</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">board</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">puyo</span><span class="p">;</span>
</code></pre></div>
<p>次に、<code>src/game.rs</code> の末尾にテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/game.rs</span>
<span class="c1">// （実装部分は後述）</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_game_initialization</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">mode</span><span class="p">(),</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Start</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">chain_count</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_game_has_board</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">board</span><span class="p">().</span><span class="n">is_some</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、<code>Game</code>構造体の<code>new</code>メソッドが正しく動作することを確認しています。具体的には、ゲームモードが<code>Start</code>に設定され、スコアと連鎖カウントが0で初期化されることを検証しています。</p>
<p><strong>Rustのテスト配置作法</strong>：
- <strong>ユニットテスト</strong>: 各ソースファイル（<code>src/game.rs</code>など）の末尾に <code>#[cfg(test)]</code> モジュールとして配置
- <strong>統合テスト</strong>: <code>tests/</code> ディレクトリにファイルを作成（モジュール間の連携をテスト）
- <code>use super::*;</code> で親モジュールの要素をインポート</p>
<h3 id="_17">実装: ゲームの初期化<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>error[E0433]: failed to resolve: could not find `game` in `puyo_puyo_game`
</code></pre></div>
<p>おっと！まだ<code>game</code>モジュールを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<blockquote>
<p>アサートファースト</p>
<p>ではテストはどこから書き始めるべきだろうか。それはテストの終わりにパスすべきアサーションを書くところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストが通るように最小限のコードを実装していきましょう。「最小限」というのがポイントです。この段階では、テストが通ることだけを目指して、必要最低限のコードを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/game.rs</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">board</span><span class="p">::</span><span class="n">Board</span><span class="p">;</span>

<span class="cp">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Start</span><span class="p">,</span>
<span class="w">    </span><span class="n">Playing</span><span class="p">,</span>
<span class="w">    </span><span class="n">Checking</span><span class="p">,</span>
<span class="w">    </span><span class="n">Erasing</span><span class="p">,</span>
<span class="w">    </span><span class="n">Falling</span><span class="p">,</span>
<span class="w">    </span><span class="n">GameOver</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="nc">GameMode</span><span class="p">,</span>
<span class="w">    </span><span class="n">score</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">chain_count</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Board</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="nc">GameMode</span><span class="p">::</span><span class="n">Start</span><span class="p">,</span>
<span class="w">            </span><span class="n">score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">chain_count</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">)),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">mode</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">chain_count</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">chain_count</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">board</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">Board</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Default</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">default</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/board.rs</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cols</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">rows</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">cols</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">rows</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cols</span><span class="p">,</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">cols</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">cols</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rows</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rows</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/lib.rs</span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">game</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">board</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">puyo</span><span class="p">;</span>
</code></pre></div>
<h3 id="_18">解説: ゲームの初期化<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 2 tests
test tests::test_game_initialization ... ok
test tests::test_game_has_board ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>実装したゲームの初期化処理について、少し解説しておきましょう。この処理では、主に以下のことを行っています：</p>
<ol>
<li>ゲームモードを<code>GameMode::Start</code>に設定</li>
<li>スコアと連鎖カウントを0で初期化</li>
<li>ボード（盤面）を6列12行で作成</li>
</ol>
<p>これにより、ゲームを開始するための準備が整います。各コンポーネントの役割を理解しておくと、今後の実装がスムーズになりますよ：</p>
<ul>
<li><strong>GameMode</strong>: ゲームの状態を管理します（Start, Playing, Checking, Erasing, Falling, GameOver）</li>
<li><strong>Board</strong>: ゲームのステージ（盤面）を管理します（ぷよの配置状態、消去判定など）</li>
<li><strong>score</strong>: スコアを管理します（連鎖数に応じたスコア計算など）</li>
<li><strong>chain_count</strong>: 連鎖カウントを管理します</li>
</ul>
<p>このように、責任を明確に分けることで、コードの保守性が高まります。これはオブジェクト指向設計の基本原則の一つ、「単一責任の原則」に従っています。</p>
<blockquote>
<p>単一責任の原則（SRP）：クラスを変更する理由は1つだけであるべき。</p>
<p>— Robert C. Martin 『Clean Architecture』</p>
</blockquote>
<h3 id="_19">実装: ゲームウィンドウとループ<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>次に、macroquadを使ってゲームウィンドウとゲームループを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main.rs</span>
<span class="k">use</span><span class="w"> </span><span class="n">macroquad</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">puyo_puyo_game</span><span class="p">::</span><span class="n">game</span><span class="p">::</span><span class="n">Game</span><span class="p">;</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">window_conf</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Conf</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Conf</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">window_title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Puyo Puyo Game&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span>
<span class="w">        </span><span class="n">window_width</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span>
<span class="w">        </span><span class="n">window_height</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span>
<span class="w">        </span><span class="o">..</span><span class="nb">Default</span><span class="p">::</span><span class="n">default</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[macroquad::main(window_conf)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">clear_background</span><span class="p">(</span><span class="n">BLACK</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ゲームの更新処理（次のイテレーションで実装）</span>

<span class="w">        </span><span class="c1">// ゲームの描画処理（次のイテレーションで実装）</span>
<span class="w">        </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;Puyo Puyo Game&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">120.0</span><span class="p">,</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>
<span class="w">        </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;Press Space to Start&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">90.0</span><span class="p">,</span><span class="w"> </span><span class="mf">300.0</span><span class="p">,</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span><span class="w"> </span><span class="n">GRAY</span><span class="p">);</span>

<span class="w">        </span><span class="n">next_frame</span><span class="p">().</span><span class="k">await</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_20">解説: ゲームウィンドウとループ<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>さて、今回実装した「ゲームウィンドウとループ」について少し詳しく解説しましょう。「ゲームループって何？」と思われるかもしれませんね。</p>
<p>ゲームループは、その名の通り、ゲームの状態を更新し、画面を描画するための繰り返し処理なんです。心臓がずっと鼓動を続けるように、このループが継続的に実行されることで、ゲームが生き生きと動き続けるんですよ。</p>
<p>ここで使っている<code>#[macroquad::main]</code>というマクロ、これがとても便利なんです！「どう便利なの？」というと、ゲームウィンドウの作成やイベントループの管理を自動的にやってくれるんです。これによって、私たちはゲームロジックに集中できるんですよ。</p>
<p>コードを見てみると、<code>loop</code>ブロック内で以下の処理を行っています：</p>
<ol>
<li><strong>clear_background(BLACK)</strong>: 画面を黒でクリア</li>
<li><strong>ゲームの更新処理</strong>: 現時点ではコメントアウト（次のイテレーションで実装）</li>
<li><strong>ゲームの描画処理</strong>: タイトルとメッセージを表示</li>
<li><strong>next_frame().await</strong>: 次のフレームまで待機</li>
</ol>
<p><code>next_frame().await</code>という記述は、「次の描画タイミングまで待ってね」という指示なんです。これによって、スムーズなアニメーションが可能になるんですよ。</p>
<p>また、<code>window_conf()</code>関数でウィンドウの設定を行っています。ここでウィンドウのタイトルやサイズを指定できるんです。</p>
<p>このゲームループが基盤となって、これから様々な機能を追加していきますよ！</p>
<h3 id="_21">画面の確認<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>ではここで以下のコマンドを実行して実際に動作する画面を確認しましょう。</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>run
</code></pre></div>
<p>ウィンドウが開き、「Puyo Puyo Game」というタイトルと「Press Space to Start」というメッセージが表示されます。</p>
<p>おめでとうございます！リリースに向けて最初の第一歩を踏み出すことができました。これから機能を追加するごとにどんどん実際のゲームの完成に近づく事が確認できます、楽しみですね。</p>
<p>「機能は別々に作りこんで最後に画面と統合するんじゃないの？」と思うもしれません。そういうアプローチもありますが画面イメージが最後まで確認できないともし間違っていたら手戻りが大変です。それに動作するプログラムがどんどん成長するのを見るのは楽しいですからね。</p>
<blockquote>
<p>トップダウンでもボトムアップでもなく、エンドツーエンドで構築していく</p>
<p>エンドツーエンドで小さな機能を構築し、そこから作業を進めながら問題について学習していく。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<h3 id="_22">コミット<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、ここでコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化とウィンドウ表示を実装&#39;</span>
</code></pre></div>
<h3 id="1_1">イテレーション1のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>Gameモジュールの初期化</strong></li>
<li>GameMode列挙型の定義（Start, Playing, Checking, Erasing, Falling, GameOver）</li>
<li>Gamestructの実装（mode, score, chain_count, board）</li>
<li>
<p>初期状態の設定</p>
</li>
<li>
<p><strong>Boardモジュールの実装</strong></p>
</li>
<li>盤面の作成（6列12行）</li>
<li>
<p>列数・行数の取得</p>
</li>
<li>
<p><strong>ゲームウィンドウとループの実装</strong></p>
</li>
<li>macroquadを使用したウィンドウ作成</li>
<li>ゲームループの実装（更新・描画サイクル）</li>
<li>
<p>タイトルとメッセージの表示</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ゲーム初期化のテスト（2テスト）</li>
<li>すべてのテストが成功</li>
</ol>
<h3 id="_23">学んだこと<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Rustの構造体とメソッド</strong>: <code>struct</code>と<code>impl</code>によるデータと動作の分離</li>
<li><strong>列挙型（enum）</strong>: <code>GameMode</code>で状態を型安全に管理</li>
<li><strong>Optionタイプ</strong>: <code>Option&lt;Board&gt;</code>でnullの安全性を保証</li>
<li><strong>macroquadの基本</strong>: ウィンドウ作成、ゲームループ、描画処理</li>
<li><strong>非同期処理</strong>: <code>async/await</code>によるフレーム待機</li>
</ul>
<p>次のイテレーションでは、ボード（盤面）の実装とぷよペアの表示に進みます！</p>
<h2 id="2">イテレーション2: ぷよペアの表示<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームの基本的な構造ができましたね。「ゲームが始まったけど、ぷよが表示されないと面白くないよね？」と思いませんか？そこで次は、ぷよペアを画面に表示できるようにしていきましょう！</p>
<h3 id="_24">ユーザーストーリー<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよペアとボード（盤面）を視覚的に確認できる</p>
</blockquote>
<p>「ぷよぷよって、2つのぷよが組になって落ちてくるゲームですよね？」そうです！今回はその「ぷよペア」を画面に表示する機能を実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。
「ぷよペアを表示する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの色を定義する（赤、青、緑、黄色の4色）</li>
<li>ボードのセルの状態を定義する（空、またはぷよで埋まっている）</li>
<li>ぷよペアの構造を実装する（軸ぷよと子ぷよの2つのぷよ）</li>
<li>ボードを描画する処理を実装する（盤面の各セルを描画する）</li>
<li>ぷよペアを描画する処理を実装する（現在落下中のぷよペアを描画する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_25">テスト: ぷよの色とセルの状態<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの色とボードのセルの状態を表す型からテストしていきましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>Rustの作法に従い、<code>src/board.rs</code> の末尾にユニットテストを配置します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/board.rs</span>
<span class="c1">// （実装部分は後述）</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_create_board</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">cols</span><span class="p">(),</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">(),</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_all_cells_are_empty_initially</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">board</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_set_and_get_cell</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>

<span class="w">        </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">));</span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_get_cell_out_of_bounds</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">),</span><span class="w"> </span><span class="nb">None</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の4つのケースを確認しています：</p>
<ol>
<li>ボードを作成したときに、正しい列数と行数が設定されているか</li>
<li>初期状態では、すべてのセルが空（<code>Cell::Empty</code>）になっているか</li>
<li>セルにぷよを設定して、それを取得できるか</li>
<li>範囲外のセルを取得しようとしたときに、<code>None</code>が返されるか</li>
</ol>
<p>「テストを実行するとどうなるんでしょう？」まだ実装していないので、当然テストは失敗するはずです。これがテスト駆動開発の「Red（赤）」の状態です。では、テストが通るように実装していきましょう！</p>
<h3 id="_26">実装: ぷよの色とボードのセル<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>「失敗するテストができたので、次は実装ですね！」そうです！テストが通るように、最小限のコードを実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/board.rs</span>
<span class="cp">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Red</span><span class="p">,</span>
<span class="w">    </span><span class="n">Blue</span><span class="p">,</span>
<span class="w">    </span><span class="n">Green</span><span class="p">,</span>
<span class="w">    </span><span class="n">Yellow</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Empty</span><span class="p">,</span>
<span class="w">    </span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cols</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">rows</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">cells</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Cell</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">cols</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">rows</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">;</span><span class="w"> </span><span class="n">rows</span><span class="p">];</span><span class="w"> </span><span class="n">cols</span><span class="p">];</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cols</span><span class="p">,</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="n">cells</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">cols</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">cols</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rows</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rows</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">get_cell</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Cell</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">col</span><span class="o">|</span><span class="w"> </span><span class="n">col</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">y</span><span class="p">)).</span><span class="n">copied</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">set_cell</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">cell</span><span class="p">:</span><span class="w"> </span><span class="nc">Cell</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「enum（列挙型）がたくさん使われていますね！」そうですね。Rustのenumは非常に強力で、型安全性を保ちながら明確な状態を表現できます：</p>
<ul>
<li><strong>PuyoColor</strong>: ぷよの色を表します。<code>Red</code>、<code>Blue</code>、<code>Green</code>、<code>Yellow</code>の4色です。</li>
<li><strong>Cell</strong>: ボードのセルの状態を表します。<code>Empty</code>（空）または<code>Filled(PuyoColor)</code>（指定された色のぷよで埋まっている）のどちらかです。</li>
</ul>
<p>「<code>#[derive(Debug, Clone, Copy, PartialEq, Eq)]</code>って何ですか？」良い質問ですね！これはRustの「derive属性」と呼ばれるもので、コンパイラに自動的にトレイト（機能）を実装してもらうための指示です：</p>
<ul>
<li><strong>Debug</strong>: <code>{:?}</code>でデバッグ出力できるようにする</li>
<li><strong>Clone</strong>: <code>clone()</code>メソッドで複製できるようにする</li>
<li><strong>Copy</strong>: 代入時に自動的にコピーされるようにする（小さな型に適用）</li>
<li><strong>PartialEq, Eq</strong>: <code>==</code>や<code>!=</code>で比較できるようにする</li>
</ul>
<blockquote>
<p>derive属性は、一般的な動作を自動的に実装してくれる便利な機能です。</p>
<p>— The Rust Programming Language</p>
</blockquote>
<p>「<code>get_cell</code>メソッドの実装が少し複雑ですね。」そうですね。このメソッドでは、<code>Option</code>型を使って安全に値を取得しています：</p>
<div class="highlight"><pre><span></span><code><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">col</span><span class="o">|</span><span class="w"> </span><span class="n">col</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">y</span><span class="p">)).</span><span class="n">copied</span><span class="p">()</span>
</code></pre></div>
<p>この行は以下の処理を行っています：
1. <code>self.cells.get(x)</code>: x番目の列を取得（範囲外なら<code>None</code>）
2. <code>.and_then(|col| col.get(y))</code>: 列が存在する場合、y番目のセルを取得
3. <code>.copied()</code>: <code>&amp;Cell</code>を<code>Cell</code>にコピー（<code>Cell</code>は<code>Copy</code>トレイトを実装しているため）</p>
<p>「<code>Option</code>型って何ですか？」Rustには<code>null</code>がありません。代わりに<code>Option&lt;T&gt;</code>型を使って、「値があるかもしれないし、ないかもしれない」という状況を表現します。<code>Option</code>は以下の2つの値を持ちます：</p>
<ul>
<li><code>Some(value)</code>: 値が存在する</li>
<li><code>None</code>: 値が存在しない</li>
</ul>
<p>これによって、nullポインタ例外のような実行時エラーを防げるんです！</p>
<blockquote>
<p>Rustには、多くの言語が持つnullという機能はありません。</p>
<p>— The Rust Programming Language</p>
</blockquote>
<p>「これでテストは通りましたか？」はい、これでテストは通るはずです！</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 4 tests
test tests::test_create_board ... ok
test tests::test_all_cells_are_empty_initially ... ok
test tests::test_set_and_get_cell ... ok
test tests::test_get_cell_out_of_bounds ... ok

test result: ok. 4 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>これがテスト駆動開発の「Green（緑）」の状態です。次は、ぷよペアの実装をテストしていきましょう！</p>
<h3 id="_27">テスト: ぷよペアの構造<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>「次は何をテストしますか？」次は、ぷよペアの構造をテストしましょう。ぷよペアは軸ぷよ（axis）と子ぷよ（child）の2つのぷよから構成されます。</p>
<p><code>src/puyo_pair.rs</code> の末尾にテストを配置します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/puyo_pair.rs</span>
<span class="c1">// （実装部分は後述）</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">board</span><span class="p">::</span><span class="n">PuyoColor</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_create_puyo_pair</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_color</span><span class="p">(),</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_color</span><span class="p">(),</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_child_position_initially_above_axis</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 子ぷよは軸ぷよの上に配置される（y座標が1小さい）</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、ぷよペアが正しく作成され、軸ぷよと子ぷよの位置や色が適切に設定されることを確認しています。特に重要なのは、子ぷよが軸ぷよの真上（y座標が1小さい位置）に配置されることです。</p>
<h3 id="_28">実装: ぷよペアの構造<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、実装に進みましょう！</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/puyo_pair.rs</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">board</span><span class="p">::</span><span class="n">PuyoColor</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">axis_x</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">axis_y</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">axis_color</span><span class="p">:</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="p">,</span>
<span class="w">    </span><span class="n">child_x</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">child_y</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">child_color</span><span class="p">:</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">axis_color</span><span class="p">:</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="p">,</span><span class="w"> </span><span class="n">child_color</span><span class="p">:</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">axis_x</span><span class="p">:</span><span class="w"> </span><span class="nc">x</span><span class="p">,</span>
<span class="w">            </span><span class="n">axis_y</span><span class="p">:</span><span class="w"> </span><span class="nc">y</span><span class="p">,</span>
<span class="w">            </span><span class="n">axis_color</span><span class="p">,</span>
<span class="w">            </span><span class="n">child_x</span><span class="p">:</span><span class="w"> </span><span class="nc">x</span><span class="p">,</span>
<span class="w">            </span><span class="n">child_y</span><span class="p">:</span><span class="w"> </span><span class="nc">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="c1">// 子ぷよは軸ぷよの上</span>
<span class="w">            </span><span class="n">child_color</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">axis_x</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">axis_y</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">axis_color</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_color</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">child_x</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">child_y</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">child_color</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_color</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ぷよペアの位置を表すのに<code>i32</code>を使っているのはなぜですか？」良い質問ですね！<code>usize</code>ではなく<code>i32</code>を使っているのは、回転処理で負の座標が一時的に発生する可能性があるためです。また、画面外の判定もしやすくなります。</p>
<p>「子ぷよが<code>y - 1</code>の位置に配置されるのはなぜですか？」ぷよぷよでは、画面の上から下に向かってy座標が増えていきます。つまり、y座標が小さいほど上にあることになります。だから、軸ぷよの上に子ぷよを配置するには、y座標を1減らすんです。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/lib.rs に追加</span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">puyo_pair</span><span class="p">;</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 6 tests
test tests::test_create_board ... ok
test tests::test_all_cells_are_empty_initially ... ok
test tests::test_set_and_get_cell ... ok
test tests::test_get_cell_out_of_bounds ... ok
test tests::test_create_puyo_pair ... ok
test tests::test_child_position_initially_above_axis ... ok

test result: ok. 6 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>「やった！テストが通りました！」おめでとうございます！これでぷよペアの基本構造が実装できました。</p>
<h3 id="_29">実装: ぷよペアの描画<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>「テストは通ったけど、実際にぷよが表示されているところを見たいですね！」そうですね！それでは、ぷよを画面に表示する処理を実装しましょう。</p>
<h4 id="game">Gameモジュールの拡張<a class="headerlink" href="#game" title="Permanent link">&para;</a></h4>
<p>まず、Gameモジュールにぷよペアを管理する機能を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/game.rs（拡張）</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">puyo_pair</span><span class="p">::</span><span class="n">PuyoPair</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">Rng</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="nc">GameMode</span><span class="p">::</span><span class="n">Start</span><span class="p">,</span>
<span class="w">            </span><span class="n">score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">chain_count</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">)),</span>
<span class="w">            </span><span class="n">current_pair</span><span class="p">:</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">drop_timer</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">drop_interval</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">fast_drop_active</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">game</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">spawn_new_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">thread_rng</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">axis_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">,</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">child_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">,</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">axis_color</span><span class="p">,</span><span class="w"> </span><span class="n">child_color</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">current_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">PuyoPair</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>rand::Rng</code>を使ってランダムに色を選んでいるんですね！」そうです！<code>rand</code>クレートを使って、4色の中からランダムに色を選択しています。</p>
<p><code>Cargo.toml</code>に<code>rand</code>クレートを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">[dependencies]</span>
<span class="n">macroquad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.4&quot;</span>
<span class="n">rand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.8&quot;</span>
</code></pre></div>
<h4 id="_30">描画処理の実装<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<p>次に、ボードとぷよペアを描画する処理を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/game.rs（さらに拡張）</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">macroquad</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">40.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">BOARD_OFFSET_X</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">BOARD_OFFSET_Y</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">80.0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ボードを描画</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">board</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_OFFSET_X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">;</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">py</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_OFFSET_Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">;</span>

<span class="w">                    </span><span class="c1">// セルの枠を描画</span>
<span class="w">                    </span><span class="n">draw_rectangle_lines</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="p">,</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">GRAY</span><span class="p">);</span>

<span class="w">                    </span><span class="c1">// セルにぷよがあれば描画</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">color</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">puyo_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RED</span><span class="p">,</span>
<span class="w">                            </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">BLUE</span><span class="p">,</span>
<span class="w">                            </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">GREEN</span><span class="p">,</span>
<span class="w">                            </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">YELLOW</span><span class="p">,</span>
<span class="w">                        </span><span class="p">};</span>

<span class="w">                        </span><span class="n">draw_circle</span><span class="p">(</span>
<span class="w">                            </span><span class="n">px</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">                            </span><span class="n">py</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">                            </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">4.0</span><span class="p">,</span>
<span class="w">                            </span><span class="n">puyo_color</span><span class="p">,</span>
<span class="w">                        </span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 軸ぷよを描画</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_OFFSET_X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">axis_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_OFFSET_Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">axis_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_color</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RED</span><span class="p">,</span>
<span class="w">                </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">BLUE</span><span class="p">,</span>
<span class="w">                </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">GREEN</span><span class="p">,</span>
<span class="w">                </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">YELLOW</span><span class="p">,</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="n">draw_circle</span><span class="p">(</span>
<span class="w">                </span><span class="n">axis_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">                </span><span class="n">axis_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">                </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">4.0</span><span class="p">,</span>
<span class="w">                </span><span class="n">axis_color</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 子ぷよを描画</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_OFFSET_X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_OFFSET_Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">child_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_color</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RED</span><span class="p">,</span>
<span class="w">                </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">BLUE</span><span class="p">,</span>
<span class="w">                </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">GREEN</span><span class="p">,</span>
<span class="w">                </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">YELLOW</span><span class="p">,</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="n">draw_circle</span><span class="p">(</span>
<span class="w">                </span><span class="n">child_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">                </span><span class="n">child_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">                </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">4.0</span><span class="p">,</span>
<span class="w">                </span><span class="n">child_color</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「macroquadの描画関数を使っているんですね！」そうです！macroquadには便利な描画関数がたくさんあります：</p>
<ul>
<li><code>draw_rectangle_lines()</code>: 長方形の枠線を描画</li>
<li><code>draw_circle()</code>: 円を描画</li>
</ul>
<p>「色のマッチングを2回書いているのは重複ではないですか？」鋭い指摘ですね！確かに重複しています。これは次のリファクタリングステップで改善しましょう。これがTDDの「Refactor（リファクタリング）」の段階です。</p>
<h4 id="_31">メイン処理の更新<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<p>最後に、main.rsを更新してぷよペアを表示するようにします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main.rs（更新）</span>
<span class="k">use</span><span class="w"> </span><span class="n">macroquad</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">puyo_puyo_game</span><span class="p">::</span><span class="n">game</span><span class="p">::{</span><span class="n">Game</span><span class="p">,</span><span class="w"> </span><span class="n">GameMode</span><span class="p">};</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">window_conf</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Conf</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Conf</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">window_title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Puyo Puyo Game&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span>
<span class="w">        </span><span class="n">window_width</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span>
<span class="w">        </span><span class="n">window_height</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span>
<span class="w">        </span><span class="o">..</span><span class="nb">Default</span><span class="p">::</span><span class="n">default</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[macroquad::main(window_conf)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">clear_background</span><span class="p">(</span><span class="n">BLACK</span><span class="p">);</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">mode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Start</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;Puyo Puyo Game&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">120.0</span><span class="p">,</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>
<span class="w">                </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;Press Space to Start&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">90.0</span><span class="p">,</span><span class="w"> </span><span class="mf">300.0</span><span class="p">,</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span><span class="w"> </span><span class="n">GRAY</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Space</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">game</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// ゲームの描画</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// スコアと連鎖数の表示</span>
<span class="w">                </span><span class="n">draw_text</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Score: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">()),</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>
<span class="w">                </span><span class="n">draw_text</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Chain: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">chain_count</span><span class="p">()),</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">55.0</span><span class="p">,</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">next_frame</span><span class="p">().</span><span class="k">await</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_32">リファクタリング: 色変換関数の抽出<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>「さて、重複コードを除去しましょう！」そうですね。色の変換処理を関数として抽出します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/game.rs（リファクタリング）</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">puyo_color_to_macroquad_color</span><span class="p">(</span><span class="n">color</span><span class="p">:</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Color</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RED</span><span class="p">,</span>
<span class="w">            </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">BLUE</span><span class="p">,</span>
<span class="w">            </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">GREEN</span><span class="p">,</span>
<span class="w">            </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">YELLOW</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">macroquad</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">40.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">BOARD_OFFSET_X</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">BOARD_OFFSET_Y</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">80.0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ボードを描画</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">board</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_OFFSET_X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">;</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">py</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_OFFSET_Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">;</span>

<span class="w">                    </span><span class="n">draw_rectangle_lines</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="p">,</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">GRAY</span><span class="p">);</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">color</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">puyo_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">::</span><span class="n">puyo_color_to_macroquad_color</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="w">                        </span><span class="n">draw_circle</span><span class="p">(</span>
<span class="w">                            </span><span class="n">px</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">                            </span><span class="n">py</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">                            </span><span class="n">CELL_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">4.0</span><span class="p">,</span>
<span class="w">                            </span><span class="n">puyo_color</span><span class="p">,</span>
<span class="w">                        </span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">draw_puyo</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="p">(),</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="p">(),</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_color</span><span class="p">(),</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">BOARD_OFFSET_X</span><span class="p">,</span><span class="w"> </span><span class="n">BOARD_OFFSET_Y</span><span class="p">);</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">draw_puyo</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">(),</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">(),</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_color</span><span class="p">(),</span><span class="w"> </span><span class="n">CELL_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">BOARD_OFFSET_X</span><span class="p">,</span><span class="w"> </span><span class="n">BOARD_OFFSET_Y</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">draw_puyo</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">:</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="p">,</span><span class="w"> </span><span class="n">cell_size</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">offset_x</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">offset_y</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cell_size</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">py</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cell_size</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">puyo_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">::</span><span class="n">puyo_color_to_macroquad_color</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>

<span class="w">        </span><span class="n">draw_circle</span><span class="p">(</span>
<span class="w">            </span><span class="n">px</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cell_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">py</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cell_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">cell_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">4.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">puyo_color</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「すっきりしましたね！」そうです！<code>draw_puyo</code>というヘルパーメソッドを抽出することで、コードの重複を減らし、可読性を向上させました。これがリファクタリングの力です。</p>
<h3 id="_33">画面の確認<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>ではここで以下のコマンドを実行して実際に動作する画面を確認しましょう。</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>run
</code></pre></div>
<p>ウィンドウが開き、スペースキーを押すと、ボードとランダムな色のぷよペアが表示されます！</p>
<p>「本当だ！ぷよが表示されました！」おめでとうございます！ぷよペアの表示機能が実装できましたね。</p>
<h3 id="_34">コミット<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、ここでコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよペアの表示機能を実装&#39;</span>
</code></pre></div>
<h3 id="2_1">イテレーション2のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ぷよの色の定義</strong></li>
<li><code>PuyoColor</code>列挙型（Red, Blue, Green, Yellow）</li>
<li>
<p><code>derive</code>属性によるトレイトの自動実装</p>
</li>
<li>
<p><strong>ボードのセル状態の定義</strong></p>
</li>
<li><code>Cell</code>列挙型（Empty, Filled(PuyoColor)）</li>
<li>
<p><code>Option</code>型による安全な値の取得</p>
</li>
<li>
<p><strong>ぷよペアの構造</strong></p>
</li>
<li>軸ぷよと子ぷよの位置と色の管理</li>
<li>
<p>子ぷよは軸ぷよの上に配置（y - 1）</p>
</li>
<li>
<p><strong>描画処理</strong></p>
</li>
<li>macroquadの描画関数を使用</li>
<li>ボードの枠線とぷよを円形で描画</li>
<li>
<p>色変換関数のヘルパーメソッド化</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ボードのテスト（4テスト）</li>
<li>ぷよペアのテスト（2テスト）</li>
<li>すべてのテストが成功</li>
</ol>
<h3 id="_35">学んだこと<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>列挙型（enum）の活用</strong>: 型安全な状態管理</li>
<li><strong>Option型</strong>: nullの代わりに安全に「値がない」を表現</li>
<li><strong>derive属性</strong>: 一般的なトレイトの自動実装</li>
<li><strong>メソッド抽出</strong>: コードの重複を減らすリファクタリング</li>
<li><strong>macroquad描画</strong>: 基本的な図形描画関数</li>
</ul>
<p>次のイテレーションでは、ぷよペアを左右に移動する機能を実装していきます！</p>
<h2 id="3">イテレーション3: ぷよペアの移動<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでぷよペアの表示ができましたね。「ゲームが始まって、ぷよも表示されたけど、動かないと面白くないよね？」と思いませんか？そこで次は、ぷよペアを左右に移動できるようにしていきましょう！</p>
<h3 id="_36">ユーザーストーリー<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよペアを左右に移動できる</p>
</blockquote>
<p>「ぷよぷよって、落ちてくるぷよを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「左右の移動」を実装していきます。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。
「ぷよペアを左右に移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>キーボード入力を検出する（左右キーが押されたことを検知する）</li>
<li>ぷよペアを左右に移動する処理を実装する（実際にぷよペアの位置を変更する）</li>
<li>移動可能かどうかのチェックを実装する（画面の端や他のぷよにぶつかる場合は移動できないようにする）</li>
<li>移動後の表示を更新する（画面上でぷよペアの位置が変わったことを表示する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_37">テスト: ぷよペアの移動<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよペアを左右に移動する機能をテストしていきましょう。ぷよペアが左右に移動できるか、そして画面の端に到達したときに移動が制限されるかをテストします。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><code>src/puyo_pair.rs</code> のテストモジュールに以下のテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/puyo_pair.rs</span>
<span class="c1">// （既存の実装とテストの続き）</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">board</span><span class="p">::{</span><span class="n">Board</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">};</span>

<span class="w">    </span><span class="c1">// ... 既存のテスト ...</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_can_move_left_when_space_is_available</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>

<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_left</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_cannot_move_left_at_left_edge</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>

<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_left</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_can_move_right_when_space_is_available</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>

<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_right</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_cannot_move_right_at_right_edge</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>

<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_right</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_move_left_changes_position</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">move_left</span><span class="p">();</span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_move_right_changes_position</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">move_right</span><span class="p">();</span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の6つのケースを確認しています：</p>
<ol>
<li>通常の状態で左に移動できるか</li>
<li>左端にいるときに左に移動できないか</li>
<li>通常の状態で右に移動できるか</li>
<li>右端にいるときに右に移動できないか</li>
<li>左に移動すると位置が正しく変わるか</li>
<li>右に移動すると位置が正しく変わるか</li>
</ol>
<p>「なるほど、画面の端を超えて移動できないようにするんですね！」そうです！ゲームの画面外にぷよが出てしまうと困りますからね。では、このテストが通るように実装していきましょう。</p>
<h3 id="_38">実装: ぷよペアの移動<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよペアを移動させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/puyo_pair.rs（拡張）</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">board</span><span class="p">::{</span><span class="n">Board</span><span class="p">,</span><span class="w"> </span><span class="n">Cell</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">};</span>

<span class="k">impl</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">can_move_left</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Board</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 左端チェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">new_axis_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">new_child_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 衝突チェック</span>
<span class="w">        </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">new_axis_x</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="p">,</span><span class="w"> </span><span class="n">new_child_x</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">can_move_right</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Board</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 右端チェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">new_axis_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">new_child_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 衝突チェック</span>
<span class="w">        </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">new_axis_x</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="p">,</span><span class="w"> </span><span class="n">new_child_x</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">move_left</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">move_right</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_collision</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Board</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">ay</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">cy</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 範囲外チェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ay</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ay</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cy</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ボード上のぷよとの衝突チェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">ax</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">ay</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">cy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>can_move_left</code>と<code>can_move_right</code>メソッドで移動可能かをチェックしているんですね！」そうです！これらのメソッドは以下の処理を行っています：</p>
<ol>
<li>移動後の新しい位置を計算</li>
<li>画面の端に到達するかチェック</li>
<li>ボード上の他のぷよとの衝突をチェック</li>
</ol>
<p>「<code>is_collision</code>メソッドは何をしているんですか？」このメソッドは、指定された位置に軸ぷよと子ぷよを配置できるかどうかをチェックします。具体的には：</p>
<ul>
<li>範囲外（画面外）かどうか</li>
<li>ボード上の既存のぷよと重なるかどうか</li>
</ul>
<p>をチェックして、いずれかに該当する場合は<code>true</code>（衝突あり）を返します。</p>
<p>「<code>move_left</code>と<code>move_right</code>は単純に座標を変更するだけですね。」そうです！実際の移動処理は、<code>can_move_*</code>メソッドで移動可能であることを確認してから呼び出されることを前提としています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 12 tests
test tests::test_create_board ... ok
test tests::test_all_cells_are_empty_initially ... ok
test tests::test_set_and_get_cell ... ok
test tests::test_get_cell_out_of_bounds ... ok
test tests::test_create_puyo_pair ... ok
test tests::test_child_position_initially_above_axis ... ok
test tests::test_can_move_left_when_space_is_available ... ok
test tests::test_cannot_move_left_at_left_edge ... ok
test tests::test_can_move_right_when_space_is_available ... ok
test tests::test_cannot_move_right_at_right_edge ... ok
test tests::test_move_left_changes_position ... ok
test tests::test_move_right_changes_position ... ok

test result: ok. 12 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>「やった！テストが通りました！」おめでとうございます！これでぷよペアの移動機能が実装できました。</p>
<h3 id="_39">実装: キーボード入力の処理<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>「テストは通ったけど、実際にキーボードで操作できるようにしたいですね！」そうですね！それでは、ゲームのメインループでキーボード入力を検出して、ぷよペアを移動できるようにしましょう。</p>
<h4 id="game_1">Gameモジュールの拡張<a class="headerlink" href="#game_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// src/game.rs（拡張）</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle_input</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">macroquad</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Playing</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 左キーが押されたら左に移動</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Left</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_left</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">pair</span><span class="p">.</span><span class="n">move_left</span><span class="p">();</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// 右キーが押されたら右に移動</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_right</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">pair</span><span class="p">.</span><span class="n">move_right</span><span class="p">();</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「macroquadの<code>is_key_pressed</code>関数を使っているんですね！」そうです！<code>is_key_pressed</code>は、指定されたキーがこのフレームで押されたかどうかを返します。これにより、キーを押すたびに1回だけ移動が実行されます。</p>
<p>「<code>is_key_pressed</code>と<code>is_key_down</code>の違いは何ですか？」良い質問ですね！</p>
<ul>
<li><strong>is_key_pressed</strong>: キーが押された瞬間だけ<code>true</code>になる（1フレームだけ）</li>
<li><strong>is_key_down</strong>: キーが押され続けている間ずっと<code>true</code></li>
</ul>
<p>今回は、キーを1回押すごとに1マス移動させたいので、<code>is_key_pressed</code>を使っています。</p>
<h4 id="_40">メイン処理の更新<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main.rs（更新）</span>
<span class="cp">#[macroquad::main(window_conf)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">clear_background</span><span class="p">(</span><span class="n">BLACK</span><span class="p">);</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">mode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Start</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;Puyo Puyo Game&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">120.0</span><span class="p">,</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>
<span class="w">                </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;Press Space to Start&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">90.0</span><span class="p">,</span><span class="w"> </span><span class="mf">300.0</span><span class="p">,</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span><span class="w"> </span><span class="n">GRAY</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Space</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">game</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// キーボード入力の処理</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="n">handle_input</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// ゲームの描画</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// スコアと連鎖数の表示</span>
<span class="w">                </span><span class="n">draw_text</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Score: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">()),</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>
<span class="w">                </span><span class="n">draw_text</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Chain: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">chain_count</span><span class="p">()),</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">55.0</span><span class="p">,</span><span class="w"> </span><span class="mf">20.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">next_frame</span><span class="p">().</span><span class="k">await</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>handle_input</code>を毎フレーム呼び出すんですね！」そうです。ゲームループの中で、毎フレームキーボード入力をチェックして、ぷよペアを移動させます。</p>
<h3 id="_41">画面の確認<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>ではここで以下のコマンドを実行して実際に動作する画面を確認しましょう。</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>run
</code></pre></div>
<p>ウィンドウが開き、スペースキーを押すと、ボードとぷよペアが表示されます。左右の矢印キーを押すと、ぷよペアが左右に移動します！</p>
<p>「本当だ！ぷよペアが動きました！」おめでとうございます！ぷよペアの移動機能が実装できましたね。</p>
<h3 id="_42">リファクタリング: 定数の抽出<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>「コードの中に<code>6</code>や<code>12</code>といったマジックナンバーが見えますね。」鋭い指摘です！これらの数値を定数として抽出しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/game.rs（リファクタリング）</span>
<span class="k">const</span><span class="w"> </span><span class="n">BOARD_COLS</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">BOARD_ROWS</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">INITIAL_SPAWN_X</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">INITIAL_SPAWN_Y</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="nc">GameMode</span><span class="p">::</span><span class="n">Start</span><span class="p">,</span>
<span class="w">            </span><span class="n">score</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">chain_count</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">BOARD_COLS</span><span class="p">,</span><span class="w"> </span><span class="n">BOARD_ROWS</span><span class="p">)),</span>
<span class="w">            </span><span class="n">current_pair</span><span class="p">:</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">drop_timer</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">drop_interval</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">fast_drop_active</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">spawn_new_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">thread_rng</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">axis_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">,</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">child_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">,</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">INITIAL_SPAWN_X</span><span class="p">,</span><span class="w"> </span><span class="n">INITIAL_SPAWN_Y</span><span class="p">,</span><span class="w"> </span><span class="n">axis_color</span><span class="p">,</span><span class="w"> </span><span class="n">child_color</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「すっきりしましたね！」そうです！定数を使うことで、コードの意図が明確になり、後で変更する際も一箇所を修正するだけで済むようになります。</p>
<blockquote>
<p>マジックナンバーを名前付き定数で置き換える</p>
<p>コード内に直接記述された数値（マジックナンバー）は、その意味が不明確で保守性を低下させます。</p>
<p>— Martin Fowler 『リファクタリング』</p>
</blockquote>
<h3 id="_43">コミット<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>実装が完了したので、ここでコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよペアの左右移動機能を実装&#39;</span>
</code></pre></div>
<h3 id="3_1">イテレーション3のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>移動可能判定</strong></li>
<li><code>can_move_left()</code>: 左に移動可能かチェック</li>
<li><code>can_move_right()</code>: 右に移動可能かチェック</li>
<li>
<p>画面端チェックと衝突チェック</p>
</li>
<li>
<p><strong>移動処理</strong></p>
</li>
<li><code>move_left()</code>: 軸ぷよと子ぷよを左に移動</li>
<li>
<p><code>move_right()</code>: 軸ぷよと子ぷよを右に移動</p>
</li>
<li>
<p><strong>衝突判定</strong></p>
</li>
<li><code>is_collision()</code>: 指定位置への配置可能性をチェック</li>
<li>範囲外チェック</li>
<li>
<p>既存ぷよとの重なりチェック</p>
</li>
<li>
<p><strong>キーボード入力処理</strong></p>
</li>
<li><code>handle_input()</code>: キーボード入力を検出して移動</li>
<li>
<p><code>is_key_pressed()</code>による1フレーム限定の入力検出</p>
</li>
<li>
<p><strong>定数の導入</strong></p>
</li>
<li>BOARD_COLS, BOARD_ROWS: ボードのサイズ</li>
<li>INITIAL_SPAWN_X, INITIAL_SPAWN_Y: 初期スポーン位置</li>
<li>
<p>マジックナンバーの排除</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>移動可能判定のテスト（4テスト）</li>
<li>移動処理のテスト（2テスト）</li>
<li>すべてのテストが成功</li>
</ol>
<h3 id="_44">学んだこと<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>参照渡しとボロー</strong>: <code>&amp;Board</code>でボードを参照として受け取る</li>
<li><strong>可変参照と不変参照</strong>: <code>&amp;mut self</code>と<code>&amp;self</code>の使い分け</li>
<li><strong>macroquadの入力処理</strong>: <code>is_key_pressed</code>と<code>is_key_down</code>の違い</li>
<li><strong>定数の活用</strong>: マジックナンバーを名前付き定数に置き換える</li>
<li><strong>衝突判定</strong>: ゲームオブジェクトの配置可能性チェック</li>
</ul>
<p>次のイテレーションでは、ぷよペアを回転させる機能を実装していきます！</p>
<h2 id="4">イテレーション4: ぷよペアの回転<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよペアを回転させる機能を実装していきましょう！</p>
<h3 id="_45">ユーザーストーリー<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよペアを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、軸ぷよを中心に子ぷよが時計回り・反時計回りに移動することです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよペアを回転させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよペアの回転処理を実装する（時計回り・反時計回りの回転）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 回転可能かどうかのチェックを実装する（他のぷよや壁にぶつかる場合は回転できないようにする）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 壁キック処理を実装する（壁際での回転を可能にする特殊処理）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 回転後の表示を更新する（画面上でぷよの位置が変わったことを表示する）</li>
</ul>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_46">テスト: ぷよペアの回転<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは基本的な回転機能のテストから書いていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main.rs の tests モジュールに追加</span>

<span class="cp">#[cfg(test)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ... 既存のテスト ...</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_rotate_right_from_up</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 初期状態: 軸(2,0), 子(2,-1) (上)</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 右回転: 子が右に移動</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_right</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_rotate_right_from_right</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 右向き: 軸(2,0), 子(3,0)</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 右回転: 子が下に移動</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_right</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_rotate_right_from_down</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 下向き: 軸(2,0), 子(2,1)</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 右回転: 子が左に移動</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_right</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_rotate_right_from_left</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 左向き: 軸(2,0), 子(1,0)</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 右回転: 子が上に移動（一周して戻る）</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_right</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_rotate_left_from_up</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 初期状態: 軸(2,0), 子(2,-1) (上)</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 左回転: 子が左に移動</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_left</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li>上向きから時計回りに回転すると、子ぷよが右に移動するか</li>
<li>右向きから時計回りに回転すると、子ぷよが下に移動するか</li>
<li>下向きから時計回りに回転すると、子ぷよが左に移動するか</li>
<li>左向きから時計回りに回転すると、子ぷよが上に移動するか（一周）</li>
<li>上向きから反時計回りに回転すると、子ぷよが左に移動するか</li>
</ol>
<p>「なるほど、軸ぷよの周りを子ぷよが回転するんですね！」そうです！では、このテストが通るように実装していきましょう。</p>
<h3 id="_47">実装: ぷよペアの回転<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよペアを回転させる機能を実装していきましょう。</p>
<p>まず、テストを実行して失敗することを確認します：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>---- tests::test_rotate_right_from_up stdout ----
thread &#39;tests::test_rotate_right_from_up&#39; panicked at src/main.rs:123:9:
no method named `rotate_right` found for struct `PuyoPair`
</code></pre></div>
<p>「エラーメッセージが出ましたね。」そうですね。<code>rotate_right</code> メソッドがまだ存在しないので、コンパイルエラーになっています。では、回転メソッドを実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のメソッド ...</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rotate_right</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 子ぷよの相対位置を計算</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 右回転: (dx, dy) -&gt; (-dy, dx)</span>
<span class="w">        </span><span class="c1">// 上(0,-1) -&gt; 右(1,0) -&gt; 下(0,1) -&gt; 左(-1,0) -&gt; 上(0,-1)</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">dy</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dx</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 新しい子ぷよの位置を計算</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">new_dx</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">new_dy</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rotate_left</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 子ぷよの相対位置を計算</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 左回転: (dx, dy) -&gt; (dy, -dx)</span>
<span class="w">        </span><span class="c1">// 上(0,-1) -&gt; 左(-1,0) -&gt; 下(0,1) -&gt; 右(1,0) -&gt; 上(0,-1)</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">dx</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 新しい子ぷよの位置を計算</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">new_dx</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">new_dy</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「これで回転ができるようになりましたね！」そうです。回転の仕組みを簡単に説明しますね：</p>
<ol>
<li>まず、軸ぷよから見た子ぷよの相対位置（dx, dy）を計算します</li>
<li>右回転の場合、(dx, dy) を (-dy, dx) に変換します</li>
<li>左回転の場合、(dx, dy) を (dy, -dx) に変換します</li>
<li>変換した相対位置を絶対位置に戻します</li>
</ol>
<p>「数学的な変換なんですね！」そうです！この変換は2D回転行列の簡略版なんですよ。では、テストが通るか確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 17 tests
test tests::test_can_move_left ... ok
test tests::test_can_move_right ... ok
test tests::test_cannot_move_left_at_left_edge ... ok
test tests::test_cannot_move_right_at_right_edge ... ok
test tests::test_rotate_right_from_up ... ok
test tests::test_rotate_right_from_right ... ok
test tests::test_rotate_right_from_down ... ok
test tests::test_rotate_right_from_left ... ok
test tests::test_rotate_left_from_up ... ok

test result: ok. 17 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！これで基本的な回転機能が実装できました。</p>
<h3 id="_48">テスト: 回転可能判定と壁キック<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>「壁際での回転はどうなるんですか？」良い質問ですね！壁際で回転すると、子ぷよが壁の外に出てしまう場合があります。そのような場合は、回転を制限するか、あるいは「壁キック」で位置を調整する必要があります。</p>
<p>まずは、回転可能かどうかを判定するテストを書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_can_rotate_right</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 中央の位置: 軸(2,0), 子(2,-1)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">can_rotate_right</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_cannot_rotate_right_at_right_edge</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 右端の位置: 軸(5,0), 子(5,-1)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 右回転すると子が(6,0)になってしまう</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">can_rotate_right</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_wall_kick_right_rotation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 右端の位置: 軸(5,0), 子(5,-1)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 壁キック付き回転を実行</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_right_with_wall_kick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 軸が左に1つ移動し、子が右向きになる</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_wall_kick_left_rotation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 左端の位置: 軸(0,0), 子(0,-1)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 壁キック付き回転を実行</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_left_with_wall_kick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 軸が右に1つ移動し、子が左向きになる</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下を確認しています：</p>
<ol>
<li>通常の位置では回転可能か</li>
<li>右端にいる場合、右回転すると壁外に出るので回転不可能か</li>
<li>壁キック付き右回転では、軸が左に移動して回転するか</li>
<li>壁キック付き左回転では、軸が右に移動して回転するか</li>
</ol>
<p>「壁キックって複雑そうですね！」確かに少し複雑ですが、順番に実装していけば大丈夫ですよ。</p>
<h3 id="_49">実装: 回転可能判定と壁キック<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>まず、回転可能かどうかを判定するメソッドを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のメソッド ...</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">can_rotate_right</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Board</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 仮想的に右回転した場合の子ぷよの位置を計算</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dx</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 回転後の位置が有効か確認</span>
<span class="w">        </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="p">,</span><span class="w"> </span><span class="n">new_child_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_child_y</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">can_rotate_left</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Board</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 仮想的に左回転した場合の子ぷよの位置を計算</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_child_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dx</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 回転後の位置が有効か確認</span>
<span class="w">        </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="p">,</span><span class="w"> </span><span class="n">new_child_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_child_y</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>次に、壁キック処理を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のメソッド ...</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rotate_right_with_wall_kick</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// まず通常の回転を試す</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">can_rotate_right</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">rotate_right</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 左に1マスずらして回転を試す（右壁キック）</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">original_axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">can_rotate_right</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">rotate_right</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 右に1マスずらして回転を試す（左壁キック）</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original_axis_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BOARD_WIDTH</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">can_rotate_right</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">rotate_right</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// どちらもダメなら元の位置に戻す</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original_axis_x</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rotate_left_with_wall_kick</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// まず通常の回転を試す</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">can_rotate_left</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">rotate_left</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 右に1マスずらして回転を試す（左壁キック）</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">original_axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BOARD_WIDTH</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">can_rotate_left</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">rotate_left</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 左に1マスずらして回転を試す（右壁キック）</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original_axis_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">can_rotate_left</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">rotate_left</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// どちらもダメなら元の位置に戻す</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original_axis_x</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「壁キックの処理はどうなっているんですか？」良い質問ですね。壁キック処理は以下の順序で試行します：</p>
<ol>
<li>まず通常の回転を試す</li>
<li>ダメなら軸を1マス移動して回転を試す（右回転なら左に、左回転なら右に）</li>
<li>それでもダメなら逆方向に移動して回転を試す</li>
<li>すべてダメなら回転しない（元の位置に戻す）</li>
</ol>
<p>「なるほど、複数のパターンを試すんですね！」そうです！これにより、プレイヤーが壁際でも快適に回転できるようになります。</p>
<p>では、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 21 tests
test tests::test_can_move_left ... ok
test tests::test_can_move_right ... ok
test tests::test_cannot_move_left_at_left_edge ... ok
test tests::test_cannot_move_right_at_right_edge ... ok
test tests::test_rotate_right_from_up ... ok
test tests::test_rotate_right_from_right ... ok
test tests::test_rotate_right_from_down ... ok
test tests::test_rotate_right_from_left ... ok
test tests::test_rotate_left_from_up ... ok
test tests::test_can_rotate_right ... ok
test tests::test_cannot_rotate_right_at_right_edge ... ok
test tests::test_wall_kick_right_rotation ... ok
test tests::test_wall_kick_left_rotation ... ok

test result: ok. 21 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！これで回転機能と壁キック処理が実装できました。</p>
<h3 id="_50">リファクタリング: 重複コードの削除<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>「<code>rotate_right_with_wall_kick</code> と <code>rotate_left_with_wall_kick</code> でコードが重複していますね？」鋭い指摘です！確かに重複していますね。しかし、今は壁キックのロジックが微妙に異なるので、このまま残しておきましょう。後で共通化できる部分が明確になったら、リファクタリングするのが良いでしょう。</p>
<p>今の段階では、テストが通っていることを確認できたので、次は実際にゲーム内で回転操作を有効にしましょう。</p>
<h3 id="_51">実装: キーボード入力との統合<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>「実際にゲーム内で回転できるようにするには？」<code>Game</code> 構造体の <code>handle_input</code> メソッドに回転処理を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のメソッド ...</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle_input</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 左右移動</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Left</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_left</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">move_left</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_right</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">move_right</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 回転（新規追加）</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Up</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">X</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_right_with_wall_kick</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_left_with_wall_kick</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「キーの割り当てはどうなっていますか？」良い質問ですね。以下のようなキー配置にしました：</p>
<ul>
<li><strong>左矢印キー</strong>: 左に移動</li>
<li><strong>右矢印キー</strong>: 右に移動</li>
<li><strong>上矢印キー / X キー</strong>: 右回転（時計回り）</li>
<li><strong>Z キー</strong>: 左回転（反時計回り）</li>
</ul>
<p>「なぜ X と Z なんですか？」これは多くのパズルゲームで使われる標準的なキー配置なんです。右手で矢印キーを操作しながら、左手で回転操作ができるようになっています。</p>
<h3 id="_52">動作確認<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>「実際に動かしてみましょう！」そうですね。開発サーバーを起動して確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>run
</code></pre></div>
<p>「ぷよが回転しました！」素晴らしい！キーボードの上矢印キーや X キーを押すと、ぷよが時計回りに回転し、Z キーを押すと反時計回りに回転します。壁際でも適切に壁キックが動作していることが確認できますね。</p>
<h3 id="4_1">イテレーション4のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>回転ロジックの実装</strong></li>
<li><code>rotate_right</code> メソッド: 子ぷよを軸ぷよの周りで時計回りに90度回転</li>
<li><code>rotate_left</code> メソッド: 子ぷよを軸ぷよの周りで反時計回りに90度回転</li>
<li>
<p>2D回転の数式: (dx, dy) → (-dy, dx) (右回転), (dx, dy) → (dy, -dx) (左回転)</p>
</li>
<li>
<p><strong>回転可能判定の実装</strong></p>
</li>
<li><code>can_rotate_right</code> メソッド: 右回転後の位置が有効かチェック</li>
<li><code>can_rotate_left</code> メソッド: 左回転後の位置が有効かチェック</li>
<li>
<p>既存の <code>is_collision</code> メソッドを活用</p>
</li>
<li>
<p><strong>壁キック処理の実装</strong></p>
</li>
<li><code>rotate_right_with_wall_kick</code> メソッド: 右回転を壁キック付きで実行</li>
<li><code>rotate_left_with_wall_kick</code> メソッド: 左回転を壁キック付きで実行</li>
<li>
<p>複数パターンの試行: 通常回転 → 壁キック(一方向) → 壁キック(逆方向)</p>
</li>
<li>
<p><strong>キーボード入力との統合</strong></p>
</li>
<li><code>handle_input</code> メソッドに回転処理を追加</li>
<li>キー配置: 上矢印/X = 右回転, Z = 左回転</li>
<li>
<p><code>is_key_pressed</code> で1回のキー押下を検出</p>
</li>
<li>
<p><strong>テストの作成（合計21テスト）</strong></p>
</li>
<li>回転ロジックのテスト（5テスト）<ul>
<li>上→右→下→左→上の4方向回転</li>
<li>反時計回りの回転</li>
</ul>
</li>
<li>回転可能判定のテスト（2テスト）<ul>
<li>通常位置での回転可能</li>
<li>右端での回転不可能</li>
</ul>
</li>
<li>
<p>壁キック処理のテスト（2テスト）</p>
<ul>
<li>右端での右回転 → 左壁キック</li>
<li>左端での左回転 → 右壁キック</li>
</ul>
</li>
<li>
<p><strong>TDDサイクルの実践</strong></p>
</li>
<li>Red: 回転・壁キックのテストを先に作成し失敗を確認</li>
<li>Green: 各機能を実装してテストを通過</li>
<li>
<p>Refactor: 今回は大きなリファクタリングなし（今後の課題として重複コードの共通化を検討）</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>2D回転行列の簡略版: 90度回転の座標変換</li>
<li>壁キック: ユーザビリティ向上のための位置自動調整</li>
<li>フォールバック処理: 複数の試行パターンで柔軟に対応</li>
<li>Rust の早期リターン: <code>return</code> による処理の簡潔化</li>
</ol>
<p><strong>次のステップ</strong>: 現在、ぷよは移動と回転ができますが、まだ自動的に落下しません。次のイテレーションでは、ぷよの自動落下と着地処理を実装していきます。</p>
<h2 id="5">イテレーション5: ぷよの自動落下と高速落下<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよって自動で落ちていくよね？」そうですね！ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきます。今回は、その「自動落下」と「高速落下」機能を実装していきましょう！</p>
<h3 id="_53">ユーザーストーリー<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとしてぷよペアを自動落下させることができる
プレイヤーとして、落下ボタンを押すことでぷよペアを高速落下させることができる</p>
</blockquote>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを自動落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 落下タイマーの実装（一定時間ごとに落下処理を実行する仕組み）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 自動落下処理の実装（タイマーが発火したときにぷよを1マス下に移動する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 落下可能判定の実装（下に移動できるかどうかをチェックする）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 高速落下の実装（下キーを押したときに即座に落下）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 着地処理の実装（ぷよが着地したときの処理）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームループとの統合（ゲームの更新処理に自由落下を組み込む）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_54">テスト: 落下可能判定<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよペアが下に移動できるかどうかを判定する機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_can_move_down</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 初期位置: 軸(2,0), 子(2,-1)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_cannot_move_down_at_bottom</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 下端: 軸(2,11), 子(2,10)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_cannot_move_down_when_blocked</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// ボードの(2,1)に既にぷよが配置されている</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 軸(2,0), 子(2,-1)のペアは下に移動できない</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下を確認しています：</p>
<ol>
<li>通常の位置では下に移動できるか</li>
<li>下端にいる場合は下に移動できないか</li>
<li>下に既にぷよがある場合は下に移動できないか</li>
</ol>
<p>「なるほど、着地判定に必要な条件を確認するんですね！」そうです！では、このテストが通るように実装していきましょう。</p>
<h3 id="_55">実装: 落下可能判定<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>まず、テストを実行して失敗することを確認します：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「エラーメッセージが出ましたね。」そうですね。<code>can_move_down</code> メソッドがまだ存在しないので、コンパイルエラーになっています。では、実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のメソッド ...</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">can_move_down</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Board</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_axis_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 範囲チェックと衝突判定</span>
<span class="w">        </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_axis_y</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_child_y</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">move_down</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「これで落下判定ができるようになりましたね！」そうです。<code>is_collision</code> メソッドを再利用して、下に移動できるかを判定しています。では、テストが通るか確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 24 tests
test tests::test_can_move_down ... ok
test tests::test_cannot_move_down_at_bottom ... ok
test tests::test_cannot_move_down_when_blocked ... ok

test result: ok. 24 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！これで基本的な落下判定が実装できました。</p>
<h3 id="_56">テスト: 自動落下タイマー<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>「次は自動落下のテストですね！」そうです。一定時間ごとにぷよが自動的に落下する機能をテストしましょう。</p>
<p>しかし、ここで問題があります。macroquad では時間の経過を直接テストするのは難しいので、落下タイマーのロジックを分離してテストします。</p>
<p>まず、<code>Game</code> 構造体に落下タイマーを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="nc">Board</span><span class="p">,</span>
<span class="w">    </span><span class="n">current_pair</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">PuyoPair</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">fall_timer</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span>
<span class="w">    </span><span class="n">fall_interval</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="nc">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">current_pair</span><span class="p">:</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">fall_timer</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">fall_interval</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="c1">// 1秒ごとに落下</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 落下タイマーを更新</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta_time</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 一定時間経過したら自動落下</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_interval</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">auto_fall</span><span class="p">();</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">auto_fall</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_down</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">move_down</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 着地処理（後で実装）</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">land_pair</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">land_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 着地処理は次のステップで実装</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「タイマーを使って一定間隔で落下させるんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li><code>fall_timer</code> でタイマーを管理</li>
<li><code>update()</code> メソッドで経過時間を加算</li>
<li>一定間隔（<code>fall_interval</code>）を超えたら <code>auto_fall()</code> を実行</li>
<li><code>auto_fall()</code> で下に移動できるかチェックし、移動または着地処理を実行</li>
</ol>
<p>「では、テストを書きましょう！」そうですね。タイマーのロジックをテストします：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_auto_fall_timer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">initial_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">axis_y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 0.5秒経過（まだ落下しない）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">axis_y</span><span class="p">,</span><span class="w"> </span><span class="n">initial_y</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// さらに0.5秒経過（合計1秒で落下）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">axis_y</span><span class="p">,</span><span class="w"> </span><span class="n">initial_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_auto_fall_multiple_times</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">initial_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">axis_y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 2.5秒経過（2回落下）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="mf">2.5</span><span class="p">);</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">axis_y</span><span class="p">,</span><span class="w"> </span><span class="n">initial_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下を確認しています：</p>
<ol>
<li>1秒未満では落下しないこと</li>
<li>1秒経過すると1マス落下すること</li>
<li>2秒以上経過すると複数回落下すること</li>
</ol>
<p>「なるほど、タイマーが正しく動作しているか確認するんですね！」そうです！</p>
<h3 id="_57">実装: 高速落下<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>「次は高速落下ですね！」そうです。下キーを押したときに、即座にぷよを1マス落下させる機能を実装しましょう。</p>
<p>まず、テストを書きます：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_fast_fall</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">initial_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 高速落下</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">move_down</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="p">,</span><span class="w"> </span><span class="n">initial_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「高速落下のテストは移動のテストと同じですね！」そうです。実装自体はすでに <code>move_down</code> メソッドがあるので、キーボード入力と統合するだけです。</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle_input</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 左右移動</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Left</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_left</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">move_left</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_right</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">move_right</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 回転</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Up</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">X</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_right_with_wall_kick</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">rotate_left_with_wall_kick</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 高速落下（新規追加）</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">Down</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_down</span><span class="p">(</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">move_down</span><span class="p">();</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// タイマーをリセット</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「下キーを押すと即座に1マス落下するんですね！」そうです！そして、<code>fall_timer</code> をリセットすることで、高速落下後も通常の落下タイミングが維持されます。</p>
<h3 id="_58">実装: 着地処理<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>「ぷよが着地したらどうなるんですか？」良い質問ですね！着地したぷよはボードに固定され、次のぷよペアが出現します。</p>
<p>まず、テストを書きます：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_land_pair</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 着地処理を実行</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">land_pair</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ボードに配置されているか確認</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">));</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// 次のぷよが出現しているか確認</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">is_some</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<p>次に、実装します：</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">land_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">take</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 軸ぷよをボードに配置</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BOARD_HEIGHT</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">][</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_color</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 子ぷよをボードに配置</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BOARD_HEIGHT</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">][</span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_color</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 次のぷよを生成</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">spawn_new_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">Rng</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">thread_rng</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">axis_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">,</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">child_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">,</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">axis_color</span><span class="p">,</span><span class="w"> </span><span class="n">child_color</span><span class="p">));</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「着地したらボードに配置して、次のぷよを生成するんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li><code>land_pair()</code> で軸ぷよと子ぷよをボードに配置</li>
<li><code>spawn_new_pair()</code> で次のぷよをランダムな色で生成</li>
<li>着地後、<code>fall_timer</code> をリセット</li>
</ol>
<p>「rand クレートを使うんですね！」そうです。ランダムな色を生成するために使います。<code>Cargo.toml</code> に追加する必要がありますね：</p>
<div class="highlight"><pre><span></span><code><span class="k">[dependencies]</span>
<span class="n">macroquad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.4&quot;</span>
<span class="n">rand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.8&quot;</span>
</code></pre></div>
<h3 id="_59">ゲームループとの統合<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>「これで自動落下が完成ですね！」そうです！最後に、メインループで <code>update</code> メソッドを呼び出すように修正します：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[macroquad::main(window_conf)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span><span class="w"> </span><span class="c1">// 最初のぷよを生成</span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">delta_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_frame_time</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 入力処理</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">handle_input</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 更新処理</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">delta_time</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 描画処理</span>
<span class="w">        </span><span class="n">clear_background</span><span class="p">(</span><span class="n">DARKGRAY</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">();</span>

<span class="w">        </span><span class="n">next_frame</span><span class="p">().</span><span class="k">await</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>get_frame_time()</code> で前のフレームからの経過時間を取得するんですね！」そうです！macroquad が提供する便利な関数です。</p>
<h3 id="_60">動作確認<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>「実際に動かしてみましょう！」そうですね。開発サーバーを起動して確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span>run
</code></pre></div>
<p>「ぷよが自動的に落ちていきます！」素晴らしい！そして下キーを押すと高速落下もできますね。着地すると次のぷよが出現して、ボードに積み重なっていきます。</p>
<h3 id="_61">リファクタリング: マジックナンバーの定数化<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>「コードの中に 1.0 とか 0.0 とかマジックナンバーがありますね？」鋭い指摘です！確かに、いくつかの数値をハードコードしてしまっています。これらを定数化しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">FALL_INTERVAL</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1秒ごとに落下</span>
<span class="k">const</span><span class="w"> </span><span class="n">INITIAL_SPAWN_X</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期出現位置X</span>
<span class="k">const</span><span class="w"> </span><span class="n">INITIAL_SPAWN_Y</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期出現位置Y</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="nc">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">current_pair</span><span class="p">:</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">fall_timer</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">fall_interval</span><span class="p">:</span><span class="w"> </span><span class="nc">FALL_INTERVAL</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">spawn_new_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">Rng</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">thread_rng</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">axis_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">::</span><span class="n">random_color</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">child_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">::</span><span class="n">random_color</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span>
<span class="w">            </span><span class="n">INITIAL_SPAWN_X</span><span class="p">,</span>
<span class="w">            </span><span class="n">INITIAL_SPAWN_Y</span><span class="p">,</span>
<span class="w">            </span><span class="n">axis_color</span><span class="p">,</span>
<span class="w">            </span><span class="n">child_color</span><span class="p">,</span>
<span class="w">        </span><span class="p">));</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">random_color</span><span class="p">(</span><span class="n">rng</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">Rng</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">,</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">,</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Yellow</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「定数化とメソッド抽出でコードが読みやすくなりましたね！」そうです！<code>random_color</code> メソッドを抽出することで、重複も減り、意図が明確になりました。</p>
<h3 id="_62">テスト実行<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>すべてのテストが通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 27 tests
test tests::test_can_move_left ... ok
test tests::test_can_move_right ... ok
test tests::test_cannot_move_left_at_left_edge ... ok
test tests::test_cannot_move_right_at_right_edge ... ok
test tests::test_can_move_down ... ok
test tests::test_cannot_move_down_at_bottom ... ok
test tests::test_cannot_move_down_when_blocked ... ok
test tests::test_auto_fall_timer ... ok
test tests::test_auto_fall_multiple_times ... ok
test tests::test_fast_fall ... ok
test tests::test_land_pair ... ok

test result: ok. 27 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！これで自動落下と高速落下の機能が完成しました。</p>
<h3 id="5_1">イテレーション5のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>落下可能判定の実装</strong></li>
<li><code>can_move_down</code> メソッド: 下に移動できるかチェック</li>
<li><code>move_down</code> メソッド: 軸ぷよと子ぷよを1マス下に移動</li>
<li>
<p>既存の <code>is_collision</code> メソッドを再利用</p>
</li>
<li>
<p><strong>自動落下タイマーの実装</strong></p>
</li>
<li><code>fall_timer</code> フィールド: 経過時間を管理</li>
<li><code>fall_interval</code> フィールド: 落下間隔（1.0秒）</li>
<li><code>update</code> メソッド: タイマーを更新し、一定間隔で <code>auto_fall</code> を呼び出し</li>
<li>
<p><code>auto_fall</code> メソッド: 落下可能なら移動、不可能なら着地処理</p>
</li>
<li>
<p><strong>高速落下の実装</strong></p>
</li>
<li><code>handle_input</code> メソッドに下キー処理を追加</li>
<li><code>is_key_pressed(KeyCode::Down)</code> で下キー押下を検出</li>
<li>
<p>即座に <code>move_down</code> を実行し、<code>fall_timer</code> をリセット</p>
</li>
<li>
<p><strong>着地処理の実装</strong></p>
</li>
<li><code>land_pair</code> メソッド: ぷよペアをボードに配置</li>
<li>軸ぷよと子ぷよの両方を配置</li>
<li>範囲チェック（y座標が0以上、BOARD_HEIGHT未満）</li>
<li>
<p><code>spawn_new_pair</code> メソッド: 次のぷよペアを生成</p>
</li>
<li>
<p><strong>ランダムなぷよ生成</strong></p>
</li>
<li><code>rand</code> クレートの導入（Cargo.toml に追加）</li>
<li><code>random_color</code> メソッド: ランダムな色を生成</li>
<li>
<p>4色（Red, Blue, Green, Yellow）からランダムに選択</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong></p>
</li>
<li><code>get_frame_time()</code> で前フレームからの経過時間を取得</li>
<li><code>update(delta_time)</code> でゲーム状態を更新</li>
<li><code>handle_input()</code> でキーボード入力を処理</li>
<li>
<p><code>draw()</code> で画面描画</p>
</li>
<li>
<p><strong>リファクタリング</strong></p>
</li>
<li>マジックナンバーの定数化: FALL_INTERVAL, INITIAL_SPAWN_X/Y</li>
<li><code>random_color</code> メソッドの抽出: ランダム色生成ロジックを共通化</li>
<li>
<p>コードの可読性向上</p>
</li>
<li>
<p><strong>テストの作成（合計27テスト）</strong></p>
</li>
<li>落下可能判定のテスト（3テスト）<ul>
<li>通常位置での落下可能</li>
<li>下端での落下不可能</li>
<li>ブロック時の落下不可能</li>
</ul>
</li>
<li>自動落下タイマーのテスト（2テスト）<ul>
<li>1秒未満では落下しない</li>
<li>1秒経過で1マス落下</li>
<li>2秒以上で複数回落下</li>
</ul>
</li>
<li>高速落下のテスト（1テスト）</li>
<li>
<p>着地処理のテスト（1テスト）</p>
</li>
<li>
<p><strong>TDDサイクルの実践</strong></p>
</li>
<li>Red: 落下・着地のテストを先に作成し失敗を確認</li>
<li>Green: 各機能を実装してテストを通過</li>
<li>
<p>Refactor: マジックナンバーの定数化、メソッド抽出</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>タイマーベースの更新処理: delta_time による時間管理</li>
<li>フレーム独立の動作: 経過時間を使った処理</li>
<li>ランダム性: rand クレートによる確率的な要素</li>
<li>状態管理: Option 型による現在のぷよペアの管理</li>
<li>リソース管理: take() による所有権の移動</li>
</ul>
</li>
</ol>
<p><strong>次のステップ</strong>: 現在、ぷよは積み重なっていきますが、まだ消去処理がありません。次のイテレーションでは、同じ色のぷよが4つ以上繋がったときに消える機能を実装していきます。</p>
<h2 id="6">イテレーション6: ぷよの消去ロジック<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを4つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_63">ユーザーストーリー<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを4つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。</p>
<h3 id="todo_5">TODOリスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 4つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 消去後の重力処理を実装する（消去された後の空きスペースにぷよが落ちてくる）</li>
</ul>
<h3 id="_64">テスト: ぷよの接続判定<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが4つ以上つながっているかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_find_connected_same_color_horizontal</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 横に4つ赤ぷよを配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">find_connected</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">);</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">connected</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_find_connected_same_color_square</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 2x2の正方形に赤ぷよを配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">find_connected</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">connected</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_find_connected_different_colors</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 市松模様に配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">find_connected</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 同じ色が2つしか繋がっていない</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">connected</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下を確認しています：</p>
<ol>
<li>横に4つ同じ色のぷよが並んでいる場合、すべて検出できるか</li>
<li>2×2の正方形に同じ色のぷよがある場合、すべて検出できるか</li>
<li>異なる色のぷよは繋がっていないと判定されるか</li>
</ol>
<h3 id="_65">実装: ぷよの接続判定（深さ優先探索）<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>「接続判定はどうやって実装するんですか？」深さ優先探索（DFS: Depth-First Search）というアルゴリズムを使います。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">collections</span><span class="p">::</span><span class="n">HashSet</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">find_connected</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">start_x</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">start_y</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">HashSet</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 開始位置が範囲外または空の場合は空のセットを返す</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">start_x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">start_x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BOARD_WIDTH</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">||</span>
<span class="w">           </span><span class="n">start_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">start_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BOARD_HEIGHT</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">connected</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">start_y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">][</span><span class="n">start_x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">color</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">color</span><span class="p">,</span>
<span class="w">            </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">connected</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 深さ優先探索</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">dfs</span><span class="p">(</span><span class="n">start_x</span><span class="p">,</span><span class="w"> </span><span class="n">start_y</span><span class="p">,</span><span class="w"> </span><span class="n">start_color</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">connected</span><span class="p">);</span>

<span class="w">        </span><span class="n">connected</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">target_color</span><span class="p">:</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 範囲チェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BOARD_WIDTH</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BOARD_HEIGHT</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 既に訪問済みならスキップ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">visited</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 色が一致するかチェック</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">][</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">color</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">target_color</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">visited</span><span class="p">.</span><span class="n">insert</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">));</span>

<span class="w">                </span><span class="c1">// 4方向を探索</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">dfs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">target_color</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">);</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">dfs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">target_color</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">);</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">dfs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">target_color</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">);</span><span class="w"> </span><span class="c1">// 下</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">dfs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">target_color</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">);</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「深さ優先探索って何ですか？」良い質問ですね！深さ優先探索は、グラフや木構造を探索するアルゴリズムの一つです。ある地点から開始して、可能な限り深く（遠く）まで探索してから、別の経路を探索する方法です。</p>
<p>このアルゴリズムでは、以下のことを行います：</p>
<ol>
<li>開始地点から同じ色のぷよがあるか確認</li>
<li>あれば訪問済みとしてマークし、4方向（上下左右）を再帰的に探索</li>
<li>すでに訪問済みの場所や、異なる色の場所はスキップ</li>
<li>すべての繋がったぷよを <code>HashSet</code> に格納</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 30 tests
test tests::test_find_connected_same_color_horizontal ... ok
test tests::test_find_connected_same_color_square ... ok
test tests::test_find_connected_different_colors ... ok

test result: ok. 30 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！これで接続判定が実装できました。</p>
<h3 id="_66">テスト: ぷよの消去判定<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>「次は消去判定ですね！」そうです。4つ以上繋がったぷよをすべて見つける機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_check_erase_4_connected</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 横に4つ赤ぷよを配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">check_erase</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">erase_positions</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_check_erase_less_than_4</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 横に3つ赤ぷよを配置（消えない）</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">check_erase</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">erase_positions</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_check_erase_multiple_groups</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 2つのグループ</span>
<span class="w">    </span><span class="c1">// 赤ぷよ4つ（横）</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 青ぷよ4つ（縦）</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">check_erase</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">erase_positions</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4 + 4</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_67">実装: ぷよの消去判定<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">check_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">HashSet</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">checked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ボード全体を走査</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">BOARD_HEIGHT</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">BOARD_WIDTH</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">x_i32</span><span class="p">,</span><span class="w"> </span><span class="n">y_i32</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// 既にチェック済みまたは空のセルはスキップ</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">checked</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">x_i32</span><span class="p">,</span><span class="w"> </span><span class="n">y_i32</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 接続しているぷよを探索</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">find_connected</span><span class="p">(</span><span class="n">x_i32</span><span class="p">,</span><span class="w"> </span><span class="n">y_i32</span><span class="p">);</span>

<span class="w">                    </span><span class="c1">// チェック済みに追加</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">connected</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">checked</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>

<span class="w">                    </span><span class="c1">// 4つ以上繋がっている場合は消去対象</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">connected</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">erase_positions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">erase_positions</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、ボード全体を走査して4つ以上繋がったグループを見つけるんですね！」そうです！この実装では：</p>
<ol>
<li>ボード全体を走査</li>
<li>各ぷよについて <code>find_connected</code> で繋がっているぷよを探索</li>
<li>4つ以上繋がっていれば消去対象としてマーク</li>
<li>既にチェック済みのぷよはスキップ（効率化）</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 33 tests
test tests::test_check_erase_4_connected ... ok
test tests::test_check_erase_less_than_4 ... ok
test tests::test_check_erase_multiple_groups ... ok

test result: ok. 33 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<h3 id="_68">テスト: ぷよの消去処理<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>「次は実際に消す処理ですね！」そうです。消去対象のぷよを実際に消すテストを書きましょう。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_erase_puyos</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 横に4つ赤ぷよを配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">check_erase</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">erase_puyos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erase_positions</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// すべて消えている</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_69">実装: ぷよの消去処理<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">erase_puyos</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">HashSet</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BOARD_WIDTH</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BOARD_HEIGHT</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">][</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうです！指定された位置のぷよを <code>Cell::Empty</code> にするだけです。</p>
<h3 id="_70">テスト: 重力処理（消去後の落下）<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>「ぷよを消した後、上にあるぷよが落ちてくる必要がありますよね？」その通りです！重力処理のテストを書きましょう。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_apply_gravity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 浮いているぷよを配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span><span class="w"> </span><span class="c1">// 下端</span>

<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">apply_gravity</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 赤ぷよが1マス落下</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// 青ぷよは動かない</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_71">実装: 重力処理<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">apply_gravity</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 各列ごとに処理</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="bp">self</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 下から詰めていく</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">write_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// 書き込み位置（下から）</span>

<span class="w">            </span><span class="c1">// 下から上にスキャンして、ぷよを収集</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">read_y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="bp">self</span><span class="p">.</span><span class="n">rows</span><span class="p">).</span><span class="n">rev</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">color</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">read_y</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// ぷよがある場合</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">read_y</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">write_y</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// 位置が異なる場合は移動</span>
<span class="w">                        </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">write_y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="w">                        </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">read_y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">;</span>
<span class="w">                        </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="c1">// 次の書き込み位置を1つ上に</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">write_y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">write_y</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">has_fallen</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>has_fallen</code> を返すのはなぜですか？」良い質問ですね！重力処理は、ぷよが安定するまで繰り返し実行する必要があります。<code>has_fallen</code> が <code>true</code> の場合、まだ落下中のぷよがあるので、もう一度重力処理を実行します。</p>
<p>この実装では、各列ごとに下から詰めていく方式を採用しています。これにより、一度の <code>apply_gravity</code> 呼び出しで、すべてのぷよが最終的な位置まで落下します。</p>
<h3 id="_72">ゲームループとの統合<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>「これらをゲームループに統合しましょう！」そうですね。ゲームモードに消去処理と重力処理を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Start</span><span class="p">,</span>
<span class="w">    </span><span class="n">Playing</span><span class="p">,</span>
<span class="w">    </span><span class="n">Checking</span><span class="p">,</span><span class="w">   </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="n">Erasing</span><span class="p">,</span><span class="w">    </span><span class="c1">// 消去中</span>
<span class="w">    </span><span class="n">Falling</span><span class="p">,</span><span class="w">    </span><span class="c1">// 落下中</span>
<span class="w">    </span><span class="n">GameOver</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Playing</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 落下タイマーを更新</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta_time</span><span class="p">;</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_interval</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">auto_fall</span><span class="p">();</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Checking</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 消去判定</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">check_erase</span><span class="p">();</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">erase_positions</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">erase_puyos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erase_positions</span><span class="p">);</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 消去対象がなければ新しいぷよを出す</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Falling</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 重力を適用</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">has_fallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">apply_gravity</span><span class="p">();</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">has_fallen</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 落下が終わったら再び消去判定</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Checking</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">auto_fall</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">can_move_down</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">move_down</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 着地処理</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">land_pair</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">land_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">pair</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">take</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 軸ぷよをボードに配置</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                    </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_color</span><span class="p">),</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 子ぷよをボードに配置</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                    </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_color</span><span class="p">),</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 重力処理モードへ移行</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームモードの遷移が複雑になりましたね！」そうですね。整理すると：</p>
<ol>
<li><strong>Playing</strong>: ぷよが落下中</li>
<li><strong>着地</strong>: <code>land_pair()</code> でぷよをボードに配置し、Falling モードへ</li>
<li><strong>Falling</strong>: 重力を適用、落下が終わったら Checking へ</li>
<li><strong>Checking</strong>: 消去判定を実行、消去対象があれば Erasing へ</li>
<li><strong>Erasing</strong>: ぷよを消去（即座に Falling へ）</li>
<li><strong>Falling</strong>: 重力を適用、落下が終わったら Checking へ</li>
<li><strong>Checking</strong>: 消去対象がなければ Playing（新しいぷよ）</li>
</ol>
<p>「連鎖も自動的に起きるんですね！」その通りです！Checking → Erasing → Falling → Checking のループで、連鎖が自動的に発生します。</p>
<h3 id="_73">バグ対応: 着地後の重力処理<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>「実際にゲームを動かしてみたら、バグを見つけました！」どのようなバグでしたか？</p>
<p>「縦になったぷよペアを着地させた後、横向きのぷよペアを重ねたとき、重なっていない方のぷよが浮いたままになってしまいます。」</p>
<p>なるほど！具体的には、こんな状態ですね：</p>
<div class="highlight"><pre><span></span><code>    2列  3列
9行  [ ]  [ ]
10行 [赤] [ ]
11行 [赤] [ ]
</code></pre></div>
<p>この状態で、横向きペア（青・青）を (2, 9)-(3, 9) に着地させると：</p>
<div class="highlight"><pre><span></span><code>    2列  3列
9行  [青] [青]  ← この右側の青が浮いたまま
10行 [赤] [ ]
11行 [赤] [ ]
</code></pre></div>
<p>「そうです！3列の青ぷよが落ちるべきなのに、落ちないんです。」</p>
<h4 id="_74">バグの原因<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h4>
<p>問題は、最初の実装で <code>land_pair()</code> が <code>Checking</code> モードに直接遷移していたことです：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">land_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... ぷよをボードに配置 ...</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Checking</span><span class="p">;</span><span class="w">  </span><span class="c1">// ← これが問題</span>
<span class="p">}</span>
</code></pre></div>
<p>このため、着地直後に消去判定が実行され、重力処理がスキップされていました。</p>
<h4 id="l">テスト: L 字型配置での重力処理<a class="headerlink" href="#l" title="Permanent link">&para;</a></h4>
<p>まず、この問題を再現するテストを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_apply_gravity_l_shape</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// L字型の配置（縦向きペア + 横向きペアを重ねた状態を模擬）</span>
<span class="w">    </span><span class="c1">// 縦向きペア: (2,10), (2,11)</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">));</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// 横向きペア: (2,9), (3,9) - 着地直後の状態</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">));</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">));</span>

<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">apply_gravity</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// (2,9)は(2,10)の上なので動かない</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">)));</span>
<span class="w">    </span><span class="c1">// (3,9)は下が空いているので(3,11)まで落ちる</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="p">));</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">get_cell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">)));</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストは通りますか？」まず <code>apply_gravity</code> の実装は正しいので、このテストは通ります。</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test_apply_gravity_l_shape
</code></pre></div>
<div class="highlight"><pre><span></span><code>test board::tests::test_apply_gravity_l_shape ... ok
</code></pre></div>
<p>「では、何が問題だったんですか？」問題は、ゲームフロー内で <code>land_pair</code> 後に重力処理をスキップしていたことです。</p>
<h4 id="falling">修正: 着地後は Falling モードへ<a class="headerlink" href="#falling" title="Permanent link">&para;</a></h4>
<p>解決策は、<code>land_pair()</code> 後に <code>Falling</code> モードに遷移させることです：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">land_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">pair</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">take</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 軸ぷよをボードに配置</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">axis_y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">axis_color</span><span class="p">),</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 子ぷよをボードに配置</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">board</span><span class="p">.</span><span class="n">set_cell</span><span class="p">(</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">child_x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">child_y</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">child_color</span><span class="p">),</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 重力処理モードへ移行（修正後）</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Falling</span><span class="p">;</span><span class="w">  </span><span class="c1">// ← Checking から Falling に変更</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「これで正しい流れになりましたね！」そうです！修正後のゲームフローは：</p>
<ol>
<li><strong>着地</strong>: <code>land_pair()</code> でぷよをボードに配置</li>
<li><strong>Falling</strong>: 重力を適用（浮いたぷよが落ちる）</li>
<li><strong>Checking</strong>: 消去判定を実行</li>
<li><strong>Erasing</strong>: 必要に応じて消去</li>
<li><strong>Falling</strong>: 消去後の重力処理（連鎖）</li>
</ol>
<p>テストを実行して、すべてが通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>cargo<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>running 38 tests
...
test board::tests::test_apply_gravity_l_shape ... ok
...

test result: ok. 38 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre></div>
<p>「バグが修正されました！」素晴らしい！実際にゲームを動かしてみて、バグを見つけて修正するというプロセスは、ソフトウェア開発において非常に重要です。</p>
<h4 id="_75">学んだこと<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h4>
<p>このバグ対応から学んだこと：</p>
<ol>
<li><strong>テストだけでは不十分</strong>: 個々のメソッドが正しくても、統合時にバグが発生することがある</li>
<li><strong>ゲームフローの重要性</strong>: 状態遷移の順序が重要</li>
<li><strong>バグ再現テストの価値</strong>: バグを再現するテストを書くことで、同じバグの再発を防げる</li>
<li><strong>段階的なデバッグ</strong>: 問題を切り分けて、原因を特定する</li>
</ol>
<h3 id="6_1">イテレーション6のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>接続判定の実装</strong></li>
<li><code>find_connected</code> メソッド: 深さ優先探索で繋がったぷよを検出</li>
<li><code>dfs</code> メソッド: 再帰的に4方向を探索</li>
<li>
<p><code>HashSet</code> を使って訪問済み管理と結果の格納</p>
</li>
<li>
<p><strong>消去判定の実装</strong></p>
</li>
<li><code>check_erase</code> メソッド: ボード全体を走査して4つ以上繋がったぷよを検出</li>
<li>複数のグループを同時に検出可能</li>
<li>
<p>効率化: 既にチェック済みのぷよはスキップ</p>
</li>
<li>
<p><strong>消去処理の実装</strong></p>
</li>
<li>
<p><code>erase_puyos</code> メソッド: 指定された位置のぷよを <code>Cell::Empty</code> に設定</p>
</li>
<li>
<p><strong>重力処理の実装</strong></p>
</li>
<li><code>apply_gravity</code> メソッド: 各列ごとに下から詰める方式で、すべてのぷよを最終位置まで一気に落とす</li>
<li>戻り値で落下の有無を返す</li>
<li>
<p>列ごとに処理することで効率的に実装</p>
</li>
<li>
<p><strong>ゲームモードの追加</strong></p>
</li>
<li><code>Checking</code>: 消去判定</li>
<li><code>Erasing</code>: 消去中</li>
<li><code>Falling</code>: 落下中</li>
<li>
<p>モード遷移: Playing → 着地 → Falling → Checking → Erasing → Falling → Checking → ...</p>
</li>
<li>
<p><strong>連鎖の自動発生</strong></p>
</li>
<li>Checking-Falling ループで自動的に連鎖が発生</li>
<li>
<p>消去対象がなくなるまで繰り返し</p>
</li>
<li>
<p><strong>バグ対応: 着地後の重力処理</strong></p>
</li>
<li>問題: <code>land_pair()</code> が <code>Checking</code> モードに直接遷移していた</li>
<li>影響: 着地後に重力処理がスキップされ、浮いたぷよが落ちない</li>
<li>修正: <code>land_pair()</code> 後に <code>Falling</code> モードに遷移するように変更</li>
<li>
<p>テスト追加: <code>test_apply_gravity_l_shape</code> で L 字型配置の重力処理を検証</p>
</li>
<li>
<p><strong>テストの作成（合計38テスト）</strong></p>
</li>
<li>接続判定のテスト（3テスト）</li>
<li>消去判定のテスト（3テスト）</li>
<li>消去処理のテスト（1テスト）</li>
<li>
<p>重力処理のテスト（4テスト）</p>
<ul>
<li>基本的な重力処理</li>
<li>複数ぷよの同時落下</li>
<li>積み重ねられたぷよの落下</li>
<li>L 字型配置での重力処理（バグ再現テスト）</li>
</ul>
</li>
<li>
<p><strong>TDDサイクルの実践</strong></p>
</li>
<li>Red: 各機能のテストを先に作成</li>
<li>Green: 実装してテストを通過</li>
<li>Refactor: DFS アルゴリズムの分離</li>
<li>
<p>バグ発見 → テスト追加 → 修正のサイクル</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>深さ優先探索（DFS）: グラフ探索の基本アルゴリズム</li>
<li><code>HashSet</code>: 重複のない集合の管理</li>
<li>再帰: 自分自身を呼び出すメソッド</li>
<li>ゲーム状態管理: モード遷移による複雑な処理の分離</li>
<li>統合バグの重要性: 個々のメソッドが正しくても、統合時にバグが発生することがある</li>
<li>バグ再現テストの価値: バグを再現するテストを書くことで、同じバグの再発を防げる</li>
</ul>
</li>
</ol>
<p><strong>次のステップ</strong>: 現在、ぷよは消えて連鎖も発生しますが、スコア計算がありません。次のイテレーションでは、スコアと連鎖数の表示を実装していきます。</p>
<h2 id="7">イテレーション7: スコアと連鎖数の表示<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="_76">ユーザーストーリー<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<blockquote>
<p>プレイヤーとして、スコアと連鎖数を確認できる</p>
</blockquote>
<p>「ぷよが消えるようになったけど、スコアが表示されないと達成感がないですね！」そうですね！今回は、スコアと連鎖数の表示機能を実装していきましょう。</p>
<h3 id="_77">実装概要<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>スコアシステムでは以下を実装します：</p>
<ol>
<li><strong>スコア構造体の追加</strong></li>
<li><strong>連鎖数のカウント</strong></li>
<li><strong>スコア計算ロジック</strong></li>
<li><strong>画面への表示</strong></li>
</ol>
<h3 id="_78">スコア構造体の実装<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">chain</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">total</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">erased_count</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">chain</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 基本スコア: 消したぷよの数 × 10</span>
<span class="w">        </span><span class="c1">// 連鎖ボーナス: 2^chain</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">chain_bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">2_</span><span class="k">u32</span><span class="p">.</span><span class="n">pow</span><span class="p">(</span><span class="n">chain</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">erased_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chain_bonus</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">points</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">reset_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">increment_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">chain</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_79">ゲームループとの統合<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">board</span><span class="p">:</span><span class="w"> </span><span class="nc">Board</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">current_pair</span><span class="p">:</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">fall_timer</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">            </span><span class="n">fall_interval</span><span class="p">:</span><span class="w"> </span><span class="nc">FALL_INTERVAL</span><span class="p">,</span>
<span class="w">            </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="nc">GameMode</span><span class="p">::</span><span class="n">Start</span><span class="p">,</span>
<span class="w">            </span><span class="n">score</span><span class="p">:</span><span class="w"> </span><span class="nc">Score</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Checking</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">check_erase</span><span class="p">();</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">erase_positions</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 連鎖数を増加</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">increment_chain</span><span class="p">();</span>

<span class="w">                    </span><span class="c1">// スコアを加算</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">erase_positions</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">chain</span><span class="p">);</span>

<span class="w">                    </span><span class="c1">// 消去処理</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">erase_puyos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erase_positions</span><span class="p">);</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 連鎖終了</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">reset_chain</span><span class="p">();</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// ... 他のモード処理 ...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_80">画面表示の実装<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ボードを描画</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">draw</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">pair</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pair</span><span class="p">.</span><span class="n">draw</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// スコアを表示</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">score_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Score: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">total</span><span class="p">);</span>
<span class="w">        </span><span class="n">draw_text</span><span class="p">(</span><span class="o">&amp;</span><span class="n">score_text</span><span class="p">,</span><span class="w"> </span><span class="mf">250.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 連鎖数を表示</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">chain</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">chain_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Chain: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">chain</span><span class="p">);</span>
<span class="w">            </span><span class="n">draw_text</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain_text</span><span class="p">,</span><span class="w"> </span><span class="mf">250.0</span><span class="p">,</span><span class="w"> </span><span class="mf">60.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="n">YELLOW</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_81">テスト<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_score_calculation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 1連鎖: 4つ消去</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">increment_chain</span><span class="p">();</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">chain</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">score</span><span class="p">.</span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4 * 10 * 1</span>

<span class="w">    </span><span class="c1">// 2連鎖: 4つ消去</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">increment_chain</span><span class="p">();</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">chain</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">score</span><span class="p">.</span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">);</span><span class="w"> </span><span class="c1">// 40 + (4 * 10 * 2)</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="8">イテレーション8: ゲームオーバー判定<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="_82">ユーザーストーリー<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<blockquote>
<p>システムとして、ぷよが画面上端に到達したらゲームオーバーになる</p>
</blockquote>
<p>「ぷよが積み重なって画面の上まで行ったらどうなるんですか？」それがゲームオーバーです！今回は、ゲームオーバーの判定と表示を実装します。</p>
<h3 id="_83">実装概要<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">spawn_new_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">Rng</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">::</span><span class="n">thread_rng</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">axis_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">::</span><span class="n">random_color</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">child_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">::</span><span class="n">random_color</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoPair</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">INITIAL_SPAWN_X</span><span class="p">,</span><span class="w"> </span><span class="n">INITIAL_SPAWN_Y</span><span class="p">,</span><span class="w"> </span><span class="n">axis_color</span><span class="p">,</span><span class="w"> </span><span class="n">child_color</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ゲームオーバー判定: 新しいぷよが配置できない</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">new_pair</span><span class="p">.</span><span class="n">is_collision</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">new_pair</span><span class="p">.</span><span class="n">axis_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_pair</span><span class="p">.</span><span class="n">axis_y</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">new_pair</span><span class="p">.</span><span class="n">child_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_pair</span><span class="p">.</span><span class="n">child_y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">GameOver</span><span class="p">;</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">current_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">new_pair</span><span class="p">);</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">fall_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ... 通常の描画 ...</span>

<span class="w">        </span><span class="c1">// ゲームオーバー表示</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">GameOver</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;GAME OVER&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="p">,</span><span class="w"> </span><span class="mf">200.0</span><span class="p">,</span><span class="w"> </span><span class="mf">50.0</span><span class="p">,</span><span class="w"> </span><span class="n">RED</span><span class="p">);</span>
<span class="w">            </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;Press R to Restart&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">80.0</span><span class="p">,</span><span class="w"> </span><span class="mf">250.0</span><span class="p">,</span><span class="w"> </span><span class="mf">30.0</span><span class="p">,</span><span class="w"> </span><span class="n">WHITE</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle_input</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ゲームオーバー時のリスタート</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">GameOver</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">is_key_pressed</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">::</span><span class="n">R</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="bp">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ... 通常の入力処理 ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_84">テスト<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_game_over_when_spawn_blocked</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 出現位置にぷよを配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 新しいぷよを出そうとする</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになる</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">GameOver</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">.</span><span class="n">is_none</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="9">イテレーション9: 全消しボーナス<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="_85">ユーザーストーリー<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<blockquote>
<p>プレイヤーとして、すべてのぷよを消したときに全消しボーナスを得られる</p>
</blockquote>
<p>「すべてのぷよを消すと特別なボーナスがあるんですよね？」そうです！全消しは大きなボーナスポイントが得られる特別な達成です。</p>
<h3 id="_86">実装概要<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_all_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">BOARD_HEIGHT</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">BOARD_WIDTH</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Empty</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">add_all_clear_bonus</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 全消しボーナス</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Checking</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">erase_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">check_erase</span><span class="p">();</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">erase_positions</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">increment_chain</span><span class="p">();</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">erase_positions</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">chain</span><span class="p">);</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">erase_puyos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erase_positions</span><span class="p">);</span>

<span class="w">                    </span><span class="c1">// 全消しチェック</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">is_all_clear</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">add_all_clear_bonus</span><span class="p">();</span>
<span class="w">                    </span><span class="p">}</span>

<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">reset_chain</span><span class="p">();</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// ... 他のモード処理 ...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ... 通常の描画 ...</span>

<span class="w">        </span><span class="c1">// 全消し表示</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">is_all_clear</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">::</span><span class="n">Checking</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">draw_text</span><span class="p">(</span><span class="s">&quot;ALL CLEAR!&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="p">,</span><span class="w"> </span><span class="mf">300.0</span><span class="p">,</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w"> </span><span class="n">GOLD</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_87">テスト<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_all_clear_detection</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">is_all_clear</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">board2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">board2</span><span class="p">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span><span class="p">::</span><span class="n">Filled</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">board2</span><span class="p">.</span><span class="n">is_all_clear</span><span class="p">());</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_all_clear_bonus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>

<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">add_all_clear_bonus</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">score</span><span class="p">.</span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="mi">6000</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1000 + 5000</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_88">まとめ<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h2>
<h3 id="_89">完成したゲームの機能<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h3>
<p>このチュートリアルで実装した機能：</p>
<ol>
<li><strong>基本操作</strong></li>
<li>ぷよペアの左右移動</li>
<li>ぷよペアの回転（壁キック付き）</li>
<li>
<p>高速落下</p>
</li>
<li>
<p><strong>ゲームロジック</strong></p>
</li>
<li>自動落下</li>
<li>着地判定</li>
<li>消去判定（4つ以上の同色ぷよ）</li>
<li>重力処理</li>
<li>
<p>連鎖システム</p>
</li>
<li>
<p><strong>スコアシステム</strong></p>
</li>
<li>基本スコア</li>
<li>連鎖ボーナス</li>
<li>
<p>全消しボーナス</p>
</li>
<li>
<p><strong>ゲーム管理</strong></p>
</li>
<li>ゲームオーバー判定</li>
<li>リスタート機能</li>
</ol>
<h3 id="_90">統合テスト<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h3>
<p>ここまで、各モジュールのユニットテストを各ソースファイルの末尾に配置してきました。これはRustの標準的な作法です。しかし、プロジェクトが成長するにつれて、複数のモジュールを組み合わせた実際のゲームシナリオをテストする必要が出てきます。</p>
<p>Rustでは、このような統合テストを <code>tests/</code> ディレクトリに配置します。統合テストは外部のクレートと同じようにライブラリを使用するため、公開API（<code>pub</code>で宣言された要素）のみにアクセスできます。</p>
<h4 id="_91">統合テストの作成<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h4>
<p><code>tests/integration_test.rs</code> を作成して、実際のゲームシナリオをテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/integration_test.rs</span>
<span class="k">use</span><span class="w"> </span><span class="n">puyo_puyo_game</span><span class="p">::</span><span class="n">game</span><span class="p">::</span><span class="n">Game</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">puyo_puyo_game</span><span class="p">::</span><span class="n">board</span><span class="p">::</span><span class="n">PuyoColor</span><span class="p">;</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_complete_game_scenario</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームが正しく初期化されている</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">chain_count</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ゲームを開始</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ぷよペアが生成されている</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">().</span><span class="n">is_some</span><span class="p">());</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_puyo_erasure_and_scoring</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 消去可能な配置を作成（4つの赤ぷよ）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 残るぷよを配置（全消しを防ぐ）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去判定を実行</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">check_and_erase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// スコアが加算されている</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">(),</span><span class="w"> </span><span class="mi">40</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4 * 10 = 40</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">chain_count</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_chain_reaction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 1連鎖目の配置（赤4つ）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 2連鎖目の配置（青3つ、赤の上）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 残るぷよを配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Green</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 1回目の消去判定</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">check_and_erase</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">first_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">();</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">first_score</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4 * 10 * 1</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">chain_count</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 重力を適用</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">apply_gravity</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 2回目の消去判定（青が落ちて4つ揃う）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">check_and_erase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 2連鎖ボーナスが付いている</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">(),</span><span class="w"> </span><span class="mi">120</span><span class="p">);</span><span class="w"> </span><span class="c1">// 40 + (4 * 10 * 2)</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">chain_count</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_all_clear_bonus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 消去可能な4つの赤ぷよのみ配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去判定を実行</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">check_and_erase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 基本スコア + 全消しボーナス</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">(),</span><span class="w"> </span><span class="mi">5040</span><span class="p">);</span><span class="w"> </span><span class="c1">// 40 + 5000</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">board</span><span class="p">().</span><span class="n">is_all_clear</span><span class="p">());</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_game_over_when_spawn_position_blocked</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 出現位置(2, 1)にぷよを配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 新しいぷよペアを生成しようとする</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">spawn_new_pair</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになる</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">is_game_over</span><span class="p">());</span>
<span class="p">}</span>

<span class="cp">#[test]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">test_restart_resets_game_state</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲーム状態を変更</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">board_mut</span><span class="p">().</span><span class="n">set_cell</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">::</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">add_score</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// リスタート</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">restart</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// すべてがリセットされている</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">chain_count</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">board</span><span class="p">().</span><span class="n">is_all_clear</span><span class="p">());</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">current_pair</span><span class="p">().</span><span class="n">is_some</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_92">統合テストの実行<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h4>
<p>統合テストは通常のテストと同じように実行できます：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># すべてのテスト（ユニット + 統合）を実行</span>
cargo<span class="w"> </span><span class="nb">test</span>

<span class="c1"># 統合テストのみ実行</span>
cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--test<span class="w"> </span>integration_test

<span class="c1"># 特定のテストを実行</span>
cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test_chain_reaction
</code></pre></div>
<h4 id="_93">ユニットテストと統合テストの使い分け<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h4>
<p><strong>ユニットテスト（<code>src/</code> 内の <code>#[cfg(test)]</code> モジュール）</strong>：
- 個別の関数やメソッドの動作を検証
- 内部実装の詳細をテスト可能
- 高速で実行できる
- 各モジュールの責務を明確化</p>
<p><strong>統合テスト（<code>tests/</code> ディレクトリ）</strong>：
- 複数のモジュールを組み合わせた動作を検証
- 公開APIのみを使用（実際の利用シーンに近い）
- エンドツーエンドのシナリオをテスト
- ライブラリ全体の動作を保証</p>
<p>このように、ユニットテストと統合テストを組み合わせることで、個々のコンポーネントから全体のシステムまで、包括的にテストできます。</p>
<h3 id="tdd">TDDで学んだこと<a class="headerlink" href="#tdd" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Red-Green-Refactor サイクル</strong></li>
<li>失敗するテストを先に書く</li>
<li>最小限の実装でテストを通す</li>
<li>
<p>コードを改善する</p>
</li>
<li>
<p><strong>Rustの重要な概念</strong></p>
</li>
<li>所有権とボロウイング</li>
<li>enum と match による状態管理</li>
<li>Option 型による null 安全性</li>
<li>Result 型によるエラーハンドリング</li>
<li>
<p>trait による抽象化</p>
</li>
<li>
<p><strong>アルゴリズム</strong></p>
</li>
<li>深さ優先探索（DFS）</li>
<li>衝突判定</li>
<li>
<p>回転行列</p>
</li>
<li>
<p><strong>ゲーム開発パターン</strong></p>
</li>
<li>ゲームループ</li>
<li>状態遷移</li>
<li>タイマー管理</li>
<li>入力処理</li>
</ol>
<h3 id="_94">次のステップ<a class="headerlink" href="#_94" title="Permanent link">&para;</a></h3>
<p>このゲームをさらに発展させるアイデア：</p>
<ol>
<li><strong>グラフィックの改善</strong></li>
<li>ぷよの画像を使用</li>
<li>アニメーション効果</li>
<li>
<p>パーティクルエフェクト</p>
</li>
<li>
<p><strong>音声の追加</strong></p>
</li>
<li>BGM</li>
<li>
<p>効果音</p>
</li>
<li>
<p><strong>追加機能</strong></p>
</li>
<li>ネクストぷよの表示</li>
<li>ホールド機能</li>
<li>ハイスコア記録</li>
<li>
<p>難易度調整</p>
</li>
<li>
<p><strong>マルチプレイ</strong></p>
</li>
<li>対戦モード</li>
<li>ネットワーク対戦</li>
</ol>
<h3 id="_95">終わりに<a class="headerlink" href="#_95" title="Permanent link">&para;</a></h3>
<p>「TDDでゲームを作るのは楽しかったです！」そうですね！テスト駆動開発は、最初は面倒に感じるかもしれませんが、確実に品質の高いコードを書くことができます。</p>
<p>「次は何を作りましょうか？」良い質問ですね！学んだTDDの技術を使って、自分のオリジナルなゲームやアプリケーションを作ってみてください。Rustの型システムとテストの力を借りれば、安全で高品質なソフトウェアを作ることができます。</p>
<p>ぷよぷよを通じてテスト駆動開発とRustの基礎を学べたことを願っています。Happy Coding!</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>