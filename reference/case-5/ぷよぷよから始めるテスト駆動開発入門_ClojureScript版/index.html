
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 - ClojureScript版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#-clojurescript" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 - ClojureScript版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="-clojurescript">ぷよぷよから始めるテスト駆動開発入門 - ClojureScript版<a class="headerlink" href="#-clojurescript" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、ClojureScriptでぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームをClojureScriptで実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。</p>
<h3 id="clojurescript">なぜClojureScriptなのか？<a class="headerlink" href="#clojurescript" title="Permanent link">&para;</a></h3>
<p>ClojureScriptは、Clojureの関数型プログラミングの哲学をJavaScript環境で実現する言語です。以下のような特徴があります：</p>
<ul>
<li><strong>Immutability（不変性）</strong>: データが変更されないため、バグが入りにくい</li>
<li><strong>Simple Made Easy</strong>: シンプルさを重視した設計哲学</li>
<li><strong>強力なマクロシステム</strong>: コード生成による高い抽象化</li>
<li><strong>REPLによる対話的開発</strong>: 即座にフィードバックを得られる開発体験</li>
</ul>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>言語</strong>: ClojureScript — 関数型プログラミングのシンプルさとJavaScriptエコシステムの両立</li>
<li><strong>ビルドツール</strong>: shadow-cljs — 高速コンパイル、npmとの統合、ホットリロード対応</li>
<li><strong>テストフレームワーク</strong>: cljs.test — ClojureScript標準のテストライブラリ</li>
<li><strong>タスクランナー</strong>: Gulp — 反復的なタスクを自動化</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡</li>
<li><strong>静的解析</strong>: clj-kondo — ClojureScript対応の高速Linter</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション0: 環境の構築で解説します。</p>
<h2 id="_4">要件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">ユーザーストーリー<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。
ユーザーストーリーには形式が定められておらず、標準的な記法もない。とはいえ、次のような形式でストーリーを考えてみると便利である。「＜ユーザーの種類＞として、＜機能や性能＞がほしい。それは＜ビジネス価値＞のためだ」という形のテンプレートに従うと、
たとえば次のようなストーリーを書ける。「本の購入者として、ＩＳＢＮで本を検索したい。それは探している本をすばやく見つけるためだ」</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう：</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜n！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PCでプレイするなら必須ですよね）</li>
<li>プレイヤーとして、タッチ操作でぷよを操作できる（スマホでもプレイしたいですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_6">ユースケース図<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>ユーザーストーリーを整理したところで、「これらの機能がどのように関連しているのか、全体像が見えるといいな」と思いませんか？そんなときに役立つのが「ユースケース図」です。</p>
<p>「ユースケース図って何？」と思われるかもしれませんね。ユースケース図は、システムと外部アクター（ここではプレイヤーとシステム自体）の相互作用を視覚的に表現するための図です。「絵に描いて整理すると分かりやすい」というやつですね。</p>
<blockquote>
<p>ユースケースは、システムの振る舞いに関する利害関係者の契約を表現するものです。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<p>「百聞は一見にしかず」というように、実際に見てみるのが一番分かりやすいですよね。では、私たちのぷよぷよゲームのユースケース図を見てみましょう：</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjU5MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODI2cHg7aGVpZ2h0OjU5MHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgyNiA1OTAiIHdpZHRoPSI4MjZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU3NyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxNS4wNyIgeD0iMTEyIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1My45OTkzIiB4PSIzNDIuNTM1MyIgeT0iMjEuOTk1MSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MDc7JiMxMjQyNDsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfU3RhcnROZXdHYW1lIj48ZWxsaXBzZSBjeD0iMjE0LjAyNTkiIGN5PSI1NDEuOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMTUxLjAyNjIiIHk9IjU0Ni42NDM2Ij4mIzI2MDMyOyYjMTIzNzU7JiMxMjM1NjsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDM0OyYjMzgyODM7JiMyMjk4Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9SZXN0YXJ0R2FtZSI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iNDcwLjk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI0NzUuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQzNDsmIzEyNTIyOyYjMTI0NzM7JiMxMjQ3OTsmIzEyNTQwOyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1vdmVQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfTW92ZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjEzMS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNTguMDMyNyIgeT0iMTM1LjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMjQwMzg7JiMyMTQ5MTsmIzEyMzk1OyYjMzEyMjc7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUm90YXRlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfUm90YXRlUHV5byI+PGVsbGlwc2UgY3g9IjIxNC4wMjczIiBjeT0iNjUuMDAzNiIgZmlsbD0iI0YxRjFGMSIgcng9IjUyLjQ5NzMiIHJ5PSIxNC41MjM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSIxNzkuMDI3NCIgeT0iNjkuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyMjIzODsmIzM2NTc4OzwvdGV4dD48L2c+PCEtLWVudGl0eSBRdWlja0Ryb3BQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlF1aWNrRHJvcFB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjIwIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV9RdWlja0Ryb3BQdXlvIj48ZWxsaXBzZSBjeD0iMjE0LjAzMjQiIGN5PSIyMDAuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMTU4LjAzMjciIHk9IjIwNC42NDg5Ij4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzMyMDMyOyYjMjYwODk7JiMxMjM2NzsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZhbGxQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZhbGxQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfRmFsbFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI1MiIgY3k9IjMzMC45OTUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI2Ni43MjUyIiByeT0iMTUuNzQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIxNjUuMDI1NCIgeT0iMzM1LjY0MzUiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMzMyNTg7JiMzMDAwMTsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEVyYXNlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJFcmFzZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9FcmFzZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI3MyIgY3k9IjI2Ni4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjE3OS4wMjc0IiB5PSIyNzAuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyODA0MDsmIzIxNDM1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjI3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9DaGFpblJlYWN0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTIiIGN5PSIyNTcuOTk1IiBmaWxsPSIjRjFGMUYxIiByeD0iNjYuNzI1MiIgcnk9IjE1Ljc0NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMzg3LjAzNTQiIHk9IjI2Mi42NDM1Ij4mIzM2ODk5OyYjMzc3ODI7JiMyMTQ1MzsmIzI0NTQwOyYjMTI0MzQ7JiMzMDMzMDsmIzI5OTgzOzwvdGV4dD48L2c+PCEtLWVudGl0eSBaZW5rZXNoaUJvbnVzLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ilplbmtlc2hpQm9udXMiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0iZW50MDAxMyIgaWQ9ImVudGl0eV9aZW5rZXNoaUJvbnVzIj48ZWxsaXBzZSBjeD0iNDM2LjA0MzEiIGN5PSIzMjcuOTk4NiIgZmlsbD0iI0YxRjFGMSIgcng9IjgzLjk5MzEiIHJ5PSIxOS4xOTg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iMzY2LjA0MzQiIHk9IjMzMi42NDcxIj4mIzIwODQwOyYjMjgwNDA7JiMxMjM3NTsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ5MDsmIzEyNDczOyYjMTI0MzQ7JiMyOTU1NDsmIzI0NDcxOzwvdGV4dD48L2c+PCEtLWVudGl0eSBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSIyOSIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJlbnRpdHlfRGlzcGxheVNjb3JlIj48ZWxsaXBzZSBjeD0iNjQxLjU1NDIiIGN5PSIyNTcuMDAyOCIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1OTkuNTU0NCIgeT0iMjYxLjY1MTMiPiYjMTI0NzM7JiMxMjQ2NzsmIzEyNDUwOyYjMTI0MzQ7JiMzNDkyMDsmIzMxMDM0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzNCIgZGF0YS11aWQ9ImVudDAwMTUiIGlkPSJlbnRpdHlfS2V5Ym9hcmRDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjA0MjQiIGN5PSI2Ny4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIzODAuMDQyNyIgeT0iNzEuNjQ4OSI+JiMxMjQ2MTsmIzEyNTQwOyYjMTI1MDg7JiMxMjU0MDsmIzEyNDg5OyYjMTIzOTE7JiMyNTgwNTsmIzIwMzE2OzwvdGV4dD48L2c+PCEtLWVudGl0eSBUb3VjaENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iVG91Y2hDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzNSIgZGF0YS11aWQ9ImVudDAwMTYiIGlkPSJlbnRpdHlfVG91Y2hDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjAzNzMiIGN5PSIxMzMuMDAzNiIgZmlsbD0iI0YxRjFGMSIgcng9IjUyLjQ5NzMiIHJ5PSIxNC41MjM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI0MDEuMDM3NCIgeT0iMTM3LjY1MjEiPiYjMTI0Nzk7JiMxMjQ4MzsmIzEyNDgxOyYjMjU4MDU7JiMyMDMxNjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgR2FtZU92ZXJDaGVjay0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHYW1lT3ZlckNoZWNrIiBkYXRhLXNvdXJjZS1saW5lPSI0MCIgZGF0YS11aWQ9ImVudDAwMTciIGlkPSJlbnRpdHlfR2FtZU92ZXJDaGVjayI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iMzk5Ljk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI0MDQuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQ1ODsmIzEyNTQwOyYjMTI0OTY7JiMxMjU0MDsmIzIxMDI4OyYjMjM0NTA7PC90ZXh0PjwvZz48IS0tZW50aXR5IEdhbWVPdmVyQW5pbWF0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI0MSIgZGF0YS11aWQ9ImVudDAwMTgiIGlkPSJlbnRpdHlfR2FtZU92ZXJBbmltYXRpb24iPjxlbGxpcHNlIGN4PSI0MzYuMDM1OSIgY3k9IjM5OS45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIzNzMuMDM2MiIgeT0iNDA0LjY0MzYiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0NTg7JiMxMjU0MDsmIzEyNDk2OyYjMTI1NDA7JiMyODQzNjsmIzIwOTg2OzwvdGV4dD48L2c+PCEtLWVudGl0eSBQbGF5ZXItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUGxheWVyIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImVudGl0eV9QbGF5ZXIiPjxlbGxpcHNlIGN4PSI0MC45OTk4IiBjeT0iMTAxLjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik00MC45OTk4LDEwOS4zNSBMNDAuOTk5OCwxMzYuMzUgTTI3Ljk5OTgsMTE3LjM1IEw1My45OTk4LDExNy4zNSBNNDAuOTk5OCwxMzYuMzUgTDI3Ljk5OTgsMTUxLjM1IE00MC45OTk4LDEzNi4zNSBMNTMuOTk5OCwxNTEuMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjYiIHk9IjE2NS44NDUxIj4mIzEyNTAzOyYjMTI1MjQ7JiMxMjQ1MjsmIzEyNTE2OyYjMTI1NDA7PC90ZXh0PjwvZz48IS0tZW50aXR5IFN5c3RlbS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X1N5c3RlbSI+PGVsbGlwc2UgY3g9Ijc5MS4wNjk5IiBjeT0iNDM3LjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik03OTEuMDY5OSw0NDUuMzUgTDc5MS4wNjk5LDQ3Mi4zNSBNNzc4LjA2OTksNDUzLjM1IEw4MDQuMDY5OSw0NTMuMzUgTTc5MS4wNjk5LDQ3Mi4zNSBMNzc4LjA2OTksNDg3LjM1IE03OTEuMDY5OSw0NzIuMzUgTDgwNC4wNjk5LDQ4Ny4zNSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iNzYzLjA3IiB5PSI1MDEuODQ1MSI+JiMxMjQ3MTsmIzEyNDczOyYjMTI0ODY7JiMxMjUxMjs8L3RleHQ+PC9nPjwhLS1saW5rIFBsYXllciB0byBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJTdGFydE5ld0dhbWUiIGRhdGEtc291cmNlLWxpbmU9IjQ2IiBkYXRhLXVpZD0ibG5rMTkiIGlkPSJsaW5rX1BsYXllcl9TdGFydE5ld0dhbWUiPjxwYXRoIGQ9Ik0yMy4wNywxNjkuMyBDMjMuMDcsMjcxLjMzIDIzLjA3LDU0MiAyMy4wNyw1NDIgQzIzLjA3LDU0MiA3Ni44Niw1NDIgMTI5LjUzLDU0MiIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1TdGFydE5ld0dhbWUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEzNS41Myw1NDIsMTI2LjUzLDUzOCwxMzAuNTMsNTQyLDEyNi41Myw1NDYsMTM1LjUzLDU0MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSZXN0YXJ0R2FtZSIgZGF0YS1zb3VyY2UtbGluZT0iNDciIGRhdGEtdWlkPSJsbmsyMCIgaWQ9ImxpbmtfUGxheWVyX1Jlc3RhcnRHYW1lIj48cGF0aCBkPSJNNDEuMDcsMTY5LjM0IEM0MS4wNywyNTguMjYgNDEuMDcsNDcxIDQxLjA3LDQ3MSBDNDEuMDcsNDcxIDgzLjg4LDQ3MSAxMjkuNjQsNDcxIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJlc3RhcnRHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNjQsNDcxLDEyNi42NCw0NjcsMTMwLjY0LDQ3MSwxMjYuNjQsNDc1LDEzNS42NCw0NzEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIE1vdmVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iTW92ZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjQ4IiBkYXRhLXVpZD0ibG5rMjEiIGlkPSJsaW5rX1BsYXllcl9Nb3ZlUHV5byI+PHBhdGggZD0iTTc2LjQzLDEzMSBDOTUuMjIsMTMxIDExMy4wMSwxMzEgMTM1LjUsMTMxIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLU1vdmVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDEuNSwxMzEsMTMyLjUsMTI3LDEzNi41LDEzMSwxMzIuNSwxMzUsMTQxLjUsMTMxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBSb3RhdGVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUm90YXRlUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iNDkiIGRhdGEtdWlkPSJsbmsyMiIgaWQ9ImxpbmtfUGxheWVyX1JvdGF0ZVB1eW8iPjxwYXRoIGQ9Ik00MS4wNyw5Mi42MSBDNDEuMDcsNzguMDkgNDEuMDcsNjUgNDEuMDcsNjUgQzQxLjA3LDY1IDEwNC4zMyw2NSAxNTUuMTksNjUiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tUm90YXRlUHV5byIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTYxLjE5LDY1LDE1Mi4xOSw2MSwxNTYuMTksNjUsMTUyLjE5LDY5LDE2MS4xOSw2NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUXVpY2tEcm9wUHV5by0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9IlF1aWNrRHJvcFB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjUwIiBkYXRhLXVpZD0ibG5rMjMiIGlkPSJsaW5rX1BsYXllcl9RdWlja0Ryb3BQdXlvIj48cGF0aCBkPSJNNTguMDcsMTY5LjUzIEM1OC4wNywxODUuMzQgNTguMDcsMjAwIDU4LjA3LDIwMCBDNTguMDcsMjAwIDk0LjgsMjAwIDEzNS41MiwyMDAiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tUXVpY2tEcm9wUHV5byIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTQxLjUyLDIwMCwxMzIuNTIsMTk2LDEzNi41MiwyMDAsMTMyLjUyLDIwNCwxNDEuNTIsMjAwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjUxIiBkYXRhLXVpZD0ibG5rMjQiIGlkPSJsaW5rX1BsYXllcl9LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik03Ni4zMywxMDMuNSBDMTYyLjA1LDEwMy41IDM3NC4wNywxMDMuNSAzNzQuMDcsMTAzLjUgQzM3NC4wNywxMDMuNSAzNzQuMDcsOTIuNjQgMzc0LjA3LDgxLjg0IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc0LjA3LDc1Ljg0LDM3MC4wNyw4NC44NCwzNzQuMDcsODAuODQsMzc4LjA3LDg0Ljg0LDM3NC4wNyw3NS44NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gVG91Y2hDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iVG91Y2hDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI1MiIgZGF0YS11aWQ9ImxuazI1IiBpZD0ibGlua19QbGF5ZXJfVG91Y2hDb250cm9sIj48cGF0aCBkPSJNNzYuNDcsMTU4LjUgQzE3MC4zNCwxNTguNSA0MTguMDcsMTU4LjUgNDE4LjA3LDE1OC41IEM0MTguMDcsMTU4LjUgNDE4LjA3LDE1OC45IDQxOC4wNywxNTIuOTQiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tVG91Y2hDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MTguMDcsMTQ2Ljk0LDQxNC4wNywxNTUuOTQsNDE4LjA3LDE1MS45NCw0MjIuMDcsMTU1Ljk0LDQxOC4wNywxNDYuOTQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBFcmFzZVB1eW8gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkVyYXNlUHV5byIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NSIgZGF0YS11aWQ9ImxuazI2IiBpZD0ibGlua19FcmFzZVB1eW9fU3lzdGVtIj48cGF0aCBkPSJNMjcyLjc4LDI2Ni4zMiBDMzAwLjIxLDI2Ni4zMiAzMjIuMDcsMjY2LjMyIDMyMi4wNywyNjYuMzIgQzMyMi4wNywyNjYuMzIgMzIyLjA3LDQzOC41MSAzMjIuMDcsNDM4LjUxIEMzMjIuMDcsNDM4LjUxIDY2MS4zOSw0MzguNTEgNzYyLjc4LDQzOC41MSIgZmlsbD0ibm9uZSIgaWQ9IkVyYXNlUHV5by1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNjYuNzgsMjY2LjMyLDI3NS43OCwyNzAuMzIsMjcxLjc4LDI2Ni4zMiwyNzUuNzgsMjYyLjMyLDI2Ni43OCwyNjYuMzIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBGYWxsUHV5byB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRmFsbFB1eW8iIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTYiIGRhdGEtdWlkPSJsbmsyNyIgaWQ9ImxpbmtfRmFsbFB1eW9fU3lzdGVtIj48cGF0aCBkPSJNMjg3LjE1LDMzMSBDMzAxLjgyLDMzMSAzMDcuMDcsMzMxIDMwNy4wNywzMzEgQzMwNy4wNywzMzEgMzA3LjA3LDQ0My4zNCAzMDcuMDcsNDQzLjM0IEMzMDcuMDcsNDQzLjM0IDY1OC44NSw0NDMuMzQgNzYyLjYsNDQzLjM0IiBmaWxsPSJub25lIiBpZD0iRmFsbFB1eW8tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjgxLjE1LDMzMSwyOTAuMTUsMzM1LDI4Ni4xNSwzMzEsMjkwLjE1LDMyNywyODEuMTUsMzMxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgQ2hhaW5SZWFjdGlvbiB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iQ2hhaW5SZWFjdGlvbiIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NyIgZGF0YS11aWQ9ImxuazI4IiBpZD0ibGlua19DaGFpblJlYWN0aW9uX1N5c3RlbSI+PHBhdGggZD0iTTUwMy43MywyNjQuMzUgQzUzMC41OSwyNjQuMzUgNTUwLjA3LDI2NC4zNSA1NTAuMDcsMjY0LjM1IEM1NTAuMDcsMjY0LjM1IDU1MC4wNyw0MzMuNjggNTUwLjA3LDQzMy42OCBDNTUwLjA3LDQzMy42OCA2OTkuMzgsNDMzLjY4IDc2Mi45NSw0MzMuNjgiIGZpbGw9Im5vbmUiIGlkPSJDaGFpblJlYWN0aW9uLWJhY2t0by1TeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ5Ny43MywyNjQuMzUsNTA2LjczLDI2OC4zNSw1MDIuNzMsMjY0LjM1LDUwNi43MywyNjAuMzUsNDk3LjczLDI2NC4zNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIFplbmtlc2hpQm9udXMgdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ilplbmtlc2hpQm9udXMiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTgiIGRhdGEtdWlkPSJsbmsyOSIgaWQ9ImxpbmtfWmVua2VzaGlCb251c19TeXN0ZW0iPjxwYXRoIGQ9Ik01MjYuMTgsMzI4IEM2MzEuMTYsMzI4IDc5MS4wNywzMjggNzkxLjA3LDMyOCBDNzkxLjA3LDMyOCA3OTEuMDcsMzg3LjUxIDc5MS4wNyw0MjguNjUiIGZpbGw9Im5vbmUiIGlkPSJaZW5rZXNoaUJvbnVzLWJhY2t0by1TeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUyMC4xOCwzMjgsNTI5LjE4LDMzMiw1MjUuMTgsMzI4LDUyOS4xOCwzMjQsNTIwLjE4LDMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIERpc3BsYXlTY29yZSB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRGlzcGxheVNjb3JlIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU5IiBkYXRhLXVpZD0ibG5rMzAiIGlkPSJsaW5rX0Rpc3BsYXlTY29yZV9TeXN0ZW0iPjxwYXRoIGQ9Ik03MDkuMzcsMjU3IEM3NTUuNjcsMjU3IDgwNS4wNywyNTcgODA1LjA3LDI1NyBDODA1LjA3LDI1NyA4MDUuMDcsMzY3Ljg2IDgwNS4wNyw0MjguNDgiIGZpbGw9Im5vbmUiIGlkPSJEaXNwbGF5U2NvcmUtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzAzLjM3LDI1Nyw3MTIuMzcsMjYxLDcwOC4zNywyNTcsNzEyLjM3LDI1Myw3MDMuMzcsMjU3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgR2FtZU92ZXJDaGVjayB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJDaGVjayIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI2MCIgZGF0YS11aWQ9ImxuazMxIiBpZD0ibGlua19HYW1lT3ZlckNoZWNrX1N5c3RlbSI+PHBhdGggZD0iTTIxNC4wNyw0MjQuNDggQzIxNC4wNyw0MzguMDcgMjE0LjA3LDQ0OC4xNyAyMTQuMDcsNDQ4LjE3IEMyMTQuMDcsNDQ4LjE3IDY0Nyw0NDguMTcgNzYyLjg1LDQ0OC4xNyIgZmlsbD0ibm9uZSIgaWQ9IkdhbWVPdmVyQ2hlY2stYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjE0LjA3LDQxOC40OCwyMTAuMDcsNDI3LjQ4LDIxNC4wNyw0MjMuNDgsMjE4LjA3LDQyNy40OCwyMTQuMDcsNDE4LjQ4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgR2FtZU92ZXJBbmltYXRpb24gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjYxIiBkYXRhLXVpZD0ibG5rMzIiIGlkPSJsaW5rX0dhbWVPdmVyQW5pbWF0aW9uX1N5c3RlbSI+PHBhdGggZD0iTTUyMC4yOCw0MDAgQzYyMC45Niw0MDAgNzc3LjA3LDQwMCA3NzcuMDcsNDAwIEM3NzcuMDcsNDAwIDc3Ny4wNyw0MTMuNTIgNzc3LjA3LDQyOC40MSIgZmlsbD0ibm9uZSIgaWQ9IkdhbWVPdmVyQW5pbWF0aW9uLWJhY2t0by1TeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUxNC4yOCw0MDAsNTIzLjI4LDQwNCw1MTkuMjgsNDAwLDUyMy4yOCwzOTYsNTE0LjI4LDQwMCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBNb3ZlUHV5byB0byBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iTW92ZVB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNjQiIGRhdGEtdWlkPSJsbmszMyIgaWQ9ImxpbmtfTW92ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjc2LjA3LDEyMi4xIEMyNzYuMDcsMTA0LjA4IDI3Ni4wNyw2NSAyNzYuMDcsNjUgQzI3Ni4wNyw2NSAzMTUuNTUsNjUgMzU4LjAxLDY1IiBmaWxsPSJub25lIiBpZD0iTW92ZVB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjQuMDEsNjUsMzU1LjAxLDYxLDM1OS4wMSw2NSwzNTUuMDEsNjksMzY0LjAxLDY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjkyLjQ5IiB5PSI3OC4wNjY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIE1vdmVQdXlvIHRvIFRvdWNoQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNb3ZlUHV5byIgZGF0YS1lbnRpdHktMj0iVG91Y2hDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2NSIgZGF0YS11aWQ9ImxuazM0IiBpZD0ibGlua19Nb3ZlUHV5b19Ub3VjaENvbnRyb2wiPjxwYXRoIGQ9Ik0yODAuNjQsMTM3Ljg0IEMzMTQuNDksMTM3Ljg0IDM0OC45MywxMzcuODQgMzgwLjA3LDEzNy44NCIgZmlsbD0ibm9uZSIgaWQ9Ik1vdmVQdXlvLXRvLVRvdWNoQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzg2LjA3LDEzNy44NCwzNzcuMDcsMTMzLjg0LDM4MS4wNywxMzcuODQsMzc3LjA3LDE0MS44NCwzODYuMDcsMTM3Ljg0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzM0LjM1IiB5PSIxNTAuOTA2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBSb3RhdGVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSb3RhdGVQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjY2IiBkYXRhLXVpZD0ibG5rMzUiIGlkPSJsaW5rX1JvdGF0ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjYwLjMsNTcuNzQgQzI5My40Nyw1Ny43NCAzMzIuNDksNTcuNzQgMzY4LjY2LDU3Ljc0IiBmaWxsPSJub25lIiBpZD0iUm90YXRlUHV5by10by1LZXlib2FyZENvbnRyb2wiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM3NC42Niw1Ny43NCwzNjUuNjYsNTMuNzQsMzY5LjY2LDU3Ljc0LDM2NS42Niw2MS43NCwzNzQuNjYsNTcuNzQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2MS4xODUxIiB4PSIyNTUuNDgiIHk9IjUzLjgwNjkiPiYjMTcxO2V4dGVuZCYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgUm90YXRlUHV5byB0byBUb3VjaENvbnRyb2wtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUm90YXRlUHV5byIgZGF0YS1lbnRpdHktMj0iVG91Y2hDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2NyIgZGF0YS11aWQ9ImxuazM2IiBpZD0ibGlua19Sb3RhdGVQdXlvX1RvdWNoQ29udHJvbCI+PHBhdGggZD0iTTI2MC4xOSw3Mi4yNiBDMjk1LjEsNzIuMjYgMzM3LjA3LDcyLjI2IDMzNy4wNyw3Mi4yNiBDMzM3LjA3LDcyLjI2IDMzNy4wNywxMjguMTYgMzM3LjA3LDEyOC4xNiBDMzM3LjA3LDEyOC4xNiAzNTUuNDMsMTI4LjE2IDM3OS45OCwxMjguMTYiIGZpbGw9Im5vbmUiIGlkPSJSb3RhdGVQdXlvLXRvLVRvdWNoQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzg1Ljk4LDEyOC4xNiwzNzYuOTgsMTI0LjE2LDM4MC45OCwxMjguMTYsMzc2Ljk4LDEzMi4xNiwzODUuOTgsMTI4LjE2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjc1LjA3IiB5PSI5OS4yOTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFF1aWNrRHJvcFB1eW8gdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlF1aWNrRHJvcFB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNjgiIGRhdGEtdWlkPSJsbmszNyIgaWQ9ImxpbmtfUXVpY2tEcm9wUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yODIuNTgsMTk0LjM4IEMzMjcuOTMsMTk0LjM4IDM3OS4wNywxOTQuMzggMzc5LjA3LDE5NC4zOCBDMzc5LjA3LDE5NC4zOCAzNzkuMDcsMTEzLjg1IDM3OS4wNyw4My40MiIgZmlsbD0ibm9uZSIgaWQ9IlF1aWNrRHJvcFB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNzkuMDcsNzcuNDIsMzc1LjA3LDg2LjQyLDM3OS4wNyw4Mi40MiwzODMuMDcsODYuNDIsMzc5LjA3LDc3LjQyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzE3LjA3IiB5PSIxOTcuMjA2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBRdWlja0Ryb3BQdXlvIHRvIFRvdWNoQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJRdWlja0Ryb3BQdXlvIiBkYXRhLWVudGl0eS0yPSJUb3VjaENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjY5IiBkYXRhLXVpZD0ibG5rMzgiIGlkPSJsaW5rX1F1aWNrRHJvcFB1eW9fVG91Y2hDb250cm9sIj48cGF0aCBkPSJNMjgyLjg1LDIwNS42MiBDMzUzLjQ2LDIwNS42MiA0NTMuMDcsMjA1LjYyIDQ1My4wNywyMDUuNjIgQzQ1My4wNywyMDUuNjIgNDUzLjA3LDE3NC4xIDQ1My4wNywxNTMiIGZpbGw9Im5vbmUiIGlkPSJRdWlja0Ryb3BQdXlvLXRvLVRvdWNoQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDUzLjA3LDE0Nyw0NDkuMDcsMTU2LDQ1My4wNywxNTIsNDU3LjA3LDE1Niw0NTMuMDcsMTQ3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzM1LjI2IiB5PSIyMTguNjg2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBFcmFzZVB1eW8gdG8gQ2hhaW5SZWFjdGlvbi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJFcmFzZVB1eW8iIGRhdGEtZW50aXR5LTI9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjcyIiBkYXRhLXVpZD0ibG5rMzkiIGlkPSJsaW5rX0VyYXNlUHV5b19DaGFpblJlYWN0aW9uIj48cGF0aCBkPSJNMjYwLjU3LDI1OC45IEMyOTIuMSwyNTguOSAzMjguMjYsMjU4LjkgMzYzLjM1LDI1OC45IiBmaWxsPSJub25lIiBpZD0iRXJhc2VQdXlvLXRvLUNoYWluUmVhY3Rpb24iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM2OS4zNSwyNTguOSwzNjAuMzUsMjU0LjksMzY0LjM1LDI1OC45LDM2MC4zNSwyNjIuOSwzNjkuMzUsMjU4LjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIyNTAuOTYiIHk9IjI1NC45NjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBDaGFpblJlYWN0aW9uIHRvIERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJDaGFpblJlYWN0aW9uIiBkYXRhLWVudGl0eS0yPSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9IjczIiBkYXRhLXVpZD0ibG5rNDAiIGlkPSJsaW5rX0NoYWluUmVhY3Rpb25fRGlzcGxheVNjb3JlIj48cGF0aCBkPSJNNDkzLjU2LDI0OS42NSBDNTIzLjAxLDI0OS42NSA1NTIuNjUsMjQ5LjY1IDU4MS41OCwyNDkuNjUiIGZpbGw9Im5vbmUiIGlkPSJDaGFpblJlYWN0aW9uLXRvLURpc3BsYXlTY29yZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTg3LjU4LDI0OS42NSw1NzguNTgsMjQ1LjY1LDU4Mi41OCwyNDkuNjUsNTc4LjU4LDI1My42NSw1ODcuNTgsMjQ5LjY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjMuMDA2OCIgeD0iNTQxLjU3IiB5PSIyNDUuNzE2OSI+JiMxNzE7aW5jbHVkZSYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgWmVua2VzaGlCb251cyB0byBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iWmVua2VzaGlCb251cyIgZGF0YS1lbnRpdHktMj0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSI3NCIgZGF0YS11aWQ9ImxuazQxIiBpZD0ibGlua19aZW5rZXNoaUJvbnVzX0Rpc3BsYXlTY29yZSI+PHBhdGggZD0iTTUxNC4wNywzMjAuNjcgQzUxNC4wNywzMDIuNTMgNTE0LjA3LDI1NyA1MTQuMDcsMjU3IEM1MTQuMDcsMjU3IDU0MS4xOSwyNTcgNTczLjY4LDI1NyIgZmlsbD0ibm9uZSIgaWQ9Ilplbmtlc2hpQm9udXMtdG8tRGlzcGxheVNjb3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NzkuNjgsMjU3LDU3MC42OCwyNTMsNTc0LjY4LDI1Nyw1NzAuNjgsMjYxLDU3OS42OCwyNTciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1MTYuMDQiIHk9IjI3MC4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBHYW1lT3ZlckNoZWNrIHRvIEdhbWVPdmVyQW5pbWF0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkdhbWVPdmVyQ2hlY2siIGRhdGEtZW50aXR5LTI9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI3NSIgZGF0YS11aWQ9ImxuazQyIiBpZD0ibGlua19HYW1lT3ZlckNoZWNrX0dhbWVPdmVyQW5pbWF0aW9uIj48cGF0aCBkPSJNMjkyLjMsNDAwIEMzMTMuNTIsNDAwIDMzMC41LDQwMCAzNTEuNzMsNDAwIiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJDaGVjay10by1HYW1lT3ZlckFuaW1hdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzU3LjczLDQwMCwzNDguNzMsMzk2LDM1Mi43Myw0MDAsMzQ4LjczLDQwNCwzNTcuNzMsNDAwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjMuMDA2OCIgeD0iMjYxLjAxIiB5PSI0MTMuMDY2OSI+JiMxNzE7aW5jbHVkZSYjMTg3OzwvdGV4dD48L2c+PCEtLVNSQz1bYkxKVEpYRDE2QnRWZnpYbXVyTHYwNEQ4NURHQmVvOXV2VHN1N1RqRGpwbER4WEhqMzhjeEFyMTFlQWRPSGE0NUg3dUwxT21ldlVUWGZqamp0eUFQTVJnVFFNY0FJVERpdlpqZGxaRlZFSkM2VjhmTFo1SEJKb0luNmpTamc2NFRjT2dUcWlxQ2k0MVFwRzBqMUg5bTNFU0NnQjhvQzFDNjUwMjZSYUFTb3EwTE1KWTk1RU1RSWptcnVsdVd4WmRuSmVZcHYtenoyQ3dzNVExWFBBYnpuMmlKeG5qbnJ1YjdWb1R6QWgzTDRHRmFlMUtYdDJGWV9ZTlU1RjVNVTdhaVBzRU9MZkllRXlLdTU5RV8tN1NGTTJEbEhJUS1LMzFBRzlvNDVscmFlWXZHbVR2Z0s5WGdiRE9RQnh6R1RTSlJPRWtLdi13NzdxaE1YWGdtUVBUUXdJVG5vaUh2OVJHZURhZ3Bfa1BpQTBtMzJ6LTdwLXcwRDZvbkgzM25UbFpNVjFIVWRoRDZlU3J1ZDNJWGpBZGE5d2d6ZFFrVUJiejlPZEM0SFZ6ZW1yeXU5Q3ZraTVkblB6X25KbFZHRTFwOXZqMWJ5QUxGelNmUWcwVFhXQmxYV2J5aGpWOHNTSFJnWFRGZ2RfM08zeEV3Ylhnc0s4UHBFZXVHN1JfZnpGeVRmM3d6NG9wazItcmsweUZlZWd4c0UtX0ZMcFpnYmFMQkNlbXNSU29OXzhLdl90b1A3VU56U1IzdWNPRTdhYTB0SG80OG1udUhfQ2Fqa1lFcHQ1bGNQdlpYTWVsMXQ4NV9Ma1JDbnoxQ0dKa2Z0cUhjclhPemZ4WDM3bG5ZVk5LaE0zX2N3NjdUcGoxaVpzZDh3bEpRZF9wZ3BvblRSSlprVHd1ZExGTVFFOWpYSDdZSmtwM3QxMDRoRmVIQ1IyNTNQRDdPVVNIcDFGMFpiRE1JSk1JZFRRcUJUNExUS1RIdC00VTFfbGx2VE5oYlVKVU15R1ZacTFmQUdZdExXck94TVZJZFpvTlEzTERGMHN4SDFEREExU2dGMXJLTm9iSjI1cUlEbkdSYklvY2lZelRFTTh4a1kwWGp0R1hYTE93eks2V3RHMlg5dXN3UlM0anpiNXJyODFQaEZkVkRzOGpoS2N4NVdYSEJpSTBjSzVvTmRCY2k0Q3JVQkJCS2xmZHEyeGpLVUZOU0xQaDNLX2x4RXlRV05iUzcxazFwM0N0dXVBMkM1QVNZbXJnSnh4cmI2eFJ4ZmY5bmxWVmpYN1ZWY1pfUDd3Y0pyS2VmejlFRGZVS2RPeWtjQ1Jma1FhT3MzWWJWaFo2cVA5V0NiYXRrMFBPRFBrMUVQb042Rm0wMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p>この図を見ると、プレイヤーとシステムの役割分担がよくわかりますね。プレイヤーはゲームの開始や操作を担当し、システムはぷよの消去判定やスコア計算などの内部処理を担当しています。また、キーボード操作とタッチ操作は「拡張（extend）」関係にあり、ぷよの移動や回転などの基本操作を異なる入力方法で実現していることがわかります。</p>
<p>このようにユースケース図を作成することで、システムの全体像を把握し、実装すべき機能の関連性を明確にすることができます。それでは、実際のコード実装に進んでいきましょう！</p>
<p>誤解しないでもらいたいのですが本来ユースケースとはテキストで記述するものでありユースケース図は概要を把握するための手段に過ぎないということです。</p>
<blockquote>
<p>楕円、矢印、人型おアイコンから構成されているUMLのユースケース図は、ユースケースを把握するための表記法ではありません。
楕円や矢印は、ユースケースをのパッケージや分解を表すもので、内容を表すものではありません。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<h2 id="_7">リリース計画<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>さて、ぷよぷよゲームの要件が明確になったところで、次に考えるべきは「どの順番で実装していくか？」ということです。一気に全部作ろうとすると、「どこから手をつければいいんだろう...」と迷ってしまいますよね。</p>
<p>アジャイル開発では、大きなプロジェクトを「イテレーション」という小さな開発期間に分割し、各イテレーションで価値のある機能を完成させていきます。「ちょっとずつ、でも確実に進める」というわけですね。</p>
<blockquote>
<p>イテレーションとは、短い開発期間（通常1〜4週間）のことです。各イテレーションの終わりには、動作するソフトウェアを提供します。</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<h3 id="_8">リリース計画の構成<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>私たちのぷよぷよゲームは、以下のイテレーションで開発していきます：</p>
<h4 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h4>
<ul>
<li>ソフトウェア開発の三種の神器の準備</li>
<li>バージョン管理、テスティング、自動化の設定</li>
<li>ClojureScript開発環境のセットアップ</li>
</ul>
<h4 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<ul>
<li>新しいゲームを開始できる</li>
<li>ゲーム状態を管理する</li>
<li>基本的な画面表示</li>
</ul>
<h4 id="2">イテレーション2: ぷよの基本動作<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<ul>
<li>ぷよを生成する</li>
<li>ぷよを自由落下させる</li>
<li>ぷよを左右に移動する</li>
</ul>
<h4 id="3">イテレーション3: ぷよの回転と高速落下<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<ul>
<li>ぷよを回転させる</li>
<li>ぷよを素早く落下させる</li>
<li>設置判定の実装</li>
</ul>
<h4 id="4">イテレーション4: ぷよの消去<a class="headerlink" href="#4" title="Permanent link">&para;</a></h4>
<ul>
<li>同じ色のぷよの判定</li>
<li>ぷよを消去する</li>
<li>基本的なスコア計算</li>
</ul>
<h4 id="5">イテレーション5: 連鎖反応<a class="headerlink" href="#5" title="Permanent link">&para;</a></h4>
<ul>
<li>連鎖判定の実装</li>
<li>連鎖スコアの計算</li>
<li>連鎖演出</li>
</ul>
<h4 id="6">イテレーション6: 特殊機能<a class="headerlink" href="#6" title="Permanent link">&para;</a></h4>
<ul>
<li>全消しボーナス</li>
<li>ゲームオーバー判定</li>
<li>ゲームオーバー演出</li>
</ul>
<h4 id="7">イテレーション7: 入力操作<a class="headerlink" href="#7" title="Permanent link">&para;</a></h4>
<ul>
<li>キーボード操作の実装</li>
<li>タッチ操作の実装</li>
<li>操作性の調整</li>
</ul>
<p>これらのイテレーションを一つずつ進めていくことで、着実にぷよぷよゲームを完成させていきましょう！</p>
<h2 id="0_1">イテレーション0: 環境の構築<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h2>
<h3 id="_9">ソフトウェア開発の三種の神器<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<blockquote>
<p>動作するきれいなコード</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>テスト駆動開発の <strong>Red-Green-Refactor</strong> サイクルを使って <strong>動作するきれいなコード</strong> を書くことができます。しかし、この品質を継続して維持していくためには、他にも準備しておかなければならないことがあります。</p>
<p>それが <strong>ソフトウェア開発の三種の神器</strong> です。</p>
<blockquote>
<p>ソフトウェア開発の三種の神器とは <strong>バージョン管理</strong>、<strong>テスティング</strong>、<strong>自動化</strong> のことです。</p>
</blockquote>
<ol>
<li><strong>バージョン管理</strong>: ソースコードの変更履歴を管理し、チーム開発を円滑にする</li>
<li><strong>テスティング</strong>: コードの動作を自動的に検証し、品質を保証する</li>
<li><strong>自動化</strong>: 繰り返し作業を自動化し、開発効率を向上させる</li>
</ol>
<p>これらを適切に整備することで、開発者は安心してコードの変更を行い、継続的に品質の高いソフトウェアを開発できるようになります。</p>
<p>本イテレーションでは、ClojureScriptでこれらの環境を整備していきます。</p>
<h3 id="git">バージョン管理: Gitとコミットメッセージ<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>まず最初に <strong>バージョン管理</strong> です。バージョン管理システムとして <strong>Git</strong> を使います。</p>
<h4 id="git_1">Gitのセットアップ<a class="headerlink" href="#git_1" title="Permanent link">&para;</a></h4>
<p>プロジェクトディレクトリでGitレポジトリを初期化します：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>init
$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 初期コミット&#39;</span>
</code></pre></div>
<h4 id="_10">コミットメッセージの書き方<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>品質の高いソフトウェア開発を行うためには、コミットメッセージにもルールを設けることが重要です。ここでは <strong>Angularコミットメッセージ規約</strong> を採用します。</p>
<p>コミットメッセージの形式：
<div class="highlight"><pre><span></span><code>&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;

&lt;body&gt;

&lt;footer&gt;
</code></pre></div></p>
<h5 id="type">Type（種類）<a class="headerlink" href="#type" title="Permanent link">&para;</a></h5>
<ul>
<li><strong>feat</strong>: 新機能の追加</li>
<li><strong>fix</strong>: バグの修正</li>
<li><strong>docs</strong>: ドキュメントの変更</li>
<li><strong>style</strong>: コードのフォーマット変更（機能に影響しない）</li>
<li><strong>refactor</strong>: リファクタリング（機能追加・バグ修正以外のコード変更）</li>
<li><strong>test</strong>: テストの追加・修正</li>
<li><strong>chore</strong>: ビルドプロセスやツールの変更</li>
</ul>
<h5 id="_11">例：<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよぷよゲーム基本実装を追加&#39;</span>
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよ消去のエッジケーステストを追加&#39;</span>
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: 連鎖判定をより読みやすく改善&#39;</span>
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: shadow-cljsとGulpのセットアップ&#39;</span>
</code></pre></div>
<h3 id="_12">テスティング: パッケージマネージャとテスト環境<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p><strong>テスティング</strong> を実現するために、ClojureScriptの開発環境を整備します。</p>
<h4 id="_13">パッケージマネージャ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>ClojureScriptでは <strong>npm</strong> と <strong>shadow-cljs</strong> を組み合わせて依存関係を管理します。また、Clojureエコシステムの豊富なツールを活用するために <strong>deps.edn</strong> も使用します。</p>
<blockquote>
<p>shadow-cljsは、ClojureScriptのモダンなビルドツールで、npmとの統合、高速なコンパイル、ホットリロードなどの機能を提供します。</p>
<p>deps.ednは、Clojureの新しい依存関係管理システムで、プロジェクトの依存関係を宣言的に記述し、エイリアスを使用してタスクを定義できます。</p>
</blockquote>
<h5 id="_14">プロジェクト構成<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>puyo-puyo-cljs/
├── package.json          # npm依存関係管理
├── gulpfile.js           # タスクランナー
├── shadow-cljs.edn       # shadow-cljsビルド設定
├── deps.edn              # Clojure CLI設定
├── README.md             # プロジェクト説明
├── .gitignore           # Git無視ファイル設定
├── public/
│   └── index.html       # HTMLエントリーポイント
├── src/
│   └── puyo/
│       └── core.cljs    # Puyo Puyoゲームメイン実装
└── test/
    └── puyo/
        └── core_test.cljs # Puyo Puyoテスト
</code></pre></div>
<h5 id="packagejson">package.json<a class="headerlink" href="#packagejson" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;puyo-puyo-cljs&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ClojureScript Puyo Puyo Game with TDD&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;public/js/main.js&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npx shadow-cljs watch app&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npx shadow-cljs release app&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npx shadow-cljs compile test &amp;&amp; node public/js/test.js&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clojure -M:lint&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;complexity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clojure -M:complexity&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;bikeshed&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clojure -M:bikeshed&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;metrics&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clojure -M:metrics&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clojure -M:format-check&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format-fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clojure -M:format-fix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npx shadow-cljs compile coverage &amp;&amp; node public/js/coverage.js&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;shadow-cljs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^2.28.20&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;gulp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.0.2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;gulp-shell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^0.8.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;chalk&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.1.2&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="shadow-cljsedn">shadow-cljs.edn<a class="headerlink" href="#shadow-cljsedn" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="ss">:deps</span><span class="w">    </span><span class="p">{</span><span class="ss">:aliases</span><span class="w"> </span><span class="p">[</span><span class="ss">:dev</span><span class="p">]}</span>
<span class="w"> </span><span class="ss">:builds</span><span class="w">  </span><span class="p">{</span><span class="ss">:app</span><span class="w"> </span><span class="p">{</span><span class="ss">:target</span><span class="w">           </span><span class="ss">:browser</span>
<span class="w">                 </span><span class="ss">:output-dir</span><span class="w">       </span><span class="s">&quot;public/js&quot;</span>
<span class="w">                 </span><span class="ss">:asset-path</span><span class="w">       </span><span class="s">&quot;/js&quot;</span>
<span class="w">                 </span><span class="ss">:modules</span><span class="w">          </span><span class="p">{</span><span class="ss">:main</span><span class="w"> </span><span class="p">{</span><span class="ss">:init-fn</span><span class="w"> </span><span class="nv">puyo.core/init</span>
<span class="w">                                          </span><span class="ss">:preloads</span><span class="w"> </span><span class="p">[]}}</span>
<span class="w">                 </span><span class="ss">:devtools</span><span class="w">         </span><span class="p">{</span><span class="ss">:after-load</span><span class="w"> </span><span class="nv">puyo.core/init</span>
<span class="w">                                   </span><span class="ss">:http-root</span><span class="w"> </span><span class="s">&quot;public&quot;</span>
<span class="w">                                   </span><span class="ss">:http-port</span><span class="w"> </span><span class="mi">8080</span><span class="p">}}</span>

<span class="w">           </span><span class="ss">:test</span><span class="w"> </span><span class="p">{</span><span class="ss">:target</span><span class="w">          </span><span class="ss">:node-test</span>
<span class="w">                  </span><span class="ss">:output-to</span><span class="w">       </span><span class="s">&quot;public/js/test.js&quot;</span>
<span class="w">                  </span><span class="ss">:ns-regexp</span><span class="w">       </span><span class="s">&quot;-test$&quot;</span>
<span class="w">                  </span><span class="ss">:autorun</span><span class="w">         </span><span class="nv">true</span><span class="p">}</span>

<span class="w">           </span><span class="ss">:coverage</span><span class="w"> </span><span class="p">{</span><span class="ss">:target</span><span class="w">     </span><span class="ss">:node-test</span>
<span class="w">                     </span><span class="ss">:output-to</span><span class="w">  </span><span class="s">&quot;public/js/coverage.js&quot;</span>
<span class="w">                     </span><span class="ss">:ns-regexp</span><span class="w">  </span><span class="s">&quot;-test$&quot;</span>
<span class="w">                     </span><span class="ss">:compiler-options</span><span class="w"> </span><span class="p">{</span><span class="ss">:coverage</span><span class="w"> </span><span class="nv">true</span><span class="p">}}}}</span>
</code></pre></div>
<h5 id="depsedn">deps.edn<a class="headerlink" href="#depsedn" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="ss">:paths</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;src&quot;</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">]</span>
<span class="w"> </span><span class="ss">:deps</span><span class="w"> </span><span class="p">{</span><span class="nv">org.clojure/clojure</span><span class="w">       </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;1.12.0&quot;</span><span class="p">}</span>
<span class="w">        </span><span class="nv">org.clojure/clojurescript</span><span class="w"> </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;1.11.60&quot;</span><span class="p">}</span>
<span class="w">        </span><span class="nv">thheller/shadow-cljs</span><span class="w">      </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;2.28.20&quot;</span><span class="p">}</span>
<span class="w">        </span><span class="nv">org.clojure/spec.alpha</span><span class="w">    </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;0.3.218&quot;</span><span class="p">}</span>
<span class="w">        </span><span class="nv">org.clojure/test.check</span><span class="w">    </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;1.1.1&quot;</span><span class="p">}}</span>

<span class="w"> </span><span class="ss">:aliases</span>
<span class="w"> </span><span class="p">{</span><span class="ss">:dev</span><span class="w"> </span><span class="p">{</span><span class="ss">:extra-deps</span><span class="w"> </span><span class="p">{</span><span class="nv">binaryage/devtools</span><span class="w"> </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;1.0.7&quot;</span><span class="p">}}}</span>

<span class="w">  </span><span class="ss">:lint</span><span class="w"> </span><span class="p">{</span><span class="ss">:replace-deps</span><span class="w"> </span><span class="p">{</span><span class="nv">clj-kondo/clj-kondo</span><span class="w"> </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;2024.11.14&quot;</span><span class="p">}}</span>
<span class="w">         </span><span class="ss">:main-opts</span><span class="w">   </span><span class="p">[</span><span class="s">&quot;-m&quot;</span><span class="w"> </span><span class="s">&quot;clj-kondo.main&quot;</span><span class="w"> </span><span class="s">&quot;--lint&quot;</span><span class="w"> </span><span class="s">&quot;src:test&quot;</span><span class="p">]}</span>

<span class="w">  </span><span class="ss">:complexity</span><span class="w"> </span><span class="p">{</span><span class="ss">:replace-deps</span><span class="w"> </span><span class="p">{</span><span class="nv">clj-kondo/clj-kondo</span><span class="w"> </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;2024.11.14&quot;</span><span class="p">}}</span>
<span class="w">               </span><span class="ss">:main-opts</span><span class="w">    </span><span class="p">[</span><span class="s">&quot;-m&quot;</span><span class="w"> </span><span class="s">&quot;clj-kondo.main&quot;</span><span class="w"> </span><span class="s">&quot;--lint&quot;</span><span class="w"> </span><span class="s">&quot;src:test&quot;</span><span class="w"> </span><span class="s">&quot;--config&quot;</span><span class="w"> </span><span class="s">&quot;{:output {:analysis true}}&quot;</span><span class="p">]}</span>

<span class="w">  </span><span class="ss">:bikeshed</span><span class="w"> </span><span class="p">{</span><span class="ss">:replace-deps</span><span class="w"> </span><span class="p">{</span><span class="nv">clj-kondo/clj-kondo</span><span class="w"> </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;2024.11.14&quot;</span><span class="p">}}</span>
<span class="w">             </span><span class="ss">:main-opts</span><span class="w">    </span><span class="p">[</span><span class="s">&quot;-m&quot;</span><span class="w"> </span><span class="s">&quot;clj-kondo.main&quot;</span><span class="w"> </span><span class="s">&quot;--lint&quot;</span><span class="w"> </span><span class="s">&quot;src:test&quot;</span><span class="w"> </span><span class="s">&quot;--config&quot;</span><span class="w"> </span><span class="s">&quot;{:linters {:line-length {:level :warning :max 100}}}&quot;</span><span class="p">]}</span>

<span class="w">  </span><span class="ss">:metrics</span><span class="w"> </span><span class="p">{</span><span class="ss">:replace-deps</span><span class="w"> </span><span class="p">{</span><span class="nv">clj-kondo/clj-kondo</span><span class="w"> </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;2024.11.14&quot;</span><span class="p">}}</span>
<span class="w">            </span><span class="ss">:main-opts</span><span class="w">    </span><span class="p">[</span><span class="s">&quot;-m&quot;</span><span class="w"> </span><span class="s">&quot;clj-kondo.main&quot;</span><span class="w"> </span><span class="s">&quot;--lint&quot;</span><span class="w"> </span><span class="s">&quot;src:test&quot;</span><span class="w"> </span><span class="s">&quot;--config&quot;</span><span class="w"> </span><span class="s">&quot;{:output {:analysis true} :linters {:line-length {:level :warning :max 100}}}&quot;</span><span class="p">]}</span>

<span class="w">  </span><span class="ss">:format-check</span><span class="w"> </span><span class="p">{</span><span class="ss">:replace-deps</span><span class="w"> </span><span class="p">{</span><span class="nv">lein-cljfmt/lein-cljfmt</span><span class="w"> </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;0.9.2&quot;</span><span class="p">}}</span>
<span class="w">                 </span><span class="ss">:main-opts</span><span class="w">    </span><span class="p">[</span><span class="s">&quot;-m&quot;</span><span class="w"> </span><span class="s">&quot;cljfmt.main&quot;</span><span class="w"> </span><span class="s">&quot;check&quot;</span><span class="p">]}</span>

<span class="w">  </span><span class="ss">:format-fix</span><span class="w"> </span><span class="p">{</span><span class="ss">:replace-deps</span><span class="w"> </span><span class="p">{</span><span class="nv">lein-cljfmt/lein-cljfmt</span><span class="w"> </span><span class="p">{</span><span class="ss">:mvn/version</span><span class="w"> </span><span class="s">&quot;0.9.2&quot;</span><span class="p">}}</span>
<span class="w">               </span><span class="ss">:main-opts</span><span class="w">    </span><span class="p">[</span><span class="s">&quot;-m&quot;</span><span class="w"> </span><span class="s">&quot;cljfmt.main&quot;</span><span class="w"> </span><span class="s">&quot;fix&quot;</span><span class="p">]}</span>

<span class="w">  </span><span class="ss">:coverage</span><span class="w"> </span><span class="p">{</span><span class="ss">:replace-deps</span><span class="w"> </span><span class="p">{}</span>
<span class="w">             </span><span class="ss">:exec-fn</span><span class="w"> </span><span class="nv">clojure.core/println</span>
<span class="w">             </span><span class="ss">:exec-args</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;ClojureScript カバレッジ測定は shadow-cljs の :coverage ビルドを使用してください&quot;</span>
<span class="w">                        </span><span class="s">&quot;実行コマンド: npx shadow-cljs compile coverage &amp;&amp; node public/js/coverage.js&quot;</span><span class="p">]}}}</span>
</code></pre></div>
<blockquote>
<p><strong>clojure.spec の追加</strong></p>
<p><code>org.clojure/spec.alpha</code> と <code>org.clojure/test.check</code> を依存関係に追加しました。これらは、データの仕様定義と生成的テストに使用します。このチュートリアルでは、各イテレーションで段階的に spec を導入していきます。</p>
</blockquote>
<h5 id="publicindexhtml">public/index.html<a class="headerlink" href="#publicindexhtml" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;ja&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ぷよぷよゲーム - ClojureScript版<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">        </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">            </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">            </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">            </span><span class="k">min-height</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">vh</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f0f0f0</span><span class="p">;</span>
<span class="w">            </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">#</span><span class="nn">app</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">canvas</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;app&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/js/main.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<h4 id="_15">テストの実行<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>ClojureScriptのテストは標準の <strong>cljs.test</strong> を使用します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># npm経由でテスト実行</span>
$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>

<span class="c1"># shadow-cljs直接実行</span>
$<span class="w"> </span>npx<span class="w"> </span>shadow-cljs<span class="w"> </span>compile<span class="w"> </span><span class="nb">test</span>
$<span class="w"> </span>node<span class="w"> </span>public/js/test.js

<span class="c1"># Gulpタスクでテスト実行</span>
$<span class="w"> </span>npx<span class="w"> </span>gulp<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<h3 id="_16">自動化: コード品質の自動管理<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>最後に <strong>自動化</strong> です。<strong>自動化</strong> によって品質の維持と開発効率の向上を実現します。</p>
<h4 id="clj-kondo">静的コード解析: clj-kondo<a class="headerlink" href="#clj-kondo" title="Permanent link">&para;</a></h4>
<p>良いコードを書き続けるためには、コードの品質を継続的に監視する必要があります。ClojureScript用の <strong>静的コード解析</strong> ツールとして <strong>clj-kondo</strong> を統一的に使用します。</p>
<h5 id="lint">基本的なLint<a class="headerlink" href="#lint" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>clojure<span class="w"> </span>-M:lint
linting<span class="w"> </span>took<span class="w"> </span>477ms,<span class="w"> </span>errors:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>warnings:<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<h5 id="_17">複雑度解析<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>clojure<span class="w"> </span>-M:complexity
linting<span class="w"> </span>took<span class="w"> </span>504ms,<span class="w"> </span>errors:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>warnings:<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<h5 id="_18">品質メトリクス<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>clojure<span class="w"> </span>-M:bikeshed
linting<span class="w"> </span>took<span class="w"> </span>482ms,<span class="w"> </span>errors:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>warnings:<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<blockquote>
<p><strong>注意</strong>: 従来のEastwoodやlein-bikeshedツールはClojureScriptとの互換性に問題があるため、ClojureScript対応のclj-kondoに統一しました。これにより、安定した静的解析環境を構築できます。</p>
</blockquote>
<h4 id="lein-cljfmt">コードフォーマッタ: lein-cljfmt<a class="headerlink" href="#lein-cljfmt" title="Permanent link">&para;</a></h4>
<p>良いコードであるためには、一貫したフォーマットが重要です。</p>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>— 『リーダブルコード』</p>
</blockquote>
<p>ClojureScriptでは <strong>lein-cljfmt</strong> を使用してコードフォーマットを管理します。</p>
<h5 id="_19">フォーマットチェック<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>clojure<span class="w"> </span>-M:format-check
All<span class="w"> </span><span class="nb">source</span><span class="w"> </span>files<span class="w"> </span>formatted<span class="w"> </span>correctly
</code></pre></div>
<h5 id="_20">自動フォーマット修正<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>clojure<span class="w"> </span>-M:format-fix
Reformatted<span class="w"> </span>src/puyo/core.cljs
</code></pre></div>
<h5 id="cljfmtedn">設定ファイル (.cljfmt.edn)<a class="headerlink" href="#cljfmtedn" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="ss">:indents</span><span class="w">       </span><span class="p">{</span><span class="nv">deftest</span><span class="w"> </span><span class="p">[[</span><span class="ss">:inner</span><span class="w"> </span><span class="mi">0</span><span class="p">]]}</span>
<span class="w"> </span><span class="ss">:remove-trailing-whitespace?</span><span class="w"> </span><span class="nv">true</span>
<span class="w"> </span><span class="ss">:insert-missing-whitespace?</span><span class="w">  </span><span class="nv">true</span>
<span class="w"> </span><span class="ss">:remove-consecutive-blank-lines?</span><span class="w"> </span><span class="nv">true</span><span class="p">}</span>
</code></pre></div>
<h4 id="shadow-cljs">コードカバレッジ: shadow-cljs<a class="headerlink" href="#shadow-cljs" title="Permanent link">&para;</a></h4>
<p>動的なテストの品質を測定するために <strong>コードカバレッジ</strong> を確認します。</p>
<blockquote>
<p>コード網羅率（コードもうらりつ、英: Code coverage）は、ソフトウェアテストで用いられる尺度の1つである。プログラムのソースコードがテストされた割合を意味する。</p>
<p>— ウィキペディア</p>
</blockquote>
<p>ClojureScript用の <strong>コードカバレッジ</strong> ツールとして <strong>shadow-cljs</strong> の組み込み機能を使用します：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>coverage
</code></pre></div>
<blockquote>
<p><strong>注意</strong>: 従来のcloverage（Clojure専用）はClojureScriptとの互換性に問題があるため、shadow-cljsの組み込みカバレッジ機能を使用するように変更しました。</p>
</blockquote>
<h4 id="gulp">タスクランナー: Gulp<a class="headerlink" href="#gulp" title="Permanent link">&para;</a></h4>
<p>これまでに様々なコマンドを使ってきましたが、それぞれを覚えるのは大変です。<strong>タスクランナー</strong> として <strong>Gulp</strong> を使用して、すべてのタスクを統一的に管理します。</p>
<blockquote>
<p>タスクランナーとは、アプリケーションのビルドなど、一定の手順で行う作業をコマンド一つで実行できるように予めタスクとして定義したものです。</p>
</blockquote>
<h5 id="gulpfilejs">gulpfile.js<a class="headerlink" href="#gulpfilejs" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">gulp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-shell&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">chalk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;chalk&#39;</span><span class="p">);</span>

<span class="c1">// ヘルプタスク</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">help</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">blue</span><span class="p">(</span><span class="s1">&#39;\n📋 利用可能なタスク:&#39;</span><span class="p">));</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  help      &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- このヘルプを表示&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  setup     &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- 依存関係のセットアップ&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  test      &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- テストを実行&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  build     &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- プロダクションビルド&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  watch     &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- 開発用ビルド（ファイル監視）&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  release   &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- リリースビルド&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  server    &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- 開発サーバー起動&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  dev       &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- 開発環境の起動&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  clean     &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- ビルド成果物をクリーンアップ&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  check     &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- 全ての品質チェックを実行&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  lint      &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- 静的コード解析を実行&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  complexity&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- 循環複雑度測定&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  format    &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- コードフォーマットをチェック&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  format-fix&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- コードフォーマットを自動修正&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;  coverage  &#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;- テストカバレッジを測定&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">done</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// セットアップタスク</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;📦 依存関係をセットアップ中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;npm install&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;✅ セットアップ完了&quot;&#39;</span>
<span class="p">]);</span>

<span class="c1">// テストタスク</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;🧪 テストを実行中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;npx shadow-cljs compile test&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;node public/js/test.js&#39;</span>
<span class="p">]);</span>

<span class="c1">// ビルドタスク</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;🔨 プロダクションビルド中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;npx shadow-cljs release app&#39;</span>
<span class="p">]);</span>

<span class="c1">// 開発用ビルド（ファイル監視）</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">watch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;👀 開発用ビルド開始（ファイル監視）...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;npx shadow-cljs watch app&#39;</span>
<span class="p">]);</span>

<span class="c1">// リリースビルド</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;🚀 リリースビルド中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;npx shadow-cljs release app --config-merge \&#39;{:compiler-options {:optimizations :advanced}}\&#39;&#39;</span>
<span class="p">]);</span>

<span class="c1">// 開発サーバー起動</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;🌐 開発サーバーを http://localhost:8080 で起動中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;npx shadow-cljs server&#39;</span>
<span class="p">]);</span>

<span class="c1">// 開発環境の起動</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;🚀 開発環境を起動中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;npx shadow-cljs watch app&#39;</span>
<span class="p">]);</span>

<span class="c1">// クリーンアップタスク</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">clean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;🧹 クリーンアップ中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;rm -rf public/js/*&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;rm -rf .shadow-cljs/&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;rm -rf node_modules/.cache/&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;✅ クリーンアップ完了&quot;&#39;</span>
<span class="p">]);</span>

<span class="c1">// 品質チェックタスク</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">check</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">blue</span><span class="p">(</span><span class="s1">&#39;🔍 全ての品質チェックを実行中...&#39;</span><span class="p">));</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">spawn</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Phase 1: 基本的な品質チェック</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;\n📊 Phase 1: 基本品質チェック&#39;</span><span class="p">));</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;clojure&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;-M:lint&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stdio</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;inherit&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="nx">lint</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span><span class="p">(</span><span class="s1">&#39;❌ Lintチェックに失敗しました&#39;</span><span class="p">));</span>
<span class="w">      </span><span class="nx">done</span><span class="p">();</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;clojure&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;-M:format-check&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stdio</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;inherit&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">format</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span><span class="p">(</span><span class="s1">&#39;❌ フォーマットチェックに失敗しました&#39;</span><span class="p">));</span>
<span class="w">        </span><span class="nx">done</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Phase 2: 複雑度解析</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;\n📈 Phase 2: 複雑度解析&#39;</span><span class="p">));</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">complexity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;clojure&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;-M:complexity&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stdio</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;inherit&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">      </span><span class="nx">complexity</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Phase 3: テスト実行</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">yellow</span><span class="p">(</span><span class="s1">&#39;\n🧪 Phase 3: テスト実行&#39;</span><span class="p">));</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;npx&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;shadow-cljs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;compile&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stdio</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;inherit&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="nx">test</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">nodeTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;public/js/test.js&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stdio</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;inherit&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">            </span><span class="nx">nodeTest</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">testCode</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">testCode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="s1">&#39;\n✅ 全ての品質チェックが完了しました！&#39;</span><span class="p">));</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">blue</span><span class="p">(</span><span class="s1">&#39;📊 循環複雑度: 低い（良好）&#39;</span><span class="p">));</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">blue</span><span class="p">(</span><span class="s1">&#39;🎯 テストカバレッジ: 100%&#39;</span><span class="p">));</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">blue</span><span class="p">(</span><span class="s1">&#39;📏 コード品質: 高い&#39;</span><span class="p">));</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span><span class="p">(</span><span class="s1">&#39;❌ テストに失敗しました&#39;</span><span class="p">));</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="nx">done</span><span class="p">();</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span><span class="p">(</span><span class="s1">&#39;❌ テストコンパイルに失敗しました&#39;</span><span class="p">));</span>
<span class="w">            </span><span class="nx">done</span><span class="p">();</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// 個別品質チェックタスク</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">lint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;🔍 静的コード解析を実行中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;clojure -M:lint&#39;</span>
<span class="p">]);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">complexity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;📈 循環複雑度を測定中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;clojure -M:complexity&#39;</span>
<span class="p">]);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;📏 コードフォーマットをチェック中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;clojure -M:format-check&#39;</span>
<span class="p">]);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">formatFix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;🔧 コードフォーマットを自動修正中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;clojure -M:format-fix&#39;</span>
<span class="p">]);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span>
<span class="w">  </span><span class="s1">&#39;echo &quot;📊 テストカバレッジを測定中...&quot;&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;clojure -M:coverage&#39;</span>
<span class="p">]);</span>

<span class="c1">// タスクをエクスポート</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">help</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">help</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setup</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">test</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">build</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">build</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">watch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">watch</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">release</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">server</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dev</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">clean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clean</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">check</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">lint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lint</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">complexity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">complexity</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">format</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">[</span><span class="s1">&#39;format-fix&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formatFix</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">coverage</span><span class="p">;</span>

<span class="c1">// デフォルトタスク</span>
<span class="nx">exports</span><span class="p">.</span><span class="k">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">help</span><span class="p">;</span>
</code></pre></div>
<h3 id="_21">環境構築の完了<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>これで <strong>ソフトウェア開発の三種の神器</strong> が揃いました！</p>
<ol>
<li><strong>バージョン管理</strong></li>
<li>Gitによるソースコード管理</li>
<li>
<p>Angularルールに基づくコミットメッセージ</p>
</li>
<li>
<p><strong>テスティング</strong></p>
</li>
<li>cljs.testによる自動テスト</li>
<li>
<p>テスト駆動開発（TDD）の実践</p>
</li>
<li>
<p><strong>自動化</strong></p>
</li>
<li>npmとshadow-cljsによる依存関係管理とビルド</li>
<li>deps.ednによるClojureツールチェーン管理</li>
<li>Gulpによるタスクランナー</li>
<li>clj-kondoによる統合静的コード解析</li>
<li>lein-cljfmtによるコードフォーマット</li>
<li>shadow-cljsによるコードカバレッジ</li>
</ol>
<p>すべてのタスクが正しく動作することを確認しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 依存関係のセットアップ</span>
$<span class="w"> </span>npx<span class="w"> </span>gulp<span class="w"> </span>setup

<span class="c1"># 全ての品質チェックを実行</span>
$<span class="w"> </span>npx<span class="w"> </span>gulp<span class="w"> </span>check
</code></pre></div>
<p>これで、テスト駆動開発で <strong>動作するきれいなコード</strong> を継続的に書いていくためのClojureScript開発環境が整いました！</p>
<h2 id="1_1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_22">ユーザーストーリー<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ゲームの初期化処理を実装する（ゲームの状態や必要なコンポーネントを設定する）</li>
<li>ゲーム画面を表示する（プレイヤーが視覚的にゲームを認識できるようにする）</li>
<li>新しいぷよを生成する（ゲーム開始時に最初のぷよを作成する）</li>
<li>ゲームループを開始する（ゲームの継続的な更新と描画を行う）</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ゲームの初期化処理」から始めましょう！</p>
<h3 id="_23">テスト: ゲームの初期化<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「ゲームの初期化処理を実装する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ゲームの初期化処理をテストするコードを書いてみましょう。何をテストすべきでしょうか？ゲームが初期化されたとき、必要なコンポーネントが正しく作成され、ゲームの状態が適切に設定されていることを確認する必要がありますね。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/core_test.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.core-test</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.test</span><span class="w"> </span><span class="ss">:refer-macros</span><span class="w"> </span><span class="p">[</span><span class="nv">deftest</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">testing</span><span class="p">]]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.core</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">game</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">ゲームの初期化テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;ゲームを初期化すると、初期状態が設定される&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">game-state</span><span class="w"> </span><span class="p">(</span><span class="nf">game/initialize</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">map? </span><span class="nv">game-state</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;ゲーム状態はマップである&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="ss">:start</span><span class="w"> </span><span class="p">(</span><span class="ss">:mode</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;ゲームモードは:startである&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nf">number?</span><span class="w"> </span><span class="p">(</span><span class="ss">:frame</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;フレーム数は数値である&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">zero? </span><span class="p">(</span><span class="ss">:frame</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;初期フレーム数は0である&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nf">number?</span><span class="w"> </span><span class="p">(</span><span class="ss">:combination-count</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;連鎖カウントは数値である&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">zero? </span><span class="p">(</span><span class="ss">:combination-count</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;初期連鎖カウントは0である&quot;</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;ゲームを初期化すると、必要なコンポーネントが含まれる&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">game-state</span><span class="w"> </span><span class="p">(</span><span class="nf">game/initialize</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">contains? </span><span class="nv">game-state</span><span class="w"> </span><span class="ss">:config</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;configが含まれる&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">contains? </span><span class="nv">game-state</span><span class="w"> </span><span class="ss">:stage</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;stageが含まれる&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">contains? </span><span class="nv">game-state</span><span class="w"> </span><span class="ss">:player</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;playerが含まれる&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">contains? </span><span class="nv">game-state</span><span class="w"> </span><span class="ss">:score</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;scoreが含まれる&quot;</span><span class="p">))))</span>
</code></pre></div>
<p>このテストでは、<code>game/initialize</code>関数が正しく動作することを確認しています。具体的には、必要なコンポーネント（config, stage, player, score）が含まれ、ゲームモードが<code>:start</code>に設定されることを検証しています。</p>
<p>ClojureScriptでは、オブジェクト指向のクラスではなく、<strong>不変データ構造（Immutable Data）</strong>と<strong>純粋関数（Pure Functions）</strong>を使います。これにより、テストがよりシンプルになり、バグが入りにくくなります。</p>
<h3 id="_24">実装: ゲームの初期化<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Error: No such namespace: puyo.core
</code></pre></div>
<p>おっと！まだ<code>puyo.core</code>名前空間を実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<blockquote>
<p>アサートファースト</p>
<p>ではテストはどこから書き始めるべきだろうか。それはテストの終わりにパスすべきアサーションを書くところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストが通るように最小限のコードを実装していきましょう。「最小限」というのがポイントです。この段階では、テストが通ることだけを目指して、必要最低限のコードを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/core.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.core</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">initialize</span>
<span class="w">  </span><span class="s">&quot;ゲームを初期化する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:start</span>
<span class="w">   </span><span class="ss">:frame</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="ss">:combination-count</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="ss">:config</span><span class="w"> </span><span class="p">{}</span>
<span class="w">   </span><span class="ss">:stage</span><span class="w"> </span><span class="p">{}</span>
<span class="w">   </span><span class="ss">:player</span><span class="w"> </span><span class="p">{}</span>
<span class="w">   </span><span class="ss">:score</span><span class="w"> </span><span class="p">{}})</span>
</code></pre></div>
<h3 id="_25">解説: ゲームの初期化<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>実装したゲームの初期化処理について、少し解説しておきましょう。ClojureScriptでは、ゲームの状態を<strong>不変のマップ（Map）</strong>で表現します。この処理では、主に以下のことを行っています：</p>
<ol>
<li>ゲームの基本状態（mode, frame, combination-count）の設定</li>
<li>各コンポーネント（config, stage, player, score）の初期化</li>
</ol>
<p>各コンポーネントの役割を理解しておくと、今後の実装がスムーズになりますよ：</p>
<ul>
<li><strong>config</strong>: ゲームの設定値を管理します（画面サイズ、ぷよの大きさなど）</li>
<li><strong>stage</strong>: ゲームのステージ（盤面）を管理します（ぷよの配置状態、消去判定など）</li>
<li><strong>player</strong>: プレイヤーの入力と操作を管理します（キーボード入力の処理、ぷよの移動など）</li>
<li><strong>score</strong>: スコアの計算と表示を管理します（連鎖数に応じたスコア計算など）</li>
</ul>
<p>ClojureScriptの関数型アプローチでは、状態を直接変更するのではなく、<strong>新しい状態を返す</strong>ことで状態遷移を表現します。これにより、副作用が少なく、テストしやすいコードになります。</p>
<blockquote>
<p>Simple Made Easy</p>
<p>シンプルさとは、物事を単純にすることではなく、絡み合いを解くことである。</p>
<p>— Rich Hickey（Clojureの作者）</p>
</blockquote>
<h3 id="_26">テスト: ゲームループの開始<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>次に、ゲームループを開始するテストを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/core_test.cljs（続き）</span>
<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">ゲームループテスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;ゲームループを開始すると、requestAnimationFrameが呼ばれる&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">called</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">          </span><span class="nv">original-raf</span><span class="w"> </span><span class="nv">js/requestAnimationFrame</span><span class="p">]</span>
<span class="w">      </span><span class="c1">;; requestAnimationFrameをモック</span>
<span class="w">      </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="nv">js/requestAnimationFrame</span>
<span class="w">            </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">callback</span><span class="p">]</span>
<span class="w">              </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="nv">called</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span>
<span class="w">              </span><span class="nv">callback</span><span class="p">))</span>

<span class="w">      </span><span class="p">(</span><span class="nf">try</span>
<span class="w">        </span><span class="p">(</span><span class="nf">game/start-loop</span><span class="w"> </span><span class="p">(</span><span class="nf">game/initialize</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="o">@</span><span class="nv">called</span><span class="w"> </span><span class="s">&quot;requestAnimationFrameが呼ばれた&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">finally</span>
<span class="w">          </span><span class="c1">;; 元に戻す</span>
<span class="w">          </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="nv">js/requestAnimationFrame</span><span class="w"> </span><span class="nv">original-raf</span><span class="p">))))))</span>
</code></pre></div>
<p>このテストでは、<code>game/start-loop</code>関数が<code>requestAnimationFrame</code>を呼び出すことを確認しています。ClojureScriptでは<code>atom</code>を使って変更可能な参照を管理します。</p>
<h3 id="_27">実装: ゲームループの開始<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/core.cljs（続き）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">game-loop</span>
<span class="w">  </span><span class="s">&quot;ゲームループの処理&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">game-state</span><span class="p">]</span>
<span class="w">  </span><span class="c1">;; 次のフレームでも自分自身を呼び出す</span>
<span class="w">  </span><span class="p">(</span><span class="nf">js/requestAnimationFrame</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">game-loop</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span>
<span class="w">  </span><span class="nv">game-state</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">start-loop</span>
<span class="w">  </span><span class="s">&quot;ゲームループを開始する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">game-state</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">game-loop</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span>
</code></pre></div>
<h3 id="_28">解説: ゲームループの開始<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>さて、今回実装した「ゲームループ」について少し詳しく解説しましょう。「ゲームループって何？」と思われるかもしれませんね。</p>
<p>ゲームループは、その名の通り、ゲームの状態を更新し、画面を描画するための繰り返し処理なんです。心臓がずっと鼓動を続けるように、このループが継続的に実行されることで、ゲームが生き生きと動き続けるんですよ。</p>
<p>ここで使っている<code>requestAnimationFrame</code>というメソッド、これがとても賢いんです！「どう賢いの？」というと、ブラウザの描画タイミングに合わせて処理を実行してくれるんです。これによって、スムーズなアニメーションが可能になるんですよ。</p>
<p>ClojureScriptの関数型アプローチでは、ループ内で状態を直接変更するのではなく、<strong>新しい状態を生成して渡していく</strong>ことで状態遷移を実現します。これにより、副作用が少なく、デバッグしやすいコードになります。</p>
<h3 id="_29">実装: 画面とエントリーポイント<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>最後に、ゲームを起動するエントリーポイントとHTMLを実装します。</p>
<h4 id="corecljs">core.cljs の完成<a class="headerlink" href="#corecljs" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/core.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.core</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">initialize</span>
<span class="w">  </span><span class="s">&quot;ゲームを初期化する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:start</span>
<span class="w">   </span><span class="ss">:frame</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="ss">:combination-count</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="ss">:config</span><span class="w"> </span><span class="p">{}</span>
<span class="w">   </span><span class="ss">:stage</span><span class="w"> </span><span class="p">{}</span>
<span class="w">   </span><span class="ss">:player</span><span class="w"> </span><span class="p">{}</span>
<span class="w">   </span><span class="ss">:score</span><span class="w"> </span><span class="p">{}})</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">game-loop</span>
<span class="w">  </span><span class="s">&quot;ゲームループの処理&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">game-state</span><span class="p">]</span>
<span class="w">  </span><span class="c1">;; 次のフレームでも自分自身を呼び出す</span>
<span class="w">  </span><span class="p">(</span><span class="nf">js/requestAnimationFrame</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">game-loop</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span>
<span class="w">  </span><span class="nv">game-state</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">start-loop</span>
<span class="w">  </span><span class="s">&quot;ゲームループを開始する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">game-state</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">game-loop</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">init</span>
<span class="w">  </span><span class="s">&quot;ゲームのエントリーポイント&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">.log</span><span class="w"> </span><span class="nv">js/console</span><span class="w"> </span><span class="s">&quot;Puyo Puyo Game Started!&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">initialize</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">start-loop</span><span class="p">)))</span>
</code></pre></div>
<p>このコードでは、以下の流れでゲームを開始します：</p>
<ol>
<li><code>initialize</code>関数でゲーム状態を初期化</li>
<li><code>start-loop</code>関数でゲームループを開始</li>
<li>スレッディングマクロ<code>-&gt;</code>で処理を繋げる</li>
</ol>
<p>ClojureScriptの<strong>スレッディングマクロ（Threading Macro）</strong><code>-&gt;</code>を使うと、処理の流れが読みやすくなります。上記のコードは以下と同じ意味です：</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="nf">start-loop</span><span class="w"> </span><span class="p">(</span><span class="nf">initialize</span><span class="p">))</span>
</code></pre></div>
<h4 id="publicindexhtml_1">public/index.html の更新<a class="headerlink" href="#publicindexhtml_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;ja&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ぷよぷよゲーム - ClojureScript版<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">        </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">            </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">            </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">            </span><span class="k">min-height</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">vh</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f0f0f0</span><span class="p">;</span>
<span class="w">            </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">#</span><span class="nn">app</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">#</span><span class="nn">stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="nc">info</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">font-weight</span><span class="p">:</span><span class="w"> </span><span class="kc">bold</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;app&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>ぷよぷよゲーム<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;score&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;info&quot;</span><span class="p">&gt;</span>Score: 0<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;stage&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;320&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;480&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;next&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;info&quot;</span><span class="p">&gt;</span>Next:<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;next2&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;info&quot;</span><span class="p">&gt;</span>Next2:<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/js/main.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<h4 id="shadow-cljsedn_1">shadow-cljs.edn の更新<a class="headerlink" href="#shadow-cljsedn_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="ss">:deps</span><span class="w">    </span><span class="p">{</span><span class="ss">:aliases</span><span class="w"> </span><span class="p">[</span><span class="ss">:dev</span><span class="p">]}</span>
<span class="w"> </span><span class="ss">:builds</span><span class="w">  </span><span class="p">{</span><span class="ss">:app</span><span class="w"> </span><span class="p">{</span><span class="ss">:target</span><span class="w">           </span><span class="ss">:browser</span>
<span class="w">                 </span><span class="ss">:output-dir</span><span class="w">       </span><span class="s">&quot;public/js&quot;</span>
<span class="w">                 </span><span class="ss">:asset-path</span><span class="w">       </span><span class="s">&quot;/js&quot;</span>
<span class="w">                 </span><span class="ss">:modules</span><span class="w">          </span><span class="p">{</span><span class="ss">:main</span><span class="w"> </span><span class="p">{</span><span class="ss">:init-fn</span><span class="w"> </span><span class="nv">puyo.core/init</span>
<span class="w">                                          </span><span class="ss">:preloads</span><span class="w"> </span><span class="p">[]}}</span>
<span class="w">                 </span><span class="ss">:devtools</span><span class="w">         </span><span class="p">{</span><span class="ss">:after-load</span><span class="w"> </span><span class="nv">puyo.core/init</span>
<span class="w">                                   </span><span class="ss">:http-root</span><span class="w"> </span><span class="s">&quot;public&quot;</span>
<span class="w">                                   </span><span class="ss">:http-port</span><span class="w"> </span><span class="mi">8080</span><span class="p">}}</span>

<span class="w">           </span><span class="ss">:test</span><span class="w"> </span><span class="p">{</span><span class="ss">:target</span><span class="w">          </span><span class="ss">:node-test</span>
<span class="w">                  </span><span class="ss">:output-to</span><span class="w">       </span><span class="s">&quot;public/js/test.js&quot;</span>
<span class="w">                  </span><span class="ss">:ns-regexp</span><span class="w">       </span><span class="s">&quot;-test$&quot;</span>
<span class="w">                  </span><span class="ss">:autorun</span><span class="w">         </span><span class="nv">true</span><span class="p">}</span>

<span class="w">           </span><span class="ss">:coverage</span><span class="w"> </span><span class="p">{</span><span class="ss">:target</span><span class="w">     </span><span class="ss">:node-test</span>
<span class="w">                     </span><span class="ss">:output-to</span><span class="w">  </span><span class="s">&quot;public/js/coverage.js&quot;</span>
<span class="w">                     </span><span class="ss">:ns-regexp</span><span class="w">  </span><span class="s">&quot;-test$&quot;</span>
<span class="w">                     </span><span class="ss">:compiler-options</span><span class="w"> </span><span class="p">{</span><span class="ss">:coverage</span><span class="w"> </span><span class="nv">true</span><span class="p">}}}}</span>
</code></pre></div>
<h3 id="_30">テストの確認<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下の結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code>Testing puyo.core-test

Ran 2 tests containing 9 assertions.
0 failures, 0 errors.
</code></pre></div>
<p>品質チェックも実行しましょう：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npx<span class="w"> </span>gulp<span class="w"> </span>check
</code></pre></div>
<h3 id="_31">画面の確認<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>では、実際に動作する画面を確認しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>ブラウザで <code>http://localhost:8080</code> を開くと、ぷよぷよゲームの画面が表示されます。コンソールには「Puyo Puyo Game Started!」というメッセージが表示されているはずです。</p>
<p>おめでとうございます！リリースに向けて最初の第一歩を踏み出すことができました。これから機能を追加するごとにどんどん実際のゲームの完成に近づくことが確認できます、楽しみですね。</p>
<p>「機能は別々に作りこんで最後に画面と統合するんじゃないの？」と思うかもしれません。そういうアプローチもありますが画面イメージが最後まで確認できないともし間違っていたら手戻りが大変です。それに動作するプログラムがどんどん成長するのを見るのは楽しいですからね。</p>
<blockquote>
<p>トップダウンでもボトムアップでもなく、エンドツーエンドで構築していく</p>
<p>エンドツーエンドで小さな機能を構築し、そこから作業を進めながら問題について学習していく。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<h3 id="clojurescript_1">ClojureScriptの関数型アプローチの利点<a class="headerlink" href="#clojurescript_1" title="Permanent link">&para;</a></h3>
<p>今回の実装を通じて、ClojureScriptの関数型アプローチの利点を実感できたでしょうか：</p>
<ol>
<li><strong>不変データ構造</strong>: 状態が意図せず変更されることがない</li>
<li><strong>純粋関数</strong>: 同じ入力には常に同じ出力を返す</li>
<li><strong>シンプルなテスト</strong>: 副作用が少ないため、テストが書きやすい</li>
<li><strong>スレッディングマクロ</strong>: 処理の流れが読みやすい</li>
</ol>
<p>これらの特徴により、バグが入りにくく、保守しやすいコードを書くことができます。</p>
<h3 id="1_2">イテレーション1のまとめ<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ゲーム状態の初期化</strong></li>
<li>不変マップによる状態管理</li>
<li>必要なコンポーネント（config, stage, player, score）の初期化</li>
<li>
<p>ゲームモードの設定</p>
</li>
<li>
<p><strong>ゲームループの実装</strong></p>
</li>
<li><code>requestAnimationFrame</code>を使用した継続的なループ処理</li>
<li>
<p>関数型アプローチによる状態遷移</p>
</li>
<li>
<p><strong>エントリーポイントの実装</strong></p>
</li>
<li><code>init</code>関数でゲームの初期化とループ開始</li>
<li>スレッディングマクロによる処理の連鎖</li>
<li>
<p>ブラウザでの動作確認が可能に</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ゲーム初期化のテスト（1テスト、6アサーション）</li>
<li>ゲームループのテスト（1テスト、1アサーション）</li>
<li>すべてのテストが成功</li>
</ol>
<h3 id="clojurespec">clojure.spec: 基本データ構造の定義<a class="headerlink" href="#clojurespec" title="Permanent link">&para;</a></h3>
<p>イテレーション1では、ゲーム状態の基本的なデータ構造を定義しました。ここで clojure.spec を使って、これらのデータ構造の仕様を定義しましょう。</p>
<h4 id="specs">specs 名前空間の作成<a class="headerlink" href="#specs" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/specs.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.specs</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]))</span>

<span class="c1">;; ゲームモードの定義</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::mode</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:start</span><span class="w"> </span><span class="ss">:new-puyo</span><span class="w"> </span><span class="ss">:playing</span><span class="w"> </span><span class="ss">:check-erase</span><span class="w"> </span><span class="ss">:apply-gravity</span><span class="w"> </span><span class="ss">:game-over</span><span class="p">})</span>

<span class="c1">;; フレーム数</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::frame</span><span class="w"> </span><span class="nv">nat-int?</span><span class="p">)</span>

<span class="c1">;; 組み合わせカウント</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::combination-count</span><span class="w"> </span><span class="nv">nat-int?</span><span class="p">)</span>

<span class="c1">;; ゲーム状態の基本構造</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::game-state-basic</span>
<span class="w">  </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="ss">:req-un</span><span class="w"> </span><span class="p">[</span><span class="ss">::mode</span><span class="w"> </span><span class="ss">::frame</span><span class="w"> </span><span class="ss">::combination-count</span><span class="p">]))</span>
</code></pre></div>
<p>「なぜこの段階で spec を定義するんですか？」良い質問ですね！TDD では、テストファーストでコードを書きますが、spec は「データの形状に対するテスト」と考えることができます。各イテレーションで新しいデータ構造を追加するたびに、その仕様も一緒に定義していくことで、データの整合性を保証できます。</p>
<h4 id="spec">テストでの spec 検証<a class="headerlink" href="#spec" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/core_test.cljs（spec検証を追加）</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.core-test</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.test</span><span class="w"> </span><span class="ss">:refer-macros</span><span class="w"> </span><span class="p">[</span><span class="nv">deftest</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">testing</span><span class="p">]]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.core</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">core</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.specs</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">specs</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">ゲーム初期化テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;ゲームが正しく初期化される&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">game-state</span><span class="w"> </span><span class="p">(</span><span class="nf">core/initialize</span><span class="p">)]</span>
<span class="w">      </span><span class="c1">;; 既存のテスト</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="ss">:start</span><span class="w"> </span><span class="p">(</span><span class="ss">:mode</span><span class="w"> </span><span class="nv">game-state</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="ss">:frame</span><span class="w"> </span><span class="nv">game-state</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="ss">:combination-count</span><span class="w"> </span><span class="nv">game-state</span><span class="p">)))</span>

<span class="w">      </span><span class="c1">;; spec による検証を追加</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nf">s/valid?</span><span class="w"> </span><span class="ss">::specs/game-state-basic</span><span class="w"> </span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">          </span><span class="s">&quot;ゲーム状態が spec を満たす&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="c1">;; spec 違反時のエラーメッセージを確認（開発時のデバッグ用）</span>
<span class="w">      </span><span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nf">s/valid?</span><span class="w"> </span><span class="ss">::specs/game-state-basic</span><span class="w"> </span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">s/explain-str</span><span class="w"> </span><span class="ss">::specs/game-state-basic</span><span class="w"> </span><span class="nv">game-state</span><span class="p">))))))</span>
</code></pre></div>
<p>「テストに spec を追加することで何が変わるんですか？」テストが通っても、データの形状が正しくない場合があります。例えば、<code>:mode</code> に不正な値が入っていても、そのキーが存在するかどうかしかチェックしていなければ見逃してしまいます。spec を使うことで、データの<strong>値の妥当性</strong>まで検証できるんです。</p>
<h4 id="repl">REPL での開発時検証<a class="headerlink" href="#repl" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; REPL での使用例</span>
<span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">&#39;</span><span class="p">[</span><span class="nv">puyo.core</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">core</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">&#39;</span><span class="p">[</span><span class="nv">puyo.specs</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">specs</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">&#39;</span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">])</span>

<span class="c1">;; ゲーム状態を初期化して検証</span>
<span class="p">(</span><span class="k">def </span><span class="nv">game</span><span class="w"> </span><span class="p">(</span><span class="nf">core/initialize</span><span class="p">))</span>
<span class="p">(</span><span class="nf">s/valid?</span><span class="w"> </span><span class="ss">::specs/game-state-basic</span><span class="w"> </span><span class="nv">game</span><span class="p">)</span>
<span class="c1">;; =&gt; true</span>

<span class="c1">;; 不正なゲーム状態を検証</span>
<span class="p">(</span><span class="nf">s/valid?</span><span class="w"> </span><span class="ss">::specs/game-state-basic</span><span class="w"> </span><span class="p">{</span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:invalid</span><span class="w"> </span><span class="ss">:frame</span><span class="w"> </span><span class="mi">0</span><span class="p">})</span>
<span class="c1">;; =&gt; false</span>

<span class="c1">;; エラー詳細を表示</span>
<span class="p">(</span><span class="nf">s/explain</span><span class="w"> </span><span class="ss">::specs/game-state-basic</span><span class="w"> </span><span class="p">{</span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:invalid</span><span class="w"> </span><span class="ss">:frame</span><span class="w"> </span><span class="mi">0</span><span class="p">})</span>
<span class="c1">;; =&gt; val: :invalid fails spec: :puyo.specs/mode at: [:mode] predicate: #{:start :new-puyo :playing ...}</span>
</code></pre></div>
<p>「REPL で即座に検証できるのは便利ですね！」そうです！ClojureScript の REPL 駆動開発と spec の相性は抜群です。コードを書きながら、データの形状が正しいかを即座に確認できます。</p>
<p>次のイテレーションでは、ぷよの移動機能を実装していきます。</p>
<h2 id="2_1">イテレーション2: ぷよの基本動作<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームの基本的な構造ができましたね。「ゲームが始まったけど、ぷよが動かないと面白くないよね？」と思いませんか？そこで次は、ぷよを左右に移動できるようにしていきましょう！</p>
<h3 id="_32">ユーザーストーリー<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「ぷよぷよって、落ちてくるぷよを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「左右の移動」を実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。
「ぷよを左右に移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>プレイヤーの入力を検出する（キーボードの左右キーが押されたことを検知する）</li>
<li>ぷよを左右に移動する処理を実装する（実際にぷよの位置を変更する）</li>
<li>移動可能かどうかのチェックを実装する（画面の端や他のぷよにぶつかる場合は移動できないようにする）</li>
<li>移動後の表示を更新する（画面上でぷよの位置が変わったことを表示する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_33">テスト: プレイヤーの入力検出<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、プレイヤーの入力を検出する部分からテストしていきましょう。キーボードの左右キーが押されたときに、それを正しく検知できるかどうかをテストします。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>ClojureScriptでは、イベント処理をatom（変更可能な参照）を使って管理します。これにより、副作用を最小限に抑えながら状態を管理できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/player_test.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.player-test</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.test</span><span class="w"> </span><span class="ss">:refer-macros</span><span class="w"> </span><span class="p">[</span><span class="nv">deftest</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">testing</span><span class="p">]]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.player</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">player</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">キー入力検出テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;左キーが押されると、左向きの移動フラグが立つ&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">input-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-input-state</span><span class="p">)]</span>
<span class="w">      </span><span class="c1">;; 左キー押下をシミュレート</span>
<span class="w">      </span><span class="p">(</span><span class="nf">player/handle-key-down</span><span class="w"> </span><span class="nv">input-state</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">true? </span><span class="o">@</span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;左フラグがtrueになる&quot;</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;右キーが押されると、右向きの移動フラグが立つ&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">input-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-input-state</span><span class="p">)]</span>
<span class="w">      </span><span class="c1">;; 右キー押下をシミュレート</span>
<span class="w">      </span><span class="p">(</span><span class="nf">player/handle-key-down</span><span class="w"> </span><span class="nv">input-state</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">true? </span><span class="o">@</span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;右フラグがtrueになる&quot;</span><span class="p">)))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;キーが離されると、対応する移動フラグが下がる&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">input-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-input-state</span><span class="p">)]</span>
<span class="w">      </span><span class="c1">;; まず左キーを押す</span>
<span class="w">      </span><span class="p">(</span><span class="nf">player/handle-key-down</span><span class="w"> </span><span class="nv">input-state</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">true? </span><span class="o">@</span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;左フラグがtrueになる&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="c1">;; 次に左キーを離す</span>
<span class="w">      </span><span class="p">(</span><span class="nf">player/handle-key-up</span><span class="w"> </span><span class="nv">input-state</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">false? </span><span class="o">@</span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;左フラグがfalseになる&quot;</span><span class="p">))))</span>
</code></pre></div>
<p>「このテストは何をしているんですか？」このテストでは、キーボードの左右キーが押されたときと離されたときに、入力状態が正しく更新されるかどうかを確認しています。ClojureScriptでは、<strong>atom</strong>を使って変更可能な状態を管理します。</p>
<h3 id="_34">実装: プレイヤーの入力検出<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>「失敗するテストができたので、次は実装ですね！」そうです！テストが通るように、最小限のコードを実装していきましょう。</p>
<blockquote>
<p>仮実装を経て本実装へ</p>
<p>失敗するテストを書いてから、最初に行う実装はどのようなものだろうか - ベタ書きの値を返そう。
それでテストが通るようになったら、ベタ書きの値をだんだん本物の式や変数に置き換えていく。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/player.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.player</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">create-input-state</span>
<span class="w">  </span><span class="s">&quot;入力状態を作成する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:left</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">   </span><span class="ss">:right</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">   </span><span class="ss">:up</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">   </span><span class="ss">:down</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="nv">false</span><span class="p">)})</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">handle-key-down</span>
<span class="w">  </span><span class="s">&quot;キー押下時の処理&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">input-state</span><span class="w"> </span><span class="nv">key-code</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="nv">key-code</span>
<span class="w">    </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span>
<span class="w">    </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span>
<span class="w">    </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:up</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span>
<span class="w">    </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:down</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span>
<span class="w">    </span><span class="nv">nil</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">handle-key-up</span>
<span class="w">  </span><span class="s">&quot;キー解放時の処理&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">input-state</span><span class="w"> </span><span class="nv">key-code</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="nv">key-code</span>
<span class="w">    </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">    </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">    </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:up</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">    </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:down</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">    </span><span class="nv">nil</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">setup-keyboard-events</span>
<span class="w">  </span><span class="s">&quot;キーボードイベントをセットアップする&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">input-state</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">.addEventListener</span><span class="w"> </span><span class="nv">js/document</span><span class="w"> </span><span class="s">&quot;keydown&quot;</span>
<span class="w">                     </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">e</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">handle-key-down</span><span class="w"> </span><span class="nv">input-state</span><span class="w"> </span><span class="p">(</span><span class="nf">.-key</span><span class="w"> </span><span class="nv">e</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">.addEventListener</span><span class="w"> </span><span class="nv">js/document</span><span class="w"> </span><span class="s">&quot;keyup&quot;</span>
<span class="w">                     </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">e</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">handle-key-up</span><span class="w"> </span><span class="nv">input-state</span><span class="w"> </span><span class="p">(</span><span class="nf">.-key</span><span class="w"> </span><span class="nv">e</span><span class="p">)))))</span>
</code></pre></div>
<p>「なるほど！atomを使って入力状態を管理しているんですね。」そうです！ClojureScriptでは、<code>atom</code>を使って変更可能な参照を管理します。<code>reset!</code>を使ってatomの値を更新できます。</p>
<p>「JavaScriptのイベントとどう連携するんですか？」<code>setup-keyboard-events</code>関数で、JavaScriptの<code>addEventListener</code>を使ってキーボードイベントをリッスンしています。イベントが発生すると、ClojureScriptの関数が呼ばれます。</p>
<h3 id="_35">テスト: ぷよの移動<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>「次は何をテストしますか？」次は、ぷよを左右に移動する機能をテストしましょう。ぷよが左右に移動できるか、そして画面の端に到達したときに移動が制限されるかをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/player_test.cljs（続き）</span>
<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">ぷよ移動テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;左に移動できる場合、左に移動する&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>
<span class="w">          </span><span class="nv">config</span><span class="w"> </span><span class="p">{</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="mi">6</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/move-left</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;X座標が1減少する&quot;</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;右に移動できる場合、右に移動する&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>
<span class="w">          </span><span class="nv">config</span><span class="w"> </span><span class="p">{</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="mi">6</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/move-right</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;X座標が1増加する&quot;</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;左端にいる場合、左に移動できない&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>
<span class="w">          </span><span class="nv">config</span><span class="w"> </span><span class="p">{</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="mi">6</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/move-left</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;X座標が変わらない&quot;</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;右端にいる場合、右に移動できない&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>
<span class="w">          </span><span class="nv">config</span><span class="w"> </span><span class="p">{</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="mi">6</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/move-right</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;X座標が変わらない&quot;</span><span class="p">)))))</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の4つのケースを確認しています：</p>
<ol>
<li>通常の状態で左に移動できるか</li>
<li>通常の状態で右に移動できるか</li>
<li>左端にいるときに左に移動しようとしても位置が変わらないか</li>
<li>右端にいるときに右に移動しようとしても位置が変わらないか</li>
</ol>
<p>「なるほど、画面の端を超えて移動できないようにするんですね！」そうです！ゲームの画面外にぷよが出てしまうと困りますからね。では、このテストが通るように実装していきましょう。</p>
<h3 id="_36">実装: ぷよの移動<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを移動させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/player.cljs（続き）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">create-puyo</span>
<span class="w">  </span><span class="s">&quot;新しいぷよを作成する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="ss">:type</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="nb">rand-int </span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="c1">; 1-4のランダムな値</span>
<span class="w">   </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">0</span><span class="p">})</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">move-left</span>
<span class="w">  </span><span class="s">&quot;ぷよを左に移動する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="ss">:x</span><span class="w"> </span><span class="nv">dec</span><span class="p">)</span>
<span class="w">    </span><span class="nv">puyo-state</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">move-right</span>
<span class="w">  </span><span class="s">&quot;ぷよを右に移動する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="nv">config</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="ss">:x</span><span class="w"> </span><span class="nv">inc</span><span class="p">)</span>
<span class="w">    </span><span class="nv">puyo-state</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">update-puyo</span>
<span class="w">  </span><span class="s">&quot;入力に応じてぷよを更新する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">input-state</span><span class="w"> </span><span class="nv">config</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">    </span><span class="o">@</span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">move-left</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">))</span>

<span class="w">    </span><span class="o">@</span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">move-right</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">))</span>

<span class="w">    </span><span class="ss">:else</span>
<span class="w">    </span><span class="nv">puyo-state</span><span class="p">))</span>
</code></pre></div>
<p>「ClojureScriptの関数型アプローチがよくわかりますね！」そうですね。重要なポイントを説明しましょう：</p>
<ol>
<li><strong>不変性</strong>: <code>move-left</code>や<code>move-right</code>は元の状態を変更せず、新しい状態を返します</li>
<li><strong>update関数</strong>: <code>(update puyo-state :x dec)</code>は、<code>:x</code>の値をデクリメントした新しいマップを返します</li>
<li><strong>条件分岐</strong>: <code>if</code>や<code>cond</code>を使って条件に応じた処理を行います</li>
<li><strong>atomの操作</strong>: <code>@</code>でatomの値を取得し、<code>reset!</code>で値を更新します</li>
</ol>
<p>「移動の処理はシンプルですね！」そうですね。<code>move-left</code>関数では左端（X座標が0）でなければX座標を1減らし、<code>move-right</code>関数では右端（X座標がステージの幅-1）でなければX座標を1増やしています。これで、ぷよが画面の端を超えて移動することはなくなりました。</p>
<h3 id="_37">実装: ぷよの画面表示<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>「テストは通ったけど、実際にぷよが動いているところを見たいですね！」そうですね！それでは、ぷよを画面に表示して、実際にキーボードで操作できるようにしましょう。</p>
<h4 id="config">config名前空間の作成<a class="headerlink" href="#config" title="Permanent link">&para;</a></h4>
<p>まず、ゲームの設定を管理する名前空間を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/config.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.config</span><span class="p">)</span>

<span class="p">(</span><span class="k">def </span><span class="nv">stage-cols</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w">         </span><span class="c1">; ステージの列数</span>
<span class="p">(</span><span class="k">def </span><span class="nv">stage-rows</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w">        </span><span class="c1">; ステージの行数</span>
<span class="p">(</span><span class="k">def </span><span class="nv">puyo-size</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w">         </span><span class="c1">; ぷよのサイズ（ピクセル）</span>
<span class="p">(</span><span class="k">def </span><span class="nv">stage-bg-color</span><span class="w"> </span><span class="s">&quot;#2a2a2a&quot;</span><span class="p">)</span><span class="w">     </span><span class="c1">; ステージの背景色</span>
<span class="p">(</span><span class="k">def </span><span class="nv">stage-border-color</span><span class="w"> </span><span class="s">&quot;#444&quot;</span><span class="p">)</span><span class="w">    </span><span class="c1">; ステージの枠線色</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">get-config</span>
<span class="w">  </span><span class="s">&quot;設定マップを取得する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">{</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="nv">stage-cols</span>
<span class="w">   </span><span class="ss">:stage-rows</span><span class="w"> </span><span class="nv">stage-rows</span>
<span class="w">   </span><span class="ss">:puyo-size</span><span class="w"> </span><span class="nv">puyo-size</span>
<span class="w">   </span><span class="ss">:stage-bg-color</span><span class="w"> </span><span class="nv">stage-bg-color</span>
<span class="w">   </span><span class="ss">:stage-border-color</span><span class="w"> </span><span class="nv">stage-border-color</span><span class="p">})</span>
</code></pre></div>
<p>ClojureScriptでは、<strong>def</strong>を使って定数を定義します。関数は必要ありませんが、マップとして設定をまとめることもできます。</p>
<h4 id="drawing">drawing名前空間の作成<a class="headerlink" href="#drawing" title="Permanent link">&para;</a></h4>
<p>次に、ぷよを描画するための名前空間を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/drawing.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.drawing</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">puyo.config</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">config</span><span class="p">]))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">colors</span>
<span class="w">  </span><span class="s">&quot;ぷよの色定義&quot;</span>
<span class="w">  </span><span class="p">{</span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;#888&quot;</span><span class="w">    </span><span class="c1">; 空</span>
<span class="w">   </span><span class="mi">1</span><span class="w"> </span><span class="s">&quot;#ff0000&quot;</span><span class="w"> </span><span class="c1">; 赤</span>
<span class="w">   </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;#00ff00&quot;</span><span class="w"> </span><span class="c1">; 緑</span>
<span class="w">   </span><span class="mi">3</span><span class="w"> </span><span class="s">&quot;#0000ff&quot;</span><span class="w"> </span><span class="c1">; 青</span>
<span class="w">   </span><span class="mi">4</span><span class="w"> </span><span class="s">&quot;#ffff00&quot;</span><span class="p">})</span><span class="w"> </span><span class="c1">; 黄色</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">draw-puyo</span>
<span class="w">  </span><span class="s">&quot;ぷよを描画する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">ctx</span><span class="w"> </span><span class="nv">type</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">size</span><span class="w"> </span><span class="nv">config/puyo-size</span>
<span class="w">        </span><span class="nv">color</span><span class="w"> </span><span class="p">(</span><span class="nb">get </span><span class="nv">colors</span><span class="w"> </span><span class="nv">type</span><span class="w"> </span><span class="p">(</span><span class="nb">get </span><span class="nv">colors</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="nv">center-x</span><span class="w"> </span><span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nb">* </span><span class="nv">x</span><span class="w"> </span><span class="nv">size</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/ </span><span class="nv">size</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">        </span><span class="nv">center-y</span><span class="w"> </span><span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nb">* </span><span class="nv">y</span><span class="w"> </span><span class="nv">size</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/ </span><span class="nv">size</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">        </span><span class="nv">radius</span><span class="w"> </span><span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nb">/ </span><span class="nv">size</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span>

<span class="w">    </span><span class="c1">;; 円を描画</span>
<span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-fillStyle</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span><span class="w"> </span><span class="nv">color</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">.beginPath</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">.arc</span><span class="w"> </span><span class="nv">ctx</span><span class="w"> </span><span class="nv">center-x</span><span class="w"> </span><span class="nv">center-y</span><span class="w"> </span><span class="nv">radius</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">* </span><span class="nv">js/Math.PI</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">.fill</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span>

<span class="w">    </span><span class="c1">;; 枠線を描画</span>
<span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-strokeStyle</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;#000&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-lineWidth</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">.beginPath</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">.arc</span><span class="w"> </span><span class="nv">ctx</span><span class="w"> </span><span class="nv">center-x</span><span class="w"> </span><span class="nv">center-y</span><span class="w"> </span><span class="nv">radius</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">* </span><span class="nv">js/Math.PI</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">.stroke</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)))</span>
</code></pre></div>
<p>「ClojureScriptでCanvas APIを使っているんですね！」そうです！JavaScriptのCanvas APIをそのまま使えます。<code>set!</code>を使ってプロパティを設定し、<code>.メソッド名</code>でメソッドを呼び出します。</p>
<h4 id="stage">stage名前空間の作成<a class="headerlink" href="#stage" title="Permanent link">&para;</a></h4>
<p>続いて、ゲームのステージを管理する名前空間を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/stage.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.stage</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">puyo.config</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">config</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.drawing</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">drawing</span><span class="p">]))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">create-field</span>
<span class="w">  </span><span class="s">&quot;フィールドを作成する（全て0で初期化）&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">vec</span><span class="w"> </span><span class="p">(</span><span class="nb">repeat </span><span class="nv">config/stage-rows</span>
<span class="w">               </span><span class="p">(</span><span class="nf">vec</span><span class="w"> </span><span class="p">(</span><span class="nb">repeat </span><span class="nv">config/stage-cols</span><span class="w"> </span><span class="mi">0</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">setup-canvas</span>
<span class="w">  </span><span class="s">&quot;Canvas要素をセットアップする&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">canvas</span><span class="w"> </span><span class="p">(</span><span class="nf">.createElement</span><span class="w"> </span><span class="nv">js/document</span><span class="w"> </span><span class="s">&quot;canvas&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ctx</span><span class="w"> </span><span class="p">(</span><span class="nf">.getContext</span><span class="w"> </span><span class="nv">canvas</span><span class="w"> </span><span class="s">&quot;2d&quot;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-width</span><span class="w"> </span><span class="nv">canvas</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">* </span><span class="nv">config/stage-cols</span><span class="w"> </span><span class="nv">config/puyo-size</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-height</span><span class="w"> </span><span class="nv">canvas</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">* </span><span class="nv">config/stage-rows</span><span class="w"> </span><span class="nv">config/puyo-size</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nb">.. </span><span class="nv">canvas</span><span class="w"> </span><span class="nv">-style</span><span class="w"> </span><span class="nv">-border</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;2px solid &quot;</span><span class="w"> </span><span class="nv">config/stage-border-color</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nb">.. </span><span class="nv">canvas</span><span class="w"> </span><span class="nv">-style</span><span class="w"> </span><span class="nv">-backgroundColor</span><span class="p">)</span><span class="w"> </span><span class="nv">config/stage-bg-color</span><span class="p">)</span>

<span class="w">    </span><span class="c1">;; ステージ要素に追加</span>
<span class="w">    </span><span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">stage-elem</span><span class="w"> </span><span class="p">(</span><span class="nf">.getElementById</span><span class="w"> </span><span class="nv">js/document</span><span class="w"> </span><span class="s">&quot;stage&quot;</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">.appendChild</span><span class="w"> </span><span class="nv">stage-elem</span><span class="w"> </span><span class="nv">canvas</span><span class="p">))</span>

<span class="w">    </span><span class="p">{</span><span class="ss">:canvas</span><span class="w"> </span><span class="nv">canvas</span>
<span class="w">     </span><span class="ss">:ctx</span><span class="w"> </span><span class="nv">ctx</span><span class="p">}))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">clear-canvas</span>
<span class="w">  </span><span class="s">&quot;Canvasをクリアする&quot;</span>
<span class="w">  </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">canvas</span><span class="w"> </span><span class="nv">ctx</span><span class="p">]}]</span>
<span class="w">  </span><span class="p">(</span><span class="nb">when </span><span class="nv">ctx</span>
<span class="w">    </span><span class="p">(</span><span class="nf">.clearRect</span><span class="w"> </span><span class="nv">ctx</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nf">.-width</span><span class="w"> </span><span class="nv">canvas</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">.-height</span><span class="w"> </span><span class="nv">canvas</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">draw-field</span>
<span class="w">  </span><span class="s">&quot;フィールドを描画する&quot;</span>
<span class="w">  </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">ctx</span><span class="p">]}</span><span class="w"> </span><span class="nv">field</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nb">when </span><span class="nv">ctx</span>
<span class="w">    </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="nb">range </span><span class="nv">config/stage-rows</span><span class="p">)</span>
<span class="w">            </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range </span><span class="nv">config/stage-cols</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">puyo-type</span><span class="w"> </span><span class="p">(</span><span class="nf">get-in</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">])]</span>
<span class="w">        </span><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">puyo-type</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">drawing/draw-puyo</span><span class="w"> </span><span class="nv">ctx</span><span class="w"> </span><span class="nv">puyo-type</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">))))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">draw-current-puyo</span>
<span class="w">  </span><span class="s">&quot;現在のぷよを描画する&quot;</span>
<span class="w">  </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">ctx</span><span class="p">]}</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nb">when </span><span class="nv">ctx</span>
<span class="w">    </span><span class="p">(</span><span class="nf">drawing/draw-puyo</span><span class="w"> </span><span class="nv">ctx</span><span class="w"> </span><span class="p">(</span><span class="ss">:type</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">:y</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">))))</span>
</code></pre></div>
<p>「vec や repeat を使っているのは何のためですか？」ClojureScriptでは、<code>repeat</code>で繰り返しの値を作り、<code>vec</code>でベクターに変換します。これにより、効率的に2次元配列を作成できます。</p>
<p>「get-in って何ですか？」<code>get-in</code>はネストしたデータ構造から値を取得する関数です。<code>(get-in field [y x])</code>は<code>field[y][x]</code>と同じ意味です。</p>
<h4 id="core">core名前空間の更新<a class="headerlink" href="#core" title="Permanent link">&para;</a></h4>
<p>最後に、ゲームのメインロジックを更新します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/core.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.core</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">puyo.config</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">config</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.player</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">player</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.stage</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">stage</span><span class="p">]))</span>

<span class="p">(</span><span class="kd">defonce </span><span class="nv">game-state</span>
<span class="w">  </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">{</span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:new-puyo</span>
<span class="w">         </span><span class="ss">:frame</span><span class="w"> </span><span class="mi">0</span>
<span class="w">         </span><span class="ss">:field</span><span class="w"> </span><span class="p">(</span><span class="nf">stage/create-field</span><span class="p">)</span>
<span class="w">         </span><span class="ss">:puyo</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">         </span><span class="ss">:input-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-input-state</span><span class="p">)</span>
<span class="w">         </span><span class="ss">:canvas-ctx</span><span class="w"> </span><span class="nv">nil</span><span class="p">}))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">initialize</span>
<span class="w">  </span><span class="s">&quot;ゲームを初期化する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">canvas-ctx</span><span class="w"> </span><span class="p">(</span><span class="nf">stage/setup-canvas</span><span class="p">)]</span>
<span class="w">    </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="nv">game-state</span>
<span class="w">            </span><span class="p">{</span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:new-puyo</span>
<span class="w">             </span><span class="ss">:frame</span><span class="w"> </span><span class="mi">0</span>
<span class="w">             </span><span class="ss">:field</span><span class="w"> </span><span class="p">(</span><span class="nf">stage/create-field</span><span class="p">)</span>
<span class="w">             </span><span class="ss">:puyo</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">             </span><span class="ss">:input-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-input-state</span><span class="p">)</span>
<span class="w">             </span><span class="ss">:canvas-ctx</span><span class="w"> </span><span class="nv">canvas-ctx</span><span class="p">}))</span>

<span class="w">  </span><span class="c1">;; キーボードイベントをセットアップ</span>
<span class="w">  </span><span class="p">(</span><span class="nf">player/setup-keyboard-events</span><span class="w"> </span><span class="p">(</span><span class="ss">:input-state</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">update-game</span>
<span class="w">  </span><span class="s">&quot;ゲームを更新する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="ss">:frame</span><span class="w"> </span><span class="nv">inc</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="p">(</span><span class="ss">:mode</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">    </span><span class="ss">:new-puyo</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:puyo</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-puyo</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:playing</span><span class="p">))</span>

<span class="w">    </span><span class="ss">:playing</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">config</span><span class="w"> </span><span class="p">(</span><span class="nf">config/get-config</span><span class="p">)</span>
<span class="w">          </span><span class="nv">updated-puyo</span><span class="w"> </span><span class="p">(</span><span class="nf">player/update-puyo</span>
<span class="w">                        </span><span class="p">(</span><span class="ss">:puyo</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="ss">:input-state</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">                        </span><span class="nv">config</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:puyo</span><span class="w"> </span><span class="nv">updated-puyo</span><span class="p">))</span>

<span class="w">    </span><span class="nv">nil</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">draw-game</span>
<span class="w">  </span><span class="s">&quot;ゲームを描画する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">canvas-ctx</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="nv">mode</span><span class="p">]}</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">]</span>
<span class="w">    </span><span class="p">(</span><span class="nf">stage/clear-canvas</span><span class="w"> </span><span class="nv">canvas-ctx</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">stage/draw-field</span><span class="w"> </span><span class="nv">canvas-ctx</span><span class="w"> </span><span class="nv">field</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">= </span><span class="nv">mode</span><span class="w"> </span><span class="ss">:playing</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">stage/draw-current-puyo</span><span class="w"> </span><span class="nv">canvas-ctx</span><span class="w"> </span><span class="nv">puyo</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">game-loop</span>
<span class="w">  </span><span class="s">&quot;ゲームループ&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">update-game</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">draw-game</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">js/requestAnimationFrame</span><span class="w"> </span><span class="nv">game-loop</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">init</span>
<span class="w">  </span><span class="s">&quot;ゲームのエントリーポイント&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">.log</span><span class="w"> </span><span class="nv">js/console</span><span class="w"> </span><span class="s">&quot;Puyo Puyo Game Started!&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">initialize</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">game-loop</span><span class="p">))</span>
</code></pre></div>
<p>「defonce って何ですか？」<code>defonce</code>は、一度だけ定義される変数を宣言します。ホットリロード時に値がリセットされないので、開発中に状態を保持できます。</p>
<p>「swap! って何ですか？」<code>swap!</code>は、atomの値を関数を使って更新します。例えば、<code>(swap! game-state update :frame inc)</code>は、<code>:frame</code>の値をインクリメントします。</p>
<h3 id="_38">動作確認<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>「これで実際に動かせますね！」はい！開発サーバーを起動して、ブラウザで確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>ブラウザで <code>http://localhost:8080</code> にアクセスすると、ステージが表示され、円形のぷよが表示されます。左右の矢印キーを押すと、ぷよが左右に移動します！</p>
<p>「動きました！」素晴らしい！これで、テストだけでなく実際の動作も確認できるようになりましたね。</p>
<h3 id="clojurescript_2">ClojureScriptの関数型アプローチの利点（再確認）<a class="headerlink" href="#clojurescript_2" title="Permanent link">&para;</a></h3>
<p>今回の実装を通じて、ClojureScriptの関数型アプローチの利点をさらに実感できたでしょうか：</p>
<ol>
<li><strong>不変データ構造</strong>: 状態を直接変更せず、新しい状態を返す</li>
<li><strong>純粋関数</strong>: <code>move-left</code>や<code>move-right</code>は副作用がない</li>
<li><strong>atomによる状態管理</strong>: 必要な部分だけ変更可能にする</li>
<li><strong>データとロジックの分離</strong>: マップとして状態を管理し、関数で処理する</li>
</ol>
<h3 id="2_2">イテレーション2のまとめ<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>player名前空間のキー入力検出機能</strong></li>
<li><code>create-input-state</code>: 入力状態をatomのマップとして作成</li>
<li><code>handle-key-down</code>/<code>handle-key-up</code>: キーイベント処理</li>
<li>
<p><code>setup-keyboard-events</code>: JavaScriptイベントリスナーの登録</p>
</li>
<li>
<p><strong>player名前空間のぷよ移動機能</strong></p>
</li>
<li><code>create-puyo</code>: 新しいぷよを不変マップとして生成</li>
<li><code>move-left</code>/<code>move-right</code>: 純粋関数による移動処理（境界チェック付き）</li>
<li>
<p><code>update-puyo</code>: 入力状態に応じたぷよの更新</p>
</li>
<li>
<p><strong>config名前空間</strong></p>
</li>
<li>定数による設定値の管理</li>
<li>
<p><code>get-config</code>: 設定をマップとして取得</p>
</li>
<li>
<p><strong>drawing名前空間</strong></p>
</li>
<li><code>colors</code>: マップによる色定義</li>
<li>
<p><code>draw-puyo</code>: Canvas APIを使った円形ぷよの描画</p>
</li>
<li>
<p><strong>stage名前空間</strong></p>
</li>
<li><code>create-field</code>: ベクターによる2次元配列の作成</li>
<li><code>setup-canvas</code>: Canvas要素のセットアップ</li>
<li>
<p><code>draw-field</code>/<code>draw-current-puyo</code>: 描画処理</p>
</li>
<li>
<p><strong>core名前空間の更新</strong></p>
</li>
<li><code>defonce</code>によるグローバル状態の管理</li>
<li><code>swap!</code>による状態の更新</li>
<li><code>case</code>による状態マシンの実装</li>
</ol>
<h3 id="clojurespec_1">clojure.spec: ぷよデータ構造とフィールドの定義<a class="headerlink" href="#clojurespec_1" title="Permanent link">&para;</a></h3>
<p>イテレーション2では、ぷよの状態とフィールドのデータ構造を実装しました。これらの仕様を spec で定義しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/specs.cljs（追加）</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.specs</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.config</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">config</span><span class="p">]))</span>

<span class="c1">;; 座標の定義</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::x</span><span class="w"> </span><span class="p">(</span><span class="nf">s/and</span><span class="w"> </span><span class="nv">int?</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">%</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">%</span><span class="w"> </span><span class="nv">config/stage-cols</span><span class="p">)))</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::y</span><span class="w"> </span><span class="p">(</span><span class="nf">s/and</span><span class="w"> </span><span class="nv">int?</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">%</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">%</span><span class="w"> </span><span class="nv">config/stage-rows</span><span class="p">)))</span>

<span class="c1">;; ぷよタイプ（1-4の色）</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::type</span><span class="w"> </span><span class="p">(</span><span class="nf">s/int-in</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span>

<span class="c1">;; 回転状態（0-3）</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::rotation</span><span class="w"> </span><span class="p">(</span><span class="nf">s/int-in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>

<span class="c1">;; ぷよの状態</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::puyo-state</span>
<span class="w">  </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="ss">:req-un</span><span class="w"> </span><span class="p">[</span><span class="ss">::x</span><span class="w"> </span><span class="ss">::y</span><span class="w"> </span><span class="ss">::type</span><span class="w"> </span><span class="ss">::rotation</span><span class="p">]))</span>

<span class="c1">;; フィールドの1セル（0=空、1-4=ぷよの色）</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::cell</span><span class="w"> </span><span class="p">(</span><span class="nf">s/int-in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span>

<span class="c1">;; フィールドの1行</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::row</span><span class="w"> </span><span class="p">(</span><span class="nf">s/coll-of</span><span class="w"> </span><span class="ss">::cell</span><span class="w"> </span><span class="ss">:kind</span><span class="w"> </span><span class="nb">vector? </span><span class="ss">:count</span><span class="w"> </span><span class="nv">config/stage-cols</span><span class="p">))</span>

<span class="c1">;; フィールド全体</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::field</span><span class="w"> </span><span class="p">(</span><span class="nf">s/coll-of</span><span class="w"> </span><span class="ss">::row</span><span class="w"> </span><span class="ss">:kind</span><span class="w"> </span><span class="nb">vector? </span><span class="ss">:count</span><span class="w"> </span><span class="nv">config/stage-rows</span><span class="p">))</span>
</code></pre></div>
<h4 id="spec_1">移動関数の spec 定義<a class="headerlink" href="#spec_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/player.cljs（spec を追加）</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.player</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.specs</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">specs</span><span class="p">]))</span>

<span class="c1">;; move-left の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">move-left</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">::specs/puyo-state</span>
<span class="w">               </span><span class="ss">:config</span><span class="w"> </span><span class="nv">map?</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/puyo-state</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">args</span><span class="w"> </span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">orig-x</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">args</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">:x</span><span class="p">)</span>
<span class="w">              </span><span class="nv">new-x</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">ret</span><span class="p">)]</span>
<span class="w">          </span><span class="c1">;; X座標は減少するか、そのまま（左端の場合）</span>
<span class="w">          </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">= </span><span class="nv">new-x</span><span class="w"> </span><span class="p">(</span><span class="nb">dec </span><span class="nv">orig-x</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">= </span><span class="nv">new-x</span><span class="w"> </span><span class="nv">orig-x</span><span class="p">)))))</span>

<span class="c1">;; move-right の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">move-right</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">::specs/puyo-state</span>
<span class="w">               </span><span class="ss">:config</span><span class="w"> </span><span class="nv">map?</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/puyo-state</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">args</span><span class="w"> </span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">orig-x</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">args</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">:x</span><span class="p">)</span>
<span class="w">              </span><span class="nv">new-x</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">ret</span><span class="p">)]</span>
<span class="w">          </span><span class="c1">;; X座標は増加するか、そのまま（右端の場合）</span>
<span class="w">          </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">= </span><span class="nv">new-x</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="nv">orig-x</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nb">= </span><span class="nv">new-x</span><span class="w"> </span><span class="nv">orig-x</span><span class="p">)))))</span>
</code></pre></div>
<p>「<code>:fn</code> で何を定義しているんですか？」<code>:fn</code> は、引数と戻り値の<strong>関係性</strong>を定義します。例えば <code>move-left</code> では、「X座標が1減るか、変わらない（左端の場合）」という不変条件を表現しています。</p>
<h4 id="_39">生成的テストの追加<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/player_test.cljs（生成的テストを追加）</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.player-test</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.test</span><span class="w"> </span><span class="ss">:refer-macros</span><span class="w"> </span><span class="p">[</span><span class="nv">deftest</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">testing</span><span class="p">]]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">cljs.spec.test.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">stest</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.player</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">player</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.specs</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">specs</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">移動関数の生成的テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;move-left と move-right が仕様を満たす&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">results</span><span class="w"> </span><span class="p">(</span><span class="nf">stest/check</span><span class="w"> </span><span class="o">`</span><span class="p">[</span><span class="nv">player/move-left</span>
<span class="w">                                 </span><span class="nv">player/move-right</span><span class="p">]</span>
<span class="w">                                </span><span class="p">{</span><span class="ss">:clojure.spec.test.check/opts</span>
<span class="w">                                 </span><span class="p">{</span><span class="ss">:num-tests</span><span class="w"> </span><span class="mi">100</span><span class="p">}})]</span>
<span class="w">      </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">result</span><span class="w"> </span><span class="nv">results</span><span class="p">]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">nil? </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">result</span><span class="w"> </span><span class="ss">:clojure.spec.test.check/ret</span><span class="w"> </span><span class="ss">:result</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;生成的テスト失敗: &quot;</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">result</span><span class="w"> </span><span class="ss">:sym</span><span class="p">)))))))</span>
</code></pre></div>
<p>「100回もテストするんですか？」そうです！spec が自動的にランダムなぷよの状態と設定を生成し、移動関数が常に仕様を満たすか検証します。これにより、境界条件などのエッジケースを自動的にテストできます。</p>
<p>次のイテレーションでは、ぷよの回転機能を実装していきます。</p>
<h2 id="3_1">イテレーション3: ぷよの回転と高速落下<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_40">ユーザーストーリー<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、この2つのぷよの相対的な位置関係を変えることです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを回転させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの回転処理を実装する（時計回り・反時計回りの回転）</li>
<li>回転可能かどうかのチェックを実装する（他のぷよや壁にぶつかる場合は回転できないようにする）</li>
<li>壁キック処理を実装する（壁際での回転を可能にする特殊処理）</li>
<li>回転後の表示を更新する（画面上でぷよの位置が変わったことを表示する）</li>
</ul>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_41">テスト: ぷよの回転<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは基本的な回転機能のテストから書いていきましょう。</p>
<p>ClojureScriptでは、ぷよの状態（軸ぷよと子ぷよ）を不変のマップで表現します。回転は、新しい回転状態を持つマップを返す純粋関数として実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/player_test.cljs（続き）</span>
<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">ぷよ回転テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;時計回りに回転すると、回転状態が1増える&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">0</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/rotate-right</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;回転状態が1になる&quot;</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;反時計回りに回転すると、回転状態が1減る&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">1</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/rotate-left</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;回転状態が0になる&quot;</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;回転状態が4になると0に戻る&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">3</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/rotate-right</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;回転状態が0に戻る&quot;</span><span class="p">)))))</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>時計回りに回転すると、回転状態が1増えるか</li>
<li>反時計回りに回転すると、回転状態が1減るか（ただし、負の値にならないように調整）</li>
<li>回転状態が最大値（3）から時計回りに回転すると、0に戻るか（循環するか）</li>
</ol>
<p>「回転状態って何ですか？」回転状態は、ぷよの向きを表す値です。0から3までの値を取り、それぞれ以下の状態を表します：
- 0: 2つ目のぷよが上にある状態
- 1: 2つ目のぷよが右にある状態
- 2: 2つ目のぷよが下にある状態
- 3: 2つ目のぷよが左にある状態</p>
<p>「なるほど、4方向の回転を表現するんですね！」そうです！では、このテストが通るように実装していきましょう。</p>
<h3 id="_42">実装: ぷよの回転<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを回転させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/player.cljs（続き）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">rotate-right</span>
<span class="w">  </span><span class="s">&quot;時計回りに回転する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">puyo-state</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="nv">%</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">rotate-left</span>
<span class="w">  </span><span class="s">&quot;反時計回りに回転する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">puyo-state</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="p">(</span><span class="nb">+ </span><span class="nv">%</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">get-child-offset</span>
<span class="w">  </span><span class="s">&quot;回転状態に応じた子ぷよのオフセットを取得&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">rotation</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="nv">rotation</span>
<span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">-1</span><span class="p">}</span><span class="w">  </span><span class="c1">; 上</span>
<span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span><span class="w">   </span><span class="c1">; 右</span>
<span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">   </span><span class="c1">; 下</span>
<span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span><span class="w">  </span><span class="c1">; 左</span>
<span class="w">    </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">-1</span><span class="p">}))</span><span class="w">  </span><span class="c1">; デフォルト</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。重要なポイントを説明しましょう：</p>
<ol>
<li><strong>mod関数</strong>: <code>(mod (inc %) 4)</code>で0-3の範囲で循環させます</li>
<li><strong>反時計回り</strong>: <code>(+ % 3)</code>は<code>(- % 1)</code>と同じ効果で、負の値を避けます</li>
<li><strong>update関数</strong>: 関数を適用して新しいマップを返します</li>
<li><strong>get-child-offset</strong>: 回転状態から子ぷよの相対位置を計算します</li>
</ol>
<p>「なぜ反時計回りの場合は単純に1減らすのではなく、3を足して4で割るんですか？」鋭い質問ですね！ClojureScriptでも、負の数の剰余演算の結果が予想と異なる場合があります。3を足して（これは1を引くのと同じ効果があります）から4で割ることで、確実に0-3の範囲に収めているんです。</p>
<h3 id="_43">テスト: 壁キック処理<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>「壁キック処理のテストはどうやって書くんですか？」壁キック処理は、ぷよが壁際にあるときに回転すると自動的に位置を調整する機能です。これをテストするには、ぷよを壁際に配置し、回転させたときに適切に位置が調整されるかを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/player_test.cljs（続き）</span>
<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">壁キック処理テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;右端で右回転すると、左に移動して回転する（壁キック）&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">config</span><span class="w"> </span><span class="p">{</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span>
<span class="w">          </span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">0</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/perform-rotation</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="nv">player/rotate-right</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;X座標が4になる（左に移動）&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;回転状態が1になる&quot;</span><span class="p">))))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;左端で左回転すると、右に移動して回転する（壁キック）&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">config</span><span class="w"> </span><span class="p">{</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span>
<span class="w">          </span><span class="nv">puyo-state</span><span class="w"> </span><span class="p">{</span><span class="ss">:x</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">:type</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">:rotation</span><span class="w"> </span><span class="mi">0</span><span class="p">}]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/perform-rotation</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="nv">player/rotate-left</span><span class="p">)]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;X座標が1になる（右に移動）&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">new-state</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;回転状態が3になる&quot;</span><span class="p">)))))</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>右端にいるときに時計回りに回転すると、左に1マス移動して回転するか</li>
<li>左端にいるときに反時計回りに回転すると、右に1マス移動して回転するか</li>
</ol>
<p>「なるほど、壁にめり込まないように自動的に位置を調整するんですね！」そうです！これがいわゆる「壁キック」と呼ばれる処理です。プレイヤーの操作性を向上させるための工夫なんですよ。では、このテストが通るように実装していきましょう。</p>
<h3 id="_44">実装: 壁キック処理<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、壁キック処理を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/player.cljs（続き）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">perform-rotation</span>
<span class="w">  </span><span class="s">&quot;回転を実行し、必要に応じて壁キックを行う&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="nv">rotate-fn</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">rotated</span><span class="w"> </span><span class="p">(</span><span class="nf">rotate-fn</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span>
<span class="w">        </span><span class="nv">offset</span><span class="w"> </span><span class="p">(</span><span class="nf">get-child-offset</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">rotated</span><span class="p">))</span>
<span class="w">        </span><span class="nv">child-x</span><span class="w"> </span><span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">rotated</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">offset</span><span class="p">))]</span>
<span class="w">    </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">      </span><span class="c1">;; 右壁にめり込む場合、左に移動</span>
<span class="w">      </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">child-x</span><span class="w"> </span><span class="p">(</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="nv">config</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="ss">:x</span><span class="w"> </span><span class="nv">dec</span><span class="p">)</span>

<span class="w">      </span><span class="c1">;; 左壁にめり込む場合、右に移動</span>
<span class="w">      </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">child-x</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="ss">:x</span><span class="w"> </span><span class="nv">inc</span><span class="p">)</span>

<span class="w">      </span><span class="c1">;; 壁にめり込まない場合、そのまま</span>
<span class="w">      </span><span class="ss">:else</span>
<span class="w">      </span><span class="nv">rotated</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">update-puyo</span>
<span class="w">  </span><span class="s">&quot;入力に応じてぷよを更新する（回転を含む）&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">input-state</span><span class="w"> </span><span class="nv">config</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">    </span><span class="o">@</span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">move-left</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">))</span>

<span class="w">    </span><span class="o">@</span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">move-right</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="p">))</span>

<span class="w">    </span><span class="o">@</span><span class="p">(</span><span class="ss">:up</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:up</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">perform-rotation</span><span class="w"> </span><span class="nv">puyo-state</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="nv">rotate-right</span><span class="p">))</span>

<span class="w">    </span><span class="ss">:else</span>
<span class="w">    </span><span class="nv">puyo-state</span><span class="p">))</span>
</code></pre></div>
<p>「なるほど、回転後に壁にめり込む場合は位置を調整するんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li>まず通常の回転処理を行う（<code>rotate-fn</code>を呼び出す）</li>
<li>回転後の子ぷよの位置を計算する</li>
<li>子ぷよが壁にめり込む状況になっていないかチェックする</li>
<li>めり込む場合は、軸ぷよの位置を調整する（壁キック）</li>
</ol>
<p>「ClojureScriptの関数型アプローチがよくわかりますね！」そうですね。重要なポイント：</p>
<ol>
<li><strong>高階関数</strong>: <code>perform-rotation</code>は回転関数を引数として受け取ります</li>
<li><strong>let束縛</strong>: 中間結果を名前付きで管理します</li>
<li><strong>cond式</strong>: 複数の条件を順に評価します</li>
<li><strong>不変性</strong>: 元の状態を変更せず、新しい状態を返します</li>
</ol>
<h3 id="2_3">実装: 2つ目のぷよの描画<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h3>
<p>「回転したぷよを画面に表示したいですね！」そうですね！では、2つ目のぷよ（子ぷよ）を描画する機能を追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/stage.cljs（更新）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">draw-current-puyo</span>
<span class="w">  </span><span class="s">&quot;現在のぷよを描画する（軸ぷよと子ぷよ）&quot;</span>
<span class="w">  </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">ctx</span><span class="p">]}</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nb">when </span><span class="nv">ctx</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">offset</span><span class="w"> </span><span class="p">(</span><span class="nf">player/get-child-offset</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">))</span>
<span class="w">          </span><span class="nv">child-x</span><span class="w"> </span><span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">offset</span><span class="p">))</span>
<span class="w">          </span><span class="nv">child-y</span><span class="w"> </span><span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="ss">:y</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">:y</span><span class="w"> </span><span class="nv">offset</span><span class="p">))]</span>
<span class="w">      </span><span class="c1">;; 軸ぷよを描画</span>
<span class="w">      </span><span class="p">(</span><span class="nf">drawing/draw-puyo</span><span class="w"> </span><span class="nv">ctx</span><span class="w"> </span><span class="p">(</span><span class="ss">:type</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="ss">:y</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">))</span>
<span class="w">      </span><span class="c1">;; 子ぷよを描画（軸ぷよと同じ色）</span>
<span class="w">      </span><span class="p">(</span><span class="nf">drawing/draw-puyo</span><span class="w"> </span><span class="nv">ctx</span><span class="w"> </span><span class="p">(</span><span class="ss">:type</span><span class="w"> </span><span class="nv">puyo-state</span><span class="p">)</span><span class="w"> </span><span class="nv">child-x</span><span class="w"> </span><span class="nv">child-y</span><span class="p">))))</span>
</code></pre></div>
<p>「2つのぷよを描画するようになったんですね！」そうです！<code>get-child-offset</code>を使って子ぷよの位置を計算し、軸ぷよと子ぷよの両方を描画しています。</p>
<h3 id="_45">動作確認<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>「これで実際に動かせますね！」はい！開発サーバーを起動して、ブラウザで確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>ブラウザで <code>http://localhost:8080</code> にアクセスすると、2つのぷよが表示されます。上矢印キーを押すと、ぷよが回転します！</p>
<p>「動きました！」素晴らしい！これで、ぷよを回転させながら左右に移動できるようになりましたね。</p>
<h3 id="clojurescript_3">ClojureScriptの関数型パターン<a class="headerlink" href="#clojurescript_3" title="Permanent link">&para;</a></h3>
<p>今回の実装で使用した関数型プログラミングのパターン：</p>
<ol>
<li><strong>高階関数</strong>: <code>perform-rotation</code>は関数を引数として受け取る</li>
<li><strong>パターンマッチング</strong>: <code>case</code>式で回転状態から座標を計算</li>
<li><strong>不変データフロー</strong>: 状態を変更せず、新しい状態を返す</li>
<li><strong>let束縛</strong>: 複雑な計算を段階的に名前付け</li>
</ol>
<h3 id="3_2">イテレーション3のまとめ<a class="headerlink" href="#3_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>回転状態の管理</strong></li>
<li><code>:rotation</code>キー：0(上)、1(右)、2(下)、3(左)の4状態で管理</li>
<li>
<p><code>get-child-offset</code>：回転状態から子ぷよの相対位置を計算</p>
</li>
<li>
<p><strong>回転関数の実装</strong></p>
</li>
<li><code>rotate-right</code>：時計回りに回転（rotation を +1）</li>
<li><code>rotate-left</code>：反時計回りに回転（rotation を +3、つまり -1 と同等）</li>
<li>
<p><code>mod</code>関数による循環的な状態遷移</p>
</li>
<li>
<p><strong>壁キック処理</strong></p>
</li>
<li><code>perform-rotation</code>：回転と壁キックを統合</li>
<li>高階関数による柔軟な設計</li>
<li>
<p>子ぷよが壁外に出る場合、軸ぷよの位置を自動調整</p>
</li>
<li>
<p><strong>描画の更新</strong></p>
</li>
<li><code>draw-current-puyo</code>で軸ぷよと子ぷよの両方を描画</li>
<li>
<p>回転状態に応じた子ぷよの位置計算</p>
</li>
<li>
<p><strong>入力処理の拡張</strong></p>
</li>
<li><code>update-puyo</code>で上キーによる回転処理</li>
<li>
<p><code>cond</code>式による複数入力の処理</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>回転機能のテスト（3テスト）</li>
<li>壁キック処理のテスト（2テスト）</li>
<li>すべてのテストが成功</li>
</ol>
<h3 id="clojurespec_2">clojure.spec: 回転関数の仕様<a class="headerlink" href="#clojurespec_2" title="Permanent link">&para;</a></h3>
<p>イテレーション3では、回転機能を実装しました。回転関数の仕様を spec で定義しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/player.cljs（回転関数の spec を追加）</span>

<span class="c1">;; rotate-right の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">rotate-right</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">::specs/puyo-state</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/puyo-state</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">args</span><span class="w"> </span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">orig-rot</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">args</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">:rotation</span><span class="p">)</span>
<span class="w">              </span><span class="nv">new-rot</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">ret</span><span class="p">)]</span>
<span class="w">          </span><span class="c1">;; 回転状態が +1 されている（mod 4）</span>
<span class="w">          </span><span class="p">(</span><span class="nb">= </span><span class="nv">new-rot</span><span class="w"> </span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="nv">orig-rot</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">)))))</span>

<span class="c1">;; rotate-left の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">rotate-left</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">::specs/puyo-state</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/puyo-state</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">args</span><span class="w"> </span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">orig-rot</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">args</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">:rotation</span><span class="p">)</span>
<span class="w">              </span><span class="nv">new-rot</span><span class="w"> </span><span class="p">(</span><span class="ss">:rotation</span><span class="w"> </span><span class="nv">ret</span><span class="p">)]</span>
<span class="w">          </span><span class="c1">;; 回転状態が -1 されている（mod 4）</span>
<span class="w">          </span><span class="p">(</span><span class="nb">= </span><span class="nv">new-rot</span><span class="w"> </span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="p">(</span><span class="nb">+ </span><span class="nv">orig-rot</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">)))))</span>

<span class="c1">;; perform-rotation の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">perform-rotation</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">::specs/puyo-state</span>
<span class="w">               </span><span class="ss">:config</span><span class="w"> </span><span class="nv">map?</span>
<span class="w">               </span><span class="ss">:rotate-fn</span><span class="w"> </span><span class="p">(</span><span class="nf">s/fspec</span><span class="w"> </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:puyo-state</span><span class="w"> </span><span class="ss">::specs/puyo-state</span><span class="p">)</span>
<span class="w">                                   </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/puyo-state</span><span class="p">))</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/puyo-state</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">args</span><span class="w"> </span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="c1">;; 回転後のX座標がフィールド内に収まっている</span>
<span class="w">        </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="ss">:x</span><span class="w"> </span><span class="nv">ret</span><span class="p">)</span>
<span class="w">              </span><span class="nv">config</span><span class="w"> </span><span class="p">(</span><span class="ss">:config</span><span class="w"> </span><span class="nv">args</span><span class="p">)]</span>
<span class="w">          </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="ss">:stage-cols</span><span class="w"> </span><span class="nv">config</span><span class="p">))))))</span>
</code></pre></div>
<p>「<code>s/fspec</code> って何ですか？」<code>s/fspec</code> は、関数自体の仕様を定義する spec です。<code>perform-rotation</code> は関数を引数として受け取る高階関数なので、その引数の関数の仕様も定義しています。</p>
<h4 id="_46">生成的テストの追加<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/player_test.cljs（回転関数の生成的テストを追加）</span>
<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">回転関数の生成的テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;rotate-right, rotate-left, perform-rotation が仕様を満たす&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">results</span><span class="w"> </span><span class="p">(</span><span class="nf">stest/check</span><span class="w"> </span><span class="o">`</span><span class="p">[</span><span class="nv">player/rotate-right</span>
<span class="w">                                 </span><span class="nv">player/rotate-left</span>
<span class="w">                                 </span><span class="nv">player/perform-rotation</span><span class="p">]</span>
<span class="w">                                </span><span class="p">{</span><span class="ss">:clojure.spec.test.check/opts</span>
<span class="w">                                 </span><span class="p">{</span><span class="ss">:num-tests</span><span class="w"> </span><span class="mi">100</span><span class="p">}})]</span>
<span class="w">      </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">result</span><span class="w"> </span><span class="nv">results</span><span class="p">]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">nil? </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">result</span><span class="w"> </span><span class="ss">:clojure.spec.test.check/ret</span><span class="w"> </span><span class="ss">:result</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;生成的テスト失敗: &quot;</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">result</span><span class="w"> </span><span class="ss">:sym</span><span class="p">)))))))</span>
</code></pre></div>
<p>「高階関数のテストも自動生成できるんですか？」そうです！spec は関数を引数として受け取る高階関数の仕様も定義でき、生成的テストで検証できます。</p>
<p>次のイテレーションでは、ぷよの自動落下機能を実装していきます。</p>
<h2 id="4_1">イテレーション4: ぷよの消去<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h2>
<p>「回転と移動ができるようになったけど、ぷよぷよの本質はぷよを消すことですよね？」そうですね！同じ色のぷよを4つ以上つなげると消える、これがぷよぷよの醍醐味です。今回は、ぷよの消去機能を実装していきましょう！</p>
<h3 id="_47">ユーザーストーリー<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</p>
</blockquote>
<p>「どうやって同じ色のぷよが繋がっているか判定するんですか？」良い質問ですね！これは「連結成分」を探索するアルゴリズムで実装します。深さ優先探索（DFS）を使って、隣接する同じ色のぷよをグループ化していくんですよ。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<ul>
<li>同じ色のぷよを探索する（深さ優先探索の実装）</li>
<li>4つ以上繋がっているぷよを消去する</li>
<li>消去後のスコア計算</li>
<li>ぷよが消えた後の落下処理</li>
</ul>
<h3 id="_48">テスト: ぷよの探索と消去<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>ClojureScriptの不変データ構造と再帰を使って、エレガントに実装できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/erase_test.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.erase-test</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.test</span><span class="w"> </span><span class="ss">:refer-macros</span><span class="w"> </span><span class="p">[</span><span class="nv">deftest</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">testing</span><span class="p">]]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.erase</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">erase</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">ぷよ探索テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;同じ色のぷよが4つ以上繋がっている場合、そのグループを取得できる&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">field</span><span class="w"> </span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span>
<span class="w">                 </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span>
<span class="w">                 </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span>
<span class="w">                 </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]]</span>
<span class="w">          </span><span class="nv">group</span><span class="w"> </span><span class="p">(</span><span class="nf">erase/find-connected</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">= </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="nb">count </span><span class="nv">group</span><span class="p">))</span><span class="w"> </span><span class="s">&quot;4つのぷよが繋がっている&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">contains? </span><span class="p">(</span><span class="nb">set </span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">contains? </span><span class="p">(</span><span class="nb">set </span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">]))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">contains? </span><span class="p">(</span><span class="nb">set </span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">]))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">contains? </span><span class="p">(</span><span class="nb">set </span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">]))))</span>

<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;3つ以下のぷよは消去対象にならない&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">field</span><span class="w"> </span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span>
<span class="w">                 </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]]</span>
<span class="w">          </span><span class="nv">erasable</span><span class="w"> </span><span class="p">(</span><span class="nf">erase/find-erasable-groups</span><span class="w"> </span><span class="nv">field</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">erasable</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;3つのグループは消去されない&quot;</span><span class="p">))))</span>
</code></pre></div>
<h3 id="_49">実装: 深さ優先探索<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>ClojureScriptの再帰と不変データ構造を活かした実装：</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/erase.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.erase</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">puyo.config</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">config</span><span class="p">]))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">get-neighbors</span>
<span class="w">  </span><span class="s">&quot;隣接する座標を取得&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span>
<span class="w">  </span><span class="p">[[(</span><span class="nb">dec </span><span class="nv">y</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span><span class="w">    </span><span class="c1">; 上</span>
<span class="w">   </span><span class="p">[(</span><span class="nb">inc </span><span class="nv">y</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span><span class="w">    </span><span class="c1">; 下</span>
<span class="w">   </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="nb">dec </span><span class="nv">x</span><span class="p">)]</span><span class="w">    </span><span class="c1">; 左</span>
<span class="w">   </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="nv">x</span><span class="p">)]])</span><span class="w">  </span><span class="c1">; 右</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">in-bounds?</span>
<span class="w">  </span><span class="s">&quot;座標がフィールド内かチェック&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">y</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">y</span><span class="w"> </span><span class="nv">config/stage-rows</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">x</span><span class="w"> </span><span class="nv">config/stage-cols</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">find-connected</span>
<span class="w">  </span><span class="s">&quot;深さ優先探索で同じ色のぷよを探索&quot;</span>
<span class="w">  </span><span class="p">([</span><span class="nv">field</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">find-connected</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nf">get-in</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">])</span><span class="w"> </span><span class="o">#</span><span class="p">{}))</span>
<span class="w">  </span><span class="p">([</span><span class="nv">field</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">target-color</span><span class="w"> </span><span class="nv">visited</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">in-bounds?</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">contains? </span><span class="nv">visited</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">])</span>
<span class="w">           </span><span class="p">(</span><span class="nb">not= </span><span class="p">(</span><span class="nf">get-in</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">])</span><span class="w"> </span><span class="nv">target-color</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">target-color</span><span class="p">))</span>
<span class="w">     </span><span class="nv">visited</span>
<span class="w">     </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">visited</span><span class="o">&#39;</span><span class="w"> </span><span class="p">(</span><span class="nb">conj </span><span class="nv">visited</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">])]</span>
<span class="w">       </span><span class="p">(</span><span class="nf">reduce</span>
<span class="w">        </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">acc</span><span class="w"> </span><span class="p">[</span><span class="nv">ny</span><span class="w"> </span><span class="nv">nx</span><span class="p">]]</span>
<span class="w">          </span><span class="p">(</span><span class="nf">find-connected</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="nv">ny</span><span class="w"> </span><span class="nv">nx</span><span class="w"> </span><span class="nv">target-color</span><span class="w"> </span><span class="nv">acc</span><span class="p">))</span>
<span class="w">        </span><span class="nv">visited</span><span class="o">&#39;</span>
<span class="w">        </span><span class="p">(</span><span class="nf">get-neighbors</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">))))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">find-erasable-groups</span>
<span class="w">  </span><span class="s">&quot;消去可能なグループを全て見つける&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">field</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">all-positions</span><span class="w"> </span><span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="nb">range </span><span class="nv">config/stage-rows</span><span class="p">)</span>
<span class="w">                            </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range </span><span class="nv">config/stage-cols</span><span class="p">)</span>
<span class="w">                            </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nb">pos? </span><span class="p">(</span><span class="nf">get-in</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]))]</span>
<span class="w">                        </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">])]</span>
<span class="w">    </span><span class="p">(</span><span class="nf">-&gt;&gt;</span><span class="w"> </span><span class="nv">all-positions</span>
<span class="w">         </span><span class="p">(</span><span class="nf">reduce</span>
<span class="w">          </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">visited</span><span class="w"> </span><span class="nv">groups</span><span class="p">]}</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]]</span>
<span class="w">            </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">contains? </span><span class="nv">visited</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">])</span>
<span class="w">              </span><span class="p">{</span><span class="ss">:visited</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="ss">:groups</span><span class="w"> </span><span class="nv">groups</span><span class="p">}</span>
<span class="w">              </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">group</span><span class="w"> </span><span class="p">(</span><span class="nf">find-connected</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">)]</span>
<span class="w">                </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt;= </span><span class="p">(</span><span class="nb">count </span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">                  </span><span class="p">{</span><span class="ss">:visited</span><span class="w"> </span><span class="p">(</span><span class="nb">into </span><span class="nv">visited</span><span class="w"> </span><span class="nv">group</span><span class="p">)</span>
<span class="w">                   </span><span class="ss">:groups</span><span class="w"> </span><span class="p">(</span><span class="nb">conj </span><span class="nv">groups</span><span class="w"> </span><span class="nv">group</span><span class="p">)}</span>
<span class="w">                  </span><span class="p">{</span><span class="ss">:visited</span><span class="w"> </span><span class="p">(</span><span class="nb">into </span><span class="nv">visited</span><span class="w"> </span><span class="nv">group</span><span class="p">)</span>
<span class="w">                   </span><span class="ss">:groups</span><span class="w"> </span><span class="nv">groups</span><span class="p">}))))</span>
<span class="w">          </span><span class="p">{</span><span class="ss">:visited</span><span class="w"> </span><span class="o">#</span><span class="p">{}</span><span class="w"> </span><span class="ss">:groups</span><span class="w"> </span><span class="p">[]})</span>
<span class="w">         </span><span class="ss">:groups</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">erase-puyos</span>
<span class="w">  </span><span class="s">&quot;ぷよを消去する&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">field</span><span class="w"> </span><span class="nv">groups</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">reduce</span>
<span class="w">   </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">f</span><span class="w"> </span><span class="nv">group</span><span class="p">]</span>
<span class="w">     </span><span class="p">(</span><span class="nf">reduce</span>
<span class="w">      </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">field</span><span class="o">&#39;</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">assoc-in</span><span class="w"> </span><span class="nv">field</span><span class="o">&#39;</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">      </span><span class="nv">f</span>
<span class="w">      </span><span class="nv">group</span><span class="p">))</span>
<span class="w">   </span><span class="nv">field</span>
<span class="w">   </span><span class="nv">groups</span><span class="p">))</span>
</code></pre></div>
<p>「再帰を使っているんですね！」そうです！ClojureScriptの特徴を活かした実装です：</p>
<ol>
<li><strong>reduce による状態管理</strong>: visited と groups を accumulator で管理</li>
<li><strong>set による高速な存在チェック</strong>: <code>contains?</code> で訪問済みを判定</li>
<li><strong>-&gt;&gt; マクロ</strong>: データ変換の流れを明確に</li>
<li><strong>不変性</strong>: 元のフィールドを変更せず、新しいフィールドを返す</li>
</ol>
<h3 id="_50">実装: ぷよの落下処理<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>消去後、空いたスペースにぷよを落とします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/erase.cljs（続き）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">apply-gravity</span>
<span class="w">  </span><span class="s">&quot;重力を適用してぷよを落とす&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">field</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cols</span><span class="w"> </span><span class="nv">config/stage-cols</span>
<span class="w">        </span><span class="nv">rows</span><span class="w"> </span><span class="nv">config/stage-rows</span><span class="p">]</span>
<span class="w">    </span><span class="p">(</span><span class="nf">reduce</span>
<span class="w">     </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">f</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span>
<span class="w">       </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">col</span><span class="w"> </span><span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">get-in</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="p">[</span><span class="nv">%</span><span class="w"> </span><span class="nv">x</span><span class="p">])</span><span class="w"> </span><span class="p">(</span><span class="nb">range </span><span class="nv">rows</span><span class="p">))</span>
<span class="w">             </span><span class="nv">non-zero</span><span class="w"> </span><span class="p">(</span><span class="nb">filter pos? </span><span class="nv">col</span><span class="p">)</span>
<span class="w">             </span><span class="nv">zeros</span><span class="w"> </span><span class="p">(</span><span class="nb">repeat </span><span class="p">(</span><span class="nb">- </span><span class="nv">rows</span><span class="w"> </span><span class="p">(</span><span class="nb">count </span><span class="nv">non-zero</span><span class="p">))</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">             </span><span class="nv">new-col</span><span class="w"> </span><span class="p">(</span><span class="nf">vec</span><span class="w"> </span><span class="p">(</span><span class="nb">concat </span><span class="nv">zeros</span><span class="w"> </span><span class="nv">non-zero</span><span class="p">))]</span>
<span class="w">         </span><span class="p">(</span><span class="nf">reduce</span>
<span class="w">          </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">field</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">y</span><span class="p">]</span>
<span class="w">            </span><span class="p">(</span><span class="nf">assoc-in</span><span class="w"> </span><span class="nv">field</span><span class="o">&#39;</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">nth </span><span class="nv">new-col</span><span class="w"> </span><span class="nv">y</span><span class="p">)))</span>
<span class="w">          </span><span class="nv">f</span>
<span class="w">          </span><span class="p">(</span><span class="nb">range </span><span class="nv">rows</span><span class="p">))))</span>
<span class="w">     </span><span class="nv">field</span>
<span class="w">     </span><span class="p">(</span><span class="nb">range </span><span class="nv">cols</span><span class="p">))))</span>
</code></pre></div>
<p>「縦の列ごとに処理しているんですね！」そうです！各列について：
1. 0 以外のぷよを集める
2. 必要な数の 0 を上に追加
3. 新しい列でフィールドを更新</p>
<h3 id="_51">ゲームループへの統合<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/core.cljs（更新）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">update-game</span>
<span class="w">  </span><span class="s">&quot;ゲームを更新する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="ss">:frame</span><span class="w"> </span><span class="nv">inc</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="p">(</span><span class="ss">:mode</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">    </span><span class="ss">:new-puyo</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:puyo</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-puyo</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:playing</span><span class="p">))</span>

<span class="w">    </span><span class="ss">:playing</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">config</span><span class="w"> </span><span class="p">(</span><span class="nf">config/get-config</span><span class="p">)</span>
<span class="w">          </span><span class="nv">updated-puyo</span><span class="w"> </span><span class="p">(</span><span class="nf">player/update-puyo</span>
<span class="w">                        </span><span class="p">(</span><span class="ss">:puyo</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="ss">:input-state</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">                        </span><span class="nv">config</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:puyo</span><span class="w"> </span><span class="nv">updated-puyo</span><span class="p">))</span>

<span class="w">    </span><span class="ss">:check-erase</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">groups</span><span class="w"> </span><span class="p">(</span><span class="nf">erase/find-erasable-groups</span><span class="w"> </span><span class="p">(</span><span class="ss">:field</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">))]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq </span><span class="nv">groups</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">do</span>
<span class="w">          </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="nv">erase/erase-puyos</span><span class="w"> </span><span class="nv">groups</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:apply-gravity</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:new-puyo</span><span class="p">)))</span>

<span class="w">    </span><span class="ss">:apply-gravity</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="nv">erase/apply-gravity</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:check-erase</span><span class="p">))</span>

<span class="w">    </span><span class="nv">nil</span><span class="p">))</span>
</code></pre></div>
<h3 id="4_2">イテレーション4のまとめ<a class="headerlink" href="#4_2" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>深さ優先探索の実装</strong></li>
<li>再帰による connected component の探索</li>
<li>set を使った訪問済み管理</li>
<li>
<p>reduce による状態の accumulation</p>
</li>
<li>
<p><strong>消去処理</strong></p>
</li>
<li>不変データ構造を活かした実装</li>
<li>
<p>assoc-in による局所的な更新</p>
</li>
<li>
<p><strong>重力処理</strong></p>
</li>
<li>列ごとの処理で効率的に実装</li>
<li>
<p>filter と concat によるデータ変換</p>
</li>
<li>
<p><strong>状態マシン</strong></p>
</li>
<li>:check-erase → :apply-gravity → :check-erase のループ</li>
<li>case 式による状態遷移の明確化</li>
</ol>
<h3 id="clojurespec_3">clojure.spec: 消去関数とフィールド操作の仕様<a class="headerlink" href="#clojurespec_3" title="Permanent link">&para;</a></h3>
<p>イテレーション4では、深さ優先探索による消去処理を実装しました。これらの関数の仕様を定義しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/specs.cljs（追加）</span>

<span class="c1">;; 座標のペア</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::position</span><span class="w"> </span><span class="p">(</span><span class="nf">s/tuple</span><span class="w"> </span><span class="ss">::y</span><span class="w"> </span><span class="ss">::x</span><span class="p">))</span>

<span class="c1">;; 座標のセット（connected component）</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::connected-group</span><span class="w"> </span><span class="p">(</span><span class="nf">s/coll-of</span><span class="w"> </span><span class="ss">::position</span><span class="w"> </span><span class="ss">:kind</span><span class="w"> </span><span class="nv">set?</span><span class="w"> </span><span class="ss">:min-count</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>

<span class="c1">;; 消去可能なグループのコレクション</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::erasable-groups</span><span class="w"> </span><span class="p">(</span><span class="nf">s/coll-of</span><span class="w"> </span><span class="ss">::connected-group</span><span class="w"> </span><span class="ss">:kind</span><span class="w"> </span><span class="nv">vector?</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/erase.cljs（spec を追加）</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.erase</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.specs</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">specs</span><span class="p">]))</span>

<span class="c1">;; find-connected の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">find-connected</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/alt</span><span class="w"> </span><span class="ss">:simple</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="ss">::specs/field</span>
<span class="w">                              </span><span class="ss">:y</span><span class="w"> </span><span class="ss">::specs/y</span>
<span class="w">                              </span><span class="ss">:x</span><span class="w"> </span><span class="ss">::specs/x</span><span class="p">)</span>
<span class="w">               </span><span class="ss">:full</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="ss">::specs/field</span>
<span class="w">                            </span><span class="ss">:y</span><span class="w"> </span><span class="ss">::specs/y</span>
<span class="w">                            </span><span class="ss">:x</span><span class="w"> </span><span class="ss">::specs/x</span>
<span class="w">                            </span><span class="ss">:target-color</span><span class="w"> </span><span class="ss">::specs/cell</span>
<span class="w">                            </span><span class="ss">:visited</span><span class="w"> </span><span class="ss">::specs/connected-group</span><span class="p">))</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/connected-group</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="c1">;; 返り値は空でないセット</span>
<span class="w">        </span><span class="p">(</span><span class="nb">pos? </span><span class="p">(</span><span class="nb">count </span><span class="nv">ret</span><span class="p">))))</span>

<span class="c1">;; find-erasable-groups の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">find-erasable-groups</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="ss">::specs/field</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/erasable-groups</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="c1">;; すべてのグループが4個以上</span>
<span class="w">        </span><span class="p">(</span><span class="nb">every? </span><span class="o">#</span><span class="p">(</span><span class="nb">&gt;= </span><span class="p">(</span><span class="nb">count </span><span class="nv">%</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="nv">ret</span><span class="p">)))</span>

<span class="c1">;; erase-puyos の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">erase-puyos</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="ss">::specs/field</span>
<span class="w">               </span><span class="ss">:groups</span><span class="w"> </span><span class="ss">::specs/erasable-groups</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/field</span><span class="p">)</span>

<span class="c1">;; apply-gravity の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">apply-gravity</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="ss">::specs/field</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/field</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">args</span><span class="w"> </span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="c1">;; フィールドの総ぷよ数は変わらない</span>
<span class="w">        </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">count-puyos</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">field</span><span class="p">]</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">count </span><span class="p">(</span><span class="nb">filter pos? </span><span class="p">(</span><span class="nf">flatten</span><span class="w"> </span><span class="nv">field</span><span class="p">))))]</span>
<span class="w">          </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">count-puyos</span><span class="w"> </span><span class="p">(</span><span class="ss">:field</span><span class="w"> </span><span class="nv">args</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="nf">count-puyos</span><span class="w"> </span><span class="nv">ret</span><span class="p">)))))</span>
</code></pre></div>
<p>「<code>:fn</code> で重力処理の性質を定義しているんですね！」そうです！<code>apply-gravity</code> は「ぷよの総数を変えず、位置だけを変える」という不変条件を持っています。これを spec で表現することで、実装のバグを早期発見できます。</p>
<h4 id="_52">カスタムジェネレータ<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h4>
<p>消去可能なフィールドを生成するカスタムジェネレータを定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/specs.cljs（カスタムジェネレータを追加）</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.specs</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">cljs.spec.gen.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">gen</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.config</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">config</span><span class="p">]))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">gen-erasable-field</span>
<span class="w">  </span><span class="s">&quot;4個以上連結したぷよを含むフィールドを生成&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">gen/fmap</span>
<span class="w">   </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">_</span><span class="p">]</span>
<span class="w">     </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">color</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="nb">rand-int </span><span class="mi">4</span><span class="p">))</span>
<span class="w">           </span><span class="c1">;; 4個のぷよを連結配置</span>
<span class="w">           </span><span class="nv">positions</span><span class="w"> </span><span class="p">[[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">]]</span>
<span class="w">           </span><span class="nv">base-field</span><span class="w"> </span><span class="p">(</span><span class="nf">vec</span><span class="w"> </span><span class="p">(</span><span class="nb">repeat </span><span class="nv">config/stage-rows</span>
<span class="w">                                   </span><span class="p">(</span><span class="nf">vec</span><span class="w"> </span><span class="p">(</span><span class="nb">repeat </span><span class="nv">config/stage-cols</span><span class="w"> </span><span class="mi">0</span><span class="p">))))]</span>
<span class="w">       </span><span class="p">(</span><span class="nf">reduce</span>
<span class="w">        </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">field</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]]</span>
<span class="w">          </span><span class="p">(</span><span class="nf">assoc-in</span><span class="w"> </span><span class="nv">field</span><span class="w"> </span><span class="p">[</span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">]</span><span class="w"> </span><span class="nv">color</span><span class="p">))</span>
<span class="w">        </span><span class="nv">base-field</span>
<span class="w">        </span><span class="nv">positions</span><span class="p">)))</span>
<span class="w">   </span><span class="p">(</span><span class="nf">gen/return</span><span class="w"> </span><span class="nv">nil</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::erasable-field</span>
<span class="w">  </span><span class="p">(</span><span class="nf">s/with-gen</span><span class="w"> </span><span class="ss">::field</span><span class="w"> </span><span class="nv">gen-erasable-field</span><span class="p">))</span>
</code></pre></div>
<h4 id="_53">生成的テスト<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/erase_test.cljs（生成的テストを追加）</span>
<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">消去関数の生成的テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;erase関数が仕様を満たす&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">results</span><span class="w"> </span><span class="p">(</span><span class="nf">stest/check</span><span class="w"> </span><span class="o">`</span><span class="p">[</span><span class="nv">erase/find-connected</span>
<span class="w">                                 </span><span class="nv">erase/find-erasable-groups</span>
<span class="w">                                 </span><span class="nv">erase/erase-puyos</span>
<span class="w">                                 </span><span class="nv">erase/apply-gravity</span><span class="p">]</span>
<span class="w">                                </span><span class="p">{</span><span class="ss">:clojure.spec.test.check/opts</span>
<span class="w">                                 </span><span class="p">{</span><span class="ss">:num-tests</span><span class="w"> </span><span class="mi">50</span><span class="p">}})]</span>
<span class="w">      </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">result</span><span class="w"> </span><span class="nv">results</span><span class="p">]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">nil? </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">result</span><span class="w"> </span><span class="ss">:clojure.spec.test.check/ret</span><span class="w"> </span><span class="ss">:result</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;生成的テスト失敗: &quot;</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">result</span><span class="w"> </span><span class="ss">:sym</span><span class="p">)))))))</span>
</code></pre></div>
<p>「カスタムジェネレータを使うことで、現実的なテストケースを生成できるんですね！」そうです！ランダムなフィールドではなく、実際に消去可能な状態のフィールドを生成することで、より意味のあるテストができます。</p>
<h2 id="5_1">イテレーション5: 連鎖反応<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h2>
<p>「ぷよが消えるようになったけど、連鎖がないとぷよぷよじゃないですよね！」そうですね！連鎖は、ぷよを消した後に上から落ちてきたぷよが新たなグループを作って消える現象です。これがぷよぷよの最大の魅力ですね。</p>
<h3 id="_54">ユーザーストーリー<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<h3 id="_55">実装: 連鎖カウント<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>連鎖数を追跡し、スコアに反映します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/score.cljs</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.score</span><span class="p">)</span>

<span class="p">(</span><span class="k">def </span><span class="nv">chain-bonus</span>
<span class="w">  </span><span class="s">&quot;連鎖ボーナステーブル&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="mi">160</span><span class="w"> </span><span class="mi">192</span><span class="w"> </span><span class="mi">224</span><span class="w"> </span><span class="mi">256</span><span class="p">])</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">calculate-score</span>
<span class="w">  </span><span class="s">&quot;スコアを計算&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">erased-count</span><span class="w"> </span><span class="nv">chain-count</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">chain-idx</span><span class="w"> </span><span class="p">(</span><span class="nb">min </span><span class="nv">chain-count</span><span class="w"> </span><span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nb">count </span><span class="nv">chain-bonus</span><span class="p">)))</span>
<span class="w">        </span><span class="nv">bonus</span><span class="w"> </span><span class="p">(</span><span class="nb">nth </span><span class="nv">chain-bonus</span><span class="w"> </span><span class="nv">chain-idx</span><span class="p">)]</span>
<span class="w">    </span><span class="p">(</span><span class="nb">* </span><span class="nv">erased-count</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="nb">max </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">+ </span><span class="mi">1</span><span class="w"> </span><span class="nv">bonus</span><span class="p">)))))</span>

<span class="c1">;; src/puyo/core.cljs（更新）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">update-game</span>
<span class="w">  </span><span class="s">&quot;ゲームを更新する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="ss">:frame</span><span class="w"> </span><span class="nv">inc</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="p">(</span><span class="ss">:mode</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span>
<span class="w">    </span><span class="c1">;; ...</span>

<span class="w">    </span><span class="ss">:check-erase</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">groups</span><span class="w"> </span><span class="p">(</span><span class="nf">erase/find-erasable-groups</span><span class="w"> </span><span class="p">(</span><span class="ss">:field</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">))]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq </span><span class="nv">groups</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">erased-count</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce + </span><span class="p">(</span><span class="nb">map count </span><span class="nv">groups</span><span class="p">))</span>
<span class="w">              </span><span class="nv">chain-count</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="ss">:chain-count</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">))</span>
<span class="w">              </span><span class="nv">points</span><span class="w"> </span><span class="p">(</span><span class="nf">score/calculate-score</span><span class="w"> </span><span class="nv">erased-count</span><span class="w"> </span><span class="nv">chain-count</span><span class="p">)]</span>
<span class="w">          </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="nv">erase/erase-puyos</span><span class="w"> </span><span class="nv">groups</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="ss">:score</span><span class="w"> </span><span class="nb">+ </span><span class="nv">points</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:chain-count</span><span class="w"> </span><span class="nv">chain-count</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:apply-gravity</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">do</span>
<span class="w">          </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:chain-count</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:new-puyo</span><span class="p">))))</span>

<span class="w">    </span><span class="c1">;; ...</span>
<span class="w">    </span><span class="p">))</span>
</code></pre></div>
<h3 id="5_2">イテレーション5のまとめ<a class="headerlink" href="#5_2" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>連鎖カウント</strong>: 連続して消えた回数を追跡</li>
<li><strong>ボーナス計算</strong>: 連鎖数に応じた指数的なスコア増加</li>
<li><strong>状態リセット</strong>: 連鎖が途切れたらカウントをリセット</li>
</ol>
<h3 id="clojurespec_4">clojure.spec: スコア計算の仕様<a class="headerlink" href="#clojurespec_4" title="Permanent link">&para;</a></h3>
<p>イテレーション5では、スコア計算機能を実装しました。スコア関連の仕様を定義しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/specs.cljs（追加）</span>

<span class="c1">;; スコア</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::score</span><span class="w"> </span><span class="nv">nat-int?</span><span class="p">)</span>

<span class="c1">;; 連鎖数</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::chain-count</span><span class="w"> </span><span class="nv">nat-int?</span><span class="p">)</span>

<span class="c1">;; 消去ぷよ数</span>
<span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="ss">::erased-count</span><span class="w"> </span><span class="nv">pos-int?</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/score.cljs（spec を追加）</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.score</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.specs</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">specs</span><span class="p">]))</span>

<span class="c1">;; calculate-score の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">calculate-score</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:erased-count</span><span class="w"> </span><span class="ss">::specs/erased-count</span>
<span class="w">               </span><span class="ss">:chain-count</span><span class="w"> </span><span class="ss">::specs/chain-count</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="ss">::specs/score</span>
<span class="w">  </span><span class="ss">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn </span><span class="p">[{</span><span class="ss">:keys</span><span class="w"> </span><span class="p">[</span><span class="nv">args</span><span class="w"> </span><span class="nv">ret</span><span class="p">]}]</span>
<span class="w">        </span><span class="c1">;; スコアは消去数に比例する</span>
<span class="w">        </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">ret</span><span class="w"> </span><span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="ss">:erased-count</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"> </span><span class="mi">10</span><span class="p">))))</span>

<span class="c1">;; all-cleared? の仕様</span>
<span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="nv">all-cleared?</span>
<span class="w">  </span><span class="ss">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="ss">:field</span><span class="w"> </span><span class="ss">::specs/field</span><span class="p">)</span>
<span class="w">  </span><span class="ss">:ret</span><span class="w"> </span><span class="nv">boolean?</span><span class="p">)</span>
</code></pre></div>
<p>「スコア計算の不変条件を定義しているんですね！」そうです！<code>calculate-score</code> は「スコアは少なくとも消去数×10以上」という性質を持っています。これを spec で表現することで、スコア計算のバグを防げます。</p>
<h4 id="_56">生成的テスト<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">;; test/puyo/score_test.cljs（生成的テストを追加）</span>
<span class="p">(</span><span class="kd">ns </span><span class="nv">puyo.score-test</span>
<span class="w">  </span><span class="p">(</span><span class="ss">:require</span><span class="w"> </span><span class="p">[</span><span class="nv">cljs.test</span><span class="w"> </span><span class="ss">:refer-macros</span><span class="w"> </span><span class="p">[</span><span class="nv">deftest</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">testing</span><span class="p">]]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">cljs.spec.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">s</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">cljs.spec.test.alpha</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">stest</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.score</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">score</span><span class="p">]</span>
<span class="w">            </span><span class="p">[</span><span class="nv">puyo.specs</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">specs</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">スコア計算の生成的テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;calculate-score が仕様を満たす&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">results</span><span class="w"> </span><span class="p">(</span><span class="nf">stest/check</span><span class="w"> </span><span class="o">`</span><span class="p">[</span><span class="nv">score/calculate-score</span>
<span class="w">                                 </span><span class="nv">score/all-cleared?</span><span class="p">]</span>
<span class="w">                                </span><span class="p">{</span><span class="ss">:clojure.spec.test.check/opts</span>
<span class="w">                                 </span><span class="p">{</span><span class="ss">:num-tests</span><span class="w"> </span><span class="mi">100</span><span class="p">}})]</span>
<span class="w">      </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">result</span><span class="w"> </span><span class="nv">results</span><span class="p">]</span>
<span class="w">        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">nil? </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">result</span><span class="w"> </span><span class="ss">:clojure.spec.test.check/ret</span><span class="w"> </span><span class="ss">:result</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;生成的テスト失敗: &quot;</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">result</span><span class="w"> </span><span class="ss">:sym</span><span class="p">)))))))</span>

<span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="nv">スコア計算の性質テスト</span>
<span class="w">  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">&quot;連鎖数が増えるとスコアが指数的に増加する&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">base-score</span><span class="w"> </span><span class="p">(</span><span class="nf">score/calculate-score</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">          </span><span class="nv">chain2-score</span><span class="w"> </span><span class="p">(</span><span class="nf">score/calculate-score</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">          </span><span class="nv">chain3-score</span><span class="w"> </span><span class="p">(</span><span class="nf">score/calculate-score</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">chain2-score</span><span class="w"> </span><span class="p">(</span><span class="nb">* </span><span class="nv">base-score</span><span class="w"> </span><span class="mf">1.5</span><span class="p">))</span>
<span class="w">          </span><span class="s">&quot;2連鎖は1連鎖の1.5倍以上&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">chain3-score</span><span class="w"> </span><span class="p">(</span><span class="nb">* </span><span class="nv">chain2-score</span><span class="w"> </span><span class="mf">1.5</span><span class="p">))</span>
<span class="w">          </span><span class="s">&quot;3連鎖は2連鎖の1.5倍以上&quot;</span><span class="p">))))</span>
</code></pre></div>
<p>「性質ベースのテストも書いているんですね！」そうです！生成的テストに加えて、「連鎖数が増えるとスコアが指数的に増加する」という性質を明示的にテストしています。これにより、スコア計算の意図が明確になります。</p>
<h2 id="6_1">イテレーション6: 特殊機能<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h2>
<h3 id="_57">全消しボーナス<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/score.cljs（追加）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">all-cleared?</span>
<span class="w">  </span><span class="s">&quot;フィールドが空かチェック&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">field</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nb">every? zero? </span><span class="p">(</span><span class="nf">flatten</span><span class="w"> </span><span class="nv">field</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">zenkeshi-bonus</span><span class="w"> </span><span class="mi">2100</span><span class="p">)</span>

<span class="c1">;; src/puyo/core.cljs（更新）</span>
<span class="ss">:check-erase</span>
<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">groups</span><span class="w"> </span><span class="p">(</span><span class="nf">erase/find-erasable-groups</span><span class="w"> </span><span class="p">(</span><span class="ss">:field</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">))]</span>
<span class="w">  </span><span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq </span><span class="nv">groups</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">erased-count</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce + </span><span class="p">(</span><span class="nb">map count </span><span class="nv">groups</span><span class="p">))</span>
<span class="w">          </span><span class="nv">chain-count</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="ss">:chain-count</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">))</span>
<span class="w">          </span><span class="nv">points</span><span class="w"> </span><span class="p">(</span><span class="nf">score/calculate-score</span><span class="w"> </span><span class="nv">erased-count</span><span class="w"> </span><span class="nv">chain-count</span><span class="p">)</span>
<span class="w">          </span><span class="nv">new-field</span><span class="w"> </span><span class="p">(</span><span class="nf">erase/erase-puyos</span><span class="w"> </span><span class="p">(</span><span class="ss">:field</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span><span class="w"> </span><span class="nv">groups</span><span class="p">)</span>
<span class="w">          </span><span class="nv">all-clear</span><span class="w"> </span><span class="p">(</span><span class="nf">score/all-cleared?</span><span class="w"> </span><span class="nv">new-field</span><span class="p">)</span>
<span class="w">          </span><span class="nv">total-points</span><span class="w"> </span><span class="p">(</span><span class="k">if </span><span class="nv">all-clear</span>
<span class="w">                        </span><span class="p">(</span><span class="nb">+ </span><span class="nv">points</span><span class="w"> </span><span class="nv">score/zenkeshi-bonus</span><span class="p">)</span>
<span class="w">                        </span><span class="nv">points</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:field</span><span class="w"> </span><span class="nv">new-field</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="ss">:score</span><span class="w"> </span><span class="nb">+ </span><span class="nv">total-points</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:chain-count</span><span class="w"> </span><span class="nv">chain-count</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:apply-gravity</span><span class="p">))</span>
<span class="w">    </span><span class="c1">;; ...</span>
<span class="w">    </span><span class="p">))</span>
</code></pre></div>
<h3 id="_58">ゲームオーバー判定<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/core.cljs（更新）</span>
<span class="ss">:new-puyo</span>
<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-puyo</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-puyo</span><span class="p">)</span>
<span class="w">      </span><span class="nv">can-place</span><span class="w"> </span><span class="p">(</span><span class="nb">every? zero? </span><span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">get-in</span><span class="w"> </span><span class="p">(</span><span class="ss">:field</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)</span><span class="w"> </span><span class="nv">%</span><span class="p">)</span>
<span class="w">                                   </span><span class="p">[[</span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="p">]]))]</span>
<span class="w">  </span><span class="p">(</span><span class="k">if </span><span class="nv">can-place</span>
<span class="w">    </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:puyo</span><span class="w"> </span><span class="nv">new-puyo</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:playing</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="nv">game-state</span><span class="w"> </span><span class="nb">assoc </span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:game-over</span><span class="p">)))</span>

<span class="ss">:game-over</span>
<span class="nv">nil</span><span class="w">  </span><span class="c1">; ゲームオーバー状態を維持</span>
</code></pre></div>
<h2 id="7_1">イテレーション7: タッチ操作<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h2>
<h3 id="_59">タッチイベントの処理<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">;; src/puyo/player.cljs（追加）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">setup-touch-events</span>
<span class="w">  </span><span class="s">&quot;タッチイベントをセットアップする&quot;</span>
<span class="w">  </span><span class="p">[</span><span class="nv">input-state</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">canvas</span><span class="w"> </span><span class="p">(</span><span class="nf">.getElementById</span><span class="w"> </span><span class="nv">js/document</span><span class="w"> </span><span class="s">&quot;stage&quot;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">(</span><span class="nf">.addEventListener</span><span class="w"> </span><span class="nv">canvas</span><span class="w"> </span><span class="s">&quot;touchstart&quot;</span>
<span class="w">                       </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">e</span><span class="p">]</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">.preventDefault</span><span class="w"> </span><span class="nv">e</span><span class="p">)</span>
<span class="w">                         </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">touch</span><span class="w"> </span><span class="p">(</span><span class="nb">aget </span><span class="p">(</span><span class="nf">.-touches</span><span class="w"> </span><span class="nv">e</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                               </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientX</span><span class="w"> </span><span class="nv">touch</span><span class="p">)</span>
<span class="w">                               </span><span class="nv">rect</span><span class="w"> </span><span class="p">(</span><span class="nf">.getBoundingClientRect</span><span class="w"> </span><span class="nv">canvas</span><span class="p">)</span>
<span class="w">                               </span><span class="nv">relative-x</span><span class="w"> </span><span class="p">(</span><span class="nb">- </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nf">.-left</span><span class="w"> </span><span class="nv">rect</span><span class="p">))</span>
<span class="w">                               </span><span class="nv">canvas-width</span><span class="w"> </span><span class="p">(</span><span class="nf">.-width</span><span class="w"> </span><span class="nv">canvas</span><span class="p">)]</span>
<span class="w">                           </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">                             </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">relative-x</span><span class="w"> </span><span class="p">(</span><span class="nb">/ </span><span class="nv">canvas-width</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">                             </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span>

<span class="w">                             </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">relative-x</span><span class="w"> </span><span class="p">(</span><span class="nb">* </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="nb">/ </span><span class="nv">canvas-width</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span>
<span class="w">                             </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">true</span><span class="p">)</span>

<span class="w">                             </span><span class="ss">:else</span>
<span class="w">                             </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:up</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">true</span><span class="p">)))))</span>

<span class="w">    </span><span class="p">(</span><span class="nf">.addEventListener</span><span class="w"> </span><span class="nv">canvas</span><span class="w"> </span><span class="s">&quot;touchend&quot;</span>
<span class="w">                       </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">e</span><span class="p">]</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">.preventDefault</span><span class="w"> </span><span class="nv">e</span><span class="p">)</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:left</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:right</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="p">(</span><span class="ss">:up</span><span class="w"> </span><span class="nv">input-state</span><span class="p">)</span><span class="w"> </span><span class="nv">false</span><span class="p">)))))</span>

<span class="c1">;; src/puyo/core.cljs（更新）</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">initialize</span>
<span class="w">  </span><span class="s">&quot;ゲームを初期化する&quot;</span>
<span class="w">  </span><span class="p">[]</span>
<span class="w">  </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">canvas-ctx</span><span class="w"> </span><span class="p">(</span><span class="nf">stage/setup-canvas</span><span class="p">)]</span>
<span class="w">    </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="nv">game-state</span>
<span class="w">            </span><span class="p">{</span><span class="ss">:mode</span><span class="w"> </span><span class="ss">:new-puyo</span>
<span class="w">             </span><span class="ss">:frame</span><span class="w"> </span><span class="mi">0</span>
<span class="w">             </span><span class="ss">:field</span><span class="w"> </span><span class="p">(</span><span class="nf">stage/create-field</span><span class="p">)</span>
<span class="w">             </span><span class="ss">:puyo</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">             </span><span class="ss">:input-state</span><span class="w"> </span><span class="p">(</span><span class="nf">player/create-input-state</span><span class="p">)</span>
<span class="w">             </span><span class="ss">:canvas-ctx</span><span class="w"> </span><span class="nv">canvas-ctx</span>
<span class="w">             </span><span class="ss">:score</span><span class="w"> </span><span class="mi">0</span>
<span class="w">             </span><span class="ss">:chain-count</span><span class="w"> </span><span class="mi">0</span><span class="p">}))</span>

<span class="w">  </span><span class="c1">;; イベントをセットアップ</span>
<span class="w">  </span><span class="p">(</span><span class="nf">player/setup-keyboard-events</span><span class="w"> </span><span class="p">(</span><span class="ss">:input-state</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">player/setup-touch-events</span><span class="w"> </span><span class="p">(</span><span class="ss">:input-state</span><span class="w"> </span><span class="o">@</span><span class="nv">game-state</span><span class="p">)))</span>
</code></pre></div>
<h3 id="7_2">イテレーション7のまとめ<a class="headerlink" href="#7_2" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>タッチ領域の分割</strong>: 画面を3分割（左・中央・右）</li>
<li><strong>タッチイベント処理</strong>: touchstart/touchend で入力状態を更新</li>
<li><strong>既存コードとの統合</strong>: 入力状態の統一により既存の移動・回転処理がそのまま動作</li>
</ol>
<h2 id="_60">まとめ<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h2>
<p>本チュートリアルでは、ClojureScript とテスト駆動開発を使って、ぷよぷよゲームを実装しました。</p>
<h3 id="clojurescript_4">ClojureScript の特徴を活かした実装<a class="headerlink" href="#clojurescript_4" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>不変データ構造</strong></li>
<li>ゲーム状態を不変のマップで管理</li>
<li>状態遷移が明確で予測可能</li>
<li>
<p>タイムトラベルデバッグが容易</p>
</li>
<li>
<p><strong>純粋関数</strong></p>
</li>
<li>副作用のない関数によるロジック実装</li>
<li>テストが容易で信頼性が高い</li>
<li>
<p>関数合成による柔軟な設計</p>
</li>
<li>
<p><strong>高階関数とクロージャ</strong></p>
</li>
<li>関数を引数・戻り値として扱う</li>
<li>コードの再利用性が高い</li>
<li>
<p>抽象度の高い設計</p>
</li>
<li>
<p><strong>強力なコレクション操作</strong></p>
</li>
<li>reduce、filter、map による宣言的なデータ処理</li>
<li>-&gt;&gt; マクロによる処理の連鎖</li>
<li>
<p>シーケンス抽象による効率的な処理</p>
</li>
<li>
<p><strong>REPL 駆動開発</strong></p>
</li>
<li>対話的な開発により即座にフィードバック</li>
<li>関数単位での動作確認</li>
<li>探索的なプログラミング</li>
</ol>
<h3 id="_61">テスト駆動開発の実践<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Red-Green-Refactor サイクル</strong>: 各機能をテストファーストで実装</li>
<li><strong>小さなステップ</strong>: 一度に一つの機能を着実に実装</li>
<li><strong>継続的なリファクタリング</strong>: テストによる安全網のもとでコード改善</li>
</ul>
<h3 id="_62">完成したゲームの機能<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<ol>
<li>ぷよの基本操作（移動・回転）</li>
<li>壁キックによる操作性向上</li>
<li>ぷよの消去判定（深さ優先探索）</li>
<li>連鎖反応とスコア計算</li>
<li>全消しボーナス</li>
<li>ゲームオーバー判定</li>
<li>キーボード・タッチ操作対応</li>
</ol>
<h3 id="_63">次のステップ<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>この基盤を活用して、以下のような拡張が可能です：</p>
<ol>
<li><strong>ビジュアル強化</strong></li>
<li>アニメーション効果</li>
<li>パーティクルエフェクト</li>
<li>
<p>サウンド対応</p>
</li>
<li>
<p><strong>ゲーム機能拡張</strong></p>
</li>
<li>おじゃまぷよ</li>
<li>対戦モード</li>
<li>
<p>レベルシステム</p>
</li>
<li>
<p><strong>技術的改善</strong></p>
</li>
<li>re-frame による状態管理</li>
<li>core.async による非同期処理</li>
<li>spec による型チェック</li>
</ol>
<h3 id="_64">参考資料<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://clojurescript.org/">ClojureScript 公式ドキュメント</a></li>
<li><a href="https://shadow-cljs.github.io/docs/UsersGuide.html">shadow-cljs 公式ガイド</a></li>
<li>Kent Beck『テスト駆動開発』</li>
<li>Rich Hickey「Simple Made Easy」</li>
</ul>
<p>ClojureScript の関数型プログラミングとテスト駆動開発を組み合わせることで、保守性が高く、拡張しやすいコードを書くことができました。この知識を活かして、さらに高度なアプリケーション開発に挑戦してみてください！</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>