
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 F# Elmish.WPF版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#f-elmishwpf" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 F# Elmish.WPF版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="f-elmishwpf">ぷよぷよから始めるテスト駆動開発入門 F# Elmish.WPF版<a class="headerlink" href="#f-elmishwpf" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>注記</strong>: このドキュメントのイテレーション2以降は、Bolero版から自動変換されたものです。
View部分のコード例は、Bolero (Bolero.Html) の記法のままになっている箇所があります。
実際のWPF実装では、以下のような対応関係になります:</p>
<ul>
<li><strong>Bolero</strong>: <code>div []</code> / <code>button []</code> → <strong>WPF</strong>: XAML <code>&lt;StackPanel&gt;</code> / <code>&lt;Button&gt;</code></li>
<li><strong>Bolero</strong>: <code>on.click</code> → <strong>WPF</strong>: <code>Command="{Binding ...}"</code></li>
<li><strong>Bolero</strong>: <code>on.keydown</code> → <strong>WPF</strong>: <code>&lt;Window.InputBindings&gt;&lt;KeyBinding .../&gt;&lt;/Window.InputBindings&gt;</code></li>
<li><strong>Bolero</strong>: <code>attr.classes</code> → <strong>WPF</strong>: <code>Style="{StaticResource ...}"</code></li>
</ul>
<p>ドメインロジック部分 (GameLogic, PuyoPair, Board など) とElmish層 (Model, Update) のコードは、
Bolero版とWPF版で共通です。</p>
</blockquote>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは!今日は私と一緒にテスト駆動開発(TDD)を使って、F#とElmish.WPFでぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか?もしかしたら「テストって、コードを書いた後にするものじゃないの?」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説:テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの?」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう!</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか?「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか?</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう:</p>
<ol>
<li><strong>Red(赤)</strong>: まず失敗するテストを書きます。「え?わざと失敗するテストを?」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green(緑)</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor(リファクタリング)</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください!</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか?プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅(第2版)</p>
</blockquote>
<p>「どんなツールを使えばいいの?」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます:</p>
<ul>
<li><strong>言語</strong>: F# — 関数型プログラミングの力で、型安全で表現力豊かなコードを書きましょう。</li>
<li><strong>UIフレームワーク</strong>: Elmish.WPF — WPFベースのF#フレームワークで、Elmishアーキテクチャによる予測可能な状態管理を実現します。</li>
<li><strong>テストフレームワーク</strong>: xUnit — .NET標準のテストフレームワークです。</li>
<li><strong>アサーションライブラリ</strong>: FsUnit — F#らしいテストコードを書くためのライブラリです。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ?昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション0: 環境の構築で解説します。</p>
<h2 id="_4">要件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">ユーザーストーリー<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。
ユーザーストーリーには形式が定められておらず、標準的な記法もない。とはいえ、次のような形式でストーリーを考えてみると便利である。「＜ユーザーの種類＞として、＜機能や性能＞がほしい。それは＜ビジネス価値＞のためだ」という形のテンプレートに従うと、
たとえば次のようなストーリーを書ける。「本の購入者として、ＩＳＢＮで本を検索したい。それは探している本をすばやく見つけるためだ」</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう：</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜ん！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PCでプレイするなら必須ですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_6">ユースケース図<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>ユーザーストーリーを整理したところで、「これらの機能がどのように関連しているのか、全体像が見えるといいな」と思いませんか？そんなときに役立つのが「ユースケース図」です。
「ユースケース図って何？」と思われるかもしれませんね。ユースケース図は、システムと外部アクター（ここではプレイヤーとシステム自体）の相互作用を視覚的に表現するための図です。「絵に描いて整理すると分かりやすい」というやつですね。</p>
<blockquote>
<p>ユースケースは、システムの振る舞いに関する利害関係者の契約を表現するものです。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<p>「百聞は一見にしかず」というように、実際に見てみるのが一番分かりやすいですよね。では、私たちのぷよぷよゲームのユースケース図を見てみましょう：</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjU4OXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODI2cHg7aGVpZ2h0OjU4OXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgyNiA1ODkiIHdpZHRoPSI4MjZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU3NiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxNS4wNyIgeD0iMTEyIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1My45OTkzIiB4PSIzNDIuNTM1MyIgeT0iMjEuOTk1MSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MDc7JiMxMjQyNDsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfU3RhcnROZXdHYW1lIj48ZWxsaXBzZSBjeD0iMjE0LjAyNTkiIGN5PSI0NjkuOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMTUxLjAyNjIiIHk9IjQ3NC42NDM2Ij4mIzI2MDMyOyYjMTIzNzU7JiMxMjM1NjsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDM0OyYjMzgyODM7JiMyMjk4Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9SZXN0YXJ0R2FtZSI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iNTQwLjk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI1NDUuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQzNDsmIzEyNTIyOyYjMTI0NzM7JiMxMjQ3OTsmIzEyNTQwOyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1vdmVQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfTW92ZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjE5OS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNTguMDMyNyIgeT0iMjAzLjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMjQwMzg7JiMyMTQ5MTsmIzEyMzk1OyYjMzEyMjc7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUm90YXRlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfUm90YXRlUHV5byI+PGVsbGlwc2UgY3g9IjIxNC4wMjczIiBjeT0iMTMzLjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTc5LjAyNzQiIHk9IjEzNy42NTIxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzIyMjM4OyYjMzY1Nzg7PC90ZXh0PjwvZz48IS0tZW50aXR5IFF1aWNrRHJvcFB1eW8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X1F1aWNrRHJvcFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjY3LjAwMDUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3Mi4yNTI0IiByeT0iMTYuODUwNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjE1OC4wMzI3IiB5PSI3MS42NDg5Ij4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzMyMDMyOyYjMjYwODk7JiMxMjM2NzsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZhbGxQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZhbGxQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfRmFsbFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI1MiIgY3k9IjMyOS45OTUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI2Ni43MjUyIiByeT0iMTUuNzQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIxNjUuMDI1NCIgeT0iMzM0LjY0MzUiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMzMyNTg7JiMzMDAwMTsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEVyYXNlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJFcmFzZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9FcmFzZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI3MyIgY3k9IjI2NS4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjE3OS4wMjc0IiB5PSIyNjkuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyODA0MDsmIzIxNDM1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjI3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9DaGFpblJlYWN0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTIiIGN5PSIyNTYuOTk1IiBmaWxsPSIjRjFGMUYxIiByeD0iNjYuNzI1MiIgcnk9IjE1Ljc0NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMzg3LjAzNTQiIHk9IjI2MS42NDM1Ij4mIzM2ODk5OyYjMzc3ODI7JiMyMTQ1MzsmIzI0NTQwOyYjMTI0MzQ7JiMzMDMzMDsmIzI5OTgzOzwvdGV4dD48L2c+PCEtLWVudGl0eSBaZW5rZXNoaUJvbnVzLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ilplbmtlc2hpQm9udXMiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0iZW50MDAxMyIgaWQ9ImVudGl0eV9aZW5rZXNoaUJvbnVzIj48ZWxsaXBzZSBjeD0iNDM2LjA0MzEiIGN5PSIzMjYuOTk4NiIgZmlsbD0iI0YxRjFGMSIgcng9IjgzLjk5MzEiIHJ5PSIxOS4xOTg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iMzY2LjA0MzQiIHk9IjMzMS42NDcxIj4mIzIwODQwOyYjMjgwNDA7JiMxMjM3NTsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ5MDsmIzEyNDczOyYjMTI0MzQ7JiMyOTU1NDsmIzI0NDcxOzwvdGV4dD48L2c+PCEtLWVudGl0eSBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSIyOSIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJlbnRpdHlfRGlzcGxheVNjb3JlIj48ZWxsaXBzZSBjeD0iNjQxLjU1NDIiIGN5PSIyNTYuMDAyOCIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1OTkuNTU0NCIgeT0iMjYwLjY1MTMiPiYjMTI0NzM7JiMxMjQ2NzsmIzEyNDUwOyYjMTI0MzQ7JiMzNDkyMDsmIzMxMDM0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzNCIgZGF0YS11aWQ9ImVudDAwMTUiIGlkPSJlbnRpdHlfS2V5Ym9hcmRDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjA0MjQiIGN5PSIxMDAuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMzgwLjA0MjciIHk9IjEwNC42NDg5Ij4mIzEyNDYxOyYjMTI1NDA7JiMxMjUwODsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5MTsmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IEdhbWVPdmVyQ2hlY2stLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR2FtZU92ZXJDaGVjayIgZGF0YS1zb3VyY2UtbGluZT0iMzkiIGRhdGEtdWlkPSJlbnQwMDE2IiBpZD0iZW50aXR5X0dhbWVPdmVyQ2hlY2siPjxlbGxpcHNlIGN4PSIyMTQuMDI1OSIgY3k9IjM5OC45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIxNTEuMDI2MiIgeT0iNDAzLjY0MzYiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0NTg7JiMxMjU0MDsmIzEyNDk2OyYjMTI1NDA7JiMyMTAyODsmIzIzNDUwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBHYW1lT3ZlckFuaW1hdGlvbi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHYW1lT3ZlckFuaW1hdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iNDAiIGRhdGEtdWlkPSJlbnQwMDE3IiBpZD0iZW50aXR5X0dhbWVPdmVyQW5pbWF0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTkiIGN5PSIzOTguOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMzczLjAzNjIiIHk9IjQwMy42NDM2Ij4mIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDU4OyYjMTI1NDA7JiMxMjQ5NjsmIzEyNTQwOyYjMjg0MzY7JiMyMDk4Njs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUGxheWVyLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlBsYXllciIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJlbnRpdHlfUGxheWVyIj48ZWxsaXBzZSBjeD0iNDAuOTk5OCIgY3k9IjEzNi4zNSIgZmlsbD0iI0YxRjFGMSIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNDAuOTk5OCwxNDQuMzUgTDQwLjk5OTgsMTcxLjM1IE0yNy45OTk4LDE1Mi4zNSBMNTMuOTk5OCwxNTIuMzUgTTQwLjk5OTgsMTcxLjM1IEwyNy45OTk4LDE4Ni4zNSBNNDAuOTk5OCwxNzEuMzUgTDUzLjk5OTgsMTg2LjM1IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI2IiB5PSIyMDAuODQ1MSI+JiMxMjUwMzsmIzEyNTI0OyYjMTI0NTI7JiMxMjUxNjsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTeXN0ZW0tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImVudGl0eV9TeXN0ZW0iPjxlbGxpcHNlIGN4PSI3OTEuMDY5OSIgY3k9IjQzNi4zNSIgZmlsbD0iI0YxRjFGMSIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNzkxLjA2OTksNDQ0LjM1IEw3OTEuMDY5OSw0NzEuMzUgTTc3OC4wNjk5LDQ1Mi4zNSBMODA0LjA2OTksNDUyLjM1IE03OTEuMDY5OSw0NzEuMzUgTDc3OC4wNjk5LDQ4Ni4zNSBNNzkxLjA2OTksNDcxLjM1IEw4MDQuMDY5OSw0ODYuMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9Ijc2My4wNyIgeT0iNTAwLjg0NTEiPiYjMTI0NzE7JiMxMjQ3MzsmIzEyNDg2OyYjMTI1MTI7PC90ZXh0PjwvZz48IS0tbGluayBQbGF5ZXIgdG8gU3RhcnROZXdHYW1lLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSI0NSIgZGF0YS11aWQ9ImxuazE4IiBpZD0ibGlua19QbGF5ZXJfU3RhcnROZXdHYW1lIj48cGF0aCBkPSJNNTMuMDcsMjA0LjUgQzUzLjA3LDI4Ni4zIDUzLjA3LDQ3MCA1My4wNyw0NzAgQzUzLjA3LDQ3MCA4OC44OSw0NzAgMTI5LjksNDcwIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVN0YXJ0TmV3R2FtZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTM1LjksNDcwLDEyNi45LDQ2NiwxMzAuOSw0NzAsMTI2LjksNDc0LDEzNS45LDQ3MCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSZXN0YXJ0R2FtZSIgZGF0YS1zb3VyY2UtbGluZT0iNDYiIGRhdGEtdWlkPSJsbmsxOSIgaWQ9ImxpbmtfUGxheWVyX1Jlc3RhcnRHYW1lIj48cGF0aCBkPSJNMjkuMDcsMjA0LjM3IEMyOS4wNywyOTkuOTQgMjkuMDcsNTQxIDI5LjA3LDU0MSBDMjkuMDcsNTQxIDc5LjE4LDU0MSAxMjkuNTksNTQxIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJlc3RhcnRHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNTksNTQxLDEyNi41OSw1MzcsMTMwLjU5LDU0MSwxMjYuNTksNTQ1LDEzNS41OSw1NDEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIE1vdmVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iTW92ZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjQ3IiBkYXRhLXVpZD0ibG5rMjAiIGlkPSJsaW5rX1BsYXllcl9Nb3ZlUHV5byI+PHBhdGggZD0iTTc2LjQzLDE5My4xNSBDOTYuNCwxOTMuMTUgMTE2LjAzLDE5My4xNSAxMzkuNzUsMTkzLjE1IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLU1vdmVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDUuNzUsMTkzLjE1LDEzNi43NSwxODkuMTUsMTQwLjc1LDE5My4xNSwxMzYuNzUsMTk3LjE1LDE0NS43NSwxOTMuMTUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIFJvdGF0ZVB1eW8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSI0OCIgZGF0YS11aWQ9ImxuazIxIiBpZD0ibGlua19QbGF5ZXJfUm90YXRlUHV5byI+PHBhdGggZD0iTTc2LjQzLDE0MC45NyBDMTAzLjMyLDE0MC45NyAxMzQuNDgsMTQwLjk3IDE2My40LDE0MC45NyIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1Sb3RhdGVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNjkuNCwxNDAuOTcsMTYwLjQsMTM2Ljk3LDE2NC40LDE0MC45NywxNjAuNCwxNDQuOTcsMTY5LjQsMTQwLjk3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBRdWlja0Ryb3BQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iNDkiIGRhdGEtdWlkPSJsbmsyMiIgaWQ9ImxpbmtfUGxheWVyX1F1aWNrRHJvcFB1eW8iPjxwYXRoIGQ9Ik03Ni40NSwxMzQuNDEgQzEwOC45NSwxMzQuNDEgMTUyLjA3LDEzNC40MSAxNTIuMDcsMTM0LjQxIEMxNTIuMDcsMTM0LjQxIDE1Mi4wNywxMDAuNDkgMTUyLjA3LDgyLjA5IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVF1aWNrRHJvcFB1eW8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1Mi4wNyw3Ni4wOSwxNDguMDcsODUuMDksMTUyLjA3LDgxLjA5LDE1Ni4wNyw4NS4wOSwxNTIuMDcsNzYuMDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNTAiIGRhdGEtdWlkPSJsbmsyMyIgaWQ9ImxpbmtfUGxheWVyX0tleWJvYXJkQ29udHJvbCI+PHBhdGggZD0iTTQxLjA3LDEyNy40OSBDNDEuMDcsMTExLjcgNDEuMDcsOTcuMDUgNDEuMDcsOTcuMDUgQzQxLjA3LDk3LjA1IDI0NC42OSw5Ny4wNSAzNTguNTIsOTcuMDUiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjQuNTIsOTcuMDUsMzU1LjUyLDkzLjA1LDM1OS41Miw5Ny4wNSwzNTUuNTIsMTAxLjA1LDM2NC41Miw5Ny4wNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIEVyYXNlUHV5byB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRXJhc2VQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjUzIiBkYXRhLXVpZD0ibG5rMjQiIGlkPSJsaW5rX0VyYXNlUHV5b19TeXN0ZW0iPjxwYXRoIGQ9Ik0yNzIuODMsMjY1LjMyIEMzMDQuMjYsMjY1LjMyIDMzMi4wNywyNjUuMzIgMzMyLjA3LDI2NS4zMiBDMzMyLjA3LDI2NS4zMiAzMzIuMDcsNDM3LjUxIDMzMi4wNyw0MzcuNTEgQzMzMi4wNyw0MzcuNTEgNjYyLjYzLDQzNy41MSA3NjIuNyw0MzcuNTEiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjY2LjgzLDI2NS4zMiwyNzUuODMsMjY5LjMyLDI3MS44MywyNjUuMzIsMjc1LjgzLDI2MS4zMiwyNjYuODMsMjY1LjMyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRmFsbFB1eW8gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkZhbGxQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU0IiBkYXRhLXVpZD0ibG5rMjUiIGlkPSJsaW5rX0ZhbGxQdXlvX1N5c3RlbSI+PHBhdGggZD0iTTI4Ny4wNSwzMzAgQzMwNC4yOCwzMzAgMzEyLjA3LDMzMCAzMTIuMDcsMzMwIEMzMTIuMDcsMzMwIDMxMi4wNyw0NDIuMzQgMzEyLjA3LDQ0Mi4zNCBDMzEyLjA3LDQ0Mi4zNCA2NjAuMjEsNDQyLjM0IDc2Mi44OSw0NDIuMzQiIGZpbGw9Im5vbmUiIGlkPSJGYWxsUHV5by1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyODEuMDUsMzMwLDI5MC4wNSwzMzQsMjg2LjA1LDMzMCwyOTAuMDUsMzI2LDI4MS4wNSwzMzAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBDaGFpblJlYWN0aW9uIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJDaGFpblJlYWN0aW9uIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU1IiBkYXRhLXVpZD0ibG5rMjYiIGlkPSJsaW5rX0NoYWluUmVhY3Rpb25fU3lzdGVtIj48cGF0aCBkPSJNNTAzLjczLDI2My4zNSBDNTMwLjU5LDI2My4zNSA1NTAuMDcsMjYzLjM1IDU1MC4wNywyNjMuMzUgQzU1MC4wNywyNjMuMzUgNTUwLjA3LDQzMi42OCA1NTAuMDcsNDMyLjY4IEM1NTAuMDcsNDMyLjY4IDY5OS4zOCw0MzIuNjggNzYyLjk1LDQzMi42OCIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDk3LjczLDI2My4zNSw1MDYuNzMsMjY3LjM1LDUwMi43MywyNjMuMzUsNTA2LjczLDI1OS4zNSw0OTcuNzMsMjYzLjM1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgWmVua2VzaGlCb251cyB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iWmVua2VzaGlCb251cyIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NiIgZGF0YS11aWQ9ImxuazI3IiBpZD0ibGlua19aZW5rZXNoaUJvbnVzX1N5c3RlbSI+PHBhdGggZD0iTTUyNi4xOCwzMjcgQzYzMS4xNiwzMjcgNzkxLjA3LDMyNyA3OTEuMDcsMzI3IEM3OTEuMDcsMzI3IDc5MS4wNywzODYuNTEgNzkxLjA3LDQyNy42NSIgZmlsbD0ibm9uZSIgaWQ9Ilplbmtlc2hpQm9udXMtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTIwLjE4LDMyNyw1MjkuMTgsMzMxLDUyNS4xOCwzMjcsNTI5LjE4LDMyMyw1MjAuMTgsMzI3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRGlzcGxheVNjb3JlIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJEaXNwbGF5U2NvcmUiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTciIGRhdGEtdWlkPSJsbmsyOCIgaWQ9ImxpbmtfRGlzcGxheVNjb3JlX1N5c3RlbSI+PHBhdGggZD0iTTcwOS4zNywyNTYgQzc1NS42NywyNTYgODA1LjA3LDI1NiA4MDUuMDcsMjU2IEM4MDUuMDcsMjU2IDgwNS4wNywzNjYuODYgODA1LjA3LDQyNy40OCIgZmlsbD0ibm9uZSIgaWQ9IkRpc3BsYXlTY29yZS1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MDMuMzcsMjU2LDcxMi4zNywyNjAsNzA4LjM3LDI1Niw3MTIuMzcsMjUyLDcwMy4zNywyNTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckNoZWNrIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJHYW1lT3ZlckNoZWNrIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU4IiBkYXRhLXVpZD0ibG5rMjkiIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfU3lzdGVtIj48cGF0aCBkPSJNMjE0LjA3LDQyMy40OCBDMjE0LjA3LDQzNy4wNyAyMTQuMDcsNDQ3LjE3IDIxNC4wNyw0NDcuMTcgQzIxNC4wNyw0NDcuMTcgNjQ3LDQ0Ny4xNyA3NjIuODUsNDQ3LjE3IiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJDaGVjay1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMTQuMDcsNDE3LjQ4LDIxMC4wNyw0MjYuNDgsMjE0LjA3LDQyMi40OCwyMTguMDcsNDI2LjQ4LDIxNC4wNyw0MTcuNDgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckFuaW1hdGlvbiB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTkiIGRhdGEtdWlkPSJsbmszMCIgaWQ9ImxpbmtfR2FtZU92ZXJBbmltYXRpb25fU3lzdGVtIj48cGF0aCBkPSJNNTIwLjI4LDM5OSBDNjIwLjk2LDM5OSA3NzcuMDcsMzk5IDc3Ny4wNywzOTkgQzc3Ny4wNywzOTkgNzc3LjA3LDQxMi41MiA3NzcuMDcsNDI3LjQxIiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJBbmltYXRpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTE0LjI4LDM5OSw1MjMuMjgsNDAzLDUxOS4yOCwzOTksNTIzLjI4LDM5NSw1MTQuMjgsMzk5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIE1vdmVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNb3ZlUHV5byIgZGF0YS1lbnRpdHktMj0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2MiIgZGF0YS11aWQ9ImxuazMxIiBpZD0ibGlua19Nb3ZlUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yNzMuMDcsMTg5LjE2IEMyNzMuMDcsMTY2LjA2IDI3My4wNywxMTAuMjUgMjczLjA3LDExMC4yNSBDMjczLjA3LDExMC4yNSAzMjQuOSwxMTAuMjUgMzcxLjY3LDExMC4yNSIgZmlsbD0ibm9uZSIgaWQ9Ik1vdmVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc3LjY3LDExMC4yNSwzNjguNjcsMTA2LjI1LDM3Mi42NywxMTAuMjUsMzY4LjY3LDExNC4yNSwzNzcuNjcsMTEwLjI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjg2LjkxIiB5PSIxMjMuMzE2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBSb3RhdGVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSb3RhdGVQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjYzIiBkYXRhLXVpZD0ibG5rMzIiIGlkPSJsaW5rX1JvdGF0ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjE0LjA3LDExNy45OCBDMjE0LjA3LDExMC43NiAyMTQuMDcsMTAzLjY1IDIxNC4wNywxMDMuNjUgQzIxNC4wNywxMDMuNjUgMjk0LjI0LDEwMy42NSAzNTkuMiwxMDMuNjUiIGZpbGw9Im5vbmUiIGlkPSJSb3RhdGVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY1LjIsMTAzLjY1LDM1Ni4yLDk5LjY1LDM2MC4yLDEwMy42NSwzNTYuMiwxMDcuNjUsMzY1LjIsMTAzLjY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjIwLjQ3IiB5PSI5OS43MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFF1aWNrRHJvcFB1eW8gdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlF1aWNrRHJvcFB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNjQiIGRhdGEtdWlkPSJsbmszMyIgaWQ9ImxpbmtfUXVpY2tEcm9wUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yODAuMDcsNzQuMTYgQzI4MC4wNyw4MS4wNiAyODAuMDcsOTAuNDUgMjgwLjA3LDkwLjQ1IEMyODAuMDcsOTAuNDUgMzI1Ljg1LDkwLjQ1IDM2OS43NCw5MC40NSIgZmlsbD0ibm9uZSIgaWQ9IlF1aWNrRHJvcFB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNzUuNzQsOTAuNDUsMzY2Ljc0LDg2LjQ1LDM3MC43NCw5MC40NSwzNjYuNzQsOTQuNDUsMzc1Ljc0LDkwLjQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzIwLjc2IiB5PSI4Ni41MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIEVyYXNlUHV5byB0byBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkVyYXNlUHV5byIgZGF0YS1lbnRpdHktMj0iQ2hhaW5SZWFjdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iNjciIGRhdGEtdWlkPSJsbmszNCIgaWQ9ImxpbmtfRXJhc2VQdXlvX0NoYWluUmVhY3Rpb24iPjxwYXRoIGQ9Ik0yNjAuNTcsMjU3LjkgQzI5Mi4xLDI1Ny45IDMyOC4yNiwyNTcuOSAzNjMuMzUsMjU3LjkiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tdG8tQ2hhaW5SZWFjdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY5LjM1LDI1Ny45LDM2MC4zNSwyNTMuOSwzNjQuMzUsMjU3LjksMzYwLjM1LDI2MS45LDM2OS4zNSwyNTcuOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjI1MC45NiIgeT0iMjUzLjk2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIENoYWluUmVhY3Rpb24gdG8gRGlzcGxheVNjb3JlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkNoYWluUmVhY3Rpb24iIGRhdGEtZW50aXR5LTI9IkRpc3BsYXlTY29yZSIgZGF0YS1zb3VyY2UtbGluZT0iNjgiIGRhdGEtdWlkPSJsbmszNSIgaWQ9ImxpbmtfQ2hhaW5SZWFjdGlvbl9EaXNwbGF5U2NvcmUiPjxwYXRoIGQ9Ik00OTMuNTYsMjQ4LjY1IEM1MjMuMDEsMjQ4LjY1IDU1Mi42NSwyNDguNjUgNTgxLjU4LDI0OC42NSIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tdG8tRGlzcGxheVNjb3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1ODcuNTgsMjQ4LjY1LDU3OC41OCwyNDQuNjUsNTgyLjU4LDI0OC42NSw1NzguNTgsMjUyLjY1LDU4Ny41OCwyNDguNjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1NDEuNTciIHk9IjI0NC43MTY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBaZW5rZXNoaUJvbnVzIHRvIERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJaZW5rZXNoaUJvbnVzIiBkYXRhLWVudGl0eS0yPSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9IjY5IiBkYXRhLXVpZD0ibG5rMzYiIGlkPSJsaW5rX1plbmtlc2hpQm9udXNfRGlzcGxheVNjb3JlIj48cGF0aCBkPSJNNTE0LjA3LDMxOS42NyBDNTE0LjA3LDMwMS41MyA1MTQuMDcsMjU2IDUxNC4wNywyNTYgQzUxNC4wNywyNTYgNTQxLjE5LDI1NiA1NzMuNjgsMjU2IiBmaWxsPSJub25lIiBpZD0iWmVua2VzaGlCb251cy10by1EaXNwbGF5U2NvcmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU3OS42OCwyNTYsNTcwLjY4LDI1Miw1NzQuNjgsMjU2LDU3MC42OCwyNjAsNTc5LjY4LDI1NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjUxNi4wNCIgeT0iMjY5LjA2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIEdhbWVPdmVyQ2hlY2sgdG8gR2FtZU92ZXJBbmltYXRpb24tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJDaGVjayIgZGF0YS1lbnRpdHktMj0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtc291cmNlLWxpbmU9IjcwIiBkYXRhLXVpZD0ibG5rMzciIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfR2FtZU92ZXJBbmltYXRpb24iPjxwYXRoIGQ9Ik0yOTIuMywzOTkgQzMxMy41MiwzOTkgMzMwLjUsMzk5IDM1MS43MywzOTkiIGZpbGw9Im5vbmUiIGlkPSJHYW1lT3ZlckNoZWNrLXRvLUdhbWVPdmVyQW5pbWF0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNTcuNzMsMzk5LDM0OC43MywzOTUsMzUyLjczLDM5OSwzNDguNzMsNDAzLDM1Ny43MywzOTkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIyNjEuMDEiIHk9IjQxMi4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tU1JDPVtiTEpUSlhEMTZCdFZmelhtdXJMdjA0RDg1OUdCZW9CU1VKVGtudFJKeEt3cEVxS1JHczl0MUllOEQxTlJBQVkwb0EtWVcxNmJfM3BDVEJoak1wV3BJeFNwNTU5Q0RmbERWRVZpVHh1cFB5UTJKeDZFYVV3T1lJSk11d08zM01tWU10REpmZnExM2FaaDZNMmFHMEFFdWZtNVRMdTZUaUEyNGkwb1JPWHA2UVdaMW9VSGZqdEdZUlRBbDFfNEVvRi1DU2RscWpxRm1VY00xV29DN0JzNy0xTllWb0ZVNmw3UFN6b1owclNWamEwRUVYNzJFb0pVTi05RjRkelBiNFRwQmVQZkpPa3dDcW9VT0doZFJzLVZEX0FOTFU4QjNRQzRuNGRlaTR5a3dYbUx4QXU0blNiY1VSTnZ5V2pKSF9ucmxpdnV0Ynh1ZU1MVFEwMk5UUWNOVnY5eVhVSFZJSXJBcFY4Q3RQVzlYTTdXdTBWbXNIMThtcFBCMVhEX01fblFNRTROMTZpNGtmbWRJRUZRMVBMWWVsaFJzVGg5cWhLYWpZbWVxU0RyRWR6MHlabDFIZk5FbDFFVHhnQ25FOXBEZVNsV1l2eVFyVExHM3k4ME51S0JWWXROQXJpYUZ6eWVkakotWDZDX29mZjZRajExNlM3ZjYyNFFseE5KX3BUOE9zZXhNRFlKc2pxNWJkTTVrbGhsMGZzaDJqR1RYdkxLNjZsUWQybEotTGJ3amlIN1VOeUtCN21NdTg0YUNFcUgyQ0FtSG1Hd2lTZC1vQlZTTm44cEowa2pmTTFzZHZ2TTFGQ25qNUZHSlBndGFQcnJ2SnJkazBDSF81OVpQSkRPRW5CZUdURkRpNm9GNmlaZnQ2aXd5UExFQnJ4RjdFLXhxMUVnVWF0bzZzNTRIOUR4Q0ZTNDBJUy1XNnBpOEVrSTNNYVZZc2pzWW1BeUJKd0F4NHFCUS1tV1l1T3lrR183ZTNFR1g0UWcyd3ItbDQyZFpYSlFCVGpDMHM3eUVEVkExQWZOMGJDTm9qSjJVcTZGblZoTGVvUWpvdVQ5TWV3SUJxRlJFUFRNckoxQlhPa3NOZDJvaEo5QWRqdU5ZeEtrZ3JQZXZKS2JUTjkxMlBMU2FGQ1pob2l4UzVhWHliV2t5aW96Y1EzNTdJUXlUa1BmQlBGcXRqd0VTVk1SVWJ5VlY4d1g3VV9scnpoTVRTU2dYZFE3WXFsbDh0RXBMWXM3ZGQ5ZlJLX3YzckpaRURzcTNJaVJYdW9sclpYUUNLcTVncVB0MFFpY1N0MmRrbWhaN20wMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p>この図を見ると、プレイヤーとシステムの役割分担がよくわかりますね。プレイヤーはゲームの開始や操作を担当し、システムはぷよの消去判定やスコア計算などの内部処理を担当しています。</p>
<p>このようにユースケース図を作成することで、システムの全体像を把握し、実装すべき機能の関連性を明確にすることができます。それでは、実際のコード実装に進んでいきましょう！</p>
<p>誤解しないでもらいたいのですが本来ユースケースとはテキストで記述するものでありユースケース図は概要を把握するための手段に過ぎないということです。</p>
<blockquote>
<p>楕円、矢印、人型おアイコンから構成されているUMLのユースケース図は、ユースケースを把握するための表記法ではありません。
楕円や矢印は、ユースケースをのパッケージや分解を表すもので、内容を表すものではありません。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<h2 id="_7">リリース計画<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>要件もわかった、プログラミング開始だ！ちょっと待ってください、何事も計画を立てる事は大事なことです。ユースケース図を見てください、結構いろんなことがありますよね。何から取り組みますか？
「スコアの表示」ですか？「ゲームオーバー判定」ですか？でもまずは「新しいゲームを開始」しないとつながりとして難しいですよね。もちろん実際にプログラミングしながら順番を考えてもいいですけど間違った順番で進めると直すのが大変ですよね。
それにこれからどんなものを作るのかは事前にある程度イメージを固めておきたいものです（いきなり「ゲームオーバー」になるゲームはやりたくないですよね）。</p>
<blockquote>
<p>計画づくりとは「なにをいつまでに作ればいいのか？」という質問に答える作業だと私は考えている</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>今回の目的はぷよぷよゲームを遊べるための最小限の機能の実装です。目的を実現するためにやるべきことをイテレーションという単位でまとめましょう。「全部やること洗い出すの？そんな先のことはわからないよ！」と思いますよね。安心してください今決めることは大まかな作業の流れと前後関係の整理だけです。
細かい部分は各イテレーションでおいおい明確になってきます。その手助けをしてくれるのがテスト駆動開発なのです。</p>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>今回はユーザーストーリーとユースケース図から以下のイテレーション計画に従ってぷよぷよゲームをリリースします。</p>
<ul>
<li>イテレーション0: 環境の構築</li>
<li>イテレーション1: ゲーム開始の実装</li>
<li>イテレーション2: ぷよの移動の実装</li>
<li>イテレーション3: ぷよの回転の実装</li>
<li>イテレーション4: ぷよの自由落下の実装</li>
<li>イテレーション5: ぷよの高速落下の実装</li>
<li>イテレーション6: ぷよの消去の実装</li>
<li>イテレーション7: 連鎖反応の実装</li>
<li>イテレーション8: 全消しボーナスの実装</li>
<li>イテレーション9: ゲームオーバーの実装</li>
</ul>
<p>では、ぷよぷよゲーム開発スタートです！</p>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>...と言いたいところですがまずは環境の構築をしなければなりません。「プログラミングなんてどの言語でやるか決めるぐらいでしょ?」と思うかもしれませんが家を建てるときにしっかりとした基礎工事が必要なように開発環境もしっかりとした準備が必要です。
家を建てた後に基礎がダメだと困ったことになりますからね。</p>
<h3 id="_8">ソフトウェア開発の三種の神器<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本章では開発環境のセットアップとして、これら三種の神器を準備していきます。環境構築は退屈に感じるかもしれませんが、これらのツールがあることで、安心してコードを書くことができるようになります。一緒に進めていきましょう！</p>
<h3 id="git">バージョン管理: Gitとコミットメッセージ<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>バージョン管理システムとして Git を使います。Git については既に使用していると仮定しますが、コミットメッセージについて1つだけ重要なルールを確認しておきましょう。</p>
<h4 id="_9">コミットメッセージの書き方<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>私たちのプロジェクトでは、<a href="https://www.conventionalcommits.org/ja/">Conventional Commits</a>の書式に従ってコミットメッセージを書きます。具体的には、それぞれのコミットメッセージはヘッダ、ボディ、フッタで構成されます。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p>ヘッダは必須で、スコープは任意です。コミットメッセージのタイトルは50文字までにしましょう（GitHub上で読みやすくなります）。</p>
<p>コミットのタイプは次を用います：</p>
<ul>
<li><strong>feat</strong>: 新しい機能</li>
<li><strong>fix</strong>: バグ修正</li>
<li><strong>docs</strong>: ドキュメント変更のみ</li>
<li><strong>style</strong>: コードに影響を与えない変更（空白、フォーマットなど）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更</li>
<li><strong>test</strong>: テストの追加や修正</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更</li>
</ul>
<p>例えば：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化機能を追加&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: メソッドの抽出&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよ消去のテストケースを追加&#39;</span>
</code></pre></div>
<h3 id="elmishwpf-f">Elmish.WPF: F#のデスクトップアプリケーションフレームワーク<a class="headerlink" href="#elmishwpf-f" title="Permanent link">&para;</a></h3>
<p>「F#でデスクトップゲームを作る?どうやって?」と思われるかもしれませんね。ここで登場するのが <strong>Elmish.WPF</strong> です。Elmish.WPF は WPF(Windows Presentation Foundation) 上で動作するF#フレームワークで、Elmishアーキテクチャ(Model-View-Update パターン)による予測可能な状態管理を実現します。</p>
<h4 id="elmishwpf">Elmish.WPFとは<a class="headerlink" href="#elmishwpf" title="Permanent link">&para;</a></h4>
<p>Elmish.WPF は F# で Windows デスクトップアプリケーションを開発するためのフレームワークです。WPF をベースにしており、F# のコードで XAML を使った UI を構築できます。</p>
<p>「なぜElmish.WPFを使うの?直接WPFを書けばいいじゃない」と思われるかもしれませんね。それにはいくつかの理由があります:</p>
<p><strong>1. Elmishアーキテクチャ</strong></p>
<p>Elmish.WPF は Elmish という状態管理パターンを採用しています。これは The Elm Architecture(TEA)に基づいた、予測可能で保守性の高いアーキテクチャです。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Elmish の基本構造</span>

<span class="c1">// Model: アプリケーションの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Count</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="o">}</span>

<span class="c1">// Message: 状態を変更するイベント</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Increment</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Decrement</span>

<span class="c1">// Init: 初期状態</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// Update: メッセージに応じて状態を更新</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Increment</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Decrement</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// Bindings: XAML へのデータバインディング定義</span>
<span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Binding</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="s">&quot;Count&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Count</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;Increment&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Increment</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;Decrement&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Decrement</span><span class="o">)</span>
<span class="o">]</span>
</code></pre></div>
<p>「Elmishって何が良いの?」と思われるかもしれませんね。Elmish の素晴らしい点は、状態の変更が予測可能で、テストしやすいことです。すべての状態変更は <code>update</code> 関数を通じて行われるため、バグを減らすことができます。</p>
<p><strong>2. 型安全性</strong></p>
<p>F# の強力な型システムにより、コンパイル時に多くのエラーを検出できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: 型安全な状態管理</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">score</span><span class="o">:</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">level</span><span class="o">:</span><span class="n">int</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Paused</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">score</span><span class="o">:</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">level</span><span class="o">:</span><span class="n">int</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">finalScore</span><span class="o">:</span><span class="n">int</span>

<span class="k">let</span><span class="w"> </span><span class="nv">handleGameState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">(</span><span class="n">score</span><span class="o">,</span><span class="w"> </span><span class="n">level</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sprintf</span><span class="w"> </span><span class="s">&quot;Playing - Score: %d, Level: %d&quot;</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="n">level</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Paused</span><span class="w"> </span><span class="o">(</span><span class="n">score</span><span class="o">,</span><span class="w"> </span><span class="n">level</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sprintf</span><span class="w"> </span><span class="s">&quot;Paused - Score: %d, Level: %d&quot;</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="n">level</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="n">finalScore</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sprintf</span><span class="w"> </span><span class="s">&quot;Game Over - Final Score: %d&quot;</span><span class="w"> </span><span class="n">finalScore</span>

<span class="c1">// すべてのケースを処理しないとコンパイルエラー</span>
</code></pre></div>
<p><strong>3. 関数型プログラミング</strong></p>
<p>F# の関数型プログラミングの恩恵を受けられます:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: イミュータブルなデータ構造</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">}</span>

<span class="k">let</span><span class="w"> </span><span class="nv">position1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="k">let</span><span class="w"> </span><span class="nv">position2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">position1</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">}</span><span class="w">  </span><span class="c1">// 新しいインスタンスを作成</span>

<span class="c1">// position1 は変更されない</span>
<span class="n">printfn</span><span class="w"> </span><span class="s">&quot;%A&quot;</span><span class="w"> </span><span class="n">position1</span><span class="w">  </span><span class="c1">// { X = 0; Y = 0 }</span>
<span class="n">printfn</span><span class="w"> </span><span class="s">&quot;%A&quot;</span><span class="w"> </span><span class="n">position2</span><span class="w">  </span><span class="c1">// { X = 10; Y = 0 }</span>
</code></pre></div>
<p>「イミュータブルって何?」と思われるかもしれませんね。イミュータブルとは、一度作成したデータを変更できないという性質のことです。これにより、予期しない状態変更によるバグを防ぐことができます。</p>
<p><strong>4. パターンマッチング</strong></p>
<p>F# のパターンマッチングは、複雑な条件分岐を簡潔に書くことができる強力な機能です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: パターンマッチング</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span>

<span class="k">let</span><span class="w"> </span><span class="nv">getPuyoName</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;赤ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;青ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;緑ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;黄ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;空&quot;</span>

<span class="c1">// コンパイラがすべてのケースをチェック</span>
<span class="c1">// ケースの漏れがあるとコンパイルエラーになる</span>
</code></pre></div>
<h4 id="elmish">Elmishアーキテクチャの詳細<a class="headerlink" href="#elmish" title="Permanent link">&para;</a></h4>
<p>Elmish は単方向データフローによる状態管理パターンです。以下の3つの要素で構成されます:</p>
<p><strong>Model(状態)</strong></p>
<p>アプリケーションの現在の状態を表現します:</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Board</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">[,]</span>
<span class="w">    </span><span class="n">CurrentPuyo</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">GameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span>
<span class="o">}</span>
</code></pre></div>
<p><strong>Message(イベント)</strong></p>
<p>状態を変更するためのイベントを定義します:</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Drop</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span>
</code></pre></div>
<p><strong>Update(更新関数)</strong></p>
<p>メッセージを受け取り、新しい状態を返します:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movePuyoLeft</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="n">newModel</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movePuyoRight</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="n">newModel</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="n">newModel</span>
<span class="w">    </span><span class="c1">// ... 他のメッセージ処理</span>
</code></pre></div>
<p><strong>Bindings(バインディング)</strong></p>
<p>XAML との接続を定義します:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Binding</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="s">&quot;Board&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Board</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;Score&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Score</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;MoveLeft&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveLeft</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;MoveRight&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveRight</span><span class="o">)</span>
<span class="o">]</span>
</code></pre></div>
<h4 id="elmishwpf_1">Elmish.WPFのメリット<a class="headerlink" href="#elmishwpf_1" title="Permanent link">&para;</a></h4>
<p>「結局、Elmish.WPFを使うメリットは何?」とまとめたくなりますよね。以下がElmish.WPFの主なメリットです:</p>
<ol>
<li><strong>型安全性</strong>: コンパイル時に多くのバグを防ぐ</li>
<li><strong>予測可能な状態管理</strong>: Elmish による単方向データフロー</li>
<li><strong>テストしやすい</strong>: 純粋関数による実装</li>
<li><strong>関数型プログラミング</strong>: 再利用可能で保守しやすいコード</li>
<li><strong>.NETエコシステムとの統合</strong>: 既存の.NETライブラリを活用できる</li>
<li><strong>WPFの豊富なUIコントロール</strong>: 成熟したUIフレームワークを活用</li>
</ol>
<p>「難しそう...」と思われるかもしれませんが、心配いりません。このチュートリアルを通じて、F# と Elmish.WPF の基本を一緒に学んでいきましょう。テスト駆動開発の流れに沿って、一つずつ機能を実装していけば、自然と F# と Elmish.WPF の使い方が身につきますよ!</p>
<h3 id="fxunit">テスティング: F#とxUnit<a class="headerlink" href="#fxunit" title="Permanent link">&para;</a></h3>
<p>良いコードを書くためには、コードが正しく動作することを確認するテストが欠かせません。F# + Elmish.WPFのテスト環境をセットアップしていきましょう。</p>
<p>「F#でどうやってテストを書くの?」と思われるかもしれませんね。F#のテストは、.NETの標準的なテストフレームワークであるxUnitと、F#らしいアサーションを提供するFsUnitを組み合わせて書きます。</p>
<h4 id="f">F#プロジェクトの作成<a class="headerlink" href="#f" title="Permanent link">&para;</a></h4>
<p>まず、F#プロジェクトの構造を作成します:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトディレクトリの作成</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>app/fsharp-2/wpf
<span class="nb">cd</span><span class="w"> </span>app/fsharp-2/wpf

<span class="c1"># ソリューションの作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>sln<span class="w"> </span>-n<span class="w"> </span>PuyoPuyo

<span class="c1"># WPFプロジェクトの作成</span>
<span class="c1"># 注: F#のWPFテンプレートが存在しないため、classlibから作成して後で設定変更</span>
dotnet<span class="w"> </span>new<span class="w"> </span>classlib<span class="w"> </span>-lang<span class="w"> </span>F#<span class="w"> </span>-o<span class="w"> </span>src/PuyoPuyo.WPF

<span class="c1"># テストプロジェクトの作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>xunit<span class="w"> </span>-lang<span class="w"> </span>F#<span class="w"> </span>-o<span class="w"> </span>tests/PuyoPuyo.Tests

<span class="c1"># ソリューションにプロジェクトを追加</span>
dotnet<span class="w"> </span>sln<span class="w"> </span>add<span class="w"> </span>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj
dotnet<span class="w"> </span>sln<span class="w"> </span>add<span class="w"> </span>tests/PuyoPuyo.Tests/PuyoPuyo.Tests.fsproj

<span class="c1"># テストプロジェクトからWPFプロジェクトを参照</span>
dotnet<span class="w"> </span>add<span class="w"> </span>tests/PuyoPuyo.Tests<span class="w"> </span>reference<span class="w"> </span>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj
</code></pre></div>
<p>WPFプロジェクトの設定を変更します（<code>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj</code>）:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">        </span><span class="nt">&lt;OutputType&gt;</span>WinExe<span class="nt">&lt;/OutputType&gt;</span>
<span class="w">        </span><span class="nt">&lt;TargetFramework&gt;</span>net9.0-windows<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">        </span><span class="nt">&lt;GenerateDocumentationFile&gt;</span>true<span class="nt">&lt;/GenerateDocumentationFile&gt;</span>
<span class="w">        </span><span class="nt">&lt;UseWPF&gt;</span>true<span class="nt">&lt;/UseWPF&gt;</span>
<span class="w">        </span><span class="nt">&lt;EnableDefaultPageItems&gt;</span>false<span class="nt">&lt;/EnableDefaultPageItems&gt;</span>
<span class="w">    </span><span class="nt">&lt;/PropertyGroup&gt;</span>

<span class="w">    </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">        </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Domain.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Program.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="w">    </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">        </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Elmish.WPF&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;3.5.8&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<p><strong>重要</strong>: .NET 9 を使用します。.NET 10 は FSharpLint との互換性に問題があるため、<code>global.json</code> で SDK バージョンを固定します:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># global.jsonの作成</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>global.json<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">{</span>
<span class="s">  &quot;sdk&quot;: {</span>
<span class="s">    &quot;version&quot;: &quot;9.0.305&quot;,</span>
<span class="s">    &quot;rollForward&quot;: &quot;latestPatch&quot;</span>
<span class="s">  }</span>
<span class="s">}</span>
<span class="s">EOF</span>
</code></pre></div>
<h4 id="elmishwpffsunit">Elmish.WPFとFsUnitのセットアップ<a class="headerlink" href="#elmishwpffsunit" title="Permanent link">&para;</a></h4>
<p>必要なパッケージをインストールします:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># WPFプロジェクトへElmish.WPFを追加（既に.fsprojに含まれている場合はスキップ）</span>
dotnet<span class="w"> </span>add<span class="w"> </span>src/PuyoPuyo.WPF<span class="w"> </span>package<span class="w"> </span>Elmish.WPF

<span class="c1"># テストプロジェクトへFsUnitを追加</span>
dotnet<span class="w"> </span>add<span class="w"> </span>tests/PuyoPuyo.Tests<span class="w"> </span>package<span class="w"> </span>FsUnit.xUnit
</code></pre></div>
<p>テストプロジェクトの設定も .NET 9 に変更します（<code>tests/PuyoPuyo.Tests/PuyoPuyo.Tests.fsproj</code>）:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">        </span><span class="nt">&lt;TargetFramework&gt;</span>net9.0-windows<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">        </span><span class="nt">&lt;IsPackable&gt;</span>false<span class="nt">&lt;/IsPackable&gt;</span>
<span class="w">        </span><span class="nt">&lt;GenerateProgramFile&gt;</span>false<span class="nt">&lt;/GenerateProgramFile&gt;</span>
<span class="w">        </span><span class="nt">&lt;IsTestProject&gt;</span>true<span class="nt">&lt;/IsTestProject&gt;</span>
<span class="w">    </span><span class="nt">&lt;/PropertyGroup&gt;</span>

<span class="w">    </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">        </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Tests.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="w">    </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">        </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;coverlet.msbuild&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;6.0.4&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;PrivateAssets&gt;</span>all<span class="nt">&lt;/PrivateAssets&gt;</span>
<span class="w">            </span><span class="nt">&lt;IncludeAssets&gt;</span>runtime;<span class="w"> </span>build;<span class="w"> </span>native;<span class="w"> </span>contentfiles;<span class="w"> </span>analyzers;<span class="w"> </span>buildtransitive<span class="nt">&lt;/IncludeAssets&gt;</span>
<span class="w">        </span><span class="nt">&lt;/PackageReference&gt;</span>
<span class="w">        </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;FsUnit.xUnit&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;7.1.1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Microsoft.NET.Test.Sdk&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;17.14.1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;xunit.v3&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;3.0.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;xunit.runner.visualstudio&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;3.1.3&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;IncludeAssets&gt;</span>runtime;<span class="w"> </span>build;<span class="w"> </span>native;<span class="w"> </span>contentfiles;<span class="w"> </span>analyzers;<span class="w"> </span>buildtransitive<span class="nt">&lt;/IncludeAssets&gt;</span>
<span class="w">            </span><span class="nt">&lt;PrivateAssets&gt;</span>all<span class="nt">&lt;/PrivateAssets&gt;</span>
<span class="w">        </span><span class="nt">&lt;/PackageReference&gt;</span>
<span class="w">    </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="w">    </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">        </span><span class="nt">&lt;ProjectReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;..\..\src\PuyoPuyo.WPF\PuyoPuyo.WPF.fsproj&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<h3 id="_10">自動化: ビルドとタスク管理<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>開発の効率を上げるため、繰り返し実行するタスクを自動化しましょう。</p>
<h4 id="dotnet-watch">dotnet watch によるホットリロード<a class="headerlink" href="#dotnet-watch" title="Permanent link">&para;</a></h4>
<p>開発中は、コードを変更するたびに自動的にビルドして再読み込みする機能が便利です：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 開発サーバーを起動（ファイル変更を監視）</span>
<span class="nb">cd</span><span class="w"> </span>src/PuyoPuyo.WPF
dotnet<span class="w"> </span>watch<span class="w"> </span>run
</code></pre></div>
<p>アプリケーションが起動し、コードを変更すると、自動的にビルドされて再起動されます。</p>
<h4 id="_11">テストの自動実行<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>テスト駆動開発では、テストを頻繁に実行します。ファイルが変更されるたびに自動的にテストを実行する設定も便利です：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># テストを監視モードで実行</span>
dotnet<span class="w"> </span>watch<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--project<span class="w"> </span>tests/PuyoPuyo.Tests
</code></pre></div>
<h4 id="cake">Cake によるビルド自動化<a class="headerlink" href="#cake" title="Permanent link">&para;</a></h4>
<p>「ビルド自動化ツールは何を使えばいいですか？」.NETエコシステムでは Cake がよく使われます。CakeはC#で書けるクロスプラットフォームなビルド自動化ツールです。</p>
<h5 id="cake_1">Cakeとは<a class="headerlink" href="#cake_1" title="Permanent link">&para;</a></h5>
<p>Cake（C# Make）は、.NET開発者向けのビルド自動化システムです：</p>
<p><strong>特徴</strong>
- C#で書けるビルドスクリプト（型安全、IntelliSense対応）
- クロスプラットフォーム（Windows、macOS、Linux）
- 豊富なアドインとヘルパー
- .NETツールとの統合</p>
<p><strong>Makefileとの比較</strong></p>
<table>
<thead>
<tr>
<th>機能</th>
<th>Makefile</th>
<th>Cake</th>
</tr>
</thead>
<tbody>
<tr>
<td>記述言語</td>
<td>シェルスクリプト</td>
<td>C#</td>
</tr>
<tr>
<td>型チェック</td>
<td>なし</td>
<td>あり（コンパイル時）</td>
</tr>
<tr>
<td>IntelliSense</td>
<td>限定的</td>
<td>完全対応</td>
</tr>
<tr>
<td>.NET統合</td>
<td>外部コマンド</td>
<td>ネイティブ</td>
</tr>
<tr>
<td>依存関係</td>
<td>タブ文字必須</td>
<td>柔軟</td>
</tr>
</tbody>
</table>
<h5 id="cake_2">Cakeのセットアップ<a class="headerlink" href="#cake_2" title="Permanent link">&para;</a></h5>
<p>まず、Cakeをローカルツールとしてインストールします：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .NET ローカルツールマニフェストを作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>tool-manifest

<span class="c1"># Cakeをインストール</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>Cake.Tool

<span class="c1"># Fantomasをインストール（コードフォーマッタ）</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>fantomas

<span class="c1"># FSharpLintをインストール（静的解析）</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>dotnet-fsharplint
</code></pre></div>
<p>次に、ビルドスクリプト <code>build.cake</code> をプロジェクトルートに作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// 引数</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="kt">var</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argument</span><span class="p">(</span><span class="s">&quot;target&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Default&quot;</span><span class="p">);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argument</span><span class="p">(</span><span class="s">&quot;configuration&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Release&quot;</span><span class="p">);</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// タスク定義</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetClean</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./src/**/bin&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./src/**/obj&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./tests/**/bin&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./tests/**/obj&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Restore&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetRestore</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Restore&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetBuild</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetBuildSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetTest</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetTestSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Run&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetRun</span><span class="p">(</span><span class="s">&quot;./src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Watch&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;watch run --project ./src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Watch-Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;watch test --project ./tests/PuyoPuyo.Tests/PuyoPuyo.Tests.fsproj&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードを自動フォーマット&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fantomas src tests&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format-Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードフォーマットをチェック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fantomas src tests --check&quot;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;コードフォーマットエラーが検出されました。dotnet cake --target=Format で修正してください。&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;静的コード解析を実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fsharplint lint PuyoPuyo.sln&quot;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;静的コード解析でエラーが検出されました。&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;テストカバレッジを測定&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetTest</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetTestSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">ArgumentCustomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CollectCoverage=true&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CoverletOutputFormat=opencover&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CoverletOutput=./coverage/&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;カバレッジレポート: ./tests/PuyoPuyo.Tests/coverage/coverage.opencover.xml&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// ターゲット</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Default&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">);</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;CI&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;CI環境での完全なビルドとテスト&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Format-Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">);</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// 実行</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">RunTarget</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
</code></pre></div>
<p>「このスクリプトは何をしているんですか？」良い質問ですね！各タスクを見ていきましょう：</p>
<p><strong>タスクの説明</strong></p>
<ol>
<li>
<p><strong>Clean</strong>：ビルド成果物を削除
   <div class="highlight"><pre><span></span><code><span class="n">DotNetClean</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">);</span>
<span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./src/**/bin&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// binフォルダを削除</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Restore</strong>：NuGetパッケージを復元
   <div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Cleanタスクに依存</span>
<span class="n">DotNetRestore</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Build</strong>：プロジェクトをビルド
   <div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Restore&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Restoreタスクに依存</span>
<span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">  </span><span class="c1">// 既に復元済みなのでスキップ</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Test</strong>：テストを実行
   <div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Buildタスクに依存</span>
<span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">  </span><span class="c1">// 既にビルド済みなのでスキップ</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Run</strong>：アプリケーションを起動</p>
</li>
<li><strong>Watch</strong>：ファイル変更を監視して自動再起動</li>
<li><strong>Watch-Test</strong>：ファイル変更を監視して自動テスト実行</li>
</ol>
<p>「<code>.IsDependentOn()</code>は何ですか？」これは、タスク間の依存関係を定義するメソッドです。例えば<code>Test</code>タスクは<code>Build</code>タスクに依存しているので、<code>Test</code>を実行すると自動的に<code>Build</code>も実行されます。依存関係は連鎖するので、<code>Test</code>を実行すると<code>Clean</code> → <code>Restore</code> → <code>Build</code> → <code>Test</code>の順に実行されます。</p>
<h5 id="cake_3">Cakeの実行<a class="headerlink" href="#cake_3" title="Permanent link">&para;</a></h5>
<p>Cakeスクリプトを実行するには、以下のコマンドを使用します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># デフォルトタスク（Test）を実行</span>
dotnet<span class="w"> </span>cake

<span class="c1"># 特定のタスクを実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Run
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch

<span class="c1"># CI環境でのビルド</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>CI

<span class="c1"># 設定を指定</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build<span class="w"> </span>--configuration<span class="o">=</span>Debug
</code></pre></div>
<h5 id="powershell-windows">PowerShell スクリプト（Windows用）<a class="headerlink" href="#powershell-windows" title="Permanent link">&para;</a></h5>
<p>Windows環境では、PowerShellスクリプトを作成すると便利です：</p>
<div class="highlight"><pre><span></span><code><span class="c"># build.ps1</span>
<span class="p">[</span><span class="k">CmdletBinding</span><span class="p">()]</span>
<span class="k">Param</span><span class="p">(</span>
    <span class="no">[string]</span><span class="nv">$Target</span> <span class="p">=</span> <span class="s2">&quot;Default&quot;</span><span class="p">,</span>
    <span class="no">[string]</span><span class="nv">$Configuration</span> <span class="p">=</span> <span class="s2">&quot;Release&quot;</span>
<span class="p">)</span>

<span class="p">&amp;</span> <span class="n">dotnet</span> <span class="n">cake</span> <span class="p">-</span><span class="n">-target</span><span class="p">=</span><span class="nv">$Target</span> <span class="p">-</span><span class="n">-configuration</span><span class="p">=</span><span class="nv">$Configuration</span>
</code></pre></div>
<p>実行方法：</p>
<div class="highlight"><pre><span></span><code><span class="c"># デフォルトタスクを実行</span>
<span class="p">.\</span><span class="n">build</span><span class="p">.</span><span class="n">ps1</span>

<span class="c"># 特定のタスクを実行</span>
<span class="p">.\</span><span class="n">build</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Target</span> <span class="n">Build</span>
<span class="p">.\</span><span class="n">build</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Target</span> <span class="n">Test</span>
</code></pre></div>
<h5 id="bashmacoslinux">Bashスクリプト（macOS/Linux用）<a class="headerlink" href="#bashmacoslinux" title="Permanent link">&para;</a></h5>
<p>macOS/Linux環境では、Bashスクリプトを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># build.sh</span>
<span class="c1">#!/usr/bin/env bash</span>

<span class="nv">TARGET</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">Default</span><span class="si">}</span>
<span class="nv">CONFIGURATION</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">Release</span><span class="si">}</span>

dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$TARGET</span><span class="s2">&quot;</span><span class="w"> </span>--configuration<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$CONFIGURATION</span><span class="s2">&quot;</span>
</code></pre></div>
<p>実行権限を付与して実行：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 実行権限を付与</span>
chmod<span class="w"> </span>+x<span class="w"> </span>build.sh

<span class="c1"># デフォルトタスクを実行</span>
./build.sh

<span class="c1"># 特定のタスクを実行</span>
./build.sh<span class="w"> </span>Build
./build.sh<span class="w"> </span>Test
</code></pre></div>
<h5 id="cake_4">Cakeの利点<a class="headerlink" href="#cake_4" title="Permanent link">&para;</a></h5>
<p>「なぜCakeを使うのですか？」Cakeを使う利点は以下の通りです：</p>
<ol>
<li><strong>型安全性</strong>：C#で書くのでコンパイル時に型チェックされる</li>
<li><strong>IntelliSense</strong>：Visual Studio CodeやRiderで補完が効く</li>
<li><strong>再利用性</strong>：NuGetパッケージとしてビルドロジックを共有できる</li>
<li><strong>統合性</strong>：.NETツールとシームレスに統合</li>
<li><strong>可読性</strong>：複雑なビルドロジックも構造化して書ける</li>
<li><strong>クロスプラットフォーム</strong>：Windows、macOS、Linuxで同じスクリプトが動く</li>
</ol>
<h3 id="_12">自動化: コード品質の自動管理<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質を自動的にチェックし、維持していく仕組みが必要です。F#エコシステムのツールを活用しましょう。</p>
<h4 id="fantomas">コードフォーマッタ: Fantomas<a class="headerlink" href="#fantomas" title="Permanent link">&para;</a></h4>
<p>F#のコードフォーマットを統一するために <strong>Fantomas</strong> を使います。</p>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>—  リーダブルコード</p>
</blockquote>
<p>Fantomasのインストール：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>fantomas
</code></pre></div>
<p><code>build.cake</code>にフォーマット用のタスクを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake に追加</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードを自動フォーマット&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fantomas src tests&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format-Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードフォーマットをチェック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fantomas src tests --check&quot;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;コードフォーマットエラーが検出されました。dotnet cake --target=Format で修正してください。&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>フォーマットの実行：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format-Check<span class="w">  </span><span class="c1"># チェックのみ</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format<span class="w">        </span><span class="c1"># 自動修正</span>
</code></pre></div>
<h4 id="fsharplint">静的コード解析: FSharpLint<a class="headerlink" href="#fsharplint" title="Permanent link">&para;</a></h4>
<p>静的コード解析ツールとして <strong>FSharpLint</strong> を使います。</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>dotnet-fsharplint
</code></pre></div>
<p>プロジェクトルートに<code>fsharplint.json</code>を作成して、ルールをカスタマイズします：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;ignoreFiles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;**/obj/**/*.fs&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;**/bin/**/*.fs&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;hints&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;add&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;formatting&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;typedItemSpacing&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;typePrefixing&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;conventions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;naming&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;nestedStatements&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;depth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;cyclomaticComplexity&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;maxComplexity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>build.cake</code>にlint用のタスクを追加：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake に追加</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;静的コード解析を実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fsharplint lint PuyoPuyo.sln&quot;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;静的コード解析でエラーが検出されました。&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>静的解析の実行：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Lint
</code></pre></div>
<h4 id="_13">テストカバレッジ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>F#でのコードカバレッジ測定には、.NETエコシステムの <strong>coverlet</strong> や <strong>altcover</strong> を使用します。</p>
<p>coverletのインストール：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># coverletをテストプロジェクトに追加</span>
dotnet<span class="w"> </span>add<span class="w"> </span>tests/PuyoPuyo.Tests<span class="w"> </span>package<span class="w"> </span>coverlet.msbuild
</code></pre></div>
<p><code>build.cake</code>にカバレッジタスクを追加：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake に追加</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;テストカバレッジを測定&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetTest</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetTestSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">ArgumentCustomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CollectCoverage=true&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CoverletOutputFormat=opencover&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CoverletOutput=./coverage/&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;カバレッジレポート: ./tests/PuyoPuyo.Tests/coverage/coverage.opencover.xml&quot;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>カバレッジの実行：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Coverage
</code></pre></div>
<h4 id="ci">CI環境での品質チェック<a class="headerlink" href="#ci" title="Permanent link">&para;</a></h4>
<p>CI環境では、すべての品質チェックを自動実行します。<code>build.cake</code>のCIタスクを拡張：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake の CI タスクを更新</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;CI&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;CI環境での完全なビルドとテスト&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Format-Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">);</span>
</code></pre></div>
<p>これにより、CI環境では以下が自動実行されます：</p>
<ol>
<li>クリーンビルド</li>
<li>フォーマットチェック</li>
<li>静的コード解析</li>
<li>テスト実行</li>
<li>カバレッジ測定</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># CI環境での実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>CI
</code></pre></div>
<h3 id="git_1">Git の設定<a class="headerlink" href="#git_1" title="Permanent link">&para;</a></h3>
<p>プロジェクトのバージョン管理を開始しましょう。</p>
<h4 id="gitignore">.gitignoreの設定<a class="headerlink" href="#gitignore" title="Permanent link">&para;</a></h4>
<p>F#プロジェクト固有のファイルを除外するため、<code>.gitignore</code> ファイルを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトルートに .gitignore を作成</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>.gitignore<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s"># Build results</span>
<span class="s">[Dd]ebug/</span>
<span class="s">[Rr]elease/</span>
<span class="s">x64/</span>
<span class="s">x86/</span>
<span class="s">[Bb]in/</span>
<span class="s">[Oo]bj/</span>

<span class="s"># Visual Studio</span>
<span class="s">.vs/</span>
<span class="s">*.user</span>
<span class="s">*.suo</span>
<span class="s">*.userosscache</span>
<span class="s">*.sln.docstates</span>

<span class="s"># Rider</span>
<span class="s">.idea/</span>
<span class="s">*.sln.iml</span>

<span class="s"># User-specific files</span>
<span class="s">*.rsuser</span>
<span class="s">*.suo</span>
<span class="s">*.user</span>
<span class="s">*.userosscache</span>
<span class="s">*.sln.docstates</span>

<span class="s"># Mono Auto Generated Files</span>
<span class="s">mono_crash.*</span>

<span class="s"># Build Results</span>
<span class="s">[Dd]ebug/</span>
<span class="s">[Dd]ebugPublic/</span>
<span class="s">[Rr]elease/</span>
<span class="s">[Rr]eleases/</span>
<span class="s">x64/</span>
<span class="s">x86/</span>
<span class="s">[Aa][Rr][Mm]/</span>
<span class="s">[Aa][Rr][Mm]64/</span>
<span class="s">bld/</span>
<span class="s">[Bb]in/</span>
<span class="s">[Oo]bj/</span>
<span class="s">[Ll]og/</span>
<span class="s">[Ll]ogs/</span>

<span class="s"># .NET Core</span>
<span class="s">project.lock.json</span>
<span class="s">project.fragment.lock.json</span>
<span class="s">artifacts/</span>

<span class="s"># Cake</span>
<span class="s">tools/**</span>
<span class="s">!tools/packages.config</span>

<span class="s"># Coverage</span>
<span class="s">coverage/</span>
<span class="s">*.opencover.xml</span>
<span class="s">EOF</span>
</code></pre></div>
<h4 id="_14">初期コミット<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>プロジェクトを Git で管理開始します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gitリポジトリを初期化</span>
git<span class="w"> </span>init

<span class="c1"># すべてのファイルをステージング</span>
git<span class="w"> </span>add<span class="w"> </span>.

<span class="c1"># 初期コミット</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: initialize F# Elmish.WPF Puyo Puyo project with test setup&quot;</span>
</code></pre></div>
<h3 id="0_1">イテレーション0のまとめ<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで準備した環境：</p>
<ol>
<li>
<p><strong>バージョン管理</strong></p>
<ul>
<li>既存の Git リポジトリを使用（case-study-game-dev）</li>
<li>.gitignoreの設定（.NET / F# 対応）</li>
<li>Conventional Commitsの規約</li>
</ul>
</li>
<li>
<p><strong>プロジェクト構造</strong>
   <div class="highlight"><pre><span></span><code>app/fsharp-2/wpf/
├── .config/
│   └── dotnet-tools.json       # ローカルツール設定
├── global.json                 # .NET SDK バージョン固定 (9.0.305)
├── PuyoPuyo.sln                # ソリューションファイル
├── build.cake                  # Cake ビルドスクリプト
├── build.ps1 / build.sh        # ビルドスクリプトラッパー
├── fsharplint.json             # FSharpLint 設定
├── src/
│   └── PuyoPuyo.WPF/
│       ├── PuyoPuyo.WPF.fsproj # WPF プロジェクト (.NET 9)
│       ├── Domain.fs           # Elmish ドメインロジック
│       └── Program.fs          # アプリケーションエントリーポイント
└── tests/
    └── PuyoPuyo.Tests/
        ├── PuyoPuyo.Tests.fsproj # テストプロジェクト (.NET 9)
        └── Tests.fs              # テストファイル
</code></pre></div></p>
</li>
<li>
<p><strong>テスティング</strong></p>
<ul>
<li>xUnit v3 のセットアップ</li>
<li>FsUnit.xUnit 7.1.1 の導入</li>
<li>coverlet.msbuild 6.0.4 によるカバレッジ測定</li>
<li>テストプロジェクトから WPF プロジェクトへの参照</li>
</ul>
</li>
<li>
<p><strong>自動化</strong></p>
<ul>
<li>dotnet watch によるホットリロード</li>
<li>Cake によるビルド自動化（型安全な C# スクリプト）</li>
<li>タスク依存関係の管理</li>
<li>クロスプラットフォーム対応（build.ps1 / build.sh）</li>
<li>Fantomas によるコードフォーマット自動化</li>
<li>FSharpLint による静的コード解析</li>
<li>coverlet によるテストカバレッジ測定</li>
<li>CI 環境での品質チェック自動化（<code>dotnet cake --target=CI</code>）</li>
</ul>
</li>
<li>
<p><strong>Elmish.WPF の理解</strong></p>
<ul>
<li>Elmish.WPF 3.5.8 のセットアップ</li>
<li>Elmish アーキテクチャの基本（Model-View-Update）</li>
<li>型安全な状態管理</li>
<li>コードベースの UI 構築（XAML を使用しない）</li>
<li>データバインディングの実装</li>
</ul>
</li>
<li>
<p><strong>技術的な決定事項</strong></p>
<ul>
<li>.NET 9 の使用（.NET 10 は FSharpLint 非互換のため）</li>
<li>global.json による SDK バージョン固定（9.0.305）</li>
<li>コード重視のアプローチ（XAML ファイルを使用しない）</li>
<li>最小限の Elmish.WPF セットアップ（Model、Message、init、update、bindings）</li>
</ul>
</li>
<li>
<p><strong>動作確認</strong></p>
<ul>
<li><code>dotnet cake --target=Run</code> でアプリケーションが起動</li>
<li>ウィンドウに「ぷよぷよゲーム」が表示されることを確認</li>
<li><code>dotnet cake --target=CI</code> ですべての品質チェックがパス</li>
</ul>
</li>
</ol>
<p>「環境構築って面倒だな...」と思われたかもしれませんが、ここで準備したツールがこれからの開発を助けてくれます。テスト駆動開発では、テストを頻繁に実行し、小さな変更を積み重ねていきます。そのため、自動化されたテスト環境とバージョン管理が不可欠なのです。</p>
<p>次のイテレーションから、実際にぷよぷよゲームの実装を始めていきます。Elmishアーキテクチャの力を使って、予測可能で保守性の高いコードを書いていきましょう！</p>
<h3 id="elmishwpf_2">Elmish.WPF 最小セットアップ<a class="headerlink" href="#elmishwpf_2" title="Permanent link">&para;</a></h3>
<p>環境構築の最後に、Elmish.WPF が正しく動作することを確認するための最小限のアプリケーションを作成します。</p>
<p><strong>重要</strong>: このチュートリアルではコード重視のアプローチを採用し、XAML ファイルは使用しません。すべての UI を F# コードで定義します。</p>
<h4 id="domainfs">Domain.fs の作成<a class="headerlink" href="#domainfs" title="Permanent link">&para;</a></h4>
<p>Elmish の基本構造を <code>src/PuyoPuyo.WPF/Domain.fs</code> に作成します:</p>
<div class="highlight"><pre><span></span><code><span class="k">namespace</span><span class="w"> </span><span class="n">PuyoPuyo</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>

<span class="sd">/// &lt;summary&gt;</span>
<span class="sd">/// Domain module</span>
<span class="sd">/// &lt;/summary&gt;</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Domain</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="sd">/// Model</span>
<span class="w">    </span><span class="sd">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="sd">/// Message</span>
<span class="w">    </span><span class="sd">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">unit</span>

<span class="w">    </span><span class="sd">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="sd">/// Initialize the model</span>
<span class="w">    </span><span class="sd">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ぷよぷよゲーム&quot;</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="sd">/// Update the model</span>
<span class="w">    </span><span class="sd">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<h4 id="programfs">Program.fs の作成<a class="headerlink" href="#programfs" title="Permanent link">&para;</a></h4>
<p>アプリケーションのエントリーポイントを <code>src/PuyoPuyo.WPF/Program.fs</code> に作成します:</p>
<div class="highlight"><pre><span></span><code><span class="k">namespace</span><span class="w"> </span><span class="n">PuyoPuyo</span>

<span class="k">open</span><span class="w"> </span><span class="nn">System</span>
<span class="k">open</span><span class="w"> </span><span class="nn">System.Windows</span>
<span class="k">open</span><span class="w"> </span><span class="nn">System.Windows.Controls</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.WPF</span>

<span class="sd">/// &lt;summary&gt;</span>
<span class="sd">/// Program module</span>
<span class="sd">/// &lt;/summary&gt;</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Program</span><span class="w"> </span><span class="o">=</span>

<span class="w">    </span><span class="sd">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="sd">/// Bindings for Elmish.WPF</span>
<span class="w">    </span><span class="sd">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Binding</span><span class="o">&lt;</span><span class="nn">Domain</span><span class="p">.</span><span class="n">Model</span><span class="o">,</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;Message&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Message</span><span class="o">)</span><span class="w"> </span><span class="o">]</span>

<span class="w">    </span><span class="sd">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="sd">/// Main entry point</span>
<span class="w">    </span><span class="sd">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">;</span><span class="w"> </span><span class="n">STAThread</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="n">argv</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// TextBlockをコードで作成</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">textBlock</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">TextBlock</span><span class="o">(</span>
<span class="w">                </span><span class="n">FontSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="o">.</span><span class="mi">0</span><span class="o">,</span>
<span class="w">                </span><span class="n">HorizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">HorizontalAlignment</span><span class="p">.</span><span class="n">Center</span><span class="o">,</span>
<span class="w">                </span><span class="n">VerticalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">VerticalAlignment</span><span class="p">.</span><span class="n">Center</span>
<span class="w">            </span><span class="o">)</span>

<span class="w">        </span><span class="n">textBlock</span><span class="o">.</span><span class="n">SetBinding</span><span class="o">(</span><span class="nn">TextBlock</span><span class="p">.</span><span class="n">TextProperty</span><span class="o">,</span><span class="w"> </span><span class="s">&quot;Message&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span>

<span class="w">        </span><span class="c1">// Windowをコードで作成</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">window</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Window</span><span class="o">(</span><span class="n">Title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PuyoPuyo&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">Width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">800</span><span class="o">.</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="n">Height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">600</span><span class="o">.</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="n">Content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textBlock</span><span class="o">)</span>

<span class="w">        </span><span class="nn">Program</span><span class="p">.</span><span class="n">mkSimpleWpf</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">bindings</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">withConsoleTrace</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">runWindowWithConfig</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="nn">ElmConfig</span><span class="p">.</span><span class="n">Default</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">LogConsole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">                </span><span class="n">Measure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">window</span>

<span class="w">        </span><span class="mi">0</span>
</code></pre></div>
<p><strong>ポイント</strong>:
- XAML を使用せず、すべて F# コードで UI を構築
- <code>TextBlock</code> を <code>Window.Content</code> に直接設定
- データバインディングは <code>SetBinding</code> メソッドで設定
- Elmish.WPF の <code>bindings</code> で Model のプロパティを公開</p>
<h4 id="_15">動作確認とデバッグ<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>WPF アプリケーションを実行するには:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 開発中の実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Run

<span class="c1"># または watch モードで実行（ファイル変更を自動検出）</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch

<span class="c1"># 直接実行する場合</span>
<span class="nb">cd</span><span class="w"> </span>src/PuyoPuyo.WPF
dotnet<span class="w"> </span>run
</code></pre></div>
<p>アプリケーションが起動し、ウィンドウの中央に「ぷよぷよゲーム」と表示されれば成功です。</p>
<h4 id="_16">ビルドと品質チェック<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>すべてのタスクが正しく動作することを確認します:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># コードフォーマット</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format

<span class="c1"># CI パイプライン（フォーマット、Lint、テスト、カバレッジ）</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>CI
</code></pre></div>
<p>すべてのチェックがパスすることを確認してください。</p>
<p>[注: 以降のイテレーションでは、ドメインロジック部分は Bolero 版と同じですが、
View 部分を WPF のコード（または必要に応じて XAML）に、
イベント処理を WPF の Command バインディングに変換します]</p>
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>「環境構築が終わったので、いよいよゲームの実装を始めましょう！」そうですね！最初のイテレーションでは、ゲームの基本となるボードとぷよのデータ構造を実装していきます。</p>
<h3 id="_17">ユーザーストーリー<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームを開始して初期状態のボードとぷよが表示される</p>
</blockquote>
<p>「ゲームを開始するって、具体的に何が必要なんですか？」良い質問ですね！ゲームを開始するためには、以下のような要素が必要です：</p>
<ol>
<li><strong>ゲームボード</strong>：ぷよを配置する場所</li>
<li><strong>ぷよ</strong>：落ちてくるゲームの主役</li>
<li><strong>初期状態</strong>：ゲームが始まったときの状態</li>
</ol>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの色を表現する型を定義する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームボードを表現する型を定義する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 空のボードを作成する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよをボードに配置する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ボードからぷよを取得する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<p>「結構たくさんありますね！」そうですね。でも、一つ一つは小さな機能なので、TDDサイクルに従って着実に進めていけば大丈夫ですよ。</p>
<h3 id="_18">テスト: ぷよの色定義<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>「最初は何からテストしますか？」まずは最も基本的な「ぷよの色」から始めましょう。F#では判別共用体（Discriminated Union）を使って、型安全にぷよの色を表現できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/PuyoTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Domain.PuyoTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよの色は4種類定義されている``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">]</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``赤色のぷよが作成できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Red</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">puyo</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Red</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``緑色のぷよが作成できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">puyo</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Green</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下の点を確認しています：</p>
<ol>
<li>ぷよの色が4種類（赤、緑、青、黄）定義されているか</li>
<li>それぞれの色のぷよが作成できるか</li>
</ol>
<p>「シンプルですね！」そうです。まずは基本から始めましょう。では、このテストが通るように実装していきます。</p>
<h3 id="_19">実装: ぷよの色定義<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。まずはテストを実行してみてください：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>テストが失敗することを確認したら、実装を進めます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Puyo.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Domain</span>

<span class="sd">/// ぷよの色</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Puyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// ぷよの色をHEX形式の文字列に変換</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">toHex</span><span class="w"> </span><span class="o">(</span><span class="n">color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#FF0000&quot;</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#00FF00&quot;</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#0000FF&quot;</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#FFFF00&quot;</span>
</code></pre></div>
<p>「判別共用体を使うと、色を型安全に扱えるんですね！」そうです！TypeScriptでは数値で色を表現していましたが、F#では判別共用体を使うことで、コンパイル時に存在しない色を使おうとするとエラーになります。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="_20">テスト: ゲームボードの作成<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>「次は何をテストしますか?」次は、ぷよを配置するゲームボードを実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Domain.BoardTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``空のボードを作成できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">13</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``作成直後のボードはすべて空である``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ボードにぷよを配置できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ボードにぷよを配置しても元のボードは変更されない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
</code></pre></div>
<p>「イミュータブルなデータ構造のテストもあるんですね！」そうです！F#ではデフォルトでデータ構造がイミュータブルなので、<code>setCell</code>を呼び出しても元のボードは変更されず、新しいボードが返されます。これが最後のテストで確認している内容です。</p>
<h3 id="_21">実装: ゲームボードの作成<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ボードの実装を進めます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Domain</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="sd">/// セルの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">PuyoColor</span>

<span class="sd">/// ゲームボード</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Cols</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Rows</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Cells</span><span class="o">:</span><span class="w"> </span><span class="n">Cell</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">array</span>
<span class="o">}</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// 空のボードを作成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">create</span><span class="w"> </span><span class="o">(</span><span class="n">cols</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">rows</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="n">Cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cols</span>
<span class="w">            </span><span class="n">Rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows</span>
<span class="w">            </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="n">Empty</span><span class="o">)</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// セルの取得</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">getCell</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Cell</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">board</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">Empty</span>

<span class="w">    </span><span class="sd">/// セルの設定（イミュータブル）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">setCell</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">cell</span><span class="o">:</span><span class="w"> </span><span class="n">Cell</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newCells</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">board</span><span class="o">.</span><span class="n">Cells</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">rowIndex</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">rowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="n">row</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">colIndex</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="n">colIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">c</span><span class="o">)</span>
<span class="w">                    </span><span class="k">else</span>
<span class="w">                        </span><span class="n">row</span><span class="o">)</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCells</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">board</span>
</code></pre></div>
<p>「<code>Array.mapi</code>を使って新しい配列を作成しているんですね！」そうです！F#では元のデータを変更せず、新しいデータを作成して返すのが基本です。<code>mapi</code>は<code>map</code>にインデックスが追加されたバージョンで、各要素の位置を確認しながら変換できます。</p>
<blockquote>
<p><strong>💡 ポイント</strong>: <code>setCell</code> の引数順序を <code>(x: int) (y: int) (cell: Cell) (board: Board)</code> にすることで、F# のパイプライン演算子 <code>|&gt;</code> との相性が良くなります。<code>board |&gt; setCell 2 10 (Filled Red)</code> のように自然に記述できます。</p>
</blockquote>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="_22">テスト: ぷよペアの定義<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>「ぷよぷよでは2つのぷよが一緒に落ちてきますよね？」そうです！次は、2つのぷよをペアとして扱うデータ構造を実装しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/PuyoPairTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Domain.PuyoPairTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを作成できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Red</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Green</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態0のとき2つ目のぷよは上にある``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">4</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは上</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態1のとき2つ目のぷよは右にある``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは右</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態2のとき2つ目のぷよは下にある``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">2</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">6</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは下</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態3のとき2つ目のぷよは左にある``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">3</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは左</span>
</code></pre></div>
<p>「回転状態によって2つ目のぷよの位置が変わるんですね！」そうです！回転状態（0-3）によって、2つ目のぷよが軸ぷよの上下左右のどこにあるかが決まります。</p>
<h3 id="_23">実装: ぷよペアの定義<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/PuyoPair.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Domain</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="sd">/// ぷよペア</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Puyo1Color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">Puyo2Color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w">  </span><span class="c1">// 2つ目のぷよ</span>
<span class="w">    </span><span class="n">Rotation</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w">          </span><span class="c1">// 0: 上, 1: 右, 2: 下, 3: 左</span>
<span class="o">}</span>

<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// ぷよペアを作成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">create</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">color1</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">color2</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">rotation</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="w">            </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span>
<span class="w">            </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color1</span>
<span class="w">            </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color2</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotation</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// ぷよペアの各ぷよの位置を取得</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">getPositions</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">pos1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">pos2</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w">      </span><span class="c1">// 上</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="o">)</span><span class="w">      </span><span class="c1">// 右</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w">      </span><span class="c1">// 下</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="o">)</span><span class="w">      </span><span class="c1">// 左</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w">      </span><span class="c1">// デフォルトは上</span>
<span class="w">        </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span>

<span class="w">    </span><span class="sd">/// ランダムなぷよペアを生成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">createRandom</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">rotation</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="n">Random</span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[|</span><span class="w"> </span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">|]</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">color1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="o">.[</span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="o">)]</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">color2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="o">.[</span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="o">)]</span>
<span class="w">        </span><span class="n">create</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">color1</span><span class="w"> </span><span class="n">color2</span><span class="w"> </span><span class="n">rotation</span>
</code></pre></div>
<p>「パターンマッチングで回転状態に応じた位置を計算しているんですね！」そうです！F#のパターンマッチングを使うことで、回転状態に応じた処理を明確に書けます。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="elmish-model">Elmish Model の定義<a class="headerlink" href="#elmish-model" title="Permanent link">&para;</a></h3>
<p>「ドメインの型ができたので、次はElmishのModelを定義しましょう！」そうですね。ゲームの状態を表すModelを定義します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Model.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Elmish</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>

<span class="sd">/// ゲームの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameStatus</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">NotStarted</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span>

<span class="sd">/// ゲームのModel</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span>
<span class="w">    </span><span class="n">CurrentPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">NextPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Level</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">GameTime</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">LastChainCount</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Status</span><span class="o">:</span><span class="w"> </span><span class="n">GameStatus</span>
<span class="o">}</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// 初期状態</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">            </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">            </span><span class="n">NextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">GameTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">LastChainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span>
<span class="w">        </span><span class="o">}</span>
</code></pre></div>
<p>「<code>option</code>型を使っているのはなぜですか？」良い質問ですね！<code>option</code>型は「値があるかもしれないし、ないかもしれない」を表現する型です。ゲーム開始前や、ぷよが固定された直後は<code>CurrentPiece</code>が<code>None</code>になり、ぷよが落下中は<code>Some puyoPair</code>になります。これにより、nullチェックが不要になり、安全にコードが書けます。</p>
<h3 id="elmish-message">Elmish Message の定義<a class="headerlink" href="#elmish-message" title="Permanent link">&para;</a></h3>
<p>「次はMessageを定義しましょう！」はい、ユーザーの操作やゲームイベントを表すMessageを定義します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Elmish</span>

<span class="sd">/// ゲームのメッセージ</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">ResetGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">HardDrop</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameStep</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">TimeStep</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">SpawnNewPiece</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">FixPiece</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">ProcessChain</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">CheckGameOver</span>
</code></pre></div>
<p>「たくさんのメッセージがありますね！」そうですね。それぞれのメッセージが特定のイベントや操作を表しています。今回のイテレーションでは、まず<code>StartGame</code>だけを実装していきます。</p>
<h3 id="update">Update 関数の実装<a class="headerlink" href="#update" title="Permanent link">&para;</a></h3>
<p>「Update関数を実装しましょう！」はい、まずは基本的な部分だけを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（続き）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Update</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="w">    </span><span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>

<span class="w">    </span><span class="sd">/// Update 関数</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="o">(</span><span class="n">message</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Cmd</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">firstPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="o">{</span>
<span class="w">                </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">                    </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">firstPiece</span>
<span class="w">                    </span><span class="n">NextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                    </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                    </span><span class="n">GameTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">            </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">ResetGame</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「<code>with</code>キーワードを使っているのはなぜですか？」F#のレコード型には「レコードコピー式」という機能があり、<code>{ model with Score = 0 }</code>のように書くことで、一部のフィールドだけを変更した新しいレコードを作成できます。元の<code>model</code>は変更されません。</p>
<h3 id="xaml-view">XAML View の実装<a class="headerlink" href="#xaml-view" title="Permanent link">&para;</a></h3>
<p>「最後にViewを実装しましょう！」はい、WPFではXAMLでUIを定義します。</p>
<h4 id="mainwindowxaml">MainWindow.xaml<a class="headerlink" href="#mainwindowxaml" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- src/PuyoPuyo.WPF/MainWindow.xaml --&gt;</span>
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよゲーム&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;600&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.Resources&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- ボーダースタイル --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Style</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;BoardBorderStyle&quot;</span><span class="w"> </span><span class="na">TargetType=</span><span class="s">&quot;Border&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;BorderBrush&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;#333333&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;BorderThickness&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;2&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Background&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;#F0F0F0&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Margin&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;20,0,20,0&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Style&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- セルスタイル --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Style</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;CellStyle&quot;</span><span class="w"> </span><span class="na">TargetType=</span><span class="s">&quot;Border&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Width&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;30&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Height&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;30&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;BorderBrush&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;#DDDDDD&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;BorderThickness&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Style&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ボタンスタイル --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Style</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;GameButtonStyle&quot;</span><span class="w"> </span><span class="na">TargetType=</span><span class="s">&quot;Button&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Width&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;120&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Height&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;30&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Margin&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;FontSize&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;16&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Cursor&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;Hand&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Style&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.Resources&gt;</span>

<span class="w">    </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;Grid.RowDefinitions&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Grid.RowDefinitions&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- タイトル --&gt;</span>
<span class="w">        </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;0&quot;</span>
<span class="w">                   </span><span class="na">Text=</span><span class="s">&quot;ぷよぷよゲーム&quot;</span>
<span class="w">                   </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span>
<span class="w">                   </span><span class="na">FontFamily=</span><span class="s">&quot;Arial&quot;</span>
<span class="w">                   </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                   </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">/&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲームボード --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Style=</span><span class="s">&quot;{StaticResource BoardBorderStyle}&quot;</span>
<span class="w">                </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;ItemsControl</span><span class="w"> </span><span class="na">ItemsSource=</span><span class="s">&quot;{Binding BoardRows}&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;ItemsControl.ItemTemplate&gt;</span>
<span class="w">                    </span><span class="nt">&lt;DataTemplate&gt;</span>
<span class="w">                        </span><span class="nt">&lt;ItemsControl</span><span class="w"> </span><span class="na">ItemsSource=</span><span class="s">&quot;{Binding}&quot;</span><span class="nt">&gt;</span>
<span class="w">                            </span><span class="nt">&lt;ItemsControl.ItemsPanel&gt;</span>
<span class="w">                                </span><span class="nt">&lt;ItemsPanelTemplate&gt;</span>
<span class="w">                                    </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Horizontal&quot;</span><span class="nt">/&gt;</span>
<span class="w">                                </span><span class="nt">&lt;/ItemsPanelTemplate&gt;</span>
<span class="w">                            </span><span class="nt">&lt;/ItemsControl.ItemsPanel&gt;</span>
<span class="w">                            </span><span class="nt">&lt;ItemsControl.ItemTemplate&gt;</span>
<span class="w">                                </span><span class="nt">&lt;DataTemplate&gt;</span>
<span class="w">                                    </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Style=</span><span class="s">&quot;{StaticResource CellStyle}&quot;</span>
<span class="w">                                            </span><span class="na">Background=</span><span class="s">&quot;{Binding Color}&quot;</span><span class="nt">/&gt;</span>
<span class="w">                                </span><span class="nt">&lt;/DataTemplate&gt;</span>
<span class="w">                            </span><span class="nt">&lt;/ItemsControl.ItemTemplate&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/ItemsControl&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/DataTemplate&gt;</span>
<span class="w">                </span><span class="nt">&lt;/ItemsControl.ItemTemplate&gt;</span>
<span class="w">            </span><span class="nt">&lt;/ItemsControl&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- コントロール --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;2&quot;</span>
<span class="w">                    </span><span class="na">Orientation=</span><span class="s">&quot;Vertical&quot;</span>
<span class="w">                    </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                    </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;ゲーム開始&quot;</span>
<span class="w">                    </span><span class="na">Command=</span><span class="s">&quot;{Binding StartGame}&quot;</span>
<span class="w">                    </span><span class="na">Visibility=</span><span class="s">&quot;{Binding StartButtonVisibility}&quot;</span>
<span class="w">                    </span><span class="na">Style=</span><span class="s">&quot;{StaticResource GameButtonStyle}&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;リセット&quot;</span>
<span class="w">                    </span><span class="na">Command=</span><span class="s">&quot;{Binding ResetGame}&quot;</span>
<span class="w">                    </span><span class="na">Visibility=</span><span class="s">&quot;{Binding ResetButtonVisibility}&quot;</span>
<span class="w">                    </span><span class="na">Style=</span><span class="s">&quot;{StaticResource GameButtonStyle}&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>「XAMLではCSSの代わりにResourcesでスタイルを定義するんですね！」そうです！XAMLでは<code>&lt;Window.Resources&gt;</code>セクションでスタイルを定義し、<code>Style="{StaticResource ...}"</code>で参照します。</p>
<h4 id="elmish-bindings">Elmish Bindings の実装<a class="headerlink" href="#elmish-bindings" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Bindings.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Elmish.Bindings</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.WPF</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Elmish.Model</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Elmish.Update</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>

<span class="sd">/// セルの色を文字列に変換</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">cellToColor</span><span class="w"> </span><span class="o">(</span><span class="n">cell</span><span class="o">:</span><span class="w"> </span><span class="n">Cell</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#CCCCCC&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Puyo</span><span class="p">.</span><span class="n">toHex</span><span class="w"> </span><span class="n">color</span>

<span class="sd">/// ボードを表示用の行データに変換</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">boardToRows</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">currentPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ボードのコピーを作成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">displayBoard</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="o">))</span>

<span class="w">    </span><span class="c1">// 現在のぷよを重ねて表示</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">currentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">piece</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x1</span><span class="o">,</span><span class="w"> </span><span class="n">y1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x2</span><span class="o">,</span><span class="w"> </span><span class="n">y2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">displayBoard</span><span class="o">.[</span><span class="n">y1</span><span class="o">].[</span><span class="n">x1</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="n">piece</span><span class="o">.</span><span class="n">Puyo1Color</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">displayBoard</span><span class="o">.[</span><span class="n">y2</span><span class="o">].[</span><span class="n">x2</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="n">piece</span><span class="o">.</span><span class="n">Puyo2Color</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>

<span class="w">    </span><span class="c1">// 匿名レコードに変換（WPFバインディング用）</span>
<span class="w">    </span><span class="n">displayBoard</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">row</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="o">{|</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cellToColor</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">|}))</span>

<span class="sd">/// バインディング定義</span>
<span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Binding</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="s">&quot;BoardRows&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">boardToRows</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;StartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">StartGame</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;ResetGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ResetGame</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;StartButtonVisibility&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s">&quot;Visible&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s">&quot;Collapsed&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;ResetButtonVisibility&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s">&quot;Visible&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s">&quot;Collapsed&quot;</span><span class="o">)</span>
<span class="o">]</span>
</code></pre></div>
<p>「Bindingsでボードとぷよペアをマージして表示用データを作っているんですね！」そうです！Bolero版の<code>viewBoard</code>関数と同じロジックを、WPF用のバインディング関数として実装しています。</p>
<h4 id="_24">アプリケーションのエントリーポイント<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/App.xaml.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="n">PuyoPuyo</span>

<span class="k">open</span><span class="w"> </span><span class="nn">System.Windows</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.WPF</span>

<span class="k">type</span><span class="w"> </span><span class="nc">App</span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">inherit</span><span class="w"> </span><span class="n">Application</span><span class="bp">()</span>

<span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="nf">OnStartup</span><span class="o">(</span><span class="n">e</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">base</span><span class="o">.</span><span class="n">OnStartup</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">mainWindow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MainWindow</span><span class="bp">()</span>

<span class="w">        </span><span class="nn">Program</span><span class="p">.</span><span class="n">mkSimple</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="nn">Elmish</span><span class="p">.</span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="nn">Elmish</span><span class="p">.</span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="nn">Elmish</span><span class="p">.</span><span class="nn">Bindings</span><span class="p">.</span><span class="n">bindings</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">runElmishLoop</span><span class="w"> </span><span class="n">mainWindow</span>
</code></pre></div>
<p>「<code>Program.mkSimple</code>でElmishを起動するんですね！」そうです！Elmish.WPFでは、<code>Program.mkSimple</code>に初期化関数、更新関数、バインディング関数を渡すことでElmishループを開始します。</p>
<h3 id="_25">動作確認<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、アプリケーションを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>run<span class="w"> </span>--project<span class="w"> </span>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj
</code></pre></div>
<p>または Cake タスクで：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Run
</code></pre></div>
<p>WPFウィンドウが開き、「ゲーム開始」ボタンが表示され、クリックするとボードとぷよが表示されるはずです！</p>
<h3 id="_26">コミット<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement basic game board and puyo display (WPF)</span>

<span class="s2">- Add PuyoColor discriminated union (Red, Green, Blue, Yellow)</span>
<span class="s2">- Add Board type with create, getCell, setCell functions</span>
<span class="s2">- Add PuyoPair type with rotation support</span>
<span class="s2">- Add Elmish Model and Message types</span>
<span class="s2">- Add basic Update function (StartGame, ResetGame)</span>
<span class="s2">- Add XAML View with board rendering</span>
<span class="s2">- Add Elmish.WPF Bindings with board-to-rows conversion</span>
<span class="s2">- Add XAML styles for game elements</span>
<span class="s2">- All tests passing (11 tests)&quot;</span>
</code></pre></div>
<h3 id="1_1">イテレーション1のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li>
<p><strong>ドメイン層</strong></p>
<ul>
<li><code>PuyoColor</code>：判別共用体を使った型安全な色定義</li>
<li><code>Cell</code>：セルの状態（空 or 色付き）</li>
<li><code>Board</code>：ゲームボード（イミュータブルな操作）</li>
<li><code>PuyoPair</code>：2つのぷよのペア（回転状態を含む）</li>
</ul>
</li>
<li>
<p><strong>Elmish層</strong></p>
<ul>
<li><code>Model</code>：ゲーム状態の定義（Board、CurrentPiece、Scoreなど）</li>
<li><code>Message</code>：イベントの定義（StartGame、ResetGameなど）</li>
<li><code>Update</code>：状態遷移ロジック</li>
</ul>
</li>
<li>
<p><strong>View層（WPF固有）</strong></p>
<ul>
<li>XAML によるUIの宣言的定義</li>
<li>Stylesによるスタイリング（CSSの代わり）</li>
<li>ItemsControl によるボードの描画</li>
<li>Command バインディングによるイベント処理</li>
</ul>
</li>
<li>
<p><strong>Bindings層（WPF固有）</strong></p>
<ul>
<li><code>boardToRows</code>関数：ボードと現在のぷよを表示用データに変換</li>
<li><code>cellToColor</code>関数：セルの色を16進数文字列に変換</li>
<li><code>Binding.oneWay</code>：データの一方向バインディング</li>
<li><code>Binding.cmd</code>：コマンドバインディング</li>
</ul>
</li>
<li>
<p><strong>TDDサイクルの実践</strong></p>
<ul>
<li>Red：失敗するテストを先に作成</li>
<li>Green：テストを通す実装</li>
<li>Refactor：コードの整理</li>
</ul>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>判別共用体による型安全な定義</li>
<li>イミュータブルなデータ構造</li>
<li>レコードコピー式（<code>with</code>キーワード）</li>
<li>Option型による安全なnull処理</li>
<li>パターンマッチング</li>
<li>Elmishの基本（Model-View-Update）</li>
<li><strong>WPF固有</strong>: XAMLによる宣言的UI定義</li>
<li><strong>WPF固有</strong>: データバインディング</li>
<li><strong>WPF固有</strong>: XAML Resourcesによるスタイル定義</li>
</ul>
</li>
</ol>
<p>次のイテレーションでは、ぷよの移動機能を実装していきます。</p>
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>「ゲームが開始できるようになったので、次は何をしますか？」次は、ぷよを動かせるようにしましょう！プレイヤーがキーボードでぷよを左右に移動できる機能を実装します。</p>
<h3 id="_27">ユーザーストーリー<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「左右に移動するって、具体的にどうやるんですか？」良い質問ですね！キーボードの左右矢印キーを押すと、ぷよが左右に1マスずつ移動します。ただし、壁やボードの端には移動できません。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> キー入力を検出する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを左に移動する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを右に移動する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 移動時の境界チェックを実装する（壁を越えない）</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update関数にキー入力処理を組み込む</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<h3 id="_28">テスト: キー入力の検出<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>「最初は何からテストしますか？」まずは、キー入力を検出する機能からテストしましょう。WPFではキーボードイベントをどう扱うか考える必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/GameLogicTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Domain.GameLogicTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを左に移動できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Left</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">movedPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="n">movedPair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;移動できるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを右に移動できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Right</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">movedPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="n">movedPair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;移動できるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``左端では左に移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Left</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``右端では右に移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Right</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>
</code></pre></div>
<p>「TypeScript版と違って、キー入力の検出をテストしていませんね？」そうです！WPFでは、キー入力はView層で処理し、Messageとしてdispatchします。ドメイン層では、純粋な移動ロジックだけをテストします。これがElmishアーキテクチャの利点で、UIとビジネスロジックが完全に分離されます。</p>
<h3 id="_29">実装: 移動ロジック<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。まず、移動方向を表す型と移動ロジックを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/GameLogic.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Domain</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>

<span class="sd">/// 移動方向</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Direction</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span>

<span class="k">module</span><span class="w"> </span><span class="nn">GameLogic</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// ぷよペアが指定位置に配置可能かチェック</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">isValidPosition</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Empty</span>

<span class="w">    </span><span class="sd">/// ぷよペアが配置可能かチェック</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">canPlacePuyoPair</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x1</span><span class="o">,</span><span class="w"> </span><span class="n">y1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x2</span><span class="o">,</span><span class="w"> </span><span class="n">y2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>
<span class="w">        </span><span class="n">isValidPosition</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isValidPosition</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="n">y2</span>

<span class="w">    </span><span class="sd">/// ぷよペアを指定方向に移動（可能な場合のみ）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">tryMovePuyoPair</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">direction</span><span class="o">:</span><span class="w"> </span><span class="n">Direction</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">dx</span><span class="o">,</span><span class="w"> </span><span class="n">dy</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dx</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">None</span>
</code></pre></div>
<p>「<code>tryMovePuyoPair</code>が<code>option</code>型を返しているのはなぜですか？」良い質問ですね！移動できる場合は<code>Some newPair</code>を返し、移動できない場合（壁や障害物がある）は<code>None</code>を返します。これにより、呼び出し側で移動の成功/失敗を安全に判定できます。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="update_1">Update 関数の拡張<a class="headerlink" href="#update_1" title="Permanent link">&para;</a></h3>
<p>「ドメインロジックができたので、次はElmishのUpdate関数を拡張しましょう！」はい、MoveLeftとMoveRightメッセージを処理できるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（Update関数の続き）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「パターンマッチングを使って、安全に処理しているんですね！」そうです！以下の点をチェックしています：</p>
<ol>
<li><code>when model.Status = Playing</code>：ゲーム中のみ移動可能</li>
<li><code>match model.CurrentPiece</code>：現在のぷよが存在するか</li>
<li><code>match GameLogic.tryMovePuyoPair</code>：移動が成功したか</li>
</ol>
<p>すべての条件が満たされた場合のみ、新しい位置でModelを更新します。</p>
<h3 id="view">View の拡張<a class="headerlink" href="#view" title="Permanent link">&para;</a></h3>
<p>「次はViewでキーボード入力を受け取るようにしましょう！」はい、キーボードイベントハンドラを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（viewの更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">GameView</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// キーボードイベントハンドラ</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">handleKeyDown</span><span class="w"> </span><span class="o">(</span><span class="n">dispatch</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="w"> </span><span class="nn">Microsoft</span><span class="p">.</span><span class="nn">AspNetCore</span><span class="p">.</span><span class="nn">Components</span><span class="p">.</span><span class="nn">Web</span><span class="p">.</span><span class="n">KeyboardEventArgs</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">Key</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>

<span class="w">    </span><span class="sd">/// メインView</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">dispatch</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">attr</span><span class="o">.</span><span class="n">classes</span><span class="w"> </span><span class="o">[</span><span class="s">&quot;game-container&quot;</span><span class="o">]</span>
<span class="w">            </span><span class="n">attr</span><span class="o">.</span><span class="n">tabindex</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// キーボードフォーカスを受け取れるようにする</span>
<span class="w">            </span><span class="n">on</span><span class="o">.</span><span class="n">keydown</span><span class="w"> </span><span class="o">(</span><span class="n">handleKeyDown</span><span class="w"> </span><span class="n">dispatch</span><span class="o">)</span>
<span class="w">        </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">h1</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよゲーム&quot;</span><span class="o">]</span>

<span class="w">            </span><span class="n">viewBoard</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span>

<span class="w">            </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="n">attr</span><span class="o">.</span><span class="n">classes</span><span class="w"> </span><span class="o">[</span><span class="s">&quot;game-controls&quot;</span><span class="o">]]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">NotStarted</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">button</span><span class="w"> </span><span class="o">[</span>
<span class="w">                        </span><span class="n">on</span><span class="o">.</span><span class="n">click</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">StartGame</span><span class="o">)</span>
<span class="w">                    </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;ゲーム開始&quot;</span><span class="o">]</span>

<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">div</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                        </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;矢印キー: 左右移動&quot;</span><span class="o">]</span>
<span class="w">                        </span><span class="n">button</span><span class="w"> </span><span class="o">[</span>
<span class="w">                            </span><span class="n">on</span><span class="o">.</span><span class="n">click</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">ResetGame</span><span class="o">)</span>
<span class="w">                        </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;リセット&quot;</span><span class="o">]</span>
<span class="w">                    </span><span class="o">]</span>

<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">div</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                        </span><span class="n">h2</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;ゲームオーバー&quot;</span><span class="o">]</span>
<span class="w">                        </span><span class="n">button</span><span class="w"> </span><span class="o">[</span>
<span class="w">                            </span><span class="n">on</span><span class="o">.</span><span class="n">click</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">ResetGame</span><span class="o">)</span>
<span class="w">                        </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;もう一度プレイ&quot;</span><span class="o">]</span>
<span class="w">                    </span><span class="o">]</span>
<span class="w">            </span><span class="o">]</span>
<span class="w">        </span><span class="o">]</span>
</code></pre></div>
<p>「<code>attr.tabindex 0</code>は何ですか？」これは、HTML要素がキーボードフォーカスを受け取れるようにする属性です。通常、<code>div</code>要素はキーボードイベントを受け取れませんが、<code>tabindex</code>を設定することで可能になります。</p>
<h3 id="update_2">テスト: Update関数の統合テスト<a class="headerlink" href="#update_2" title="Permanent link">&para;</a></h3>
<p>「Update関数の動作もテストしたいです！」良いですね！Elmishの統合テストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Elmish.UpdateTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``MoveLeftメッセージでぷよが左に移動する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``MoveRightメッセージでぷよが右に移動する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``左端では左に移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 位置が変わらない</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ゲーム中でない場合は移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1">// 位置が変わらない</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>
</code></pre></div>
<p>「Elmish層のテストでは、Modelの状態遷移を確認しているんですね！」そうです！これにより、以下の点を確認できます：</p>
<ol>
<li>メッセージを受け取ったときの正しい状態遷移</li>
<li>ゲーム状態（Playing/NotStarted）による動作の違い</li>
<li>境界条件での動作</li>
</ol>
<h3 id="_30">動作確認<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、開発サーバーを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch
</code></pre></div>
<p>ブラウザで画面をクリックしてフォーカスを当てた後、左右矢印キーを押すとぷよが左右に移動するはずです！</p>
<h3 id="_31">コミット<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement puyo movement with keyboard input</span>

<span class="s2">- Add Direction type (Left, Right, Down)</span>
<span class="s2">- Add GameLogic module with tryMovePuyoPair function</span>
<span class="s2">- Add boundary checking (canPlacePuyoPair)</span>
<span class="s2">- Update Elmish Update function for MoveLeft/MoveRight</span>
<span class="s2">- Add keyboard event handler in View</span>
<span class="s2">- Add tabindex for keyboard focus</span>
<span class="s2">- Add unit tests for movement logic (4 tests)</span>
<span class="s2">- Add integration tests for Update function (4 tests)</span>
<span class="s2">- All tests passing (19 tests)&quot;</span>
</code></pre></div>
<h3 id="2_1">イテレーション2のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li>
<p><strong>ドメイン層</strong></p>
<ul>
<li><code>Direction</code> 判別共用体（Left, Right, Down）</li>
<li><code>GameLogic</code> モジュール：<ul>
<li><code>isValidPosition</code>：位置の有効性チェック</li>
<li><code>canPlacePuyoPair</code>：ぷよペアの配置可能性チェック</li>
<li><code>tryMovePuyoPair</code>：移動試行（Option型を返す）</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Elmish層</strong></p>
<ul>
<li><code>MoveLeft</code> / <code>MoveRight</code> メッセージの処理</li>
<li>ゲーム状態のガード（<code>when model.Status = Playing</code>）</li>
<li>パターンマッチによる安全な状態遷移</li>
</ul>
</li>
<li>
<p><strong>View層</strong></p>
<ul>
<li>キーボードイベントハンドラ（<code>handleKeyDown</code>）</li>
<li><code>attr.tabindex</code> でフォーカス可能に</li>
<li>キー操作説明の追加</li>
</ul>
</li>
<li>
<p><strong>テスト</strong></p>
<ul>
<li>ドメインロジックのテスト（4テスト）<ul>
<li>左右移動の成功ケース</li>
<li>境界でのエラーケース</li>
</ul>
</li>
<li>Elmish統合テスト（4テスト）<ul>
<li>メッセージによる状態遷移</li>
<li>ゲーム状態による動作制御</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>Option型による安全なエラーハンドリング</li>
<li>関数型プログラミングの純粋関数（副作用なし）</li>
<li>Elmishにおける関心の分離（Domain/Elmish/View）</li>
<li>パターンマッチングによる網羅的な処理</li>
<li><code>when</code>ガードによる条件付きパターンマッチ</li>
<li>タプルによる座標の表現</li>
</ul>
</li>
<li>
<p><strong>TypeScript版との違い</strong></p>
<ul>
<li>キー入力検出をViewで処理（Domainは純粋関数）</li>
<li>private フィールドアクセスの代わりにOption型</li>
<li>イベントハンドラのバインド不要（関数型）</li>
<li>nullチェックの代わりにパターンマッチ</li>
</ul>
</li>
</ol>
<p>次のイテレーションでは、ぷよの回転機能を実装していきます。</p>
<h2 id="3">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_32">ユーザーストーリー<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、この2つのぷよの相対的な位置関係を変えることです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの回転処理を実装する（時計回り）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 回転可能かどうかのチェックを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 壁キック処理を実装する（壁際での回転を可能にする）</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update関数に回転処理を組み込む</li>
<li class="task-list-item"><input type="checkbox" disabled/> View にキー入力を追加する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_33">テスト: ぷよの回転<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは基本的な回転機能のテストから書いていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/PuyoPairTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``時計回りに回転すると回転状態が1増える``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態3から時計回りに回転すると0に戻る``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">3</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転すると2つ目のぷよの位置が変わる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 回転状態0（上）</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span><span class="w">  </span><span class="c1">// 回転状態1（右）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">rotated</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよは変わらない</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは右に</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下の点を確認しています：</p>
<ol>
<li>時計回りに回転すると、回転状態が1増えるか</li>
<li>回転状態が最大値（3）から回転すると、0に戻るか（循環するか）</li>
<li>回転によって2つ目のぷよの位置が正しく変わるか</li>
</ol>
<p>「回転状態って何ですか？」回転状態は、ぷよの向きを表す値です。0から3までの値を取り、それぞれ以下の状態を表します：
- 0: 2つ目のぷよが上にある状態
- 1: 2つ目のぷよが右にある状態
- 2: 2つ目のぷよが下にある状態
- 3: 2つ目のぷよが左にある状態</p>
<h3 id="_34">実装: ぷよの回転<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを回転させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/PuyoPair.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// 時計回りに回転</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotateClockwise</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// 反時計回りに回転</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotateCounterClockwise</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「シンプルですね！」そうです！回転処理自体はとてもシンプルです。<code>rotateClockwise</code>では回転状態を1増やし、<code>rotateCounterClockwise</code>では回転状態を3増やしています（これは1減らすのと同じ効果があります）。</p>
<p>「なぜ反時計回りの場合は3を足すんですか？」鋭い質問ですね！F#でも、負の数の剰余演算の結果が負になることがあります。例えば、<code>(0 - 1) % 4</code>は<code>-1</code>になります。しかし、私たちは常に0から3の範囲の値が欲しいので、3を足して（これは1を引くのと同じ効果）から4で割ることで、確実に正の値の範囲内に収めています。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="_35">テスト: 壁キック処理<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>「壁キック処理のテストはどうやって書くんですか？」壁キック処理は、ぷよが壁際にあるときに回転すると自動的に位置を調整する機能です。これをテストするには、ぷよを壁際に配置し、回転させたときに適切に位置が調整されるかを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/GameLogicTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``右端で回転すると左にキックされる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 右端、回転状態0（上）</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 回転成功</span>
<span class="w">        </span><span class="n">rotated</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="c1">// 左に1マスキック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;回転できるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``左端で回転すると右にキックされる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 左端、回転状態0（上）</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">}</span><span class="w">  </span><span class="c1">// 左向き</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">rotated</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">kicked</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">kicked</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 右に1マスキック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;回転できるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``壁キックできない場合は回転しない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="c1">// 右端にぷよを配置（壁キックできない状況を作る）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li>右端にいるときに回転すると、左に1マス移動して回転するか</li>
<li>左端にいるときに回転すると、右に1マス移動して回転するか</li>
<li>壁キックもできない場合は、回転が失敗するか</li>
</ol>
<h3 id="_36">実装: 壁キック処理<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、壁キック処理を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/GameLogic.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">GameLogic</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// ぷよペアを回転（壁キック処理付き）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">tryRotatePuyoPair</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// 通常回転を試す</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">Some</span><span class="w"> </span><span class="n">rotated</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 壁キックを試す（左に1マス）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">kickedLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotated</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">kickedLeft</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="n">Some</span><span class="w"> </span><span class="n">kickedLeft</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">// 壁キックを試す（右に1マス）</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">kickedRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotated</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">kickedRight</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="n">Some</span><span class="w"> </span><span class="n">kickedRight</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// 回転できない</span>
<span class="w">                    </span><span class="n">None</span>
</code></pre></div>
<p>「段階的にチェックしているんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li>まず通常の回転を試す</li>
<li>配置できない場合、左に1マスずらして（壁キック）試す</li>
<li>それでもダメなら右に1マスずらして試す</li>
<li>すべて失敗したら<code>None</code>を返す</li>
</ol>
<p>「F#のパイプライン演算子を使うともっと綺麗に書けませんか？」良い質問ですね！確かに、関数型のスタイルで書き直すこともできます。でも、今回は可読性を優先して、段階的なチェックを明示的に書いています。</p>
<h3 id="update_3">Update 関数の拡張<a class="headerlink" href="#update_3" title="Permanent link">&para;</a></h3>
<p>「ドメインロジックができたので、次はElmishのUpdate関数を拡張しましょう！」はい、Rotateメッセージを処理できるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（Update関数の続き）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「移動の処理と同じパターンですね！」そうです！以下の点をチェックしています：</p>
<ol>
<li>ゲーム中（Playing）のみ回転可能</li>
<li>現在のぷよが存在するか</li>
<li>回転が成功したか（壁キック含む）</li>
</ol>
<h3 id="view_1">View の拡張<a class="headerlink" href="#view_1" title="Permanent link">&para;</a></h3>
<p>「次はViewでキーボード入力を受け取るようにしましょう！」はい、上矢印キーで回転できるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（handleKeyDownの更新）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">handleKeyDown</span><span class="w"> </span><span class="o">(</span><span class="n">dispatch</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="w"> </span><span class="nn">Microsoft</span><span class="p">.</span><span class="nn">AspNetCore</span><span class="p">.</span><span class="nn">Components</span><span class="p">.</span><span class="nn">Web</span><span class="p">.</span><span class="n">KeyboardEventArgs</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">Key</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>
</code></pre></div>
<p>「シンプルですね！」そうです！上矢印キーが押されたら<code>Rotate</code>メッセージをdispatchするだけです。</p>
<p>操作説明も更新しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（viewの更新）</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">div</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                        </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;← →: 左右移動&quot;</span><span class="o">]</span>
<span class="w">                        </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↑: 回転&quot;</span><span class="o">]</span>
<span class="w">                        </span><span class="n">button</span><span class="w"> </span><span class="o">[</span>
<span class="w">                            </span><span class="n">on</span><span class="o">.</span><span class="n">click</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">ResetGame</span><span class="o">)</span>
<span class="w">                        </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;リセット&quot;</span><span class="o">]</span>
<span class="w">                    </span><span class="o">]</span>
</code></pre></div>
<h3 id="update_4">テスト: Update関数の統合テスト<a class="headerlink" href="#update_4" title="Permanent link">&para;</a></h3>
<p>「Update関数の回転処理もテストしましょう！」はい、Elmishの統合テストを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``Rotateメッセージでぷよが回転する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転時に壁キックが発生する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 右端</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="c1">// 左にキック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転できない場合は状態が変わらない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="o">;</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 回転していない</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="c1">// 位置も変わらない</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>
</code></pre></div>
<h3 id="_37">動作確認<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、開発サーバーを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch
</code></pre></div>
<p>ブラウザで画面をクリックしてフォーカスを当てた後、上矢印キーを押すとぷよが回転し、壁際では自動的に位置が調整されるはずです！</p>
<h3 id="_38">コミット<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement puyo rotation with wall kick</span>

<span class="s2">- Add rotateClockwise and rotateCounterClockwise to PuyoPair</span>
<span class="s2">- Add tryRotatePuyoPair with wall kick logic in GameLogic</span>
<span class="s2">- Update Elmish Update function for Rotate message</span>
<span class="s2">- Add ArrowUp key handler for rotation</span>
<span class="s2">- Add unit tests for rotation logic (3 tests)</span>
<span class="s2">- Add unit tests for wall kick (3 tests)</span>
<span class="s2">- Add integration tests for Update function (3 tests)</span>
<span class="s2">- All tests passing (28 tests)&quot;</span>
</code></pre></div>
<h3 id="3_1">イテレーション3のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li>
<p><strong>ドメイン層</strong></p>
<ul>
<li><code>PuyoPair.rotateClockwise</code>：時計回り回転（回転状態を+1）</li>
<li><code>PuyoPair.rotateCounterClockwise</code>：反時計回り回転（回転状態を+3）</li>
<li><code>GameLogic.tryRotatePuyoPair</code>：回転試行（壁キック処理付き）</li>
<li>壁キックロジック：左、右の順に1マスずらして配置可能性をチェック</li>
</ul>
</li>
<li>
<p><strong>Elmish層</strong></p>
<ul>
<li><code>Rotate</code> メッセージの処理</li>
<li>回転失敗時の状態維持</li>
<li>パターンマッチによる安全な処理</li>
</ul>
</li>
<li>
<p><strong>View層</strong></p>
<ul>
<li>上矢印キーで回転</li>
<li>操作説明の更新</li>
</ul>
</li>
<li>
<p><strong>テスト</strong></p>
<ul>
<li>回転ロジックの単体テスト（3テスト）<ul>
<li>通常回転</li>
<li>回転状態の循環</li>
<li>位置の変化</li>
</ul>
</li>
<li>壁キックのテスト（3テスト）<ul>
<li>右端での左キック</li>
<li>左端での右キック</li>
<li>キック不可の場合</li>
</ul>
</li>
<li>Elmish統合テスト（3テスト）<ul>
<li>通常回転</li>
<li>壁キック発生</li>
<li>回転失敗</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>剰余演算による循環処理（<code>(n + k) % m</code>）</li>
<li>段階的なフォールバック処理（通常→左キック→右キック）</li>
<li>Option型による連続的な試行</li>
<li>イミュータブルなレコード更新（<code>{ pair with ... }</code>）</li>
</ul>
</li>
<li>
<p><strong>壁キック処理の工夫</strong></p>
<ul>
<li>まず通常回転を試す</li>
<li>失敗したら左に1マスずらす</li>
<li>さらに失敗したら右に1マスずらす</li>
<li>すべて失敗したら<code>None</code>を返す</li>
<li>これにより、プレイヤーの意図を最大限尊重</li>
</ul>
</li>
<li>
<p><strong>TypeScript版との違い</strong></p>
<ul>
<li>壁キック処理を<code>tryRotatePuyoPair</code>に統合</li>
<li>Option型による段階的な試行</li>
<li>重複コードなし（関数型のコンポジション）</li>
</ul>
</li>
</ol>
<p>次のイテレーションでは、ぷよの自由落下機能を実装していきます。</p>
<h2 id="4">イテレーション4: ぷよの自由落下の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよって自動で落ちていくよね？」そうですね！ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきます。今回は、その「自由落下」機能を実装していきましょう！</p>
<h3 id="_39">ユーザーストーリー<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとしてぷよを自由落下させることができる</p>
</blockquote>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 自動落下のタイマーメッセージを追加する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 落下可能判定を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 着地処理を実装する（ぷよをボードに固定）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 新しいぷよを生成する処理を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> タイマーを使った定期的な落下処理を組み込む</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<h3 id="_40">テスト: 落下可能判定<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>「最初は何からテストしますか？」まずは、ぷよが下に移動できるかを判定する機能からテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/GameLogicTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを下に移動できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">movedPair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;下に移動できるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``下端では下に移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 回転状態0（上）なので2つ目のぷよは y=10</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``下にぷよがある場合は移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span><span class="w">  </span><span class="c1">// 下に障害物</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>
</code></pre></div>
<p>「これらのテストは既に<code>tryMovePuyoPair</code>で実装済みですね！」そうです！イテレーション2で<code>Direction.Down</code>を定義していたので、下方向の移動も既に対応済みです。テストを実行して確認しましょう。</p>
<h3 id="_41">テスト: ぷよの固定<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>「次はぷよをボードに固定する処理をテストしましょう！」はい、ぷよが着地したときの処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアをボードに固定できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x1</span><span class="o">,</span><span class="w"> </span><span class="n">y1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x2</span><span class="o">,</span><span class="w"> </span><span class="n">y2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを固定しても元のボードは変更されない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x1</span><span class="o">,</span><span class="w"> </span><span class="n">y1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span><span class="w">  </span><span class="c1">// 元のボードは空のまま</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span><span class="w">  </span><span class="c1">// 新しいボードには固定</span>
</code></pre></div>
<p>「イミュータブルなデータ構造のテストですね！」そうです！F#では、<code>fixPuyoPair</code>は新しいボードを返し、元のボードは変更されません。</p>
<h3 id="_42">実装: ぷよの固定<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// ぷよペアをボードに固定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">fixPuyoPair</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x1</span><span class="o">,</span><span class="w"> </span><span class="n">y1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x2</span><span class="o">,</span><span class="w"> </span><span class="n">y2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>

<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCell</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Puyo1Color</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCell</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Puyo2Color</span><span class="o">)</span>
</code></pre></div>
<p>「パイプライン演算子を使って連鎖的に処理していますね！」そうです！<code>board</code>に対して、まず1つ目のぷよを配置し、その結果に対して2つ目のぷよを配置しています。これが関数型プログラミングのスタイルです。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="elmish-subscription">Elmish Subscription によるタイマー<a class="headerlink" href="#elmish-subscription" title="Permanent link">&para;</a></h3>
<p>「自動落下のタイマーはどうやって実装しますか？」Elmishでは、Subscriptionという仕組みを使ってタイマーを実装します。</p>
<p>まず、タイマーメッセージを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（Messageの追加）</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">ResetGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w">  </span><span class="c1">// タイマーメッセージを追加</span>
<span class="w">    </span><span class="c1">// ... 他のメッセージ ...</span>
</code></pre></div>
<p>次に、Subscriptionを定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Subscription.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Elmish</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">System</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Subscription</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// ゲームタイマー（1秒ごとにTickメッセージを発行）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">gameTimer</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Sub</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">sub</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="nn">Timers</span><span class="p">.</span><span class="n">Timer</span><span class="o">(</span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span><span class="o">)</span>
<span class="w">                </span><span class="n">timer</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Tick</span><span class="o">)</span>
<span class="w">                </span><span class="n">timer</span><span class="o">.</span><span class="n">Start</span><span class="bp">()</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IDisposable</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="k">member</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="nf">Dispose</span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="o">.</span><span class="n">Stop</span><span class="bp">()</span><span class="o">;</span><span class="w"> </span><span class="n">timer</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">[</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;gameTimer&quot;</span><span class="w"> </span><span class="o">],</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="bp">[]</span>
</code></pre></div>
<p>「Subscriptionって何ですか？」良い質問ですね！Subscriptionは、外部のイベント（タイマー、WebSocket、キーボードなど）をElmishのメッセージに変換する仕組みです。ゲームが<code>Playing</code>状態のときのみタイマーが動作し、<code>Tick</code>メッセージを定期的に発行します。</p>
<h3 id="update_5">Update 関数の拡張<a class="headerlink" href="#update_5" title="Permanent link">&para;</a></h3>
<p>「Tickメッセージを受け取ったときの処理を実装しましょう！」はい、自動落下のロジックを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（Update関数の続き）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 下に移動を試みる</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 移動成功</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 移動できない（着地）</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                </span><span class="o">{</span>
<span class="w">                    </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                        </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newBoard</span>
<span class="w">                        </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「着地したら新しいぷよを生成するんですね！」そうです！以下の処理を行っています：</p>
<ol>
<li>下に移動できるか試す</li>
<li>移動できたら新しい位置に更新</li>
<li>移動できない（着地）場合：<ul>
<li>現在のぷよをボードに固定</li>
<li>新しいぷよを生成</li>
<li>Modelを更新</li>
</ul>
</li>
</ol>
<h3 id="update_6">テスト: Update関数の統合テスト<a class="headerlink" href="#update_6" title="Permanent link">&para;</a></h3>
<p>「Update関数の自動落下処理もテストしましょう！」はい、統合テストを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``Tickメッセージでぷよが下に移動する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``着地したぷよはボードに固定され新しいぷよが生成される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 下端近く</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// 着地したぷよがボードに固定されている</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよが生成されている</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;新しいぷよが生成されるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ゲーム中でない場合は落下しない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="c1">// 位置が変わらない</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>
</code></pre></div>
<h3 id="program">Program の設定<a class="headerlink" href="#program" title="Permanent link">&para;</a></h3>
<p>「Subscriptionを使うには、Programの設定が必要ですね！」そうです！メインのエントリーポイントでSubscriptionを登録します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs（更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoGame.Main</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">WPF</span>
<span class="k">open</span><span class="w"> </span><span class="nn">WPF.Html</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Elmish.Model</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Elmish.Update</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Elmish.Subscription</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Components.GameView</span>

<span class="k">type</span><span class="w"> </span><span class="nc">MyApp</span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">inherit</span><span class="w"> </span><span class="n">ProgramComponent</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&gt;</span><span class="bp">()</span>

<span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="nf">Program</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="nn">GameView</span><span class="p">.</span><span class="n">view</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">dispatch</span>

<span class="w">        </span><span class="nn">Program</span><span class="p">.</span><span class="n">mkProgram</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">view</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">withSubscription</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Subscription</span><span class="p">.</span><span class="n">gameTimer</span><span class="w"> </span><span class="n">model</span><span class="o">)</span>
</code></pre></div>
<p>「<code>Program.withSubscription</code>でタイマーを登録するんですね！」そうです！これにより、ゲームがPlaying状態のときのみタイマーが動作し、定期的に<code>Tick</code>メッセージが発行されます。</p>
<h3 id="_43">動作確認<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、開発サーバーを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch
</code></pre></div>
<p>ブラウザで「ゲーム開始」ボタンをクリックすると、ぷよが自動的に落下し、着地すると新しいぷよが生成されるはずです！</p>
<h3 id="_44">コミット<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement auto-falling puyo with gravity</span>

<span class="s2">- Add Board.fixPuyoPair to fix puyo pair to board</span>
<span class="s2">- Add Tick message for timer events</span>
<span class="s2">- Add Subscription module with gameTimer</span>
<span class="s2">- Update Elmish Update function for Tick message</span>
<span class="s2">- Auto-generate new puyo when current puyo lands</span>
<span class="s2">- Add unit tests for fixPuyoPair (2 tests)</span>
<span class="s2">- Add integration tests for Tick handling (3 tests)</span>
<span class="s2">- All tests passing (35 tests)&quot;</span>
</code></pre></div>
<h3 id="4_1">イテレーション4のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li>
<p><strong>ドメイン層</strong></p>
<ul>
<li><code>Board.fixPuyoPair</code>：ぷよペアをボードに固定（イミュータブル）</li>
<li>パイプライン演算子による連鎖的な処理</li>
</ul>
</li>
<li>
<p><strong>Elmish層</strong></p>
<ul>
<li><code>Tick</code> メッセージ：タイマーイベント</li>
<li>自動落下ロジック：<ul>
<li>下に移動を試みる</li>
<li>移動できたら位置を更新</li>
<li>着地したらボードに固定し新しいぷよを生成</li>
</ul>
</li>
<li>Subscription：ゲームタイマーの実装</li>
</ul>
</li>
<li>
<p><strong>Program設定</strong></p>
<ul>
<li><code>Program.withSubscription</code>でタイマーを登録</li>
<li>ゲームのライフサイクル管理</li>
</ul>
</li>
<li>
<p><strong>テスト</strong></p>
<ul>
<li>ボードへの固定テスト（2テスト）<ul>
<li>固定の成功</li>
<li>イミュータビリティの確認</li>
</ul>
</li>
<li>自動落下の統合テスト（3テスト）<ul>
<li>通常の落下</li>
<li>着地と新ぷよ生成</li>
<li>ゲーム状態による制御</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>Elmish Subscription：外部イベントの統合</li>
<li>IDisposable：リソースの適切な解放</li>
<li>パイプライン演算子による関数合成</li>
<li>タイマーのライフサイクル管理</li>
<li>ゲーム状態による動作制御</li>
</ul>
</li>
<li>
<p><strong>Subscription の仕組み</strong></p>
<ul>
<li><code>Sub&lt;Message&gt;</code>型：サブスクリプションの定義</li>
<li>タプル：<code>[ [ "id" ], sub ]</code>形式でサブスクリプションを識別</li>
<li>IDisposable：タイマーの停止とリソース解放</li>
<li>モデル依存：<code>model.Status</code>に応じて動的に切り替え</li>
</ul>
</li>
<li>
<p><strong>TypeScript版との違い</strong></p>
<ul>
<li>タイマーをSubscriptionとして宣言的に定義</li>
<li><code>requestAnimationFrame</code>の代わりに<code>System.Timers.Timer</code></li>
<li>コールバック地獄なし（メッセージベース）</li>
<li>リソース管理が明確（IDisposable）</li>
</ul>
</li>
</ol>
<p>次のイテレーションでは、ぷよの高速落下機能を実装していきます。</p>
<h2 id="5">イテレーション5: ぷよの高速落下の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「自動で落ちるようになったけど、もっと速く落としたいときもあるよね？」そうですね！ぷよぷよでは、下矢印キーを押すとぷよが速く落ちるようになります。今回は、その「高速落下」機能を実装していきましょう！</p>
<h3 id="_45">ユーザーストーリー<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、下キーを押している間、ぷよを高速で落下させることができる</p>
</blockquote>
<p>「高速落下って具体的にどういう動きですか？」良い質問ですね！下矢印キーを押している間は、通常よりも速い間隔でぷよが落ちていきます。キーを離すと、通常の速度に戻ります。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 下矢印キーの入力を検出する</li>
<li class="task-list-item"><input type="checkbox" disabled/> MoveDownメッセージを処理する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 高速落下用のタイマーを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 通常タイマーと高速タイマーを切り替える</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<h3 id="_46">テスト: 下方向への移動<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>「下方向への移動は既に実装済みですよね？」そうです！イテレーション2で<code>tryMovePuyoPair</code>に<code>Direction.Down</code>を実装済みなので、基本的な機能は既にあります。念のため、テストを追加して確認しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``MoveDownメッセージでぷよが下に移動する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``下端に到達した場合は着地する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 下端近く</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// 着地してボードに固定</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよが生成</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;新しいぷよが生成されるはずです&quot;</span>
</code></pre></div>
<p>「Tickメッセージと同じ処理になりそうですね！」そうです！下に移動を試みて、着地したらボードに固定して新しいぷよを生成する、という処理は共通です。</p>
<h3 id="update_7">Update 関数の拡張<a class="headerlink" href="#update_7" title="Permanent link">&para;</a></h3>
<p>「MoveDownメッセージの処理を追加しましょう！」はい、Tickと同じロジックを使います。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（Update関数の続き）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 下に移動を試みる</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 移動成功</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 移動できない（着地）</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                </span><span class="o">{</span>
<span class="w">                    </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                        </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newBoard</span>
<span class="w">                        </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「Tickメッセージの処理と全く同じですね！」そうです！重複していますね。後でリファクタリングして共通化することもできますが、今は動作を優先しましょう。</p>
<h3 id="view_2">View の拡張<a class="headerlink" href="#view_2" title="Permanent link">&para;</a></h3>
<p>「下矢印キーの入力を受け取るようにしましょう！」はい、キーボードイベントハンドラに追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（handleKeyDownの更新）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">handleKeyDown</span><span class="w"> </span><span class="o">(</span><span class="n">dispatch</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="w"> </span><span class="nn">Microsoft</span><span class="p">.</span><span class="nn">AspNetCore</span><span class="p">.</span><span class="nn">Components</span><span class="p">.</span><span class="nn">Web</span><span class="p">.</span><span class="n">KeyboardEventArgs</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">Key</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveDown</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>
</code></pre></div>
<p>操作説明も更新しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（viewの更新）</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">div</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                        </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;← →: 左右移動&quot;</span><span class="o">]</span>
<span class="w">                        </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↑: 回転&quot;</span><span class="o">]</span>
<span class="w">                        </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↓: 高速落下&quot;</span><span class="o">]</span>
<span class="w">                        </span><span class="n">button</span><span class="w"> </span><span class="o">[</span>
<span class="w">                            </span><span class="n">on</span><span class="o">.</span><span class="n">click</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">ResetGame</span><span class="o">)</span>
<span class="w">                        </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">text</span><span class="w"> </span><span class="s">&quot;リセット&quot;</span><span class="o">]</span>
<span class="w">                    </span><span class="o">]</span>
</code></pre></div>
<h3 id="_47">高速落下タイマーの実装<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>「下キーを押している間だけ速く落ちるようにしたいんですが？」良い質問ですね！そのためには、Modelに「高速落下モード」の状態を追加し、タイマーの速度を切り替える必要があります。</p>
<p>まず、Modelを拡張します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Model.fs（Modelの更新）</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span>
<span class="w">    </span><span class="n">CurrentPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">NextPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Level</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">GameTime</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">LastChainCount</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Status</span><span class="o">:</span><span class="w"> </span><span class="n">GameStatus</span>
<span class="w">    </span><span class="n">IsFastFalling</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w">  </span><span class="c1">// 高速落下モード</span>
<span class="o">}</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">            </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">            </span><span class="n">NextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">GameTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">LastChainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span>
<span class="w">            </span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">        </span><span class="o">}</span>
</code></pre></div>
<p>次に、高速落下の開始/終了メッセージを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（Messageの追加）</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">ResetGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartFastFall</span><span class="w">  </span><span class="c1">// 高速落下開始</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StopFastFall</span><span class="w">   </span><span class="c1">// 高速落下終了</span>
</code></pre></div>
<p>「キーを押したときと離したときで別のメッセージを送るんですね！」そうです！Viewでkeydownとkeyupの両方のイベントを処理します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（イベントハンドラの更新）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">handleKeyDown</span><span class="w"> </span><span class="o">(</span><span class="n">dispatch</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="w"> </span><span class="nn">Microsoft</span><span class="p">.</span><span class="nn">AspNetCore</span><span class="p">.</span><span class="nn">Components</span><span class="p">.</span><span class="nn">Web</span><span class="p">.</span><span class="n">KeyboardEventArgs</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">Key</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">dispatch</span><span class="w"> </span><span class="n">MoveDown</span>
<span class="w">            </span><span class="n">dispatch</span><span class="w"> </span><span class="n">StartFastFall</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">handleKeyUp</span><span class="w"> </span><span class="o">(</span><span class="n">dispatch</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">e</span><span class="o">:</span><span class="w"> </span><span class="nn">Microsoft</span><span class="p">.</span><span class="nn">AspNetCore</span><span class="p">.</span><span class="nn">Components</span><span class="p">.</span><span class="nn">Web</span><span class="p">.</span><span class="n">KeyboardEventArgs</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">Key</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">StopFastFall</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>

<span class="w">    </span><span class="sd">/// メインView</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">dispatch</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">attr</span><span class="o">.</span><span class="n">classes</span><span class="w"> </span><span class="o">[</span><span class="s">&quot;game-container&quot;</span><span class="o">]</span>
<span class="w">            </span><span class="n">attr</span><span class="o">.</span><span class="n">tabindex</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">on</span><span class="o">.</span><span class="n">keydown</span><span class="w"> </span><span class="o">(</span><span class="n">handleKeyDown</span><span class="w"> </span><span class="n">dispatch</span><span class="o">)</span>
<span class="w">            </span><span class="n">on</span><span class="o">.</span><span class="n">keyup</span><span class="w"> </span><span class="o">(</span><span class="n">handleKeyUp</span><span class="w"> </span><span class="n">dispatch</span><span class="o">)</span><span class="w">  </span><span class="c1">// keyupイベントを追加</span>
<span class="w">        </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="c1">// ... 既存のコード ...</span>
<span class="w">        </span><span class="o">]</span>
</code></pre></div>
<p>Update関数で高速落下モードを切り替えます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（Update関数の続き）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartFastFall</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StopFastFall</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>最後に、Subscriptionでタイマーの速度を切り替えます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Subscription.fs（更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Subscription</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// ゲームタイマー（高速落下時は速く）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">gameTimer</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Sub</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">IsFastFalling</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">100</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">sub</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="nn">Timers</span><span class="p">.</span><span class="n">Timer</span><span class="o">(</span><span class="n">interval</span><span class="o">)</span>
<span class="w">                </span><span class="n">timer</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Tick</span><span class="o">)</span>
<span class="w">                </span><span class="n">timer</span><span class="o">.</span><span class="n">Start</span><span class="bp">()</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IDisposable</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="k">member</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="nf">Dispose</span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="o">.</span><span class="n">Stop</span><span class="bp">()</span><span class="o">;</span><span class="w"> </span><span class="n">timer</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">[</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;gameTimer&quot;</span><span class="w"> </span><span class="o">],</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="bp">[]</span>
</code></pre></div>
<p>「高速落下モードのときは100msごと、通常時は1000msごとにTickが発行されるんですね！」そうです！これにより、下キーを押している間は10倍速く落ちるようになります。</p>
<h3 id="_48">テスト: 高速落下モード<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>「高速落下モードの切り替えもテストしましょう！」はい、テストを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``StartFastFallメッセージで高速落下モードになる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="o">;</span><span class="w"> </span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">StartFastFall</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">newModel</span><span class="o">.</span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">true</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``StopFastFallメッセージで高速落下モードが解除される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="o">;</span><span class="w"> </span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">StopFastFall</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">newModel</span><span class="o">.</span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ゲーム中でない場合は高速落下モードにならない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="o">;</span><span class="w"> </span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">StartFastFall</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">newModel</span><span class="o">.</span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>
</code></pre></div>
<h3 id="_49">リファクタリング: 落下処理の共通化<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>「TickとMoveDownの処理が重複していますね。リファクタリングしましょう！」良いですね！共通の処理を関数として抽出します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（ヘルパー関数の追加）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Update</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// ぷよを下に移動させる（共通処理）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Cmd</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 移動成功</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 移動できない（着地）</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                </span><span class="o">{</span>
<span class="w">                    </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                        </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newBoard</span>
<span class="w">                        </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="sd">/// Update 関数</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="o">(</span><span class="n">message</span><span class="o">:</span><span class="w"> </span><span class="n">Message</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Cmd</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">dropPuyo</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">dropPuyo</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// ... その他のメッセージ ...</span>
</code></pre></div>
<p>「重複がなくなってスッキリしましたね！」そうです！これで、落下処理のロジックが一箇所にまとまりました。</p>
<h3 id="_50">動作確認<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、開発サーバーを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch
</code></pre></div>
<p>ブラウザで「ゲーム開始」ボタンをクリックして、下矢印キーを押してみてください。キーを押している間は速く落ち、離すと通常速度に戻るはずです！</p>
<h3 id="_51">コミット<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement fast falling with down arrow key</span>

<span class="s2">- Add IsFastFalling to Model</span>
<span class="s2">- Add StartFastFall and StopFastFall messages</span>
<span class="s2">- Add keyup event handler for stopping fast fall</span>
<span class="s2">- Update gameTimer subscription to adjust speed based on IsFastFalling</span>
<span class="s2">- Extract common dropPuyo function to eliminate duplication</span>
<span class="s2">- Add unit tests for fast fall mode (3 tests)</span>
<span class="s2">- Add integration test for MoveDown (2 tests)</span>
<span class="s2">- All tests passing (42 tests)&quot;</span>
</code></pre></div>
<h3 id="5_1">イテレーション5のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li>
<p><strong>ドメイン層</strong></p>
<ul>
<li>既存の<code>tryMovePuyoPair</code>を活用（Down方向）</li>
</ul>
</li>
<li>
<p><strong>Elmish層</strong></p>
<ul>
<li><code>IsFastFalling</code>：高速落下モードの状態</li>
<li><code>StartFastFall</code> / <code>StopFastFall</code> メッセージ</li>
<li><code>MoveDown</code> メッセージの処理</li>
<li><code>dropPuyo</code>：落下処理の共通化（リファクタリング）</li>
</ul>
</li>
<li>
<p><strong>View層</strong></p>
<ul>
<li><code>handleKeyDown</code>：下矢印キーでMoveDownとStartFastFall</li>
<li><code>handleKeyUp</code>：キーを離したときにStopFastFall</li>
<li>操作説明の更新</li>
</ul>
</li>
<li>
<p><strong>Subscription</strong></p>
<ul>
<li>タイマー速度の動的切り替え（1000ms → 100ms）</li>
<li><code>model.IsFastFalling</code>に応じて速度を変更</li>
</ul>
</li>
<li>
<p><strong>テスト</strong></p>
<ul>
<li>MoveDownメッセージのテスト（2テスト）</li>
<li>高速落下モードの切り替えテスト（3テスト）</li>
<li>ゲーム状態による制御</li>
</ul>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>keydownとkeyupイベントの組み合わせ</li>
<li>Subscriptionのモデル依存による動的な振る舞い</li>
<li>リファクタリング：重複コードの関数抽出</li>
<li>状態フラグによる動作切り替え</li>
<li>タイマー速度の動的変更</li>
</ul>
</li>
<li>
<p><strong>リファクタリングの実践</strong></p>
<ul>
<li>Before：TickとMoveDownで重複コード</li>
<li>After：<code>dropPuyo</code>関数に共通処理を抽出</li>
<li>DRY原則（Don't Repeat Yourself）の実践</li>
<li>保守性の向上</li>
</ul>
</li>
<li>
<p><strong>TypeScript版との違い</strong></p>
<ul>
<li>キー状態管理をModelで一元化</li>
<li>keyup/keydownイベントを別々のメッセージに変換</li>
<li>タイマー速度の宣言的な切り替え</li>
<li>イベントリスナーの手動管理不要</li>
</ul>
</li>
</ol>
<p>次のイテレーションでは、ぷよの消去機能を実装していきます。</p>
<h2 id="6">イテレーション6: ぷよの消去の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが積み上がってきましたが、消えませんね？」そうですね！ぷよぷよの最も重要な機能、同じ色のぷよが4つ以上つながったら消える機能を実装しましょう！</p>
<h3 id="_52">ユーザーストーリー<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとして、同じ色のぷよが4つ以上つながっている場合、それらを消去できる</p>
</blockquote>
<p>「4つ以上つながったら消えるんですね！」そうです！ぷよぷよでは、同じ色のぷよが縦か横に4つ以上つながると消えます。</p>
<h3 id="todo_5">TODOリスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> つながっているぷよを検出する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 4つ以上つながっているぷよグループを見つける</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを消去する処理を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 消去後にぷよを落下させる処理を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 着地後に消去判定を行う</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<h3 id="_53">テスト: つながっているぷよの検出<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>「最初は何からテストしますか？」まずは、同じ色のぷよがつながっているかを検出する機能からテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``横に4つ並んだぷよを検出できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``縦に4つ並んだぷよを検出できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``L字型につながった5つのぷよを検出できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``3つ以下のぷよは検出されない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Yellow</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Yellow</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Yellow</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<p>「つながっているぷよをどうやって検出するんですか？」良い質問ですね！幅優先探索（BFS）や深さ優先探索（DFS）というアルゴリズムを使って、同じ色のぷよをたどっていきます。</p>
<h3 id="_54">実装: つながっているぷよの検出<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// 隣接するセルの座標を取得</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">getNeighbors</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">[</span>
<span class="w">            </span><span class="o">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w">  </span><span class="c1">// 左</span>
<span class="w">            </span><span class="o">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w">  </span><span class="c1">// 右</span>
<span class="w">            </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w">  </span><span class="c1">// 上</span>
<span class="w">            </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w">  </span><span class="c1">// 下</span>
<span class="w">        </span><span class="o">]</span>

<span class="w">    </span><span class="sd">/// 指定位置から同じ色のつながったぷよを探索（BFS）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">findConnectedPuyos</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">startX</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">startY</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">visited</span><span class="o">:</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">bfs</span><span class="w"> </span><span class="o">(</span><span class="n">queue</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">visited</span><span class="o">:</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">result</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">contains</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="n">bfs</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="n">result</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">newVisited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">add</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="n">visited</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">neighbors</span><span class="w"> </span><span class="o">=</span>
<span class="w">                        </span><span class="n">getNeighbors</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span>
<span class="w">                        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">nx</span><span class="o">,</span><span class="w"> </span><span class="n">ny</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                            </span><span class="ow">not</span><span class="w"> </span><span class="o">(</span><span class="nn">Set</span><span class="p">.</span><span class="n">contains</span><span class="w"> </span><span class="o">(</span><span class="n">nx</span><span class="o">,</span><span class="w"> </span><span class="n">ny</span><span class="o">)</span><span class="w"> </span><span class="n">newVisited</span><span class="o">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                            </span><span class="k">match</span><span class="w"> </span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">true</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">false</span><span class="o">)</span>
<span class="w">                    </span><span class="n">bfs</span><span class="w"> </span><span class="o">(</span><span class="n">rest</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">neighbors</span><span class="o">)</span><span class="w"> </span><span class="n">newVisited</span><span class="w"> </span><span class="o">((</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">result</span><span class="o">)</span>

<span class="w">        </span><span class="n">bfs</span><span class="w"> </span><span class="o">[(</span><span class="n">startX</span><span class="o">,</span><span class="w"> </span><span class="n">startY</span><span class="o">)]</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="bp">[]</span>

<span class="w">    </span><span class="sd">/// 4つ以上つながっているぷよのグループを検出</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">findConnectedGroups</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">((</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">empty</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">[]</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="o">(</span><span class="nn">Set</span><span class="p">.</span><span class="n">contains</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="n">visited</span><span class="o">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="k">match</span><span class="w"> </span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="o">|</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="n">visited</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="n">groups</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">groups</span>
<span class="w">                        </span><span class="n">visited</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">ofList</span><span class="w"> </span><span class="n">group</span>
<span class="w">                    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="n">groups</span>
</code></pre></div>
<p>「BFS（幅優先探索）を使っているんですね！」そうです！キューを使って、同じ色のぷよを順番にたどっていきます。F#の再帰関数とパターンマッチングを使って、綺麗に書けますね。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="_55">テスト: ぷよの消去<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>「次はぷよを消す処理をテストしましょう！」はい、検出したぷよを実際に消去する処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``指定した位置のぷよを消去できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">12</span><span class="o">);</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">12</span><span class="o">);</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">12</span><span class="o">);</span><span class="w"> </span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="mi">12</span><span class="o">)]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">positions</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
</code></pre></div>
<h3 id="_56">実装: ぷよの消去<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// 指定位置のぷよを消去</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">clearPuyos</span><span class="w"> </span><span class="o">(</span><span class="n">positions</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">positions</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">fold</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">setCell</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="n">b</span><span class="o">)</span><span class="w"> </span><span class="n">board</span>
</code></pre></div>
<p>「<code>List.fold</code>を使って連鎖的に消去しているんですね！」そうです！関数型プログラミングの典型的なパターンです。また、<code>setCell</code> の引数順序を変更したことで、パイプライン演算子と組み合わせて使いやすくなりました。</p>
<h3 id="_57">テスト: 重力による落下<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>「ぷよを消した後、上のぷよが落ちてこないといけませんね！」そうです！重力処理を実装しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``重力を適用すると浮いているぷよが落ちる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span><span class="w">   </span><span class="c1">// 浮いているぷよ</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span><span class="w">    </span><span class="c1">// 下にあるぷよ</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">applyGravity</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span><span class="w">  </span><span class="c1">// 落ちた</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``重力を適用すると複数のぷよが落ちる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Yellow</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">applyGravity</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Yellow</span><span class="o">)</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
</code></pre></div>
<h3 id="_58">実装: 重力による落下<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// 重力を適用（浮いているぷよを落とす）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">applyGravity</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">newCells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="n">Empty</span><span class="o">)</span>

<span class="w">        </span><span class="c1">// 各列ごとに処理</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">column</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="o">[|</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">|]</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Empty</span><span class="o">)</span>

<span class="w">            </span><span class="c1">// 下から詰める</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">startY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">column</span><span class="o">.</span><span class="n">Length</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">column</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="n">newCells</span><span class="o">.[</span><span class="n">startY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">column</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span>

<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCells</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「各列ごとに空でないセルを集めて、下から詰め直しているんですね！」そうです！これで、消去後に上のぷよが正しく落ちてきます。</p>
<h3 id="update_8">Update 関数の拡張<a class="headerlink" href="#update_8" title="Permanent link">&para;</a></h3>
<p>「着地後に消去処理を行うようにしましょう！」はい、<code>dropPuyo</code>関数を拡張します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（dropPuyoの更新）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Cmd</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 移動成功</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 移動できない（着地）</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>

<span class="w">                </span><span class="c1">// 消去処理</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">boardWithPuyo</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterClear</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="nn">Board</span><span class="p">.</span><span class="n">applyGravity</span><span class="w"> </span><span class="n">boardWithPuyo</span>
<span class="w">                    </span><span class="k">else</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">                        </span><span class="n">boardWithPuyo</span>
<span class="w">                        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">positions</span>
<span class="w">                        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">applyGravity</span>

<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                </span><span class="o">{</span>
<span class="w">                    </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                        </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterClear</span>
<span class="w">                        </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「着地→消去→重力の順に処理しているんですね！」そうです！以下の流れで処理されます：</p>
<ol>
<li>ぷよをボードに固定</li>
<li>つながっているぷよを検出</li>
<li>4つ以上のグループがあれば消去</li>
<li><strong>重力を常に適用して浮いているぷよを落とす</strong>（消去がない場合も適用）</li>
<li>新しいぷよを生成</li>
</ol>
<blockquote>
<p><strong>🔧 重要な修正点</strong>: 初期の実装では、消去がない場合は重力を適用していませんでした。しかし、これではぷよペアの片方が空中に浮いたままになる問題が発生します。そのため、消去の有無にかかわらず、着地後は常に <code>Board.applyGravity</code> を適用するよう修正しました。</p>
</blockquote>
<h3 id="update_9">テスト: Update関数の統合テスト<a class="headerlink" href="#update_9" title="Permanent link">&para;</a></h3>
<p>「消去処理の統合テストも追加しましょう！」はい、実際のゲームフローをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``着地時に4つ以上つながったぷよが消える``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="c1">// 下に3つ並べておく</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 4つ目のぷよを落とす（1回のTickで着地する位置に配置）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="o">;</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span><span class="w">  </span><span class="c1">// 着地</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// 4つつながったので消えている</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>

<span class="w">    </span><span class="c1">// 緑のぷよは重力で落ちて下端に残っている</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``着地時に消去されなくても重力が適用される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="c1">// 縦向きのぷよペアを配置（下端）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span><span class="w">   </span><span class="c1">// 軸ぷよ</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span><span class="w"> </span><span class="c1">// 子ぷよ</span>

<span class="w">    </span><span class="c1">// 横向きのぷよペアを重ねる（rotation=3で左向き、軸ぷよが右）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="o">;</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span><span class="w">  </span><span class="c1">// 着地</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// 軸ぷよ（Blue）は縦ぷよの上に着地</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 子ぷよ（Yellow）は重力で(2,12)に落ちる</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Yellow</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// (2,10)は空になっている</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
</code></pre></div>
<p>「浮遊ぷよのテストを追加したんですね！」そうです！横向きのぷよペアの片方が縦向きのぷよに重なり、もう片方が空中に浮く状況を再現しています。着地後は常に重力が適用されるため、浮いているぷよは正しく落下します。</p>
<h3 id="_59">動作確認<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、開発サーバーを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch
</code></pre></div>
<p>ブラウザでゲームを開始し、同じ色のぷよを4つつなげてみてください。消えるはずです！</p>
<h3 id="_60">コミット<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement puyo clearing and gravity</span>

<span class="s2">- Add findConnectedGroups to detect 4+ connected puyos using BFS</span>
<span class="s2">- Add clearPuyos to remove puyos at specified positions</span>
<span class="s2">- Add applyGravity to drop floating puyos after clearing</span>
<span class="s2">- Update dropPuyo to handle clearing after landing</span>
<span class="s2">- Add unit tests for connected group detection (4 tests)</span>
<span class="s2">- Add unit tests for clearing (1 test)</span>
<span class="s2">- Add unit tests for gravity (2 tests)</span>
<span class="s2">- Add integration test for clearing on landing (1 test)</span>
<span class="s2">- All tests passing (50 tests)&quot;</span>
</code></pre></div>
<h3 id="6_1">イテレーション6のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li>
<p><strong>ドメイン層</strong></p>
<ul>
<li><code>findConnectedGroups</code>：BFSでつながったぷよを検出<ul>
<li><code>getNeighbors</code>：隣接セルの取得</li>
<li><code>findConnectedPuyos</code>：再帰的BFS探索</li>
</ul>
</li>
<li><code>clearPuyos</code>：指定位置のぷよを消去</li>
<li><code>applyGravity</code>：浮いているぷよを落とす</li>
</ul>
</li>
<li>
<p><strong>アルゴリズム</strong></p>
<ul>
<li>BFS（幅優先探索）：つながったぷよの検出</li>
<li>訪問済み管理：<code>Set&lt;int * int&gt;</code>で重複探索を防止</li>
<li>列ごとの再配置：重力処理</li>
</ul>
</li>
<li>
<p><strong>Elmish層</strong></p>
<ul>
<li><code>dropPuyo</code>の拡張：着地→消去→<strong>常に重力を適用</strong></li>
<li>消去の有無にかかわらず重力を適用することで浮遊ぷよを防止</li>
</ul>
</li>
<li>
<p><strong>テスト</strong></p>
<ul>
<li>つながったぷよの検出テスト（4テスト）<ul>
<li>横に4つ</li>
<li>縦に4つ</li>
<li>L字型に5つ</li>
<li>3つ以下は検出されない</li>
</ul>
</li>
<li>消去処理のテスト（1テスト）</li>
<li>重力処理のテスト（2テスト）</li>
<li>統合テスト（2テスト）<ul>
<li>着地時の消去処理</li>
<li><strong>浮遊ぷよの重力適用</strong>（重要なエッジケース）</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
<ul>
<li>BFS（幅優先探索）アルゴリズム</li>
<li>再帰関数とパターンマッチング</li>
<li><code>Set</code>型による訪問済み管理</li>
<li><code>List.fold</code>による連鎖的な更新</li>
<li>ミュータブルな配列の局所的な使用（重力処理）</li>
<li>列ごとのフィルタと再配置</li>
<li><strong>パイプライン対応の関数設計</strong>（引数順序の工夫）</li>
</ul>
</li>
<li>
<p><strong>F#らしい実装</strong></p>
<ul>
<li>再帰関数によるBFS</li>
<li>パターンマッチングによる分岐</li>
<li>パイプライン演算子 <code>|&gt;</code> を活用した可読性の高いコード</li>
<li>データを最後の引数に配置する関数設計</li>
<li>イミュータブルな設計（Set、List）</li>
<li>パイプライン演算子による連鎖</li>
<li><code>List.fold</code>による集約</li>
</ul>
</li>
<li>
<p><strong>TypeScript版との違い</strong></p>
<ul>
<li>BFSの実装が再帰的で宣言的</li>
<li>Setによる訪問済み管理（mutationなし）</li>
<li>パイプライン演算子による可読性</li>
<li>パターンマッチングによる安全な分岐</li>
</ul>
</li>
</ol>
<p>次のイテレーションでは、連鎖反応を実装していきます。</p>
<h2 id="7">イテレーション7: 連鎖反応の実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装していきましょう！</p>
<h3 id="_61">ユーザーストーリー<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="todo_6">TODOリスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「連鎖反応を実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>連鎖判定を実装する（ぷよが消えた後に新たな消去パターンがあるかを判定する）</li>
<li>連鎖カウントを実装する（何連鎖目かをカウントする）</li>
<li>連鎖ボーナスの計算を実装する（連鎖数に応じたボーナス点を計算する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_62">テスト: 連鎖判定<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、連鎖判定をテストしましょう。ぷよが消えて落下した後に、新たな消去パターンが発生するかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ゲームの盤面にぷよを配置</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 1 1 2 0 0</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 最初の消去判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="n">groups1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="ow">not</span><span class="k">&#39;</span><span class="w"> </span><span class="o">(</span><span class="n">be</span><span class="w"> </span><span class="n">Empty</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 消去実行</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">positions1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterClear1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">positions1</span>

<span class="w">    </span><span class="c1">// 落下処理</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">applyGravity</span><span class="w"> </span><span class="n">boardAfterClear1</span>

<span class="w">    </span><span class="c1">// 連鎖判定（2回目の消去判定）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">boardAfterGravity</span>

<span class="w">    </span><span class="c1">// 連鎖が発生していることを確認（青ぷよが4つつながっている）</span>
<span class="w">    </span><span class="n">groups2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="ow">not</span><span class="k">&#39;</span><span class="w"> </span><span class="o">(</span><span class="n">be</span><span class="w"> </span><span class="n">Empty</span><span class="o">)</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のシナリオを確認しています：</p>
<ol>
<li>まず、特定のパターンでぷよを配置します（赤ぷよの2×2の正方形と、その上に青ぷよが縦に3つ並び、さらに青ぷよが横に1つある状態）</li>
<li>最初の消去判定で赤ぷよの正方形が消えます</li>
<li>消去後に落下処理を行うと、上にあった青ぷよが落下します</li>
<li>落下した結果、新たに青ぷよが4つつながり、連鎖が発生することを確認します</li>
</ol>
<p>「なるほど、連鎖の仕組みがテストで表現されているんですね！」そうです！このテストは、ぷよぷよの連鎖の基本的な仕組みを表現しています。では、このテストが通るか確認してみましょう。</p>
<h3 id="_63">実装: 連鎖判定<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>「既存のゲームループを見てみると、実は連鎖反応は既に実装されています！」そうなんです。イテレーション6で実装したゲームループの仕組みが、そのまま連鎖反応を実現しているんです。</p>
<p>「え？本当ですか？」はい。Elmish の update 関数の実装を見てみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の update 関数（抜粋）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 着地処理</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>

<span class="w">                </span><span class="c1">// 消去判定と処理</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">boardWithPuyo</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterClear</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="n">boardWithPuyo</span>
<span class="w">                    </span><span class="k">else</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">clearedBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">boardWithPuyo</span><span class="w"> </span><span class="n">positions</span>
<span class="w">                        </span><span class="nn">Board</span><span class="p">.</span><span class="n">applyGravity</span><span class="w"> </span><span class="n">clearedBoard</span><span class="w">  </span><span class="c1">// ← ここで重力適用</span>

<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                </span><span class="o">{</span>
<span class="w">                    </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                        </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterClear</span>
<span class="w">                        </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「この実装の何が連鎖反応を実現しているんですか？」現在の実装では、1回の着地で1回だけ消去と重力を適用していますが、連鎖を実現するには、消去後に再度消去判定を繰り返す必要があります。</p>
<h4 id="_64">連鎖の流れ<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h4>
<p>連鎖を実現するには、以下のような流れが必要です：</p>
<ol>
<li>
<p><strong>1回目の消去</strong>：
   <div class="highlight"><pre><span></span><code>着地 → 消去判定 → 消去 → 重力適用
</code></pre></div></p>
</li>
<li>
<p><strong>2回目の消去（連鎖）</strong>：
   <div class="highlight"><pre><span></span><code>消去判定 → 消去あり → 消去 → 重力適用
</code></pre></div></p>
</li>
<li>
<p><strong>連鎖終了</strong>：
   <div class="highlight"><pre><span></span><code>消去判定 → 消去なし → 次のぷよ
</code></pre></div></p>
</li>
</ol>
<p>「つまり、消去後に再度消去判定を繰り返す必要があるんですね！」そのとおりです！では、連鎖を実現する処理を実装していきましょう。</p>
<h3 id="_65">実装: 連鎖処理の再帰的な実装<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>まず、消去と重力を繰り返し適用する関数を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// 消去と重力を繰り返し適用（連鎖処理）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1">// 消去対象がない場合は終了</span>
<span class="w">            </span><span class="n">board</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 消去して重力を適用</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">clearedBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">positions</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">clearedBoard</span>

<span class="w">            </span><span class="c1">// 再帰的に消去判定を繰り返す</span>
<span class="w">            </span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">boardAfterGravity</span>
</code></pre></div>
<p>「この関数は何をしているんですか？」この関数は、再帰的に消去と重力を適用し続けます：</p>
<ol>
<li>消去対象のグループを検出</li>
<li>グループがない場合は終了</li>
<li>グループがある場合は消去して重力を適用</li>
<li>再度1に戻る（再帰呼び出し）</li>
</ol>
<p>「なるほど、消去対象がなくなるまで繰り返すんですね！」そうです。では、この関数を update 関数から呼び出すように修正しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の dropPuyo 関数を修正</span>

<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Cmd</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 着地処理</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>

<span class="w">            </span><span class="c1">// 連鎖処理（消去と重力を繰り返し適用）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">boardWithPuyo</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="o">{</span>
<span class="w">                </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterChain</span>
<span class="w">                    </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">            </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「これで連鎖が動くようになりましたか？」はい！<code>clearAndApplyGravityRepeatedly</code> 関数が、消去対象がなくなるまで自動的に繰り返し処理を行うため、連鎖が実現されます。</p>
<h3 id="_66">テスト実行<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストは通りましたか？」はい！連鎖のテストを含めて、全てのテストがパスしました。</p>
<h3 id="_67">解説: 再帰的な連鎖処理<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>F# で連鎖処理を実装する際のポイントを見ていきましょう：</p>
<ol>
<li>
<p><strong>再帰関数の活用</strong>
   <div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="c1">// 処理して再帰呼び出し</span>
<span class="w">        </span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">boardAfterGravity</span>
</code></pre></div></p>
<ul>
<li><code>rec</code> キーワードで再帰関数を定義</li>
<li>終了条件（消去グループなし）で再帰を止める</li>
<li>末尾再帰最適化により、スタックオーバーフローを防ぐ</li>
</ul>
</li>
<li>
<p><strong>不変性の維持</strong>
   <div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">clearedBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">positions</span>
<span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">clearedBoard</span>
<span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">boardAfterGravity</span>
</code></pre></div></p>
<ul>
<li>各ステップで新しい Board を返す</li>
<li>元の board は変更されない</li>
<li>パイプライン処理で順次適用</li>
</ul>
</li>
<li>
<p><strong>パターンマッチングによる分岐</strong>
   <div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="n">board</span>
<span class="k">else</span>
<span class="w">    </span><span class="c1">// 消去処理</span>
</code></pre></div></p>
<ul>
<li>リストが空かどうかで処理を分岐</li>
<li>F# の表現力豊かな条件分岐</li>
</ul>
</li>
</ol>
<h3 id="typescript">TypeScript版との違い<a class="headerlink" href="#typescript" title="Permanent link">&para;</a></h3>
<p>TypeScript 版では、ゲームループの状態遷移（モード切り替え）によって連鎖を実現していました：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// TypeScript版の状態遷移</span>
<span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="o">:</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span>
<span class="p">}</span>
<span class="k">break</span>

<span class="k">case</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="o">:</span>
<span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="w">  </span><span class="c1">// 消去後、重力チェックへ</span>
<span class="k">break</span>
</code></pre></div>
<p>一方、F# WPF 版では：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#版の再帰的処理</span>
<span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="n">board</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">clearedBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">positions</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">clearedBoard</span>
<span class="w">        </span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">boardAfterGravity</span>
</code></pre></div>
<p><strong>主な違い</strong>：</p>
<table>
<thead>
<tr>
<th>観点</th>
<th>TypeScript版</th>
<th>F# WPF版</th>
</tr>
</thead>
<tbody>
<tr>
<td>実装方式</td>
<td>状態遷移（モード管理）</td>
<td>再帰関数</td>
</tr>
<tr>
<td>処理の流れ</td>
<td>イベントループで段階的</td>
<td>一度の関数呼び出しで完結</td>
</tr>
<tr>
<td>コードの複雑さ</td>
<td>モードごとの分岐が必要</td>
<td>シンプルな再帰処理</td>
</tr>
<tr>
<td>デバッグ</td>
<td>状態遷移を追う必要あり</td>
<td>関数の入出力を確認</td>
</tr>
</tbody>
</table>
<p>「F# の方がシンプルに書けるんですね！」そうです。再帰関数と不変性により、連鎖処理を宣言的に表現できています。</p>
<h3 id="_68">テストの追加<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>連鎖が正しく動作することを確認するため、複数のテストケースを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``連鎖処理で消去対象がない場合は盤面がそのまま返される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// 消去対象がないため、盤面は変わらない</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``連鎖処理で2連鎖が正しく動作する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 1連鎖目で赤が消え、2連鎖目で青が消えるパターン</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// すべてのぷよが消えている（2連鎖が発生）</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``連鎖処理で3連鎖が正しく動作する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 3連鎖が発生するパターン</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="c1">// 1連鎖目: 赤ぷよ（下部）</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="c1">// 2連鎖目: 青ぷよ（中部）</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">        </span><span class="c1">// 3連鎖目: 緑ぷよ（上部）</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// すべてのぷよが消えている（3連鎖が発生）</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
</code></pre></div>
<p>「これらのテストは何を確認しているんですか？」これらのテストでは、以下を確認しています：</p>
<ol>
<li><strong>消去なしのケース</strong>：消去対象がない場合、盤面がそのまま返される</li>
<li><strong>2連鎖のケース</strong>：赤ぷよが消えた後、青ぷよが落下して2連鎖が発生</li>
<li><strong>3連鎖のケース</strong>：複数回の連鎖が正しく動作する</li>
</ol>
<h3 id="_69">コミット<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>テストが全て通ったら、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">feat: implement chain reaction system</span>

<span class="s">- Add clearAndApplyGravityRepeatedly for recursive chain processing</span>
<span class="s">- Update dropPuyo to use chain processing function</span>
<span class="s">- Add test for basic chain reaction (2 chains)</span>
<span class="s">- Add test for no clearing case</span>
<span class="s">- Add test for 2-chain scenario</span>
<span class="s">- Add test for 3-chain scenario</span>
<span class="s">- All tests passing (54 tests)</span>

<span class="s">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;</span>
<span class="s">EOF</span>
<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="7_1">イテレーション７のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li>
<p><strong>再帰関数による連鎖処理</strong>：</p>
<ul>
<li><code>rec</code> キーワードで再帰関数を定義</li>
<li>終了条件を明確にする</li>
<li>末尾再帰最適化によるパフォーマンス</li>
</ul>
</li>
<li>
<p><strong>宣言的なコード</strong>：</p>
<ul>
<li>TypeScript 版の状態遷移と比較してシンプル</li>
<li>関数型プログラミングの利点を活用</li>
<li>不変性により安全な処理</li>
</ul>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
<ul>
<li>連鎖が発生するケースをテスト</li>
<li>消去なしのケースもテスト</li>
<li>複数連鎖のケースで動作確認</li>
<li>テストで仕様を明確化</li>
</ul>
</li>
<li>
<p><strong>F# の表現力</strong>：</p>
<ul>
<li>再帰による自然な連鎖表現</li>
<li>パターンマッチングによる分岐</li>
<li>パイプライン演算子での処理の流れ</li>
</ul>
</li>
</ol>
<p>このイテレーションで、ぷよぷよの醍醐味である連鎖反応が実装できました。次のイテレーションでは、全消しボーナスを実装して、プレイヤーに特別な達成感を提供します！</p>
<h2 id="8">イテレーション8: 全消しボーナスの実装<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>「連鎖ができるようになったけど、ぷよぷよには全消しボーナスもありますよね？」そうですね！ぷよぷよには、盤面上のぷよをすべて消すと得られる「全消し（ぜんけし）ボーナス」という特別な報酬があります。今回は、その全消しボーナスを実装していきましょう！</p>
<h3 id="_70">ユーザーストーリー<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、盤面上のぷよをすべて消したときに全消しボーナスを獲得できる</p>
</blockquote>
<p>「やった！全部消えた！」という達成感と共に、特別なボーナスポイントを獲得できる機能を実装します。これにより、プレイヤーは全消しを狙った戦略を考えるようになりますね。</p>
<h3 id="todo_7">TODOリスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「全消しボーナスを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>全消し判定を実装する（盤面上のぷよがすべて消えたかどうかを判定する）</li>
<li>スコア管理を実装する（スコアの計算と表示を管理する）</li>
<li>全消しボーナスの計算を実装する（全消し時に加算するボーナス点を計算する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_71">テスト: 全消し判定<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、全消し判定をテストしましょう。盤面上のぷよがすべて消えたかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``盤面上のぷよがすべて消えると全消しになる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">clearedBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">positions</span>

<span class="w">    </span><span class="c1">// 全消し判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">checkZenkeshi</span><span class="w"> </span><span class="n">clearedBoard</span>

<span class="w">    </span><span class="c1">// 全消しになっていることを確認</span>
<span class="w">    </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">true</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``盤面上にぷよが残っていると全消しにならない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span><span class="w">  </span><span class="c1">// 消えないぷよ</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">clearedBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">positions</span>

<span class="w">    </span><span class="c1">// 全消し判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">checkZenkeshi</span><span class="w"> </span><span class="n">clearedBoard</span>

<span class="w">    </span><span class="c1">// 全消しになっていないことを確認</span>
<span class="w">    </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>盤面上のぷよがすべて消えた場合、全消しと判定されるか</li>
<li>盤面上にぷよが残っている場合、全消しと判定されないか</li>
</ol>
<p>「最初のテストでは、2×2の正方形に赤ぷよを配置して、それらが消えた後に全消しになるんですね？」そうです！最初のテストでは、2×2の正方形に赤ぷよを配置し、それらが消去された後に盤面が空になるので、全消しと判定されるはずです。</p>
<p>「2つ目のテストでは、消えないぷよが残るようにしているんですね？」その通りです！2つ目のテストでは、2×2の正方形に赤ぷよを配置した上で、別の場所に青ぷよを1つ配置しています。赤ぷよは消えますが、青ぷよは消えないので、全消しにはならないはずです。</p>
<p>「なるほど、全消し判定の条件がよく分かりますね！」では、このテストが通るように実装していきましょう。</p>
<h3 id="_72">実装: 全消し判定<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、全消し判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// 全消し判定（盤面上にぷよがあるかチェック）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">checkZenkeshi</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">board</span><span class="o">.</span><span class="n">Cells</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">forall</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">row</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">forall</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Empty</span><span class="o">))</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。全消し判定の実装自体はとてもシンプルです。盤面上のすべてのセルをチェックし、全てが <code>Empty</code> であれば <code>true</code> を返します。</p>
<p>「<code>Array.forall</code> を使っているんですね！」その通りです！<code>Array.forall</code> は、配列の全ての要素が条件を満たすかをチェックする関数です。外側の <code>forall</code> で各行を、内側の <code>forall</code> で各列をチェックしています。</p>
<h3 id="_73">解説: 全消し判定<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>全消し判定では、以下のことを行っています：</p>
<ol>
<li>盤面上のすべての行を順番にチェック</li>
<li>各行のすべてのセルが <code>Empty</code> かどうかをチェック</li>
<li>すべてのセルが空であれば <code>true</code>、1つでもぷよがあれば <code>false</code></li>
</ol>
<p>「全消し判定はいつ行われるんですか？」良い質問ですね！全消し判定は、連鎖処理が完了した後に行われます。ぷよが消えた後、盤面上にぷよが残っていないかをチェックするんです。</p>
<h3 id="_74">テスト: スコア管理<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>次に、スコア管理の機能を実装します。まずはテストから書いていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/ScoreTests.fs（新規作成）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.ScoreTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Domain.Score</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``初期スコアは0である``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="n">score</span><span class="o">.</span><span class="n">Value</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``スコアを加算できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">addScore</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="n">updatedScore</span><span class="o">.</span><span class="n">Value</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">100</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``スコアを複数回加算できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Score</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="bp">()</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">addScore</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">addScore</span><span class="w"> </span><span class="mi">200</span>
<span class="w">    </span><span class="n">score</span><span class="o">.</span><span class="n">Value</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">300</span>
</code></pre></div>
<p>「スコア管理のテストでは何を確認しているんですか？」これらのテストでは、以下を確認しています：</p>
<ol>
<li>初期状態でスコアが0であること</li>
<li>スコアを加算できること</li>
<li>スコアを複数回加算できること</li>
</ol>
<h3 id="_75">実装: スコア管理<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>スコアを管理する型とモジュールを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Score.fs（新規作成）</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="nn">WPF</span><span class="p">.</span><span class="n">Domain</span>

<span class="sd">/// スコアを表す型</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Value</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="o">}</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Score</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// スコアを作成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">create</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// スコアを加算</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">addScore</span><span class="w"> </span><span class="o">(</span><span class="n">score</span><span class="o">:</span><span class="w"> </span><span class="n">Score</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">points</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="o">.</span><span class="n">Value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// 全消しボーナスを加算</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">addZenkeshiBonus</span><span class="w"> </span><span class="o">(</span><span class="n">score</span><span class="o">:</span><span class="w"> </span><span class="n">Score</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">zenkeshiBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span>
<span class="w">        </span><span class="n">addScore</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="n">zenkeshiBonus</span>
</code></pre></div>
<p>「スコアはレコード型で表現するんですね！」そうです。F# のレコード型は不変で、コピー式 (<code>{ score with Value = ... }</code>) で簡単に新しいスコアを作成できます。</p>
<p>「全消しボーナスは固定値なんですね！」はい、全消しボーナスは固定で 3600 点とします。これは、プレイヤーに特別な達成感を与えるための値です。</p>
<h3 id="_76">テスト: 全消しボーナス<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>全消しボーナスのテストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/ScoreTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``全消しボーナスを加算できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">addZenkeshiBonus</span><span class="w"> </span><span class="n">score</span>
<span class="w">    </span><span class="n">updatedScore</span><span class="o">.</span><span class="n">Value</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">3600</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``通常スコアと全消しボーナスを組み合わせて加算できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Score</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="bp">()</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">addScore</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">addZenkeshiBonus</span>
<span class="w">    </span><span class="n">score</span><span class="o">.</span><span class="n">Value</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4600</span>
</code></pre></div>
<h3 id="model">Model への統合<a class="headerlink" href="#model" title="Permanent link">&para;</a></h3>
<p>スコアを Model に追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の Model 型を修正</span>

<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span>
<span class="w">    </span><span class="n">CurrentPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">Status</span><span class="o">:</span><span class="w"> </span><span class="n">GameStatus</span>
<span class="w">    </span><span class="n">IsFastFalling</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">Score</span><span class="w">  </span><span class="c1">// ← 追加</span>
<span class="o">}</span>
</code></pre></div>
<p>init 関数も修正します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の init 関数を修正</span>

<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">initialBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initialBoard</span>
<span class="w">        </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">initialPiece</span>
<span class="w">        </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">        </span><span class="n">IsFastFalling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">        </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="bp">()</span><span class="w">  </span><span class="c1">// ← 追加</span>
<span class="w">    </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<h3 id="_77">全消し判定と連鎖処理の統合<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>連鎖処理に全消し判定を組み込みます。連鎖処理が完了した後のボード状態を返すだけでなく、全消しだったかどうかも返すように修正します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs の clearAndApplyGravityRepeatedly を修正</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// 消去と重力を繰り返し適用（連鎖処理）、全消しかどうかも返す</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="n">clearAndApplyGravityRepeatedlyImpl</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">board</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">clearedBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">positions</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">clearedBoard</span>
<span class="w">            </span><span class="n">clearAndApplyGravityRepeatedlyImpl</span><span class="w"> </span><span class="n">boardAfterGravity</span>

<span class="w">    </span><span class="sd">/// 消去と重力を繰り返し適用し、最終状態と全消しフラグを返す</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">finalBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clearAndApplyGravityRepeatedlyImpl</span><span class="w"> </span><span class="n">board</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkZenkeshi</span><span class="w"> </span><span class="n">finalBoard</span>
<span class="w">        </span><span class="o">(</span><span class="n">finalBoard</span><span class="o">,</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="o">)</span>
</code></pre></div>
<p>「戻り値がタプルになったんですね！」そうです。F# では複数の値を返す場合、タプルを使うのが一般的です。</p>
<h3 id="update_10">update 関数の修正<a class="headerlink" href="#update_10" title="Permanent link">&para;</a></h3>
<p>dropPuyo 関数を修正して、全消しボーナスを加算するようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の dropPuyo 関数を修正</span>

<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Cmd</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 着地処理</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>

<span class="w">            </span><span class="c1">// 連鎖処理（消去と重力を繰り返し適用）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">boardAfterChain</span><span class="o">,</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">boardWithPuyo</span>

<span class="w">            </span><span class="c1">// 全消しの場合はボーナス加算</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newScore</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="nn">Score</span><span class="p">.</span><span class="n">addZenkeshiBonus</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Score</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="n">model</span><span class="o">.</span><span class="n">Score</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="o">{</span>
<span class="w">                </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterChain</span>
<span class="w">                    </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                    </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newScore</span>
<span class="w">            </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
</code></pre></div>
<p>「全消しのときだけボーナスが加算されるんですね！」そうです。if 式を使って、全消しの場合はボーナスを加算し、そうでない場合は現在のスコアをそのまま使います。</p>
<h3 id="view_3">View への統合<a class="headerlink" href="#view_3" title="Permanent link">&para;</a></h3>
<p>スコアを画面に表示するように view 関数を修正します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の view 関数を修正</span>

<span class="k">let</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;font-family: monospace; text-align: center; padding: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">h1</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ&quot;</span><span class="w"> </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// スコア表示</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-bottom: 10px; font-size: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">text</span><span class="w"> </span><span class="o">$</span><span class="s">&quot;Score: {model.Score.Value}&quot;</span>
<span class="w">        </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// ゲームボード</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;display: inline-block; border: 2px solid black; background-color: #f0f0f0;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;display: flex;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">match</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;white&quot;</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="n">puyoColor</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="k">match</span><span class="w"> </span><span class="n">puyoColor</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>

<span class="w">                        </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">isPuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                                </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">false</span>

<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">finalColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="n">isPuyoPair</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                        </span><span class="k">match</span><span class="w"> </span><span class="n">piece</span><span class="o">.</span><span class="n">Puyo1Color</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>
<span class="w">                                    </span><span class="k">elif</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                        </span><span class="k">match</span><span class="w"> </span><span class="n">piece</span><span class="o">.</span><span class="n">Puyo2Color</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>
<span class="w">                                    </span><span class="k">else</span>
<span class="w">                                        </span><span class="n">color</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">color</span>
<span class="w">                            </span><span class="k">else</span>
<span class="w">                                </span><span class="n">color</span>

<span class="w">                        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span>
<span class="w">                            </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="o">$</span><span class="s">&quot;width: 30px; height: 30px; border: 1px solid #ccc; background-color: {finalColor};&quot;</span>
<span class="w">                        </span><span class="o">]</span><span class="w"> </span><span class="bp">[]</span>
<span class="w">                </span><span class="o">]</span>
<span class="w">        </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// 操作説明</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-top: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;← → : 移動&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↑ : 回転&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↓ : 高速落下&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="o">]</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「スコアが画面の上部に表示されるんですね！」そうです。プレイヤーは現在のスコアをいつでも確認できるようになります。</p>
<h3 id="_78">テスト実行<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストは通りましたか？」はい！全消し判定とスコア管理のテストを含めて、全てのテストがパスしました。</p>
<h3 id="_79">統合テスト<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p>全消しボーナスが正しく動作することを確認する統合テストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``全消しの場合はフラグがtrueになる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">finalBoard</span><span class="o">,</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// 全消しフラグがtrueであることを確認</span>
<span class="w">    </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">true</span>

<span class="w">    </span><span class="c1">// すべてのセルが空であることを確認</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">finalBoard</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``全消しでない場合はフラグがfalseになる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">finalBoard</span><span class="o">,</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// 全消しフラグがfalseであることを確認</span>
<span class="w">    </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>

<span class="w">    </span><span class="c1">// ぷよが残っていることを確認</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">finalBoard</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">finalBoard</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
</code></pre></div>
<h3 id="_80">コミット<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p>テストが全て通ったら、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">feat: implement all-clear bonus system</span>

<span class="s">- Add checkZenkeshi function to detect all-clear state</span>
<span class="s">- Create Score module for score management</span>
<span class="s">- Add Score to Model with initial value 0</span>
<span class="s">- Update clearAndApplyGravityRepeatedly to return isZenkeshi flag</span>
<span class="s">- Update dropPuyo to add all-clear bonus (3600 points)</span>
<span class="s">- Add score display to view</span>
<span class="s">- Add tests for all-clear detection (2 tests)</span>
<span class="s">- Add tests for score management (5 tests)</span>
<span class="s">- Add integration tests for all-clear flag (2 tests)</span>
<span class="s">- All tests passing (63 tests)</span>

<span class="s">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;</span>
<span class="s">EOF</span>
<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="8_1">イテレーション８のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li>
<p><strong>全消し判定の実装</strong>：</p>
<ul>
<li><code>Array.forall</code> による全要素チェック</li>
<li>二重の <code>forall</code> で2次元配列を処理</li>
<li>シンプルなロジックで確実な判定を実現</li>
</ul>
</li>
<li>
<p><strong>スコア管理の設計</strong>：</p>
<ul>
<li>レコード型による不変なスコア表現</li>
<li>モジュールによる操作の抽出</li>
<li>コピー式による安全な更新</li>
</ul>
</li>
<li>
<p><strong>タプルによる複数戻り値</strong>：</p>
<ul>
<li><code>Board * bool</code> で最終盤面と全消しフラグを返す</li>
<li>パターンマッチングで分解して利用</li>
<li>F# の簡潔な複数値の扱い</li>
</ul>
</li>
<li>
<p><strong>条件分岐によるボーナス加算</strong>：</p>
<ul>
<li>if 式による全消しチェック</li>
<li>全消しの場合のみボーナス加算</li>
<li>不変性を保ちながら状態更新</li>
</ul>
</li>
<li>
<p><strong>View への統合</strong>：</p>
<ul>
<li>スコア表示の追加</li>
<li>リアルタイムなスコア更新</li>
<li>プレイヤーへのフィードバック</li>
</ul>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
<ul>
<li>全消しになるケースとならないケースの両方をテスト</li>
<li>スコア管理の基本機能をテスト</li>
<li>統合テストで全体の動作を保証</li>
</ul>
</li>
<li>
<p><strong>F# の表現力</strong>：</p>
<ul>
<li><code>Array.forall</code> による宣言的な全要素チェック</li>
<li>タプルによる複数戻り値の簡潔な表現</li>
<li>パターンマッチングによる値の取り出し</li>
</ul>
</li>
</ol>
<p>このイテレーションで、全消しボーナスという特別な報酬システムが実装できました。次のイテレーションでは、ゲームの終了条件となるゲームオーバー判定を実装していきます！</p>
<h2 id="9">イテレーション9: ゲームオーバーの実装<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>「ゲームが終わる条件も必要ですよね？」そうですね！どんなゲームにも終わりがあります。ぷよぷよでは、新しいぷよを配置できなくなったときにゲームオーバーとなります。今回は、そのゲームオーバー判定と演出を実装していきましょう！</p>
<h3 id="_81">ユーザーストーリー<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。ゲームオーバーになったことを明確に伝え、適切な演出を行うことで、プレイヤーに達成感や次回への意欲を持ってもらうことができます。</p>
<h3 id="todo_8">TODOリスト<a class="headerlink" href="#todo_8" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ゲームオーバーを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出する）</li>
<li>ゲームオーバー状態を Model に追加する（ゲーム状態の管理）</li>
<li>ゲームオーバー演出を実装する（ゲームオーバー時に特別な表示を追加する）</li>
<li>リスタート機能を実装する（ゲームオーバー後に新しいゲームを始められるようにする）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_82">テスト: ゲームオーバー判定<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバー判定をテストしましょう。新しいぷよを配置できない状態を検出する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/GameLogicTests.fs（新規作成）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.GameLogicTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Domain.GameLogic</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``新しいぷよを配置できない場合、ゲームオーバーになる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ボードの上部（新しいぷよが配置される位置）にぷよを配置</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよペア（通常は x=2, y=0 と x=2, y=1 に配置される）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになっていることを確認</span>
<span class="w">    </span><span class="n">isGameOver</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">true</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``新しいぷよを配置できる場合、ゲームオーバーにならない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 空のボード</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">    </span><span class="c1">// 新しいぷよペア</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span>

<span class="w">    </span><span class="c1">// ゲームオーバーにならないことを確認</span>
<span class="w">    </span><span class="n">isGameOver</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>新しいぷよの配置位置にすでにぷよがある場合、ゲームオーバーと判定されるか</li>
<li>新しいぷよの配置位置が空の場合、ゲームオーバーにならないか</li>
</ol>
<p>「最初のテストでは、ボードの上部にぷよを配置しているんですね？」そうです！新しいぷよが配置される位置（x=2, y=0 など）にすでにぷよがあると、新しいぷよを配置できないため、ゲームオーバーと判定されるはずです。</p>
<p>「なるほど、ゲームオーバー判定の条件がよく分かりますね！」では、このテストが通るように実装していきましょう。</p>
<h3 id="_83">実装: ゲームオーバー判定<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームオーバー判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/GameLogic.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">GameLogic</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// ゲームオーバー判定（新しいぷよを配置できるかチェック）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">checkGameOver</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">newPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// 新しいぷよが配置できない場合はゲームオーバー</span>
<span class="w">        </span><span class="ow">not</span><span class="w"> </span><span class="o">(</span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span><span class="o">)</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。ゲームオーバー判定の実装自体はとてもシンプルです。既存の <code>canPlacePuyoPair</code> 関数を利用して、新しいぷよが配置できるかをチェックし、配置できない場合はゲームオーバーと判定します。</p>
<p>「<code>canPlacePuyoPair</code> をそのまま使えるんですね！」その通りです！<code>canPlacePuyoPair</code> は、ぷよペアが配置可能かどうかを判定する関数で、これまでの実装で既に存在しています。この関数が <code>false</code> を返す場合（配置できない）、それは新しいぷよを置けない、つまりゲームオーバーということになります。</p>
<h3 id="gamestatus-gameover">GameStatus への GameOver 追加<a class="headerlink" href="#gamestatus-gameover" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー状態を表すために、<code>GameStatus</code> 型に <code>GameOver</code> を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/GameStatus.fs（修正）</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="nn">WPF</span><span class="p">.</span><span class="n">Domain</span>

<span class="k">type</span><span class="w"> </span><span class="nc">GameStatus</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span><span class="w">  </span><span class="c1">// ← 追加</span>
</code></pre></div>
<h3 id="message-restart">Message への Restart 追加<a class="headerlink" href="#message-restart" title="Permanent link">&para;</a></h3>
<p>リスタート機能のために、新しいメッセージを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の Message 型を修正</span>

<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartFastFall</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StopFastFall</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Restart</span><span class="w">  </span><span class="c1">// ← 追加</span>
</code></pre></div>
<h3 id="update_11">update 関数の修正<a class="headerlink" href="#update_11" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー判定とリスタート処理を update 関数に追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の update 関数を修正</span>

<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Restart</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ゲームを初期状態に戻す</span>
<span class="w">        </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 着地処理</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>

<span class="w">                </span><span class="c1">// 連鎖処理（消去と重力を繰り返し適用）</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">boardAfterChain</span><span class="o">,</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">boardWithPuyo</span>

<span class="w">                </span><span class="c1">// 全消しの場合はボーナス加算</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">newScore</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="nn">Score</span><span class="p">.</span><span class="n">addZenkeshiBonus</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Score</span>
<span class="w">                    </span><span class="k">else</span>
<span class="w">                        </span><span class="n">model</span><span class="o">.</span><span class="n">Score</span>

<span class="w">                </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>

<span class="w">                </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">boardAfterChain</span><span class="w"> </span><span class="n">nextPiece</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">isGameOver</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1">// ゲームオーバー</span>
<span class="w">                    </span><span class="o">{</span>
<span class="w">                        </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterChain</span>
<span class="w">                            </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">                            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newScore</span>
<span class="w">                            </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameOver</span>
<span class="w">                    </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// ゲーム続行</span>
<span class="w">                    </span><span class="o">{</span>
<span class="w">                        </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterChain</span>
<span class="w">                            </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newScore</span>
<span class="w">                    </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ゲームオーバー時は何もしない</span>
<span class="w">        </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="c1">// ... 既存のコード（MoveLeft, MoveRight, Rotate, MoveDown, StartFastFall, StopFastFall）...</span>
</code></pre></div>
<p>「ゲームオーバーになったら、CurrentPiece を None にするんですね！」そうです。ゲームオーバー時は、新しいぷよを配置できないため、<code>CurrentPiece</code> を <code>None</code> にします。また、Status を <code>GameOver</code> に変更することで、ゲームループが停止します。</p>
<h3 id="subscription">Subscription の修正<a class="headerlink" href="#subscription" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー時はタイマーを停止するように修正します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の Subscription.gameTimer を修正</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Subscription</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">gameTimer</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Sub</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">IsFastFalling</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">100</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">sub</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="nn">Timers</span><span class="p">.</span><span class="n">Timer</span><span class="o">(</span><span class="n">interval</span><span class="o">)</span>
<span class="w">                </span><span class="n">timer</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Tick</span><span class="o">)</span>
<span class="w">                </span><span class="n">timer</span><span class="o">.</span><span class="n">Start</span><span class="bp">()</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IDisposable</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="k">member</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="nf">Dispose</span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="o">.</span><span class="n">Stop</span><span class="bp">()</span><span class="o">;</span><span class="w"> </span><span class="n">timer</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">[</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;gameTimer&quot;</span><span class="w"> </span><span class="o">],</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="bp">[]</span><span class="w">  </span><span class="c1">// GameOver 時はタイマーなし</span>
</code></pre></div>
<p>「Status が Playing のときだけタイマーが動くんですね！」そうです。ゲームオーバー時は、Status が <code>GameOver</code> になるため、タイマーが停止し、Tick メッセージが送られなくなります。</p>
<h3 id="view_4">View への統合<a class="headerlink" href="#view_4" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー演出と リスタートボタンを view に追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の view 関数を修正</span>

<span class="k">let</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;font-family: monospace; text-align: center; padding: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">h1</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ&quot;</span><span class="w"> </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// スコア表示</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-bottom: 10px; font-size: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">text</span><span class="w"> </span><span class="o">$</span><span class="s">&quot;Score: {model.Score.Value}&quot;</span>
<span class="w">        </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// ゲームオーバー表示</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-bottom: 20px; font-size: 30px; color: red; font-weight: bold;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;GAME OVER&quot;</span>
<span class="w">            </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// ゲームボード</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;display: inline-block; border: 2px solid black; background-color: #f0f0f0;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;display: flex;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">match</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;white&quot;</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="n">puyoColor</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="k">match</span><span class="w"> </span><span class="n">puyoColor</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>

<span class="w">                        </span><span class="c1">// 現在のぷよペアを描画（ゲームオーバー時は表示しない）</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">isPuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="o">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="o">,</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                                </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">false</span>

<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">finalColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="n">isPuyoPair</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                        </span><span class="k">match</span><span class="w"> </span><span class="n">piece</span><span class="o">.</span><span class="n">Puyo1Color</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>
<span class="w">                                    </span><span class="k">elif</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                        </span><span class="k">match</span><span class="w"> </span><span class="n">piece</span><span class="o">.</span><span class="n">Puyo2Color</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>
<span class="w">                                    </span><span class="k">else</span>
<span class="w">                                        </span><span class="n">color</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">color</span>
<span class="w">                            </span><span class="k">else</span>
<span class="w">                                </span><span class="n">color</span>

<span class="w">                        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span>
<span class="w">                            </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="o">$</span><span class="s">&quot;width: 30px; height: 30px; border: 1px solid #ccc; background-color: {finalColor};&quot;</span>
<span class="w">                        </span><span class="o">]</span><span class="w"> </span><span class="bp">[]</span>
<span class="w">                </span><span class="o">]</span>
<span class="w">        </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// リスタートボタン（ゲームオーバー時のみ表示）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-top: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                </span><span class="n">button</span><span class="w"> </span><span class="o">[</span>
<span class="w">                    </span><span class="n">on</span><span class="o">.</span><span class="n">click</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Restart</span><span class="o">)</span>
<span class="w">                    </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;padding: 10px 20px; font-size: 16px; cursor: pointer;&quot;</span>
<span class="w">                </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;Restart&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">            </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// 操作説明</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-top: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;← → : 移動&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↑ : 回転&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↓ : 高速落下&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="o">]</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「ゲームオーバー時には "GAME OVER" と表示されて、リスタートボタンが出るんですね！」そうです。プレイヤーにゲームが終了したことを明確に伝え、新しいゲームを始めるためのボタンを提供します。</p>
<h3 id="_84">テスト実行<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストは通りましたか？」はい！ゲームオーバー判定のテストを含めて、全てのテストがパスしました。</p>
<h3 id="_85">統合テスト<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー機能が正しく動作することを確認する統合テストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/GameLogicTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアの回転位置も考慮してゲームオーバー判定する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ボードの上部にぷよを配置</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span><span class="w">  </span><span class="c1">// 回転後の位置にぷよがある</span>

<span class="w">    </span><span class="c1">// 縦向きのぷよペア（Rotation = 0 なら y=0 と y=1 に配置される）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになっていることを確認</span>
<span class="w">    </span><span class="n">isGameOver</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">true</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよが盤面の上部ギリギリでもゲームオーバーにならない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ボードの下の方にぷよを配置</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよペア（上部に配置される）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span>

<span class="w">    </span><span class="c1">// ゲームオーバーにならないことを確認</span>
<span class="w">    </span><span class="n">isGameOver</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>
</code></pre></div>
<p>「これらのテストは何を確認しているんですか？」これらのテストでは、以下を確認しています：</p>
<ol>
<li><strong>回転位置の考慮</strong>：ぷよペアの回転状態（Rotation）も考慮してゲームオーバー判定が行われるか</li>
<li><strong>境界条件</strong>：盤面の上部ギリギリにぷよがあってもゲームオーバーにならないか</li>
</ol>
<p>「なるほど、<code>canPlacePuyoPair</code> が回転も考慮するから、自動的に正しく判定されるんですね！」そうです。既存の関数を再利用することで、複雑なロジックを書かずに正確な判定ができています。</p>
<h3 id="_86">コミット<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>テストが全て通ったら、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">feat: implement game over detection and restart</span>

<span class="s">- Add checkGameOver function to GameLogic module</span>
<span class="s">- Add GameOver state to GameStatus type</span>
<span class="s">- Add Restart message for restarting the game</span>
<span class="s">- Update update function to check game over after landing</span>
<span class="s">- Stop game timer when status is GameOver</span>
<span class="s">- Add &quot;GAME OVER&quot; display to view</span>
<span class="s">- Add restart button that appears on game over</span>
<span class="s">- Add tests for game over detection (4 tests)</span>
<span class="s">- All tests passing (67 tests)</span>

<span class="s">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;</span>
<span class="s">EOF</span>
<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="9_1">イテレーション９のまとめ<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li>
<p><strong>ゲームオーバー判定の実装</strong>：</p>
<ul>
<li>既存の <code>canPlacePuyoPair</code> 関数を再利用</li>
<li>シンプルなロジックで確実な判定を実現</li>
<li>回転状態も自動的に考慮される</li>
</ul>
</li>
<li>
<p><strong>GameStatus の拡張</strong>：</p>
<ul>
<li><code>GameOver</code> 状態を追加</li>
<li>判別共用体による安全な状態管理</li>
<li>パターンマッチングで状態に応じた処理</li>
</ul>
</li>
<li>
<p><strong>Elmish のメッセージ追加</strong>：</p>
<ul>
<li><code>Restart</code> メッセージでゲームリセット</li>
<li><code>init ()</code> を呼び出して初期状態に戻す</li>
<li>シンプルなリスタート実装</li>
</ul>
</li>
<li>
<p><strong>Subscription の制御</strong>：</p>
<ul>
<li>Status に応じてタイマーを制御</li>
<li>GameOver 時はタイマーを停止</li>
<li>リソースの適切な管理</li>
</ul>
</li>
<li>
<p><strong>View の条件分岐</strong>：</p>
<ul>
<li>if 式によるゲームオーバー表示</li>
<li>Status に応じた UI の切り替え</li>
<li>リスタートボタンの表示制御</li>
</ul>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
<ul>
<li>ゲームオーバーになるケースとならないケースをテスト</li>
<li>回転位置を考慮したテスト</li>
<li>境界条件のテスト</li>
</ul>
</li>
<li>
<p><strong>F# の表現力</strong>：</p>
<ul>
<li>判別共用体による状態管理</li>
<li>パターンマッチングによる分岐</li>
<li>if 式による条件付き View 要素</li>
</ul>
</li>
</ol>
<p>このイテレーションで、ゲームオーバー判定とリスタート機能が実装できました。これで、ぷよぷよゲームの基本的な機能が完成しました！</p>
<h2 id="f-elmishwpf_1">まとめ: F# と Elmish.WPF で学ぶテスト駆動開発<a class="headerlink" href="#f-elmishwpf_1" title="Permanent link">&para;</a></h2>
<p>「ついに完成しましたね!」そうです!イテレーション 0 から 9 まで、一緒にぷよぷよゲームを作ってきました。お疲れ様でした!このチュートリアルを通じて、F# と Elmish.WPF を使ったテスト駆動開発の実践を学んできました。</p>
<h3 id="elmishwpf_3">Elmish.WPF の強み<a class="headerlink" href="#elmishwpf_3" title="Permanent link">&para;</a></h3>
<p>このチュートリアルを通じて、Elmish.WPF の強みを実感できたと思います:</p>
<p><strong>デスクトップアプリケーション開発</strong>:
- ネイティブな Windows アプリケーション
- WPF の成熟した UI コントロール
- ハードウェアアクセラレーション</p>
<p><strong>XAML との統合</strong>:
- 宣言的な UI 定義
- データバインディングによる自動更新
- デザイナーとの分業が可能</p>
<p><strong>Elmish アーキテクチャ</strong>:
- シンプルな状態管理
- 予測可能な動作
- デバッグのしやすさ</p>
<h3 id="bolero">Bolero 版との比較<a class="headerlink" href="#bolero" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>観点</th>
<th>Bolero 版</th>
<th>Elmish.WPF 版</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>実行環境</strong></td>
<td>ブラウザ(WebAssembly)</td>
<td>Windows デスクトップ</td>
</tr>
<tr>
<td><strong>UI定義</strong></td>
<td>Bolero.Html(F#コード)</td>
<td>XAML</td>
</tr>
<tr>
<td><strong>イベント処理</strong></td>
<td>on.click, on.keydown</td>
<td>Command バインディング</td>
</tr>
<tr>
<td><strong>スタイル</strong></td>
<td>CSS</td>
<td>XAML Resources/Styles</td>
</tr>
<tr>
<td><strong>配布</strong></td>
<td>Web サーバー</td>
<td>インストーラー/実行ファイル</td>
</tr>
<tr>
<td><strong>起動速度</strong></td>
<td>初回ロード時間あり</td>
<td>即座に起動</td>
</tr>
</tbody>
</table>
<p><strong>Elmish.WPF 版の利点</strong>:
- デスクトップアプリケーションとして配布可能
- WPF の豊富な UI コントロール
- ネイティブなパフォーマンス
- オフラインでの動作</p>
<p><strong>Bolero 版の利点</strong>:
- クロスプラットフォーム(ブラウザがあれば動く)
- インストール不要
- Web での配布が容易</p>
<p>このチュートリアルが、あなたのソフトウェア開発の旅の一助となれば幸いです。Happy coding!</p>
<hr />
<p><strong>著者より</strong>: このチュートリアルは、テスト駆動開発と関数型プログラミングの素晴らしさを伝えたいという思いから作成しました。質問やフィードバックがあれば、ぜひお気軽にお寄せください。一緒に学び、成長していきましょう!</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>