
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 - Kotlin Compose Multiplatform 編 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#-kotlin-compose-multiplatform" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 - Kotlin Compose Multiplatform 編
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="-kotlin-compose-multiplatform">ぷよぷよから始めるテスト駆動開発入門 - Kotlin Compose Multiplatform 編<a class="headerlink" href="#-kotlin-compose-multiplatform" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、Kotlin Compose Multiplatform でぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説:テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの？」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう:</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それが TDD のマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzQzcHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc0MyA2NTEiIHdpZHRoPSI3NDNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSI0MDEiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzIxIiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMyMSIgeDI9IjQ4MC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMzEiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTYzIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NjMiIHgyPSI3MzYuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTczIiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00MDEsMjYuMzYgQzQwMSw0MC4yOSA0MDEsNjAuOTYgNDAxLDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDAxLDg2LjY1LDQwNSw3Ny42NSw0MDEsODEuNjUsMzk3LDc3LjY1LDQwMSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMyMC42MywxMTkuMzcgQzI4OC45NiwxMjYuMjkgMjU1LjU1LDE0MC4wNCAyMzYsMTY3IEMyMTcuNDUsMTkyLjU5IDI1Mi40MjQ0LDIxMi41Mjg3IDI4My40MTQ0LDIyNS4wMDg3IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljk4LDIyNy4yNSwyODIuMTI1OCwyMjAuMTc3NiwyODQuMzQyLDIyNS4zODIyLDI3OS4xMzczLDIyNy41OTg0LDI4OC45OCwyMjcuMjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjAuNTQ4NCIgeD0iMjM3IiB5PSIxODAuMDY2OSI+VE9ETyAmIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyNDM0OyYjMjAzMTY7JiMyNTEwNDs8L3RleHQ+PC9nPjwhLS1saW5rIFRPRE8gdG8gPz8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJUT0RPIiBkYXRhLWVudGl0eS0yPSIuLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImxuazE1IiBpZD0ibGlua19UT0RPXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zNDAuMywyMTMuNjEgQzM0Ny40OCwyMDQuNTUgMzU1LjQxLDE5NC4wMyAzNjIsMTg0IEMzNzEuODksMTY4Ljk2IDM3OC44NzAzLDE1Ni41MzI1IDM4Ni4xNTAzLDE0Mi41NDI1IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzg4LjkyLDEzNy4yMiwzODEuMjE3MiwxNDMuMzU3MywzODYuNjExOSwxNDEuNjU1NCwzODguMzEzOCwxNDcuMDUwMiwzODguOTIsMTM3LjIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjI0LjU0ODYiIHg9IjM3My41MiIgeT0iMTgwLjA2NjkiPlRPRE8gJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzMDYuNjgwOSIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1OyBUT0RPICYjMTI1MjI7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMyNTE0NzsmIzEyNDI3OzwvdGV4dD48L2c+PCEtLWxpbmsgPz8/Pz8/Pz8/PyB0byA/Pz8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSIuLi4uLi4uLi4uIiBkYXRhLWVudGl0eS0yPSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTIiIGRhdGEtdWlkPSJsbmsxNyIgaWQ9ImxpbmtfLi4uLi4uLi4uLl8uLi4uLi4uLi4uLiI+PHBhdGggZD0iTTQ4MS4yOCwxMTkuNjggQzUyMi4xOCwxMjYuNDMgNTcwLjc4LDEzOS45NiA2MDcsMTY3IEM2MjIuNzEsMTc4LjczIDYzMS4zOTE1LDE5Mi41NjEzIDYzOC40MDE1LDIwOC4wOTEzIiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tJiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjQwLjg3LDIxMy41Niw2NDAuODEzMSwyMDMuNzExMyw2MzguODEyOSwyMDkuMDAyOCw2MzMuNTIxNSwyMDcuMDAyNiw2NDAuODcsMjEzLjU2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1TUkM9W1pQQkRKaTkwNThOdFZPZ2tKTlcxNXd2Q045OE9UeVE1cVJoS1hGVzB0M2tIN3diMks0QWc5OEhHSE81SzMwaTVMMXhjcURBLVhKQ2pHZ0VZaDJQcHBwVmRkam14a3NqeFVZQW5lT0Z4NDZ5R01OMEplV19rV0h1V0NrMDFINHh4TW11VFRmQVJJTnF6RVkzUWFHOGtKenZoTmd3YVhOTjVSSGs3NGZrX2JPSHQtbWVnUWFmR201UkFDOHVidWpOSVJneU9NMk1HdXBmcmx0Y2NITEJhU2hIX1M3Z0kyZ3RRNDFMbTBfbTQ3ZVROYkwyUkN1a3NOaFNYdFBPcVp3VVlaY2lfVXZNZ3pmS2NCV05mNnQzWGJ0cG5MQkU5dlFLUVAyenlNdXdrNzVZc1VwYTJMSzd0Z3lNVUpOS1AzMzlUbnZtQ0N3NWQ3UHBfbFczZ1VCY0hKQmpPbTMteF9CNTJDZ1VGRy1hM2FmSzJ3MEZLY1d2d3U3RF9WMHNvTGxhU081aUxINVUxXzBCSEtnMndOYTdTb1U4ZF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます:</p>
<ul>
<li><strong>言語</strong>: Kotlin — 「Java だけじゃダメなの？」と思われるかもしれませんが、Kotlin は簡潔で安全な構文で、マルチプラットフォーム開発をサポートしてくれるモダンな言語です。</li>
<li><strong>UI フレームワーク</strong>: Compose Multiplatform — Android、iOS、デスクトップ、Web で動作する UI を一つのコードベースで書けます。「一度書いてどこでも動く」は魅力的ですよね！</li>
<li><strong>ビルドツール</strong>: Gradle — Kotlin プロジェクトの標準ビルドツールです。依存関係管理からビルド、テスト実行まで面倒を見てくれます。</li>
<li><strong>テストフレームワーク</strong>: JUnit — Java/Kotlin のデファクトスタンダードなテストフレームワークです。テスト駆動開発には欠かせないツールですね。</li>
<li><strong>静的コード解析</strong>: Detekt — Kotlin のコード品質をチェックしてくれます。「コードレビュアー代わりになってくれる」と思うと便利ですよね。</li>
<li><strong>コードフォーマッタ</strong>: ktlint — Kotlin の公式スタイルガイドに準拠したフォーマッタです。「コードの見た目を統一するのって大事ですよね！」</li>
<li><strong>コードカバレッジ</strong>: JaCoCo — テストがどれだけコードをカバーしているか測定してくれます。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ？昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが、手順に従って進めればそんなに難しいことではありません。詳細はイテレーション 0: 環境の構築で解説します。</p>
<h3 id="kotlin-compose-multiplatform">Kotlin と Compose Multiplatform について<a class="headerlink" href="#kotlin-compose-multiplatform" title="Permanent link">&para;</a></h3>
<p>さて、ここで「Kotlin って何？」「Compose Multiplatform ってどういうもの？」と疑問に思われる方もいらっしゃるかもしれませんね。少し詳しく見ていきましょう。</p>
<h4 id="kotlin">Kotlin とは<a class="headerlink" href="#kotlin" title="Permanent link">&para;</a></h4>
<p><strong>Kotlin</strong> は JetBrains 社が開発した、Java プラットフォーム上で動作するモダンなプログラミング言語です。2011 年に発表され、2017 年には Google が Android の公式開発言語として採用したことで大きな注目を集めました。</p>
<p>「Java とどう違うの？」と思われるかもしれませんね。Kotlin の特徴を見てみましょう:</p>
<h5 id="kotlin_1">Kotlin の主な特徴<a class="headerlink" href="#kotlin_1" title="Permanent link">&para;</a></h5>
<ol>
<li><strong>簡潔な構文</strong></li>
<li>Java よりも少ないコードで同じ機能を実現できます</li>
<li>
<p>ボイラープレート（定型的なコード）が大幅に削減されます</p>
</li>
<li>
<p><strong>Null 安全性</strong></p>
</li>
<li>Null ポインタ例外を型システムレベルで防ぎます</li>
<li>
<p>「あれ？Null で落ちた...」という経験、ありませんか？Kotlin ならコンパイル時に検出できるんです</p>
</li>
<li>
<p><strong>関数型プログラミングのサポート</strong></p>
</li>
<li>高階関数、ラムダ式、イミュータブルなデータ構造をサポート</li>
<li>
<p>「関数を変数のように扱える」って便利ですよね！</p>
</li>
<li>
<p><strong>Java との相互運用性</strong></p>
</li>
<li>既存の Java ライブラリをそのまま使用できます</li>
<li>
<p>Java プロジェクトに段階的に導入することも可能です</p>
</li>
<li>
<p><strong>マルチプラットフォーム対応</strong></p>
</li>
<li>JVM、JavaScript、ネイティブコードへのコンパイルが可能</li>
<li>一度書いたコードを複数のプラットフォームで実行できます</li>
</ol>
<h5 id="kotlin_2">Kotlin のコード例<a class="headerlink" href="#kotlin_2" title="Permanent link">&para;</a></h5>
<p>Java と Kotlin の比較を見てみましょう。同じ機能を実装するのに、こんなに違いがあるんです:</p>
<p><strong>Java での実装:</strong>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stageWidth</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stageHeight</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">puyoSize</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Config</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">puyoSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getStageWidth</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stageWidth</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getStageHeight</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stageHeight</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getPuyoSize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">puyoSize</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p><strong>Kotlin での実装:</strong>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageWidth</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageHeight</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">puyoSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32</span>
<span class="p">}</span>
</code></pre></div></p>
<p>「こんなに短くなるの！？」と驚かれるかもしれませんね。Kotlin では getter や setter、コンストラクタが自動生成されるため、本質的なコードだけに集中できるんです。</p>
<h4 id="compose-multiplatform">Compose Multiplatform とは<a class="headerlink" href="#compose-multiplatform" title="Permanent link">&para;</a></h4>
<p><strong>Compose Multiplatform</strong> は、JetBrains 社が開発した、宣言的 UI フレームワークです。Google の Android 向け UI ツールキット「Jetpack Compose」をベースに、マルチプラットフォーム対応を実現しています。</p>
<p>「宣言的 UI って何？」と思われるかもしれませんね。従来の命令的な UI 構築と比較してみましょう:</p>
<h5 id="ui-vs-ui">命令的 UI vs 宣言的 UI<a class="headerlink" href="#ui-vs-ui" title="Permanent link">&para;</a></h5>
<p><strong>命令的 UI（従来の方法）:</strong>
<div class="highlight"><pre><span></span><code><span class="c1">// 「どうやって」UIを変更するかを記述</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Button</span><span class="p">()</span>
<span class="n">button</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;クリック&quot;</span>
<span class="n">button</span><span class="p">.</span><span class="na">setOnClickListener</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">button</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;クリック済み&quot;</span>
<span class="p">}</span>
</code></pre></div></p>
<p><strong>宣言的 UI（Compose の方法）:</strong>
<div class="highlight"><pre><span></span><code><span class="c1">// 「何を」表示するかを記述</span>
<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">MyButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">clicked</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Button</span><span class="p">(</span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">clicked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Text</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clicked</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;クリック済み&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s">&quot;クリック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>宣言的 UI では、「UI がどうあるべきか」を記述するだけで、「どうやって変更するか」は Compose が自動的に処理してくれるんです。便利ですよね！</p>
<h5 id="compose-multiplatform_1">Compose Multiplatform の主な特徴<a class="headerlink" href="#compose-multiplatform_1" title="Permanent link">&para;</a></h5>
<ol>
<li><strong>単一のコードベース</strong></li>
<li>Android、iOS、デスクトップ、Web で同じコードが動作します</li>
<li>
<p>「一度書いてどこでも動く（Write Once, Run Anywhere）」を実現</p>
</li>
<li>
<p><strong>宣言的 UI</strong></p>
</li>
<li>UI の状態と表示が常に同期されます</li>
<li>
<p>「あれ？画面が更新されない...」という問題が減ります</p>
</li>
<li>
<p><strong>Kotlin との完全な統合</strong></p>
</li>
<li>Kotlin の言語機能をフルに活用できます</li>
<li>
<p>型安全で、コンパイル時にエラーを検出できます</p>
</li>
<li>
<p><strong>ホットリロード</strong></p>
</li>
<li>コードを変更すると即座に画面に反映されます</li>
<li>
<p>「ビルドして実行して確認して...」の繰り返しから解放されます</p>
</li>
<li>
<p><strong>Material Design 3 サポート</strong></p>
</li>
<li>Google の最新デザインガイドラインに準拠した UI コンポーネントが使えます</li>
</ol>
<h5 id="compose-multiplatform_2">Compose Multiplatform のコード例<a class="headerlink" href="#compose-multiplatform_2" title="Permanent link">&para;</a></h5>
<p>Compose でぷよぷよのゲーム画面を作るとこんな感じになります:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">GameScreen</span><span class="p">(</span><span class="n">game</span><span class="p">:</span><span class="w"> </span><span class="n">Game</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Column</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">        </span><span class="n">horizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">CenterHorizontally</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// スコア表示</span>
<span class="w">        </span><span class="n">Text</span><span class="p">(</span>
<span class="w">            </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">value</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">headlineMedium</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1">// ゲームフィールド</span>
<span class="w">        </span><span class="n">Canvas</span><span class="p">(</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">                </span><span class="p">.</span><span class="na">size</span><span class="p">(</span>
<span class="w">                    </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">).</span><span class="na">dp</span><span class="p">,</span>
<span class="w">                    </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">).</span><span class="na">dp</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ぷよを描画</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">val</span><span class="w"> </span><span class="nv">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">drawPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">)</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「読みやすい！」と思いませんか？Compose では UI の構造がそのままコードの構造になるんです。</p>
<h5 id="_4">なぜマルチプラットフォームが重要なのか<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h5>
<p>「でも、ぷよぷよゲームを作るだけなら、一つのプラットフォームだけでいいんじゃない？」と思われるかもしれませんね。確かにそうなんですが、マルチプラットフォーム対応には大きなメリットがあるんです:</p>
<ol>
<li><strong>開発コストの削減</strong></li>
<li>プラットフォームごとにコードを書く必要がありません</li>
<li>
<p>一つの変更が全プラットフォームに反映されます</p>
</li>
<li>
<p><strong>一貫したユーザー体験</strong></p>
</li>
<li>どのプラットフォームでも同じ操作感</li>
<li>
<p>バグ修正や機能追加が全プラットフォームで同時に適用されます</p>
</li>
<li>
<p><strong>チーム効率の向上</strong></p>
</li>
<li>iOS チーム、Android チーム、Web チームと分ける必要がありません</li>
<li>
<p>一つのチームで全プラットフォームをカバーできます</p>
</li>
<li>
<p><strong>技術スタックの統一</strong></p>
</li>
<li>Kotlin という一つの言語を習得すれば、どのプラットフォームでも開発できます</li>
<li>「iOS は Swift、Android は Kotlin、Web は TypeScript...」という複雑さから解放されます</li>
</ol>
<h5 id="compose-multiplatform_3">Compose Multiplatform のアーキテクチャ<a class="headerlink" href="#compose-multiplatform_3" title="Permanent link">&para;</a></h5>
<p>Compose Multiplatform の構成を見てみましょう:</p>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────────┐
│     共通ビジネスロジック (commonMain)     │
│  - ゲームロジック、スコア計算、ぷよの移動  │
└─────────────────────────────────────────┘
              ↓ 共有 ↓
┌─────────────────────────────────────────┐
│        共通 UI (commonMain)              │
│  - Compose UI コンポーネント             │
│  - 画面レイアウト、描画ロジック           │
└─────────────────────────────────────────┘
              ↓ 共有 ↓
┌──────┬──────────┬──────────┬──────────┐
│Android│  iOS     │ Desktop  │   Web    │
│ 固有  │  固有     │  固有     │   固有    │
└──────┴──────────┴──────────┴──────────┘
</code></pre></div>
<p>「ほとんどのコードが共有できる」って素晴らしいですよね！</p>
<h4 id="_5">テスト駆動開発との相性<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>「テスト駆動開発と Kotlin Compose Multiplatform って相性いいの？」と疑問に思われるかもしれませんね。実は、とても相性がいいんです！</p>
<ol>
<li><strong>強力な型システム</strong></li>
<li>コンパイル時に多くのエラーを検出できます</li>
<li>
<p>テストで見つける前に問題を発見できることが多いんです</p>
</li>
<li>
<p><strong>関数型プログラミング</strong></p>
</li>
<li>純粋関数（副作用のない関数）を書きやすい</li>
<li>
<p>純粋関数はテストが簡単なんです</p>
</li>
<li>
<p><strong>宣言的 UI</strong></p>
</li>
<li>UI のテストが状態のテストに置き換えられます</li>
<li>
<p>「この状態ならこの UI」という形でテストできます</p>
</li>
<li>
<p><strong>マルチプラットフォーム対応</strong></p>
</li>
<li>共通のテストコードを書けば、全プラットフォームでテストできます</li>
<li>「一度書いたテストがどこでも動く」んです</li>
</ol>
<p>これらの特徴により、Kotlin Compose Multiplatform はテスト駆動開発に最適な環境と言えるんです。私たちはこの環境で、安心してぷよぷよゲームを開発していけるんですよ！</p>
<h2 id="_6">要件<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="_7">ユーザーストーリー<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。
ユーザーストーリーには形式が定められておらず、標準的な記法もない。とはいえ、次のような形式でストーリーを考えてみると便利である。「＜ユーザーの種類＞として、＜機能や性能＞がほしい。それは＜ビジネス価値＞のためだ」という形のテンプレートに従うと、
たとえば次のようなストーリーを書ける。「本の購入者として、ISBN で本を検索したい。それは探している本をすばやく見つけるためだ」</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう:</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを 4 つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜ん！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PC でプレイするなら必須ですよね）</li>
<li>プレイヤーとして、タッチ操作でぷよを操作できる（スマホでもプレイしたいですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_8">ユースケース図<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>ユーザーストーリーを整理したところで、「これらの機能がどのように関連しているのか、全体像が見えるといいな」と思いませんか？そんなときに役立つのが「ユースケース図」です。「ユースケース図って何？」と思われるかもしれませんね。ユースケース図は、システムと外部アクター（ここではプレイヤーとシステム自体）の相互作用を視覚的に表現するための図です。「絵に描いて整理すると分かりやすい」というやつですね。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjczNXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTAwOXB4O2hlaWdodDo3MzVweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMDA5IDczNSIgd2lkdGg9IjEwMDlweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iY2x1c3Rlcl8uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU0MSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijg3MS4xNSIgeD0iMTIzIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjUwOS41NzUyIiB5PSIyMS45OTUxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQwNzsmIzEyNDI0OyYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBVQzEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iVUMxIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV9VQzEiPjxlbGxpcHNlIGN4PSIyMTEuMjQ3MyIgY3k9IjU3LjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTc2LjI0NzQiIHk9IjYxLjY1MjEiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMzgyODM7JiMyMjk4Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgVUMyLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlVDMiIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfVUMyIj48ZWxsaXBzZSBjeD0iMjExLjI1MjQiIGN5PSIxMjMuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMTU1LjI1MjciIHk9IjEyNy42NDg5Ij4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzI0MDM4OyYjMjE0OTE7JiMxMjM5NTsmIzMxMjI3OyYjMjEyMDU7PC90ZXh0PjwvZz48IS0tZW50aXR5IFVDMy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJVQzMiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iZW50aXR5X1VDMyI+PGVsbGlwc2UgY3g9IjIxMS4yNDczIiBjeT0iMTg5LjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTc2LjI0NzQiIHk9IjE5My42NTIxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzIyMjM4OyYjMzY1Nzg7PC90ZXh0PjwvZz48IS0tZW50aXR5IFVDNC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJVQzQiIGRhdGEtc291cmNlLWxpbmU9IjEwIiBkYXRhLXVpZD0iZW50MDAwOCIgaWQ9ImVudGl0eV9VQzQiPjxlbGxpcHNlIGN4PSIyMTEuMjUyNCIgY3k9IjI1NS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNTUuMjUyNyIgeT0iMjU5LjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMzIwMzI7JiMyNjA4OTsmIzEyMzY3OyYjMzM4NTM7JiMxOTk3OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgVUM1LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlVDNSIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X1VDNSI+PGVsbGlwc2UgY3g9IjQ2MC45OTczIiBjeT0iMjU1LjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iNDI1Ljk5NzQiIHk9IjI1OS42NTIxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzI4MDQwOyYjMjE0MzU7PC90ZXh0PjwvZz48IS0tZW50aXR5IFVDNi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJVQzYiIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9VQzYiPjxlbGxpcHNlIGN4PSI2NzkuMDk3OCIgY3k9IjQ5Ny4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNDIuNTk3OCIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjY1MS4wOTc5IiB5PSI1MDEuNjUyMSI+JiMzNjg5OTsmIzM3NzgyOyYjMjE0NTM7JiMyNDU0MDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgVUM3LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlVDNyIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5X1VDNyI+PGVsbGlwc2UgY3g9IjkxMS40MTUyIiBjeT0iNTA2Ljk5NSIgZmlsbD0iI0YxRjFGMSIgcng9IjY2LjcyNTIiIHJ5PSIxNS43NDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9Ijg2Mi40MTU0IiB5PSI1MTEuNjQzNSI+JiMyMDg0MDsmIzI4MDQwOyYjMTIzNzU7JiMxMjUwODsmIzEyNTQwOyYjMTI0OTA7JiMxMjQ3Mzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgVUM4LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlVDOCIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDEyIiBpZD0iZW50aXR5X1VDOCI+PGVsbGlwc2UgY3g9IjIxMS4yNDUyIiBjeT0iNTE1Ljk5NSIgZmlsbD0iI0YxRjFGMSIgcng9IjY2LjcyNTIiIHJ5PSIxNS43NDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjE2Mi4yNDU0IiB5PSI1MjAuNjQzNSI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQ1ODsmIzEyNTQwOyYjMTI0OTY7JiMxMjU0MDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgVUM5LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlVDOSIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDEzIiBpZD0iZW50aXR5X1VDOSI+PGVsbGlwc2UgY3g9IjIxMS4yNDczIiBjeT0iMzIxLjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTc2LjI0NzQiIHk9IjMyNS42NTIxIj4mIzEyNDczOyYjMTI0Njc7JiMxMjQ1MDsmIzM0OTIwOyYjMzEwMzQ7PC90ZXh0PjwvZz48IS0tZW50aXR5IFVDMTAtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iVUMxMCIgZGF0YS1zb3VyY2UtbGluZT0iMTYiIGRhdGEtdWlkPSJlbnQwMDE0IiBpZD0iZW50aXR5X1VDMTAiPjxlbGxpcHNlIGN4PSIyMTEuMjQ1MiIgY3k9IjM4NS45OTUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI2Ni43MjUyIiByeT0iMTUuNzQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIxNjIuMjQ1NCIgeT0iMzkwLjY0MzUiPiYjMTI0NjE7JiMxMjU0MDsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ4OTsmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IFVDMTEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iVUMxMSIgZGF0YS1zb3VyY2UtbGluZT0iMTciIGRhdGEtdWlkPSJlbnQwMDE1IiBpZD0iZW50aXR5X1VDMTEiPjxlbGxpcHNlIGN4PSIyMTEuMjQ3MyIgY3k9IjQ1MS4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjE3Ni4yNDc0IiB5PSI0NTUuNjUyMSI+JiMxMjQ3OTsmIzEyNDgzOyYjMTI0ODE7JiMyNTgwNTsmIzIwMzE2OzwvdGV4dD48L2c+PCEtLWVudGl0eSBwbGF5ZXItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icGxheWVyIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImVudGl0eV9wbGF5ZXIiPjxlbGxpcHNlIGN4PSI0MC45OTk4IiBjeT0iMjI1LjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik00MC45OTk4LDIzMy4zNSBMNDAuOTk5OCwyNjAuMzUgTTI3Ljk5OTgsMjQxLjM1IEw1My45OTk4LDI0MS4zNSBNNDAuOTk5OCwyNjAuMzUgTDI3Ljk5OTgsMjc1LjM1IE00MC45OTk4LDI2MC4zNSBMNTMuOTk5OCwyNzUuMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjYiIHk9IjI4OS44NDUxIj4mIzEyNTAzOyYjMTI1MjQ7JiMxMjQ1MjsmIzEyNTE2OyYjMTI1NDA7PC90ZXh0PjwvZz48IS0tZW50aXR5IHN5c3RlbS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJzeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X3N5c3RlbSI+PGVsbGlwc2UgY3g9IjQwLjk5OTkiIGN5PSI1OTAuMzUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI4IiByeT0iOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTQwLjk5OTksNTk4LjM1IEw0MC45OTk5LDYyNS4zNSBNMjcuOTk5OSw2MDYuMzUgTDUzLjk5OTksNjA2LjM1IE00MC45OTk5LDYyNS4zNSBMMjcuOTk5OSw2NDAuMzUgTTQwLjk5OTksNjI1LjM1IEw1My45OTk5LDY0MC4zNSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMTMiIHk9IjY1NC44NDUxIj4mIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWxpbmsgcGxheWVyIHRvIFVDMS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJwbGF5ZXIiIGRhdGEtZW50aXR5LTI9IlVDMSIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJsbmsxNiIgaWQ9ImxpbmtfcGxheWVyX1VDMSI+PHBhdGggZD0iTTQ5LjQ5LDIxNi40NiBDNTguNzEsMTc4Ljk3IDc3LjkzLDEyMi44NyAxMTUsODkgQzEyOC43OCw3Ni40MSAxNDEuODgzOSw3MC4zMDEgMTU5LjIyMzksNjUuNjYxIiBmaWxsPSJub25lIiBpZD0icGxheWVyLXRvLVVDMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTY1LjAyLDY0LjExLDE1NS4yOTE5LDYyLjU3MjQsMTYwLjE4OTksNjUuNDAyNSwxNTcuMzU5OSw3MC4zMDA1LDE2NS4wMiw2NC4xMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBwbGF5ZXIgdG8gVUMyLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InBsYXllciIgZGF0YS1lbnRpdHktMj0iVUMyIiBkYXRhLXNvdXJjZS1saW5lPSIyMSIgZGF0YS11aWQ9ImxuazE3IiBpZD0ibGlua19wbGF5ZXJfVUMyIj48cGF0aCBkPSJNNjMuMDMsMjE2LjY2IEM3NS43NywxOTYuNSA5My42OCwxNzIuNzcgMTE1LDE1NyBDMTI4LjEzLDE0Ny4yOSAxMzguNjA2MSwxNDIuMDcxOSAxNTMuODY2MSwxMzYuOTExOSIgZmlsbD0ibm9uZSIgaWQ9InBsYXllci10by1VQzIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1OS41NSwxMzQuOTksMTQ5Ljc0MjksMTM0LjA4MzcsMTU0LjgxMzUsMTM2LjU5MTYsMTUyLjMwNTUsMTQxLjY2MjEsMTU5LjU1LDEzNC45OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBwbGF5ZXIgdG8gVUMzLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InBsYXllciIgZGF0YS1lbnRpdHktMj0iVUMzIiBkYXRhLXNvdXJjZS1saW5lPSIyMiIgZGF0YS11aWQ9ImxuazE4IiBpZD0ibGlua19wbGF5ZXJfVUMzIj48cGF0aCBkPSJNNzYuMTksMjM4LjExIEM4OC4zMiwyMzIuMzggMTAyLjE1LDIyNi4xMyAxMTUsMjIxIEMxMzQuNiwyMTMuMTcgMTUxLjIzNjIsMjA3LjQyMTEgMTY5LjM2NjIsMjAxLjYxMTEiIGZpbGw9Im5vbmUiIGlkPSJwbGF5ZXItdG8tVUMzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNzUuMDgsMTk5Ljc4LDE2NS4yODg2LDE5OC43MTc0LDE3MC4zMTg1LDIwMS4zMDU5LDE2Ny43MywyMDYuMzM1OCwxNzUuMDgsMTk5Ljc4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIHBsYXllciB0byBVQzQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0icGxheWVyIiBkYXRhLWVudGl0eS0yPSJVQzQiIGRhdGEtc291cmNlLWxpbmU9IjIzIiBkYXRhLXVpZD0ibG5rMTkiIGlkPSJsaW5rX3BsYXllcl9VQzQiPjxwYXRoIGQ9Ik03Ni40NSwyNTUgQzk0LjQzLDI1NSAxMTEuMTMsMjU1IDEzMi42OSwyNTUiIGZpbGw9Im5vbmUiIGlkPSJwbGF5ZXItdG8tVUM0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzguNjksMjU1LDEyOS42OSwyNTEsMTMzLjY5LDI1NSwxMjkuNjksMjU5LDEzOC42OSwyNTUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgcGxheWVyIHRvIFVDOS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJwbGF5ZXIiIGRhdGEtZW50aXR5LTI9IlVDOSIgZGF0YS1zb3VyY2UtbGluZT0iMjQiIGRhdGEtdWlkPSJsbmsyMCIgaWQ9ImxpbmtfcGxheWVyX1VDOSI+PHBhdGggZD0iTTc2LjE5LDI3MS44OSBDODguMzIsMjc3LjYyIDEwMi4xNSwyODMuODcgMTE1LDI4OSBDMTM0LjYsMjk2LjgzIDE1MS4yMzYyLDMwMi41Nzg5IDE2OS4zNjYyLDMwOC4zODg5IiBmaWxsPSJub25lIiBpZD0icGxheWVyLXRvLVVDOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTc1LjA4LDMxMC4yMiwxNjcuNzMsMzAzLjY2NDIsMTcwLjMxODUsMzA4LjY5NDEsMTY1LjI4ODYsMzExLjI4MjYsMTc1LjA4LDMxMC4yMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBwbGF5ZXIgdG8gVUMxMC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJwbGF5ZXIiIGRhdGEtZW50aXR5LTI9IlVDMTAiIGRhdGEtc291cmNlLWxpbmU9IjI1IiBkYXRhLXVpZD0ibG5rMjEiIGlkPSJsaW5rX3BsYXllcl9VQzEwIj48cGF0aCBkPSJNNjIuOTcsMjkzLjQxIEM3NS43LDMxMy42IDkzLjYsMzM3LjMzIDExNSwzNTMgQzEyOC43LDM2My4wMyAxMzkuOTcyMSwzNjguMzgyIDE1NS43OTIxLDM3My40MTIiIGZpbGw9Im5vbmUiIGlkPSJwbGF5ZXItdG8tVUMxMCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTYxLjUxLDM3NS4yMywxNTQuMTQ1MSwzNjguNjkxLDE1Ni43NDUxLDM3My43MTUsMTUxLjcyMTEsMzc2LjMxNDksMTYxLjUxLDM3NS4yMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBwbGF5ZXIgdG8gVUMxMS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJwbGF5ZXIiIGRhdGEtZW50aXR5LTI9IlVDMTEiIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0ibG5rMjIiIGlkPSJsaW5rX3BsYXllcl9VQzExIj48cGF0aCBkPSJNNDkuNzEsMjkzLjQzIEM1OS4wNiwzMzAuNDcgNzguMzQsMzg1LjY2IDExNSw0MTkgQzEyOC44MSw0MzEuNTYgMTQxLjkxNSw0MzcuNjU1MSAxNTkuMjQ1LDQ0Mi4zMDUxIiBmaWxsPSJub25lIiBpZD0icGxheWVyLXRvLVVDMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE2NS4wNCw0NDMuODYsMTU3LjM4NDEsNDM3LjY2NDMsMTYwLjIxMDgsNDQyLjU2NDIsMTU1LjMxMDksNDQ1LjM5MSwxNjUuMDQsNDQzLjg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFVDMiB0byBVQzUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVUMyIiBkYXRhLWVudGl0eS0yPSJVQzUiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0ibG5rMjMiIGlkPSJsaW5rX1VDMl9VQzUiPjxwYXRoIGQ9Ik0yNTUuMTEsMTM2LjgyIEMyODkuNjEsMTQ4LjgyIDMzOC43NSwxNjcuODcgMzc4LjUsMTkxIEM0MDMuMzgsMjA1LjQ4IDQyNC41MjA2LDIyMi44NjgyIDQ0MC4yMzA2LDIzNi44NjgyIiBmaWxsPSJub25lIiBpZD0iVUMyLXRvLVVDNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDQ0LjcxLDI0MC44Niw0NDAuNjUyMSwyMzEuODg2LDQ0MC45NzcyLDIzNy41MzM1LDQzNS4zMjk2LDIzNy44NTg1LDQ0NC43MSwyNDAuODYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIzMTQuNSIgeT0iMTU2LjU3NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFVDMyB0byBVQzUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVUMzIiBkYXRhLWVudGl0eS0yPSJVQzUiIGRhdGEtc291cmNlLWxpbmU9IjI5IiBkYXRhLXVpZD0ibG5rMjQiIGlkPSJsaW5rX1VDM19VQzUiPjxwYXRoIGQ9Ik0yNTAuMjMsMTk5IEMyODMuOTQsMjA3Ljg4IDMzNC41MiwyMjEuMjQgMzc4LjUsMjMzIEMzOTIuOCwyMzYuODIgNDAyLjcxNzYsMjM5LjQ4NTIgNDE2LjQ4NzYsMjQzLjIwNTIiIGZpbGw9Im5vbmUiIGlkPSJVQzMtdG8tVUM1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MjIuMjgsMjQ0Ljc3LDQxNC42MzQ3LDIzOC41NjEyLDQxNy40NTMsMjQzLjQ2Niw0MTIuNTQ4MywyNDYuMjg0Myw0MjIuMjgsMjQ0Ljc3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjMuMDA2OCIgeD0iMzE0LjUiIHk9IjIxMi4wNTY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBVQzQgdG8gVUM1LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlVDNCIgZGF0YS1lbnRpdHktMj0iVUM1IiBkYXRhLXNvdXJjZS1saW5lPSIzMCIgZGF0YS11aWQ9ImxuazI1IiBpZD0ibGlua19VQzRfVUM1Ij48cGF0aCBkPSJNMjgzLjkxLDI1NSBDMzIzLjY0LDI1NSAzNjYuMTQsMjU1IDQwMi4xNywyNTUiIGZpbGw9Im5vbmUiIGlkPSJVQzQtdG8tVUM1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MDguMTcsMjU1LDM5OS4xNywyNTEsNDAzLjE3LDI1NSwzOTkuMTcsMjU5LDQwOC4xNywyNTUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIzMTQuNSIgeT0iMjUxLjA2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFVDNSB0byBVQzYtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVUM1IiBkYXRhLWVudGl0eS0yPSJVQzYiIGRhdGEtc291cmNlLWxpbmU9IjMxIiBkYXRhLXVpZD0ibG5rMjYiIGlkPSJsaW5rX1VDNV9VQzYiPjxwYXRoIGQ9Ik00NzQuODcsMjY5LjQxIEM1MTMuNCwzMTIuNTYgNjIzLjQ5NDUsNDM1Ljg0MzggNjYxLjU2NDUsNDc4LjQ5MzgiIGZpbGw9Im5vbmUiIGlkPSJVQzUtdG8tVUM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NjUuNTYsNDgyLjk3LDY2Mi41NTA5LDQ3My41OTIxLDY2Mi4yMzA0LDQ3OS4yMzk5LDY1Ni41ODI3LDQ3OC45MTk0LDY2NS41Niw0ODIuOTciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2MS4xODUxIiB4PSI1NDQuNSIgeT0iMzQzLjI3NjkiPiYjMTcxO2V4dGVuZCYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgVUM2IHRvIFVDNy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJVQzYiIGRhdGEtZW50aXR5LTI9IlVDNyIgZGF0YS1zb3VyY2UtbGluZT0iMzIiIGRhdGEtdWlkPSJsbmsyNyIgaWQ9ImxpbmtfVUM2X1VDNyI+PHBhdGggZD0iTTcyMS44MSw0OTguODEgQzc1Ni4yOSw1MDAuMzEgNzk5Ljg1NTYsNTAyLjIwMDEgODM5LjUyNTYsNTAzLjkyMDEiIGZpbGw9Im5vbmUiIGlkPSJVQzYtdG8tVUM3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI4NDUuNTIsNTA0LjE4LDgzNi43MDE3LDQ5OS43OTM5LDg0MC41MjQ3LDUwMy45NjM0LDgzNi4zNTUyLDUwNy43ODY0LDg0NS41Miw1MDQuMTgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2MS4xODUxIiB4PSI3NTIuNjkiIHk9IjQ5Ni4yOTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIHN5c3RlbSB0byBVQzUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0ic3lzdGVtIiBkYXRhLWVudGl0eS0yPSJVQzUiIGRhdGEtc291cmNlLWxpbmU9IjM0IiBkYXRhLXVpZD0ibG5rMjgiIGlkPSJsaW5rX3N5c3RlbV9VQzUiPjxwYXRoIGQ9Ik02OS4xNiw2MTguMzcgQzExNy4xMyw2MTQuMjIgMjE3Ljk4LDU5OS42NSAyODMuNSw1NDkgQzM4NC4zLDQ3MS4wOSA0MzguMDY2OCwzMjMuNjk5OSA0NTMuNjA2OCwyNzUuNTU5OSIgZmlsbD0ibm9uZSIgaWQ9InN5c3RlbS10by1VQzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ1NS40NSwyNjkuODUsNDQ4Ljg3ODYsMjc3LjE4Niw0NTMuOTE0LDI3NC42MDgyLDQ1Ni40OTE4LDI3OS42NDM2LDQ1NS40NSwyNjkuODUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgc3lzdGVtIHRvIFVDNi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzeXN0ZW0iIGRhdGEtZW50aXR5LTI9IlVDNiIgZGF0YS1zb3VyY2UtbGluZT0iMzUiIGRhdGEtdWlkPSJsbmsyOSIgaWQ9Imxpbmtfc3lzdGVtX1VDNiI+PHBhdGggZD0iTTY5LjM4LDYyMi45MiBDMTE0LjM4LDYyNy4wOSAyMDYuNjYsNjMzLjAxIDI4My41LDYyMSBDNDI2LjQ2LDU5OC42NSA1ODMuMzA1NCw1MzYuOTc2OCA2NDUuOTY1NCw1MTAuNzQ2OCIgZmlsbD0ibm9uZSIgaWQ9InN5c3RlbS10by1VQzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY1MS41LDUwOC40Myw2NDEuNjUzNSw1MDguMjE1NSw2NDYuODg3OCw1MTAuMzYwNyw2NDQuNzQyNiw1MTUuNTk1LDY1MS41LDUwOC40MyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBzeXN0ZW0gdG8gVUM3LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InN5c3RlbSIgZGF0YS1lbnRpdHktMj0iVUM3IiBkYXRhLXNvdXJjZS1saW5lPSIzNiIgZGF0YS11aWQ9ImxuazMwIiBpZD0ibGlua19zeXN0ZW1fVUM3Ij48cGF0aCBkPSJNNjkuMjksNjUxLjI0IEMxMDAuMDcsNjgyLjgyIDE1My4zMSw3MjcgMjEwLjI1LDcyNyBDMTAwMi4xNSw3MjggMTAwMi4xNSw3MjggNjgwLjEsNzI3IEM3OTguNDMsNzI3IDg3Ny4zMzMsNTc4LjcwNzIgOTAwLjg3Myw1MjguMjU3MiIgZmlsbD0ibm9uZSIgaWQ9InN5c3RlbS10by1VQzciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjkwMy40MSw1MjIuODIsODk1Ljk3OTYsNTI5LjI4NDUsOTAxLjI5NTgsNTI3LjM1MSw5MDMuMjI5Myw1MzIuNjY3Miw5MDMuNDEsNTIyLjgyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIHN5c3RlbSB0byBVQzgtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0ic3lzdGVtIiBkYXRhLWVudGl0eS0yPSJVQzgiIGRhdGEtc291cmNlLWxpbmU9IjM3IiBkYXRhLXVpZD0ibG5rMzEiIGlkPSJsaW5rX3N5c3RlbV9VQzgiPjxwYXRoIGQ9Ik02OS4zNiw1ODkuNiBDODAuMDUsNTc4Ljk1IDkyLjg3LDU2Ny41MyAxMDYsNTU5IEMxMjUuNjIsNTQ2LjI1IDE0NCw1MzguMDc3MSAxNjQuMDMsNTMwLjgwNzEiIGZpbGw9Im5vbmUiIGlkPSJzeXN0ZW0tdG8tVUM4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNjkuNjcsNTI4Ljc2LDE1OS44NDUzLDUyOC4wNzA2LDE2NC45Nyw1MzAuNDY1OSwxNjIuNTc0Nyw1MzUuNTkwNiwxNjkuNjcsNTI4Ljc2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1TUkM9W1RQQlBKaTkwNThSbHZvYWN0NEZPTWkwR1JkbTY3dzBmOHBRZk9EZ0lJOG85UlFEMTJLaXFtZU40ODFCMXhLUUNZNFh1Y0E0aVItNnEzRDhYYTNJSl9sRHp2eXBJb2NYVldyZTZBYkJnRzhEOUlLNlk5Y05JMDBZWWJiNFdEY2xPVkNENjJ2bGEtT00yMmV6YThPVUs5SlR3c0VYWnltQVIzSGtnRUxMM1htM09ST0hxSWFPR3d5Sjhxejd1ODRyaXpHSGFMSUdBQWVBVV95YnZqTTJyMm53eHBUdmttMk5Hc2NraHpzSUxrclhfZFJPN0xrNk1jaTVEdmp0elJEMmFHY1kzQ0ZyaUo2aEZNMl9GQWlGbnp0Qkh5MFBweWZNdElXQ2dTMmpYVmxPdUJyTWpTajRRcklkYkx6R3d4djEyaDlGUmdwa2Rrb0JOSEJOOFhoRFp1eUx2Z1AySFFiNnRyaVQ2NW5sRHNLRGRzbGdYR2ltamwzbGJZeEtrOXBWNXlOMnZndTNWeE9zbVFNOUpQdXEwRTBMV3lMc1hydmptaGYtOUdKUTZzMVhjT3NvamJOeWoxbTBXN1E3RlBvU0V4aTF1TjRnQlNaUTk0V2IyR2JqOVUybFhBRTRUV2V1cmI0dXdXQVNXbVdBbS00X2ZaWldzeWNvQ2kzN3cxbTAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<p>このユースケース図を見ると、プレイヤーとシステムがどのように相互作用するかが一目で分かりますね。プレイヤーはぷよを操作し、システムは消去や連鎖の判定を行う。そして、それらが組み合わさってぷよぷよゲームが成り立つんです。</p>
<h2 id="0">イテレーション 0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>さて、いよいよ開発を始める準備をしましょう！「イテレーション 0」と聞いて、「あれ？1 からじゃないの？」と思われるかもしれませんね。アジャイル開発では、実際の機能開発を始める前の準備段階を「イテレーション 0」と呼ぶんです。ここでは、開発に必要なツールを揃えて、プロジェクトの基盤を作っていきます。</p>
<h3 id="_9">ソフトウェア開発の三種の神器<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>前回はKotlinとテスト駆動開発を使って FizzBuzz プログラムを作りました。プログラムは動くものができたのですが、一人で開発していく上でまだ不便な部分があります。今回は開発していく上で便利になるツールを導入していきます。</p>
<blockquote>
<p>よいソフトウェアを書くのは難しい。よいソフトウェアを書くコツを覚えるのにも時間がかかる。けれども、よいソフトウェアを書くのに役立つツールを知ることはできる。</p>
<p>「よいコードを書くコツの一つは、よいツールを使うことだ。よいツールが自分のかわりに仕事をしてくれる。」</p>
<p>— <a href="https://twitter.com/t_wada">和田卓人（t-wada）さん</a></p>
</blockquote>
<p><a href="https://twitter.com/t_wada">和田卓人（t-wada）さん</a> が提唱されている <a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a> を使ってよいソフトウェアを書くためのツールを準備していきます。</p>
<p>三種の神器とは以下のとおりです。</p>
<ol>
<li><strong>バージョン管理システム</strong></li>
<li><strong>テスティングフレームワーク</strong></li>
<li><strong>自動化</strong></li>
</ol>
<p>この三種の神器について説明していきます。</p>
<h4 id="_10">バージョン管理システム<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>バージョン管理システムとは、ファイルの作成日時、変更日時、変更点などの履歴を管理するシステムです。これを使うことでファイルをバックアップしなくても、以前のファイルの状態を復元できたり、ファイルの変更内容を確認できたり、バックアップとしての役目も果たします。現在の主流は <code>Git</code> です。</p>
<h4 id="_11">テスティングフレームワーク<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>テスティングフレームワークとは、プログラムをテストするために使用するソフトウェアです。前回、プログラムの動作を確認するために対話的 Kotlin シェル（REPL）にプログラムを入力していました。しかし、プログラムの変更を行った場合に前回実施した動作確認を再度実施するのは面倒ですよね。テスティングフレームワークを使うとテストプログラムを作成することで何度でも同じテストを自動実行できるようになります。Kotlin には <strong>JUnit</strong> というテスティングフレームワークが使用できます。</p>
<h4 id="_12">自動化<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>自動化とは、これまで手動で行っていた作業をツールを使って自動的に実行できるようにすることです。例えば、テストの実行、プログラムの品質をチェックしたり、プログラムのフォーマットを整えたりといった作業を自動化してくれます。Kotlin では <strong>Gradle</strong> というビルドツールを使用して自動化を実現できます。</p>
<h3 id="_13">今回準備するツール<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>今回は Kotlin Compose Multiplatform での開発に向けて以下のツールを準備していきます:</p>
<ul>
<li><strong>バージョン管理システム</strong>: Git</li>
<li><strong>テスティングフレームワーク</strong>: JUnit</li>
<li><strong>パッケージマネージャ</strong>: Gradle</li>
<li><strong>静的コード解析</strong>: Detekt</li>
<li><strong>コードフォーマッタ</strong>: ktlint</li>
<li><strong>コードカバレッジ</strong>: JaCoCo</li>
<li><strong>タスクランナー</strong>: Gradle</li>
<li><strong>自動化</strong>: Gradle Watch</li>
</ul>
<p>それでは、ツールを一つずつ導入していきましょう。</p>
<h3 id="_14">プロジェクトの作成<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>まず、Kotlin Compose Multiplatform プロジェクトを作成します。IntelliJ IDEA を使用すると簡単に作成できます:</p>
<ol>
<li>IntelliJ IDEA を起動</li>
<li>"New Project" を選択</li>
<li>"Kotlin Multiplatform" → "Compose Multiplatform" を選択</li>
<li>プロジェクト名を "PuyoPuyoTDD" に設定</li>
<li>パッケージ名を "com.example.puyopuyo" に設定</li>
<li>ターゲットプラットフォームを選択（Desktop、Android、iOS、Web から選べます）</li>
<li>"Create" をクリック</li>
</ol>
<p>プロジェクトが作成されると、以下のような構造になります:</p>
<div class="highlight"><pre><span></span><code>PuyoPuyoTDD/
├── gradle/
├── src/
│   ├── commonMain/
│   │   └── kotlin/
│   ├── commonTest/
│   │   └── kotlin/
│   ├── desktopMain/
│   │   └── kotlin/
│   └── desktopTest/
│       └── kotlin/
├── build.gradle.kts
├── gradle.properties
├── gradlew
├── gradlew.bat
└── settings.gradle.kts
</code></pre></div>
<h3 id="_15">バージョン管理<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>バージョン管理には Git を使用します。Git は分散型バージョン管理システムです。プロジェクトを Git で管理するための初期化を行いましょう。</p>
<p>Git が初期化されているかどうかを確認します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>status
On<span class="w"> </span>branch<span class="w"> </span>main
nothing<span class="w"> </span>to<span class="w"> </span>commit,<span class="w"> </span>working<span class="w"> </span>tree<span class="w"> </span>clean
</code></pre></div>
<p>上記のような出力がされれば Git は初期化されています。もしも <code>fatal: not a git repository</code> のようなエラーが出力された場合は、以下のコマンドで Git を初期化してください。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>init
</code></pre></div>
<p>次に、リモートリポジトリの設定を確認します。GitHub などにリポジトリを作成している場合は、リモートリポジトリの設定を行います。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>-v
origin<span class="w">  </span>https://github.com/username/repository.git<span class="w"> </span><span class="o">(</span>fetch<span class="o">)</span>
origin<span class="w">  </span>https://github.com/username/repository.git<span class="w"> </span><span class="o">(</span>push<span class="o">)</span>
</code></pre></div>
<p>リモートリポジトリが設定されていない場合は、以下のコマンドで設定します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>add<span class="w"> </span>origin<span class="w"> </span>https://github.com/username/repository.git
</code></pre></div>
<p>これでバージョン管理の準備は完了です。</p>
<h3 id="_16">コミットメッセージ<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>Git を使ったバージョン管理では、変更をコミットする際にコミットメッセージを書きます。このコミットメッセージは後からコードの変更履歴を確認する際に重要な情報となります。</p>
<h4 id="conventional-commits">Conventional Commits<a class="headerlink" href="#conventional-commits" title="Permanent link">&para;</a></h4>
<p>コミットメッセージを書く際には、一定のルールに従って書くことで、後から変更履歴を確認しやすくなります。そのためのルールとして <strong>Conventional Commits</strong> という規約があります。</p>
<blockquote>
<p>Conventional Commits 仕様は、コミットメッセージのための軽量な規約です。明確なコミット履歴を作成するための簡単なルールを提供します。この規約に従うことで、コミット履歴を元に自動化ツールを作成することが簡単になります。</p>
<p>— <a href="https://www.conventionalcommits.org/ja/v1.0.0/">Conventional Commits</a></p>
</blockquote>
<p>Conventional Commits では、コミットメッセージを以下の形式で書きます:</p>
<div class="highlight"><pre><span></span><code>&lt;type&gt;[optional scope]: &lt;description&gt;

[optional body]

[optional footer(s)]
</code></pre></div>
<h5 id="type">type（必須）<a class="headerlink" href="#type" title="Permanent link">&para;</a></h5>
<p>コミットの種類を表します。主要な type は以下のとおりです:</p>
<ul>
<li><strong>feat</strong>: 新機能の追加</li>
<li><strong>fix</strong>: バグの修正</li>
<li><strong>docs</strong>: ドキュメントの変更</li>
<li><strong>style</strong>: コードの意味に影響しない変更（空白、フォーマットなど）</li>
<li><strong>refactor</strong>: バグ修正や機能追加ではないコードの変更</li>
<li><strong>test</strong>: テストの追加や修正</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更</li>
</ul>
<h5 id="scope">scope（任意）<a class="headerlink" href="#scope" title="Permanent link">&para;</a></h5>
<p>変更された範囲を表します。例: <code>api</code>, <code>ui</code>, <code>database</code> など</p>
<h5 id="description">description（必須）<a class="headerlink" href="#description" title="Permanent link">&para;</a></h5>
<p>変更内容の簡潔な説明</p>
<h5 id="_17">例<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>feat:<span class="w"> </span>Config<span class="w"> </span>クラスにゲーム設定機能を追加

fix:<span class="w"> </span>ぷよが重なる問題を修正

docs:<span class="w"> </span>README.md<span class="w"> </span>にプロジェクトの説明を追加

test:<span class="w"> </span>Stage<span class="w"> </span>クラスの単体テストを追加

chore:<span class="w"> </span>Gradle<span class="w"> </span>の依存関係を更新
</code></pre></div>
<p>このルールに従ってコミットメッセージを書くことで、変更履歴が分かりやすくなります。</p>
<h3 id="_18">パッケージマネージャ<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>ソフトウェア開発では、様々な外部ライブラリを使用することがあります。これらのライブラリを手動で管理するのは大変な作業です。そこで <strong>パッケージマネージャ</strong> を使用します。</p>
<blockquote>
<p>パッケージマネージャとは、ソフトウェアのパッケージの検索、インストール、アップデート、削除などを自動化するツールです。</p>
<p>— Wikipedia</p>
</blockquote>
<p>Kotlin では <strong>Gradle</strong> というビルドツールがパッケージマネージャの役割も果たします。Gradle は Java プラットフォーム向けのビルド自動化ツールです。</p>
<h4 id="gradle">Gradle の設定<a class="headerlink" href="#gradle" title="Permanent link">&para;</a></h4>
<p>Compose Multiplatform プロジェクトでは、<code>build.gradle.kts</code> ファイルでプロジェクトの設定を行います。基本的な <code>build.gradle.kts</code> の例:</p>
<div class="highlight"><pre><span></span><code><span class="n">plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;multiplatform&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;2.0.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;org.jetbrains.compose&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.6.0&quot;</span>
<span class="p">}</span>

<span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;com.example.puyopuyo&quot;</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span>

<span class="n">repositories</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">google</span><span class="p">()</span>
<span class="w">    </span><span class="n">mavenCentral</span><span class="p">()</span>
<span class="w">    </span><span class="n">maven</span><span class="p">(</span><span class="s">&quot;https://maven.pkg.jetbrains.space/public/p/compose/dev&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">kotlin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">jvm</span><span class="p">(</span><span class="s">&quot;desktop&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">sourceSets</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">commonMain</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">getting</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">dependencies</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">implementation</span><span class="p">(</span><span class="n">compose</span><span class="p">.</span><span class="na">runtime</span><span class="p">)</span>
<span class="w">                </span><span class="n">implementation</span><span class="p">(</span><span class="n">compose</span><span class="p">.</span><span class="na">foundation</span><span class="p">)</span>
<span class="w">                </span><span class="n">implementation</span><span class="p">(</span><span class="n">compose</span><span class="p">.</span><span class="na">material3</span><span class="p">)</span>
<span class="w">                </span><span class="n">implementation</span><span class="p">(</span><span class="n">compose</span><span class="p">.</span><span class="na">ui</span><span class="p">)</span>
<span class="w">                </span><span class="n">implementation</span><span class="p">(</span><span class="n">compose</span><span class="p">.</span><span class="na">components</span><span class="p">.</span><span class="na">resources</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">commonTest</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">getting</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">dependencies</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">implementation</span><span class="p">(</span><span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">desktopMain</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">getting</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">dependencies</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">implementation</span><span class="p">(</span><span class="n">compose</span><span class="p">.</span><span class="na">desktop</span><span class="p">.</span><span class="na">currentOs</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">compose</span><span class="p">.</span><span class="na">desktop</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">application</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mainClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MainKt&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="plugins">plugins ブロック<a class="headerlink" href="#plugins" title="Permanent link">&para;</a></h5>
<p>使用するプラグインを指定します:</p>
<ul>
<li><code>kotlin("multiplatform")</code>: Kotlin マルチプラットフォームプロジェクト用のプラグイン</li>
<li><code>org.jetbrains.compose</code>: Compose Multiplatform 用のプラグイン</li>
</ul>
<h5 id="repositories">repositories ブロック<a class="headerlink" href="#repositories" title="Permanent link">&para;</a></h5>
<p>依存関係を取得するリポジトリを指定します:</p>
<ul>
<li><code>google()</code>: Google の Maven リポジトリ</li>
<li><code>mavenCentral()</code>: Maven Central リポジトリ</li>
<li><code>maven("https://maven.pkg.jetbrains.space/public/p/compose/dev")</code>: JetBrains の Compose 用リポジトリ</li>
</ul>
<h5 id="kotlin_3">kotlin ブロック<a class="headerlink" href="#kotlin_3" title="Permanent link">&para;</a></h5>
<p>マルチプラットフォームの設定と依存関係を指定します:</p>
<ul>
<li><code>sourceSets</code>: プラットフォームごとのソースセットと依存関係</li>
<li><code>commonMain</code>: 全プラットフォーム共通のコード</li>
<li><code>commonTest</code>: 全プラットフォーム共通のテストコード</li>
<li><code>desktopMain</code>: デスクトップアプリ固有のコード</li>
</ul>
<h4 id="gradle_1">Gradle のタスク実行<a class="headerlink" href="#gradle_1" title="Permanent link">&para;</a></h4>
<p>Gradle では様々なタスクを実行できます:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトのビルド</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>build

<span class="c1"># テストの実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>

<span class="c1"># デスクトップアプリケーションの実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>run

<span class="c1"># 利用可能なタスクの一覧表示</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>tasks
</code></pre></div>
<p>これでパッケージマネージャの設定は完了です。設定をコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: Gradle プロジェクトセットアップ&#39;</span>
</code></pre></div>
<h3 id="_19">静的コード解析<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>コードを書いていると、バグや品質の問題が混入することがあります。これらの問題を早期に発見するために <strong>静的コード解析</strong> ツールを使用します。</p>
<blockquote>
<p>静的コード解析とは、プログラムを実行することなく、ソースコードを解析してバグやコーディング規約違反、セキュリティ上の問題などを検出する手法です。</p>
</blockquote>
<p>Kotlin では <strong>Detekt</strong> という静的コード解析ツールを使用できます。</p>
<h4 id="detekt">Detekt の導入<a class="headerlink" href="#detekt" title="Permanent link">&para;</a></h4>
<p><code>build.gradle.kts</code> に Detekt プラグインを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="n">plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;multiplatform&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;2.0.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;org.jetbrains.compose&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.6.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;io.gitlab.arturbosch.detekt&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.23.0&quot;</span>
<span class="p">}</span>

<span class="c1">// ... 既存の設定 ...</span>

<span class="n">dependencies</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">detektPlugins</span><span class="p">(</span><span class="s">&quot;io.gitlab.arturbosch.detekt:detekt-formatting:1.23.0&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Detekt configuration</span>
<span class="n">detekt</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">buildUponDefaultConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="n">allRules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="na">setFrom</span><span class="p">(</span><span class="s">&quot;</span><span class="si">$</span><span class="n">projectDir</span><span class="s">/config/detekt/detekt.yml&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span><span class="p">.</span><span class="na">withType</span><span class="o">&lt;</span><span class="n">io</span><span class="p">.</span><span class="na">gitlab</span><span class="p">.</span><span class="na">arturbosch</span><span class="p">.</span><span class="na">detekt</span><span class="p">.</span><span class="na">Detekt</span><span class="o">&gt;</span><span class="p">().</span><span class="na">configureEach</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">jvmTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;17&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="detekt_1">Detekt の設定ファイル<a class="headerlink" href="#detekt_1" title="Permanent link">&para;</a></h4>
<p>プロジェクトに <code>config/detekt/detekt.yml</code> ファイルを作成して、Detekt のルールをカスタマイズできます:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># detekt.yml</span>
<span class="nt">autoCorrect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">style</span><span class="p">:</span>
<span class="w">  </span><span class="nt">MaxLineLength</span><span class="p">:</span>
<span class="w">    </span><span class="nt">maxLineLength</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120</span>

<span class="nt">complexity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ComplexMethod</span><span class="p">:</span>
<span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span>
<span class="w">  </span><span class="nt">TooManyFunctions</span><span class="p">:</span>
<span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="nt">formatting</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ParameterListWrapping</span><span class="p">:</span>
<span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<h4 id="detekt_2">Detekt の実行<a class="headerlink" href="#detekt_2" title="Permanent link">&para;</a></h4>
<p>以下のコマンドで Detekt を実行できます:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 静的解析の実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>detekt

<span class="c1"># 自動修正を含む実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>detektMain<span class="w"> </span>--auto-correct
</code></pre></div>
<p>実行結果の例:</p>
<div class="highlight"><pre><span></span><code>&gt; Task :detektMain
Detekt found 3 issues.

/src/commonMain/kotlin/Config.kt:10:1: [style] MagicNumber: This expression contains a magic number. Consider defining it to a well named constant.

BUILD SUCCESSFUL in 2s
</code></pre></div>
<p>Detekt は以下のような問題を検出します:</p>
<ul>
<li><strong>コード品質</strong>: 複雑すぎるメソッド、長すぎる行など</li>
<li><strong>バグの可能性</strong>: null ポインタ例外の可能性、型キャストエラーなど</li>
<li><strong>スタイル</strong>: コーディング規約違反、命名規則違反など</li>
<li><strong>パフォーマンス</strong>: 非効率なコード</li>
<li><strong>セキュリティ</strong>: セキュリティ上の問題</li>
</ul>
<p>設定をコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: Detekt 静的コード解析セットアップ&#39;</span>
</code></pre></div>
<h3 id="_20">コードフォーマッタ<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>コードの書き方にはスタイルがあります。インデント、改行、スペースの使い方などです。チーム開発では、メンバー全員が同じスタイルでコードを書くことが重要です。<strong>コードフォーマッタ</strong> を使用することで、コードのスタイルを自動的に統一できます。</p>
<blockquote>
<p>コードフォーマッタとは、ソースコードを一定のスタイルに自動的に整形するツールです。</p>
</blockquote>
<p>Kotlin では <strong>ktlint</strong> というコードフォーマッタを使用できます。ktlint は、Kotlin の公式コーディング規約に準拠したフォーマッタです。</p>
<h4 id="ktlint">ktlint の導入<a class="headerlink" href="#ktlint" title="Permanent link">&para;</a></h4>
<p><code>build.gradle.kts</code> に ktlint プラグインを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="n">plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;multiplatform&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;2.0.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;org.jetbrains.compose&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.6.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;io.gitlab.arturbosch.detekt&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.23.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;org.jlleitschuh.gradle.ktlint&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;11.5.1&quot;</span>
<span class="p">}</span>

<span class="c1">// ... 既存の設定 ...</span>

<span class="c1">// Ktlint configuration</span>
<span class="n">ktlint</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">verbose</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">outputToConsole</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">coloredOutput</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">reporters</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">reporter</span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">jlleitschuh</span><span class="p">.</span><span class="na">gradle</span><span class="p">.</span><span class="na">ktlint</span><span class="p">.</span><span class="na">reporter</span><span class="p">.</span><span class="na">ReporterType</span><span class="p">.</span><span class="na">CHECKSTYLE</span><span class="p">)</span>
<span class="w">        </span><span class="n">reporter</span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">jlleitschuh</span><span class="p">.</span><span class="na">gradle</span><span class="p">.</span><span class="na">ktlint</span><span class="p">.</span><span class="na">reporter</span><span class="p">.</span><span class="na">ReporterType</span><span class="p">.</span><span class="na">JSON</span><span class="p">)</span>
<span class="w">        </span><span class="n">reporter</span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">jlleitschuh</span><span class="p">.</span><span class="na">gradle</span><span class="p">.</span><span class="na">ktlint</span><span class="p">.</span><span class="na">reporter</span><span class="p">.</span><span class="na">ReporterType</span><span class="p">.</span><span class="na">HTML</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="ktlint_1">ktlint の実行<a class="headerlink" href="#ktlint_1" title="Permanent link">&para;</a></h4>
<p>以下のコマンドで ktlint を実行できます:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># コードスタイルのチェック</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>ktlintCheck

<span class="c1"># コードスタイルの自動修正</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>ktlintFormat
</code></pre></div>
<p>実行結果の例:</p>
<div class="highlight"><pre><span></span><code>&gt; Task :ktlintMainSourceSetCheck
/src/commonMain/kotlin/Config.kt:5:1: Unexpected indentation (4) (should be 8) (indent)
/src/commonMain/kotlin/Config.kt:10:17: Missing spacing after &quot;,&quot; (comma-spacing)

2 problems (0 errors, 2 warnings)

BUILD FAILED in 1s
</code></pre></div>
<p>ktlint は以下のようなスタイル問題を検出・修正します:</p>
<ul>
<li><strong>インデント</strong>: タブやスペースの統一</li>
<li><strong>スペーシング</strong>: 演算子、カンマ、括弧周りのスペース</li>
<li><strong>改行</strong>: 適切な位置での改行</li>
<li><strong>インポート</strong>: インポート文の整理</li>
<li><strong>命名規則</strong>: クラス名、メソッド名の規則</li>
</ul>
<h4 id="_21">自動修正の例<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h4>
<p>修正前:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageWidth</span><span class="p">:</span><span class="kt">Int</span><span class="o">=</span><span class="m">6</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageHeight</span><span class="p">:</span><span class="kt">Int</span><span class="o">=</span><span class="m">13</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">puyoSize</span><span class="p">:</span><span class="kt">Int</span><span class="o">=</span><span class="m">32</span>
<span class="p">}</span>
</code></pre></div>
<p>修正後:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageWidth</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageHeight</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">puyoSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32</span>
<span class="p">}</span>
</code></pre></div>
<p>設定をコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: ktlint コードフォーマッタセットアップ&#39;</span>
</code></pre></div>
<h3 id="_22">コードカバレッジ<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>テストを書いていると、「どの程度のコードがテストされているか」を知りたくなります。これを測定するのが <strong>コードカバレッジ</strong> です。</p>
<blockquote>
<p>コードカバレッジとは、テストによって実行されたソースコードの割合を測定する手法です。</p>
</blockquote>
<p>Kotlin では <strong>JaCoCo</strong>（Java Code Coverage）というツールでコードカバレッジを測定できます。</p>
<h4 id="jacoco">JaCoCo の導入<a class="headerlink" href="#jacoco" title="Permanent link">&para;</a></h4>
<p><code>build.gradle.kts</code> に JaCoCo プラグインを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="n">plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;multiplatform&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;2.0.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;org.jetbrains.compose&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.6.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;io.gitlab.arturbosch.detekt&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.23.0&quot;</span>
<span class="w">    </span><span class="n">id</span><span class="p">(</span><span class="s">&quot;org.jlleitschuh.gradle.ktlint&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;11.5.1&quot;</span>
<span class="w">    </span><span class="n">jacoco</span>
<span class="p">}</span>

<span class="c1">// ... 既存の設定 ...</span>

<span class="n">tasks</span><span class="p">.</span><span class="na">withType</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">finalizedBy</span><span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="na">jacocoTestReport</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span><span class="p">.</span><span class="na">jacocoTestReport</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">dependsOn</span><span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="na">test</span><span class="p">)</span>
<span class="w">    </span><span class="n">reports</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">xml</span><span class="p">.</span><span class="na">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="n">csv</span><span class="p">.</span><span class="na">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="n">html</span><span class="p">.</span><span class="na">outputLocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">layout</span><span class="p">.</span><span class="na">buildDirectory</span><span class="p">.</span><span class="na">dir</span><span class="p">(</span><span class="s">&quot;jacocoHtml&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="jacoco_1">JaCoCo の実行<a class="headerlink" href="#jacoco_1" title="Permanent link">&para;</a></h4>
<p>テストを実行すると、自動的にコードカバレッジが測定されます:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># テスト実行（カバレッジも同時に実行される）</span>
$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>

<span class="c1"># カバレッジレポートのみ生成</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>jacocoTestReport
</code></pre></div>
<p>実行結果の例:</p>
<div class="highlight"><pre><span></span><code>&gt; Task :test
ConfigTest &gt; ステージの幅が正しく設定されている() PASSED
ConfigTest &gt; ステージの高さが正しく設定されている() PASSED
ConfigTest &gt; ぷよのサイズが正しく設定されている() PASSED

&gt; Task :jacocoTestReport

BUILD SUCCESSFUL in 3s
</code></pre></div>
<h4 id="_23">カバレッジレポートの確認<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>テスト実行後に <code>build/jacocoHtml</code> フォルダが作成されます。その中の <code>index.html</code> を開くとカバレッジ状況を確認できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ブラウザでレポートを開く</span>
$<span class="w"> </span>open<span class="w"> </span>build/jacocoHtml/index.html
</code></pre></div>
<p>レポートには以下の情報が表示されます:</p>
<ul>
<li><strong>Line Coverage</strong>: 実行された行の割合</li>
<li><strong>Branch Coverage</strong>: 実行された分岐の割合</li>
<li><strong>Method Coverage</strong>: 実行されたメソッドの割合</li>
<li><strong>Class Coverage</strong>: 実行されたクラスの割合</li>
</ul>
<h4 id="_24">カバレッジの例<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Package              Line Coverage    Branch Coverage    Method Coverage
com.example.puyopuyo 85% (17/20)      75% (6/8)         100% (4/4)
</code></pre></div>
<p>この例では:
- 20 行中 17 行がテストで実行された（85%）
- 8 つの分岐中 6 つがテストで実行された（75%）
- 4 つのメソッドすべてがテストで実行された（100%）</p>
<p>コードカバレッジは品質の指標の一つですが、100% である必要はありません。重要なのは、重要な機能がしっかりテストされていることです。</p>
<p>設定をコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: JaCoCo コードカバレッジセットアップ&#39;</span>
</code></pre></div>
<h3 id="_25">タスクランナー<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>ここまででテストの実行、静的コード解析、コードフォーマット、コードカバレッジを実施することができるようになりました。でもコマンドを実行するのにそれぞれのコマンドを覚えておくのは面倒ですよね。例えばテストの実行は:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>では静的コード解析はどうやりましたか？フォーマットはどうやりましたか？調べるのも面倒ですよね。いちいち調べるのが面倒なことは全部 <strong>タスクランナー</strong> にやらせるようにしましょう。</p>
<blockquote>
<p>タスクランナーとは、アプリケーションのビルドなど、一定の手順で行う作業をコマンド一つで実行できるように予めタスクとして定義したものです。</p>
</blockquote>
<p>Kotlin の <strong>タスクランナー</strong> は <code>Gradle</code> です。Gradle は単なるパッケージマネージャではなく、強力なタスクランナーでもあります。</p>
<h4 id="_26">カスタムタスクの定義<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<p><code>build.gradle.kts</code> にカスタムタスクを追加して、よく使うコマンドを簡単に実行できるようにします:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// カスタムタスクの定義</span>
<span class="n">tasks</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="s">&quot;checkAll&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;全てのチェックを実行&quot;</span>
<span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;verification&quot;</span>
<span class="w">    </span><span class="n">dependsOn</span><span class="p">(</span><span class="s">&quot;ktlintCheck&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;detekt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="s">&quot;fixAll&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;自動修正可能な全ての問題を修正&quot;</span>
<span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;formatting&quot;</span>
<span class="w">    </span><span class="n">dependsOn</span><span class="p">(</span><span class="s">&quot;ktlintFormat&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">finalizedBy</span><span class="p">(</span><span class="s">&quot;detektMain&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="s">&quot;qualityCheck&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;コード品質チェック&quot;</span>
<span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;verification&quot;</span>
<span class="w">    </span><span class="n">dependsOn</span><span class="p">(</span><span class="s">&quot;ktlintCheck&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;detekt&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_27">タスクの実行<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<p>定義したタスクを実行できます:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 利用可能なタスクの一覧表示</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>tasks

<span class="c1"># 全てのチェックを実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>checkAll

<span class="c1"># 自動修正を実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>fixAll

<span class="c1"># コード品質チェックのみ実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>qualityCheck
</code></pre></div>
<p>実行結果の例:</p>
<div class="highlight"><pre><span></span><code>&gt; Task :ktlintCheck
&gt; Task :detekt
&gt; Task :test

BUILD SUCCESSFUL in 5s
</code></pre></div>
<h4 id="gradle-wrapper">Gradle Wrapper<a class="headerlink" href="#gradle-wrapper" title="Permanent link">&para;</a></h4>
<p>プロジェクトには <code>gradlew</code>（Unix/Linux/Mac）と <code>gradlew.bat</code>（Windows）というファイルがあります。これは <strong>Gradle Wrapper</strong> と呼ばれ、Gradle がインストールされていない環境でも同じバージョンの Gradle を使用できるようにするツールです。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Unix/Linux/Mac</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>build

<span class="c1"># Windows</span>
$<span class="w"> </span>gradlew.bat<span class="w"> </span>build
</code></pre></div>
<p>チーム開発では、メンバー全員が同じバージョンの Gradle を使用することが重要なので、Gradle Wrapper を使用することが推奨されます。</p>
<h3 id="_28">自動化<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>これまでに導入したツールを使って、開発作業を自動化しましょう。Gradle には <strong>継続的ビルド</strong> 機能があり、ファイルの変更を監視して自動的にタスクを実行できます。</p>
<h4 id="_29">ファイル監視による自動実行<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># ファイル変更を監視してテストを自動実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--continuous

<span class="c1"># ファイル変更を監視して品質チェックを自動実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>qualityCheck<span class="w"> </span>--continuous
</code></pre></div>
<p><code>--continuous</code> オプションを使用すると、ソースファイルが変更されるたびに自動的にタスクが実行されます。</p>
<p>実行結果の例:</p>
<div class="highlight"><pre><span></span><code>&gt; Task :qualityCheck

BUILD SUCCESSFUL in 2s

Waiting for changes to input files... (ctrl-d to exit)
&lt;-------------&gt; 0% EXECUTING
&gt; :qualityCheck
</code></pre></div>
<p>この状態で Kotlin ファイルを編集すると、自動的に品質チェックが実行されます:</p>
<div class="highlight"><pre><span></span><code>Change detected, executing build...

&gt; Task :ktlintCheck
&gt; Task :detekt

BUILD SUCCESSFUL in 1s

Waiting for changes to input files... (ctrl-d to exit)
</code></pre></div>
<h4 id="ide">IDE との連携<a class="headerlink" href="#ide" title="Permanent link">&para;</a></h4>
<p>多くの IDE は Gradle と連携して、以下のような自動化を提供しています:</p>
<ul>
<li><strong>保存時の自動フォーマット</strong>: ファイル保存時に ktlintFormat を実行</li>
<li><strong>リアルタイム解析</strong>: Detekt による静的解析結果をエディタに表示</li>
<li><strong>テストの自動実行</strong>: テストファイル変更時にテストを自動実行</li>
</ul>
<p>これらの機能により、開発中にリアルタイムでコード品質を確認できます。</p>
<p>設定をコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: タスクの自動化セットアップ&#39;</span>
</code></pre></div>
<p>これで <a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a> の最後のアイテムの準備ができました。次回の開発からは最初にコマンドラインで <code>./gradlew checkAll</code> を実行すれば良いコードを書くためのタスクを自動で実行してくれるようになるので、コードを書くことに集中できるようになりました。</p>
<h3 id="_30">まとめ<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>今回は Kotlin Compose Multiplatform での開発に必要なツールを導入しました:</p>
<h4 id="_31">導入したツール<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>バージョン管理システム</strong>: Git</li>
<li><strong>テスティングフレームワーク</strong>: JUnit</li>
<li><strong>パッケージマネージャ</strong>: Gradle</li>
<li><strong>静的コード解析</strong>: Detekt</li>
<li><strong>コードフォーマッタ</strong>: ktlint</li>
<li><strong>コードカバレッジ</strong>: JaCoCo</li>
<li><strong>タスクランナー</strong>: Gradle</li>
<li><strong>自動化</strong>: Gradle Watch</li>
</ol>
<h4 id="_32">よく使うコマンド<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 全てのチェックを実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>checkAll

<span class="c1"># 自動修正を実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>fixAll

<span class="c1"># テスト実行（カバレッジ付き）</span>
$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>

<span class="c1"># 継続的品質チェック</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>qualityCheck<span class="w"> </span>--continuous

<span class="c1"># デスクトップアプリの実行</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>run
</code></pre></div>
<p>これらのツールを使うことで、以下の利点が得られます:</p>
<ul>
<li><strong>品質の向上</strong>: 静的解析とフォーマッタによりコードの品質が向上</li>
<li><strong>効率の向上</strong>: 自動化により手動作業が削減</li>
<li><strong>一貫性の確保</strong>: チーム全体で同じ品質基準を共有</li>
<li><strong>早期発見</strong>: 問題の早期発見と修正</li>
<li><strong>集中力の向上</strong>: コード品質管理から開放され、ロジックに集中可能</li>
</ul>
<p>次のエピソードでは、これらのツールを活用して実際にぷよぷよゲームの実装を始めていきましょう。まずはゲームの設定から始めて、少しずつ機能を追加していきます。楽しみにしていてくださいね！</p>
<h2 id="1">イテレーション 1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_33">ユーザーストーリー<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう:</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODO リスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずは TODO リストを作成しましょう。TODO リストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ゲーム設定（Config）を定義する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームの初期化処理を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ステージ（Stage）を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> プレイヤー（Player）を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> スコア（Score）を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲーム画面を表示する</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ゲーム設定」から始めましょう！</p>
<h3 id="_34">テスト: ゲーム設定<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>さて、TODO リストの最初のタスク「ゲーム設定（Config）を定義する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ゲーム設定をテストするコードを書いてみましょう。何をテストすべきでしょうか？ゲーム設定には、ステージの幅・高さ、ぷよのサイズなどの基本的な設定値が必要ですね。</p>
<p><code>src/commonTest/kotlin/ConfigTest.kt</code> を作成します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.Test</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.assertEquals</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">ConfigTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">ステ</span><span class="nf">ー</span><span class="err">ジの幅が正しく設定されている</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Act &amp; Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">ステ</span><span class="nf">ー</span><span class="err">ジの高さが正しく設定されている</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Act &amp; Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">ぷよのサイズが正しく設定されている() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Act &amp; Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、<code>Config</code> クラスが適切な設定値を持っているかを確認しています。ステージの幅は 6、高さは 13、ぷよのサイズは 40 ピクセルという、ぷよぷよゲームの標準的な設定値です。</p>
<h3 id="_35">実装: ゲーム設定<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>Unresolved reference: Config
</code></pre></div>
<p>おっと！まだ <code>Config</code> クラスを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<p>では、テストが通るように最小限のコードを実装していきましょう。「最小限」というのがポイントです。この段階では、テストが通ることだけを目指して、必要最低限のコードを書きます。</p>
<p><code>src/commonMain/kotlin/Config.kt</code> を作成します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageWidth</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageHeight</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">puyoSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">40</span>
<span class="p">}</span>
</code></pre></div>
<p>「こんなに簡単でいいの？」と思われるかもしれませんね。はい、これで十分なんです！Kotlin のプロパティは自動的に getter を生成してくれるので、Java のような冗長なコードを書く必要がありません。</p>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<h3 id="_36">解説: ゲーム設定<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>実装したゲーム設定について、少し解説しておきましょう。<code>Config</code> クラスは、ゲーム全体で使用する設定値を一元管理するクラスです:</p>
<ul>
<li><strong>stageWidth</strong>: ステージの横幅（マス数）= 6</li>
<li><strong>stageHeight</strong>: ステージの高さ（マス数）= 13</li>
<li><strong>puyoSize</strong>: 1 つのぷよの表示サイズ（ピクセル数）= 40</li>
</ul>
<p>これらの値をクラスにまとめることで、設定の変更が容易になります。例えば、「ステージを広くしたい」と思ったときに、<code>stageWidth</code> の値を変更するだけで済むんです。これは、「変更に強いコード」を書くための重要なテクニックです。</p>
<blockquote>
<p>定数を使用することで、マジックナンバーを排除し、コードの可読性と保守性を向上させる。</p>
<p>— Robert C. Martin 『Clean Code』</p>
</blockquote>
<p>設定をコミットしておきましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム設定クラスを追加&#39;</span>
</code></pre></div>
<h3 id="_37">テスト: ゲームの初期化<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>次に、ゲームの初期化処理のテストを書きます。ゲームが初期化されたとき、必要なコンポーネントが正しく作成されることを確認しましょう。</p>
<p><code>src/commonTest/kotlin/GameTest.kt</code> を作成します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.Test</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.assertEquals</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.assertNotNull</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">GameTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">ゲ</span><span class="nf">ー</span><span class="err">ムを初期化すると必要なコンポ</span><span class="n">ー</span><span class="err">ネントが作成される</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">assertNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">assertNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">)</span>
<span class="w">        </span><span class="n">assertNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">)</span>
<span class="w">        </span><span class="n">assertNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">ゲ</span><span class="nf">ー</span><span class="err">ムを初期化するとゲ</span><span class="n">ー</span><span class="err">ムモ</span><span class="n">ー</span><span class="err">ドが</span><span class="n">Start</span><span class="err">になる</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="na">Start</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_38">実装: ゲームの初期化<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、実装していきましょう。</p>
<p><code>src/commonMain/kotlin/Game.kt</code> を作成します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="kd">enum</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Start</span><span class="p">,</span>
<span class="w">    </span><span class="n">CheckFall</span><span class="p">,</span>
<span class="w">    </span><span class="n">Fall</span><span class="p">,</span>
<span class="w">    </span><span class="n">CheckErase</span><span class="p">,</span>
<span class="w">    </span><span class="n">Erasing</span><span class="p">,</span>
<span class="w">    </span><span class="n">NewPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="n">Playing</span><span class="p">,</span>
<span class="w">    </span><span class="n">GameOver</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="w">    </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Stage</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="w">    </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="w"> </span><span class="n">Player</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="w">    </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">score</span><span class="p">:</span><span class="w"> </span><span class="n">Score</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">mode</span><span class="p">:</span><span class="w"> </span><span class="n">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">Start</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">frame</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">combinationCount</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 各コンポーネントの初期化</span>
<span class="w">        </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">        </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// ゲームモードを設定</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">Start</span>
<span class="w">        </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="n">combinationCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>おっと、まだ <code>Stage</code>、<code>Player</code>、<code>Score</code> クラスが実装されていないのでエラーになりますね。これらのクラスも順次実装していきましょう。</p>
<h3 id="stageplayerscore">実装: Stage、Player、Score の基本構造<a class="headerlink" href="#stageplayerscore" title="Permanent link">&para;</a></h3>
<p>テストを通すために、最小限の実装を追加します。</p>
<p><code>src/commonMain/kotlin/Stage.kt</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TODO: 実装は後のイテレーションで</span>
<span class="p">}</span>
</code></pre></div>
<p><code>src/commonMain/kotlin/Player.kt</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Stage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TODO: 実装は後のイテレーションで</span>
<span class="p">}</span>
</code></pre></div>
<p><code>src/commonMain/kotlin/Score.kt</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">value</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">points</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">points</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>すべてのテストが通りましたね！Green の状態です。</p>
<h3 id="_39">解説: ゲームの初期化<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>実装したゲームの初期化処理について解説しておきましょう。この処理では、主に以下のことを行っています:</p>
<ol>
<li>各コンポーネント（Config、Stage、Player、Score）のインスタンスを作成</li>
<li>ゲームモードを <code>Start</code> に設定</li>
<li>フレームカウンタと連鎖カウンタを 0 にリセット</li>
</ol>
<p>各コンポーネントの役割:</p>
<ul>
<li><strong>Config</strong>: ゲームの設定値を管理</li>
<li><strong>Stage</strong>: ゲームのステージ（盤面）を管理</li>
<li><strong>Player</strong>: プレイヤーの入力と操作を管理</li>
<li><strong>Score</strong>: スコアの計算と表示を管理</li>
</ul>
<p>このように、責任を明確に分けることで、コードの保守性が高まります。これはオブジェクト指向設計の基本原則の一つ、「単一責任の原則」に従っています。</p>
<blockquote>
<p>単一責任の原則（SRP）: クラスを変更する理由は 1 つだけであるべき。</p>
<p>— Robert C. Martin 『Clean Architecture』</p>
</blockquote>
<p>設定をコミットしておきましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化処理を実装&#39;</span>
</code></pre></div>
<h3 id="_40">画面の表示<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>さて、ゲームのコアロジックは実装できましたが、「実際にゲームを動かしてみたい！」と思いますよね。ここからは、Compose Multiplatform を使ってゲームの画面を表示していきましょう。</p>
<h4 id="compose-multiplatform-ui">Compose Multiplatform での UI 構築<a class="headerlink" href="#compose-multiplatform-ui" title="Permanent link">&para;</a></h4>
<p>Compose Multiplatform では、宣言的な UI 構築が可能です。「宣言的」とは、「UI がどうあるべきか」を記述することで、「どうやって UI を変更するか」は Compose が自動的に処理してくれるという意味です。</p>
<blockquote>
<p>宣言的 UI では、UI ツリー全体を概念的に再生成し、変更された部分のみを実際に更新します。これにより、UI の状態管理が大幅に簡素化されます。</p>
<p>— Jetpack Compose ドキュメント</p>
</blockquote>
<p>従来の命令的 UI と比較してみましょう:</p>
<p><strong>命令的 UI（従来の方法）:</strong>
<div class="highlight"><pre><span></span><code><span class="c1">// 状態が変わるたびに UI を手動で更新する必要がある</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">scoreText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TextView</span><span class="p">()</span>
<span class="n">scoreText</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: 0&quot;</span>

<span class="c1">// スコアが変わったら...</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">updateScore</span><span class="p">(</span><span class="n">newScore</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">scoreText</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: </span><span class="si">$</span><span class="n">newScore</span><span class="s">&quot;</span><span class="w">  </span><span class="c1">// 手動で更新</span>
<span class="p">}</span>
</code></pre></div></p>
<p><strong>宣言的 UI（Compose の方法）:</strong>
<div class="highlight"><pre><span></span><code><span class="c1">// 状態が変わると自動的に UI が更新される</span>
<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">ScoreDisplay</span><span class="p">(</span><span class="n">score</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;スコア: </span><span class="si">$</span><span class="n">score</span><span class="s">&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// score が変わると自動的に再描画</span>
<span class="p">}</span>
</code></pre></div></p>
<p>宣言的 UI では、状態と UI が常に同期されるため、「あれ？画面が更新されない...」という問題が減るんです。便利ですよね！</p>
<h4 id="_41">メインエントリーポイントの実装<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h4>
<p>まず、アプリケーションのエントリーポイントを作成します。デスクトップアプリケーションの場合、<code>Main.kt</code> がエントリーポイントになります。</p>
<p><code>src/jvmMain/kotlin/Main.kt</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.unit.dp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.window.Window</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.window.WindowState</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.window.application</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.example.puyopuyo.GameApp</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">application</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Window</span><span class="p">(</span>
<span class="w">            </span><span class="n">onCloseRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">exitApplication</span><span class="p">,</span>
<span class="w">            </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WindowState</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">400.</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">800.</span><span class="n">dp</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">GameApp</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>このコードでは、以下のことを行っています:</p>
<ul>
<li><strong>application</strong>: Compose Desktop アプリケーションを起動</li>
<li><strong>Window</strong>: ウィンドウを作成（タイトルとクローズハンドラを設定）</li>
<li><strong>WindowState</strong>: ウィンドウのサイズを 400×800 ピクセルに設定</li>
<li><strong>GameApp</strong>: ゲーム画面のルートコンポーネントを表示</li>
</ul>
<p>シンプルですよね！これだけでウィンドウが作成されます。</p>
<h4 id="_42">ゲーム画面の実装<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h4>
<p>次に、ゲーム画面全体を表示する <code>GameApp</code> コンポーネントを実装します。</p>
<p><code>src/commonMain/kotlin/GameApp.kt</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.layout.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material.MaterialTheme</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material.Surface</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material.Text</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.runtime.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Alignment</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Modifier</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.unit.dp</span>

<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">GameApp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームインスタンスの作成と初期化</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">().</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">MaterialTheme</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Surface</span><span class="p">(</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colors</span><span class="p">.</span><span class="na">background</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Column</span><span class="p">(</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">                </span><span class="n">horizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">CenterHorizontally</span><span class="p">,</span>
<span class="w">                </span><span class="n">verticalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">Center</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// タイトル</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ぷよぷよ&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">h3</span>
<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                </span><span class="c1">// スコア表示</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">value</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">h5</span>
<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                </span><span class="c1">// ゲームモード表示</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;モード: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">body1</span>
<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">32.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                </span><span class="c1">// ゲームステージ</span>
<span class="w">                </span><span class="n">GameStage</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このコードについて、重要なポイントを解説します:</p>
<p><strong>remember の使用:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Game</span><span class="p">().</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>remember</code> は、Composable 関数が再実行されても値を保持し続けるための仕組みです。「再実行されても？」と思われるかもしれませんね。実は、Compose では状態が変わるたびに Composable 関数が再実行されるんです。でも、<code>remember</code> を使うことで、ゲームインスタンスは最初の 1 回だけ作成され、以降は同じインスタンスが使い回されます。</p>
<p><strong>MaterialTheme の適用:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">MaterialTheme</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Surface</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">        </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colors</span><span class="p">.</span><span class="na">background</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// UI コンポーネント</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>MaterialTheme</code> は、Google の Material Design のスタイルを適用するためのコンポーネントです。これにより、一貫したデザインの UI を簡単に作成できます。</p>
<p><strong>レイアウトの構築:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">Column</span><span class="p">(</span>
<span class="w">    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">    </span><span class="n">horizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">CenterHorizontally</span><span class="p">,</span>
<span class="w">    </span><span class="n">verticalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">Center</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// UI コンポーネントを縦に配置</span>
<span class="p">}</span>
</code></pre></div>
<p><code>Column</code> は、子要素を縦方向に配置するレイアウトコンポーネントです:</p>
<ul>
<li><code>fillMaxSize()</code>: 親のサイズいっぱいに広がる</li>
<li><code>horizontalAlignment</code>: 水平方向の配置（ここでは中央揃え）</li>
<li><code>verticalArrangement</code>: 垂直方向の配置（ここでは中央揃え）</li>
</ul>
<h4 id="_43">ゲームステージの実装<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h4>
<p>次に、ゲームのステージ（盤面）を表示する <code>GameStage</code> コンポーネントを実装します。</p>
<p><code>src/commonMain/kotlin/GameStage.kt</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.Canvas</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.border</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.layout.size</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.runtime.Composable</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Modifier</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.geometry.Offset</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.geometry.Size</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.graphics.Color</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.unit.dp</span>

<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">GameStage</span><span class="p">(</span><span class="n">game</span><span class="p">:</span><span class="w"> </span><span class="n">Game</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageWidthPx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">).</span><span class="na">dp</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageHeightPx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">).</span><span class="na">dp</span>

<span class="w">    </span><span class="n">Canvas</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">            </span><span class="p">.</span><span class="na">size</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageWidthPx</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageHeightPx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">border</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">Black</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ステージの背景</span>
<span class="w">        </span><span class="n">drawRect</span><span class="p">(</span>
<span class="w">            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">White</span><span class="p">,</span>
<span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Size</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="na">width</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="na">height</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1">// グリッド線の描画</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">cellSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">.</span><span class="na">toFloat</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 縦線</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0.</span><span class="p">.</span><span class="na">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">xPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span>
<span class="w">            </span><span class="n">drawLine</span><span class="p">(</span>
<span class="w">                </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">LightGray</span><span class="p">,</span>
<span class="w">                </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="n">xPos</span><span class="p">,</span><span class="w"> </span><span class="m">0f</span><span class="p">),</span>
<span class="w">                </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="n">xPos</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="na">height</span><span class="p">),</span>
<span class="w">                </span><span class="n">strokeWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1f</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 横線</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0.</span><span class="p">.</span><span class="na">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">yPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span>
<span class="w">            </span><span class="n">drawLine</span><span class="p">(</span>
<span class="w">                </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">LightGray</span><span class="p">,</span>
<span class="w">                </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span><span class="w"> </span><span class="n">yPos</span><span class="p">),</span>
<span class="w">                </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="na">width</span><span class="p">,</span><span class="w"> </span><span class="n">yPos</span><span class="p">),</span>
<span class="w">                </span><span class="n">strokeWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1f</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// TODO: ぷよの描画（後のイテレーションで実装）</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このコードについて解説します:</p>
<p><strong>Canvas の使用:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">Canvas</span><span class="p">(</span>
<span class="w">    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">        </span><span class="p">.</span><span class="na">size</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageWidthPx</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageHeightPx</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">border</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">Black</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 描画処理</span>
<span class="p">}</span>
</code></pre></div>
<p><code>Canvas</code> は、自由に図形を描画できる Compose コンポーネントです。ゲームのような独自の描画が必要な場合に使用します。</p>
<p><strong>グリッド線の描画:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// 縦線</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0.</span><span class="p">.</span><span class="na">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">xPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span>
<span class="w">    </span><span class="n">drawLine</span><span class="p">(</span>
<span class="w">        </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">LightGray</span><span class="p">,</span>
<span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="n">xPos</span><span class="p">,</span><span class="w"> </span><span class="m">0f</span><span class="p">),</span>
<span class="w">        </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="n">xPos</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="na">height</span><span class="p">),</span>
<span class="w">        </span><span class="n">strokeWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1f</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>グリッド線を描画することで、ステージのマス目が見えるようになります。これにより、ぷよの配置がわかりやすくなりますね。</p>
<h4 id="_44">アプリケーションの実行<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h4>
<p>さて、実装したアプリケーションを実行してみましょう！</p>
<div class="highlight"><pre><span></span><code><span class="c1"># デスクトップアプリケーションを起動</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>run
</code></pre></div>
<p>ウィンドウが開いて、以下のような画面が表示されるはずです:</p>
<ul>
<li>タイトル「ぷよぷよ」</li>
<li>スコア表示「スコア: 0」</li>
<li>ゲームモード表示「モード: Start」</li>
<li>白い背景にグリッド線が引かれたステージ</li>
</ul>
<p>「動いた！」と感動しませんか？まだぷよは表示されませんが、ゲームの基本的な画面ができました。</p>
<p>設定をコミットしておきましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Compose Multiplatform で画面表示を実装&#39;</span>
</code></pre></div>
<h3 id="1_1">イテレーション 1 のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！イテレーション 1 が完了しました。このイテレーションで実装したことを振り返ってみましょう:</p>
<h4 id="_45">実装した機能<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> ゲーム設定（Config）を定義する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ゲームの初期化処理を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ステージ（Stage）の基本構造を作成する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> プレイヤー（Player）の基本構造を作成する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> スコア（Score）を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ゲーム画面を表示する</li>
</ul>
<h4 id="_46">学んだこと<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>テスト駆動開発のサイクル</strong>: Red → Green → Refactor の流れを体験しました</li>
<li><strong>単一責任の原則</strong>: 各クラスに明確な責任を持たせることの重要性を学びました</li>
<li><strong>Kotlin の簡潔な構文</strong>: プロパティの自動生成により、コードが簡潔になることを実感しました</li>
<li><strong>TODO リストの活用</strong>: 大きなタスクを小さく分解することで、着実に進められることを体験しました</li>
<li><strong>Compose Multiplatform の宣言的 UI</strong>: 状態と UI が常に同期される仕組みを理解しました</li>
<li><strong>remember による状態管理</strong>: 再実行されても値を保持する仕組みを学びました</li>
</ol>
<p>次のイテレーションでは、ぷよの移動機能を実装し、実際にゲームとして遊べるようにしていきます。楽しみにしていてくださいね！</p>
<h2 id="2">イテレーション 2: ぷよの落下<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>イテレーション 1 では、ゲームの基本構造と画面表示を実装しました。しかし、まだぷよは表示されていませんね。このイテレーションでは、ぷよを生成して落下させる機能を実装していきましょう！</p>
<blockquote>
<p>少しずつ前に進む。それが唯一の方法だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_47">ユーザーストーリー<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーは以下です:</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを見ることができる</p>
</blockquote>
<p>シンプルですが、これがゲームの基本動作になります。ぷよが生成されて、重力によって落下していく様子を実装していきましょう。</p>
<h3 id="todo_1">TODO リスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>今回のユーザーストーリーを実現するために必要なタスクを洗い出しましょう:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ステージにぷよを配置・取得する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> プレイヤーが新しいぷよを生成する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよが自動的に落下する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ステージ上のぷよを画面に描画する</li>
</ul>
<p>それでは、TDD のサイクルに従って、一つずつ実装していきましょう！</p>
<h3 id="_48">テスト: ステージにぷよを配置・取得する<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>最初のタスクは、ステージにぷよを配置したり取得したりする機能です。ステージはぷよぷよゲームの盤面ですから、どのマスにどんなぷよがあるかを管理する必要がありますね。</p>
<p><code>src/commonTest/kotlin/StageTest.kt</code> にテストを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.Test</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.assertEquals</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">StageTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">初期状態では全てのマスが空である() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Act &amp; Assert</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">ぷよを配置できる() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// (x=2, y=10) に種類1のぷよを配置</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">複数のぷよを配置できる() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 赤ぷよ</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1">// 青ぷよ</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="c1">// 緑ぷよ</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="c1">// 黄ぷよ</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">ぷよを上書きできる() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1">// 上書き</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、以下の機能を確認しています:</p>
<ul>
<li>初期状態では全てのマスが空（0）であること</li>
<li><code>setPuyo()</code> でぷよを配置できること</li>
<li><code>getPuyo()</code> で配置したぷよを取得できること</li>
<li>複数のぷよを配置できること</li>
<li>ぷよを上書きできること</li>
</ul>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>当然、まだ <code>initialize()</code>、<code>getPuyo()</code>、<code>setPuyo()</code> メソッドを実装していないので、テストは失敗します。これが Red の状態です。</p>
<h3 id="_49">実装: ステージにぷよを配置・取得する<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>では、テストが通るように <code>Stage</code> クラスを実装しましょう。</p>
<p><code>src/commonMain/kotlin/Stage.kt</code> を以下のように更新します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">field</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">IntArray</span><span class="o">&gt;</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">IntArray</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">):</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">field</span><span class="o">[</span><span class="n">y</span><span class="o">][</span><span class="n">x</span><span class="o">]</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">setPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">field</span><span class="o">[</span><span class="n">y</span><span class="o">][</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoType</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>すべてのテストが通りましたね！Green の状態です。</p>
<h3 id="_50">解説: ステージの実装<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>実装した <code>Stage</code> クラスについて解説しておきましょう。</p>
<p><strong>2 次元配列によるフィールド管理:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">field</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">IntArray</span><span class="o">&gt;</span>
</code></pre></div>
<p>ステージは 2 次元配列 <code>field</code> でぷよの配置を管理しています。<code>Array&lt;IntArray&gt;</code> は「配列の配列」で、以下のような構造になっています:</p>
<div class="highlight"><pre><span></span><code>field[y][x] = ぷよの種類

field = [
  [0, 0, 0, 0, 0, 0],  // y = 0 (一番上の行)
  [0, 0, 0, 0, 0, 0],  // y = 1
  ...
  [0, 0, 0, 0, 0, 0],  // y = 12 (一番下の行)
]
</code></pre></div>
<p>各要素の値は以下を表します:</p>
<ul>
<li><code>0</code>: 空のマス</li>
<li><code>1</code>: 赤ぷよ</li>
<li><code>2</code>: 青ぷよ</li>
<li><code>3</code>: 緑ぷよ</li>
<li><code>4</code>: 黄ぷよ</li>
</ul>
<p><strong>初期化処理:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">IntArray</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>initialize()</code> メソッドでは、ステージの高さ × 幅のサイズの 2 次元配列を作成し、全ての要素を <code>0</code>（空）で初期化しています。Kotlin では配列の初期化時にラムダ式を使えるので、とても簡潔に書けますね。</p>
<p><strong>ぷよの配置と取得:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">getPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">):</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">field</span><span class="o">[</span><span class="n">y</span><span class="o">][</span><span class="n">x</span><span class="o">]</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">setPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">field</span><span class="o">[</span><span class="n">y</span><span class="o">][</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoType</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>getPuyo(x, y)</code>: 指定座標のぷよの種類を取得</li>
<li><code>setPuyo(x, y, puyoType)</code>: 指定座標にぷよを配置</li>
</ul>
<p>注意点として、配列のインデックスは <code>field[y][x]</code> の順番になっています。「なぜ x が後なの？」と思われるかもしれませんね。これは一般的な 2 次元配列の表記法に従っているためです。</p>
<p>設定をコミットしておきましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Stage クラスにぷよの配置・取得機能を追加&#39;</span>
</code></pre></div>
<h3 id="_51">テスト: プレイヤーが新しいぷよを生成する<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>次に、プレイヤーが新しいぷよを生成する機能を実装しましょう。「ぷよが落ちてくる」ためには、まずぷよを生成する必要がありますよね。</p>
<p><code>src/commonTest/kotlin/PlayerTest.kt</code> を作成します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.Test</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.assertEquals</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.assertTrue</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">PlayerTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">新しいぷよを生成すると初期位置に配置される() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">)</span><span class="w"> </span><span class="c1">// ステージの中央（6マスの場合、x=2）</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span><span class="p">)</span><span class="w"> </span><span class="c1">// 一番上（y=0）</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">新しいぷよを生成するとぷよの種類が設定される() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="c1">// ぷよの種類は1〜4のいずれか</span>
<span class="w">        </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoType</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1.</span><span class="p">.</span><span class="m">4</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">新しいぷよを生成すると次のぷよも決まる() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="c1">// 次のぷよの種類も1〜4のいずれか</span>
<span class="w">        </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">nextPuyoType</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1.</span><span class="p">.</span><span class="m">4</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">新しいぷよを生成すると回転状態が0になる() {</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">rotation</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、以下の機能を確認しています:</p>
<ul>
<li>新しいぷよが初期位置（x=2, y=0）に配置されること</li>
<li>ぷよの種類が 1〜4 の範囲で設定されること</li>
<li>次のぷよの種類も決まること</li>
<li>回転状態が 0（上向き）になること</li>
</ul>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>まだ実装していないので、テストは失敗します。Red の状態ですね。</p>
<h3 id="_52">実装: プレイヤーが新しいぷよを生成する<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>では、<code>Player</code> クラスを実装していきましょう。</p>
<p><code>src/commonMain/kotlin/Player.kt</code> を以下のように更新します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.random.Random</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Stage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">puyoX</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">puyoY</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">puyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">nextPuyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">rotation</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createNewPuyo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">puyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c1">// ステージの中央</span>
<span class="w">        </span><span class="n">puyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">// 一番上</span>
<span class="w">        </span><span class="n">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="c1">// 1〜4のランダムな値</span>
<span class="w">        </span><span class="n">nextPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
<span class="w">        </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">// 回転状態を0（上向き）にリセット</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>すべてのテストが通りましたね！Green の状態です。</p>
<h3 id="_53">解説: ぷよの生成<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>実装した <code>Player</code> クラスのぷよ生成機能について解説しておきましょう。</p>
<p><strong>プレイヤーの状態:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nv">puyoX</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="kd">var</span><span class="w"> </span><span class="nv">puyoY</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="kd">var</span><span class="w"> </span><span class="nv">puyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="kd">var</span><span class="w"> </span><span class="nv">nextPuyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
<span class="kd">var</span><span class="w"> </span><span class="nv">rotation</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>
</code></pre></div>
<p>プレイヤーは以下の状態を持っています:</p>
<ul>
<li><code>puyoX</code>, <code>puyoY</code>: 現在のぷよの位置</li>
<li><code>puyoType</code>: 現在のぷよの種類（1〜4）</li>
<li><code>nextPuyoType</code>: 次のぷよの種類（1〜4）</li>
<li><code>rotation</code>: 回転状態（0〜3）</li>
</ul>
<p>これらのプロパティは <code>private set</code> により、外部から読み取りはできますが、書き込みはできません。「なぜ？」と思われるかもしれませんね。これは、プレイヤーの状態を <code>Player</code> クラス内でのみ変更できるようにするためです。これにより、意図しない状態変更を防げるんです。</p>
<p><strong>ぷよの生成処理:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">createNewPuyo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">puyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c1">// ステージの中央</span>
<span class="w">    </span><span class="n">puyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">// 一番上</span>
<span class="w">    </span><span class="n">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="c1">// 1〜4のランダムな値</span>
<span class="w">    </span><span class="n">nextPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
<span class="w">    </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">// 回転状態を0（上向き）にリセット</span>
<span class="p">}</span>
</code></pre></div>
<p><code>createNewPuyo()</code> メソッドでは、以下の処理を行っています:</p>
<ol>
<li><strong>初期位置の設定</strong>: ぷよをステージの中央上部（x=2, y=0）に配置</li>
<li><strong>ぷよの種類の決定</strong>: <code>Random.nextInt(1, 5)</code> で 1〜4 のランダムな値を生成</li>
<li><strong>次のぷよの準備</strong>: 次のぷよの種類も同時に決定</li>
<li><strong>回転状態のリセット</strong>: 回転状態を 0（上向き）にリセット</li>
</ol>
<p><strong>Random.nextInt について:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">Random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="c1">// 1以上5未満の整数 = 1, 2, 3, 4</span>
</code></pre></div>
<p>Kotlin の <code>Random.nextInt(from, until)</code> は、<code>from</code> 以上 <code>until</code> 未満の整数を生成します。したがって、<code>Random.nextInt(1, 5)</code> は 1, 2, 3, 4 のいずれかを返します。</p>
<p>設定をコミットしておきましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Player クラスにぷよ生成機能を追加&#39;</span>
</code></pre></div>
<h3 id="_54">テスト: ぷよが自動的に落下する<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>さて、ぷよが生成できるようになったので、次は「落下」機能を実装しましょう。ぷよぷよゲームの基本ですね！</p>
<p><code>src/commonTest/kotlin/PlayerTest.kt</code> にテストを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよを下に移動できる() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="c1">// 移動成功</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよがステ</span><span class="nf">ー</span><span class="err">ジの底に到達したら移動できない</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ぷよをステージの底まで移動</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertFalse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="c1">// 移動失敗</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよが着地判定できる() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ぷよをステージの底まで移動</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">hasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">hasLanded</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">着地したぷよをステ</span><span class="nf">ー</span><span class="err">ジに配置できる</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoType</span>

<span class="w">    </span><span class="c1">// ぷよをステージの底まで移動</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">finalX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">finalY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">placePuyoOnStage</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">finalX</span><span class="p">,</span><span class="w"> </span><span class="n">finalY</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、以下の機能を確認しています:</p>
<ul>
<li><code>moveDown()</code>: ぷよが下に移動できること</li>
<li>ステージの底に到達したら移動できないこと</li>
<li><code>hasLanded()</code>: 着地判定ができること</li>
<li><code>placePuyoOnStage()</code>: 着地したぷよをステージに配置できること</li>
</ul>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>まだ実装していないので、テストは失敗します。Red の状態です。</p>
<h3 id="_55">実装: ぷよが自動的に落下する<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>では、落下機能を実装していきましょう。</p>
<p><code>src/commonMain/kotlin/Player.kt</code> に以下のメソッドを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">moveDown</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 移動先にぷよがないかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">puyoY</span><span class="o">++</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">hasLanded</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージの底に到達したか</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 下にぷよがあるか</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">placePuyoOnStage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>すべてのテストが通りましたね！Green の状態です。</p>
<h3 id="_56">解説: ぷよの落下<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>実装した落下機能について解説しておきましょう。</p>
<p><strong>下への移動:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">moveDown</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 移動先にぷよがないかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">puyoY</span><span class="o">++</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>
<p><code>moveDown()</code> メソッドでは、以下のチェックを行っています:</p>
<ol>
<li><strong>境界チェック</strong>: ステージの底（<code>y = stageHeight - 1</code>）に到達していないか</li>
<li><strong>衝突チェック</strong>: 移動先のマスが空（値が 0）か</li>
</ol>
<p>両方の条件を満たせば、ぷよを下に移動させて <code>true</code> を返します。移動できない場合は <code>false</code> を返します。「移動できたかどうか」を返り値で知らせるんですね。</p>
<p><strong>着地判定:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">hasLanded</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージの底に到達したか</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 下にぷよがあるか</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>
<p><code>hasLanded()</code> メソッドでは、ぷよが着地したかを判定します。着地条件は以下の 2 つです:</p>
<ol>
<li>ステージの底に到達した</li>
<li>下のマスに既にぷよがある</li>
</ol>
<p>どちらかの条件を満たせば、ぷよは着地したと判断します。</p>
<p><strong>ステージへの配置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">placePuyoOnStage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><code>placePuyoOnStage()</code> メソッドは、着地したぷよをステージに配置します。現在のぷよの位置（<code>puyoX</code>, <code>puyoY</code>）と種類（<code>puyoType</code>）を使って、ステージの <code>setPuyo()</code> を呼び出すだけのシンプルな実装です。</p>
<p>設定をコミットしておきましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Player クラスにぷよ落下機能を追加&#39;</span>
</code></pre></div>
<h3 id="_57">ステージ上のぷよを画面に描画する<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>さて、ここまででぷよの生成と落下のロジックは完成しました。最後に、これらのぷよを実際に画面に表示しましょう！</p>
<h4 id="_58">ぷよの色定義<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h4>
<p>まず、ぷよの種類ごとに色を定義します。</p>
<p><code>src/commonMain/kotlin/PuyoColor.kt</code> を作成します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.graphics.Color</span>

<span class="kd">object</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">Empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">White</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">Red</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFFF4444</span><span class="p">)</span><span class="w">      </span><span class="c1">// 赤ぷよ (type = 1)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">Blue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF4444FF</span><span class="p">)</span><span class="w">     </span><span class="c1">// 青ぷよ (type = 2)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">Green</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF44FF44</span><span class="p">)</span><span class="w">    </span><span class="c1">// 緑ぷよ (type = 3)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">Yellow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFFFFF44</span><span class="p">)</span><span class="w">   </span><span class="c1">// 黄ぷよ (type = 4)</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getColor</span><span class="p">(</span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">):</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">puyoType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Red</span>
<span class="w">            </span><span class="m">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">            </span><span class="m">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Green</span>
<span class="w">            </span><span class="m">4</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Yellow</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このオブジェクトでは:</p>
<ul>
<li><code>object</code> キーワードでシングルトンを定義しています</li>
<li>ぷよの種類ごとに色を定義</li>
<li><code>getColor()</code> 関数でぷよの種類から色を取得</li>
</ul>
<h4 id="_59">ゲームステージの更新<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h4>
<p>次に、<code>GameStage.kt</code> を更新して、ステージ上のぷよと落下中のぷよを描画します。</p>
<p><code>src/commonMain/kotlin/GameStage.kt</code> を以下のように更新します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.Canvas</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.border</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.layout.size</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.runtime.Composable</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Modifier</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.geometry.CornerRadius</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.geometry.Offset</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.geometry.Size</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.graphics.Color</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.unit.dp</span>

<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">GameStage</span><span class="p">(</span><span class="n">game</span><span class="p">:</span><span class="w"> </span><span class="n">Game</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageWidthPx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">).</span><span class="na">dp</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stageHeightPx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">).</span><span class="na">dp</span>

<span class="w">    </span><span class="n">Canvas</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">            </span><span class="p">.</span><span class="na">size</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageWidthPx</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageHeightPx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">border</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">Black</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ステージの背景</span>
<span class="w">        </span><span class="n">drawRect</span><span class="p">(</span>
<span class="w">            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">White</span><span class="p">,</span>
<span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Size</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="na">width</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="na">height</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">cellSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">.</span><span class="na">toFloat</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// グリッド線の描画</span>
<span class="w">        </span><span class="c1">// 縦線</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0.</span><span class="p">.</span><span class="na">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">xPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span>
<span class="w">            </span><span class="n">drawLine</span><span class="p">(</span>
<span class="w">                </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">LightGray</span><span class="p">,</span>
<span class="w">                </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="n">xPos</span><span class="p">,</span><span class="w"> </span><span class="m">0f</span><span class="p">),</span>
<span class="w">                </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="n">xPos</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="na">height</span><span class="p">),</span>
<span class="w">                </span><span class="n">strokeWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1f</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 横線</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0.</span><span class="p">.</span><span class="na">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">yPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span>
<span class="w">            </span><span class="n">drawLine</span><span class="p">(</span>
<span class="w">                </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">LightGray</span><span class="p">,</span>
<span class="w">                </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span><span class="w"> </span><span class="n">yPos</span><span class="p">),</span>
<span class="w">                </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="na">width</span><span class="p">,</span><span class="w"> </span><span class="n">yPos</span><span class="p">),</span>
<span class="w">                </span><span class="n">strokeWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1f</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ステージ上のぷよを描画</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">drawPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">cellSize</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 落下中のぷよを描画</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">puyoType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">drawPuyo</span><span class="p">(</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">,</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">puyoY</span><span class="p">,</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">puyoType</span><span class="p">,</span>
<span class="w">                </span><span class="n">cellSize</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ぷよを描画する</span>
<span class="cm"> */</span>
<span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="n">androidx</span><span class="p">.</span><span class="nf">compose</span><span class="p">.</span><span class="na">ui</span><span class="p">.</span><span class="na">graphics</span><span class="p">.</span><span class="na">drawscope</span><span class="p">.</span><span class="na">DrawScope</span><span class="p">.</span><span class="na">drawPuyo</span><span class="p">(</span>
<span class="w">    </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">cellSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">padding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.1f</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">puyoSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">padding</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2</span>

<span class="w">    </span><span class="n">drawRoundRect</span><span class="p">(</span>
<span class="w">        </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="na">getColor</span><span class="p">(</span><span class="n">puyoType</span><span class="p">),</span>
<span class="w">        </span><span class="n">topLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span>
<span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">padding</span><span class="p">,</span>
<span class="w">            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">padding</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Size</span><span class="p">(</span><span class="n">puyoSize</span><span class="p">,</span><span class="w"> </span><span class="n">puyoSize</span><span class="p">),</span>
<span class="w">        </span><span class="n">cornerRadius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CornerRadius</span><span class="p">(</span><span class="n">puyoSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.2f</span><span class="p">,</span><span class="w"> </span><span class="n">puyoSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.2f</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// ぷよのハイライト（光沢効果）</span>
<span class="w">    </span><span class="n">drawCircle</span><span class="p">(</span>
<span class="w">        </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">White</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3f</span><span class="p">),</span>
<span class="w">        </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.2f</span><span class="p">,</span>
<span class="w">        </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span>
<span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.35f</span><span class="p">,</span>
<span class="w">            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.35f</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>この実装について解説しましょう:</p>
<p><strong>ぷよの描画関数:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="n">androidx</span><span class="p">.</span><span class="nf">compose</span><span class="p">.</span><span class="na">ui</span><span class="p">.</span><span class="na">graphics</span><span class="p">.</span><span class="na">drawscope</span><span class="p">.</span><span class="na">DrawScope</span><span class="p">.</span><span class="na">drawPuyo</span><span class="p">(</span>
<span class="w">    </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">cellSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p><code>drawPuyo()</code> は、<code>DrawScope</code> の拡張関数として定義されています。これにより、<code>Canvas</code> のスコープ内で <code>drawPuyo()</code> を呼び出せるようになります。</p>
<p><strong>ぷよの描画:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">padding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.1f</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">puyoSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">padding</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2</span>

<span class="n">drawRoundRect</span><span class="p">(</span>
<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="na">getColor</span><span class="p">(</span><span class="n">puyoType</span><span class="p">),</span>
<span class="w">    </span><span class="n">topLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">padding</span><span class="p">,</span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">padding</span>
<span class="w">    </span><span class="p">),</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Size</span><span class="p">(</span><span class="n">puyoSize</span><span class="p">,</span><span class="w"> </span><span class="n">puyoSize</span><span class="p">),</span>
<span class="w">    </span><span class="n">cornerRadius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CornerRadius</span><span class="p">(</span><span class="n">puyoSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.2f</span><span class="p">,</span><span class="w"> </span><span class="n">puyoSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.2f</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<ul>
<li>マスのサイズから 10% のパディングを確保</li>
<li>角丸の長方形でぷよを描画</li>
<li><code>cornerRadius</code> で角を丸くして、ぷよらしい見た目に</li>
</ul>
<p><strong>光沢効果:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// ぷよのハイライト（光沢効果）</span>
<span class="n">drawCircle</span><span class="p">(</span>
<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">White</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3f</span><span class="p">),</span>
<span class="w">    </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.2f</span><span class="p">,</span>
<span class="w">    </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Offset</span><span class="p">(</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.35f</span><span class="p">,</span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.35f</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>ぷよの左上に半透明の白い円を描画することで、光沢効果を表現しています。これにより、ぷよに立体感が出るんです。</p>
<h4 id="_60">アプリケーションの更新<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h4>
<p>最後に、<code>GameApp.kt</code> を更新して、ぷよが自動的に落下するようにします。ゲームループを実装して、500ms ごとにぷよを下に移動させましょう。</p>
<p><code>src/commonMain/kotlin/GameApp.kt</code> を以下のように更新します:</p>
<div class="highlight"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">com.example.puyopuyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.layout.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material.MaterialTheme</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material.Surface</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material.Text</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.runtime.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Alignment</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Modifier</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.unit.dp</span>

<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">GameApp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームインスタンスの作成と初期化</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Game</span><span class="p">().</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">initialize</span><span class="p">()</span>
<span class="w">                </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 再描画をトリガーするための状態</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">updateTrigger</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ゲームループ：500ms ごとにぷよを下に移動</span>
<span class="w">    </span><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">updateTrigger</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kotlinx</span><span class="p">.</span><span class="na">coroutines</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="m">500</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 移動できなかった場合は着地</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">placePuyoOnStage</span><span class="p">()</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">updateTrigger</span><span class="o">++</span><span class="w"> </span><span class="c1">// 再描画をトリガー</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">MaterialTheme</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Surface</span><span class="p">(</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colors</span><span class="p">.</span><span class="na">background</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Column</span><span class="p">(</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">                </span><span class="n">horizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">CenterHorizontally</span><span class="p">,</span>
<span class="w">                </span><span class="n">verticalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">Center</span><span class="p">,</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// タイトル</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ぷよぷよ&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">h3</span><span class="p">,</span>
<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                </span><span class="c1">// ゲームステージ</span>
<span class="w">                </span><span class="n">key</span><span class="p">(</span><span class="n">updateTrigger</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">GameStage</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                </span><span class="c1">// スコア表示</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">value</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">h5</span><span class="p">,</span>
<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                </span><span class="c1">// ゲームモード表示</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;モード: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">body1</span><span class="p">,</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>この更新では:</p>
<ul>
<li><code>player.createNewPuyo()</code> で最初のぷよを生成</li>
<li><code>updateTrigger</code> 状態で再描画をトリガー</li>
<li><code>LaunchedEffect</code> でゲームループを実装</li>
<li>500ms ごとにぷよを下に移動</li>
<li>移動できない場合は着地判定を行い、新しいぷよを生成</li>
<li><code>updateTrigger++</code> で次のループをトリガー</li>
<li><code>key(updateTrigger)</code> で GameStage を包むことで、状態が変わったときに再描画される</li>
</ul>
<h4 id="_61">アプリケーションの実行<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h4>
<p>さて、実装したアプリケーションを実行してみましょう！</p>
<div class="highlight"><pre><span></span><code><span class="c1"># デスクトップアプリケーションを起動</span>
$<span class="w"> </span>./gradlew<span class="w"> </span>run
</code></pre></div>
<p>ウィンドウが開いて、以下のような画面が表示されるはずです:</p>
<ul>
<li>ステージの中央上部に色付きのぷよが表示される</li>
<li>500ms ごとに自動的にぷよが下に落下する</li>
<li>ぷよが底に到達したら自動的に新しいぷよが生成される</li>
<li>ステージに配置されたぷよは残り続ける</li>
</ul>
<p>「動いた！ぷよが自動的に落ちてくる！」と感動しますよね。ゲームループが実装されて、ぷよぷよゲームらしくなってきました！</p>
<p>設定をコミットしておきましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの描画機能を実装&#39;</span>
</code></pre></div>
<h3 id="2_1">イテレーション 2 のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！イテレーション 2 が完了しました。このイテレーションで実装したことを振り返ってみましょう:</p>
<h4 id="_62">実装した機能<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> ステージにぷよを配置・取得する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> プレイヤーが新しいぷよを生成する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ぷよが自動的に落下する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ステージ上のぷよを画面に描画する</li>
</ul>
<h4 id="_63">実装したクラスとメソッド<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h4>
<p><strong>Stage クラス:</strong>
- <code>initialize()</code>: ステージを初期化
- <code>getPuyo(x, y)</code>: 指定座標のぷよを取得
- <code>setPuyo(x, y, puyoType)</code>: 指定座標にぷよを配置</p>
<p><strong>Player クラス:</strong>
- <code>createNewPuyo()</code>: 新しいぷよを生成
- <code>moveDown()</code>: ぷよを下に移動
- <code>hasLanded()</code>: ぷよが着地したか判定
- <code>placePuyoOnStage()</code>: 着地したぷよをステージに配置</p>
<p><strong>PuyoColor オブジェクト:</strong>
- <code>getColor(puyoType)</code>: ぷよの種類から色を取得</p>
<p><strong>GameStage コンポーネント:</strong>
- <code>drawPuyo()</code>: ぷよを描画する拡張関数</p>
<h4 id="_64">学んだこと<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>2 次元配列の使い方</strong>: ステージの状態を 2 次元配列で管理する方法を学びました</li>
<li><strong>private set の活用</strong>: プロパティの読み取りは許可しつつ、書き込みを制限する方法を理解しました</li>
<li><strong>境界チェックと衝突判定</strong>: ゲームロジックに必要な基本的なチェック処理を実装しました</li>
<li><strong>Kotlin の Random クラス</strong>: <code>Random.nextInt()</code> でランダムな値を生成する方法を学びました</li>
<li><strong>Compose の Canvas</strong>: <code>Canvas</code> を使った自由な描画方法を理解しました</li>
<li><strong>DrawScope の拡張関数</strong>: <code>DrawScope</code> の拡張関数として描画ロジックを分離する方法を学びました</li>
<li><strong>object によるシングルトン</strong>: Kotlin の <code>object</code> キーワードでシングルトンを定義する方法を理解しました</li>
<li><strong>mutableStateOf による状態管理</strong>: Compose での状態変更と再描画のトリガー方法を学びました</li>
<li><strong>LaunchedEffect によるゲームループ</strong>: コルーチンを使った自動実行と状態更新の仕組みを理解しました</li>
<li><strong>key による再描画制御</strong>: Compose での効率的な再描画のトリガー方法を学びました</li>
</ol>
<h4 id="_65">次のイテレーションへ<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h4>
<p>現在、ぷよは自動的に落下し、新しいぷよが生成されるようになりました。次のイテレーションでは、以下の機能を実装していきます:</p>
<ul>
<li>キーボード操作（左右移動、回転）</li>
<li>ぷよの回転機能</li>
<li>2 つのぷよ（軸ぷよと子ぷよ）の実装</li>
</ul>
<p>ゲームらしくなってきましたね。引き続き、テスト駆動開発のサイクルに従って、機能を追加していきましょう！</p>
<h2 id="3">イテレーション 3: ぷよの操作<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>イテレーション 2 では、ぷよの生成と落下機能を実装しました。しかし、ぷよを操作できないとゲームになりませんよね。このイテレーションでは、プレイヤーがぷよを左右に移動したり回転したりする機能を実装していきましょう！</p>
<blockquote>
<p>プログラミングとは、学習のプロセスである。テストを書き、プログラムを動かし、そして学ぶ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_66">ユーザーストーリー<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーは以下です:</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動したり回転したりして、好きな場所に配置できる</p>
</blockquote>
<p>ぷよぷよゲームの醍醐味である「ぷよの操作」ですね。ぷよを移動・回転させて、戦略的に配置していきましょう。</p>
<h3 id="todo_2">TODO リスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>今回のユーザーストーリーを実現するために必要なタスクを洗い出しましょう:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを左右に移動する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを回転する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 2 つのぷよ（軸ぷよと子ぷよ）を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> キーボードで操作できるようにする</li>
</ul>
<p>それでは、TDD のサイクルに従って、一つずつ実装していきましょう！</p>
<h3 id="_67">テスト: ぷよを左右に移動する<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>最初のタスクは、ぷよを左右に移動する機能です。プレイヤーがぷよを好きな位置に配置できるようにしましょう。</p>
<p><code>src/commonTest/kotlin/PlayerTest.kt</code> にテストを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよを左に移動できる() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">moveLeft</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよを右に移動できる() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">moveRight</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよが左端にある場合は左に移動できない() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ぷよを左端まで移動</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">moveLeft</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">)</span><span class="w"> </span><span class="c1">// 左端から動かない</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよが右端にある場合は右に移動できない() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ぷよを右端まで移動</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">moveRight</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">)</span><span class="w"> </span><span class="c1">// 右端から動かない</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">左に他のぷよがある場合は左に移動できない() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 左側にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">moveLeft</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">initialX</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">)</span><span class="w"> </span><span class="c1">// 移動しない</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">右に他のぷよがある場合は右に移動できない() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 右側にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">moveRight</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">initialX</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">)</span><span class="w"> </span><span class="c1">// 移動しない</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、以下の機能を確認しています:</p>
<ul>
<li>ぷよを左に移動できること</li>
<li>ぷよを右に移動できること</li>
<li>左端・右端で移動できないこと</li>
<li>他のぷよがある場合は移動できないこと</li>
</ul>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>まだ実装していないので、テストは失敗します。Red の状態ですね。</p>
<h3 id="_68">実装: ぷよを左右に移動する<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>では、<code>Player</code> クラスに左右移動の機能を実装していきましょう。</p>
<p><code>src/commonMain/kotlin/Player.kt</code> に以下のメソッドを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">moveLeft</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 移動先にぷよがないかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">puyoX</span><span class="o">--</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">moveRight</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 移動先にぷよがないかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">puyoX</span><span class="o">++</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>すべてのテストが通りましたね！Green の状態です。</p>
<h3 id="_69">解説: ぷよの左右移動<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>実装した左右移動機能について解説しておきましょう。</p>
<p><strong>左への移動:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">moveLeft</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 移動先にぷよがないかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">puyoX</span><span class="o">--</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>moveLeft()</code> メソッドでは、以下のチェックを行っています:</p>
<ol>
<li><strong>境界チェック</strong>: 左端（<code>x = 0</code>）に到達していないか</li>
<li><strong>衝突チェック</strong>: 移動先のマスが空（値が 0）か</li>
</ol>
<p>両方の条件を満たせば、ぷよを左に移動させます。</p>
<p><strong>右への移動:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">moveRight</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 移動先にぷよがないかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">puyoX</span><span class="o">++</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>moveRight()</code> メソッドも同様に、境界チェックと衝突チェックを行います。右端は <code>x = stageWidth - 1</code> です。</p>
<p><strong>moveDown() との類似性:</strong></p>
<p>「あれ？<code>moveDown()</code> と似ているな」と思いませんか？そうなんです。移動処理のパターンは以下のように共通しています:</p>
<ol>
<li>境界チェック</li>
<li>衝突チェック</li>
<li>移動</li>
</ol>
<p>この共通パターンに気づくことが、より良い設計への第一歩です。「重複を排除できないかな？」と考えることが大切ですが、今の段階ではこのままにしておきましょう。後のリファクタリングで改善できるかもしれませんね。</p>
<p>設定をコミットしておきましょう:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Player クラスにぷよの左右移動機能を追加&#39;</span>
</code></pre></div>
<h3 id="3_1">イテレーション 3 のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！イテレーション 3 が完了しました。このイテレーションで実装したことを振り返ってみましょう:</p>
<h4 id="_70">実装した機能<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> ぷよを左右に移動する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを回転する機能を実装する（次のイテレーションで実装予定）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 2 つのぷよ（軸ぷよと子ぷよ）を実装する（次のイテレーションで実装予定）</li>
<li class="task-list-item"><input type="checkbox" disabled/> キーボードで操作できるようにする（次のイテレーションで実装予定）</li>
</ul>
<h4 id="_71">実装したクラスとメソッド<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h4>
<p><strong>Player クラス:</strong>
- <code>moveLeft()</code>: ぷよを左に移動
- <code>moveRight()</code>: ぷよを右に移動</p>
<h4 id="_72">学んだこと<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>移動処理の共通パターン</strong>: 境界チェック → 衝突チェック → 移動という共通パターンを理解しました</li>
<li><strong>重複コードの認識</strong>: <code>moveLeft()</code>, <code>moveRight()</code>, <code>moveDown()</code> の類似性に気づき、将来のリファクタリングの可能性を学びました</li>
<li><strong>段階的な実装</strong>: 複雑な機能も小さなステップで確実に実装できることを体験しました</li>
</ol>
<h4 id="_73">次のイテレーションへ<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h4>
<p>現在、ぷよを左右に移動できるようになりましたが、まだ回転機能や 2 つのぷよ（軸ぷよと子ぷよ）、キーボード操作が実装されていません。次のイテレーションでは、これらの機能を実装していきます。</p>
<p>ぷよぷよゲームとして、少しずつ形になってきましたね。引き続き、テスト駆動開発のサイクルに従って、機能を追加していきましょう！</p>
<h2 id="4-2">イテレーション 4: 2 つのぷよと回転<a class="headerlink" href="#4-2" title="Permanent link">&para;</a></h2>
<p>イテレーション 3 では、ぷよの左右移動機能を実装しました。しかし、現在のぷよは 1 つだけで、回転もできません。本物のぷよぷよゲームでは、2 つのぷよ（軸ぷよと子ぷよ）が一組になって落ちてきて、回転させることができますよね。このイテレーションでは、2 つのぷよと回転機能を実装していきましょう！</p>
<blockquote>
<p>複雑さは段階的に追加する。一度に全てを実装しようとしない。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_74">ユーザーストーリー<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーは以下です:</p>
<blockquote>
<p>プレイヤーとして、2 つ一組のぷよを回転させて、好きな向きで配置できる</p>
</blockquote>
<p>ぷよぷよの醍醐味である「回転」ですね。2 つのぷよを回転させて、戦略的に配置していきましょう。</p>
<h3 id="todo_3">TODO リスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>今回のユーザーストーリーを実現するために必要なタスクを洗い出しましょう:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 2 つのぷよ（軸ぷよと子ぷよ）の概念を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを回転する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 回転時の壁蹴り（がべキック）を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 2 つのぷよを画面に描画する</li>
</ul>
<p>それでは、TDD のサイクルに従って、一つずつ実装していきましょう！</p>
<h3 id="2_2">テスト: 2 つのぷよ（軸ぷよと子ぷよ）<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<p>まず、2 つのぷよの概念を実装しましょう。ぷよぷよゲームでは、軸ぷよを中心に子ぷよが回転します。</p>
<p><code>src/commonTest/kotlin/PlayerTest.kt</code> にテストを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">新しいぷよを生成すると子ぷよの種類も設定される() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">childPuyoType</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1.</span><span class="p">.</span><span class="m">4</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">子ぷよの初期位置は軸ぷよの上() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="nv">childX</span><span class="p">,</span><span class="w"> </span><span class="nv">childY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">getChildPuyoPosition</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">childX</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">childY</span><span class="p">)</span><span class="w"> </span><span class="c1">// 軸ぷよの上</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_3">実装: 2 つのぷよ<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h3>
<p><code>Player</code> クラスに子ぷよのプロパティとメソッドを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nv">childPuyoType</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">createNewPuyo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">puyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<span class="w">    </span><span class="n">puyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="n">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
<span class="w">    </span><span class="n">childPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="c1">// 子ぷよの種類を設定</span>
<span class="w">    </span><span class="n">nextPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
<span class="w">    </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">getChildPuyoPosition</span><span class="p">():</span><span class="w"> </span><span class="n">Pair</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="m">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">        </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">        </span><span class="m">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 下</span>
<span class="w">        </span><span class="m">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_4">解説: 2 つのぷよ<a class="headerlink" href="#2_4" title="Permanent link">&para;</a></h3>
<p><strong>回転状態と子ぷよの位置:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">getChildPuyoPosition</span><span class="p">():</span><span class="w"> </span><span class="n">Pair</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="m">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">        </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">        </span><span class="m">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 下</span>
<span class="w">        </span><span class="m">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>rotation</code> の値によって、子ぷよの位置が決まります:
- <code>0</code>: 軸ぷよの上
- <code>1</code>: 軸ぷよの右
- <code>2</code>: 軸ぷよの下
- <code>3</code>: 軸ぷよの左</p>
<p>この仕組みにより、回転を実装するときは <code>rotation</code> の値を変えるだけで、子ぷよの位置が自動的に変わるんです。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Player クラスに子ぷよの概念を追加&#39;</span>
</code></pre></div>
<h3 id="_75">テスト: ぷよの回転<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>次に、回転機能のテストを書きます:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよを右回転できる() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">rotation</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">rotateRight</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">((</span><span class="n">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">rotation</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">ぷよを左回転できる() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">rotateLeft</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">rotation</span><span class="p">)</span><span class="w"> </span><span class="c1">// 0 から左回転すると 3</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">壁の近くで回転すると壁蹴りが発生する() {</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ぷよを右端まで移動</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">rotateRight</span><span class="p">()</span><span class="w"> </span><span class="c1">// 子ぷよが右に来る回転</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// 壁蹴りで左にずれる</span>
<span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">puyoX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_76">実装: ぷよの回転<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p><code>Player</code> クラスに回転メソッドを追加します:</p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">rotateRight</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">4</span>

<span class="w">    </span><span class="c1">// 回転後の子ぷよの位置を計算</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="nv">childX</span><span class="p">,</span><span class="w"> </span><span class="nv">childY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">newRotation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span>
<span class="w">            </span><span class="m">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="m">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 壁蹴り処理</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">puyoX</span><span class="o">++</span><span class="w"> </span><span class="c1">// 左端を超える場合、右にずらす</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">puyoX</span><span class="o">--</span><span class="w"> </span><span class="c1">// 右端を超える場合、左にずらす</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 再計算</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="nv">newChildX</span><span class="p">,</span><span class="w"> </span><span class="nv">newChildY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">newRotation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span>
<span class="w">            </span><span class="m">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="m">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 衝突チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newChildY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newChildY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">newChildX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newChildX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">newChildX</span><span class="p">,</span><span class="w"> </span><span class="n">newChildY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">rotateLeft</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">4</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="nv">childX</span><span class="p">,</span><span class="w"> </span><span class="nv">childY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">newRotation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span>
<span class="w">            </span><span class="m">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="m">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">puyoX</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">puyoX</span><span class="o">--</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="nv">newChildX</span><span class="p">,</span><span class="w"> </span><span class="nv">newChildY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">newRotation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span>
<span class="w">            </span><span class="m">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="m">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newChildY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newChildY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">newChildX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newChildX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">newChildX</span><span class="p">,</span><span class="w"> </span><span class="n">newChildY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_77">解説: 回転と壁蹴り<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p><strong>壁蹴り（がべキック）:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">puyoX</span><span class="o">++</span><span class="w"> </span><span class="c1">// 左端を超える場合、右にずらす</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">puyoX</span><span class="o">--</span><span class="w"> </span><span class="c1">// 右端を超える場合、左にずらす</span>
<span class="p">}</span>
</code></pre></div>
<p>壁蹴りは、回転後に子ぷよが壁の外に出てしまう場合、軸ぷよをずらして回転を可能にする処理です。これにより、壁際でも回転できるようになります。ぷよぷよゲームの重要なテクニックですね。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Player クラスにぷよの回転機能を追加&#39;</span>
</code></pre></div>
<h3 id="2_5">2 つのぷよの描画<a class="headerlink" href="#2_5" title="Permanent link">&para;</a></h3>
<p>最後に、<code>GameStage.kt</code> を更新して子ぷよも描画します:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 落下中のぷよを描画（軸ぷよ）</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">puyoType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">drawPuyo</span><span class="p">(</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">puyoX</span><span class="p">,</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">puyoY</span><span class="p">,</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">puyoType</span><span class="p">,</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 子ぷよの描画</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="nv">childX</span><span class="p">,</span><span class="w"> </span><span class="nv">childY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">getChildPuyoPosition</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">childY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">drawPuyo</span><span class="p">(</span><span class="n">childX</span><span class="p">,</span><span class="w"> </span><span class="n">childY</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">childPuyoType</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">puyoSize</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>また、<code>placePuyoOnStage()</code> も更新して、両方のぷよを配置するようにします:</p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">placePuyoOnStage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 軸ぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 子ぷよを配置</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="nv">childX</span><span class="p">,</span><span class="w"> </span><span class="nv">childY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChildPuyoPosition</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">childY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="n">childX</span><span class="p">,</span><span class="w"> </span><span class="n">childY</span><span class="p">,</span><span class="w"> </span><span class="n">childPuyoType</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 2つのぷよの描画を実装&#39;</span>
</code></pre></div>
<h3 id="4">イテレーション 4 のまとめ<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！イテレーション 4 が完了しました。</p>
<h4 id="_78">実装した機能<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> 2 つのぷよ（軸ぷよと子ぷよ）の概念を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ぷよを回転する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 回転時の壁蹴り（がべキック）を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 2 つのぷよを画面に描画する</li>
</ul>
<h4 id="_79">学んだこと<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>軸と子の関係</strong>: 軸ぷよを中心に子ぷよが回転する仕組みを理解しました</li>
<li><strong>回転状態の管理</strong>: <code>rotation</code> の値（0〜3）で 4 方向を表現する方法を学びました</li>
<li><strong>壁蹴り処理</strong>: ゲームの操作性を高める重要なテクニックを実装しました</li>
<li><strong>Pair の活用</strong>: Kotlin の <code>Pair</code> 型で座標を返す方法を学びました</li>
</ol>
<p>ぷよぷよゲームの基本的な操作機能が揃いましたね。次のイテレーションでは、キーボード操作と自動落下を実装していきましょう！</p>
<h2 id="5">イテレーション 5: キーボード操作とゲームループ<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>イテレーション 4 では、2 つのぷよと回転機能を実装しました。これで必要な操作機能は揃いましたが、まだボタンクリックでしか操作できませんし、ぷよは自動的に落ちてきません。このイテレーションでは、キーボード操作とゲームループを実装して、本物のぷよぷよゲームに近づけていきましょう！</p>
<blockquote>
<p>ソフトウェアは段階的に成長させる。小さな変更を繰り返し、常に動作する状態を保つ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_80">ユーザーストーリー<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーは以下です:</p>
<blockquote>
<p>プレイヤーとして、キーボードでぷよを操作し、自動的に落ちてくるぷよを楽しめる</p>
</blockquote>
<p>ゲームとして遊べる状態にしましょう。キーボードで操作でき、ぷよが自動的に落ちてくるようになります。</p>
<h3 id="todo_4">TODO リスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>今回のユーザーストーリーを実現するために必要なタスクを洗い出しましょう:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> キーボード操作を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームループを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 自動落下機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> テスト用ボタンを削除する</li>
</ul>
<p>それでは、実装していきましょう！</p>
<h3 id="_81">キーボード操作の実装<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>まず、キーボードイベントを処理できるようにします。Compose Desktop では、<code>onKeyEvent</code> を使ってキー入力を処理できます。</p>
<p><code>src/desktopMain/kotlin/Main.kt</code> を更新します:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.window.Window</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.window.application</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.input.key.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">com.example.puyopuyo.GameApp</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Window</span><span class="p">(</span>
<span class="w">        </span><span class="n">onCloseRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">exitApplication</span><span class="p">,</span>
<span class="w">        </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">onKeyEvent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">KeyEventType</span><span class="p">.</span><span class="na">KeyDown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">handleKeyEvent</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">key</span><span class="p">)</span>
<span class="w">                </span><span class="kc">true</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kc">false</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">GameApp</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">handleKeyEvent</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="p">):</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionLeft</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 左キー処理</span>
<span class="w">            </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionRight</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 右キー処理</span>
<span class="w">            </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionUp</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 上キー（回転）処理</span>
<span class="w">            </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionDown</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 下キー（高速落下）処理</span>
<span class="w">            </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Key</span><span class="p">.</span><span class="na">X</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// X キー（左回転）処理</span>
<span class="w">            </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>実際には、ゲームインスタンスにアクセスする必要があるため、<code>GameApp</code> 内でキーイベントを処理します。</p>
<p><code>src/commonMain/kotlin/GameApp.kt</code> を更新します:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">GameApp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームインスタンスの作成と初期化</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Game</span><span class="p">().</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">initialize</span><span class="p">()</span>
<span class="w">                </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 再描画をトリガーするための状態</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">updateTrigger</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">frameCount</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// フォーカス制御</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">focusRequester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FocusRequester</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ゲームループ：約60FPSで動作</span>
<span class="w">    </span><span class="n">LaunchedEffect</span><span class="p">(</span><span class="kt">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 起動時にフォーカスを要求</span>
<span class="w">        </span><span class="n">focusRequester</span><span class="p">.</span><span class="na">requestFocus</span><span class="p">()</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">kotlinx</span><span class="p">.</span><span class="na">coroutines</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="m">16</span><span class="p">)</span><span class="w"> </span><span class="c1">// 約60FPS</span>
<span class="w">            </span><span class="n">frameCount</span><span class="o">++</span>

<span class="w">            </span><span class="c1">// 約1秒ごとに落下</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 移動できなかった場合は着地</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">placePuyoOnStage</span><span class="p">()</span>
<span class="w">                        </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">updateTrigger</span><span class="o">++</span><span class="w"> </span><span class="c1">// 再描画をトリガー</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Box</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">Modifier</span>
<span class="w">                </span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">focusRequester</span><span class="p">(</span><span class="n">focusRequester</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">onKeyEvent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">KeyEventType</span><span class="p">.</span><span class="na">KeyDown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionLeft</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveLeft</span><span class="p">()</span>
<span class="w">                                </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                </span><span class="kc">true</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionRight</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveRight</span><span class="p">()</span>
<span class="w">                                </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                </span><span class="kc">true</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionUp</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="na">Z</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">rotateRight</span><span class="p">()</span>
<span class="w">                                </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                </span><span class="kc">true</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="n">Key</span><span class="p">.</span><span class="na">X</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">rotateLeft</span><span class="p">()</span>
<span class="w">                                </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                </span><span class="kc">true</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionDown</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">()</span>
<span class="w">                                </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                </span><span class="kc">true</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kc">false</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="p">.</span><span class="na">focusable</span><span class="p">(),</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MaterialTheme</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Surface</span><span class="p">(</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">                </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colors</span><span class="p">.</span><span class="na">background</span><span class="p">,</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Column</span><span class="p">(</span>
<span class="w">                    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">horizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">CenterHorizontally</span><span class="p">,</span>
<span class="w">                    </span><span class="n">verticalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">Center</span><span class="p">,</span>
<span class="w">                </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// タイトル</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                        </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ぷよぷよ&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">h3</span><span class="p">,</span>
<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                    </span><span class="c1">// ゲームステージ</span>
<span class="w">                    </span><span class="n">key</span><span class="p">(</span><span class="n">updateTrigger</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">GameStage</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="w">                    </span><span class="p">}</span>

<span class="w">                    </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                    </span><span class="c1">// スコア表示</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                        </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">value</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">h5</span><span class="p">,</span>
<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                    </span><span class="c1">// ゲームモード表示</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                        </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;モード: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">body1</span><span class="p">,</span>
<span class="w">                    </span><span class="p">)</span>

<span class="w">                    </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>

<span class="w">                    </span><span class="c1">// リセットボタン</span>
<span class="w">                    </span><span class="n">Button</span><span class="p">(</span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">game</span><span class="p">.</span><span class="na">reset</span><span class="p">()</span>
<span class="w">                        </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                    </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;リセット&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_82">解説: キーボード操作<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p><strong>FocusRequester によるフォーカス制御:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// フォーカス制御</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">focusRequester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FocusRequester</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>

<span class="n">LaunchedEffect</span><span class="p">(</span><span class="kt">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 起動時にフォーカスを要求</span>
<span class="w">    </span><span class="n">focusRequester</span><span class="p">.</span><span class="na">requestFocus</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="n">Box</span><span class="p">(</span>
<span class="w">    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">        </span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">focusRequester</span><span class="p">(</span><span class="n">focusRequester</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">onKeyEvent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="na">focusable</span><span class="p">()</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<ul>
<li><code>FocusRequester</code>: フォーカスを明示的に制御するためのオブジェクト</li>
<li><code>focusRequester.requestFocus()</code>: 起動時に自動的にフォーカスを取得</li>
<li><code>.focusRequester(focusRequester)</code>: Modifier にフォーカス制御を関連付け</li>
<li><code>.focusable()</code>: キーボードフォーカスを受け取れるようにする</li>
</ul>
<p><strong>onKeyEvent の使用:</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">.</span><span class="na">onKeyEvent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">KeyEventType</span><span class="p">.</span><span class="na">KeyDown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionLeft</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveLeft</span><span class="p">()</span>
<span class="w">                </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                </span><span class="kc">true</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// ...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>onKeyEvent</code>: キーボードイベントをキャプチャ</li>
<li><code>KeyEventType.KeyDown</code>: キーが押されたときのみ処理</li>
<li><code>updateTrigger++</code>: 画面を再描画</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: キーボード操作を実装&#39;</span>
</code></pre></div>
<h3 id="_83">ゲームループの実装<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p>次に、ゲームループを実装して、ぷよが自動的に落ちるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ゲームループ：約60FPSで動作</span>
<span class="n">LaunchedEffect</span><span class="p">(</span><span class="kt">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 起動時にフォーカスを要求</span>
<span class="w">    </span><span class="n">focusRequester</span><span class="p">.</span><span class="na">requestFocus</span><span class="p">()</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kotlinx</span><span class="p">.</span><span class="na">coroutines</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="m">16</span><span class="p">)</span><span class="w"> </span><span class="c1">// 約60FPS</span>
<span class="w">        </span><span class="n">frameCount</span><span class="o">++</span>

<span class="w">        </span><span class="c1">// 約1秒ごとに落下</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 移動できなかった場合は着地</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">placePuyoOnStage</span><span class="p">()</span>
<span class="w">                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">updateTrigger</span><span class="o">++</span><span class="w"> </span><span class="c1">// 再描画をトリガー</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_84">解説: ゲームループ<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p><strong>LaunchedEffect:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">LaunchedEffect</span><span class="p">(</span><span class="kt">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 起動時にフォーカスを要求</span>
<span class="w">    </span><span class="n">focusRequester</span><span class="p">.</span><span class="na">requestFocus</span><span class="p">()</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kotlinx</span><span class="p">.</span><span class="na">coroutines</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="m">16</span><span class="p">)</span><span class="w"> </span><span class="c1">// 約60FPS</span>
<span class="w">        </span><span class="n">frameCount</span><span class="o">++</span>

<span class="w">        </span><span class="c1">// 約1秒ごとに落下</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ぷよを落下させる</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>LaunchedEffect(Unit)</code>: Composable のライフサイクルに連動したコルーチンを起動</li>
<li><code>focusRequester.requestFocus()</code>: 起動時にキーボードフォーカスを自動取得</li>
<li><code>kotlinx.coroutines.delay(16)</code>: 約 60FPS で実行（16ms ≈ 1/60秒）</li>
<li><code>frameCount % 60 == 0</code>: 60 フレームごと（約1秒）に落下</li>
</ul>
<p>これにより、ぷよが自動的に落ちるようになります。また、起動時に自動的にフォーカスを取得することで、ユーザーがクリックしなくてもキーボード操作が可能になります。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームループと自動落下を実装&#39;</span>
</code></pre></div>
<h3 id="_85">テスト用ボタンの削除<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>最後に、イテレーション 2 で追加したテスト用ボタンを削除します。もうキーボードで操作できるので、ボタンは不要ですね。</p>
<p><code>GameApp.kt</code> から以下のコードを削除:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// テスト用ボタン（削除）</span>
<span class="n">Row</span><span class="p">(</span>
<span class="w">    </span><span class="n">horizontalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">spacedBy</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Button</span><span class="p">(</span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">()</span>
<span class="w">        </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">    </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;下に移動&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Button</span><span class="p">(</span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">placePuyoOnStage</span><span class="p">()</span>
<span class="w">            </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">    </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;新しいぷよ&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: テスト用ボタンを削除&#39;</span>
</code></pre></div>
<h3 id="_86">アプリケーションの実行<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>さあ、実装したアプリケーションを実行してみましょう！</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./gradlew<span class="w"> </span>run
</code></pre></div>
<p>今度こそ、本物のぷよぷよゲームとして遊べます:</p>
<ul>
<li>ぷよが自動的に落ちてくる</li>
<li>矢印キーで左右に移動</li>
<li>上キーまたは Z キーで右回転</li>
<li>X キーで左回転</li>
<li>下キーで高速落下</li>
</ul>
<p>「ついに遊べるゲームになった！」と感動しますよね。</p>
<h3 id="5_1">イテレーション 5 のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！イテレーション 5 が完了しました。</p>
<h4 id="_87">実装した機能<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> キーボード操作を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ゲームループを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 自動落下機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> テスト用ボタンを削除する</li>
</ul>
<h4 id="_88">学んだこと<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>onKeyEvent の使用</strong>: Compose でキーボード入力を処理する方法を学びました</li>
<li><strong>LaunchedEffect の活用</strong>: Composable のライフサイクルに連動したコルーチンを理解しました</li>
<li><strong>ゲームループの実装</strong>: 約60FPSで動作するゲームループを実装しました</li>
<li><strong>フレームカウント</strong>: フレーム数を数えて定期的な処理を実行する方法を学びました</li>
</ol>
<h4 id="_89">次のイテレーションへ<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h4>
<p>現在、ぷよぷよゲームとして遊べる状態になりましたが、まだ重要な機能が実装されていません:</p>
<ul>
<li>ぷよの消去機能（同じ色が 4 つ以上つながったら消える）</li>
<li>連鎖機能</li>
<li>ゲームオーバー判定</li>
<li>スコア計算</li>
</ul>
<p>次のイテレーションでは、これらの機能を実装して、完全なぷよぷよゲームに仕上げていきましょう！</p>
<p>ここまでで、テスト駆動開発のサイクルに従って、段階的にゲームを作り上げてきました。小さなステップを積み重ねることで、複雑なゲームも実装できることを体験できたのではないでしょうか。</p>
<h2 id="6">イテレーション 6: ぷよの消去処理<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="_90">ユーザーストーリー<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h3>
<blockquote>
<p>プレイヤーとして、同じ色のぷよが 4 つ以上つながったら消えて、重力で上のぷよが落ちてくるゲームを楽しめる</p>
</blockquote>
<p>このイテレーションでは、ぷよぷよの核心的な機能である「消去処理」を実装します。同じ色のぷよが 4 つ以上つながったら消え、その後重力が適用されて上のぷよが落下します。</p>
<h3 id="todo_5">TODO リスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装する機能:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 接続されたぷよを探索する機能を実装する（深さ優先探索）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 消去判定機能を実装する（4 つ以上つながったぷよを見つける）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 消去実行機能を実装する（つながったぷよを削除する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 重力処理を実装する（空いたスペースにぷよを落下させる）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームに消去処理を統合する</li>
</ul>
<h3 id="1_2">1. 接続されたぷよを探索する（深さ優先探索）<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<p>まずは、同じ色のぷよがどれだけつながっているかを調べる機能をテストから書いていきます。</p>
<h4 id="red">テストコード (Red)<a class="headerlink" href="#red" title="Permanent link">&para;</a></h4>
<p><code>Stage.kt</code> に消去関連の機能を追加します。まずはテストから：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// StageTest.kt</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">隣接する同じ色のぷよを探索できる() {</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 縦に4つ並べる</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">connectedPuyos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">searchConnectedPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">connectedPuyos</span><span class="p">.</span><span class="na">size</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">L</span><span class="err">字型につながったぷよを探索できる</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// L字型に配置</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">connectedPuyos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">searchConnectedPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">connectedPuyos</span><span class="p">.</span><span class="na">size</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは：
- 縦に 4 つ並んだぷよを探索できるか
- L 字型につながったぷよを探索できるか</p>
<p>をテストしています。</p>
<h4 id="green">実装コード (Green)<a class="headerlink" href="#green" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Stage.kt</span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">PuyoPosition</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">type</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 接続されたぷよを探索します（深さ優先探索）</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">searchConnectedPuyo</span><span class="p">(</span>
<span class="w">        </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">        </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">        </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">        </span><span class="n">visited</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">BooleanArray</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BooleanArray</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="n">MutableList</span><span class="o">&lt;</span><span class="n">PuyoPosition</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutableListOf</span><span class="p">()</span>
<span class="w">    </span><span class="p">):</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PuyoPosition</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 範囲外チェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">!in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">!in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 訪問済みチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">visited</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 同じ色かチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 訪問済みにする</span>
<span class="w">        </span><span class="n">visited</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">PuyoPosition</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">))</span>

<span class="w">        </span><span class="c1">// 上下左右を再帰的に探索</span>
<span class="w">        </span><span class="n">searchConnectedPuyo</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">        </span><span class="n">searchConnectedPuyo</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">        </span><span class="n">searchConnectedPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">        </span><span class="n">searchConnectedPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="c1">// 下</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_91">解説<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h4>
<p><strong>深さ優先探索（DFS: Depth-First Search）</strong></p>
<p>この実装では、深さ優先探索というアルゴリズムを使っています：</p>
<ol>
<li><strong>基底ケース（再帰の終了条件）</strong>:</li>
<li>範囲外なら終了</li>
<li>訪問済みなら終了</li>
<li>
<p>違う色なら終了</p>
</li>
<li>
<p><strong>再帰ケース</strong>:</p>
</li>
<li>現在位置を訪問済みにする</li>
<li>現在位置を結果に追加</li>
<li>上下左右の 4 方向に対して再帰的に探索</li>
</ol>
<p><strong>Kotlin のデフォルト引数</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">searchConnectedPuyo</span><span class="p">(</span>
<span class="w">    </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">visited</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">BooleanArray</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BooleanArray</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="n">MutableList</span><span class="o">&lt;</span><span class="n">PuyoPosition</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutableListOf</span><span class="p">()</span>
<span class="p">):</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PuyoPosition</span><span class="o">&gt;</span>
</code></pre></div>
<p>デフォルト引数を使うことで、最初の呼び出し時は <code>visited</code> と <code>result</code> を省略できます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 最初の呼び出し</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">searchConnectedPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="c1">// 再帰呼び出し時は visited と result を引き継ぐ</span>
<span class="n">searchConnectedPuyo</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<h4 id="_92">コミット<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: 接続されたぷよを探索する機能を実装&quot;</span>
</code></pre></div>
<h3 id="2_6">2. 消去判定機能を実装する<a class="headerlink" href="#2_6" title="Permanent link">&para;</a></h3>
<p>次に、ステージ全体をチェックして、4 つ以上つながったぷよを見つける機能を実装します。</p>
<h4 id="red_1">テストコード (Red)<a class="headerlink" href="#red_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// StageTest.kt</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">消去判定で4つ以上つながったぷよが見つかる() {</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 縦に4つ並べる（消える）</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>

<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">erasePuyoCount</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">消去判定で3つ以下のぷよは消えない() {</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 縦に3つだけ並べる（消えない）</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>

<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">erasePuyoCount</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">複数の色のぷよが混在していても正しく消去判定できる() {</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 赤4つ（消える）</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 青3つ（消えない）</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 赤の4つだけが消去対象</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">erasePuyoCount</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="green_1">実装コード (Green)<a class="headerlink" href="#green_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Stage.kt</span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">EraseInfo</span><span class="p">(</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">erasePuyoCount</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">eraseList</span><span class="p">:</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PuyoPosition</span><span class="o">&gt;</span>
<span class="p">)</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 消去可能なぷよをチェックします</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkErase</span><span class="p">():</span><span class="w"> </span><span class="n">EraseInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">eraseList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutableListOf</span><span class="o">&lt;</span><span class="n">PuyoPosition</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BooleanArray</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">visited</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">val</span><span class="w"> </span><span class="nv">connectedPuyos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">searchConnectedPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">)</span>

<span class="w">                    </span><span class="c1">// 4つ以上つながっていたら消去対象</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connectedPuyos</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">eraseList</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">connectedPuyos</span><span class="p">)</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EraseInfo</span><span class="p">(</span><span class="n">eraseList</span><span class="p">.</span><span class="na">size</span><span class="p">,</span><span class="w"> </span><span class="n">eraseList</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_93">解説<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h4>
<p><strong>消去判定のアルゴリズム</strong></p>
<ol>
<li>ステージ全体をループ</li>
<li>各マスについて、まだ訪問していない場合：</li>
<li>接続されたぷよを探索</li>
<li>4 つ以上つながっていたら消去リストに追加</li>
</ol>
<p><strong>visited フラグの重要性</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BooleanArray</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p><code>visited</code> フラグを使うことで：
- 同じぷよを重複してチェックしない
- 効率的に探索できる</p>
<p>例えば、4 つつながったぷよがある場合：
- 最初のぷよから探索して 4 つ見つかる
- 次のぷよはすでに <code>visited</code> なのでスキップ
- 重複して数えることがない</p>
<h4 id="_94">コミット<a class="headerlink" href="#_94" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: 消去判定機能を実装&quot;</span>
</code></pre></div>
<h3 id="3_2">3. 消去実行機能を実装する<a class="headerlink" href="#3_2" title="Permanent link">&para;</a></h3>
<p>消去対象のぷよを実際に削除する機能を実装します。</p>
<h4 id="red_2">テストコード (Red)<a class="headerlink" href="#red_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// StageTest.kt</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">消去リストのぷよを削除できる() {</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 縦に4つ並べる</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">executeErase</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">eraseList</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// すべて0になっている</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="green_2">実装コード (Green)<a class="headerlink" href="#green_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Stage.kt</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 消去対象のぷよを消去します</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">executeErase</span><span class="p">(</span><span class="n">eraseList</span><span class="p">:</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PuyoPosition</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">puyo</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eraseList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">board</span><span class="o">[</span><span class="n">puyo</span><span class="p">.</span><span class="na">x</span><span class="o">][</span><span class="n">puyo</span><span class="p">.</span><span class="na">y</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_95">解説<a class="headerlink" href="#_95" title="Permanent link">&para;</a></h4>
<p>この関数はシンプルで、消去リストに含まれるぷよを順番に <code>0</code> にしていくだけです。</p>
<h4 id="_96">コミット<a class="headerlink" href="#_96" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: 消去実行機能を実装&quot;</span>
</code></pre></div>
<h3 id="4_1">4. 重力処理を実装する<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>ぷよを消した後、空いたスペースに上のぷよを落下させる機能を実装します。</p>
<h4 id="red_3">テストコード (Red)<a class="headerlink" href="#red_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// StageTest.kt</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">重力を適用すると空中に浮いているぷよが落下する() {</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 下に空きがある状態でぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 空中に浮いている</span>

<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">applyGravity</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 一番下まで落ちる</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">))</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">重力を適用すると複数のぷよが正しく落下する() {</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 下に土台がある状態</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 土台</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// 浮いている</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">  </span><span class="c1">// 浮いている</span>

<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">applyGravity</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 土台の上に積み重なる</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">))</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">重力適用時に途中で消えたぷよの上のぷよが落ちる() {</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 下から: 赤4つ（消える）、その上に青1つ</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// 青</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 赤（L字の一部）</span>

<span class="w">    </span><span class="c1">// 消去判定→消去実行</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">executeErase</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">eraseList</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 重力適用</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">applyGravity</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 青が一番下まで落ちる</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">))</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="green_3">実装コード (Green)<a class="headerlink" href="#green_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Stage.kt</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 重力を適用してぷよを落下させます</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">applyGravity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 各列について処理</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 下から詰めていく位置</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nv">writeY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span>

<span class="w">            </span><span class="c1">// 下から上に向かってぷよを探索</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">readY</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="n">downTo</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">readY</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// ぷよがある場合、下に詰める</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readY</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">writeY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">board</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">writeY</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">readY</span><span class="o">]</span>
<span class="w">                        </span><span class="n">board</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">readY</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">writeY</span><span class="o">--</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_97">解説<a class="headerlink" href="#_97" title="Permanent link">&para;</a></h4>
<p><strong>重力処理のアルゴリズム</strong></p>
<p>この実装は「2 ポインタ」アルゴリズムを使っています：</p>
<ol>
<li><code>writeY</code>: 次にぷよを書き込む位置（下から）</li>
<li><code>readY</code>: 現在読み取っているぷよの位置（下から上へ）</li>
</ol>
<p>処理の流れ：</p>
<div class="highlight"><pre><span></span><code>初期状態:        処理中:         結果:
0  0  0         0  0  0        0  0  0
2  2  0         0  2  0        0  0  0
0  0  0   →    0  0  0   →   2  2  0
1  1  0         2  2  0        1  1  0
</code></pre></div>
<p>各列ごとに：
- 下から上に向かってぷよを探索（<code>readY</code>）
- ぷよを見つけたら、下から詰めていく（<code>writeY</code>）
- 読み取り位置と書き込み位置が違う場合は移動</p>
<p><strong>Kotlin の downTo</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">readY</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="n">downTo</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
</code></pre></div>
<p><code>downTo</code> は Kotlin の範囲演算子で、降順にループします：
- <code>13 downTo 0</code> は 13, 12, 11, ..., 1, 0 の順</p>
<h4 id="_98">コミット<a class="headerlink" href="#_98" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: 重力処理を実装&quot;</span>
</code></pre></div>
<h3 id="5_2">5. ゲームに消去処理を統合する<a class="headerlink" href="#5_2" title="Permanent link">&para;</a></h3>
<p>最後に、ゲームループに消去処理を組み込みます。</p>
<h4 id="_99">実装コード<a class="headerlink" href="#_99" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// App.kt の LaunchedEffect 内を修正</span>
<span class="n">LaunchedEffect</span><span class="p">(</span><span class="kt">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">delay</span><span class="p">(</span><span class="m">16</span><span class="p">)</span><span class="w"> </span><span class="c1">// 約60FPS</span>
<span class="w">        </span><span class="n">frameCount</span><span class="o">++</span>

<span class="w">        </span><span class="c1">// 約1秒ごとに落下</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 着地した</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">placePuyoOnStage</span><span class="p">()</span>

<span class="w">                    </span><span class="c1">// 消去処理を実行</span>
<span class="w">                    </span><span class="kd">var</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>
<span class="w">                    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// 消去実行</span>
<span class="w">                        </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">executeErase</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">eraseList</span><span class="p">)</span>

<span class="w">                        </span><span class="c1">// 重力適用</span>
<span class="w">                        </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">applyGravity</span><span class="p">()</span>

<span class="w">                        </span><span class="c1">// 再度消去判定（連鎖のため）</span>
<span class="w">                        </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>
<span class="w">                    </span><span class="p">}</span>

<span class="w">                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_100">解説<a class="headerlink" href="#_100" title="Permanent link">&para;</a></h4>
<p><strong>消去処理のループ</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">executeErase</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">eraseList</span><span class="p">)</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">applyGravity</span><span class="p">()</span>
<span class="w">    </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">checkErase</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>このループは：
1. 消去判定を行う
2. 消去するぷよがある場合：
   - ぷよを消す
   - 重力を適用
   - 再度消去判定（連鎖のため）
3. 消去するぷよがなくなるまで繰り返す</p>
<p>これにより、連鎖が自動的に処理されます！</p>
<blockquote>
<p><strong>連鎖の例</strong></p>
<div class="highlight"><pre><span></span><code>ステップ1: 着地
○ ○ ○ ●
○ ○ ● ●
○ ● ● ●
● ● ● ●  ← 4つつながった

ステップ2: 消去
○ ○ ○
○ ○
○

ステップ3: 重力


○ ○ ○
○ ○ ○    ← ここで再び4つつながる

ステップ4: 連鎖！
</code></pre></div>
</blockquote>
<h4 id="_101">コミット<a class="headerlink" href="#_101" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: ゲームに消去処理を統合&quot;</span>
</code></pre></div>
<h3 id="6_1">イテレーション 6 のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！イテレーション 6 が完了しました。</p>
<h4 id="_102">実装した機能<a class="headerlink" href="#_102" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> 接続されたぷよを探索する機能を実装する（深さ優先探索）</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 消去判定機能を実装する（4 つ以上つながったぷよを見つける）</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 消去実行機能を実装する（つながったぷよを削除する）</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 重力処理を実装する（空いたスペースにぷよを落下させる）</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ゲームに消去処理を統合する</li>
</ul>
<h4 id="_103">学んだこと<a class="headerlink" href="#_103" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>深さ優先探索（DFS）アルゴリズム</strong></li>
<li>再帰を使った探索アルゴリズム</li>
<li><code>visited</code> フラグで重複チェックを防ぐ</li>
<li>
<p>上下左右の 4 方向を探索</p>
</li>
<li>
<p><strong>Kotlin のデフォルト引数</strong></p>
</li>
<li>再帰関数で便利に使える</li>
<li>
<p>最初の呼び出しと再帰呼び出しで引数を変えられる</p>
</li>
<li>
<p><strong>2 ポインタアルゴリズム</strong></p>
</li>
<li>重力処理で使用</li>
<li>
<p>読み取り位置と書き込み位置を分けて管理</p>
</li>
<li>
<p><strong>連鎖処理</strong></p>
</li>
<li>ループで消去→重力→消去判定を繰り返す</li>
<li>シンプルなロジックで自然に連鎖が実現</li>
</ol>
<h4 id="_104">次のイテレーションへ<a class="headerlink" href="#_104" title="Permanent link">&para;</a></h4>
<p>ぷよぷよの基本的なゲーム性が完成しました！次のイテレーションでは：</p>
<ul>
<li>スコア計算（消したぷよの数と連鎖数に応じて）</li>
<li>ゲームオーバー判定（画面上部にぷよが到達したら）</li>
<li>ゲームオーバー画面の表示</li>
</ul>
<p>これらを実装して、完全なぷよぷよゲームに仕上げていきましょう！</p>
<h2 id="7">イテレーション 7: スコア計算とゲームオーバー<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="_105">ユーザーストーリー<a class="headerlink" href="#_105" title="Permanent link">&para;</a></h3>
<blockquote>
<p>プレイヤーとして、ぷよを消したときにスコアが加算され、ゲームオーバーになったら結果が表示されるゲームを楽しめる</p>
</blockquote>
<p>このイテレーションでは、ゲームを完成させるための最終的な機能を実装します。スコア計算、連鎖ボーナス、全消しボーナス、ゲームオーバー判定、そしてゲームオーバー画面を追加します。</p>
<h3 id="todo_6">TODO リスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装する機能:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> スコアクラスを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> スコア計算機能を実装する（消去数 × 連鎖ボーナス）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 全消しボーナスを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームオーバー判定を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームオーバー画面を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> リスタート機能を実装する</li>
</ul>
<h3 id="1_3">1. スコアクラスを実装する<a class="headerlink" href="#1_3" title="Permanent link">&para;</a></h3>
<p>まずは、スコアを管理するクラスをテストから作っていきます。</p>
<h4 id="red_4">テストコード (Red)<a class="headerlink" href="#red_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// ScoreTest.kt</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.Test</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlin.test.assertEquals</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">ScoreTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">スコアの初期値は0() {</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">()</span>

<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="na">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">スコアを加算できる() {</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">()</span>

<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>

<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="na">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="err">スコアをリセットできる() {</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">()</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="m">500</span><span class="p">)</span>

<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="na">reset</span><span class="p">()</span>

<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="na">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="green_4">実装コード (Green)<a class="headerlink" href="#green_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Score.kt</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">value</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">set</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * スコアを加算します</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">points</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">points</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * スコアをリセットします</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_106">解説<a class="headerlink" href="#_106" title="Permanent link">&para;</a></h4>
<p>シンプルなスコア管理クラスです。<code>value</code> プロパティは外部から読み取り専用で、<code>add()</code> と <code>reset()</code> メソッドでのみ変更できます。</p>
<h4 id="_107">コミット<a class="headerlink" href="#_107" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: スコアクラスを実装&quot;</span>
</code></pre></div>
<h3 id="2_7">2. スコア計算機能を実装する<a class="headerlink" href="#2_7" title="Permanent link">&para;</a></h3>
<p>次に、消去したぷよの数と連鎖数に応じてスコアを計算する機能を実装します。</p>
<h4 id="red_5">テストコード (Red)<a class="headerlink" href="#red_5" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// ScoreTest.kt</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">消去数に応じてスコアを計算できる() {</span>
<span class="w">    </span><span class="c1">// 4個消去、1連鎖</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="n">score1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 × 10 × 1 = 40</span>

<span class="w">    </span><span class="c1">// 5個消去、1連鎖</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">score2</span><span class="p">)</span><span class="w"> </span><span class="c1">// 5 × 10 × 1 = 50</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">連鎖数に応じてスコアボ</span><span class="nf">ー</span><span class="err">ナスが増える</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 4個消去、1連鎖</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="n">score1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 × 10 × 1 = 40</span>

<span class="w">    </span><span class="c1">// 4個消去、2連鎖</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">320</span><span class="p">,</span><span class="w"> </span><span class="n">score2</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 × 10 × 8 = 320</span>

<span class="w">    </span><span class="c1">// 4個消去、3連鎖</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">640</span><span class="p">,</span><span class="w"> </span><span class="n">score3</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 × 10 × 16 = 640</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">高連鎖になるほどボ</span><span class="nf">ー</span><span class="err">ナスが大きくなる</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 5連鎖</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">2560</span><span class="p">,</span><span class="w"> </span><span class="n">score5</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 × 10 × 64 = 2560</span>

<span class="w">    </span><span class="c1">// 8連鎖以上</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">6400</span><span class="p">,</span><span class="w"> </span><span class="n">score8</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 × 10 × 160 = 6400</span>

<span class="w">    </span><span class="c1">// 10連鎖（8連鎖以上は同じボーナス）</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span>
<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">6400</span><span class="p">,</span><span class="w"> </span><span class="n">score10</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 × 10 × 160 = 6400</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="green_5">実装コード (Green)<a class="headerlink" href="#green_5" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Score.kt</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="kd">companion</span><span class="w"> </span><span class="kd">object</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="cm">/**</span>
<span class="cm">         * スコアを計算します</span>
<span class="cm">         *</span>
<span class="cm">         * @param erasedCount 消去したぷよの数</span>
<span class="cm">         * @param chainCount 連鎖数</span>
<span class="cm">         * @return 計算されたスコア</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="kd">fun</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">erasedCount</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">chainCount</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">):</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 基本点: 消去数 × 10</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">basePoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erasedCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">10</span>

<span class="w">            </span><span class="c1">// 連鎖ボーナス倍率</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">chainCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">1</span><span class="w">      </span><span class="c1">// 1連鎖: ×1</span>
<span class="w">                </span><span class="m">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">8</span><span class="w">      </span><span class="c1">// 2連鎖: ×8</span>
<span class="w">                </span><span class="m">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">16</span><span class="w">     </span><span class="c1">// 3連鎖: ×16</span>
<span class="w">                </span><span class="m">4</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">32</span><span class="w">     </span><span class="c1">// 4連鎖: ×32</span>
<span class="w">                </span><span class="m">5</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">64</span><span class="w">     </span><span class="c1">// 5連鎖: ×64</span>
<span class="w">                </span><span class="m">6</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">96</span><span class="w">     </span><span class="c1">// 6連鎖: ×96</span>
<span class="w">                </span><span class="m">7</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">128</span><span class="w">    </span><span class="c1">// 7連鎖: ×128</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">160</span><span class="w"> </span><span class="c1">// 8連鎖以上: ×160</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">basePoints</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chainBonus</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_108">解説<a class="headerlink" href="#_108" title="Permanent link">&para;</a></h4>
<p><strong>スコア計算式</strong></p>
<div class="highlight"><pre><span></span><code>スコア = 消去数 × 10 × 連鎖ボーナス
</code></pre></div>
<p><strong>連鎖ボーナステーブル</strong></p>
<table>
<thead>
<tr>
<th>連鎖数</th>
<th>ボーナス倍率</th>
</tr>
</thead>
<tbody>
<tr>
<td>1連鎖</td>
<td>×1</td>
</tr>
<tr>
<td>2連鎖</td>
<td>×8</td>
</tr>
<tr>
<td>3連鎖</td>
<td>×16</td>
</tr>
<tr>
<td>4連鎖</td>
<td>×32</td>
</tr>
<tr>
<td>5連鎖</td>
<td>×64</td>
</tr>
<tr>
<td>6連鎖</td>
<td>×96</td>
</tr>
<tr>
<td>7連鎖</td>
<td>×128</td>
</tr>
<tr>
<td>8連鎖以上</td>
<td>×160</td>
</tr>
</tbody>
</table>
<p>この倍率により、連鎖を続けるほど爆発的にスコアが増えます。</p>
<p><strong>companion object</strong></p>
<p>Kotlin の <code>companion object</code> は、クラスのインスタンスを作らずに呼び出せる静的メソッドを定義するための機能です：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// インスタンス不要で呼び出せる</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
</code></pre></div>
<h4 id="_109">コミット<a class="headerlink" href="#_109" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: スコア計算機能を実装&quot;</span>
</code></pre></div>
<h3 id="3_3">3. 全消しボーナスを実装する<a class="headerlink" href="#3_3" title="Permanent link">&para;</a></h3>
<p>ステージ上のぷよをすべて消した場合のボーナスを実装します。</p>
<h4 id="red_6">テストコード (Red)<a class="headerlink" href="#red_6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// ScoreTest.kt</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">全消しボ</span><span class="nf">ー</span><span class="err">ナスを計算できる</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculateAllClearBonus</span><span class="p">()</span>

<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="m">3600</span><span class="p">,</span><span class="w"> </span><span class="n">bonus</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="green_6">実装コード (Green)<a class="headerlink" href="#green_6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Score.kt</span>
<span class="kd">companion</span><span class="w"> </span><span class="kd">object</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 全消しボーナスを計算します</span>
<span class="cm">     *</span>
<span class="cm">     * @return 全消しボーナスのポイント</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">calculateAllClearBonus</span><span class="p">():</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">3600</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_110">解説<a class="headerlink" href="#_110" title="Permanent link">&para;</a></h4>
<p>全消しボーナスは固定で 3600 ポイントです。イテレーション 6 で実装した <code>Stage.isAllClear()</code> メソッドと組み合わせて使います。</p>
<h4 id="_111">コミット<a class="headerlink" href="#_111" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: 全消しボーナスを実装&quot;</span>
</code></pre></div>
<h3 id="4_2">4. ゲームにスコア計算を統合する<a class="headerlink" href="#4_2" title="Permanent link">&para;</a></h3>
<p>ゲームに <code>Score</code> クラスを追加し、連鎖が発生したときにスコアを加算するようにします。</p>
<h4 id="_112">実装コード<a class="headerlink" href="#_112" title="Permanent link">&para;</a></h4>
<p>まず、<code>Game</code> クラスに <code>Score</code> を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Game.kt</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">()</span><span class="w">  </span><span class="c1">// 追加</span>

<span class="w">    </span><span class="k">init</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>次に、<code>Stage.kt</code> に連鎖情報を返す機能を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Stage.kt</span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">ChainInfo</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">erasedPuyoCount</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span>

<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">ChainResult</span><span class="p">(</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainCount</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainInfoList</span><span class="p">:</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ChainInfo</span><span class="o">&gt;</span>
<span class="p">)</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Stage</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 連鎖処理を実行します</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">processChain</span><span class="p">():</span><span class="w"> </span><span class="n">ChainResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainInfoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutableListOf</span><span class="o">&lt;</span><span class="n">ChainInfo</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 消去判定</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkErase</span><span class="p">()</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">erasePuyoCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 消去するぷよがなければ終了</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 連鎖情報を記録</span>
<span class="w">            </span><span class="n">chainInfoList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ChainInfo</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">erasePuyoCount</span><span class="p">))</span>

<span class="w">            </span><span class="c1">// 消去実行</span>
<span class="w">            </span><span class="n">executeErase</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="na">eraseList</span><span class="p">)</span>
<span class="w">            </span><span class="n">chainCount</span><span class="o">++</span>

<span class="w">            </span><span class="c1">// 重力適用</span>
<span class="w">            </span><span class="n">applyGravity</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ChainResult</span><span class="p">(</span><span class="n">chainCount</span><span class="p">,</span><span class="w"> </span><span class="n">chainInfoList</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 全消し判定を行います</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">isAllClear</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>そして、<code>App.kt</code> のゲームループを更新します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// App.kt の LaunchedEffect 内を修正</span>
<span class="n">LaunchedEffect</span><span class="p">(</span><span class="kt">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">delay</span><span class="p">(</span><span class="m">16</span><span class="p">)</span><span class="w"> </span><span class="c1">// 約60FPS</span>
<span class="w">        </span><span class="n">frameCount</span><span class="o">++</span>

<span class="w">        </span><span class="c1">// 約1秒ごとに落下</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 着地した</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">placePuyoOnStage</span><span class="p">()</span>

<span class="w">                    </span><span class="c1">// 連鎖処理を実行</span>
<span class="w">                    </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">processChain</span><span class="p">()</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chainResult</span><span class="p">.</span><span class="na">chainCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// 各連鎖のスコアを計算</span>
<span class="w">                        </span><span class="n">chainResult</span><span class="p">.</span><span class="na">chainInfoList</span><span class="p">.</span><span class="na">forEachIndexed</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">chainInfo</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                            </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1">// 連鎖数は1から始まる</span>
<span class="w">                            </span><span class="kd">val</span><span class="w"> </span><span class="nv">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span>
<span class="w">                                </span><span class="n">chainInfo</span><span class="p">.</span><span class="na">erasedPuyoCount</span><span class="p">,</span>
<span class="w">                                </span><span class="n">chainNumber</span>
<span class="w">                            </span><span class="p">)</span>
<span class="w">                            </span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="w">                        </span><span class="p">}</span>

<span class="w">                        </span><span class="c1">// 全消し判定を行い、全消しならボーナスを加算</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">isAllClear</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="kd">val</span><span class="w"> </span><span class="nv">bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculateAllClearBonus</span><span class="p">()</span>
<span class="w">                            </span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">bonus</span><span class="p">)</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>

<span class="w">                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>最後に、スコアを画面に表示します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// App.kt</span>
<span class="n">Column</span><span class="p">(</span>
<span class="w">    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">    </span><span class="n">horizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">CenterHorizontally</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// スコア表示を追加</span>
<span class="w">    </span><span class="n">Text</span><span class="p">(</span>
<span class="w">        </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">value</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">fontSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24.</span><span class="n">sp</span><span class="p">,</span>
<span class="w">        </span><span class="n">fontWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FontWeight</span><span class="p">.</span><span class="na">Bold</span><span class="p">,</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">Canvas</span><span class="p">(</span><span class="cm">/* ... 既存の Canvas コード ... */</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// キーボード操作の Box</span>
<span class="w">    </span><span class="n">Box</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_113">解説<a class="headerlink" href="#_113" title="Permanent link">&para;</a></h4>
<p><strong>連鎖処理の変更</strong></p>
<p>以前のイテレーションでは、消去処理をループで実装していましたが、今回は <code>processChain()</code> メソッドに統合しました。このメソッドは：</p>
<ol>
<li>消去→重力→消去判定を繰り返す</li>
<li>各連鎖で消去したぷよの数を記録</li>
<li>連鎖数と詳細情報を返す</li>
</ol>
<p><strong>スコア加算のロジック</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">chainResult</span><span class="p">.</span><span class="na">chainInfoList</span><span class="p">.</span><span class="na">forEachIndexed</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">chainInfo</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1">// 連鎖数は1から始まる</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span>
<span class="w">        </span><span class="n">chainInfo</span><span class="p">.</span><span class="na">erasedPuyoCount</span><span class="p">,</span>
<span class="w">        </span><span class="n">chainNumber</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><code>forEachIndexed</code> を使って、各連鎖のインデックス（0始まり）と情報を取得し、連鎖数（1始まり）に変換してスコアを計算します。</p>
<p><strong>全消しボーナス</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">isAllClear</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculateAllClearBonus</span><span class="p">()</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">bonus</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>連鎖処理が終わった後、ステージが空になっていたら全消しボーナスを加算します。</p>
<h4 id="_114">コミット<a class="headerlink" href="#_114" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: ゲームにスコア計算を統合&quot;</span>
</code></pre></div>
<h3 id="5_3">5. ゲームオーバー判定を実装する<a class="headerlink" href="#5_3" title="Permanent link">&para;</a></h3>
<p>新しいぷよが生成できなくなったらゲームオーバーにする機能を実装します。</p>
<h4 id="red_7">テストコード (Red)<a class="headerlink" href="#red_7" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// PlayerTest.kt</span>
<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">新しいぷよの位置にすでにぷよがあるとゲ</span><span class="nf">ー</span><span class="err">ムオ</span><span class="n">ー</span><span class="err">バ</span><span class="n">ー</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよの初期位置（2, 0）にぷよを配置</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">setPuyo</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">checkGameOver</span><span class="p">()</span>

<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">isGameOver</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="err">新しいぷよの位置が空いているとゲ</span><span class="nf">ー</span><span class="err">ムオ</span><span class="n">ー</span><span class="err">バ</span><span class="n">ー</span><span class="err">ではない</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="na">checkGameOver</span><span class="p">()</span>

<span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">isGameOver</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="green_7">実装コード (Green)<a class="headerlink" href="#green_7" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Player.kt</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">Player</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="p">:</span><span class="w"> </span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Stage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * ゲームオーバー判定を行います</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">checkGameOver</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 新しいぷよの配置位置（軸ぷよ）にすでにぷよがあるかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">puyoX</span><span class="p">,</span><span class="w"> </span><span class="n">puyoY</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 子ぷよの位置もチェック</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="nv">childX</span><span class="p">,</span><span class="w"> </span><span class="nv">childY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChildPuyoPosition</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 子ぷよが画面外の場合はチェックしない</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="n">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 子ぷよの位置にぷよがあるかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getPuyo</span><span class="p">(</span><span class="n">childX</span><span class="p">,</span><span class="w"> </span><span class="n">childY</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_115">解説<a class="headerlink" href="#_115" title="Permanent link">&para;</a></h4>
<p>ゲームオーバー判定は：
1. 新しいぷよの軸ぷよの位置にすでにぷよがあるか
2. 子ぷよの位置にすでにぷよがあるか（画面内の場合のみ）</p>
<p>をチェックします。どちらかに既存のぷよがあれば、新しいぷよを配置できないのでゲームオーバーです。</p>
<h4 id="_116">コミット<a class="headerlink" href="#_116" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: ゲームオーバー判定を実装&quot;</span>
</code></pre></div>
<h3 id="6_2">6. ゲームオーバー画面を実装する<a class="headerlink" href="#6_2" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー時に画面を表示し、リスタート機能を追加します。</p>
<h4 id="_117">実装コード<a class="headerlink" href="#_117" title="Permanent link">&para;</a></h4>
<p>まず、<code>Game</code> クラスにゲームモードを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Game.kt</span>
<span class="kd">enum</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PLAYING</span><span class="p">,</span>
<span class="w">    </span><span class="n">GAME_OVER</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">()</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">mode</span><span class="p">:</span><span class="w"> </span><span class="n">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">PLAYING</span>

<span class="w">    </span><span class="k">init</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * ゲームをリスタートします</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">restart</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="na">reset</span><span class="p">()</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">PLAYING</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>次に、<code>App.kt</code> でゲームオーバー判定と画面表示を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// App.kt</span>
<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Game</span><span class="p">())</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">updateTrigger</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">frameCount</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">Column</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">(),</span>
<span class="w">        </span><span class="n">horizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">CenterHorizontally</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// スコア表示</span>
<span class="w">        </span><span class="n">Row</span><span class="p">(</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">                </span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
<span class="w">            </span><span class="n">horizontalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">SpaceBetween</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">value</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">fontSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24.</span><span class="n">sp</span><span class="p">,</span>
<span class="w">                </span><span class="n">fontWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FontWeight</span><span class="p">.</span><span class="na">Bold</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;モード: </span><span class="si">${</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">PLAYING</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;</span><span class="err">プレイ中</span><span class="s">&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s">&quot;</span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムオ</span><span class="n">ー</span><span class="err">バ</span><span class="n">ー</span><span class="s">&quot;</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">fontSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18.</span><span class="n">sp</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">Box</span><span class="p">(</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">                </span><span class="p">.</span><span class="na">size</span><span class="p">(</span>
<span class="w">                    </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="p">).</span><span class="na">dp</span><span class="p">,</span>
<span class="w">                    </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">stageHeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="p">).</span><span class="na">dp</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ゲーム画面</span>
<span class="w">            </span><span class="n">Canvas</span><span class="p">(</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">                    </span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="na">border</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">Black</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">onKeyEvent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">PLAYING</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">KeyEventType</span><span class="p">.</span><span class="na">KeyDown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionLeft</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveLeft</span><span class="p">()</span>
<span class="w">                                    </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                    </span><span class="kc">true</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                                </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionRight</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveRight</span><span class="p">()</span>
<span class="w">                                    </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                    </span><span class="kc">true</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                                </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionUp</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="na">Z</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">rotateRight</span><span class="p">()</span>
<span class="w">                                    </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                    </span><span class="kc">true</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                                </span><span class="n">Key</span><span class="p">.</span><span class="na">X</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">rotateLeft</span><span class="p">()</span>
<span class="w">                                    </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                    </span><span class="kc">true</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                                </span><span class="n">Key</span><span class="p">.</span><span class="na">DirectionDown</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">()</span>
<span class="w">                                    </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                                    </span><span class="kc">true</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="kc">false</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="p">.</span><span class="na">focusable</span><span class="p">()</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">updateTrigger</span><span class="w"> </span><span class="c1">// トリガーで再描画</span>

<span class="w">                </span><span class="c1">// 背景</span>
<span class="w">                </span><span class="n">drawRect</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="na">White</span><span class="p">)</span>

<span class="w">                </span><span class="c1">// ... ステージと落下中のぷよの描画 ...</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// ゲームオーバー画面</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">GAME_OVER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Box</span><span class="p">(</span>
<span class="w">                    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">                        </span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="na">Black</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7f</span><span class="p">)),</span>
<span class="w">                    </span><span class="n">contentAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">Center</span>
<span class="w">                </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Column</span><span class="p">(</span>
<span class="w">                        </span><span class="n">horizontalAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">CenterHorizontally</span><span class="p">,</span>
<span class="w">                        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">                            </span><span class="p">.</span><span class="na">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="na">White</span><span class="p">,</span><span class="w"> </span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>
<span class="w">                            </span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">32.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">                    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                            </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GAME OVER&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="n">fontSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">36.</span><span class="n">sp</span><span class="p">,</span>
<span class="w">                            </span><span class="n">fontWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FontWeight</span><span class="p">.</span><span class="na">Bold</span><span class="p">,</span>
<span class="w">                            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="na">Red</span>
<span class="w">                        </span><span class="p">)</span>
<span class="w">                        </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>
<span class="w">                        </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                            </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;スコア: </span><span class="si">${</span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">value</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="n">fontSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24.</span><span class="n">sp</span><span class="p">,</span>
<span class="w">                            </span><span class="n">fontWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FontWeight</span><span class="p">.</span><span class="na">Bold</span>
<span class="w">                        </span><span class="p">)</span>
<span class="w">                        </span><span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">height</span><span class="p">(</span><span class="m">24.</span><span class="n">dp</span><span class="p">))</span>
<span class="w">                        </span><span class="n">Button</span><span class="p">(</span>
<span class="w">                            </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">game</span><span class="p">.</span><span class="na">restart</span><span class="p">()</span>
<span class="w">                                </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;もう一度プレイする&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fontSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18.</span><span class="n">sp</span><span class="p">)</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ゲームループ</span>
<span class="w">    </span><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">frameCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">PLAYING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">delay</span><span class="p">(</span><span class="m">16</span><span class="p">)</span><span class="w"> </span><span class="c1">// 約60FPS</span>
<span class="w">            </span><span class="n">frameCount</span><span class="o">++</span>

<span class="w">            </span><span class="c1">// 約1秒ごとに落下</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frameCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">moveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 着地した</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">placePuyoOnStage</span><span class="p">()</span>

<span class="w">                        </span><span class="c1">// 連鎖処理を実行</span>
<span class="w">                        </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">processChain</span><span class="p">()</span>

<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chainResult</span><span class="p">.</span><span class="na">chainCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="c1">// スコア計算</span>
<span class="w">                            </span><span class="n">chainResult</span><span class="p">.</span><span class="na">chainInfoList</span><span class="p">.</span><span class="na">forEachIndexed</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">chainInfo</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="kd">val</span><span class="w"> </span><span class="nv">chainNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span>
<span class="w">                                </span><span class="kd">val</span><span class="w"> </span><span class="nv">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span>
<span class="w">                                    </span><span class="n">chainInfo</span><span class="p">.</span><span class="na">erasedPuyoCount</span><span class="p">,</span>
<span class="w">                                    </span><span class="n">chainNumber</span>
<span class="w">                                </span><span class="p">)</span>
<span class="w">                                </span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="w">                            </span><span class="p">}</span>

<span class="w">                            </span><span class="c1">// 全消しボーナス</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">stage</span><span class="p">.</span><span class="na">isAllClear</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="kd">val</span><span class="w"> </span><span class="nv">bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="na">calculateAllClearBonus</span><span class="p">()</span>
<span class="w">                                </span><span class="n">game</span><span class="p">.</span><span class="na">score</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">bonus</span><span class="p">)</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span>

<span class="w">                        </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">                        </span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>

<span class="w">                        </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">player</span><span class="p">.</span><span class="na">checkGameOver</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">GAME_OVER</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">updateTrigger</span><span class="o">++</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_118">解説<a class="headerlink" href="#_118" title="Permanent link">&para;</a></h4>
<p><strong>ゲームモードの管理</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">enum</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PLAYING</span><span class="p">,</span>
<span class="w">    </span><span class="n">GAME_OVER</span>
<span class="p">}</span>
</code></pre></div>
<p>ゲームの状態を管理するための列挙型です。<code>PLAYING</code> と <code>GAME_OVER</code> の 2 つの状態があります。</p>
<p><strong>ゲームオーバー画面</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">GAME_OVER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Box</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">            </span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="na">Black</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7f</span><span class="p">)),</span>
<span class="w">        </span><span class="n">contentAlignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alignment</span><span class="p">.</span><span class="na">Center</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ゲームオーバーメッセージとリスタートボタン</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>半透明の黒い背景（<code>alpha = 0.7f</code>）の上に、白い角丸のボックスでゲームオーバーメッセージを表示します。</p>
<p><strong>リスタート機能</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">restart</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="na">reset</span><span class="p">()</span>
<span class="w">    </span><span class="n">player</span><span class="p">.</span><span class="na">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">PLAYING</span>
<span class="p">}</span>
</code></pre></div>
<p>ステージとスコアをリセットし、新しいぷよを生成してゲームモードを <code>PLAYING</code> に戻します。</p>
<p><strong>LaunchedEffect の key</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">frameCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="na">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="na">PLAYING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>LaunchedEffect(game.mode)</code> とすることで、<code>game.mode</code> が変更されたときに Effect が再起動されます。これにより、リスタート時にゲームループが正しく再開されます。</p>
<h4 id="_119">コミット<a class="headerlink" href="#_119" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: ゲームオーバー画面とリスタート機能を実装&quot;</span>
</code></pre></div>
<h3 id="7_1">イテレーション 7 のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！イテレーション 7 が完了し、ぷよぷよゲームが完成しました！</p>
<h4 id="_120">実装した機能<a class="headerlink" href="#_120" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> スコアクラスを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> スコア計算機能を実装する（消去数 × 連鎖ボーナス）</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 全消しボーナスを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ゲームオーバー判定を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> ゲームオーバー画面を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> リスタート機能を実装する</li>
</ul>
<h4 id="_121">学んだこと<a class="headerlink" href="#_121" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>companion object</strong></li>
<li>クラスのインスタンスなしで呼び出せる静的メソッド</li>
<li>
<p><code>Score.calculate()</code> のようにユーティリティ関数として使える</p>
</li>
<li>
<p><strong>連鎖ボーナスの計算</strong></p>
</li>
<li>指数関数的に増加するボーナステーブル</li>
<li>
<p><code>when</code> 式での分岐処理</p>
</li>
<li>
<p><strong>ゲーム状態管理</strong></p>
</li>
<li><code>enum class</code> でゲームモードを定義</li>
<li>
<p>状態に応じて UI とロジックを切り替え</p>
</li>
<li>
<p><strong>LaunchedEffect の key パラメータ</strong></p>
</li>
<li>key が変更されると Effect が再起動される</li>
<li>
<p>ゲームループの再開に活用</p>
</li>
<li>
<p><strong>Compose の UI レイヤリング</strong></p>
</li>
<li><code>Box</code> と <code>Modifier.background()</code> で半透明オーバーレイ</li>
<li>ゲームオーバー画面の実装パターン</li>
</ol>
<h4 id="_122">完成したゲームの特徴<a class="headerlink" href="#_122" title="Permanent link">&para;</a></h4>
<ul>
<li>✅ ぷよを操作できる（移動・回転）</li>
<li>✅ 自動落下する</li>
<li>✅ 4 つ以上つながったら消える</li>
<li>✅ 連鎖が発生する</li>
<li>✅ スコアが計算される</li>
<li>✅ 全消しボーナスがある</li>
<li>✅ ゲームオーバー判定がある</li>
<li>✅ リスタートできる</li>
</ul>
<h3 id="_123">さらなる改善のアイデア<a class="headerlink" href="#_123" title="Permanent link">&para;</a></h3>
<p>このゲームは完成しましたが、さらに改良できる要素があります：</p>
<ol>
<li><strong>Next ぷよの表示</strong>: 次に来るぷよを表示する</li>
<li><strong>効果音</strong>: ぷよを消したときの音</li>
<li><strong>アニメーション</strong>: 消去時のエフェクト</li>
<li><strong>難易度調整</strong>: 落下速度が徐々に速くなる</li>
<li><strong>ハイスコア</strong>: ローカルストレージに保存</li>
<li><strong>2 人対戦モード</strong>: おじゃまぷよの実装</li>
</ol>
<p>これらの機能を追加することで、さらに本格的なゲームに仕上げることができます！</p>
<h3 id="_124">テスト駆動開発を振り返って<a class="headerlink" href="#_124" title="Permanent link">&para;</a></h3>
<p>この「ぷよぷよから始めるテスト駆動開発入門」では、7 つのイテレーションを通じて、段階的にゲームを作り上げてきました：</p>
<ul>
<li><strong>イテレーション 0</strong>: 環境構築</li>
<li><strong>イテレーション 1</strong>: ゲームの初期化と表示</li>
<li><strong>イテレーション 2</strong>: ぷよの落下</li>
<li><strong>イテレーション 3</strong>: 左右移動</li>
<li><strong>イテレーション 4</strong>: 2 つぷよと回転</li>
<li><strong>イテレーション 5</strong>: キーボード操作とゲームループ</li>
<li><strong>イテレーション 6</strong>: 消去処理</li>
<li><strong>イテレーション 7</strong>: スコア計算とゲームオーバー</li>
</ul>
<p>各イテレーションで：</p>
<ol>
<li><strong>小さなステップ</strong>: 一度に 1 つの機能だけを実装</li>
<li><strong>Red-Green-Refactor</strong>: テスト → 実装 → 改善のサイクル</li>
<li><strong>早期のフィードバック</strong>: テストによる即座の確認</li>
<li><strong>自信を持ってリファクタリング</strong>: テストがあるので安心</li>
</ol>
<p>テスト駆動開発は、最初は遠回りに感じるかもしれません。しかし：</p>
<ul>
<li>バグが早期に発見できる</li>
<li>設計が改善される</li>
<li>ドキュメントの役割も果たす</li>
<li>リファクタリングが安全にできる</li>
</ul>
<p>という大きなメリットがあります。</p>
<blockquote>
<p>"Make it work, make it right, make it fast."</p>
<p>— Kent Beck</p>
</blockquote>
<p>まずは動くものを作り、次に正しく作り、最後に高速化する。テスト駆動開発は、この原則を実践するための強力な手法です。</p>
<p>お疲れ様でした！あなたは TDD でぷよぷよゲームを完成させることができました。この経験を活かして、さらに素晴らしいソフトウェアを作っていってください！</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>