
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 Scala.js 日本語コード版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#scalajs" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 Scala.js 日本語コード版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="scalajs">ぷよぷよから始めるテスト駆動開発入門 Scala.js 日本語コード版<a class="headerlink" href="#scalajs" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>注意</strong>: このドキュメントは、コード内のすべての識別子（変数名、関数名、クラス名など）を日本語に変換したバージョンです。
日本語識別子を使用することで、コードの意図がより明確になり、ドメイン知識とコードの距離が近くなります。
ただし、実際のプロジェクトでは、チームの慣習やプロジェクトの要件に応じて、適切な命名規則を選択してください。</p>
</blockquote>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、ぷよぷよゲームを Scala.js で作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを Scala.js で実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの？」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>言語</strong>: Scala 3 — 強力な型システムと関数型プログラミングの機能を持つ言語です。「型があれば安心してリファクタリングできますよ！」</li>
<li><strong>JavaScript 変換</strong>: Scala.js — Scala のコードを JavaScript に変換し、ブラウザで実行できるようにします。</li>
<li><strong>ビルドツール</strong>: sbt — Scala の標準的なビルドツールです。依存関係の管理やコンパイル、テストの実行を担当します。</li>
<li><strong>テストフレームワーク</strong>: ScalaTest — Scala における最も人気のあるテストフレームワークの一つです。テスト駆動開発には欠かせないツールですね。</li>
<li><strong>静的コード解析</strong>: WartRemover — Scala 用の静的コード解析ツールです。コードの潜在的な問題を検出してくれます。</li>
<li><strong>コードフォーマッタ</strong>: Scalafmt — コードのフォーマットを自動で統一してくれます。</li>
<li><strong>コードカバレッジ</strong>: scoverage — テストがコードのどれだけをカバーしているかを測定します。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ？昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション0: 環境の構築で解説します。</p>
<h2 id="_4">要件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">ユーザーストーリー<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。
ユーザーストーリーには形式が定められておらず、標準的な記法もない。とはいえ、次のような形式でストーリーを考えてみると便利である。「＜ユーザーの種類＞として、＜機能や性能＞がほしい。それは＜ビジネス価値＞のためだ」という形のテンプレートに従うと、
たとえば次のようなストーリーを書ける。「本の購入者として、ＩＳＢＮで本を検索したい。それは探している本をすばやく見つけるためだ」</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう：</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜ん！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PCでプレイするなら必須ですよね）</li>
<li>プレイヤーとして、タッチ操作でぷよを操作できる（スマホでもプレイしたいですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>...と言いたいところですがまずは環境の構築をしなければなりません。「プログラミングなんてどの言語でやるか決めるぐらいでしょ？」と思うかもしれませんが家を建てるときにしっかりとした基礎工事が必要なように開発環境もしっかりとした準備が必要です。
家を建てた後に基礎がダメだと困ったことになりますからね。</p>
<h3 id="_6">ソフトウェア開発の三種の神器<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本章では開発環境のセットアップとして、これら三種の神器を準備していきます。環境構築は退屈に感じるかもしれませんが、これらのツールがあることで、安心してコードを書くことができるようになります。一緒に進めていきましょう！</p>
<h3 id="git">バージョン管理: Gitとコミットメッセージ<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>バージョン管理システムとして Git を使います。Git については既に使用していると仮定しますが、コミットメッセージについて1つだけ重要なルールを確認しておきましょう。</p>
<h4 id="_7">コミットメッセージの書き方<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>私たちのプロジェクトでは、<a href="https://www.conventionalcommits.org/ja/">Conventional Commits</a>の書式に従ってコミットメッセージを書きます。具体的には、それぞれのコミットメッセージはヘッダ、ボディ、フッタで構成されます。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p>ヘッダは必須で、スコープは任意です。コミットメッセージのタイトルは50文字までにしましょう（GitHub上で読みやすくなります）。</p>
<p>コミットのタイプは次を用います：</p>
<ul>
<li><strong>feat</strong>: 新しい機能</li>
<li><strong>fix</strong>: バグ修正</li>
<li><strong>docs</strong>: ドキュメント変更のみ</li>
<li><strong>style</strong>: コードに影響を与えない変更（空白、フォーマットなど）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更</li>
<li><strong>test</strong>: テストの追加や修正</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更</li>
</ul>
<p>例えば：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化機能を追加&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: メソッドの抽出&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよ消去のテストケースを追加&#39;</span>
</code></pre></div>
<h3 id="_8">テスティング: パッケージマネージャとテスト環境<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>良いコードを書くためには、コードが正しく動作することを確認するテストが欠かせません。そのためのツールをセットアップしていきましょう。</p>
<h4 id="sbt">パッケージマネージャ: sbt<a class="headerlink" href="#sbt" title="Permanent link">&para;</a></h4>
<p>外部ライブラリやツールを管理するために <strong>sbt</strong> を使います。</p>
<blockquote>
<p>sbtとは、Scalaで記述されたビルドツールで、Scalaプロジェクトの依存関係管理、コンパイル、テスト実行、パッケージング等を行います。</p>
<p>—  <a href="https://www.scala-sbt.org/">公式ドキュメント</a></p>
</blockquote>
<p>まず、プロジェクトディレクトリを作成し、<code>build.sbt</code> を作成して依存関係を設定します：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>puyo-puyo-game
<span class="nb">cd</span><span class="w"> </span>puyo-puyo-game
</code></pre></div>
<p><code>build.sbt</code> を以下のように作成します：</p>
<div class="highlight"><pre><span></span><code><span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalaVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;3.3.3&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">organization</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;com.example&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">organizationName</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;puyo-puyo&quot;</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">project</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">enablePlugins</span><span class="p">(</span><span class="nc">ScalaJSPlugin</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">settings</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;puyo-puyo-game&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalaJSUseMainModuleInitializer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>

<span class="w">    </span><span class="c1">// テストフレームワーク</span>
<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;org.scalatest&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalatest&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.2.18&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nc">Test</span>
<span class="w">    </span><span class="p">),</span>

<span class="w">    </span><span class="c1">// Scala.js DOM ライブラリ</span>
<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;org.scala-js&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalajs-dom&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.8.0&quot;</span>
<span class="w">  </span><span class="p">)</span>
</code></pre></div>
<p>プロジェクト構造を作成します：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>src/main/scala
mkdir<span class="w"> </span>-p<span class="w"> </span>src/test/scala
mkdir<span class="w"> </span>-p<span class="w"> </span>project
</code></pre></div>
<p><code>project/build.properties</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="na">sbt.version</span><span class="o">=</span><span class="s">1.9.9</span>
</code></pre></div>
<p><code>project/plugins.sbt</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;org.scala-js&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-scalajs&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;1.16.0&quot;</span><span class="p">)</span>
<span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;org.scalameta&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-scalafmt&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.5.0&quot;</span><span class="p">)</span>
<span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;org.wartremover&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-wartremover&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.1.3&quot;</span><span class="p">)</span>
<span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;org.scoverage&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-scoverage&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.0.9&quot;</span><span class="p">)</span>
</code></pre></div>
<p>これで、テストを実行する準備ができました：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<h3 id="_9">自動化: コード品質の自動管理<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質を自動的にチェックし、維持していく仕組みが必要です。ここでは、静的コード解析、コードフォーマット、コードカバレッジ、そしてタスクランナーを設定します。</p>
<h4 id="wartremover">静的コード解析: WartRemover<a class="headerlink" href="#wartremover" title="Permanent link">&para;</a></h4>
<p>静的コード解析ツールとして <strong>WartRemover</strong> を使います。WartRemoverは、コードを実行せずに潜在的な問題を検出するツールです。</p>
<p><code>build.sbt</code> にプラグインの設定を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">project</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">enablePlugins</span><span class="p">(</span><span class="nc">ScalaJSPlugin</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">settings</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;puyo-puyo-game&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalaJSUseMainModuleInitializer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>

<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;org.scalatest&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalatest&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.2.18&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nc">Test</span>
<span class="w">    </span><span class="p">),</span>

<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;org.scala-js&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalajs-dom&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.8.0&quot;</span><span class="p">,</span>

<span class="w">    </span><span class="c1">// WartRemover 設定</span>
<span class="w">    </span><span class="n">wartremoverWarnings</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Warts</span><span class="p">.</span><span class="n">unsafe</span>
<span class="w">  </span><span class="p">)</span>
</code></pre></div>
<p>静的コード解析を実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span>compile
</code></pre></div>
<p>WartRemoverは以下のような問題を検出してくれます：
- Null参照の使用
- var（可変変数）の不適切な使用
- Anyの使用
- 例外の不適切な使用</p>
<p>例えば、以下のコードでは警告が出力されます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 警告が出るコード例</span>
<span class="k">def</span><span class="w"> </span><span class="nf">badExample</span><span class="p">():</span><span class="w"> </span><span class="nc">Any</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// var使用の警告</span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="kc">null</span><span class="w">      </span><span class="c1">// null使用の警告</span>
<span class="p">}</span>
</code></pre></div>
<p>このような問題を事前に発見することで、より安全で保守しやすいコードを書くことができます。</p>
<h4 id="scalafmt">コードフォーマッタ: Scalafmt<a class="headerlink" href="#scalafmt" title="Permanent link">&para;</a></h4>
<p>コードのフォーマットを統一するために <strong>Scalafmt</strong> を使います。</p>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>—  リーダブルコード</p>
</blockquote>
<p><code>.scalafmt.conf</code> ファイルを作成して設定を追加しましょう：</p>
<div class="highlight"><pre><span></span><code>version = &quot;3.7.17&quot;
runner.dialect = scala3

maxColumn = 100
indent.main = 2
indent.callSite = 2
indent.ctrlSite = 2
indent.defnSite = 2
indent.caseSite = 2

rewrite.rules = [RedundantBraces, RedundantParens, SortModifiers]
rewrite.redundantBraces.stringInterpolation = true
</code></pre></div>
<p>フォーマットのチェックと自動修正は以下のコマンドで実行できます：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span>scalafmtCheck<span class="w">  </span><span class="c1"># チェックのみ</span>
sbt<span class="w"> </span>scalafmt<span class="w">       </span><span class="c1"># 自動修正</span>
</code></pre></div>
<h4 id="scoverage">コードカバレッジ: scoverage<a class="headerlink" href="#scoverage" title="Permanent link">&para;</a></h4>
<p>テストがコードのどれだけをカバーしているかを確認するために、<strong>scoverage</strong> を使います。</p>
<blockquote>
<p>コード網羅率（コードもうらりつ、英: Code coverage）は、ソフトウェアテストで用いられる尺度の1つである。プログラムのソースコードがテストされた割合を意味する。</p>
</blockquote>
<p><code>build.sbt</code> に設定を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">project</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">enablePlugins</span><span class="p">(</span><span class="nc">ScalaJSPlugin</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">settings</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;puyo-puyo-game&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalaJSUseMainModuleInitializer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>

<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;org.scalatest&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalatest&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.2.18&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nc">Test</span>
<span class="w">    </span><span class="p">),</span>

<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;org.scala-js&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalajs-dom&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.8.0&quot;</span><span class="p">,</span>

<span class="w">    </span><span class="n">wartremoverWarnings</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Warts</span><span class="p">.</span><span class="n">unsafe</span><span class="p">,</span>

<span class="w">    </span><span class="c1">// カバレッジ設定</span>
<span class="w">    </span><span class="n">coverageEnabled</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageMinimumStmtTotal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageFailOnMinimum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageHighlighting</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">)</span>
</code></pre></div>
<p>カバレッジレポートを生成するには：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span>clean<span class="w"> </span>coverage<span class="w"> </span><span class="nb">test</span><span class="w"> </span>coverageReport
</code></pre></div>
<p>実行後、<code>target/scala-3.3.3/scoverage-report</code> フォルダ内の <code>index.html</code> を開くと、視覚的にカバレッジ状況を確認できます。</p>
<h4 id="sbt_1">タスクランナー: sbt カスタムタスク<a class="headerlink" href="#sbt_1" title="Permanent link">&para;</a></h4>
<p>複数のコマンドを覚えるのは大変です。sbt のカスタムタスクを使って、よく使うコマンドをタスクとして登録し、簡単に実行できるようにします。</p>
<p><code>build.sbt</code> にカスタムタスクを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalaVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;3.3.3&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">organization</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;com.example&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">organizationName</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;puyo-puyo&quot;</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">project</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">enablePlugins</span><span class="p">(</span><span class="nc">ScalaJSPlugin</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">settings</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;puyo-puyo-game&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalaJSUseMainModuleInitializer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>

<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;org.scalatest&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalatest&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.2.18&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nc">Test</span>
<span class="w">    </span><span class="p">),</span>

<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;org.scala-js&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalajs-dom&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.8.0&quot;</span><span class="p">,</span>

<span class="w">    </span><span class="n">wartremoverWarnings</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Warts</span><span class="p">.</span><span class="n">unsafe</span><span class="p">,</span>

<span class="w">    </span><span class="n">coverageEnabled</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageMinimumStmtTotal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageFailOnMinimum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageHighlighting</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">)</span>

<span class="c1">// カスタムタスクの定義</span>
<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Format source code&quot;</span><span class="p">)</span>
<span class="n">format</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Compile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalafmt</span><span class="p">).</span><span class="n">value</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalafmt</span><span class="p">).</span><span class="n">value</span>
<span class="p">}</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">formatCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Check source code formatting&quot;</span><span class="p">)</span>
<span class="n">formatCheck</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Compile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalafmtCheck</span><span class="p">).</span><span class="n">value</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalafmtCheck</span><span class="p">).</span><span class="n">value</span>
<span class="p">}</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">lint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Run static analysis&quot;</span><span class="p">)</span>
<span class="n">lint</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Compile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">compile</span><span class="p">).</span><span class="n">value</span>
<span class="p">}</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Run tests with coverage&quot;</span><span class="p">)</span>
<span class="n">coverage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">coverageReport</span><span class="p">).</span><span class="n">value</span>
<span class="p">}</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Run all quality checks&quot;</span><span class="p">)</span>
<span class="n">check</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">formatCheck</span><span class="p">.</span><span class="n">value</span>
<span class="w">  </span><span class="n">lint</span><span class="p">.</span><span class="n">value</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">test</span><span class="p">).</span><span class="n">value</span>
<span class="w">  </span><span class="n">coverage</span><span class="p">.</span><span class="n">value</span>
<span class="p">}</span>
</code></pre></div>
<p>カスタムタスクを実行してみます：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># フォーマットチェック</span>
sbt<span class="w"> </span>formatCheck

<span class="c1"># 静的解析実行</span>
sbt<span class="w"> </span>lint

<span class="c1"># テストとカバレッジ実行</span>
sbt<span class="w"> </span>coverage

<span class="c1"># 全ての品質チェック実行</span>
sbt<span class="w"> </span>check
</code></pre></div>
<p><code>check</code> タスクを実行することで、フォーマットチェック、静的解析、テスト、カバレッジまで一度に実行できます。</p>
<h4 id="_10">タスクの自動実行<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>ファイルを編集するたびに手動でコマンドを実行するのは面倒です。sbt の <code>~</code> 接頭辞を使って、ファイルの変更を検知して自動的にテストやフォーマットを実行できるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># テストの自動実行</span>
sbt<span class="w"> </span><span class="s2">&quot;~ test&quot;</span>

<span class="c1"># フォーマットチェックの自動実行</span>
sbt<span class="w"> </span><span class="s2">&quot;~ formatCheck&quot;</span>

<span class="c1"># 全ての品質チェックの自動実行</span>
sbt<span class="w"> </span><span class="s2">&quot;~ check&quot;</span>
</code></pre></div>
<p>開発時のワークフロー例：</p>
<ol>
<li>ターミナルで <code>sbt "~ test"</code> を実行してファイル監視を開始</li>
<li>コードを編集・保存</li>
<li>自動的にテストが実行される</li>
<li>テストが失敗した場合は、コードを修正して再度保存</li>
<li>自動的にテストが再実行される</li>
</ol>
<p>この自動化により、<strong>レッド→グリーン→リファクタ</strong> のTDDサイクルをより効率的に回すことができます。</p>
<p>監視を停止するには <code>Ctrl+C</code> を押すか、sbtコンソールで <code>Enter</code> キーを押します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ファイル監視の開始</span>
$<span class="w"> </span>sbt
sbt:puyo-puyo-game&gt;<span class="w"> </span>~<span class="w"> </span><span class="nb">test</span>
<span class="o">[</span>info<span class="o">]</span><span class="w"> </span><span class="m">1</span>.<span class="w"> </span>Monitoring<span class="w"> </span><span class="nb">source</span><span class="w"> </span>files<span class="w"> </span><span class="k">for</span><span class="w"> </span>puyo-puyo-game/test...
<span class="o">[</span>info<span class="o">]</span><span class="w">    </span>Press<span class="w"> </span>&lt;enter&gt;<span class="w"> </span>to<span class="w"> </span>interrupt<span class="w"> </span>or<span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>options.
<span class="c1"># ファイルを変更すると自動でテストが実行される</span>
<span class="c1"># Enter キーで監視停止</span>
</code></pre></div>
<h3 id="_11">環境構築の完了<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！これで開発環境のセットアップが完了しました。以下のツールが使えるようになりました：</p>
<ul>
<li><strong>バージョン管理</strong>: Git（Conventional Commits形式）</li>
<li><strong>テスティング</strong>: ScalaTest（Scala.js 対応）</li>
<li><strong>静的コード解析</strong>: WartRemover</li>
<li><strong>コードフォーマット</strong>: Scalafmt</li>
<li><strong>コードカバレッジ</strong>: scoverage</li>
<li><strong>タスクランナー</strong>: sbt カスタムタスク</li>
<li><strong>自動化</strong>: sbt ファイル監視（<code>~</code> 接頭辞）</li>
</ul>
<p>これらのツールにより、<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>が揃いました。これから安心してテスト駆動開発に取り組むことができます！</p>
<h3 id="_12">環境構成<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>実際に構築した開発環境の構成は以下の通りです：</p>
<h4 id="_13">プロジェクト構造<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>puyo-puyo-game/
├── src/
│   ├── main/
│   │   └── scala/
│   │       └── com/
│   │           └── example/
│   │               └── puyo/
│   │                   └── Main.scala
│   └── test/
│       └── scala/
│           └── com/
│               └── example/
│                   └── puyo/
│                       └── MainSpec.scala
├── project/
│   ├── build.properties
│   └── plugins.sbt
├── build.sbt
├── .scalafmt.conf
└── .gitignore
</code></pre></div>
<h4 id="buildsbt">build.sbt の完全な設定<a class="headerlink" href="#buildsbt" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalaVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;3.3.3&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">organization</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;com.example&quot;</span>
<span class="nc">ThisBuild</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">organizationName</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;puyo-puyo&quot;</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">project</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">enablePlugins</span><span class="p">(</span><span class="nc">ScalaJSPlugin</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">settings</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;puyo-puyo-game&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalaJSUseMainModuleInitializer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>

<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;org.scalatest&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalatest&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.2.18&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nc">Test</span>
<span class="w">    </span><span class="p">),</span>

<span class="w">    </span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;org.scala-js&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;scalajs-dom&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.8.0&quot;</span><span class="p">,</span>

<span class="w">    </span><span class="n">wartremoverWarnings</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Warts</span><span class="p">.</span><span class="n">unsafe</span><span class="p">,</span>

<span class="w">    </span><span class="n">coverageEnabled</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageMinimumStmtTotal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageFailOnMinimum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">coverageHighlighting</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">)</span>

<span class="c1">// カスタムタスクの定義</span>
<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Format source code&quot;</span><span class="p">)</span>
<span class="n">format</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Compile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalafmt</span><span class="p">).</span><span class="n">value</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalafmt</span><span class="p">).</span><span class="n">value</span>
<span class="p">}</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">formatCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Check source code formatting&quot;</span><span class="p">)</span>
<span class="n">formatCheck</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Compile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalafmtCheck</span><span class="p">).</span><span class="n">value</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scalafmtCheck</span><span class="p">).</span><span class="n">value</span>
<span class="p">}</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">lint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Run static analysis&quot;</span><span class="p">)</span>
<span class="n">lint</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Compile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">compile</span><span class="p">).</span><span class="n">value</span>
<span class="p">}</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Run tests with coverage&quot;</span><span class="p">)</span>
<span class="n">coverage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">coverageReport</span><span class="p">).</span><span class="n">value</span>
<span class="p">}</span>

<span class="k">lazy</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskKey</span><span class="p">[</span><span class="nc">Unit</span><span class="p">](</span><span class="s">&quot;Run all quality checks&quot;</span><span class="p">)</span>
<span class="n">check</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">formatCheck</span><span class="p">.</span><span class="n">value</span>
<span class="w">  </span><span class="n">lint</span><span class="p">.</span><span class="n">value</span>
<span class="w">  </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">test</span><span class="p">).</span><span class="n">value</span>
<span class="w">  </span><span class="n">coverage</span><span class="p">.</span><span class="n">value</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="projectbuildproperties">project/build.properties<a class="headerlink" href="#projectbuildproperties" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="na">sbt.version</span><span class="o">=</span><span class="s">1.9.9</span>
</code></pre></div>
<h4 id="projectpluginssbt">project/plugins.sbt<a class="headerlink" href="#projectpluginssbt" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;org.scala-js&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-scalajs&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;1.16.0&quot;</span><span class="p">)</span>
<span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;org.scalameta&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-scalafmt&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.5.0&quot;</span><span class="p">)</span>
<span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;org.wartremover&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-wartremover&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.1.3&quot;</span><span class="p">)</span>
<span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;org.scoverage&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-scoverage&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;2.0.9&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="scalafmtconf">.scalafmt.conf<a class="headerlink" href="#scalafmtconf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>version = &quot;3.7.17&quot;
runner.dialect = scala3

maxColumn = 100
indent.main = 2
indent.callSite = 2
indent.ctrlSite = 2
indent.defnSite = 2
indent.caseSite = 2

rewrite.rules = [RedundantBraces, RedundantParens, SortModifiers]
rewrite.redundantBraces.stringInterpolation = true
</code></pre></div>
<h4 id="gitignore">.gitignore<a class="headerlink" href="#gitignore" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code># sbt
target/
project/target/
project/project/

# Scala
*.class
*.log

# IDE
.idea/
.bsp/
.metals/
.vscode/

# OS
.DS_Store
</code></pre></div>
<h4 id="_14">環境構築の確認<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>環境構築が正しく完了したことを確認するには、以下のコマンドを実行します：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span>check
</code></pre></div>
<p>このコマンドは以下の処理を順次実行します：</p>
<ol>
<li>Scalafmt によるコードフォーマットチェック</li>
<li>WartRemover による静的解析</li>
<li>ScalaTest によるテスト実行</li>
<li>scoverage によるカバレッジレポート生成</li>
</ol>
<p>すべてのチェックが成功すれば、環境構築は完了です。</p>
<p>では、実際のゲーム開発に進みましょう！</p>
<h2 id="_15">まとめ<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<p>イテレーション0では、ぷよぷよゲームを Scala.js で開発するための環境を構築しました。</p>
<p><strong>ソフトウェア開発の三種の神器</strong> である「バージョン管理」「テスティング」「自動化」を準備することで、安心してテスト駆動開発に取り組める基盤が整いました。</p>
<p>次のイテレーションでは、実際にゲームのコードを書き始めます。テスト駆動開発のサイクル（Red-Green-Refactor）に従って、一歩ずつ確実に機能を実装していきましょう！</p>
<p>開発を始める際は、まず <code>sbt "~ test"</code> を実行して、後はコードを書くことに集中しましょう！</p>
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_16">ユーザーストーリー<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ゲームの初期化処理を実装する（ゲームの状態や必要なコンポーネントを設定する）</li>
<li>ゲーム画面を表示する（プレイヤーが視覚的にゲームを認識できるようにする）</li>
<li>新しいぷよを生成する（ゲーム開始時に最初のぷよを作成する）</li>
<li>ゲームループを開始する（ゲームの継続的な更新と描画を行う）</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ゲームの初期化処理」から始めましょう！</p>
<h3 id="_17">テスト: ゲームの初期化<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「ゲームの初期化処理を実装する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ゲームの初期化処理をテストするコードを書いてみましょう。何をテストすべきでしょうか？ゲームが初期化されたとき、必要なコンポーネントが正しく作成され、ゲームの状態が適切に設定されていることを確認する必要がありますね。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/GameSpec.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">flatspec</span><span class="p">.</span><span class="nc">AnyFlatSpec</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">matchers</span><span class="p">.</span><span class="nn">should</span><span class="p">.</span><span class="nc">Matchers</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nc">BeforeAndAfterEach</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ゲ</span><span class="err">ー</span><span class="n">ムSpec</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">AnyFlatSpec</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">Matchers</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">BeforeAndAfterEach</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">:</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">beforeEach</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="s">&quot;ゲーム&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;初期化時に必要なコンポーネントを作成する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">初期化</span><span class="p">()</span>

<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">設定情報</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">ぷよ画像</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">スコア</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;初期化時にゲームモードをStartに設定する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">初期化</span><span class="p">()</span>

<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">モ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Start</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、<code>ゲーム</code>クラスの<code>initialize</code>メソッドが正しく動作することを確認しています。具体的には、必要なコンポーネント（設定情報, ぷよ画像, ステージ, プレイヤー, スコア）が作成され、ゲームモードが<code>Start</code>に設定されることを検証しています。</p>
<h3 id="_18">実装: ゲームの初期化<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>[error] not found: object ゲーム
</code></pre></div>
<p>おっと！まだ<code>ゲーム</code>クラスを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<blockquote>
<p>アサートファースト</p>
<p>ではテストはどこから書き始めるべきだろうか。それはテストの終わりにパスすべきアサーションを書くところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストが通るように最小限のコードを実装していきましょう。「最小限」というのがポイントです。この段階では、テストが通ることだけを目指して、必要最低限のコードを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/ゲーム.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">enum</span><span class="w"> </span><span class="nc">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">:</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">Start</span><span class="p">,</span><span class="w"> </span><span class="nc">CheckFall</span><span class="p">,</span><span class="w"> </span><span class="nc">Fall</span><span class="p">,</span><span class="w"> </span><span class="nc">CheckErase</span><span class="p">,</span><span class="w"> </span><span class="nc">Erasing</span><span class="p">,</span><span class="w"> </span><span class="nc">NewPuyo</span><span class="p">,</span><span class="w"> </span><span class="nc">Playing</span><span class="p">,</span><span class="w"> </span><span class="nc">GameOver</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_mode</span><span class="p">:</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Start</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">フレ</span><span class="err">ー</span><span class="n">ム</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">連鎖数</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">:</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">スコア</span><span class="p">:</span><span class="w"> </span><span class="n">スコア</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">モ</span><span class="err">ー</span><span class="n">ド</span><span class="p">:</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mode</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">初期化</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 各コンポーネントの初期化</span>
<span class="w">    </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">設定情報</span><span class="p">()</span>
<span class="w">    </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">(</span><span class="n">設定情報</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">    </span><span class="n">スコア</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">スコア</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームモードを設定</span>
<span class="w">    </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Start</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_19">解説: ゲームの初期化<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>実装したゲームの初期化処理について、少し解説しておきましょう。この処理では、主に以下のことを行っています：</p>
<ol>
<li>各コンポーネント（設定情報, ぷよ画像, ステージ, プレイヤー, スコア）のインスタンスを作成</li>
<li>ゲームモードを<code>Start</code>に設定</li>
</ol>
<p>これにより、ゲームを開始するための準備が整います。各コンポーネントの役割を理解しておくと、今後の実装がスムーズになりますよ：</p>
<ul>
<li><strong>設定情報</strong>: ゲームの設定値を管理します（画面サイズ、ぷよの大きさなど）</li>
<li><strong>ぷよ画像</strong>: ぷよの画像を管理します（各色のぷよの画像を読み込み、描画する）</li>
<li><strong>ステージ</strong>: ゲームのステージ（盤面）を管理します（ぷよの配置状態、消去判定など）</li>
<li><strong>プレイヤー</strong>: プレイヤーの入力と操作を管理します（キーボード入力の処理、ぷよの移動など）</li>
<li><strong>スコア</strong>: スコアの計算と表示を管理します（連鎖数に応じたスコア計算など）</li>
</ul>
<p>このように、責任を明確に分けることで、コードの保守性が高まります。これはオブジェクト指向設計の基本原則の一つ、「単一責任の原則」に従っています。</p>
<blockquote>
<p>単一責任の原則（SRP）：クラスを変更する理由は1つだけであるべき。</p>
<p>— Robert C. Martin 『Clean Architecture』</p>
</blockquote>
<p>また、Scala 3 の <code>enum</code> を使ってゲームモードを定義していることに注目してください。これにより、型安全にゲームの状態を表現できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="nc">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">:</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">Start</span><span class="p">,</span><span class="w"> </span><span class="nc">CheckFall</span><span class="p">,</span><span class="w"> </span><span class="nc">Fall</span><span class="p">,</span><span class="w"> </span><span class="nc">CheckErase</span><span class="p">,</span><span class="w"> </span><span class="nc">Erasing</span><span class="p">,</span><span class="w"> </span><span class="nc">NewPuyo</span><span class="p">,</span><span class="w"> </span><span class="nc">Playing</span><span class="p">,</span><span class="w"> </span><span class="nc">GameOver</span>
</code></pre></div>
<p>これは TypeScript の Union 型に相当する、より型安全な表現方法です。</p>
<h3 id="_20">実装: 依存クラスの作成<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>テストを通すために、必要な依存クラス（設定情報, ぷよ画像, ステージ, プレイヤー, スコア）も最小限の実装を作成します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/設定情報.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">class</span><span class="w"> </span><span class="nc">設定情報</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 最小限の実装</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/ぷよ画像.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ぷよ画像</span><span class="p">(</span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 最小限の実装</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/ステージ.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 最小限の実装</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">class</span><span class="w"> </span><span class="nc">プレイヤ</span><span class="err">ー</span><span class="p">(</span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 最小限の実装</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/スコア.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">class</span><span class="w"> </span><span class="nc">スコア</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 最小限の実装</span>
<span class="p">}</span>
</code></pre></div>
<p>これらのクラスは現時点では空の実装ですが、後続のイテレーションで徐々に機能を追加していきます。</p>
<h3 id="_21">テストの確認<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下の結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code>[info] GameSpec:
[info] ゲーム
[info] - 初期化時に必要なコンポーネントを作成する
[info] - 初期化時にゲームモードをStartに設定する
[info] Run completed in 234 milliseconds.
[info] Total number of tests run: 2
[info] Suites: completed 1, aborted 0
[info] Tests: succeeded 2, failed 0, canceled 0, ignored 0, pending 0
[info] All tests passed.
</code></pre></div>
<h3 id="_22">実装: エントリーポイント<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>次に、ゲームを起動するエントリーポイント <code>Main.scala</code> を実装します。Scala.js では、<code>JSApp</code> trait を使ってブラウザで実行可能なアプリケーションを作成できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/Main.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="nn">js</span><span class="p">.</span><span class="nn">annotation</span><span class="p">.</span><span class="nc">JSExportTopLevel</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">dom</span>

<span class="nd">@JSExportTopLevel</span><span class="p">(</span><span class="s">&quot;PuyoPuyoGame&quot;</span><span class="p">)</span>
<span class="k">object</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームのインスタンスを作成</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームを初期化</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">初期化</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームループを開始（次のタスクで実装）</span>
<span class="w">    </span><span class="c1">// ゲーム.loop()</span>

<span class="w">    </span><span class="n">dom</span><span class="p">.</span><span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Puyo Puyo ゲーム Started!&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このコードでは、以下のステップでゲームを開始します：</p>
<ol>
<li><code>ゲーム</code> クラスのインスタンスを作成</li>
<li><code>initialize()</code> メソッドで各コンポーネントを初期化</li>
<li>コンソールにメッセージを出力</li>
</ol>
<p><code>@JSExportTopLevel</code> アノテーションにより、このオブジェクトが JavaScript から呼び出し可能になります。</p>
<h3 id="html">実装: HTML ファイル<a class="headerlink" href="#html" title="Permanent link">&para;</a></h3>
<p>ゲームを表示するための HTML ファイルを作成します。</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- index.html --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;ja&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ぷよぷよゲーム<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;app&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;./target/scala-3.3.3/puyo-puyo-game-fastopt.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="nx">PuyoPuyoGame</span><span class="p">.</span><span class="nx">main</span><span class="p">();</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p>この HTML ファイルでは、以下のことを行っています：</p>
<ol>
<li><strong>基本的な HTML 構造の定義</strong></li>
<li><code>lang="ja"</code> で日本語ページであることを指定</li>
<li>
<p>ビューポート設定でレスポンシブ対応</p>
</li>
<li>
<p><strong>アプリケーションのマウントポイント</strong></p>
</li>
<li>
<p><code>&lt;div id="app"&gt;&lt;/div&gt;</code> がゲーム画面を表示する場所になります</p>
</li>
<li>
<p><strong>Scala.js のロード</strong></p>
</li>
<li><code>fastopt.js</code> は開発用の最適化されたビルド</li>
<li><code>PuyoPuyoGame.main()</code> でゲームを起動</li>
</ol>
<h3 id="javascript">JavaScript のビルドと実行<a class="headerlink" href="#javascript" title="Permanent link">&para;</a></h3>
<p>Scala.js のコードを JavaScript にコンパイルして実行します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># JavaScript へのコンパイル（開発用）</span>
sbt<span class="w"> </span>fastLinkJS

<span class="c1"># ファイルサーバーの起動（Python を使用）</span>
python<span class="w"> </span>-m<span class="w"> </span>http.server<span class="w"> </span><span class="m">8000</span>
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開くと、コンソールに「Puyo Puyo ゲーム Started!」というメッセージが表示されているはずです。</p>
<p>おめでとうございます！リリースに向けて最初の第一歩を踏み出すことができました。これから機能を追加するごとにどんどん実際のゲームの完成に近づく事が確認できます、楽しみですね。</p>
<p>「機能は別々に作りこんで最後に画面と統合するんじゃないの？」と思うもしれません。そういうアプローチもありますが画面イメージが最後まで確認できないともし間違っていたら手戻りが大変です。それに動作するプログラムがどんどん成長するのを見るのは楽しいですからね。</p>
<blockquote>
<p>トップダウンでもボトムアップでもなく、エンドツーエンドで構築していく</p>
<p>エンドツーエンドで小さな機能を構築し、そこから作業を進めながら問題について学習していく。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<h3 id="1_1">イテレーション 1 のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ゲーム クラスの初期化</strong></li>
<li>必要なコンポーネント（設定情報, ぷよ画像, ステージ, プレイヤー, スコア）の作成</li>
<li>ゲームモードの設定</li>
<li>
<p>Scala 3 の <code>enum</code> による型安全な状態管理</p>
</li>
<li>
<p><strong>エントリーポイントの実装</strong></p>
</li>
<li><code>Main.scala</code> でゲームの初期化</li>
<li><code>@JSExportTopLevel</code> による JavaScript からの呼び出し</li>
<li>
<p>ブラウザでの動作確認が可能に</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ゲーム初期化のテスト（2 テスト）</li>
<li>ScalaTest の FlatSpec スタイルによる読みやすいテスト</li>
<li>
<p>すべてのテストが成功</p>
</li>
<li>
<p><strong>Scala.js の特徴</strong></p>
</li>
<li>型安全な JavaScript コード生成</li>
<li>Scala のオブジェクト指向と関数型の機能を活用</li>
<li><code>scalajs-dom</code> による DOM 操作</li>
</ol>
<p>次のイテレーションでは、ゲームループの実装とぷよの移動機能を実装していきます。</p>
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームの基本的な構造ができましたね。「ゲームが始まったけど、ぷよが動かないと面白くないよね？」と思いませんか？そこで次は、ぷよを左右に移動できるようにしていきましょう！</p>
<h3 id="_23">ユーザーストーリー<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「ぷよぷよって、落ちてくるぷよを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「左右の移動」を実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。
「ぷよを左右に移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>プレイヤーの入力を検出する（キーボードの左右キーが押されたことを検知する）</li>
<li>ぷよを左右に移動する処理を実装する（実際にぷよの位置を変更する）</li>
<li>移動可能かどうかのチェックを実装する（画面の端や他のぷよにぶつかる場合は移動できないようにする）</li>
<li>移動後の表示を更新する（画面上でぷよの位置が変わったことを表示する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_24">テスト: プレイヤーの入力検出<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、プレイヤーの入力を検出する部分からテストしていきましょう。キーボードの左右キーが押されたときに、それを正しく検知できるかどうかをテストします。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/PlayerSpec.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">flatspec</span><span class="p">.</span><span class="nc">AnyFlatSpec</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">matchers</span><span class="p">.</span><span class="nn">should</span><span class="p">.</span><span class="nc">Matchers</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nc">BeforeAndAfterEach</span>

<span class="k">class</span><span class="w"> </span><span class="nc">プレイヤ</span><span class="err">ー</span><span class="nc">Spec</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">AnyFlatSpec</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">Matchers</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">BeforeAndAfterEach</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">:</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">beforeEach</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">設定情報</span><span class="p">()</span>
<span class="w">    </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">(</span><span class="n">設定情報</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="s">&quot;プレイヤー&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;左キーが押されたときに左フラグを設定する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// キー入力をシミュレート（テスト用のメソッドを呼び出す）</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="s">&quot;ArrowLeft&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>

<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">入力キ</span><span class="err">ー</span><span class="n">左</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;右キーが押されたときに右フラグを設定する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="s">&quot;ArrowRight&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>

<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">入力キ</span><span class="err">ー</span><span class="n">右</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;キーが離されたときにフラグをクリアする&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="s">&quot;ArrowLeft&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">入力キ</span><span class="err">ー</span><span class="n">左</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">true</span>

<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="s">&quot;ArrowLeft&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">入力キ</span><span class="err">ー</span><span class="n">左</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストは何をしているんですか？」このテストでは、キーボードの左右キーが押されたときと離されたときに、<code>プレイヤー</code>クラスの中の対応するフラグが正しく設定されるかどうかを確認しています。</p>
<p>Scala.js では DOM イベントのシミュレートがテスト環境で難しいため、テスト用の<code>キー状態を設定</code>メソッドを用意してキー入力をテストします。これにより、ビジネスロジックを独立してテストできます。</p>
<h3 id="_25">実装: プレイヤーの入力検出<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>「失敗するテストができたので、次は実装ですね！」そうです！テストが通るように、最小限のコードを実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">dom</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="nn">dom</span><span class="p">.{</span><span class="nc">KeyboardEvent</span><span class="p">,</span><span class="w"> </span><span class="n">document</span><span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">プレイヤ</span><span class="err">ー</span><span class="p">(</span>
<span class="w">    </span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="p">,</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">,</span>
<span class="w">    </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">上</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">下</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">  </span><span class="c1">// テスト用のアクセサ</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">入力キ</span><span class="err">ー</span><span class="n">左</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">入力キ</span><span class="err">ー</span><span class="n">右</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">入力キ</span><span class="err">ー</span><span class="n">上</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">上</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">入力キ</span><span class="err">ー</span><span class="n">下</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">下</span>

<span class="w">  </span><span class="c1">// キーボードイベントの登録</span>
<span class="w">  </span><span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s">&quot;keydown&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">onKeyDown</span><span class="w"> </span><span class="n">_</span><span class="p">)</span>
<span class="w">  </span><span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s">&quot;keyup&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">onKeyUp</span><span class="w"> </span><span class="n">_</span><span class="p">)</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onKeyDown</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">KeyboardEvent</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onKeyUp</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">KeyboardEvent</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// テスト用のメソッド（実装からも呼び出す）</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">key</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowUp&quot;</span><span class="w">    </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">上</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">下</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w">            </span><span class="o">=&gt;</span><span class="w"> </span><span class="c1">// 何もしない</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど！キーが押されたり離されたりしたときのイベントを検知して、フラグを設定しているんですね。」そうです！ここでは、<code>document.addEventListener</code>を使って、キーボードのイベントをリッスンしています。</p>
<p>Scala.js では、イベントハンドラの登録も型安全に行えます。<code>onKeyDown _</code> の <code>_</code> は、メソッドを関数値に変換するための記法です。</p>
<p>また、<code>キー状態を設定</code> メソッドを public にすることで、テストからも呼び出せるようにし、実際のイベントハンドラからも共通のロジックを使うようにしています。これは「テスタビリティ」を高めるための設計です。</p>
<h3 id="_26">テスト: ぷよの移動<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>「次は何をテストしますか？」次は、ぷよを左右に移動する機能をテストしましょう。ぷよが左右に移動できるか、そして画面の端に到達したときに移動が制限されるかをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/PlayerSpec.scala（続き）</span>
<span class="s">&quot;プレイヤー movement&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;可能な場合に左に移動する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">左に移動</span><span class="p">()</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;可能な場合に右に移動する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">右に移動</span><span class="p">()</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;左端では左に移動しない&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標を設定</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// 左端に設定</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">左に移動</span><span class="p">()</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;右端では右に移動しない&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標を設定</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 右端に設定</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">右に移動</span><span class="p">()</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、以下の4つのケースを確認しています：</p>
<ol>
<li>通常の状態で左に移動できるか</li>
<li>通常の状態で右に移動できるか</li>
<li>左端にいるときに左に移動しようとしても位置が変わらないか</li>
<li>右端にいるときに右に移動しようとしても位置が変わらないか</li>
</ol>
<h3 id="_27">実装: ぷよの移動<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを移動させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala（続き）</span>
<span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nc">InitialPuyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nc">InitialPuyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nc">MinPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nc">MaxPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>

<span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoX</span>
<span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoY</span>
<span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_ぷよの種類</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_nextPuyoType</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">回転</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="c1">// テスト用のアクセサ</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ぷよのX座標</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ぷよのY座標</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのY座標</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ぷよの種類</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよの種類</span>

<span class="c1">// テスト用のセッター</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ぷよのX座標を設定</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>

<span class="k">def</span><span class="w"> </span><span class="nf">新しいぷよを作成</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoX</span>
<span class="w">  </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoY</span>
<span class="w">  </span><span class="n">_ぷよの種類</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRandomPuyoType</span><span class="p">()</span>
<span class="w">  </span><span class="n">_nextPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRandomPuyoType</span><span class="p">()</span>
<span class="w">  </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getRandomPuyoType</span><span class="p">():</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nc">MinPuyoType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scala</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nc">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="nc">MaxPuyoType</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nc">MinPuyoType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">左に移動</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">右に移動</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ぷよの位置や種類を管理するプロパティがたくさんありますね！」そうですね。ぷよの状態を管理するために、いくつかのプロパティを定義しています。</p>
<p>Scala では、<code>private var</code> でプライベートな可変変数を定義し、<code>def</code> で公開するアクセサメソッドを定義します。これにより、カプセル化を保ちながらテストからもアクセスできるようにしています。</p>
<p>また、マジックナンバーを定数として定義することで、コードの可読性と保守性を高めています。Scala では <code>val</code> を使って定数を定義します。</p>
<p>「これでテストは通りましたか？」はい、これでテストは通るはずです！</p>
<h3 id="_28">実装: 設定情報 クラスの拡張<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>次に、画面表示に必要な設定を 設定情報 クラスに追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/設定情報.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">class</span><span class="w"> </span><span class="nc">設定情報</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w">            </span><span class="c1">// ステージの列数</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="w">           </span><span class="c1">// ステージの行数</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ぷよサイズ</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w">            </span><span class="c1">// ぷよのサイズ（ピクセル）</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ背景色</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2a2a2a&quot;</span><span class="w">  </span><span class="c1">// ステージの背景色</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ枠線色</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#444&quot;</span><span class="w">         </span><span class="c1">// ステージの枠線色</span>
<span class="p">}</span>
</code></pre></div>
<p>Scala では、コンストラクタの引数なしでフィールドを定義する場合は、クラス本体に直接 <code>val</code> で定義します。</p>
<h3 id="_29">実装: ぷよ画像 クラス<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>ぷよを描画するための ぷよ画像 クラスを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/ぷよ画像.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="nn">dom</span><span class="p">.</span><span class="nc">CanvasRenderingContext2D</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">js</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ぷよ画像</span><span class="p">(</span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">色配列</span><span class="p">:</span><span class="w"> </span><span class="n">js</span><span class="p">.</span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">js</span><span class="p">.</span><span class="nc">Array</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;#888&quot;</span><span class="p">,</span><span class="w">    </span><span class="c1">// 0: 空</span>
<span class="w">    </span><span class="s">&quot;#ff0000&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 1: 赤</span>
<span class="w">    </span><span class="s">&quot;#00ff00&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 2: 緑</span>
<span class="w">    </span><span class="s">&quot;#0000ff&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 3: 青</span>
<span class="w">    </span><span class="s">&quot;#ffff00&quot;</span><span class="w">  </span><span class="c1">// 4: 黄色</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">描画</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="nc">CanvasRenderingContext2D</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ぷよサイズ</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoType</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">puyoType</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">colors</span><span class="p">.</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">colors</span><span class="p">(</span><span class="n">puyoType</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">colors</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 円の中心座標と半径を計算</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">centerX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">centerY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span>

<span class="w">    </span><span class="c1">// ぷよを円形で描画</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">beginPath</span><span class="p">()</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">arc</span><span class="p">(</span><span class="n">centerX</span><span class="p">,</span><span class="w"> </span><span class="n">centerY</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="nc">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">fill</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 枠線を描画</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">strokeStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#000&quot;</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">lineWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">beginPath</span><span class="p">()</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">arc</span><span class="p">(</span><span class="n">centerX</span><span class="p">,</span><span class="w"> </span><span class="n">centerY</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="nc">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">stroke</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Scala.js では、JavaScript の配列を扱う場合は <code>scala.scalajs.js.Array</code> を使用します。これにより、JavaScript の配列と互換性のあるデータ構造を使えます。</p>
<p>また、Canvas API は <code>org.scalajs.dom</code> パッケージから利用できます。Scala の型システムにより、型安全に Canvas API を使用できます。</p>
<h3 id="_30">実装: ステージ クラス<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>ゲームのステージを管理する ステージ クラスを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/ステージ.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">dom</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="nn">dom</span><span class="p">.{</span><span class="nc">CanvasRenderingContext2D</span><span class="p">,</span><span class="w"> </span><span class="nc">HTMLCanvasElement</span><span class="p">,</span><span class="w"> </span><span class="n">document</span><span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">キャンバス</span><span class="p">:</span><span class="w"> </span><span class="nc">HTMLCanvasElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">コンテキスト</span><span class="p">:</span><span class="w"> </span><span class="nc">Option</span><span class="p">[</span><span class="nc">CanvasRenderingContext2D</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">None</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">フィ</span><span class="err">ー</span><span class="n">ルド</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">Array</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>

<span class="w">  </span><span class="n">initializeCanvas</span><span class="p">()</span>
<span class="w">  </span><span class="n">initializeField</span><span class="p">()</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">initializeCanvas</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">キャンバス</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="p">.</span><span class="n">createElement</span><span class="p">(</span><span class="s">&quot;canvas&quot;</span><span class="p">).</span><span class="k">asInstanceOf</span><span class="p">[</span><span class="nc">HTMLCanvasElement</span><span class="p">]</span>
<span class="w">    </span><span class="n">キャンバス</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ぷよサイズ</span>
<span class="w">    </span><span class="n">キャンバス</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ぷよサイズ</span>
<span class="w">    </span><span class="n">キャンバス</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">s&quot;2px solid </span><span class="si">${</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ枠線色</span><span class="si">}</span><span class="s">&quot;</span>
<span class="w">    </span><span class="n">キャンバス</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">backgroundColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ背景色</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stageElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">&quot;ステージ&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stageElement</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">stageElement</span><span class="p">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">キャンバス</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 描画コンテキストを取得</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">canvas</span><span class="p">.</span><span class="n">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">コンテキスト</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="k">asInstanceOf</span><span class="p">[</span><span class="nc">CanvasRenderingContext2D</span><span class="p">])</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">initializeField</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">フィ</span><span class="err">ー</span><span class="n">ルド</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">描画</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// キャンバスをクリア</span>
<span class="w">      </span><span class="n">context</span><span class="p">.</span><span class="n">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">canvas</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">canvas</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// フィールドのぷよを描画</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span>
<span class="w">        </span><span class="n">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">puyoType</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ぷよ画像</span><span class="p">.</span><span class="n">描画</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよを描画</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="n">ぷよ画像</span><span class="p">.</span><span class="n">描画</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよを設定</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">field</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoType</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよを取得</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c1">// 範囲外</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">field</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Scala では、<code>Option</code> 型を使って null 安全にコンテキストを管理します。<code>ctx.foreach</code> により、コンテキストが存在する場合のみ処理を実行できます。</p>
<p><code>Array.fill</code> は、指定されたサイズの配列を指定された値で初期化する便利なメソッドです。</p>
<p><code>for</code> 内包表記を使うことで、ネストしたループを簡潔に書けます。<code>if</code> ガードを使って、特定の条件を満たす要素だけを処理できます。</p>
<h3 id="_31">実装: プレイヤー クラスの拡張<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>プレイヤー クラスに描画と更新のメソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala（追加部分）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">描画</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">drawPuyo</span><span class="p">(</span><span class="n">_ぷよのX座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよの種類</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">更新</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// キー入力に応じて移動</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_32">実装: ゲーム クラスの更新<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>ゲーム クラスのゲームループで描画と更新を行うようにします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/ゲーム.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">dom</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_mode</span><span class="p">:</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Start</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">フレ</span><span class="err">ー</span><span class="n">ム</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">連鎖数</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">:</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">スコア</span><span class="p">:</span><span class="w"> </span><span class="n">スコア</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">モ</span><span class="err">ー</span><span class="n">ド</span><span class="p">:</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mode</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">初期化</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">設定情報</span><span class="p">()</span>
<span class="w">    </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">(</span><span class="n">設定情報</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">    </span><span class="n">スコア</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">スコア</span><span class="p">()</span>

<span class="w">    </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">NewPuyo</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ル</span><span class="err">ー</span><span class="n">プ</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">update</span><span class="p">()</span>
<span class="w">    </span><span class="n">draw</span><span class="p">()</span>
<span class="w">    </span><span class="n">dom</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">requestAnimationFrame</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">loop</span><span class="p">())</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">更新</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="n">_mode</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">NewPuyo</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">        </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">更新</span><span class="p">()</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="c1">// その他の状態は今後実装</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">描画</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">描画</span><span class="p">()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">描画</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Scala のパターンマッチを使って、ゲームモードに応じた処理を分岐しています。<code>match</code> 式は、TypeScript の <code>switch</code> 文よりも強力で、型安全にパターンマッチができます。</p>
<h3 id="mainscala">実装: Main.scala の更新<a class="headerlink" href="#mainscala" title="Permanent link">&para;</a></h3>
<p>エントリーポイントを更新してゲームループを開始します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/Main.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="nn">js</span><span class="p">.</span><span class="nn">annotation</span><span class="p">.</span><span class="nc">JSExportTopLevel</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">dom</span>

<span class="nd">@JSExportTopLevel</span><span class="p">(</span><span class="s">&quot;PuyoPuyoGame&quot;</span><span class="p">)</span>
<span class="k">object</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">()</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">初期化</span><span class="p">()</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">loop</span><span class="p">()</span>

<span class="w">    </span><span class="n">dom</span><span class="p">.</span><span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Puyo Puyo ゲーム Started!&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_33">テストの確認<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下のような結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code>[info] PlayerSpec:
[info] プレイヤー
[info] - 左キーが押されたときに左フラグを設定する
[info] - 右キーが押されたときに右フラグを設定する
[info] - キーが離されたときにフラグをクリアする
[info] プレイヤー movement
[info] - 可能な場合に左に移動する
[info] - 可能な場合に右に移動する
[info] - 左端では左に移動しない
[info] - 右端では右に移動しない
[info] Run completed in 456 milliseconds.
[info] Total number of tests run: 7
[info] Suites: completed 1, aborted 0
[info] Tests: succeeded 7, failed 0, canceled 0, ignored 0, pending 0
[info] All tests passed.
</code></pre></div>
<h3 id="_34">動作確認<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>実際にブラウザで動作を確認してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># JavaScript へのコンパイル</span>
sbt<span class="w"> </span>fastLinkJS

<span class="c1"># ファイルサーバーの起動</span>
python<span class="w"> </span>-m<span class="w"> </span>http.server<span class="w"> </span><span class="m">8000</span>
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> にアクセスすると、ステージが表示され、円形のぷよが表示されます。左右の矢印キーを押すと、ぷよが左右に移動します！</p>
<h3 id="2_1">イテレーション2のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>プレイヤー クラスのキー入力検出</strong></li>
<li>キー入力フラグの実装</li>
<li><code>キー状態を設定</code> メソッドによるテスタビリティの向上</li>
<li>
<p>Scala.js の DOM イベントリスナー登録</p>
</li>
<li>
<p><strong>プレイヤー クラスのぷよ移動機能</strong></p>
</li>
<li>ぷよの状態管理（位置、種類、回転）</li>
<li><code>createNewPuyo</code>、<code>moveLeft</code>、<code>moveRight</code> メソッド</li>
<li>境界チェックによる移動制限</li>
<li>
<p>定数による設定値の管理</p>
</li>
<li>
<p><strong>設定情報 クラスの拡張</strong></p>
</li>
<li>ステージサイズとぷよサイズの定義</li>
<li>
<p>色設定の追加</p>
</li>
<li>
<p><strong>ぷよ画像 クラスの実装</strong></p>
</li>
<li><code>js.Array</code> による色定義</li>
<li>Canvas API を使った円形描画</li>
<li>
<p>型安全な Canvas 操作</p>
</li>
<li>
<p><strong>ステージ クラスの実装</strong></p>
</li>
<li>Canvas 要素の生成と DOM への追加</li>
<li><code>Option</code> 型による null 安全な Context 管理</li>
<li><code>Array.fill</code> による2次元配列の初期化</li>
<li>
<p>for 内包表記による簡潔なループ処理</p>
</li>
<li>
<p><strong>ゲーム クラスのゲームループ</strong></p>
</li>
<li>パターンマッチによる状態管理</li>
<li><code>requestAnimationFrame</code> による継続的な更新</li>
<li>
<p><code>update</code> と <code>draw</code> の分離</p>
</li>
<li>
<p><strong>Scala.js の特徴的な実装</strong></p>
</li>
<li><code>Option</code> 型による null 安全性</li>
<li>パターンマッチによる型安全な分岐</li>
<li>for 内包表記による簡潔なコード</li>
<li><code>asInstanceOf</code> による型キャスト（最小限の使用）</li>
<li><code>js.Array</code> による JavaScript 互換配列</li>
</ol>
<p>次のイテレーションでは、ぷよの回転機能を実装していきます。</p>
<h2 id="3">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_35">ユーザーストーリー<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、この2つのぷよの相対的な位置関係を変えることです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを回転させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの回転処理を実装する（時計回り・反時計回りの回転）</li>
<li>回転可能かどうかのチェックを実装する（他のぷよや壁にぶつかる場合は回転できないようにする）</li>
<li>壁キック処理を実装する（壁際での回転を可能にする特殊処理）</li>
<li>回転後の表示を更新する（画面上でぷよの位置が変わったことを表示する）</li>
</ul>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_36">テスト: ぷよの回転<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは基本的な回転機能のテストから書いていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/PlayerSpec.scala（続き）</span>
<span class="s">&quot;プレイヤー rotation&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;時計回りに回転して回転状態をインクリメントする&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">右に回転</span><span class="p">()</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="p">((</span><span class="n">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;反時計回りに回転して回転状態をデクリメントする&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">左に回転</span><span class="p">()</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="p">((</span><span class="n">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;右回転時に回転状態を3から0にラップする&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態を設定</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">右に回転</span><span class="p">()</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>時計回りに回転すると、回転状態が1増えるか</li>
<li>反時計回りに回転すると、回転状態が1減るか（ただし、負の値にならないように調整）</li>
<li>回転状態が最大値（3）から時計回りに回転すると、0に戻るか（循環するか）</li>
</ol>
<p>「回転状態って何ですか？」回転状態は、ぷよの向きを表す値です。0から3までの値を取り、それぞれ以下の状態を表します：</p>
<ul>
<li>0: 2つ目のぷよが上にある状態</li>
<li>1: 2つ目のぷよが右にある状態</li>
<li>2: 2つ目のぷよが下にある状態</li>
<li>3: 2つ目のぷよが左にある状態</li>
</ul>
<p>「なるほど、4方向の回転を表現するんですね！」そうです！では、このテストが通るように実装していきましょう。</p>
<h3 id="_37">実装: ぷよの回転<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを回転させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala（続き）</span>

<span class="c1">// 回転状態をテストからアクセス可能にする</span>
<span class="k">def</span><span class="w"> </span><span class="nf">回転状態</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_回転状態</span>
<span class="k">def</span><span class="w"> </span><span class="nf">回転状態を設定</span><span class="p">(</span><span class="n">r</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span>

<span class="c1">// 2つ目のぷよのオフセット（回転状態に応じた相対位置）</span>
<span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">オフセットX</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 右、下、左、上のX方向オフセット</span>
<span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">オフセットY</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="c1">// 右、下、左、上のY方向オフセット</span>

<span class="k">def</span><span class="w"> </span><span class="nf">右に回転</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 時計回りに回転（0→1→2→3→0）</span>
<span class="w">  </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_回転状態</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">左に回転</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 反時計回りに回転（0→3→2→1→0）</span>
<span class="w">  </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_回転状態</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。回転処理自体はとてもシンプルです。<code>rotateRight</code>メソッドでは回転状態を1増やし、<code>rotateLeft</code>メソッドでは回転状態を1減らしています（ただし、負の値にならないように3を足して4で割った余りを取っています）。</p>
<p>「なぜ反時計回りの場合は単純に1減らすのではなく、3を足して4で割るんですか？」鋭い質問ですね！Scala でも、負の数の剰余演算（<code>%</code>演算子）の結果が負になることがあります。例えば、<code>-1 % 4</code>は<code>-1</code>になります。しかし、私たちは常に0から3の範囲の値が欲しいので、3を足して（これは1を引くのと同じ効果があります）から4で割ることで、確実に正の値の範囲内に収めているんです。</p>
<blockquote>
<p>剰余演算子 (%) は、1つ目のオペランドが2つ目のオペランドで除算されたときの余りである剰余を返します。これは常に被除数の符号を取ります。</p>
<p>— Mozilla Developer Network 『剰余演算子』</p>
</blockquote>
<p>「テストは通りましたか？」はい、これでテストは通るはずです！これで基本的な回転機能が実装できました。しかし、まだ壁際での回転（壁キック）処理が実装されていませんね。次はそれをテストしていきましょう。</p>
<h3 id="_38">テスト: 壁キック処理<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>「壁キック処理のテストはどうやって書くんですか？」壁キック処理は、ぷよが壁際にあるときに回転すると自動的に位置を調整する機能です。これをテストするには、ぷよを壁際に配置し、回転させたときに適切に位置が調整されるかを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/PlayerSpec.scala（続き）</span>
<span class="s">&quot;Wall kick&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;右端で右回転時に左に移動する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標を設定</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 右端に配置</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態を設定</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="c1">// 上向き</span>

<span class="w">  </span><span class="c1">// 右回転（2つ目のぷよが右にくる）</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">右に回転</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 壁キックにより左に移動していることを確認</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">1</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;左端で左回転時に右に移動する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標を設定</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="c1">// 左端に配置</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態を設定</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="c1">// 上向き</span>

<span class="w">  </span><span class="c1">// 左回転（2つ目のぷよが左にくる）</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">左に回転</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 壁キックにより右に移動していることを確認</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">3</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>右端にいるときに時計回りに回転すると、左に1マス移動して回転するか</li>
<li>左端にいるときに反時計回りに回転すると、右に1マス移動して回転するか</li>
</ol>
<p>「なるほど、壁にめり込まないように自動的に位置を調整するんですね！」そうです！これがいわゆる「壁キック」と呼ばれる処理です。プレイヤーの操作性を向上させるための工夫なんですよ。では、このテストが通るように実装していきましょう。</p>
<h3 id="_39">実装: 壁キック処理<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、壁キック処理を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">右に回転</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 時計回りに回転</span>
<span class="w">  </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_回転状態</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>

<span class="w">  </span><span class="c1">// 壁キック処理</span>
<span class="w">  </span><span class="n">performWallKick</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">左に回転</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 反時計回りに回転</span>
<span class="w">  </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_回転状態</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>

<span class="w">  </span><span class="c1">// 壁キック処理</span>
<span class="w">  </span><span class="n">performWallKick</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">performWallKick</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 2つ目のぷよの位置を計算</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 右端で右回転した場合（2つ目のぷよが右にくる場合）</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 左に移動（壁キック）</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 左端で左回転した場合（2つ目のぷよが左にくる場合）</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 右に移動（壁キック）</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、回転後に壁にめり込む場合は位置を調整するんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li>まず通常の回転処理を行う</li>
<li>回転後、ぷよが壁にめり込む状況になっていないかチェックする</li>
<li>めり込む場合は、ぷよの位置を調整する（壁キック）</li>
</ol>
<p>「<code>rotateRight</code>と<code>rotateLeft</code>で同じ壁キック処理を呼び出していますね。」そうです！重複するコードを<code>performWallKick</code>メソッドに抽出することで、コードの重複を減らしました。これはリファクタリングの基本原則の一つ、「DRY原則（Don't Repeat Yourself）」に従っています。</p>
<p>「テストは通りましたか？」はい、これでテストは通るはずです！これでぷよを回転させる機能と、壁際での特殊処理（壁キック）が実装できました。</p>
<h3 id="2_2">実装: 2つ目のぷよを考慮した移動制限<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<p>「回転ができるようになったということは、2つ目のぷよの位置も考慮して移動を制限する必要がありますね？」鋭い指摘です！現在の<code>moveLeft</code>と<code>moveRight</code>は、軸ぷよ（1つ目のぷよ）しか考慮していません。2つ目のぷよも考慮するように改善しましょう。</p>
<p>まずはテストから書きます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/PlayerSpec.scala（続き）</span>
<span class="s">&quot;プレイヤー movement with rotation&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;2つ目のぷよが右端を超える場合は右に移動しない&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標を設定</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 右端に配置</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態を設定</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよが右にある状態</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">右に移動</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 移動していないことを確認</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;2つ目のぷよが左端を超える場合は左に移動しない&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標を設定</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="c1">// 左端に配置</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態を設定</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよが左にある状態</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">左に移動</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 移動していないことを確認</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>次に実装を改善します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">左に移動</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 軸ぷよと2つ目のぷよが範囲内かチェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextX</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">右に移動</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 軸ぷよと2つ目のぷよが範囲内かチェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextX</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「これで軸ぷよと2つ目のぷよの両方が範囲内にある場合のみ移動できるようになりましたね！」そうです！これでより正確な移動制限が実装できました。</p>
<h3 id="2_3">実装: 2つ目のぷよの描画<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h3>
<p>「回転機能ができたので、2つ目のぷよも描画する必要がありますね！」その通りです！現在は軸ぷよしか描画していないので、2つ目のぷよも描画するように<code>draw</code>メソッドを改善しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">描画</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 軸ぷよを描画</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">drawPuyo</span><span class="p">(</span><span class="n">_ぷよのX座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよの種類</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 2つ目のぷよを描画</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetY</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">drawPuyo</span><span class="p">(</span><span class="n">secondPuyoX</span><span class="p">,</span><span class="w"> </span><span class="n">secondPuyoY</span><span class="p">,</span><span class="w"> </span><span class="n">_nextPuyoType</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、回転状態に応じたオフセットを使って2つ目のぷよの位置を計算するんですね！」そうです！<code>offsetX</code>と<code>offsetY</code>配列を使って、回転状態に応じた2つ目のぷよの相対位置を計算しています。</p>
<h3 id="_40">実装: プレイヤー クラスの完全版<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>これまでの実装をまとめた プレイヤー クラスの完全版を確認しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">dom</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="nn">dom</span><span class="p">.{</span><span class="nc">KeyboardEvent</span><span class="p">,</span><span class="w"> </span><span class="n">document</span><span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">プレイヤ</span><span class="err">ー</span><span class="p">(</span>
<span class="w">    </span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="p">,</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">,</span>
<span class="w">    </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nc">InitialPuyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nc">InitialPuyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nc">MinPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nc">MaxPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">上</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">下</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoX</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoY</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_ぷよの種類</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_nextPuyoType</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_回転状態</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">  </span><span class="c1">// 2つ目のぷよのオフセット（回転状態に応じた相対位置）</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">オフセットX</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">オフセットY</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// テスト用のアクセサ</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">入力キ</span><span class="err">ー</span><span class="n">左</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">入力キ</span><span class="err">ー</span><span class="n">右</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">入力キ</span><span class="err">ー</span><span class="n">上</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">上</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">入力キ</span><span class="err">ー</span><span class="n">下</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">下</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよのX座標</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよのY座標</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのY座標</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよの種類</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよの種類</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">回転状態</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_回転状態</span>

<span class="w">  </span><span class="c1">// テスト用のセッター</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよのX座標を設定</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">回転状態を設定</span><span class="p">(</span><span class="n">r</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span>

<span class="w">  </span><span class="c1">// キーボードイベントの登録</span>
<span class="w">  </span><span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s">&quot;keydown&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">onKeyDown</span><span class="w"> </span><span class="n">_</span><span class="p">)</span>
<span class="w">  </span><span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s">&quot;keyup&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">onKeyUp</span><span class="w"> </span><span class="n">_</span><span class="p">)</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onKeyDown</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">KeyboardEvent</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onKeyUp</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">KeyboardEvent</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">キ</span><span class="err">ー</span><span class="n">状態を設定</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">pressed</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">key</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowUp&quot;</span><span class="w">    </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">上</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">下</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w">            </span><span class="o">=&gt;</span><span class="w"> </span><span class="c1">// 何もしない</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">新しいぷよを作成</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoX</span>
<span class="w">    </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoY</span>
<span class="w">    </span><span class="n">_ぷよの種類</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRandomPuyoType</span><span class="p">()</span>
<span class="w">    </span><span class="n">_nextPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRandomPuyoType</span><span class="p">()</span>
<span class="w">    </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">getRandomPuyoType</span><span class="p">():</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nc">MinPuyoType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scala</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nc">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="nc">MaxPuyoType</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nc">MinPuyoType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">左に移動</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextX</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">右に移動</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondPuyoNextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextX</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">右に回転</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_回転状態</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="n">performWallKick</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">左に回転</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_回転状態</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="n">performWallKick</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">performWallKick</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">描画</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 軸ぷよを描画</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">drawPuyo</span><span class="p">(</span><span class="n">_ぷよのX座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよの種類</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 2つ目のぷよを描画</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetY</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">drawPuyo</span><span class="p">(</span><span class="n">secondPuyoX</span><span class="p">,</span><span class="w"> </span><span class="n">secondPuyoY</span><span class="p">,</span><span class="w"> </span><span class="n">_nextPuyoType</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">更新</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// キー入力に応じて移動</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">moveLeft</span><span class="p">()</span>
<span class="w">      </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">左</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">moveRight</span><span class="p">()</span>
<span class="w">      </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">右</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// キー入力に応じて回転</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">上</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">rotateRight</span><span class="p">()</span>
<span class="w">      </span><span class="n">_入力キ</span><span class="err">ー</span><span class="n">上</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_41">テストの確認<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下のような結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code>[info] PlayerSpec:
[info] プレイヤー
[info] - 左キーが押されたときに左フラグを設定する
[info] - 右キーが押されたときに右フラグを設定する
[info] - キーが離されたときにフラグをクリアする
[info] プレイヤー movement
[info] - 可能な場合に左に移動する
[info] - 可能な場合に右に移動する
[info] - 左端では左に移動しない
[info] - 右端では右に移動しない
[info] プレイヤー rotation
[info] - 時計回りに回転して回転状態をインクリメントする
[info] - 反時計回りに回転して回転状態をデクリメントする
[info] - 右回転時に回転状態を3から0にラップする
[info] Wall kick
[info] - 右端で右回転時に左に移動する
[info] - 左端で左回転時に右に移動する
[info] プレイヤー movement with rotation
[info] - 2つ目のぷよが右端を超える場合は右に移動しない
[info] - 2つ目のぷよが左端を超える場合は左に移動しない
[info] Run completed in 678 milliseconds.
[info] Total number of tests run: 14
[info] Suites: completed 1, aborted 0
[info] Tests: succeeded 14, failed 0, canceled 0, ignored 0, pending 0
[info] All tests passed.
</code></pre></div>
<h3 id="_42">動作確認<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>実際にブラウザで動作を確認してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># JavaScript へのコンパイル</span>
sbt<span class="w"> </span>fastLinkJS

<span class="c1"># ファイルサーバーの起動</span>
python<span class="w"> </span>-m<span class="w"> </span>http.server<span class="w"> </span><span class="m">8000</span>
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> にアクセスすると、2つのぷよが表示され、上キーを押すと回転し、左右キーを押すと移動します！壁際で回転しても壁キックが働いて正しく回転できることを確認してください。</p>
<h3 id="3_1">イテレーション3のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの回転機能と壁際での特殊処理を実装しました。以下がイテレーション3で実施した内容のまとめです：</p>
<ol>
<li><strong>回転状態の管理</strong></li>
<li><code>rotation</code> プロパティ：0（上）、1（右）、2（下）、3（左）の4状態で管理</li>
<li>
<p>回転状態に応じた2つ目のぷよの位置計算（<code>offsetX</code>、<code>offsetY</code> 配列使用）</p>
</li>
<li>
<p><strong>回転メソッドの実装</strong></p>
</li>
<li><code>rotateRight</code> メソッド：時計回りに回転（rotation を +1）</li>
<li><code>rotateLeft</code> メソッド：反時計回りに回転（rotation を +3、つまり -1 と同等）</li>
<li>
<p><code>performWallKick</code> メソッド：回転処理と壁キック処理を統合</p>
</li>
<li>
<p><strong>壁キック処理</strong></p>
</li>
<li>回転後に2つ目のぷよが壁外に出る場合、軸ぷよの位置を自動調整</li>
<li>左壁キック：<code>nextX &lt; 0</code> のとき <code>puyoX</code> を +1</li>
<li>
<p>右壁キック：<code>nextX &gt;= ステージ列数</code> のとき <code>puyoX</code> を -1</p>
</li>
<li>
<p><strong>2つ目のぷよを考慮した移動制限</strong></p>
</li>
<li><code>moveLeft</code>/<code>moveRight</code> の改善：回転状態に応じて2つ目のぷよの位置も計算</li>
<li>
<p>軸ぷよと2つ目のぷよの両方が範囲内にある場合のみ移動可能</p>
</li>
<li>
<p><strong>描画の更新</strong></p>
</li>
<li><code>draw</code> メソッドで回転状態に応じた2つ目のぷよの描画</li>
<li>
<p>軸ぷよと2つ目のぷよを両方描画</p>
</li>
<li>
<p><strong>キー入力の統合</strong></p>
</li>
<li><code>update</code> メソッドで上キー（<code>入力キー上</code>）による回転処理</li>
<li>
<p>回転後フラグをクリア</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>回転機能のテスト（3テスト）<ul>
<li>時計回りに回転すると回転状態が1増える</li>
<li>反時計回りに回転すると回転状態が1減る</li>
<li>回転状態が4になると0に戻る</li>
</ul>
</li>
<li>壁キック処理のテスト（2テスト）<ul>
<li>左壁際で回転すると右にキックする</li>
<li>右壁際で回転すると左にキックする</li>
</ul>
</li>
<li>横向き移動制限のテスト（2テスト）<ul>
<li>横向き（右）の状態で右端にいる場合、右に移動できない</li>
<li>横向き（左）の状態で左端にいる場合、左に移動できない</li>
</ul>
</li>
<li>
<p>合計14テストすべて成功</p>
</li>
<li>
<p><strong>TDD サイクルの実践</strong></p>
</li>
<li>Red: 回転・壁キック・移動制限のテストを先に作成し失敗を確認</li>
<li>Green: 各機能を実装してテストを通過</li>
<li>
<p>Refactor: <code>performWallKick</code> メソッドへの共通処理抽出</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>4方向状態管理：配列インデックスによる効率的な座標オフセット計算</li>
<li>壁キック：ユーザビリティ向上のための位置自動調整</li>
<li>複合的な境界チェック：軸ぷよと2つ目のぷよ両方の範囲チェック</li>
<li>
<p>DRY原則：重複コードの共通メソッド化（<code>performWallKick</code>）</p>
</li>
<li>
<p><strong>Scala の特徴的な実装</strong></p>
<ul>
<li><code>Array</code> による固定長配列の効率的な使用</li>
<li>剰余演算を使った循環的な状態管理</li>
<li>メソッドの適切な抽出によるコードの再利用</li>
</ul>
</li>
</ol>
<p><strong>注意</strong>: このイテレーションでは壁との境界チェックのみを実装しており、既存のぷよとの衝突判定はまだ実装されていません。そのため、回転や移動時に着地済みのぷよを上書きしてしまう問題があります。この問題は後のイテレーションで修正します。</p>
<p>このイテレーションにより、ぷよを自由に回転させながら左右に移動できるようになり、ぷよぷよの基本的な操作性が実現できました。</p>
<p>次のイテレーションでは、ぷよの自由落下機能を実装していきます。</p>
<h2 id="4">イテレーション4: ぷよの自由落下の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよって自動で落ちていくよね？」そうですね！ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきます。今回は、その「自由落下」機能を実装していきましょう！</p>
<h3 id="_43">ユーザーストーリー<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとしてぷよを自由落下させることができる</p>
</blockquote>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを自由落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>落下タイマーの実装（一定時間ごとに落下処理を実行する仕組み）</li>
<li>自動落下処理の実装（タイマーが発火したときにぷよを1マス下に移動する）</li>
<li>落下可能判定の実装（下に移動できるかどうかをチェックする）</li>
<li>着地処理の実装（ぷよが着地したときの処理）</li>
<li>ゲームループとの統合（ゲームの更新処理に自由落下を組み込む）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_44">テスト: 落下タイマー<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、一定時間ごとに落下処理が実行される仕組みをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/PlayerSpec.scala（続き）</span>
<span class="s">&quot;プレイヤー auto drop&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;drop one row after drop interval&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000.0</span><span class="w">  </span><span class="c1">// 1000ミリ秒 = 1秒</span>

<span class="w">  </span><span class="c1">// 落下間隔分の時間を経過させる</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="n">dropInterval</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 1マス下に落ちていることを確認</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;not drop before drop interval&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000.0</span>

<span class="w">  </span><span class="c1">// 落下間隔の半分だけ経過させる</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="n">dropInterval</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 位置が変わっていないことを確認</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">initialY</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;not drop beyond bottom edge&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標を設定</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="c1">// 下端に配置</span>

<span class="w">  </span><span class="c1">// 落下処理を実行</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 位置が変わっていないことを確認（下端を超えない）</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>落下間隔が経過すると、ぷよが1マス下に落ちるか</li>
<li>落下間隔未満では、ぷよは落ちないか</li>
<li>下端に達した場合、それ以上落ちないか</li>
</ol>
<p>「テストを書いたら、次は実装ですね！」その通りです。Red（失敗）→ Green（成功）→ Refactor（改善）のサイクルで進めていきましょう。</p>
<h3 id="_45">実装: 落下タイマー<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、落下タイマーを実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala（続き）</span>
<span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">落下タイマ</span><span class="err">ー</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">落下間隔</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000.0</span><span class="w">  </span><span class="c1">// 1秒ごとに落下</span>

<span class="c1">// テスト用のアクセサ</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ぷよのY座標を設定</span><span class="p">(</span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span>

<span class="k">def</span><span class="w"> </span><span class="nf">デルタ時間で更新</span><span class="p">(</span><span class="n">デルタ時間</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// タイマーを進める</span>
<span class="w">  </span><span class="n">dropTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">デルタ時間</span>

<span class="w">  </span><span class="c1">// 落下間隔を超えたら落下処理を実行</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dropTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">dropInterval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">applyGravity</span><span class="p">()</span>
<span class="w">    </span><span class="n">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">  </span><span class="c1">// タイマーをリセット</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 既存の update 処理も実行（キー入力処理）</span>
<span class="w">  </span><span class="n">update</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">重力を適用</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">canMoveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 着地した場合の処理（後で実装）</span>
<span class="w">    </span><span class="n">onLanded</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">下に移動できる</span><span class="p">():</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 下端チェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 2つ目のぷよの位置を計算</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetY</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 軸ぷよの下にぷよがあるかチェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="n">_ぷよのX座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 2つ目のぷよの下にぷよがあるかチェック</span>
<span class="w">  </span><span class="c1">// ただし、2つ目のぷよが下向き（rotation == 2）の場合はスキップ</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offsetY</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondPuyoY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="n">secondPuyoX</span><span class="p">,</span><span class="w"> </span><span class="n">secondPuyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kc">true</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onLanded</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 着地処理（後で実装）</span>
<span class="w">  </span><span class="n">dom</span><span class="p">.</span><span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;ぷよが着地しました&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>「タイマーを使って一定間隔で落下させるんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li><code>dropTimer</code> でタイマーを管理</li>
<li><code>updateWithDelta()</code> メソッドで経過時間を加算</li>
<li>一定間隔（<code>dropInterval</code>）を超えたら <code>applyGravity()</code> を実行</li>
<li><code>applyGravity()</code> で下に移動できるかチェックし、移動または着地処理を実行</li>
</ol>
<p>「Scala では <code>Double</code> 型で時間を管理するんですね。」そうです！JavaScript の <code>number</code> 型と互換性を保つために、<code>Double</code> 型を使用しています。</p>
<h3 id="_46">テスト: 着地判定<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>「ぷよが着地したときの処理もテストしたいです！」いいですね！次は、ぷよが着地したときの振る舞いをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/PlayerSpec.scala（続き）</span>
<span class="s">&quot;プレイヤー landing&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;fix puyo to ステージ when landed&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標を設定</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// 下端の1つ上に配置</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態を設定</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよが下にある状態</span>

<span class="w">  </span><span class="c1">// 落下処理を実行（着地する）</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ステージにぷよが固定されていることを確認</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのX座標</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;set landed flag when puyo lands&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標を設定</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態を設定</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 落下処理を実行（着地する）</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 着地フラグが立っていることを確認</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">着地した</span><span class="p">()</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;land on top of existing puyo&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ステージの底に既存のぷよを配置</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標を設定</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">回転状態を設定</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよが下</span>

<span class="w">  </span><span class="c1">// 2回落下（着地するまで）</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 既存のぷよの上に着地していることを確認</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_47">実装: 着地処理<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、着地処理を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/プレイヤー.scala（続き）</span>
<span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_着地済み</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="c1">// テスト用のアクセサ</span>
<span class="k">def</span><span class="w"> </span><span class="nf">着地した</span><span class="p">():</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_着地済み</span>

<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onLanded</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 軸ぷよをステージに固定</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="n">_ぷよのX座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="p">,</span><span class="w"> </span><span class="n">_ぷよの種類</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 2つ目のぷよをステージに固定</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">secondPuyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetY</span><span class="p">(</span><span class="n">_回転状態</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="n">secondPuyoX</span><span class="p">,</span><span class="w"> </span><span class="n">secondPuyoY</span><span class="p">,</span><span class="w"> </span><span class="n">_nextPuyoType</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 着地フラグを立てる</span>
<span class="w">  </span><span class="n">_着地済み</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>

<span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">新しいぷよを作成</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">_ぷよのX座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoX</span>
<span class="w">  </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">InitialPuyoY</span>
<span class="w">  </span><span class="n">_ぷよの種類</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRandomPuyoType</span><span class="p">()</span>
<span class="w">  </span><span class="n">_nextPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRandomPuyoType</span><span class="p">()</span>
<span class="w">  </span><span class="n">_回転状態</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">_着地済み</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w">  </span><span class="c1">// 着地フラグをリセット</span>
<span class="w">  </span><span class="n">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">  </span><span class="c1">// タイマーもリセット</span>
<span class="p">}</span>
</code></pre></div>
<p>「着地したらステージに固定して、フラグを立てるんですね！」その通りです！この実装では、以下のことを行っています：</p>
<ol>
<li><code>onLanded()</code> で軸ぷよと2つ目のぷよをステージに配置</li>
<li>着地フラグ（<code>_着地済み</code>）を立てる</li>
<li><code>createNewPuyo()</code> で着地フラグをリセット</li>
</ol>
<p>「これでテストは通りましたか？」はい、これでテストは通るはずです！</p>
<h3 id="_48">実装: ステージ クラスの重力処理<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>「着地したぷよの上に新しいぷよを重ねられるようになりましたね。でも、浮いているぷよはどうなるんですか？」鋭い質問ですね！ステージ上の浮いているぷよにも重力を適用する必要があります。ステージ クラスに重力処理を追加しましょう。</p>
<p>まずはテストから：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/com/example/puyo/StageSpec.scala（新規作成）</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">flatspec</span><span class="p">.</span><span class="nc">AnyFlatSpec</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">matchers</span><span class="p">.</span><span class="nn">should</span><span class="p">.</span><span class="nc">Matchers</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nc">BeforeAndAfterEach</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ステ</span><span class="err">ー</span><span class="n">ジSpec</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">AnyFlatSpec</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">Matchers</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">BeforeAndAfterEach</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">beforeEach</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">設定情報</span><span class="p">()</span>
<span class="w">    </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">(</span><span class="n">設定情報</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="s">&quot;ステージ gravity&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;make floating puyo fall one row&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 浮いている青ぷよを配置（下に空きがある）</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// 下端に黄色ぷよの積み重ね</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 重力を適用</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">重力を適用</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 青ぷよが1マス落ちていることを確認</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="n">hasFallen</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">true</span>

<span class="w">    </span><span class="c1">// 黄色ぷよは変わらない（下端に積み重なっているので動かない）</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;return false when no puyo falls&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 全てのぷよが支えられている状態</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 重力を適用</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">重力を適用</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 何も落ちていないことを確認</span>
<span class="w">    </span><span class="n">hasFallen</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;make multiple floating puyos fall&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 複数の浮いているぷよを配置</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 重力を適用</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">重力を適用</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 全てのぷよが1マス落ちていることを確認</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="n">hasFallen</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>次に ステージ クラスに重力処理を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/ステージ.scala（追加）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">重力を適用</span><span class="p">():</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// フィールドのコピーを作成（移動前の状態を保存）</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">originalField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">  </span><span class="c1">// 下から上に向かって各列をスキャン（列ごとに処理）</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalField</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">puyoType</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 元のフィールドで下に空きがあるかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">originalField</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 1マス下に移動</span>
<span class="w">          </span><span class="n">フィ</span><span class="err">ー</span><span class="n">ルド</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoType</span>
<span class="w">          </span><span class="n">フィ</span><span class="err">ー</span><span class="n">ルド</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">          </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">hasFallen</span>
<span class="p">}</span>
</code></pre></div>
<p>「フィールドのコピーを作成するんですね。なぜですか？」良い質問です！フィールドを直接変更しながらスキャンすると、すでに移動したぷよが再度移動されてしまう可能性があります。元の状態のコピーを保持することで、各ぷよが1回の呼び出しで1マスだけ落ちることを保証しています。</p>
<p>「Scala では <code>map(_.clone())</code> で2次元配列をコピーするんですね。」そうです！<code>map</code> で各行に対して <code>clone()</code> を呼び出すことで、深いコピーを作成しています。</p>
<h3 id="_49">実装: ゲーム クラスの拡張<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>「ゲームループで重力処理を呼び出す必要がありますね？」その通りです！ゲーム クラスを拡張して、着地後に重力処理を実行するようにしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/com/example/puyo/ゲーム.scala（更新）</span>
<span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">puyo</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">dom</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">_mode</span><span class="p">:</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Start</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">フレ</span><span class="err">ー</span><span class="n">ム</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">連鎖数</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">最終時刻</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">:</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">スコア</span><span class="p">:</span><span class="w"> </span><span class="n">スコア</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">モ</span><span class="err">ー</span><span class="n">ド</span><span class="p">:</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mode</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">初期化</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">設定情報</span><span class="p">()</span>
<span class="w">    </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">(</span><span class="n">設定情報</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">    </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">    </span><span class="n">スコア</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">スコア</span><span class="p">()</span>

<span class="w">    </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">NewPuyo</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ル</span><span class="err">ー</span><span class="n">プ</span><span class="p">(</span><span class="n">currentTime</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 経過時間を計算（ミリ秒）</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">デルタ時間</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastTime</span>
<span class="w">    </span><span class="n">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentTime</span>

<span class="w">    </span><span class="n">update</span><span class="p">(</span><span class="n">デルタ時間</span><span class="p">)</span>
<span class="w">    </span><span class="n">draw</span><span class="p">()</span>
<span class="w">    </span><span class="n">dom</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">requestAnimationFrame</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">loop</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">更新</span><span class="p">(</span><span class="n">デルタ時間</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="n">_mode</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">NewPuyo</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">        </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">        </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="c1">// プレイ中の処理（キー入力と自由落下）</span>
<span class="w">        </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="n">デルタ時間</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 着地したら重力チェックに移行</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">着地した</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="c1">// 重力を適用</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">重力を適用</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasFallen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// ぷよが落下した場合、Fall モードへ</span>
<span class="w">          </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Fall</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 落下するぷよがない場合、次のぷよを出す</span>
<span class="w">          </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">NewPuyo</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Fall</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="c1">// 落下アニメーション用（一定フレーム待機）</span>
<span class="w">        </span><span class="c1">// 簡略化のため、すぐに CheckFall に戻る</span>
<span class="w">        </span><span class="n">_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="c1">// その他の状態は今後実装</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">描画</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">描画</span><span class="p">()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">描画</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>requestAnimationFrame</code> が <code>currentTime</code> を渡してくれるんですね！」そうです！ブラウザが提供する高精度なタイムスタンプを使って、フレーム間の経過時間を計算します。Scala.js では <code>Double</code> 型として受け取ります。</p>
<h3 id="_50">テストの確認<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>sbt<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下のような結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code>[info] PlayerSpec:
[info] プレイヤー
[info] - 左キーが押されたときに左フラグを設定する
[info] - 右キーが押されたときに右フラグを設定する
[info] - キーが離されたときにフラグをクリアする
[info] プレイヤー movement
[info] - 可能な場合に左に移動する
[info] - 可能な場合に右に移動する
[info] - 左端では左に移動しない
[info] - 右端では右に移動しない
[info] プレイヤー rotation
[info] - 時計回りに回転して回転状態をインクリメントする
[info] - 反時計回りに回転して回転状態をデクリメントする
[info] - 右回転時に回転状態を3から0にラップする
[info] Wall kick
[info] - 右端で右回転時に左に移動する
[info] - 左端で左回転時に右に移動する
[info] プレイヤー movement with rotation
[info] - 2つ目のぷよが右端を超える場合は右に移動しない
[info] - 2つ目のぷよが左端を超える場合は左に移動しない
[info] プレイヤー auto drop
[info] - should drop one row after drop interval
[info] - should not drop before drop interval
[info] - should not drop beyond bottom edge
[info] プレイヤー landing
[info] - should fix puyo to ステージ when landed
[info] - should set landed flag when puyo lands
[info] - should land on top of existing puyo
[info]
[info] StageSpec:
[info] ステージ gravity
[info] - should make floating puyo fall one row
[info] - should return false when no puyo falls
[info] - should make multiple floating puyos fall
[info]
[info] Run completed in 892 milliseconds.
[info] Total number of tests run: 23
[info] Suites: completed 2, aborted 0
[info] Tests: succeeded 23, failed 0, canceled 0, ignored 0, pending 0
[info] All tests passed.
</code></pre></div>
<h3 id="_51">動作確認<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>実際にブラウザで動作を確認してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># JavaScript へのコンパイル</span>
sbt<span class="w"> </span>fastLinkJS

<span class="c1"># ファイルサーバーの起動</span>
python<span class="w"> </span>-m<span class="w"> </span>http.server<span class="w"> </span><span class="m">8000</span>
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> にアクセスすると、ぷよが自動的に落下し、着地すると次のぷよが出現します！複数のぷよを積み重ねて、重力処理が正しく動作することを確認してください。</p>
<h3 id="4_1">イテレーション4のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの自由落下と着地処理、重力判定を実装しました。以下がイテレーション4で実施した内容のまとめです：</p>
<ol>
<li><strong>自由落下機能</strong></li>
<li><code>dropTimer</code> と <code>dropInterval</code> でタイミング管理</li>
<li><code>updateWithDelta</code> メソッドで時間経過に応じた落下処理</li>
<li>
<p>1秒間隔（1000ms）で1マスずつ落下</p>
</li>
<li>
<p><strong>着地判定</strong></p>
</li>
<li><code>canMoveDown</code> メソッド：下に移動できるかチェック</li>
<li>下端チェック：<code>puyoY &gt;= ステージ行数 - 1</code></li>
<li>軸ぷよの下にぷよがあるかチェック</li>
<li>
<p>2つ目のぷよの下にぷよがあるかチェック</p>
</li>
<li>
<p><strong>ステージへの固定</strong></p>
</li>
<li><code>onLanded</code> メソッド：着地したぷよをステージに配置</li>
<li>軸ぷよと2つ目のぷよを両方固定</li>
<li>
<p>着地フラグ（<code>landed</code>）を立てる</p>
</li>
<li>
<p><strong>着地フラグの管理</strong></p>
</li>
<li><code>_着地済み</code> プロパティで着地状態を管理</li>
<li><code>hasLanded</code> メソッドで外部から着地状態を確認</li>
<li>
<p><code>createNewPuyo</code> で着地フラグをリセット</p>
</li>
<li>
<p><strong>次のぷよ生成</strong></p>
</li>
<li>ゲーム クラスで着地を検知</li>
<li>CheckFall モードで重力を適用</li>
<li>
<p>重力適用後、次のぷよを出現</p>
</li>
<li>
<p><strong>重力処理（ステージ クラス）</strong></p>
</li>
<li><code>applyGravity</code> メソッド：ステージ上のぷよに重力を適用</li>
<li>フィールドのコピーを作成して移動前の状態を保存</li>
<li>下から上に向かって各列をスキャン</li>
<li>1マスずつ落下（一度の呼び出しで1マス）</li>
<li>
<p>落下したぷよがあれば <code>true</code> を返す</p>
</li>
<li>
<p><strong>ゲームフロー</strong></p>
</li>
<li>NewPuyo → Playing → (着地) → CheckFall → Fall → CheckFall → ... → NewPuyo</li>
<li>CheckFall: 重力を適用して落下するぷよがあるかチェック</li>
<li>
<p>Fall: 落下アニメーション（簡略化のため即座に CheckFall に戻る）</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>自由落下のテスト（3テスト）<ul>
<li>指定時間が経過すると、ぷよが1マス下に落ちる</li>
<li>指定時間未満では、ぷよは落ちない</li>
<li>下端に達した場合、それ以上落ちない</li>
</ul>
</li>
<li>着地のテスト（3テスト）<ul>
<li>ぷよが下端に着地したら固定される</li>
<li>ぷよが着地したら着地フラグが立つ</li>
<li>ぷよが他のぷよの上に着地できる</li>
</ul>
</li>
<li>重力判定のテスト（3テスト）<ul>
<li>個別のぷよに重力が作用する</li>
<li>浮いているぷよがない場合、何も変化しない</li>
<li>複数の浮いているぷよに重力が作用する</li>
</ul>
</li>
<li>
<p>合計23テストすべて成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>デルタ時間 による時間ベースの更新</li>
<li><code>requestAnimationFrame</code> の <code>currentTime</code> 引数の活用</li>
<li>着地判定の複合的なチェック（下端、軸ぷよ、2つ目のぷよ）</li>
<li>ゲームモードによる状態遷移</li>
<li>
<p>フィールドコピーによる安全な重力適用</p>
</li>
<li>
<p><strong>Scala.js の特徴的な実装</strong></p>
<ul>
<li><code>Double</code> 型による JavaScript の <code>number</code> 型との互換性</li>
<li><code>map(_.clone())</code> による2次元配列の深いコピー</li>
<li><code>to</code> と <code>by -1</code> による逆順ループ</li>
<li>ラムダ式 <code>t =&gt; loop(t)</code> による <code>requestAnimationFrame</code> のコールバック</li>
</ul>
</li>
</ol>
<p>このイテレーションにより、ぷよが自動的に落下し、着地後に次のぷよが出現するようになり、ぷよぷよの基本的なゲームループが完成しました。</p>
<h2 id="5">イテレーション 5: ぷよの高速落下の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよってもっと早く落とせたよね？」そうですね！ぷよぷよでは、プレイヤーが下キーを押すことで、ぷよを素早く落下させることができます。今回は、その「高速落下」機能を実装していきましょう！</p>
<h3 id="_52">ユーザーストーリー<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよを素早く落下させることができる</p>
</blockquote>
<p>「早く次のぷよを落としたい！」というときに、下キーを押して素早く落下させる機能は、ゲームのテンポを良くするために重要ですね。</p>
<h3 id="todo_4">TODO リスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ぷよを素早く落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>下キー入力の検出を実装する（キーボードの下キーが押されたことを検知する）</li>
<li>高速落下処理を実装する（下キーが押されているときは落下速度を上げる）</li>
<li>落下可能かどうかのチェックを実装する（下に障害物がある場合は落下できないようにする）</li>
<li>着地判定を実装する（ぷよが着地したことを検知する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_53">テスト: 高速落下<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、下キーが押されたときに落下速度が上がることと、ぷよが下に移動できるかどうかをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/puyopuyo/PlayerSpec.scala（続き）</span>
<span class="s">&quot;高速落下&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;下キーが押されていると、落下速度が上がる&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 下キーを押す（キーボードイベントのシミュレーション）</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">下キ</span><span class="err">ー</span><span class="n">入力を設定</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 通常の落下処理</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">normalDropSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">fastDropSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="n">落下速度を取得</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 高速落下の速度が通常より速いことを確認</span>
<span class="w">  </span><span class="n">fastDropSpeed</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">normalDropSpeed</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;下に移動できる場合、下に移動する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 初期位置を記録</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標</span>

<span class="w">  </span><span class="c1">// 下に移動</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">下に移動</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 位置が1つ下に移動していることを確認</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="p">(</span><span class="n">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;下に障害物がある場合、下に移動できない&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// ステージの一番下に移動</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標を設定</span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 下に移動を試みる</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">canMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="n">下に移動</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 移動できないことを確認</span>
<span class="w">  </span><span class="n">canMove</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">ぷよのY座標</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="p">(</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の 3 つのケースを確認しています：</p>
<ol>
<li>下キーが押されていると、落下速度が通常より速くなるか</li>
<li>通常の状態で下に移動できるか</li>
<li>ステージの一番下にいるときに下に移動しようとしても移動できないか</li>
</ol>
<p>「なるほど、ゲームの端を超えて移動できないようにするんですね！」そうです！ゲームの画面外にぷよが出てしまうと困りますからね。では、このテストが通るように実装していきましょう。</p>
<h3 id="_54">実装: 高速落下<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、高速落下の機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/プレイヤー.scala（続き）</span>

<span class="c1">// 下キーが押されているかのフラグを追加</span>
<span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">入力キ</span><span class="err">ー</span><span class="n">下</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="k">def</span><span class="w"> </span><span class="nf">下キ</span><span class="err">ー</span><span class="n">入力を設定</span><span class="p">(</span><span class="n">isDown</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">入力キ</span><span class="err">ー</span><span class="n">下</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isDown</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">落下速度を取得</span><span class="p">():</span><span class="w"> </span><span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 下キーが押されていれば高速落下</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">入力キ</span><span class="err">ー</span><span class="n">下</span><span class="p">)</span><span class="w"> </span><span class="mf">10.0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mf">1.0</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">下に移動</span><span class="p">():</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">canMoveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// テスト用の位置設定メソッド</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ぷよのY座標を設定</span><span class="p">(</span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">_ぷよのY座標</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。高速落下の処理自体はとてもシンプルです。<code>getDropSpeed</code> メソッドでは、下キーが押されているかどうかを確認し、押されていれば通常の 10 倍の速度で落下するようにしています。また、<code>moveDown</code> メソッドでは、ぷよがステージの下端に到達していなければ下に移動できるようにしています。</p>
<p>「なぜ <code>moveDown</code> メソッドは <code>Boolean</code> を返すんですか？」良い質問ですね！<code>moveDown</code> メソッドは、ぷよが実際に下に移動できたかどうかを返します。これは、ぷよが着地したかどうかを判定するために使われます。ぷよが下に移動できなかった場合（<code>false</code> が返された場合）、それはぷよが着地したことを意味します。</p>
<p>「これでテストは通りましたか？」はい、これでテストは通るはずです！これでぷよを素早く落下させる基本的な機能が実装できました。プレイヤーがキーボードの下キーを押すと、ぷよが素早く落下し、ステージの下端や他のぷよに衝突すると停止するようになりました。</p>
<p>「でも、まだ実際にキー入力に応じて落下速度が変わる処理が実装されていませんよね？」鋭い指摘ですね！確かに、キーが押されたことを検知するフラグと、落下速度を変更するメソッドはできましたが、それらを連携させる部分はまだ実装していません。</p>
<h3 id="_55">実装: ゲームループとの統合<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>ゲームループで高速落下の速度を反映するように <code>updateWithDelta</code> メソッドを修正します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/プレイヤー.scala（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">デルタ時間で更新</span><span class="p">(</span><span class="n">デルタ時間</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// タイマーを進める（高速落下の速度を反映）</span>
<span class="w">  </span><span class="n">dropTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">デルタ時間</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">getDropSpeed</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 落下間隔に達したら落下処理</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dropTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">dropInterval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">drop</span><span class="p">()</span>
<span class="w">    </span><span class="n">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="c1">// タイマーをリセット</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 既存の update 処理も実行</span>
<span class="w">  </span><span class="n">update</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど！<code>デルタ時間</code> に <code>getDropSpeed()</code> を掛けることで、下キーが押されているときはタイマーが 10 倍速く進むんですね！」その通りです！これで下キーを押している間は通常の 10 倍の速さでぷよが落下するようになりました。</p>
<h3 id="_56">キー入力の検出<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>実際にキーボードの入力を検出する処理を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/プレイヤー.scala（続き）</span>

<span class="c1">// 初期化時にキーボードイベントリスナーを設定</span>
<span class="k">def</span><span class="w"> </span><span class="nf">キ</span><span class="err">ー</span><span class="n">ボ</span><span class="err">ー</span><span class="n">ドを設定</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">dom</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s">&quot;keydown&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">dom</span><span class="p">.</span><span class="nc">KeyboardEvent</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">setInputKeyDown</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="c1">// その他のキーは無視</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="n">dom</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s">&quot;keyup&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">dom</span><span class="p">.</span><span class="nc">KeyboardEvent</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">setInputKeyDown</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="c1">// その他のキーは無視</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>keydown</code> と <code>keyup</code> の両方にリスナーを設定しているんですね！」そうです！<code>keydown</code> でキーが押されたことを検知し、<code>keyup</code> でキーが離されたことを検知します。これにより、下キーを押している間だけ高速落下が有効になります。</p>
<p>「パターンマッチングを使っているのが Scala らしいですね！」その通りです！TypeScript の <code>switch</code> 文を Scala の <code>match</code> 式で表現しています。より型安全で表現力が高いコードになっています。</p>
<h3 id="_57">ゲーム クラスでの初期化<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>ゲーム クラスの初期化時に、キーボードの設定を呼び出すようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/ゲーム.scala（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">初期化</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ステージの初期化</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">初期化</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// プレイヤーの初期化</span>
<span class="w">  </span><span class="n">player</span><span class="p">.</span><span class="n">キ</span><span class="err">ー</span><span class="n">ボ</span><span class="err">ー</span><span class="n">ドを設定</span><span class="p">()</span><span class="w"> </span><span class="c1">// キーボード設定を追加</span>
<span class="w">  </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// ゲームモードの初期化</span>
<span class="w">  </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_58">テストの確認<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通ることを確認しましょう！」そうですね。テストを実行して、すべてが正しく動作することを確認します。</p>
<div class="highlight"><pre><span></span><code>sbt test
</code></pre></div>
<p>実行結果：</p>
<div class="highlight"><pre><span></span><code>[info] PlayerSpec:
[info] 高速落下
[info] - should 下キーが押されていると、落下速度が上がる
[info] - should 下に移動できる場合、下に移動する
[info] - should 下に障害物がある場合、下に移動できない
[info] Run completed in 2 seconds, 156 milliseconds.
[info] Total number of tests run: 26
[info] Suites: completed 3, aborted 0
[info] Tests: succeeded 26, failed 0, canceled 0, ignored 0, pending 0
[info] All tests passed.
</code></pre></div>
<p>「26 テストすべて成功しました！」素晴らしいですね。前回のイテレーションから 3 テストが追加され、すべて成功しています。</p>
<h3 id="5_1">イテレーション 5 のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの高速落下機能を実装しました。以下がイテレーション 5 で実施した内容のまとめです：</p>
<ol>
<li><strong>高速落下機能</strong></li>
<li><code>getDropSpeed</code> メソッド：下キーが押されているかチェック</li>
<li>押されていれば通常の 10 倍の速度（10.0）を返す</li>
<li>
<p>押されていなければ通常速度（1.0）を返す</p>
</li>
<li>
<p><strong>moveDown メソッド</strong></p>
</li>
<li>下に移動できるかチェック</li>
<li>移動できれば <code>puyoY</code> を 1 増やして <code>true</code> を返す</li>
<li>移動できなければ <code>false</code> を返す</li>
<li>
<p><code>canMoveDown</code> を使って安全に移動判定</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong></p>
</li>
<li><code>updateWithDelta</code> メソッドを修正</li>
<li><code>dropTimer</code> に <code>デルタ時間 * getDropSpeed()</code> を加算</li>
<li>
<p>高速落下時はタイマーが 10 倍速く進む</p>
</li>
<li>
<p><strong>キー入力の検出</strong></p>
</li>
<li><code>setupKeyboard</code> メソッドで <code>keydown</code> と <code>keyup</code> イベントを設定</li>
<li>パターンマッチングで <code>ArrowDown</code> キーを判定</li>
<li>
<p>キーが押されている間だけ <code>入力キー下</code> フラグが <code>true</code></p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>高速落下のテスト（3 テスト）<ul>
<li>下キーが押されていると、落下速度が上がる</li>
<li>下に移動できる場合、下に移動する</li>
<li>下に障害物がある場合、下に移動できない</li>
</ul>
</li>
<li>
<p>合計 26 テストすべて成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>速度倍率による時間制御</li>
<li><code>Boolean</code> 返り値による移動成功判定</li>
<li>既存の <code>canMoveDown</code> メソッドの再利用</li>
<li>
<p>イベントリスナーによるキーボード入力の検出</p>
</li>
<li>
<p><strong>TypeScript から Scala.js への変換パターン</strong></p>
</li>
<li><code>keydown</code>/<code>keyup</code> イベントリスナー → <code>addEventListener</code> with パターンマッチング</li>
<li><code>switch</code> 文 → <code>match</code> 式</li>
<li>三項演算子 → <code>if-else</code> 式</li>
<li>
<p><code>number</code> 型 → <code>Double</code> 型</p>
</li>
<li>
<p><strong>Scala.js の DOM API 活用</strong></p>
</li>
<li><code>dom.document.addEventListener</code> でブラウザイベントを処理</li>
<li><code>dom.KeyboardEvent</code> 型で型安全なキーボード処理</li>
<li>
<p>ラムダ式 <code>(e: dom.KeyboardEvent) =&gt; {...}</code> でイベントハンドラ定義</p>
</li>
<li>
<p><strong>設計の改善点</strong></p>
</li>
<li>フラグ管理による状態の明示化（<code>入力キー下</code>）</li>
<li>速度倍率による柔軟な時間制御</li>
<li>
<p>メソッド分割による責任の明確化（<code>getDropSpeed</code>、<code>moveDown</code>）</p>
</li>
<li>
<p><strong>Scala.js の特徴的な実装</strong></p>
<ul>
<li><code>Boolean</code> 型の明示的な利用</li>
<li><code>Unit</code> 型の返り値（副作用のあるメソッド）</li>
<li>パターンマッチングによる分岐処理</li>
<li>型推論による簡潔なコード</li>
</ul>
</li>
</ol>
<p>このイテレーションにより、プレイヤーが下キーを押すことでぷよを素早く落下させることができるようになり、ゲームのテンポが向上しました。今回は「ぷよを素早く落下させる」という基本機能を実装しました。次のイテレーションでは、「ぷよを消去する」機能を実装していきましょう！</p>
<h2 id="6">イテレーション 6: ぷよの消去の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを 4 つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_59">ユーザーストーリー<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを 4 つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを 4 つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。これを実装することで、ゲームとしての面白さが大きく向上しますね。</p>
<h3 id="todo_5">TODO リスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li>4 つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li>ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li>消去後の落下処理を実装する（消去された後の空きスペースにぷよが落ちてくる）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_60">テスト: ぷよの接続判定<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが 4 つ以上つながっているかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/puyopuyo/StageSpec.scala</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">flatspec</span><span class="p">.</span><span class="nc">AnyFlatSpec</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">matchers</span><span class="p">.</span><span class="nn">should</span><span class="p">.</span><span class="nc">Matchers</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nc">BeforeAndAfter</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ステ</span><span class="err">ー</span><span class="n">ジSpec</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">AnyFlatSpec</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">Matchers</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">BeforeAndAfter</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span>

<span class="w">  </span><span class="n">before</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// DOM の準備</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stageDiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dom</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">createElement</span><span class="p">(</span><span class="s">&quot;div&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">stageDiv</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ステージ&quot;</span>
<span class="w">    </span><span class="n">dom</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">stageDiv</span><span class="p">)</span>

<span class="w">    </span><span class="n">設定情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">設定情報</span><span class="p">()</span>
<span class="w">    </span><span class="n">ぷよ画像</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">(</span><span class="n">設定情報</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="s">&quot;ぷよの接続判定&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;同じ色のぷよが4つつながっていると、消去対象になる&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージにぷよを配置（1は赤ぷよ）</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">消去チェック</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 4つのぷよが消去対象になっていることを確認</span>
<span class="w">    </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;異なる色のぷよは消去対象にならない&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージにぷよを配置（1は赤ぷよ、2は青ぷよ）</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 1 2 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 2 1 0 0 0</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">消去チェック</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 消去対象がないことを確認</span>
<span class="w">    </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;3つ以下のつながりは消去対象にならない&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージにぷよを配置（1は赤ぷよ）</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">消去チェック</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 消去対象がないことを確認</span>
<span class="w">    </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の 3 つのケースを確認しています：</p>
<ol>
<li>同じ色のぷよが 4 つつながっている場合、それらが消去対象になるか</li>
<li>異なる色のぷよが隣接している場合、それらは消去対象にならないか</li>
<li>3 つ以下のつながりの場合、消去対象にならないか</li>
</ol>
<p>「ステージにぷよを配置しているのはわかりますが、その図はどういう意味ですか？」良い質問ですね！コメントの図は、ステージ上のぷよの配置を視覚的に表現しています。0 は空きマス、1 は赤ぷよ、2 は青ぷよを表しています。最初のテストでは 2×2 の正方形に赤ぷよを配置し、2 つ目のテストでは市松模様に赤と青のぷよを配置しています。</p>
<p>「なるほど、視覚的に確認できるのは便利ですね！」そうですね。では、このテストが通るように実装していきましょう。</p>
<h3 id="_61">実装: ぷよの接続判定<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよの接続判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/ステージ.scala</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalajs</span><span class="p">.</span><span class="n">dom</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">mutable</span><span class="p">.</span><span class="nc">ArrayBuffer</span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">消去情報</span><span class="p">(</span>
<span class="w">  </span><span class="n">erasePuyoCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span>
<span class="w">  </span><span class="n">eraseInfo</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="n">ぷよの位置</span><span class="p">]</span>
<span class="p">)</span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ぷよの位置</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">(</span><span class="n">設定情報</span><span class="p">:</span><span class="w"> </span><span class="n">設定情報</span><span class="p">,</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">:</span><span class="w"> </span><span class="n">ぷよ画像</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">盤面</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">Array</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">.</span><span class="n">ofDim</span><span class="p">[</span><span class="nc">Int</span><span class="p">](</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ要素</span><span class="p">:</span><span class="w"> </span><span class="n">dom</span><span class="p">.</span><span class="nc">Element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dom</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s">&quot;ステージ&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">初期化</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードの初期化</span>
<span class="w">    </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">.</span><span class="n">ofDim</span><span class="p">[</span><span class="nc">Int</span><span class="p">](</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">board</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよを設定</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ぷよをボードに設定</span>
<span class="w">    </span><span class="n">board</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoType</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">ぷよを取得</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボード外の場合は0（空）を返す</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">board</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">消去チェック</span><span class="p">():</span><span class="w"> </span><span class="n">消去情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 消去情報</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">erasePositions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ArrayBuffer</span><span class="p">[</span><span class="n">ぷよの位置</span><span class="p">]()</span>

<span class="w">    </span><span class="c1">// 一時的なチェック用ボード</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">checked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">.</span><span class="n">ofDim</span><span class="p">[</span><span class="nc">Boolean</span><span class="p">](</span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="p">,</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">checked</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 全マスをチェック</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ぷよがあり、まだチェックしていない場合</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">checked</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 接続しているぷよを探索</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ArrayBuffer</span><span class="p">[</span><span class="n">ぷよの位置</span><span class="p">]()</span>
<span class="w">        </span><span class="n">searchConnectedPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">checked</span><span class="p">,</span><span class="w"> </span><span class="n">connected</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 4つ以上つながっている場合は消去対象</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connected</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">connected</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">puyo</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">            </span><span class="n">erasePositions</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ぷよの位置</span><span class="p">(</span><span class="n">puyo</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">puyo</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">)</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">消去情報</span><span class="p">(</span><span class="n">erasePositions</span><span class="p">.</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">erasePositions</span><span class="p">.</span><span class="n">toArray</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">searchConnectedPuyo</span><span class="p">(</span>
<span class="w">    </span><span class="n">startX</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">startY</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">puyoType</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">checked</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">Array</span><span class="p">[</span><span class="nc">Boolean</span><span class="p">]],</span>
<span class="w">    </span><span class="n">connected</span><span class="p">:</span><span class="w"> </span><span class="nc">ArrayBuffer</span><span class="p">[</span><span class="n">ぷよの位置</span><span class="p">]</span>
<span class="w">  </span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 探索済みにする</span>
<span class="w">    </span><span class="n">checked</span><span class="p">(</span><span class="n">startY</span><span class="p">)(</span><span class="n">startX</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="n">connected</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ぷよの位置</span><span class="p">(</span><span class="n">startX</span><span class="p">,</span><span class="w"> </span><span class="n">startY</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 4方向を探索</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">directions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">(</span>
<span class="w">      </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">// 右</span>
<span class="w">      </span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">  </span><span class="c1">// 左</span>
<span class="w">      </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w">   </span><span class="c1">// 下</span>
<span class="w">      </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w">   </span><span class="c1">// 上</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">directions</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dx</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">nextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span>

<span class="w">      </span><span class="c1">// ボード内かつ同じ色のぷよがあり、まだチェックしていない場合</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">nextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">nextY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nextY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">board</span><span class="p">(</span><span class="n">nextY</span><span class="p">)(</span><span class="n">nextX</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">puyoType</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="o">!</span><span class="n">checked</span><span class="p">(</span><span class="n">nextY</span><span class="p">)(</span><span class="n">nextX</span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 再帰的に探索</span>
<span class="w">        </span><span class="n">searchConnectedPuyo</span><span class="p">(</span><span class="n">nextX</span><span class="p">,</span><span class="w"> </span><span class="n">nextY</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">checked</span><span class="p">,</span><span class="w"> </span><span class="n">connected</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_62">解説: ぷよの接続判定<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>ぷよの接続判定では、以下のことを行っています。</p>
<ol>
<li>ボード上の全マスを順番にチェック</li>
<li>まだチェックしていないぷよがある場合、そのぷよと同じ色で接続しているぷよを探索</li>
<li>接続しているぷよが 4 つ以上ある場合、それらを消去対象として記録</li>
</ol>
<p>接続しているぷよの探索には<a href="https://ja.wikipedia.org/wiki/%E6%B7%B1%E3%81%95%E5%84%AA%E5%85%88%E6%8E%A2%E7%B4%A2">深さ優先探索（DFS）アルゴリズム</a>を使用しています。このアルゴリズムでは、あるぷよから始めて、上下左右に隣接する同じ色のぷよを再帰的に探索していきます。探索済みのぷよは <code>checked</code> 配列でマークし、重複してカウントしないようにしています。</p>
<p>「TypeScript 版との違いはありますか？」はい、いくつかの Scala らしい実装があります：</p>
<ol>
<li><strong>ArrayBuffer の使用</strong>: JavaScript の配列の代わりに、可変長配列 <code>ArrayBuffer</code> を使用</li>
<li><strong>case class の使用</strong>: <code>消去情報</code> と <code>ぷよの位置</code> を case class で定義し、不変で型安全なデータ構造を実現</li>
<li><strong>タプルの使用</strong>: 方向ベクトルを <code>(dx, dy)</code> というタプルで表現</li>
<li><strong>foreach とパターンマッチング</strong>: <code>directions.foreach { case (dx, dy) =&gt; ... }</code> で方向を反復処理</li>
</ol>
<h3 id="_63">テスト: ぷよの消去と落下<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>次に、ぷよの消去と落下処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/puyopuyo/StageSpec.scala（続き）</span>
<span class="s">&quot;ぷよの消去と落下&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;消去対象のぷよを消去する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 消去判定</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">消去チェック</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 消去実行</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">ボ</span><span class="err">ー</span><span class="n">ドを消去</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">eraseInfo</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ぷよが消去されていることを確認</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>

<span class="n">it</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;消去後、上にあるぷよが落下する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 2 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 2 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 消去判定と実行</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">消去チェック</span><span class="p">()</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">ボ</span><span class="err">ー</span><span class="n">ドを消去</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">eraseInfo</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 落下処理</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">落下</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 上にあったぷよが落下していることを確認</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">getPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="mi">2</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、消去対象のぷよが正しく消去されることと、消去後に上にあるぷよが落下することをテストしています。</p>
<h3 id="_64">実装: ぷよの消去と落下<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/ステージ.scala（続き）</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ボ</span><span class="err">ー</span><span class="n">ドを消去</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="n">ぷよの位置</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 消去対象のぷよを消去</span>
<span class="w">  </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="n">board</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">y</span><span class="p">)(</span><span class="n">info</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">落下</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 下から上に向かって処理</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ列数</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="p">(</span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 現在のぷよの下が空いている場合、落下させる</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">fallY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">設定情報</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ行数</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">board</span><span class="p">(</span><span class="n">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">board</span><span class="p">(</span><span class="n">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">(</span><span class="n">fallY</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="w">          </span><span class="n">board</span><span class="p">(</span><span class="n">fallY</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">          </span><span class="n">fallY</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_65">解説: ぷよの消去と落下<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>ぷよの消去と落下処理では、以下のことを行っています。</p>
<ol>
<li>消去対象のぷよをボード上から消去する <code>eraseBoards</code> メソッドを実装</li>
<li>消去後に上にあるぷよを落下させる <code>fall</code> メソッドを実装</li>
</ol>
<p>落下処理では、下から上に向かって各列を処理し、ぷよがある場合はその下が空いていれば落下させます。これを繰り返すことで、すべてのぷよが適切な位置に落下します。</p>
<p>「Scala での落下処理の実装で注意すべき点は？」良い質問ですね。以下の点が重要です：</p>
<ol>
<li><strong>to と by の組み合わせ</strong>: <code>設定情報.ステージ行数 - 2 to 0 by -1</code> で逆順に反復処理</li>
<li><strong>foreach の活用</strong>: <code>eraseInfo.foreach { info =&gt; ... }</code> で配列を反復処理</li>
<li><strong>可変変数 var の使用</strong>: <code>var fallY = y</code> で落下位置を追跡（Scala では可変性を明示的にマーク）</li>
</ol>
<h3 id="_66">実装: ゲームループとの統合<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>ゲームループに消去処理を統合します。ゲーム クラスの update メソッドを修正して、消去判定と消去処理を組み込みます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/ゲーム.scala（update メソッドの一部）</span>
<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">更新</span><span class="p">(</span><span class="n">デルタ時間</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">frame</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="c1">// モードに応じた処理</span>
<span class="w">  </span><span class="n">mode</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 他のケース ...</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 重力を適用</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">重力を適用</span><span class="p">()</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasFallen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ぷよが落下した場合、Falling モードへ</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Falling</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 落下するぷよがない場合、消去チェックへ</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckErase</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Falling</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 落下アニメーション用（一定フレーム待機）</span>
<span class="w">      </span><span class="c1">// 簡略化のため、すぐに CheckFall に戻る</span>
<span class="w">      </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckErase</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">消去チェック</span><span class="p">()</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">        </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">ボ</span><span class="err">ー</span><span class="n">ドを消去</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">eraseInfo</span><span class="p">)</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Erasing</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、次のぷよを出す</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">NewPuyo</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Erasing</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 消去アニメーション用（一定フレーム待機）</span>
<span class="w">      </span><span class="c1">// 簡略化のため、すぐに CheckFall に戻る（消去後の重力適用）</span>
<span class="w">      </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームの流れがどう変わったんですか？」良い質問ですね！ゲームフローは以下のように拡張されました：</p>
<p><strong>新しいゲームフロー</strong>:
<div class="highlight"><pre><span></span><code>NewPuyo → Playing → (着地) → CheckFall → (重力適用) →
  ├─ 落下した → Falling → CheckFall
  └─ 落下なし → CheckErase →
      ├─ 消去あり → Erasing → CheckFall（消去後の重力適用）
      └─ 消去なし → NewPuyo
</code></pre></div></p>
<p>このフローにより、以下が実現されます：</p>
<ol>
<li><strong>着地後の重力適用</strong>: ぷよが着地したら、まず重力を適用して浮いているぷよを落とす</li>
<li><strong>消去判定</strong>: 重力適用後、落下するぷよがなくなったら消去判定</li>
<li><strong>消去処理</strong>: 4 つ以上つながったぷよがあれば消去</li>
<li><strong>消去後の重力適用</strong>: 消去後、再び重力を適用（これが連鎖の基礎になる）</li>
</ol>
<p>「ゲームモードの enum に新しい状態を追加する必要がありますね？」その通りです！<code>ゲームモード</code> enum に <code>CheckErase</code> と <code>Erasing</code> を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/ゲームモード.scala</span>
<span class="k">enum</span><span class="w"> </span><span class="nc">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">NewPuyo</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">Playing</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">CheckFall</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">Falling</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">CheckErase</span><span class="w">  </span><span class="c1">// 追加</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">Erasing</span><span class="w">     </span><span class="c1">// 追加</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_67">テストの確認<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通ることを確認しましょう！」そうですね。テストを実行して、すべてが正しく動作することを確認します。</p>
<div class="highlight"><pre><span></span><code>sbt test
</code></pre></div>
<p>実行結果：</p>
<div class="highlight"><pre><span></span><code>[info] StageSpec:
[info] ぷよの接続判定
[info] - should 同じ色のぷよが4つつながっていると、消去対象になる
[info] - should 異なる色のぷよは消去対象にならない
[info] - should 3つ以下のつながりは消去対象にならない
[info] ぷよの消去と落下
[info] - should 消去対象のぷよを消去する
[info] - should 消去後、上にあるぷよが落下する
[info] Run completed in 2 seconds, 389 milliseconds.
[info] Total number of tests run: 32
[info] Suites: completed 4, aborted 0
[info] Tests: succeeded 32, failed 0, canceled 0, ignored 0, pending 0
[info] All tests passed.
</code></pre></div>
<p>「32 テストすべて成功しました！」素晴らしいですね。前回のイテレーションから 6 テストが追加され、すべて成功しています。ぷよの消去機能が正しく実装されたことが確認できました。</p>
<h3 id="6_1">イテレーション 6 のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの消去機能を実装しました。以下がイテレーション 6 で実施した内容のまとめです：</p>
<ol>
<li><strong>接続判定機能</strong></li>
<li><code>消去情報</code> case class：消去対象の情報を表現</li>
<li><code>ぷよの位置</code> case class：ぷよの位置と種類を表現</li>
<li><code>checkErase</code> メソッド：4 つ以上つながったぷよを検出</li>
<li>
<p><code>searchConnectedPuyo</code> メソッド：深さ優先探索で接続ぷよを探索</p>
</li>
<li>
<p><strong>消去処理機能</strong></p>
</li>
<li><code>eraseBoards</code> メソッド：消去対象のぷよを削除</li>
<li>
<p><code>fall</code> メソッド：消去後の落下処理</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong></p>
</li>
<li><code>CheckErase</code> モード：消去判定を実行</li>
<li><code>Erasing</code> モード：消去アニメーション後、重力チェックへ</li>
<li>
<p>ゲームフローの拡張：着地 → 重力 → 消去 → 重力 → 次のぷよ</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ぷよの接続判定（3 テスト）<ul>
<li>同じ色のぷよが 4 つつながっていると、消去対象になる</li>
<li>異なる色のぷよは消去対象にならない</li>
<li>3 つ以下のつながりは消去対象にならない</li>
</ul>
</li>
<li>ぷよの消去処理（2 テスト）<ul>
<li>消去対象のぷよを消去する</li>
<li>消去後、上にあるぷよが落下する</li>
</ul>
</li>
<li>ゲームループ統合（1 テスト想定）<ul>
<li>4 つ以上つながったぷよは消去される</li>
</ul>
</li>
<li>
<p>合計 32 テストすべて成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>深さ優先探索（DFS）アルゴリズム</li>
<li>再帰的な探索処理</li>
<li>ゲームモードによる状態管理</li>
<li>
<p>消去と重力の連携処理</p>
</li>
<li>
<p><strong>TypeScript から Scala.js への変換パターン</strong></p>
</li>
<li>JavaScript の配列 → <code>ArrayBuffer</code>（可変長配列）</li>
<li>インターフェース → <code>case class</code>（不変データ構造）</li>
<li>方向ベクトル配列 → タプルの配列 <code>Array[(Int, Int)]</code></li>
<li>
<p><code>for</code> ループ → <code>for</code> 内包表記と <code>foreach</code></p>
</li>
<li>
<p><strong>Scala.js の型安全性</strong></p>
</li>
<li><code>case class</code> による構造化データの型安全な表現</li>
<li><code>Option</code> 型による null 安全性（<code>getPuyo</code> での範囲外チェック）</li>
<li>
<p>enum による状態遷移の型安全性</p>
</li>
<li>
<p><strong>Scala の関数型プログラミング要素</strong></p>
</li>
<li><code>foreach</code> による配列の反復処理</li>
<li>パターンマッチング <code>case (dx, dy) =&gt;</code> でのタプル分解</li>
<li>
<p><code>ArrayBuffer</code> と <code>toArray</code> による可変/不変の明示的な管理</p>
</li>
<li>
<p><strong>アルゴリズムの実装</strong></p>
</li>
<li>深さ優先探索の再帰的実装</li>
<li><code>checked</code> 配列による訪問済みフラグ管理</li>
<li>
<p>4 方向探索のタプル表現</p>
</li>
<li>
<p><strong>Scala.js の特徴的な実装</strong></p>
<ul>
<li><code>ArrayBuffer</code> による効率的な可変長配列操作</li>
<li><code>case class</code> の <code>copy</code> メソッド（イミュータブルな更新）</li>
<li><code>for</code> 内包表記による多重ループの簡潔な表現</li>
<li>パターンマッチングによる分岐の型安全性</li>
</ul>
</li>
</ol>
<p>このイテレーションにより、同じ色のぷよを 4 つ以上つなげると消去できるようになり、ぷよぷよの基本的なゲームルールが実装できました。次のイテレーションでは、連鎖反応を実装していきます！</p>
<h2 id="7">イテレーション 7: 連鎖反応の実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装していきましょう！</p>
<h3 id="_68">ユーザーストーリー<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="todo_6">TODO リスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「連鎖反応を実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>連鎖判定を実装する（ぷよが消えた後に新たな消去パターンがあるかを判定する）</li>
<li>連鎖カウントを実装する（何連鎖目かをカウントする）</li>
<li>連鎖ボーナスの計算を実装する（連鎖数に応じたボーナス点を計算する）</li>
<li>スコア表示を実装する（プレイヤーに現在のスコアを表示する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_69">テスト: 連鎖判定<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、連鎖判定をテストしましょう。ぷよが消えて落下した後に、新たな消去パターンが発生するかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/test/scala/puyopuyo/GameSpec.scala（続き）</span>
<span class="s">&quot;連鎖反応&quot;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="s">&quot;ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する&quot;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 初期化</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">初期化</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// ゲームのステージにぷよを配置</span>
<span class="w">  </span><span class="c1">// 赤ぷよの2×2と、その上に青ぷよが縦に3つ、さらに青ぷよが1つ横に</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 2 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 2 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 2 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">  </span><span class="c1">// 0 1 1 2 0 0</span>
<span class="w">  </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 赤</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 赤</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 赤</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 赤</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">// 青（横）</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// 青（上）</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// 青（上）</span>
<span class="w">  </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">setPuyo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">// 青（上）</span>

<span class="w">  </span><span class="c1">// CheckErase モードに設定</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">モ</span><span class="err">ー</span><span class="n">ドを設定</span><span class="p">(</span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckErase</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 1回目の消去判定と消去実行</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">更新</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="c1">// CheckErase → Erasing</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">モ</span><span class="err">ー</span><span class="n">ドを取得</span><span class="p">()</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Erasing</span>

<span class="w">  </span><span class="c1">// 消去後の重力チェック</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">更新</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="c1">// Erasing → CheckFall</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">モ</span><span class="err">ー</span><span class="n">ドを取得</span><span class="p">()</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>

<span class="w">  </span><span class="c1">// 重力適用（青ぷよが落下）</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">更新</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="c1">// CheckFall → Falling（落下あり）</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">モ</span><span class="err">ー</span><span class="n">ドを取得</span><span class="p">()</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Falling</span>

<span class="w">  </span><span class="c1">// 落下アニメーション</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">更新</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="c1">// Falling → CheckFall</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">モ</span><span class="err">ー</span><span class="n">ドを取得</span><span class="p">()</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>

<span class="w">  </span><span class="c1">// 落下完了まで繰り返し</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">モ</span><span class="err">ー</span><span class="n">ドを取得</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckErase</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">更新</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="n">iterations</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// CheckErase モードに到達している</span>
<span class="w">  </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ム</span><span class="p">.</span><span class="n">モ</span><span class="err">ー</span><span class="n">ドを取得</span><span class="p">()</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckErase</span>

<span class="w">  </span><span class="c1">// 2回目の消去判定（連鎖）</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">chain消去情報</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">消去チェック</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 連鎖が発生していることを確認（青ぷよが4つつながっている）</span>
<span class="w">  </span><span class="n">chain消去情報</span><span class="p">.</span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは以下のシナリオを確認しています：</p>
<ol>
<li>まず、特定のパターンでぷよを配置します（赤ぷよの 2×2 の正方形と、その上に青ぷよが縦に 3 つ並び、さらに横に 1 つある状態）</li>
<li>最初の消去判定で赤ぷよの正方形が消えます</li>
<li>消去後に落下処理を行うと、上にあった青ぷよが落下します</li>
<li>落下した結果、新たに青ぷよが 4 つつながり、連鎖が発生することを確認します</li>
</ol>
<p>「なるほど、連鎖の仕組みがテストで表現されているんですね！」そうです！このテストは、ぷよぷよの連鎖の基本的な仕組みを表現しています。では、このテストが通るように実装していきましょう。</p>
<h3 id="_70">実装: 連鎖判定<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>「既存のゲームループを見てみると、実は連鎖反応は既に実装されています！」そうなんです。イテレーション 6 で実装したゲームループの仕組みが、そのまま連鎖反応を実現しているんです。</p>
<p>「え？本当ですか？」はい。ゲームループの実装を見てみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/ゲーム.scala の update メソッド</span>
<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">更新</span><span class="p">(</span><span class="n">デルタ時間</span><span class="p">:</span><span class="w"> </span><span class="nc">Double</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">frame</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="c1">// モードに応じた処理</span>
<span class="w">  </span><span class="n">mode</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">NewPuyo</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">      </span><span class="n">プレイヤ</span><span class="err">ー</span><span class="p">.</span><span class="n">新しいぷよを作成</span><span class="p">()</span>
<span class="w">      </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Playing</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// プレイ中の処理（キー入力と自由落下）</span>
<span class="w">      </span><span class="n">player</span><span class="p">.</span><span class="n">デルタ時間で更新</span><span class="p">(</span><span class="n">デルタ時間</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 着地したら重力チェックに移行</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">着地した</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 重力を適用</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">重力を適用</span><span class="p">()</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasFallen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ぷよが落下した場合、Falling モードへ</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Falling</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 落下するぷよがない場合、消去チェックへ</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckErase</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Falling</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 落下アニメーション用（一定フレーム待機）</span>
<span class="w">      </span><span class="c1">// 簡略化のため、すぐに CheckFall に戻る</span>
<span class="w">      </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckErase</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">消去チェック</span><span class="p">()</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">        </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">.</span><span class="n">ボ</span><span class="err">ー</span><span class="n">ドを消去</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">eraseInfo</span><span class="p">)</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Erasing</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、次のぷよを出す</span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">NewPuyo</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">Erasing</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="c1">// 消去アニメーション用（一定フレーム待機）</span>
<span class="w">      </span><span class="c1">// 簡略化のため、すぐに CheckFall に戻る（消去後の重力適用）</span>
<span class="w">      </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">.</span><span class="nc">CheckFall</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このゲームループの何が連鎖反応を実現しているんですか？」重要なのは、<code>Erasing</code> モード後に <code>CheckFall</code> に戻るという点です。連鎖が発生する流れを見てみましょう：</p>
<h4 id="_71">連鎖の流れ<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>1 回目の消去</strong>：
   <div class="highlight"><pre><span></span><code>CheckErase → ぷよが消去される → Erasing → CheckFall
</code></pre></div></p>
</li>
<li>
<p><strong>重力適用</strong>：
   <div class="highlight"><pre><span></span><code>CheckFall → 上のぷよが落下 → Falling → CheckFall → 落下完了 → CheckErase
</code></pre></div></p>
</li>
<li>
<p><strong>2 回目の消去（連鎖）</strong>：
   <div class="highlight"><pre><span></span><code>CheckErase → 落下後に新しい消去パターン発見 → Erasing → CheckFall
</code></pre></div></p>
</li>
<li>
<p><strong>連鎖終了</strong>：
   <div class="highlight"><pre><span></span><code>CheckFall → 落下なし → CheckErase → 消去なし → NewPuyo
</code></pre></div></p>
</li>
</ol>
<p>「つまり、<code>Erasing → CheckFall → CheckErase</code> のサイクルが連鎖を作っているんですね！」そのとおりです！このサイクルが、消去対象がなくなるまで繰り返されることで、連鎖反応が実現されています。</p>
<h3 id="_72">テストの確認<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通ることを確認しましょう！」そうですね。テストを実行して、すべてが正しく動作することを確認します。</p>
<div class="highlight"><pre><span></span><code>sbt test
</code></pre></div>
<p>実行結果：</p>
<div class="highlight"><pre><span></span><code>[info] GameSpec:
[info] 連鎖反応
[info] - should ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する
[info] Run completed in 2 seconds, 512 milliseconds.
[info] Total number of tests run: 33
[info] Suites: completed 4, aborted 0
[info] Tests: succeeded 33, failed 0, canceled 0, ignored 0, pending 0
[info] All tests passed.
</code></pre></div>
<p>「33 テストすべて成功しました！」素晴らしいですね。前回のイテレーションから 1 テストが追加され、すべて成功しています。イテレーション 6 で実装したゲームループが、自然に連鎖反応を実現していたんです。</p>
<h3 id="_73">テスト用のアクセサメソッド<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>「テストで <code>ゲーム.ステージ</code>、<code>ゲーム.モードを設定()</code>、<code>ゲーム.モードを取得()</code> を使っていますが、これらは追加する必要がありますね？」その通りです！テストのために必要なアクセサメソッドを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/main/scala/puyopuyo/ゲーム.scala（続き）</span>

<span class="c1">// テスト用のアクセサメソッド</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="p">:</span><span class="w"> </span><span class="n">ステ</span><span class="err">ー</span><span class="n">ジ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">_stage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">モ</span><span class="err">ー</span><span class="n">ドを設定</span><span class="p">(</span><span class="n">newMode</span><span class="p">:</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newMode</span>
<span class="p">}</span>
<span class="k">def</span><span class="w"> </span><span class="nf">モ</span><span class="err">ー</span><span class="n">ドを取得</span><span class="p">():</span><span class="w"> </span><span class="n">ゲ</span><span class="err">ー</span><span class="n">ムモ</span><span class="err">ー</span><span class="n">ド</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span>
</code></pre></div>
<p>「private なフィールドにアクセスするためのメソッドなんですね！」そうです。Scala では、テストから内部状態にアクセスする際に、このようなアクセサメソッドを提供することが一般的です。</p>
<h3 id="7_1">イテレーション 7 のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>連鎖反応はゲームループの構造から生まれる</strong></li>
<li><code>Erasing → CheckFall → CheckErase</code> のサイクルが連鎖を実現</li>
<li>消去対象がなくなるまで自動的に繰り返される</li>
<li>
<p>新しいコードを追加する必要がなかった</p>
</li>
<li>
<p><strong>テストファースト開発の利点</strong></p>
</li>
<li>テストを先に書くことで、既存実装の動作を確認できた</li>
<li>新しいコードを追加せずに、テストだけで機能の動作を検証</li>
<li>
<p>実装が正しく動作していることを確認</p>
</li>
<li>
<p><strong>シンプルな設計の力</strong></p>
</li>
<li>複雑な連鎖ロジックを追加せずに、既存の状態遷移だけで実現</li>
<li>各モードが単一責任を持つことで、組み合わせが自然に連鎖を生む</li>
<li>
<p>状態機械パターンの威力を実感</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>連鎖反応のテスト（1 テスト）<ul>
<li>ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する</li>
</ul>
</li>
<li>
<p>合計 33 テストすべて成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>状態遷移による自然な連鎖の実現</li>
<li>既存のゲームループ構造の再確認</li>
<li>
<p>テスト駆動開発による動作検証</p>
</li>
<li>
<p><strong>TypeScript から Scala.js への変換パターン</strong></p>
</li>
<li>プライベートフィールドへのアクセス → アクセサメソッド</li>
<li><code>game['mode']</code> → <code>ゲーム.モードを取得()</code></li>
<li>
<p><code>game['ステージ']</code> → <code>ゲーム.ステージ</code></p>
</li>
<li>
<p><strong>Scala のカプセル化</strong></p>
</li>
<li><code>private</code> によるフィールドの保護</li>
<li><code>def</code> によるアクセサメソッドの提供</li>
<li>
<p>テスト可能性とカプセル化のバランス</p>
</li>
<li>
<p><strong>状態機械パターン</strong></p>
</li>
<li>enum による型安全な状態管理</li>
<li>パターンマッチングによる状態遷移</li>
<li>
<p>各状態が明確な責任を持つ</p>
</li>
<li>
<p><strong>設計の美しさ</strong></p>
</li>
<li>単純な状態遷移が複雑な振る舞いを生む</li>
<li>拡張可能で保守しやすい設計</li>
<li>
<p>テストで動作を確認できる安心感</p>
</li>
<li>
<p><strong>Scala.js の特徴的な実装</strong></p>
<ul>
<li>enum による型安全な状態管理</li>
<li>パターンマッチングによる網羅的な分岐処理</li>
<li>不変性を意識した設計（状態の明示的な変更）</li>
</ul>
</li>
</ol>
<p>次のイテレーションでは、全消しボーナス機能を実装して、ゲームをさらに面白くしていきます！</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>