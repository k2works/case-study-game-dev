
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 F# Fable版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#f-fable" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 F# Fable版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="f-fable">ぷよぷよから始めるテスト駆動開発入門 F# Fable版<a class="headerlink" href="#f-fable" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、F#とFableでぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの？」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進んでいきますよ。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>言語</strong>: F# — 関数型プログラミングの力で、型安全で表現力豊かなコードを書きましょう。</li>
<li><strong>Webコンパイラ</strong>: Fable — F#をJavaScriptにコンパイルしてブラウザで実行します。関数型プログラミングの恩恵をWebアプリで享受できます。</li>
<li><strong>テストフレームワーク</strong>: Fable.Mocha — F#でブラウザテストを実行する強力なフレームワークです。</li>
<li><strong>ビルドツール</strong>: Vite — 高速な開発サーバーとビルドツールです。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ？昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション0: 環境の構築で解説します。</p>
<h2 id="_4">要件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">ユーザーストーリー<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。
ユーザーストーリーには形式が定められておらず、標準的な記法もない。とはいえ、次のような形式でストーリーを考えてみると便利である。「＜ユーザーの種類＞として、＜機能や性能＞がほしい。それは＜ビジネス価値＞のためだ」という形のテンプレートに従うと、
たとえば次のようなストーリーを書ける。「本の購入者として、ＩＳＢＮで本を検索したい。それは探している本をすばやく見つけるためだ」</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう：</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜ん！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PCでプレイするなら必須ですよね）</li>
<li>プレイヤーとして、タッチ操作でぷよを操作できる（スマホでもプレイしたいですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_6">ユースケース図<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>ユーザーストーリーを整理したところで、「これらの機能がどのように関連しているのか、全体像が見えるといいな」と思いませんか？そんなときに役立つのが「ユースケース図」です。
「ユースケース図って何？」と思われるかもしれませんね。ユースケース図は、システムと外部アクター（ここではプレイヤーとシステム自体）の相互作用を視覚的に表現するための図です。「絵に描いて整理すると分かりやすい」というやつですね。</p>
<blockquote>
<p>ユースケースは、システムの振る舞いに関する利害関係者の契約を表現するものです。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<p>「百聞は一見にしかず」というように、実際に見てみるのが一番分かりやすいですよね。では、私たちのぷよぷよゲームのユースケース図を見てみましょう：</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjU5MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODI2cHg7aGVpZ2h0OjU5MHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgyNiA1OTAiIHdpZHRoPSI4MjZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU3NyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxNS4wNyIgeD0iMTEyIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1My45OTkzIiB4PSIzNDIuNTM1MyIgeT0iMjEuOTk1MSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MDc7JiMxMjQyNDsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfU3RhcnROZXdHYW1lIj48ZWxsaXBzZSBjeD0iMjE0LjAyNTkiIGN5PSI1NDEuOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMTUxLjAyNjIiIHk9IjU0Ni42NDM2Ij4mIzI2MDMyOyYjMTIzNzU7JiMxMjM1NjsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDM0OyYjMzgyODM7JiMyMjk4Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9SZXN0YXJ0R2FtZSI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iNDcwLjk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI0NzUuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQzNDsmIzEyNTIyOyYjMTI0NzM7JiMxMjQ3OTsmIzEyNTQwOyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1vdmVQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfTW92ZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjEzMS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNTguMDMyNyIgeT0iMTM1LjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMjQwMzg7JiMyMTQ5MTsmIzEyMzk1OyYjMzEyMjc7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUm90YXRlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfUm90YXRlUHV5byI+PGVsbGlwc2UgY3g9IjIxNC4wMjczIiBjeT0iNjUuMDAzNiIgZmlsbD0iI0YxRjFGMSIgcng9IjUyLjQ5NzMiIHJ5PSIxNC41MjM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSIxNzkuMDI3NCIgeT0iNjkuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyMjIzODsmIzM2NTc4OzwvdGV4dD48L2c+PCEtLWVudGl0eSBRdWlja0Ryb3BQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlF1aWNrRHJvcFB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjIwIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV9RdWlja0Ryb3BQdXlvIj48ZWxsaXBzZSBjeD0iMjE0LjAzMjQiIGN5PSIyMDAuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMTU4LjAzMjciIHk9IjIwNC42NDg5Ij4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzMyMDMyOyYjMjYwODk7JiMxMjM2NzsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZhbGxQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZhbGxQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfRmFsbFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI1MiIgY3k9IjMzMC45OTUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI2Ni43MjUyIiByeT0iMTUuNzQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIxNjUuMDI1NCIgeT0iMzM1LjY0MzUiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMzMyNTg7JiMzMDAwMTsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEVyYXNlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJFcmFzZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9FcmFzZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI3MyIgY3k9IjI2Ni4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjE3OS4wMjc0IiB5PSIyNzAuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyODA0MDsmIzIxNDM1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjI3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9DaGFpblJlYWN0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTIiIGN5PSIyNTcuOTk1IiBmaWxsPSIjRjFGMUYxIiByeD0iNjYuNzI1MiIgcnk9IjE1Ljc0NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMzg3LjAzNTQiIHk9IjI2Mi42NDM1Ij4mIzM2ODk5OyYjMzc3ODI7JiMyMTQ1MzsmIzI0NTQwOyYjMTI0MzQ7JiMzMDMzMDsmIzI5OTgzOzwvdGV4dD48L2c+PCEtLWVudGl0eSBaZW5rZXNoaUJvbnVzLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ilplbmtlc2hpQm9udXMiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0iZW50MDAxMyIgaWQ9ImVudGl0eV9aZW5rZXNoaUJvbnVzIj48ZWxsaXBzZSBjeD0iNDM2LjA0MzEiIGN5PSIzMjcuOTk4NiIgZmlsbD0iI0YxRjFGMSIgcng9IjgzLjk5MzEiIHJ5PSIxOS4xOTg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iMzY2LjA0MzQiIHk9IjMzMi42NDcxIj4mIzIwODQwOyYjMjgwNDA7JiMxMjM3NTsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ5MDsmIzEyNDczOyYjMTI0MzQ7JiMyOTU1NDsmIzI0NDcxOzwvdGV4dD48L2c+PCEtLWVudGl0eSBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSIyOSIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJlbnRpdHlfRGlzcGxheVNjb3JlIj48ZWxsaXBzZSBjeD0iNjQxLjU1NDIiIGN5PSIyNTcuMDAyOCIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1OTkuNTU0NCIgeT0iMjYxLjY1MTMiPiYjMTI0NzM7JiMxMjQ2NzsmIzEyNDUwOyYjMTI0MzQ7JiMzNDkyMDsmIzMxMDM0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzNCIgZGF0YS11aWQ9ImVudDAwMTUiIGlkPSJlbnRpdHlfS2V5Ym9hcmRDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjA0MjQiIGN5PSI2Ny4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIzODAuMDQyNyIgeT0iNzEuNjQ4OSI+JiMxMjQ2MTsmIzEyNTQwOyYjMTI1MDg7JiMxMjU0MDsmIzEyNDg5OyYjMTIzOTE7JiMyNTgwNTsmIzIwMzE2OzwvdGV4dD48L2c+PCEtLWVudGl0eSBUb3VjaENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iVG91Y2hDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzNSIgZGF0YS11aWQ9ImVudDAwMTYiIGlkPSJlbnRpdHlfVG91Y2hDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjAzNzMiIGN5PSIxMzMuMDAzNiIgZmlsbD0iI0YxRjFGMSIgcng9IjUyLjQ5NzMiIHJ5PSIxNC41MjM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI0MDEuMDM3NCIgeT0iMTM3LjY1MjEiPiYjMTI0Nzk7JiMxMjQ4MzsmIzEyNDgxOyYjMjU4MDU7JiMyMDMxNjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgR2FtZU92ZXJDaGVjay0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHYW1lT3ZlckNoZWNrIiBkYXRhLXNvdXJjZS1saW5lPSI0MCIgZGF0YS11aWQ9ImVudDAwMTciIGlkPSJlbnRpdHlfR2FtZU92ZXJDaGVjayI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iMzk5Ljk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI0MDQuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQ1ODsmIzEyNTQwOyYjMTI0OTY7JiMxMjU0MDsmIzIxMDI4OyYjMjM0NTA7PC90ZXh0PjwvZz48IS0tZW50aXR5IEdhbWVPdmVyQW5pbWF0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI0MSIgZGF0YS11aWQ9ImVudDAwMTgiIGlkPSJlbnRpdHlfR2FtZU92ZXJBbmltYXRpb24iPjxlbGxpcHNlIGN4PSI0MzYuMDM1OSIgY3k9IjM5OS45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIzNzMuMDM2MiIgeT0iNDA0LjY0MzYiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0NTg7JiMxMjU0MDsmIzEyNDk2OyYjMTI1NDA7JiMyODQzNjsmIzIwOTg2OzwvdGV4dD48L2c+PCEtLWVudGl0eSBQbGF5ZXItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUGxheWVyIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImVudGl0eV9QbGF5ZXIiPjxlbGxpcHNlIGN4PSI0MC45OTk4IiBjeT0iMTAxLjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik00MC45OTk4LDEwOS4zNSBMNDAuOTk5OCwxMzYuMzUgTTI3Ljk5OTgsMTE3LjM1IEw1My45OTk4LDExNy4zNSBNNDAuOTk5OCwxMzYuMzUgTDI3Ljk5OTgsMTUxLjM1IE00MC45OTk4LDEzNi4zNSBMNTMuOTk5OCwxNTEuMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjYiIHk9IjE2NS44NDUxIj4mIzEyNTAzOyYjMTI1MjQ7JiMxMjQ1MjsmIzEyNTE2OyYjMTI1NDA7PC90ZXh0PjwvZz48IS0tZW50aXR5IFN5c3RlbS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X1N5c3RlbSI+PGVsbGlwc2UgY3g9Ijc5MS4wNjk5IiBjeT0iNDM3LjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik03OTEuMDY5OSw0NDUuMzUgTDc5MS4wNjk5LDQ3Mi4zNSBNNzc4LjA2OTksNDUzLjM1IEw4MDQuMDY5OSw0NTMuMzUgTTc5MS4wNjk5LDQ3Mi4zNSBMNzc4LjA2OTksNDg3LjM1IE03OTEuMDY5OSw0NzIuMzUgTDgwNC4wNjk5LDQ4Ny4zNSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iNzYzLjA3IiB5PSI1MDEuODQ1MSI+JiMxMjQ3MTsmIzEyNDczOyYjMTI0ODY7JiMxMjUxMjs8L3RleHQ+PC9nPjwhLS1saW5rIFBsYXllciB0byBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJTdGFydE5ld0dhbWUiIGRhdGEtc291cmNlLWxpbmU9IjQ2IiBkYXRhLXVpZD0ibG5rMTkiIGlkPSJsaW5rX1BsYXllcl9TdGFydE5ld0dhbWUiPjxwYXRoIGQ9Ik0yMy4wNywxNjkuMyBDMjMuMDcsMjcxLjMzIDIzLjA3LDU0MiAyMy4wNyw1NDIgQzIzLjA3LDU0MiA3Ni44Niw1NDIgMTI5LjUzLDU0MiIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1TdGFydE5ld0dhbWUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEzNS41Myw1NDIsMTI2LjUzLDUzOCwxMzAuNTMsNTQyLDEyNi41Myw1NDYsMTM1LjUzLDU0MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSZXN0YXJ0R2FtZSIgZGF0YS1zb3VyY2UtbGluZT0iNDciIGRhdGEtdWlkPSJsbmsyMCIgaWQ9ImxpbmtfUGxheWVyX1Jlc3RhcnRHYW1lIj48cGF0aCBkPSJNNDEuMDcsMTY5LjM0IEM0MS4wNywyNTguMjYgNDEuMDcsNDcxIDQxLjA3LDQ3MSBDNDEuMDcsNDcxIDgzLjg4LDQ3MSAxMjkuNjQsNDcxIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJlc3RhcnRHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNjQsNDcxLDEyNi42NCw0NjcsMTMwLjY0LDQ3MSwxMjYuNjQsNDc1LDEzNS42NCw0NzEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIE1vdmVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iTW92ZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjQ4IiBkYXRhLXVpZD0ibG5rMjEiIGlkPSJsaW5rX1BsYXllcl9Nb3ZlUHV5byI+PHBhdGggZD0iTTc2LjQzLDEzMSBDOTUuMjIsMTMxIDExMy4wMSwxMzEgMTM1LjUsMTMxIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLU1vdmVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDEuNSwxMzEsMTMyLjUsMTI3LDEzNi41LDEzMSwxMzIuNSwxMzUsMTQxLjUsMTMxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBSb3RhdGVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUm90YXRlUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iNDkiIGRhdGEtdWlkPSJsbmsyMiIgaWQ9ImxpbmtfUGxheWVyX1JvdGF0ZVB1eW8iPjxwYXRoIGQ9Ik00MS4wNyw5Mi42MSBDNDEuMDcsNzguMDkgNDEuMDcsNjUgNDEuMDcsNjUgQzQxLjA3LDY1IDEwNC4zMyw2NSAxNTUuMTksNjUiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tUm90YXRlUHV5byIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTYxLjE5LDY1LDE1Mi4xOSw2MSwxNTYuMTksNjUsMTUyLjE5LDY5LDE2MS4xOSw2NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUXVpY2tEcm9wUHV5by0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9IlF1aWNrRHJvcFB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjUwIiBkYXRhLXVpZD0ibG5rMjMiIGlkPSJsaW5rX1BsYXllcl9RdWlja0Ryb3BQdXlvIj48cGF0aCBkPSJNNTguMDcsMTY5LjUzIEM1OC4wNywxODUuMzQgNTguMDcsMjAwIDU4LjA3LDIwMCBDNTguMDcsMjAwIDk0LjgsMjAwIDEzNS41MiwyMDAiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tUXVpY2tEcm9wUHV5byIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTQxLjUyLDIwMCwxMzIuNTIsMTk2LDEzNi41MiwyMDAsMTMyLjUyLDIwNCwxNDEuNTIsMjAwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjUxIiBkYXRhLXVpZD0ibG5rMjQiIGlkPSJsaW5rX1BsYXllcl9LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik03Ni4zMywxMDMuNSBDMTYyLjA1LDEwMy41IDM3NC4wNywxMDMuNSAzNzQuMDcsMTAzLjUgQzM3NC4wNywxMDMuNSAzNzQuMDcsOTIuNjQgMzc0LjA3LDgxLjg0IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc0LjA3LDc1Ljg0LDM3MC4wNyw4NC44NCwzNzQuMDcsODAuODQsMzc4LjA3LDg0Ljg0LDM3NC4wNyw3NS44NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gVG91Y2hDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iVG91Y2hDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI1MiIgZGF0YS11aWQ9ImxuazI1IiBpZD0ibGlua19QbGF5ZXJfVG91Y2hDb250cm9sIj48cGF0aCBkPSJNNzYuNDcsMTU4LjUgQzE3MC4zNCwxNTguNSA0MTguMDcsMTU4LjUgNDE4LjA3LDE1OC41IEM0MTguMDcsMTU4LjUgNDE4LjA3LDE1OC45IDQxOC4wNywxNTIuOTQiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tVG91Y2hDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MTguMDcsMTQ2Ljk0LDQxNC4wNywxNTUuOTQsNDE4LjA3LDE1MS45NCw0MjIuMDcsMTU1Ljk0LDQxOC4wNywxNDYuOTQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBFcmFzZVB1eW8gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkVyYXNlUHV5byIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NSIgZGF0YS11aWQ9ImxuazI2IiBpZD0ibGlua19FcmFzZVB1eW9fU3lzdGVtIj48cGF0aCBkPSJNMjcyLjc4LDI2Ni4zMiBDMzAwLjIxLDI2Ni4zMiAzMjIuMDcsMjY2LjMyIDMyMi4wNywyNjYuMzIgQzMyMi4wNywyNjYuMzIgMzIyLjA3LDQzOC41MSAzMjIuMDcsNDM4LjUxIEMzMjIuMDcsNDM4LjUxIDY2MS4zOSw0MzguNTEgNzYyLjc4LDQzOC41MSIgZmlsbD0ibm9uZSIgaWQ9IkVyYXNlUHV5by1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNjYuNzgsMjY2LjMyLDI3NS43OCwyNzAuMzIsMjcxLjc4LDI2Ni4zMiwyNzUuNzgsMjYyLjMyLDI2Ni43OCwyNjYuMzIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBGYWxsUHV5byB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRmFsbFB1eW8iIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTYiIGRhdGEtdWlkPSJsbmsyNyIgaWQ9ImxpbmtfRmFsbFB1eW9fU3lzdGVtIj48cGF0aCBkPSJNMjg3LjE1LDMzMSBDMzAxLjgyLDMzMSAzMDcuMDcsMzMxIDMwNy4wNywzMzEgQzMwNy4wNywzMzEgMzA3LjA3LDQ0My4zNCAzMDcuMDcsNDQzLjM0IEMzMDcuMDcsNDQzLjM0IDY1OC44NSw0NDMuMzQgNzYyLjYsNDQzLjM0IiBmaWxsPSJub25lIiBpZD0iRmFsbFB1eW8tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjgxLjE1LDMzMSwyOTAuMTUsMzM1LDI4Ni4xNSwzMzEsMjkwLjE1LDMyNywyODEuMTUsMzMxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgQ2hhaW5SZWFjdGlvbiB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iQ2hhaW5SZWFjdGlvbiIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NyIgZGF0YS11aWQ9ImxuazI4IiBpZD0ibGlua19DaGFpblJlYWN0aW9uX1N5c3RlbSI+PHBhdGggZD0iTTUwMy43MywyNjQuMzUgQzUzMC41OSwyNjQuMzUgNTUwLjA3LDI2NC4zNSA1NTAuMDcsMjY0LjM1IEM1NTAuMDcsMjY0LjM1IDU1MC4wNyw0MzMuNjggNTUwLjA3LDQzMy42OCBDNTUwLjA3LDQzMy42OCA2OTkuMzgsNDMzLjY4IDc2Mi45NSw0MzMuNjgiIGZpbGw9Im5vbmUiIGlkPSJDaGFpblJlYWN0aW9uLWJhY2t0by1TeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ5Ny43MywyNjQuMzUsNTA2LjczLDI2OC4zNSw1MDIuNzMsMjY0LjM1LDUwNi43MywyNjAuMzUsNDk3LjczLDI2NC4zNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIFplbmtlc2hpQm9udXMgdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ilplbmtlc2hpQm9udXMiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTgiIGRhdGEtdWlkPSJsbmsyOSIgaWQ9ImxpbmtfWmVua2VzaGlCb251c19TeXN0ZW0iPjxwYXRoIGQ9Ik01MjYuMTgsMzI4IEM2MzEuMTYsMzI4IDc5MS4wNywzMjggNzkxLjA3LDMyOCBDNzkxLjA3LDMyOCA3OTEuMDcsMzg3LjUxIDc5MS4wNyw0MjguNjUiIGZpbGw9Im5vbmUiIGlkPSJaZW5rZXNoaUJvbnVzLWJhY2t0by1TeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUyMC4xOCwzMjgsNTI5LjE4LDMzMiw1MjUuMTgsMzI4LDUyOS4xOCwzMjQsNTIwLjE4LDMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIERpc3BsYXlTY29yZSB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRGlzcGxheVNjb3JlIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU5IiBkYXRhLXVpZD0ibG5rMzAiIGlkPSJsaW5rX0Rpc3BsYXlTY29yZV9TeXN0ZW0iPjxwYXRoIGQ9Ik03MDkuMzcsMjU3IEM3NTUuNjcsMjU3IDgwNS4wNywyNTcgODA1LjA3LDI1NyBDODA1LjA3LDI1NyA4MDUuMDcsMzY3Ljg2IDgwNS4wNyw0MjguNDgiIGZpbGw9Im5vbmUiIGlkPSJEaXNwbGF5U2NvcmUtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzAzLjM3LDI1Nyw3MTIuMzcsMjYxLDcwOC4zNywyNTcsNzEyLjM3LDI1Myw3MDMuMzcsMjU3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgR2FtZU92ZXJDaGVjayB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJDaGVjayIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI2MCIgZGF0YS11aWQ9ImxuazMxIiBpZD0ibGlua19HYW1lT3ZlckNoZWNrX1N5c3RlbSI+PHBhdGggZD0iTTIxNC4wNyw0MjQuNDggQzIxNC4wNyw0MzguMDcgMjE0LjA3LDQ0OC4xNyAyMTQuMDcsNDQ4LjE3IEMyMTQuMDcsNDQ4LjE3IDY0Nyw0NDguMTcgNzYyLjg1LDQ0OC4xNyIgZmlsbD0ibm9uZSIgaWQ9IkdhbWVPdmVyQ2hlY2stYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjE0LjA3LDQxOC40OCwyMTAuMDcsNDI3LjQ4LDIxNC4wNyw0MjMuNDgsMjE4LjA3LDQyNy40OCwyMTQuMDcsNDE4LjQ4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgR2FtZU92ZXJBbmltYXRpb24gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjYxIiBkYXRhLXVpZD0ibG5rMzIiIGlkPSJsaW5rX0dhbWVPdmVyQW5pbWF0aW9uX1N5c3RlbSI+PHBhdGggZD0iTTUyMC4yOCw0MDAgQzYyMC45Niw0MDAgNzc3LjA3LDQwMCA3NzcuMDcsNDAwIEM3NzcuMDcsNDAwIDc3Ny4wNyw0MTMuNTIgNzc3LjA3LDQyOC40MSIgZmlsbD0ibm9uZSIgaWQ9IkdhbWVPdmVyQW5pbWF0aW9uLWJhY2t0by1TeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUxNC4yOCw0MDAsNTIzLjI4LDQwNCw1MTkuMjgsNDAwLDUyMy4yOCwzOTYsNTE0LjI4LDQwMCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBNb3ZlUHV5byB0byBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iTW92ZVB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNjQiIGRhdGEtdWlkPSJsbmszMyIgaWQ9ImxpbmtfTW92ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjc2LjA3LDEyMi4xIEMyNzYuMDcsMTA0LjA4IDI3Ni4wNyw2NSAyNzYuMDcsNjUgQzI3Ni4wNyw2NSAzMTUuNTUsNjUgMzU4LjAxLDY1IiBmaWxsPSJub25lIiBpZD0iTW92ZVB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjQuMDEsNjUsMzU1LjAxLDYxLDM1OS4wMSw2NSwzNTUuMDEsNjksMzY0LjAxLDY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjkyLjQ5IiB5PSI3OC4wNjY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIE1vdmVQdXlvIHRvIFRvdWNoQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNb3ZlUHV5byIgZGF0YS1lbnRpdHktMj0iVG91Y2hDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2NSIgZGF0YS11aWQ9ImxuazM0IiBpZD0ibGlua19Nb3ZlUHV5b19Ub3VjaENvbnRyb2wiPjxwYXRoIGQ9Ik0yODAuNjQsMTM3Ljg0IEMzMTQuNDksMTM3Ljg0IDM0OC45MywxMzcuODQgMzgwLjA3LDEzNy44NCIgZmlsbD0ibm9uZSIgaWQ9Ik1vdmVQdXlvLXRvLVRvdWNoQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzg2LjA3LDEzNy44NCwzNzcuMDcsMTMzLjg0LDM4MS4wNywxMzcuODQsMzc3LjA3LDE0MS44NCwzODYuMDcsMTM3Ljg0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzM0LjM1IiB5PSIxNTAuOTA2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBSb3RhdGVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSb3RhdGVQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjY2IiBkYXRhLXVpZD0ibG5rMzUiIGlkPSJsaW5rX1JvdGF0ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjYwLjMsNTcuNzQgQzI5My40Nyw1Ny43NCAzMzIuNDksNTcuNzQgMzY4LjY2LDU3Ljc0IiBmaWxsPSJub25lIiBpZD0iUm90YXRlUHV5by10by1LZXlib2FyZENvbnRyb2wiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM3NC42Niw1Ny43NCwzNjUuNjYsNTMuNzQsMzY5LjY2LDU3Ljc0LDM2NS42Niw2MS43NCwzNzQuNjYsNTcuNzQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2MS4xODUxIiB4PSIyNTUuNDgiIHk9IjUzLjgwNjkiPiYjMTcxO2V4dGVuZCYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgUm90YXRlUHV5byB0byBUb3VjaENvbnRyb2wtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUm90YXRlUHV5byIgZGF0YS1lbnRpdHktMj0iVG91Y2hDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2NyIgZGF0YS11aWQ9ImxuazM2IiBpZD0ibGlua19Sb3RhdGVQdXlvX1RvdWNoQ29udHJvbCI+PHBhdGggZD0iTTI2MC4xOSw3Mi4yNiBDMjk1LjEsNzIuMjYgMzM3LjA3LDcyLjI2IDMzNy4wNyw3Mi4yNiBDMzM3LjA3LDcyLjI2IDMzNy4wNywxMjguMTYgMzM3LjA3LDEyOC4xNiBDMzM3LjA3LDEyOC4xNiAzNTUuNDMsMTI4LjE2IDM3OS45OCwxMjguMTYiIGZpbGw9Im5vbmUiIGlkPSJSb3RhdGVQdXlvLXRvLVRvdWNoQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzg1Ljk4LDEyOC4xNiwzNzYuOTgsMTI0LjE2LDM4MC45OCwxMjguMTYsMzc2Ljk4LDEzMi4xNiwzODUuOTgsMTI4LjE2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjc1LjA3IiB5PSI5OS4yOTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFF1aWNrRHJvcFB1eW8gdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlF1aWNrRHJvcFB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNjgiIGRhdGEtdWlkPSJsbmszNyIgaWQ9ImxpbmtfUXVpY2tEcm9wUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yODIuNTgsMTk0LjM4IEMzMjcuOTMsMTk0LjM4IDM3OS4wNywxOTQuMzggMzc5LjA3LDE5NC4zOCBDMzc5LjA3LDE5NC4zOCAzNzkuMDcsMTEzLjg1IDM3OS4wNyw4My40MiIgZmlsbD0ibm9uZSIgaWQ9IlF1aWNrRHJvcFB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNzkuMDcsNzcuNDIsMzc1LjA3LDg2LjQyLDM3OS4wNyw4Mi40MiwzODMuMDcsODYuNDIsMzc5LjA3LDc3LjQyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzE3LjA3IiB5PSIxOTcuMjA2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBRdWlja0Ryb3BQdXlvIHRvIFRvdWNoQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJRdWlja0Ryb3BQdXlvIiBkYXRhLWVudGl0eS0yPSJUb3VjaENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjY5IiBkYXRhLXVpZD0ibG5rMzgiIGlkPSJsaW5rX1F1aWNrRHJvcFB1eW9fVG91Y2hDb250cm9sIj48cGF0aCBkPSJNMjgyLjg1LDIwNS42MiBDMzUzLjQ2LDIwNS42MiA0NTMuMDcsMjA1LjYyIDQ1My4wNywyMDUuNjIgQzQ1My4wNywyMDUuNjIgNDUzLjA3LDE3NC4xIDQ1My4wNywxNTMiIGZpbGw9Im5vbmUiIGlkPSJRdWlja0Ryb3BQdXlvLXRvLVRvdWNoQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDUzLjA3LDE0Nyw0NDkuMDcsMTU2LDQ1My4wNywxNTIsNDU3LjA3LDE1Niw0NTMuMDcsMTQ3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzM1LjI2IiB5PSIyMTguNjg2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBFcmFzZVB1eW8gdG8gQ2hhaW5SZWFjdGlvbi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJFcmFzZVB1eW8iIGRhdGEtZW50aXR5LTI9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjcyIiBkYXRhLXVpZD0ibG5rMzkiIGlkPSJsaW5rX0VyYXNlUHV5b19DaGFpblJlYWN0aW9uIj48cGF0aCBkPSJNMjYwLjU3LDI1OC45IEMyOTIuMSwyNTguOSAzMjguMjYsMjU4LjkgMzYzLjM1LDI1OC45IiBmaWxsPSJub25lIiBpZD0iRXJhc2VQdXlvLXRvLUNoYWluUmVhY3Rpb24iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM2OS4zNSwyNTguOSwzNjAuMzUsMjU0LjksMzY0LjM1LDI1OC45LDM2MC4zNSwyNjIuOSwzNjkuMzUsMjU4LjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIyNTAuOTYiIHk9IjI1NC45NjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBDaGFpblJlYWN0aW9uIHRvIERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJDaGFpblJlYWN0aW9uIiBkYXRhLWVudGl0eS0yPSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9IjczIiBkYXRhLXVpZD0ibG5rNDAiIGlkPSJsaW5rX0NoYWluUmVhY3Rpb25fRGlzcGxheVNjb3JlIj48cGF0aCBkPSJNNDkzLjU2LDI0OS42NSBDNTIzLjAxLDI0OS42NSA1NTIuNjUsMjQ5LjY1IDU4MS41OCwyNDkuNjUiIGZpbGw9Im5vbmUiIGlkPSJDaGFpblJlYWN0aW9uLXRvLURpc3BsYXlTY29yZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTg3LjU4LDI0OS42NSw1NzguNTgsMjQ1LjY1LDU4Mi41OCwyNDkuNjUsNTc4LjU4LDI1My42NSw1ODcuNTgsMjQ5LjY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjMuMDA2OCIgeD0iNTQxLjU3IiB5PSIyNDUuNzE2OSI+JiMxNzE7aW5jbHVkZSYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgWmVua2VzaGlCb251cyB0byBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iWmVua2VzaGlCb251cyIgZGF0YS1lbnRpdHktMj0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSI3NCIgZGF0YS11aWQ9ImxuazQxIiBpZD0ibGlua19aZW5rZXNoaUJvbnVzX0Rpc3BsYXlTY29yZSI+PHBhdGggZD0iTTUxNC4wNywzMjAuNjcgQzUxNC4wNywzMDIuNTMgNTE0LjA3LDI1NyA1MTQuMDcsMjU3IEM1MTQuMDcsMjU3IDU0MS4xOSwyNTcgNTczLjY4LDI1NyIgZmlsbD0ibm9uZSIgaWQ9Ilplbmtlc2hpQm9udXMtdG8tRGlzcGxheVNjb3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NzkuNjgsMjU3LDU3MC42OCwyNTMsNTc0LjY4LDI1Nyw1NzAuNjgsMjYxLDU3OS42OCwyNTciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1MTYuMDQiIHk9IjI3MC4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBHYW1lT3ZlckNoZWNrIHRvIEdhbWVPdmVyQW5pbWF0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkdhbWVPdmVyQ2hlY2siIGRhdGEtZW50aXR5LTI9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI3NSIgZGF0YS11aWQ9ImxuazQyIiBpZD0ibGlua19HYW1lT3ZlckNoZWNrX0dhbWVPdmVyQW5pbWF0aW9uIj48cGF0aCBkPSJNMjkyLjMsNDAwIEMzMTMuNTIsNDAwIDMzMC41LDQwMCAzNTEuNzMsNDAwIiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJDaGVjay10by1HYW1lT3ZlckFuaW1hdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzU3LjczLDQwMCwzNDguNzMsMzk2LDM1Mi43Myw0MDAsMzQ4LjczLDQwNCwzNTcuNzMsNDAwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjMuMDA2OCIgeD0iMjYxLjAxIiB5PSI0MTMuMDY2OSI+JiMxNzE7aW5jbHVkZSYjMTg3OzwvdGV4dD48L2c+PCEtLVNSQz1bYkxKVEpYRDE2QnRWZnpYbXVyTHYwNEQ4NURHQmVvOXV2VHN1N1RqRGpwbER4WEhqMzhjeEFyMTFlQWRPSGE0NUg3dUwxT21ldlVUWGZqamp0eUFQTVJnVFFNY0FJVERpdlpqZGxaRlZFSkM2VjhmTFo1SEJKb0luNmpTamc2NFRjT2dUcWlxQ2k0MVFwRzBqMUg5bTNFU0NnQjhvQzFDNjUwMjZSYUFTb3EwTE1KWTk1RU1RSWptcnVsdVd4WmRuSmVZcHYtenoyQ3dzNVExWFBBYnpuMmlKeG5qbnJ1YjdWb1R6QWgzTDRHRmFlMUtYdDJGWV9ZTlU1RjVNVTdhaVBzRU9MZkllRXlLdTU5RV8tN1NGTTJEbEhJUS1LMzFBRzlvNDVscmFlWXZHbVR2Z0s5WGdiRE9RQnh6R1RTSlJPRWtLdi13NzdxaE1YWGdtUVBUUXdJVG5vaUh2OVJHZURhZ3Bfa1BpQTBtMzJ6LTdwLXcwRDZvbkgzM25UbFpNVjFIVWRoRDZlU3J1ZDNJWGpBZGE5d2d6ZFFrVUJiejlPZEM0SFZ6ZW1yeXU5Q3ZraTVkblB6X25KbFZHRTFwOXZqMWJ5QUxGelNmUWcwVFhXQmxYV2J5aGpWOHNTSFJnWFRGZ2RfM08zeEV3Ylhnc0s4UHBFZXVHN1JfZnpGeVRmM3d6NG9wazItcmsweUZlZWd4c0UtX0ZMcFpnYmFMQkNlbXNSU29OXzhLdl90b1A3VU56U1IzdWNPRTdhYTB0SG80OG1udUhfQ2Fqa1lFcHQ1bGNQdlpYTWVsMXQ4NV9Ma1JDbnoxQ0dKa2Z0cUhjclhPemZ4WDM3bG5ZVk5LaE0zX2N3NjdUcGoxaVpzZDh3bEpRZF9wZ3BvblRSSlprVHd1ZExGTVFFOWpYSDdZSmtwM3QxMDRoRmVIQ1IyNTNQRDdPVVNIcDFGMFpiRE1JSk1JZFRRcUJUNExUS1RIdC00VTFfbGx2VE5oYlVKVU15R1ZacTFmQUdZdExXck94TVZJZFpvTlEzTERGMHN4SDFEREExU2dGMXJLTm9iSjI1cUlEbkdSYklvY2lZelRFTTh4a1kwWGp0R1hYTE93eks2V3RHMlg5dXN3UlM0anpiNXJyODFQaEZkVkRzOGpoS2N4NVdYSEJpSTBjSzVvTmRCY2k0Q3JVQkJCS2xmZHEyeGpLVUZOU0xQaDNLX2x4RXlRV05iUzcxazFwM0N0dXVBMkM1QVNZbXJnSnh4cmI2eFJ4ZmY5bmxWVmpYN1ZWY1pfUDd3Y0pyS2VmejlFRGZVS2RPeWtjQ1Jma1FhT3MzWWJWaFo2cVA5V0NiYXRrMFBPRFBrMUVQb042Rm0wMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p>この図を見ると、プレイヤーとシステムの役割分担がよくわかりますね。プレイヤーはゲームの開始や操作を担当し、システムはぷよの消去判定やスコア計算などの内部処理を担当しています。また、キーボード操作とタッチ操作は「拡張（extend）」関係にあり、ぷよの移動や回転などの基本操作を異なる入力方法で実現していることがわかります。</p>
<p>このようにユースケース図を作成することで、システムの全体像を把握し、実装すべき機能の関連性を明確にすることができます。それでは、実際のコード実装に進んでいきましょう！</p>
<p>誤解しないでもらいたいのですが本来ユースケースとはテキストで記述するものでありユースケース図は概要を把握するための手段に過ぎないということです。</p>
<blockquote>
<p>楕円、矢印、人型おアイコンから構成されているUMLのユースケース図は、ユースケースを把握するための表記法ではありません。
楕円や矢印は、ユースケースをのパッケージや分解を表すもので、内容を表すものではありません。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<h2 id="_7">リリース計画<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>要件もわかった、プログラミング開始だ！ちょっと待ってください、何事も計画を立てる事は大事なことです。ユースケース図を見てください、結構いろんなことがありますよね。何から取り組みますか？
「スコアの表示」ですか？「ゲームオーバー判定」ですか？でもまずは「新しいゲームを開始」しないとつながりとして難しいですよね。もちろん実際にプログラミングしながら順番を考えてもいいですけど間違った順番で進めると直すのが大変ですよね。
それにこれからどんなものを作るのかは事前にある程度イメージを固めておきたいものです（いきなり「ゲームオーバー」になるゲームはやりたくないですよね）。</p>
<blockquote>
<p>計画づくりとは「なにをいつまでに作ればいいのか？」という質問に答える作業だと私は考えている</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>今回の目的はぷよぷよゲームを遊べるための最小限の機能の実装です。目的を実現するためにやるべきことをイテレーションという単位でまとめましょう。「全部やること洗い出すの？そんな先のことはわからないよ！」と思いますよね。安心してください今決めることは大まかな作業の流れと前後関係の整理だけです。
細かい部分は各イテレーションでおいおい明確になってきます。その手助けをしてくれるのがテスト駆動開発なのです。</p>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>今回はユーザーストーリーとユースケース図から以下のイテレーション計画に従ってぷよぷよゲームをリリースします。</p>
<ul>
<li>イテレーション0: 環境の構築</li>
<li>イテレーション1: ゲーム開始の実装</li>
<li>イテレーション2: ぷよの移動の実装</li>
<li>イテレーション3: ぷよの回転の実装</li>
<li>イテレーション4: ぷよの自由落下の実装</li>
<li>イテレーション5: ぷよの高速落下の実装</li>
<li>イテレーション6: ぷよの消去の実装</li>
<li>イテレーション7: 連鎖反応の実装</li>
<li>イテレーション8: 全消しボーナスの実装</li>
<li>イテレーション9: ゲームオーバーの実装</li>
</ul>
<p>では、ぷよぷよゲーム開発スタートです！</p>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>...と言いたいところですがまずは環境の構築をしなければなりません。「プログラミングなんてどの言語でやるか決めるぐらいでしょ？」と思うかもしれませんが家を建てるときにしっかりとした基礎工事が必要なように開発環境もしっかりとした準備が必要です。
家を建てた後に基礎がダメだと困ったことになりますからね。</p>
<h3 id="_8">ソフトウェア開発の三種の神器<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本章では開発環境のセットアップとして、これら三種の神器を準備していきます。環境構築は退屈に感じるかもしれませんが、これらのツールがあることで、安心してコードを書くことができるようになります。一緒に進めていきましょう！</p>
<h3 id="git">バージョン管理: Gitとコミットメッセージ<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>バージョン管理システムとして Git を使います。Git については既に使用していると仮定しますが、コミットメッセージについて1つだけ重要なルールを確認しておきましょう。</p>
<h4 id="_9">コミットメッセージの書き方<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>私たちのプロジェクトでは、<a href="https://www.conventionalcommits.org/ja/">Conventional Commits</a>の書式に従ってコミットメッセージを書きます。具体的には、それぞれのコミットメッセージはヘッダ、ボディ、フッタで構成されます。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p>ヘッダは必須で、スコープは任意です。コミットメッセージのタイトルは50文字までにしましょう（GitHub上で読みやすくなります）。</p>
<p>コミットのタイプは次を用います：</p>
<ul>
<li><strong>feat</strong>: 新しい機能</li>
<li><strong>fix</strong>: バグ修正</li>
<li><strong>docs</strong>: ドキュメント変更のみ</li>
<li><strong>style</strong>: コードに影響を与えない変更（空白、フォーマットなど）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更</li>
<li><strong>test</strong>: テストの追加や修正</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更</li>
</ul>
<p>例えば：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化機能を追加&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: メソッドの抽出&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよ消去のテストケースを追加&#39;</span>
</code></pre></div>
<h3 id="fable-fjavascript">Fable: F#からJavaScriptへ<a class="headerlink" href="#fable-fjavascript" title="Permanent link">&para;</a></h3>
<p>「F#でブラウザゲームを作る？どうやって？」と思われるかもしれませんね。ここで登場するのが <strong>Fable</strong> です。Fable は F# のコードを JavaScript に変換するコンパイラで、F# の型安全性と関数型プログラミングの恩恵を受けながら、ブラウザで動作するアプリケーションを開発できる素晴らしいツールです。</p>
<h4 id="fable">Fableとは<a class="headerlink" href="#fable" title="Permanent link">&para;</a></h4>
<p>Fable は F# から JavaScript へのコンパイラで、2016 年に Alfonso García-Caro 氏によって開発されました。F# のコードをモダンな JavaScript (ES2015+) に変換し、ブラウザや Node.js で実行できるようにします。</p>
<p>「なぜわざわざF#からJavaScriptに変換するの？直接JavaScriptを書けばいいじゃない」と思われるかもしれませんね。それにはいくつかの理由があります：</p>
<p><strong>1. 型安全性</strong></p>
<p>F# は静的型付け言語です。コンパイル時に型エラーを検出できるため、実行時エラーを大幅に減らすことができます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: コンパイル時に型エラーを検出</span>
<span class="k">let</span><span class="w"> </span><span class="nv">add</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span>
<span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="w">  </span><span class="c1">// コンパイルエラー！</span>
</code></pre></div>
<p>対して JavaScript は動的型付け言語なので、実行時まで型エラーが発見されません：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// JavaScript: 実行時にエラーが発生するかもしれない</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// &quot;12&quot; という文字列になってしまう</span>
</code></pre></div>
<p>「型安全性って、そんなに重要なの？」と思われるかもしれませんが、大規模なプロジェクトになると、型エラーによるバグが致命的な問題を引き起こすことがあります。Fable を使えば、コンパイル時に多くのバグを防ぐことができます。</p>
<p><strong>2. 関数型プログラミング</strong></p>
<p>F# は関数型プログラミング言語として設計されており、イミュータブル（不変）なデータ構造や純粋関数など、バグを減らすための機能が標準で備わっています。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: イミュータブルなデータ構造</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">}</span>

<span class="k">let</span><span class="w"> </span><span class="nv">point1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="k">let</span><span class="w"> </span><span class="nv">point2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">point1</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">}</span><span class="w">  </span><span class="c1">// 新しいインスタンスを作成</span>

<span class="c1">// point1 は変更されない</span>
<span class="n">printfn</span><span class="w"> </span><span class="s">&quot;%A&quot;</span><span class="w"> </span><span class="n">point1</span><span class="w">  </span><span class="c1">// { X = 0; Y = 0 }</span>
<span class="n">printfn</span><span class="w"> </span><span class="s">&quot;%A&quot;</span><span class="w"> </span><span class="n">point2</span><span class="w">  </span><span class="c1">// { X = 10; Y = 0 }</span>
</code></pre></div>
<p>「イミュータブルって何？」と思われるかもしれませんね。イミュータブルとは、一度作成したデータを変更できないという性質のことです。これにより、予期しない状態変更によるバグを防ぐことができます。</p>
<p><strong>3. パターンマッチング</strong></p>
<p>F# のパターンマッチングは、複雑な条件分岐を簡潔に書くことができる強力な機能です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: パターンマッチング</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span>

<span class="k">let</span><span class="w"> </span><span class="nv">getPuyoName</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;赤ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;青ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;緑ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;黄ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;空&quot;</span>

<span class="c1">// コンパイラがすべてのケースをチェック</span>
<span class="c1">// ケースの漏れがあるとコンパイルエラーになる</span>
</code></pre></div>
<p>JavaScript で同じことをしようとすると、if-else や switch 文を使う必要があり、ケースの漏れがあってもコンパイラが検出してくれません。</p>
<p><strong>4. 強力な型推論</strong></p>
<p>F# の型推論は非常に強力で、多くの場合、型注釈を書かなくてもコンパイラが正しい型を推論してくれます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: 型注釈なしでも型推論が働く</span>
<span class="k">let</span><span class="w"> </span><span class="nv">double</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1">// コンパイラは x が int であると推論</span>

<span class="k">let</span><span class="w"> </span><span class="nv">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="mi">1</span><span class="o">;</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="mi">4</span><span class="o">;</span><span class="w"> </span><span class="mi">5</span><span class="o">]</span>
<span class="k">let</span><span class="w"> </span><span class="nv">doubled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="kt">double</span><span class="w">  </span><span class="c1">// [2; 4; 6; 8; 10]</span>
</code></pre></div>
<p>「型注釈を書かなくていいなら、動的型付け言語と同じじゃない？」と思われるかもしれませんが、違います。F# は静的型付け言語なので、コンパイル時に型エラーを検出できます。型推論は、型の安全性を保ちながら、コードを簡潔に書けるようにするための機能です。</p>
<h4 id="fabletypescript">FableとTypeScriptの違い<a class="headerlink" href="#fabletypescript" title="Permanent link">&para;</a></h4>
<p>「TypeScriptも型安全なJavaScriptを提供してくれるよね？FableとTypeScriptの違いは何？」という疑問を持たれるかもしれません。良い質問ですね！</p>
<p><strong>1. 型システムの厳格さ</strong></p>
<p>TypeScript は JavaScript のスーパーセットとして設計されており、既存の JavaScript コードとの互換性を重視しています。そのため、型システムは比較的柔軟です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// TypeScript: any型で型安全性を回避できる</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">42</span><span class="p">;</span>
<span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hello&quot;</span><span class="p">;</span><span class="w">  </span><span class="c1">// OK</span>
<span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span><span class="p">();</span><span class="w">  </span><span class="c1">// コンパイルは通るが、実行時エラー</span>
</code></pre></div>
<p>対して F# の型システムはより厳格で、型安全性を重視しています：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: any型のような抜け道はない</span>
<span class="k">let</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>
<span class="c1">// value &lt;- &quot;hello&quot;  // コンパイルエラー！</span>
</code></pre></div>
<p><strong>2. イミュータブルがデフォルト</strong></p>
<p>TypeScript では、変数はデフォルトでミュータブル（変更可能）です：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// TypeScript: デフォルトでミュータブル</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// OK</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">};</span>
<span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w">  </span><span class="c1">// OK（constでもプロパティは変更できる）</span>
</code></pre></div>
<p>F# では、デフォルトでイミュータブルです：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: デフォルトでイミュータブル</span>
<span class="k">let</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="c1">// count &lt;- 1  // コンパイルエラー！</span>

<span class="k">type</span><span class="w"> </span><span class="nc">Point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">}</span>
<span class="k">let</span><span class="w"> </span><span class="nv">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="c1">// point.X &lt;- 10  // コンパイルエラー！</span>

<span class="c1">// 変更が必要な場合は明示的にmutableキーワードを使う</span>
<span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">mutableCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">mutableCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// OK</span>
</code></pre></div>
<p><strong>3. 関数型プログラミングの機能</strong></p>
<p>TypeScript も関数型プログラミングのスタイルをサポートしていますが、F# は最初から関数型言語として設計されています。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: パイプライン演算子で処理を連鎖</span>
<span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="mi">1</span><span class="o">;</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="mi">4</span><span class="o">;</span><span class="w"> </span><span class="mi">5</span><span class="o">]</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">sum</span>
<span class="w">    </span><span class="c1">// 30</span>
</code></pre></div>
<p>TypeScript では、メソッドチェーンを使いますが、F# のパイプライン演算子ほど読みやすくはありません：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// TypeScript: メソッドチェーン</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">]</span>
<span class="w">  </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
</code></pre></div>
<p><strong>4. パターンマッチング</strong></p>
<p>F# のパターンマッチングは、TypeScript の switch 文よりもはるかに強力です：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: 網羅的なパターンマッチング</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Shape</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Circle</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">radius</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">width</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Triangle</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">base</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span>

<span class="k">let</span><span class="w"> </span><span class="nv">getArea</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Circle</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Math</span><span class="p">.</span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">radius</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="o">(</span><span class="n">width</span><span class="o">,</span><span class="w"> </span><span class="n">height</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Triangle</span><span class="w"> </span><span class="o">(</span><span class="k">base</span><span class="o">,</span><span class="w"> </span><span class="n">height</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">base</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span>

<span class="c1">// ケースの漏れがあるとコンパイルエラー</span>
</code></pre></div>
<p>TypeScript では、同様の機能を実現するために、タグ付きユニオン型を使う必要があります：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// TypeScript: タグ付きユニオン型</span>
<span class="kr">type</span><span class="w"> </span><span class="nx">Shape</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;circle&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">radius</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rectangle&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;triangle&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">base</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">};</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">getArea</span><span class="p">(</span><span class="nx">shape</span><span class="o">:</span><span class="w"> </span><span class="kt">Shape</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">shape</span><span class="p">.</span><span class="nx">kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;circle&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">shape</span><span class="p">.</span><span class="nx">radius</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">shape</span><span class="p">.</span><span class="nx">radius</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;rectangle&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">shape</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">shape</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;triangle&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">shape</span><span class="p">.</span><span class="nx">base</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">shape</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ケースの漏れがあってもコンパイルエラーにならない</span>
<span class="c1">// (strictNullChecksを有効にすればエラーになる)</span>
</code></pre></div>
<h4 id="fable_1">Fableの仕組み<a class="headerlink" href="#fable_1" title="Permanent link">&para;</a></h4>
<p>「FableはどうやってF#をJavaScriptに変換しているの？」という疑問を持たれるかもしれませんね。簡単に説明しましょう。</p>
<p><strong>1. F#コンパイラの活用</strong></p>
<p>Fable は F# コンパイラ（F# Compiler Services）を使って、F# のコードを抽象構文木（AST）に変換します。これにより、F# の型システムや型推論の恩恵を受けることができます。</p>
<p><strong>2. JavaScriptへの変換</strong></p>
<p>Fable は AST を解析し、JavaScript のコードに変換します。この際、モダンな JavaScript (ES2015+) の機能を活用します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#のコード</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">}</span>

<span class="k">let</span><span class="w"> </span><span class="nv">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">}</span>
<span class="k">let</span><span class="w"> </span><span class="nv">newPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>このコードは、以下のような JavaScript に変換されます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Fableが生成するJavaScript</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Point</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Record</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">X</span><span class="p">,</span><span class="w"> </span><span class="nx">Y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">X</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Y</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Point</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span><span class="p">);</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">newPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Point</span><span class="p">(</span><span class="mf">30</span><span class="p">,</span><span class="w"> </span><span class="nx">point</span><span class="p">.</span><span class="nx">Y</span><span class="p">);</span>
</code></pre></div>
<p><strong>3. JavaScriptとの相互運用</strong></p>
<p>Fable の素晴らしい点は、既存の JavaScript ライブラリと簡単に連携できることです。Fable は JavaScript のエコシステムを活用できるように設計されています。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#からJavaScriptのライブラリを呼び出す</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Core</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Core.JsInterop</span>

<span class="c1">// JavaScript の console.log を呼び出す</span>
<span class="n">printfn</span><span class="w"> </span><span class="s">&quot;Hello, World!&quot;</span><span class="w">  </span><span class="c1">// F#の標準関数</span>

<span class="c1">// JavaScriptのDateオブジェクトを使う</span>
<span class="k">open</span><span class="w"> </span><span class="nn">System</span>

<span class="k">let</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">DateTime</span><span class="p">.</span><span class="n">Now</span>
<span class="n">printfn</span><span class="w"> </span><span class="s">&quot;Current time: %A&quot;</span><span class="w"> </span><span class="n">now</span>
</code></pre></div>
<h4 id="fable_2">Fableのメリット<a class="headerlink" href="#fable_2" title="Permanent link">&para;</a></h4>
<p>「結局、Fableを使うメリットは何？」とまとめたくなりますよね。以下がFableの主なメリットです：</p>
<ol>
<li><strong>型安全性</strong>: コンパイル時に多くのバグを防ぐ</li>
<li><strong>イミュータブルな設計</strong>: 予期しない状態変更を防ぐ</li>
<li><strong>パターンマッチング</strong>: 複雑な条件分岐を簡潔に書ける</li>
<li><strong>関数型プログラミング</strong>: 再利用可能で保守しやすいコード</li>
<li><strong>JavaScriptエコシステムとの統合</strong>: 既存のライブラリを活用できる</li>
<li><strong>モダンな開発体験</strong>: 強力な型推論とツールサポート</li>
</ol>
<p>「難しそう...」と思われるかもしれませんが、心配いりません。このチュートリアルを通じて、F# と Fable の基本を一緒に学んでいきましょう。テスト駆動開発の流れに沿って、一つずつ機能を実装していけば、自然と F# と Fable の使い方が身につきますよ！</p>
<h3 id="ffablemocha">テスティング: F#とFable.Mocha<a class="headerlink" href="#ffablemocha" title="Permanent link">&para;</a></h3>
<p>良いコードを書くためには、コードが正しく動作することを確認するテストが欠かせません。F# + Fableのテスト環境をセットアップしていきましょう。</p>
<h4 id="f">F#プロジェクトの作成<a class="headerlink" href="#f" title="Permanent link">&para;</a></h4>
<p>まず、F#プロジェクトの構造を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトディレクトリの作成</span>
mkdir<span class="w"> </span>puyo-puyo-fable
<span class="nb">cd</span><span class="w"> </span>puyo-puyo-fable

<span class="c1"># ソースとテストディレクトリの作成</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>src<span class="w"> </span>tests

<span class="c1"># F#プロジェクトファイルの作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>classlib<span class="w"> </span>-lang<span class="w"> </span>F#<span class="w"> </span>-o<span class="w"> </span>src<span class="w"> </span>-n<span class="w"> </span>PuyoPuyo
dotnet<span class="w"> </span>new<span class="w"> </span>console<span class="w"> </span>-lang<span class="w"> </span>F#<span class="w"> </span>-o<span class="w"> </span>tests<span class="w"> </span>-n<span class="w"> </span>PuyoPuyo.Tests
</code></pre></div>
<h4 id="fable_3">Fableのセットアップ<a class="headerlink" href="#fable_3" title="Permanent link">&para;</a></h4>
<p>Fableを使用するために必要なパッケージをインストールします：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ソースプロジェクトへFableパッケージを追加</span>
<span class="nb">cd</span><span class="w"> </span>src
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>Fable.Core
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>Fable.Browser.Dom
<span class="nb">cd</span><span class="w"> </span>..

<span class="c1"># テストプロジェクトへFable.Mochaを追加</span>
<span class="nb">cd</span><span class="w"> </span>tests
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>Fable.Mocha
dotnet<span class="w"> </span>add<span class="w"> </span>reference<span class="w"> </span>../src/PuyoPuyo.fsproj
<span class="nb">cd</span><span class="w"> </span>..
</code></pre></div>
<h4 id="packagejson">package.jsonの作成<a class="headerlink" href="#packagejson" title="Permanent link">&para;</a></h4>
<p>npmパッケージの管理とスクリプトの定義のため、プロジェクトルートに<code>package.json</code>を作成します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>init<span class="w"> </span>-y
</code></pre></div>
<p><code>package.json</code>の<code>"scripts"</code>セクションを以下のように編集します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;puyo-puyo-fable&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;private&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;module&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;install-deps&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dotnet tool restore &amp;&amp; dotnet restore&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vite&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dotnet fable src -o dist/src &amp;&amp; vite build&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;preview&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vite preview&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dotnet fable tests -o dist/tests --run mocha dist/tests&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dotnet fable watch tests -o dist/tests --run mocha dist/tests&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;clean&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rm -rf dist&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;setup&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm install &amp;&amp; npm run install-deps&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;vite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;mocha&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^10.2.0&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_10">開発依存パッケージのインストール<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install
</code></pre></div>
<h4 id="net">.NET ツールの設定<a class="headerlink" href="#net" title="Permanent link">&para;</a></h4>
<p>プロジェクトローカルでFableを使用するため、<code>.config/dotnet-tools.json</code>を作成します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>new<span class="w"> </span>tool-manifest
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>fable
</code></pre></div>
<h3 id="_11">自動化: コード品質の自動管理<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質を自動的にチェックし、維持していく仕組みが必要です。F#エコシステムのツールを活用しましょう。</p>
<h4 id="fantomas">コードフォーマッタ: Fantomas<a class="headerlink" href="#fantomas" title="Permanent link">&para;</a></h4>
<p>F#のコードフォーマットを統一するために <strong>Fantomas</strong> を使います。</p>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>—  リーダブルコード</p>
</blockquote>
<p>Fantomasのインストール：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>fantomas
</code></pre></div>
<p><code>package.json</code>にフォーマット用のスクリプトを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dotnet fantomas src tests&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format:check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dotnet fantomas src tests --check&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>フォーマットの実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>format:check<span class="w">  </span><span class="c1"># チェックのみ</span>
npm<span class="w"> </span>run<span class="w"> </span>format<span class="w">        </span><span class="c1"># 自動修正</span>
</code></pre></div>
<h4 id="fsharplint">静的コード解析: FSharpLint<a class="headerlink" href="#fsharplint" title="Permanent link">&para;</a></h4>
<p>静的コード解析ツールとして <strong>FSharpLint</strong> を使います。</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>dotnet-fsharplint
</code></pre></div>
<p>プロジェクトルートに<code>fsharplint.json</code>を作成して、ルールをカスタマイズします：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;ignoreFiles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;**/obj/**/*.fs&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;**/bin/**/*.fs&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;hints&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;add&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;formatting&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;typedItemSpacing&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;typePrefixing&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;conventions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;naming&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;nestedStatements&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;depth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;cyclomaticComplexity&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;maxComplexity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>package.json</code>にlint用のスクリプトを追加：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dotnet fsharplint lint PuyoPuyo.sln&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>静的解析の実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>lint
</code></pre></div>
<h4 id="_12">テストカバレッジ<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>F#でのコードカバレッジ測定には、通常.NETエコシステムの<strong>coverlet</strong>や<strong>altcover</strong>を使用します。Fableプロジェクトでは、テストの実行とカバレッジを確認するために、まずテストが正しく動作することを確認しましょう。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<h3 id="vite">Viteの設定<a class="headerlink" href="#vite" title="Permanent link">&para;</a></h3>
<p>ブラウザでゲームを実行するため、Viteの設定ファイル<code>vite.config.js</code>をプロジェクトルートに作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineConfig</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vite&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineConfig</span><span class="p">({</span>
<span class="w">  </span><span class="nx">root</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./public&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">publicDir</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;../public&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">build</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">outDir</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;../dist&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">emptyOutDir</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">server</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="mf">3000</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
<p><code>public</code>ディレクトリとHTMLファイルを作成：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>public
</code></pre></div>
<p><code>public/index.html</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;ja&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ぷよぷよ - F# Fable版<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">        </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#f0f0f0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">#</span><span class="nn">game-container</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">            </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">            </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">            </span><span class="k">min-height</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="kt">vh</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">canvas</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#333</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#fff</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;game-container&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;game-canvas&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;320&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;640&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/dist/src/App.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="_13">プロジェクト構造の確認<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>ここまでで、以下のようなプロジェクト構造ができているはずです：</p>
<div class="highlight"><pre><span></span><code>puyo-puyo-fable/
├── .config/
│   └── dotnet-tools.json
├── src/
│   ├── PuyoPuyo.fsproj
│   └── Library.fs (後でApp.fsに変更)
├── tests/
│   ├── PuyoPuyo.Tests.fsproj
│   └── Program.fs (後でTests.fsに変更)
├── public/
│   └── index.html
├── package.json
├── vite.config.js
└── fsharplint.json
</code></pre></div>
<h3 id="_14">初期テストの作成<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発を始めるため、簡単なテストを作成しましょう。</p>
<p><code>tests/Tests.fs</code>を作成：</p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;初期テスト&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;サンプルテスト - 1 + 1 は 2&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;1 + 1 は 2 であるべき&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nn">Mocha</span><span class="p">.</span><span class="n">runTests</span><span class="w"> </span><span class="n">tests</span>
</code></pre></div>
<p><code>tests/PuyoPuyo.Tests.fsproj</code>を編集して、テストファイルを含めます：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;OutputType&gt;</span>Exe<span class="nt">&lt;/OutputType&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net8.0<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Tests.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Fable.Mocha&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;2.17.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;ProjectReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;..\src\PuyoPuyo.fsproj&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  初期テスト
    ✓ サンプルテスト - 1 + 1 は 2

  1 passing (Xms)
</code></pre></div>
<h3 id="_15">環境構築の完了<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！これで開発環境のセットアップが完了しました。以下のツールが使えるようになりました：</p>
<ul>
<li><strong>バージョン管理</strong>: Git（Conventional Commits形式）</li>
<li><strong>テスティング</strong>: Fable.Mocha</li>
<li><strong>静的コード解析</strong>: FSharpLint（循環的複雑度チェック付き）</li>
<li><strong>コードフォーマット</strong>: Fantomas</li>
<li><strong>ビルドツール</strong>: Vite</li>
<li><strong>Webコンパイラ</strong>: Fable</li>
</ul>
<p>これで、F# + Fableでぷよぷよゲームを開発するための基盤が整いました。次のイテレーションから、実際のゲーム機能の実装に入っていきましょう！</p>
<h3 id="_16">環境確認チェックリスト<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>最後に、環境が正しくセットアップできているか確認しましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>npm run test</code> でテストが実行できる</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>npm run format</code> でコードフォーマットができる</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>npm run lint</code> で静的解析が実行できる</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>npm run dev</code> で開発サーバーが起動できる</li>
<li class="task-list-item"><input type="checkbox" disabled/> ブラウザで http://localhost:3000 にアクセスできる</li>
</ul>
<p>すべてチェックできたら、環境構築は完了です。さあ、テスト駆動開発でぷよぷよゲームを作っていきましょう！</p>
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_17">ユーザーストーリー<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ゲームの初期化処理を実装する（ゲームの状態を設定する）</li>
<li>ゲーム画面を表示する（プレイヤーが視覚的にゲームを認識できるようにする）</li>
<li>新しいぷよを生成する（ゲーム開始時に最初のぷよを作成する）</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ゲームの初期化処理」から始めましょう！</p>
<h3 id="_18">テスト: ゲームの初期化<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「ゲームの初期化処理を実装する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ゲームの初期化処理をテストするコードを書いてみましょう。何をテストすべきでしょうか？ゲームが初期化されたとき、ゲームの状態が適切に設定されていることを確認する必要がありますね。</p>
<p>F#では、テストをモジュールとして記述し、Fable.Mochaを使用します。まず<code>tests/GameTests.fs</code>を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/GameTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.GameTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Game</span>

<span class="k">let</span><span class="w"> </span><span class="nv">gameInitTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ゲームの初期化&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;ゲームを初期化すると、ゲームステートが作成される&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">gameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Game</span><span class="p">.</span><span class="n">init</span><span class="bp">()</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isNotNull</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="s">&quot;ゲームステートが作成されるべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;ゲームを初期化すると、ステージが6列12行で作成される&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">gameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Game</span><span class="p">.</span><span class="n">init</span><span class="bp">()</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="s">&quot;ステージは6列であるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="s">&quot;ステージは12行であるべき&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ゲーム&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gameInitTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>このテストでは、<code>Game.init()</code>関数が正しく動作することを確認しています。具体的には、ゲームステートが作成され、ステージが6列12行で作成されることを検証しています。</p>
<p>F#では、関数型プログラミングのアプローチで、イミュータブルなデータ構造を使用します。これにより、予測可能で安全なコードを書くことができます。</p>
<h3 id="_19">実装: ゲームの初期化<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Error: Cannot find module &#39;PuyoPuyo.Game&#39;
</code></pre></div>
<p>おっと！まだ<code>Game</code>モジュールを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<blockquote>
<p>アサートファースト</p>
<p>ではテストはどこから書き始めるべきだろうか。それはテストの終わりにパスすべきアサーションを書くところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストが通るように最小限のコードを実装していきましょう。「最小限」というのがポイントです。この段階では、テストが通ることだけを目指して、必要最低限のコードを書きます。</p>
<p>まず、型定義を作成します。<code>src/Types.fs</code>を作成：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Types.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Types</span>

<span class="sd">/// ぷよの色</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Purple</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span>

<span class="sd">/// 位置</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="o">}</span>

<span class="sd">/// ぷよ</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span>
<span class="w">    </span><span class="n">Position</span><span class="o">:</span><span class="w"> </span><span class="n">Position</span>
<span class="o">}</span>
</code></pre></div>
<p>次に、ステージモジュールを作成します。<code>src/Stage.fs</code>を作成：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Stage</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Types</span>

<span class="sd">/// ステージの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">StageState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Cells</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">array</span>
<span class="w">    </span><span class="n">Rows</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Cols</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="o">}</span>

<span class="sd">/// ステージを作成する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">create</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span>
<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cells</span>
<span class="w">        </span><span class="n">Rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows</span>
<span class="w">        </span><span class="n">Cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cols</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<p>次に、ゲームモジュールを作成します。<code>src/Game.fs</code>を作成：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Game</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Types</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Stage</span>

<span class="sd">/// ゲームの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="o">}</span>

<span class="sd">/// ゲームを初期化する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">        </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<h3 id="_20">解説: ゲームの初期化<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>さあ、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>F#での実装について、少し解説しておきましょう。この処理では、主に以下のことを行っています：</p>
<ol>
<li><strong>イミュータブルなデータ構造</strong>: F#では、デフォルトで値がイミュータブル（変更不可）です。これにより、予期せぬ副作用を避けられます。</li>
<li><strong>判別共用体（Discriminated Union）</strong>: <code>PuyoColor</code>は判別共用体として定義されています。これにより、型安全な状態管理が可能になります。</li>
<li><strong>レコード型</strong>: <code>GameState</code>や<code>StageState</code>はレコード型として定義されています。これにより、構造化されたデータを扱いやすくなります。</li>
</ol>
<p>各コンポーネントの役割：</p>
<ul>
<li><strong>GameState</strong>: ゲームの全体的な状態を管理します（ステージ、スコア）</li>
<li><strong>StageState</strong>: ゲームのステージ（盤面）を管理します（セルの配置状態、行数、列数）</li>
<li><strong>Types</strong>: ゲーム全体で使用する型定義を集約します</li>
</ul>
<p>このように、責任を明確に分けることで、コードの保守性が高まります。これは関数型プログラミングにおける「関心の分離」に従っています。</p>
<h3 id="_21">プロジェクトファイルの更新<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>F#プロジェクトでは、ファイルの順序が重要です。<code>src/PuyoPuyo.fsproj</code>を更新して、正しい順序でファイルをコンパイルするようにします：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net8.0<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Types.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Stage.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Game.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Fable.Core&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;4.0.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Fable.Browser.Dom&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;2.14.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<p>テストプロジェクトファイル<code>tests/PuyoPuyo.Tests.fsproj</code>も更新：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;OutputType&gt;</span>Exe<span class="nt">&lt;/OutputType&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net8.0<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;GameTests.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Tests.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Fable.Mocha&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;2.17.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;ProjectReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;..\src\PuyoPuyo.fsproj&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<h3 id="_22">テストの更新<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>テストモジュールも更新して、すべてのテストを実行できるようにします。<code>tests/Tests.fs</code>を更新：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/Tests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.GameTests</span>

<span class="k">let</span><span class="w"> </span><span class="nv">allTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;すべてのテスト&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="nn">GameTests</span><span class="p">.</span><span class="n">tests</span>
<span class="w">    </span><span class="o">]</span>

<span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nn">Mocha</span><span class="p">.</span><span class="n">runTests</span><span class="w"> </span><span class="n">allTests</span>
</code></pre></div>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  ゲーム
    ゲームの初期化
      ✓ ゲームを初期化すると、ゲームステートが作成される
      ✓ ゲームを初期化すると、ステージが6列12行で作成される

  2 passing (Xms)
</code></pre></div>
<h3 id="1_1">イテレーション 1 のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>型定義の実装</strong></li>
<li>判別共用体による型安全な状態管理（<code>PuyoColor</code>）</li>
<li>
<p>レコード型による構造化データ（<code>GameState</code>、<code>StageState</code>、<code>Position</code>、<code>Puyo</code>）</p>
</li>
<li>
<p><strong>Stage モジュールの実装</strong></p>
</li>
<li><code>create</code>関数によるステージの初期化</li>
<li>
<p>6列12行の空のステージを作成</p>
</li>
<li>
<p><strong>Game モジュールの実装</strong></p>
</li>
<li>イミュータブルな<code>GameState</code>レコードの定義</li>
<li>
<p><code>init</code>関数による初期状態の作成</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>Fable.Mochaを使用したテスト</li>
<li>ゲーム初期化のテスト（2 テスト）</li>
<li>すべてのテストが成功</li>
</ol>
<p>F#の関数型プログラミングの特徴を活かして、型安全でシンプルな実装ができました。次のイテレーションでは、ぷよの移動機能を実装していきます。</p>
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームの基本的な構造ができましたね。「ゲームが始まったけど、ぷよが動かないと面白くないよね？」と思いませんか？そこで次は、ぷよを左右に移動できるようにしていきましょう！</p>
<h3 id="_23">ユーザーストーリー<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「ぷよぷよって、落ちてくるぷよを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「左右の移動」を実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。
「ぷよを左右に移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>現在のぷよの状態を管理する（位置や色）</li>
<li>ぷよを左右に移動する処理を実装する（実際にぷよの位置を変更する）</li>
<li>移動可能かどうかのチェックを実装する（画面の端にぶつかる場合は移動できないようにする）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_24">テスト: ぷよの作成<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよを作成できるかどうかをテストしていきましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><code>tests/PlayerTests.fs</code>を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.PlayerTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Types</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Player</span>

<span class="k">let</span><span class="w"> </span><span class="nv">playerTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;プレイヤー&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;新しいぷよを作成すると、初期位置に配置される&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyo</span><span class="bp">()</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;ぷよのX座標は2（中央）であるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;ぷよのY座標は0（一番上）であるべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;新しいぷよを作成すると、色が設定される&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyo</span><span class="bp">()</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">notEqual</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Color</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;ぷよの色は空ではないべき&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;プレイヤー機能&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">playerTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>このテストでは、<code>Player.createNewPuyo()</code>関数が正しく動作することを確認しています。具体的には、ぷよが中央の初期位置に作成され、適切な色が設定されることを検証しています。</p>
<h3 id="_25">実装: ぷよの作成<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Error: Cannot find module &#39;PuyoPuyo.Player&#39;
</code></pre></div>
<p>おっと！まだ<code>Player</code>モジュールを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<p>では、テストが通るように最小限のコードを実装していきましょう。<code>src/Player.fs</code>を作成：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Player</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Types</span>

<span class="sd">/// 新しいぷよを作成する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">createNewPuyo</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Puyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[|</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="w"> </span><span class="o">|]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="n">Random</span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="o">.[</span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="o">)]</span>

<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span>
<span class="w">        </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<p>「シンプルですね！」そうです。F#では、関数型プログラミングのスタイルで簡潔に書けます。ランダムな色を選んで、初期位置（X=2, Y=0）にぷよを作成しています。</p>
<h3 id="_26">テスト: ぷよの移動<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>次は、ぷよを左右に移動する機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">puyoMoveTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ぷよの移動&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;左に移動できる場合、左に移動する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyo</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">moveLeft</span><span class="w"> </span><span class="n">puyo</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">movedPuyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;X座標が1減るべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;右に移動できる場合、右に移動する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyo</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">moveRight</span><span class="w"> </span><span class="n">puyo</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">movedPuyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;X座標が1増えるべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;左端にいる場合、左に移動できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyo</span><span class="bp">()</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">moveLeft</span><span class="w"> </span><span class="n">puyo</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">movedPuyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;X座標は変わらないべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;右端にいる場合、右に移動できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyo</span><span class="bp">()</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">moveRight</span><span class="w"> </span><span class="n">puyo</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">movedPuyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="s">&quot;X座標は変わらないべき&quot;</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の4つのケースを確認しています：</p>
<ol>
<li>通常の状態で左に移動できるか</li>
<li>通常の状態で右に移動できるか</li>
<li>左端にいるときに左に移動しようとしても位置が変わらないか</li>
<li>右端にいるときに右に移動しようとしても位置が変わらないか</li>
</ol>
<p>「F#では<code>with</code>キーワードを使ってレコードを更新しているんですね！」そうです！F#では、イミュータブルなレコードを扱うため、<code>with</code>キーワードで一部のフィールドだけを変更した新しいレコードを作成します。これが関数型プログラミングの特徴です。</p>
<h3 id="_27">実装: ぷよの移動<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを移動させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（続き）</span>

<span class="sd">/// ぷよを左に移動する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">moveLeft</span><span class="w"> </span><span class="o">(</span><span class="n">puyo</span><span class="o">:</span><span class="w"> </span><span class="n">Puyo</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stageCols</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Puyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">puyo</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">puyo</span>

<span class="sd">/// ぷよを右に移動する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">moveRight</span><span class="w"> </span><span class="o">(</span><span class="n">puyo</span><span class="o">:</span><span class="w"> </span><span class="n">Puyo</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stageCols</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Puyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stageCols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">puyo</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyo</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">puyo</span>
</code></pre></div>
<p>「なるほど！イミュータブルなデータ構造なので、元のぷよは変更せずに、新しいぷよを返しているんですね！」その通りです！F#では、データを変更する代わりに、変更された新しいデータを返します。これにより、予期せぬ副作用を防ぎ、コードの推論が容易になります。</p>
<blockquote>
<p>仮実装を経て本実装へ</p>
<p>失敗するテストを書いてから、最初に行う実装はどのようなものだろうか - ベタ書きの値を返そう。
それでテストが通るようになったら、ベタ書きの値をだんだん本物の式や変数に置き換えていく。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「移動の処理はシンプルですね！」そうですね。<code>moveLeft</code>関数では左端（X座標が0）でなければX座標を1減らし、<code>moveRight</code>関数では右端（X座標がステージの幅-1）でなければX座標を1増やしています。どちらの場合も、移動できない場合は元のぷよをそのまま返します。</p>
<h3 id="_28">プロジェクトファイルの更新<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p><code>src/PuyoPuyo.fsproj</code>を更新して、<code>Player.fs</code>を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net8.0<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Types.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Stage.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Player.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Game.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Fable.Core&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;4.0.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Fable.Browser.Dom&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;2.14.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<p>テストプロジェクトファイル<code>tests/PuyoPuyo.Tests.fsproj</code>も更新：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;OutputType&gt;</span>Exe<span class="nt">&lt;/OutputType&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net8.0<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;GameTests.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;PlayerTests.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Tests.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Fable.Mocha&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;2.17.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;ProjectReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;..\src\PuyoPuyo.fsproj&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<h3 id="_29">テストの更新<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p><code>tests/Tests.fs</code>を更新して、PlayerTestsを追加：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/Tests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.GameTests</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.PlayerTests</span>

<span class="k">let</span><span class="w"> </span><span class="nv">allTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;すべてのテスト&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="nn">GameTests</span><span class="p">.</span><span class="n">tests</span>
<span class="w">        </span><span class="nn">PlayerTests</span><span class="p">.</span><span class="n">tests</span>
<span class="w">    </span><span class="o">]</span>

<span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nn">Mocha</span><span class="p">.</span><span class="n">runTests</span><span class="w"> </span><span class="n">allTests</span>
</code></pre></div>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  ゲーム
    ゲームの初期化
      ✓ ゲームを初期化すると、ゲームステートが作成される
      ✓ ゲームを初期化すると、ステージが6列12行で作成される

  プレイヤー機能
    プレイヤー
      ✓ 新しいぷよを作成すると、初期位置に配置される
      ✓ 新しいぷよを作成すると、色が設定される
    ぷよの移動
      ✓ 左に移動できる場合、左に移動する
      ✓ 右に移動できる場合、右に移動する
      ✓ 左端にいる場合、左に移動できない
      ✓ 右端にいる場合、右に移動できない

  8 passing (Xms)
</code></pre></div>
<h3 id="_30">解説: イミュータブルなデータ構造の利点<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>「これでテストは通りましたか？」はい、すべてのテストが通りました！これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>F#のイミュータブルなデータ構造について、少し詳しく解説しましょう：</p>
<ol>
<li><strong>予測可能性</strong>: データが変更されないため、関数の結果が常に同じ入力に対して同じ出力を返します</li>
<li><strong>並行処理の安全性</strong>: データ競合が発生しないため、マルチスレッド環境でも安全です</li>
<li><strong>テストのしやすさ</strong>: 副作用がないため、テストが簡単に書けます</li>
<li><strong>履歴の追跡</strong>: 過去の状態を保持できるため、Undo/Redo機能が実装しやすくなります</li>
</ol>
<p>「でも、毎回新しいオブジェクトを作るのは効率が悪くないですか？」良い質問ですね！実は、F#コンパイラとランタイムは、構造共有（Structural Sharing）という技術を使って、変更されていない部分は元のデータを再利用します。そのため、パフォーマンスへの影響は最小限です。</p>
<h3 id="2_1">イテレーション 2 のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>Player モジュールの実装</strong></li>
<li><code>createNewPuyo</code>関数による新しいぷよの作成</li>
<li>
<p>ランダムな色の選択</p>
</li>
<li>
<p><strong>ぷよの移動機能</strong></p>
</li>
<li><code>moveLeft</code>関数による左移動</li>
<li><code>moveRight</code>関数による右移動</li>
<li>
<p>画面端での移動制限</p>
</li>
<li>
<p><strong>イミュータブルなデータ更新</strong></p>
</li>
<li><code>with</code>キーワードによるレコードの部分更新</li>
<li>
<p>副作用のない関数型アプローチ</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ぷよ作成のテスト（2 テスト）</li>
<li>ぷよ移動のテスト（4 テスト）</li>
<li>すべてのテストが成功</li>
</ol>
<p>F#の関数型プログラミングの特徴であるイミュータブルなデータ構造を活かして、安全で予測可能な実装ができました。次のイテレーションでは、ぷよの回転機能を実装していきます。</p>
<h2 id="3">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_31">ユーザーストーリー<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、この2つのぷよの相対的な位置関係を変えることです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを回転させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>2つ目のぷよの型定義を追加する（軸ぷよと子ぷよ）</li>
<li>ぷよの回転処理を実装する（時計回りの回転）</li>
<li>回転可能かどうかのチェックを実装する（壁にぶつかる場合は回転できないようにする）</li>
<li>壁キック処理を実装する（壁際での回転を可能にする特殊処理）</li>
</ul>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_32">テスト: ぷよペアの定義<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは2つのぷよ（ペア）を表現する型のテストから書いていきましょう。</p>
<p><code>tests/PlayerTests.fs</code>に追加：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">puyoPairTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ぷよペア&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;新しいぷよペアを作成すると、軸ぷよと子ぷよが作成される&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;軸ぷよのX座標は2であるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;軸ぷよのY座標は0であるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">notEqual</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Color</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;軸ぷよの色は空ではないべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">notEqual</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Color</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;子ぷよの色は空ではないべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;初期状態では子ぷよは軸ぷよの上にある&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;子ぷよのX座標は2であるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="s">&quot;子ぷよのY座標は-1（上）であるべき&quot;</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<h3 id="_33">実装: ぷよペアの定義<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。当然エラーになりますね。これが「Red（赤）」の状態です。</p>
<p>では、型定義を追加しましょう。<code>src/Types.fs</code>を更新：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Types.fs（追加）</span>

<span class="sd">/// ぷよペア（軸ぷよと子ぷよ）</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Axis</span><span class="o">:</span><span class="w"> </span><span class="n">Puyo</span><span class="w">    </span><span class="c1">// 軸ぷよ（回転の中心）</span>
<span class="w">    </span><span class="n">Child</span><span class="o">:</span><span class="w"> </span><span class="n">Puyo</span><span class="w">   </span><span class="c1">// 子ぷよ（回転する）</span>
<span class="o">}</span>
</code></pre></div>
<p>次に、<code>src/Player.fs</code>を更新してぷよペアを作成する関数を実装：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Player</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Types</span>

<span class="sd">/// 新しいぷよペアを作成する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">createNewPuyoPair</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[|</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="w"> </span><span class="o">|]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="n">Random</span><span class="bp">()</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="o">.[</span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="o">)]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="o">.[</span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="o">)]</span>

<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">axisColor</span>
<span class="w">            </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">        </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">childColor</span>
<span class="w">            </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">}</span><span class="w">  </span><span class="c1">// 軸ぷよの上</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<p>「子ぷよのY座標が-1なんですね！」そうです。初期状態では、子ぷよは軸ぷよの真上にあります。Y座標が-1ということは、画面の外（上部）にいることになります。</p>
<h3 id="_34">テスト: ぷよの回転<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>次は、ぷよを回転する機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">puyoRotationTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ぷよの回転&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;時計回りに回転すると、子ぷよが右に移動する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="s">&quot;子ぷよのX座標は3（右）であるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;子ぷよのY座標は0であるべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;2回時計回りに回転すると、子ぷよが下に移動する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">puyoPair</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;子ぷよのX座標は2であるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">&quot;子ぷよのY座標は1（下）であるべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;4回時計回りに回転すると、元の位置に戻る&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">puyoPair</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;子ぷよのX座標は2であるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="s">&quot;子ぷよのY座標は-1（上）であるべき&quot;</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>1回回転すると、子ぷよが軸ぷよの右に移動するか</li>
<li>2回回転すると、子ぷよが軸ぷよの下に移動するか</li>
<li>4回回転すると、元の位置（上）に戻るか</li>
</ol>
<p>「パイプライン演算子<code>|&gt;</code>を使って回転を連鎖させているんですね！」そうです！F#では、パイプライン演算子を使って処理を連鎖させることができます。これにより、データの流れが明確になります。</p>
<h3 id="_35">実装: ぷよの回転<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを回転させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（続き）</span>

<span class="sd">/// 回転方向</span>
<span class="k">type</span><span class="w"> </span><span class="nc">RotationDirection</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Up</span><span class="w">      </span><span class="c1">// 上: (0, -1)</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span><span class="w">   </span><span class="c1">// 右: (1, 0)</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span><span class="w">    </span><span class="c1">// 下: (0, 1)</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span><span class="w">    </span><span class="c1">// 左: (-1, 0)</span>

<span class="sd">/// 時計回りに回転方向を取得</span>
<span class="k">let</span><span class="w"> </span><span class="nv">rotateDirectionClockwise</span><span class="w"> </span><span class="o">(</span><span class="n">direction</span><span class="o">:</span><span class="w"> </span><span class="n">RotationDirection</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">RotationDirection</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Up</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Right</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Down</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Left</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Up</span>

<span class="sd">/// 回転方向から相対座標を取得</span>
<span class="k">let</span><span class="w"> </span><span class="nv">getOffset</span><span class="w"> </span><span class="o">(</span><span class="n">direction</span><span class="o">:</span><span class="w"> </span><span class="n">RotationDirection</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Up</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">)</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>

<span class="sd">/// 現在の回転方向を取得（軸ぷよと子ぷよの位置から計算）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">getCurrentDirection</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">RotationDirection</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="o">(</span><span class="n">dx</span><span class="o">,</span><span class="w"> </span><span class="n">dy</span><span class="o">)</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Up</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Right</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Down</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Left</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Up</span><span class="w">  </span><span class="c1">// デフォルト</span>

<span class="sd">/// ぷよペアを時計回りに回転する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">rotateRight</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stageCols</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">currentDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCurrentDirection</span><span class="w"> </span><span class="n">puyoPair</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotateDirectionClockwise</span><span class="w"> </span><span class="n">currentDirection</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">offsetX</span><span class="o">,</span><span class="w"> </span><span class="n">offsetY</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOffset</span><span class="w"> </span><span class="n">newDirection</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newChildX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newChildY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetY</span>

<span class="w">    </span><span class="c1">// 壁キック処理</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">adjustedAxisX</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">newChildX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 左壁キック</span>
<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="n">newChildX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stageCols</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 右壁キック</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">finalChildX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adjustedAxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span>

<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adjustedAxisX</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">finalChildX</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newChildY</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<p>「なるほど！判別共用体で回転方向を表現しているんですね！」その通りです！F#では、判別共用体を使って状態を型安全に表現できます。これにより、コンパイル時に多くのエラーを検出できます。</p>
<p>「パターンマッチングで回転処理を実装しているのもわかりやすいですね！」そうです！パターンマッチングを使うことで、各方向に対する処理が明確になります。また、網羅性チェックにより、すべてのケースを処理することが保証されます。</p>
<h3 id="_36">テスト: 壁キック処理<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>「壁キック処理のテストはどうやって書くんですか？」壁キック処理は、ぷよが壁際にあるときに回転すると自動的に位置を調整する機能です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">wallKickTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;壁キック処理&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;右端で右向きに回転すると、左に移動して回転する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span><span class="w">  </span><span class="c1">// 上向き</span>
<span class="w">            </span><span class="o">}</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="s">&quot;軸ぷよが左にキックされるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="s">&quot;子ぷよが右にあるべき&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;左端で左向きに回転すると、右に移動して回転する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span><span class="w">  </span><span class="c1">// 上向き</span>
<span class="w">            </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 3回回転して左向きにする</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">leftwardPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">puyoPair</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="c1">// さらに1回回転（左向き→上向き）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="n">leftwardPair</span><span class="w"> </span><span class="mi">6</span>

<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">&quot;軸ぷよが右にキックされるべき&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">&quot;子ぷよが上にあるべき&quot;</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>右端にいるときに右向きに回転すると、左に1マス移動して回転するか</li>
<li>左端にいるときに左向きから上向きに回転すると、右に1マス移動して回転するか</li>
</ol>
<h3 id="_37">プロジェクトファイルとテストの更新<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>テストを更新して、新しいテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（更新）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;プレイヤー機能&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">playerTests</span>
<span class="w">        </span><span class="n">puyoMoveTests</span>
<span class="w">        </span><span class="n">puyoPairTests</span>
<span class="w">        </span><span class="n">puyoRotationTests</span>
<span class="w">        </span><span class="n">wallKickTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  ゲーム
    ゲームの初期化
      ✓ ゲームを初期化すると、ゲームステートが作成される
      ✓ ゲームを初期化すると、ステージが6列12行で作成される

  プレイヤー機能
    プレイヤー
      ✓ 新しいぷよを作成すると、初期位置に配置される
      ✓ 新しいぷよを作成すると、色が設定される
    ぷよの移動
      ✓ 左に移動できる場合、左に移動する
      ✓ 右に移動できる場合、右に移動する
      ✓ 左端にいる場合、左に移動できない
      ✓ 右端にいる場合、右に移動できない
    ぷよペア
      ✓ 新しいぷよペアを作成すると、軸ぷよと子ぷよが作成される
      ✓ 初期状態では子ぷよは軸ぷよの上にある
    ぷよの回転
      ✓ 時計回りに回転すると、子ぷよが右に移動する
      ✓ 2回時計回りに回転すると、子ぷよが下に移動する
      ✓ 4回時計回りに回転すると、元の位置に戻る
    壁キック処理
      ✓ 右端で右向きに回転すると、左に移動して回転する
      ✓ 左端で左向きに回転すると、右に移動して回転する

  15 passing (Xms)
</code></pre></div>
<h3 id="_38">解説: 判別共用体とパターンマッチング<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通りましたね！」はい、これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>F#の判別共用体とパターンマッチングについて、少し詳しく解説しましょう：</p>
<ol>
<li><strong>型安全性</strong>: <code>RotationDirection</code>は4つの値しか取れないため、不正な値が入ることがありません</li>
<li><strong>網羅性チェック</strong>: パターンマッチングで全ケースを処理しているかコンパイラがチェックします</li>
<li><strong>可読性</strong>: <code>Up</code>, <code>Right</code>, <code>Down</code>, <code>Left</code>という名前により、コードの意図が明確です</li>
<li><strong>保守性</strong>: 新しい方向を追加する場合、コンパイラが未処理のケースを教えてくれます</li>
</ol>
<p>「これがTypeScriptの数値による回転状態管理と違うところですね！」その通りです。TypeScriptでは<code>0, 1, 2, 3</code>という数値で管理しますが、F#では意味のある名前を持つ判別共用体で管理します。これにより、コードの可読性と保守性が向上します。</p>
<h3 id="3_1">イテレーション 3 のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>型定義の拡張</strong></li>
<li><code>PuyoPair</code>レコード型の追加（軸ぷよと子ぷよ）</li>
<li>
<p><code>RotationDirection</code>判別共用体の追加（4方向の回転状態）</p>
</li>
<li>
<p><strong>ぷよペアの作成</strong></p>
</li>
<li><code>createNewPuyoPair</code>関数による2つのぷよの生成</li>
<li>
<p>軸ぷよと子ぷよの初期配置</p>
</li>
<li>
<p><strong>回転機能</strong></p>
</li>
<li><code>rotateRight</code>関数による時計回りの回転</li>
<li>判別共用体とパターンマッチングによる回転処理</li>
<li>
<p>相対座標計算による子ぷよの位置更新</p>
</li>
<li>
<p><strong>壁キック処理</strong></p>
</li>
<li>壁際での回転時の自動位置調整</li>
<li>
<p>左壁キックと右壁キックの実装</p>
</li>
<li>
<p><strong>関数型プログラミングの活用</strong></p>
</li>
<li>パイプライン演算子による処理の連鎖</li>
<li>イミュータブルなデータ更新</li>
<li>
<p>パターンマッチングによる明確な制御フロー</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ぷよペアのテスト（2 テスト）</li>
<li>回転機能のテスト（3 テスト）</li>
<li>壁キック処理のテスト（2 テスト）</li>
<li>すべてのテストが成功</li>
</ol>
<p>F#の判別共用体とパターンマッチングを活かして、型安全で読みやすい回転処理を実装できました。次のイテレーションでは、ぷよの自由落下機能を実装していきます。</p>
<h2 id="4">イテレーション 4: ぷよの自由落下の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよって自動的に落ちてくるよね？」そうですね！ぷよぷよでは、ぷよが一定の時間間隔で自動的に落下していきます。今回は、その「自由落下」機能を実装していきましょう！</p>
<h3 id="_39">ユーザーストーリー<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとして、ぷよを一定間隔で自動的に落下させることができる</p>
</blockquote>
<p>「時間が経つと勝手に落ちていくあの動きですね！」その通りです。プレイヤーが操作しなくても、ぷよが自動的に落下していく仕組みを実装します。</p>
<h3 id="todo_3">TODO リスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ぷよを一定間隔で落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>落下タイマーの実装（経過時間を管理する）</li>
<li>自動落下処理の実装（一定時間ごとに 1 マス下に移動）</li>
<li>落下可能判定の実装（下に移動できるかチェック）</li>
<li>着地処理の実装（着地したらステージに固定）</li>
<li>ステージへの固定処理（着地したぷよをステージに配置）</li>
<li>重力処理の実装（ステージ上のぷよに重力を適用）</li>
<li>ゲームループとの統合（時間経過を管理）</li>
</ul>
<p>「結構たくさんありますね！」そうですね。でも、一つずつテスト駆動開発の流れに沿って進めていけば大丈夫です。まずはテストから書いていきますよ。</p>
<h3 id="_40">テスト: 自由落下<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよペアが下に移動できるかどうかをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（続き）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PlayerTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Types</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Player</span>

<span class="k">let</span><span class="w"> </span><span class="nv">freeFallTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;自由落下&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;下に移動できる場合、1マス下に移動する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span>

<span class="w">            </span><span class="c1">// 下に移動</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span>

<span class="w">            </span><span class="c1">// 1マス下に移動していることを確認</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">movedPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">(</span><span class="n">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;軸ぷよが下に移動している&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">movedPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;子ぷよが下に移動している&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;下端に達している場合、移動できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 軸ぷよを下端に配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoAtBottom</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">canMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">canMoveDown</span><span class="w"> </span><span class="n">puyoAtBottom</span><span class="w"> </span><span class="n">stage</span>

<span class="w">            </span><span class="c1">// 移動できないことを確認</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isFalse</span><span class="w"> </span><span class="n">canMove</span><span class="w"> </span><span class="s">&quot;下端では移動できない&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;子ぷよが下端に達している場合、移動できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 子ぷよを下端に配置（上向き→右回転で下向き→右回転で下向き）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">puyoPair</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">rotateRight</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">rotateRight</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoAtBottom</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">rotatedPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">canMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">canMoveDown</span><span class="w"> </span><span class="n">puyoAtBottom</span><span class="w"> </span><span class="n">stage</span>

<span class="w">            </span><span class="c1">// 移動できないことを確認</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isFalse</span><span class="w"> </span><span class="n">canMove</span><span class="w"> </span><span class="s">&quot;子ぷよが下端では移動できない&quot;</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>通常の状態で下に移動できるか</li>
<li>軸ぷよがステージの下端にいるときに下に移動できないか</li>
<li>子ぷよがステージの下端にいるときに下に移動できないか</li>
</ol>
<p>「なるほど、ぷよペアの両方をチェックする必要があるんですね！」そうです！ぷよペアは2つのぷよで構成されているので、両方の位置を考慮する必要があります。では、このテストが通るように実装していきましょう。</p>
<h3 id="_41">実装: 落下判定と移動<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、下に移動できるかチェックする関数と、実際に移動する関数を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（続き）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Player</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Types</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Stage</span>

<span class="c1">// 下に移動できるかチェックする</span>
<span class="k">let</span><span class="w"> </span><span class="nv">canMoveDown</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 軸ぷよと子ぷよの両方が下端に達していないかチェック</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">axisNextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">childNextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">axisNextY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childNextY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">false</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="c1">// ステージ上のぷよとの衝突チェック（後で実装）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">axisNextCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">axisNextY</span><span class="o">].[</span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="o">]</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">childNextCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">childNextY</span><span class="o">].[</span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="o">]</span>

<span class="w">        </span><span class="n">axisNextCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">childNextCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span>

<span class="c1">// 下に移動する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">moveDown</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stageRows</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">      </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。F#のイミュータブルなデータ構造を活用して、新しいぷよペアを作成しています。<code>canMoveDown</code>関数では、軸ぷよと子ぷよの両方が下端に達していないか、そして下のセルが空かどうかをチェックしています。</p>
<p>「<code>with</code>キーワードを使っているんですね！」その通りです。F#の<code>with</code>キーワードを使うと、レコード型の一部だけを変更した新しいインスタンスを作成できます。元のデータは変更されないので、安全に処理できます。</p>
<h3 id="_42">テスト: 着地処理<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>「次は着地処理をテストしましょう！」はい、ぷよが着地したときにステージに固定される処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">landingTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;着地処理&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;着地したぷよはステージに固定される&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 軸ぷよを下から2番目、子ぷよを下端に配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoAtBottom</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">puyoPair</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">rotateRight</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w">  </span><span class="c1">// 右回転</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">rotateRight</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w">  </span><span class="c1">// 下向き</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">finalPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">puyoAtBottom</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoAtBottom</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoAtBottom</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// ステージに固定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixToStage</span><span class="w"> </span><span class="n">finalPair</span><span class="w"> </span><span class="n">stage</span>

<span class="w">            </span><span class="c1">// ステージに固定されていることを確認</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span>
<span class="w">                </span><span class="n">updatedStage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">finalPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="o">].[</span><span class="n">finalPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="o">]</span>
<span class="w">                </span><span class="n">finalPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Color</span>
<span class="w">                </span><span class="s">&quot;軸ぷよがステージに固定されている&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span>
<span class="w">                </span><span class="n">updatedStage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">finalPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="o">].[</span><span class="n">finalPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="o">]</span>
<span class="w">                </span><span class="n">finalPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Color</span>
<span class="w">                </span><span class="s">&quot;子ぷよがステージに固定されている&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;ステージ上のぷよの上には着地できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// ステージの(2, 11)に赤ぷよを配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w"> </span><span class="n">stage</span>

<span class="w">            </span><span class="c1">// (2, 10)に軸ぷよ、(2, 9)に子ぷよを配置（上向き）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoAbove</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">canMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">canMoveDown</span><span class="w"> </span><span class="n">puyoAbove</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 移動できないことを確認</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isFalse</span><span class="w"> </span><span class="n">canMove</span><span class="w"> </span><span class="s">&quot;ぷよの上には移動できない&quot;</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<h3 id="_43">実装: 着地処理<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>「着地処理を実装しましょう！」はい、ぷよペアをステージに固定する関数を実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（続き）</span>

<span class="c1">// ぷよペアをステージに固定する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">fixToStage</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">stage</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Color</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Color</span>
</code></pre></div>
<p>「パイプライン演算子を使っているんですね！」その通りです。<code>|&gt;</code>演算子を使うと、処理の流れを上から下に読みやすく表現できます。この例では、まず軸ぷよをステージに配置し、次に子ぷよを配置しています。</p>
<p>「でも、<code>Stage.setPuyo</code>関数はまだ実装していませんね？」鋭い指摘です！<code>Stage</code>モジュールに<code>setPuyo</code>関数を追加する必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.fs（続き）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Stage</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Types</span>

<span class="c1">// ぷよをステージに配置する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">setPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newCells</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">rowIndex</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">rowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="n">row</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">colIndex</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">colIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">cell</span><span class="o">)</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="n">row</span><span class="o">)</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCells</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// ぷよを取得する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">getPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span>
</code></pre></div>
<p>「配列全体をコピーして新しい配列を作るんですね！」そうです。F#の配列は変更可能ですが、イミュータブルなアプローチを維持するために、<code>Array.mapi</code>を使って新しい配列を作成しています。</p>
<h3 id="_44">テスト: 重力処理<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>「ぷよが着地したあと、浮いているぷよはどうなるんですか？」良い質問ですね！ステージ上のぷよにも重力を適用して、浮いているぷよを落下させる必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/StageTests.fs（新規作成）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">StageTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Types</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Stage</span>

<span class="k">let</span><span class="w"> </span><span class="nv">gravityTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;重力処理&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;個別のぷよに重力が作用する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// (3, 9), (3, 10), (3, 11)に黄色ぷよを配置（下端から3段積み）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithBottom</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span>

<span class="w">            </span><span class="c1">// (4, 2)に青ぷよを配置（浮いている）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithFloating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w"> </span><span class="n">stageWithBottom</span>

<span class="w">            </span><span class="c1">// 重力を適用</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">updatedStage</span><span class="o">,</span><span class="w"> </span><span class="n">hasFallen</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">stageWithFloating</span>

<span class="w">            </span><span class="c1">// 青ぷよが1マス落ちていることを確認</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;元の位置は空&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w"> </span><span class="s">&quot;1マス下に移動&quot;</span>

<span class="w">            </span><span class="c1">// 黄色ぷよは変わらない</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="w"> </span><span class="s">&quot;黄色ぷよ1&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="w"> </span><span class="s">&quot;黄色ぷよ2&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="w"> </span><span class="s">&quot;黄色ぷよ3&quot;</span>

<span class="w">            </span><span class="c1">// 落下したフラグが立っている</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="s">&quot;落下が発生した&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;浮いているぷよがない場合、何も変化しない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 下端にぷよを配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w"> </span><span class="n">stage</span>

<span class="w">            </span><span class="c1">// 重力を適用</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">updatedStage</span><span class="o">,</span><span class="w"> </span><span class="n">hasFallen</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 変化なし</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w"> </span><span class="s">&quot;位置は変わらない&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isFalse</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="s">&quot;落下は発生していない&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;複数の浮いているぷよに重力が作用する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// (2, 5)と(4, 7)に赤ぷよを配置（両方浮いている）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithFloating</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">            </span><span class="c1">// 重力を適用</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">updatedStage</span><span class="o">,</span><span class="w"> </span><span class="n">hasFallen</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">stageWithFloating</span>

<span class="w">            </span><span class="c1">// 両方とも1マス落ちている</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;元の位置1は空&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w"> </span><span class="s">&quot;1マス下に移動1&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;元の位置2は空&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w"> </span><span class="s">&quot;1マス下に移動2&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="s">&quot;落下が発生した&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ステージ&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gravityTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<h3 id="_45">実装: 重力処理<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>「重力処理を実装しましょう！」はい、ステージ上のぷよに重力を適用する関数を実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.fs（続き）</span>

<span class="c1">// ステージ上のぷよに重力を適用（1マスずつ落とす）</span>
<span class="c1">// 戻り値: (更新後のステージ, 落下したぷよがあればtrue)</span>
<span class="k">let</span><span class="w"> </span><span class="nv">applyGravity</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// フィールドのコピーを作成（移動前の状態を保存）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">originalCells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">copy</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">newCells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalCells</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">copy</span>

<span class="w">    </span><span class="c1">// 下から上に向かって各列をスキャン（列ごとに処理）</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalCells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1">// 元のフィールドで下に空きがあるかチェック</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">originalCells</span><span class="o">.[</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1">// 1マス下に移動</span>
<span class="w">                    </span><span class="n">newCells</span><span class="o">.[</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color</span>
<span class="w">                    </span><span class="n">newCells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span>
<span class="w">                    </span><span class="n">hasFallen</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">true</span>

<span class="w">    </span><span class="o">({</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCells</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="n">hasFallen</span><span class="o">)</span>
</code></pre></div>
<p>「<code>mutable</code>キーワードを使っているんですね！」はい、F#では基本的にイミュータブルなデータを扱いますが、ループ内で状態を更新する場合は<code>mutable</code>キーワードを使います。ただし、このような場合でも、最終的には新しいステージを返すことで、関数全体としてはイミュータブルな振る舞いを保ちます。</p>
<p>「配列の操作も変更可能なんですか？」そうです。F#の配列（<code>array</code>）は変更可能です。ただし、ここでは<code>Array.copy</code>を使って配列全体をコピーしてから変更しているので、元のステージは変更されません。</p>
<h3 id="_46">ゲームステートの拡張<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>「ゲームのモードを管理する必要がありますね？」その通りです。ゲームのモードを管理するための型を追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Types.fs（続き）</span>

<span class="c1">// ゲームモード</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">NewPuyo</span><span class="w">      </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w">      </span><span class="c1">// プレイ中（操作可能）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">CheckFall</span><span class="w">    </span><span class="c1">// 重力チェック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Falling</span><span class="w">      </span><span class="c1">// 落下中</span>

<span class="c1">// プレイヤーの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PlayerState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">CurrentPuyo</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">DropTimer</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span>
<span class="w">    </span><span class="n">DropInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span>
<span class="w">    </span><span class="n">HasLanded</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span>
<span class="o">}</span>

<span class="c1">// ゲームステート</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span>
<span class="w">    </span><span class="n">Player</span><span class="o">:</span><span class="w"> </span><span class="n">PlayerState</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Mode</span><span class="o">:</span><span class="w"> </span><span class="n">GameMode</span>
<span class="o">}</span>
</code></pre></div>
<p>「<code>option</code>型が使われていますね！」はい、F#の<code>option</code>型は値があるかないかを型安全に表現できます。<code>None</code>は値がないことを、<code>Some value</code>は値があることを表します。</p>
<h3 id="_47">ゲームループの実装<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>「ゲームループを実装しましょう！」はい、時間経過に応じてぷよを落下させる処理を実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs（更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Game</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Types</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Player</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Stage</span>

<span class="c1">// ゲームを初期化する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">        </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="w">        </span><span class="n">DropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span><span class="w">  </span><span class="c1">// 1秒（ミリ秒）</span>
<span class="w">        </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">      </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span>
<span class="w">      </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// ゲームを更新する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">gameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">gameState</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// タイマーを進める</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropTimer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">deltaTime</span>

<span class="w">            </span><span class="c1">// 落下間隔に達したか</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">newTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropInterval</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">canMoveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1">// 下に移動</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="o">.</span><span class="n">Rows</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// 着地したのでステージに固定</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixToStage</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="o">;</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">// タイマーを更新</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newTimer</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 重力を適用</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">updatedStage</span><span class="o">,</span><span class="w"> </span><span class="n">hasFallen</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1">// 落下したので Falling モードへ</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 落下するぷよがないので次のぷよを出す</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 落下アニメーション（簡略化のため即座に CheckFall に戻る）</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「パターンマッチングでゲームモードを処理しているんですね！」その通りです。F#のパターンマッチングを使うと、各モードごとの処理を明確に分離できます。また、コンパイラが全ケースをチェックしてくれるので、処理漏れを防げます。</p>
<h3 id="_48">プロジェクトファイルとテストの更新<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>テストを更新して、新しいテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（更新）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;プレイヤー機能&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">playerTests</span>
<span class="w">        </span><span class="n">puyoMoveTests</span>
<span class="w">        </span><span class="n">puyoPairTests</span>
<span class="w">        </span><span class="n">puyoRotationTests</span>
<span class="w">        </span><span class="n">wallKickTests</span>
<span class="w">        </span><span class="n">freeFallTests</span>
<span class="w">        </span><span class="n">landingTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/Main.fs（更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Tests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>

<span class="k">let</span><span class="w"> </span><span class="nv">allTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;すべてのテスト&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="nn">GameTests</span><span class="p">.</span><span class="n">tests</span>
<span class="w">        </span><span class="nn">PlayerTests</span><span class="p">.</span><span class="n">tests</span>
<span class="w">        </span><span class="nn">StageTests</span><span class="p">.</span><span class="n">tests</span>
<span class="w">    </span><span class="o">]</span>

<span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nn">Mocha</span><span class="p">.</span><span class="n">runTests</span><span class="w"> </span><span class="n">allTests</span>
</code></pre></div>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  ゲーム
    ゲームの初期化
      ✓ ゲームを初期化すると、ゲームステートが作成される
      ✓ ゲームを初期化すると、ステージが6列12行で作成される

  プレイヤー機能
    プレイヤー
      ✓ 新しいぷよを作成すると、初期位置に配置される
      ✓ 新しいぷよを作成すると、色が設定される
    ぷよの移動
      ✓ 左に移動できる場合、左に移動する
      ✓ 右に移動できる場合、右に移動する
      ✓ 左端にいる場合、左に移動できない
      ✓ 右端にいる場合、右に移動できない
    ぷよペア
      ✓ 新しいぷよペアを作成すると、軸ぷよと子ぷよが作成される
      ✓ 初期状態では子ぷよは軸ぷよの上にある
    ぷよの回転
      ✓ 時計回りに回転すると、子ぷよが右に移動する
      ✓ 2回時計回りに回転すると、子ぷよが下に移動する
      ✓ 4回時計回りに回転すると、元の位置に戻る
    壁キック処理
      ✓ 右端で右向きに回転すると、左に移動して回転する
      ✓ 左端で左向きに回転すると、右に移動して回転する
    自由落下
      ✓ 下に移動できる場合、1マス下に移動する
      ✓ 下端に達している場合、移動できない
      ✓ 子ぷよが下端に達している場合、移動できない
    着地処理
      ✓ 着地したぷよはステージに固定される
      ✓ ステージ上のぷよの上には着地できない

  ステージ
    重力処理
      ✓ 個別のぷよに重力が作用する
      ✓ 浮いているぷよがない場合、何も変化しない
      ✓ 複数の浮いているぷよに重力が作用する

  23 passing (Xms)
</code></pre></div>
<h3 id="option">解説: Option型と時間ベースの更新<a class="headerlink" href="#option" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通りましたね！」はい、これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>F#のOption型と時間ベースの更新について、少し詳しく解説しましょう：</p>
<ol>
<li><strong>Option型の利点</strong>:</li>
<li><code>None</code>と<code>Some value</code>で値の有無を明確に表現</li>
<li>パターンマッチングで安全に値を取り出せる</li>
<li>
<p><code>null</code>参照エラーを防止できる</p>
</li>
<li>
<p><strong>時間ベースの更新</strong>:</p>
</li>
<li><code>deltaTime</code>で経過時間を管理</li>
<li>フレームレートに依存しない一定の落下速度</li>
<li>
<p><code>DropTimer</code>と<code>DropInterval</code>で落下タイミングを制御</p>
</li>
<li>
<p><strong>ゲームモードの状態遷移</strong>:</p>
</li>
<li><code>NewPuyo</code> → <code>Playing</code> → <code>CheckFall</code> → <code>Falling</code> → <code>CheckFall</code> → ... → <code>NewPuyo</code></li>
<li>パターンマッチングで各モードの処理を明確に分離</li>
<li>
<p>コンパイラによる網羅性チェック</p>
</li>
<li>
<p><strong>イミュータブルな状態管理</strong>:</p>
</li>
<li>各更新で新しい<code>GameState</code>を作成</li>
<li>元の状態は変更されない</li>
<li>デバッグや状態の追跡が容易</li>
</ol>
<p>「TypeScriptのクラスベースの実装と違いますね！」その通りです。F#では関数とイミュータブルなデータ構造を使って、より宣言的なコードを書くことができます。</p>
<h3 id="4_1">イテレーション 4 のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>自由落下機能</strong></li>
<li><code>DropTimer</code>と<code>DropInterval</code>で時間管理</li>
<li><code>update</code>関数で時間経過に応じた落下処理</li>
<li>
<p>1秒間隔（1000ms）で1マスずつ落下</p>
</li>
<li>
<p><strong>落下判定</strong></p>
</li>
<li><code>canMoveDown</code>関数：下に移動できるかチェック</li>
<li>軸ぷよと子ぷよの両方をチェック</li>
<li>
<p>下端チェックとステージ上のぷよとの衝突チェック</p>
</li>
<li>
<p><strong>ステージへの固定</strong></p>
</li>
<li><code>fixToStage</code>関数：着地したぷよをステージに配置</li>
<li>パイプライン演算子による処理の連鎖</li>
<li>
<p>イミュータブルな更新</p>
</li>
<li>
<p><strong>重力処理</strong></p>
</li>
<li><code>applyGravity</code>関数：ステージ上のぷよに重力を適用</li>
<li>フィールドのコピーを作成して移動前の状態を保存</li>
<li>下から上に向かって各列をスキャン</li>
<li>
<p>1マスずつ落下（一度の呼び出しで1マス）</p>
</li>
<li>
<p><strong>ゲームモード管理</strong></p>
</li>
<li><code>GameMode</code>判別共用体の追加</li>
<li><code>NewPuyo</code>, <code>Playing</code>, <code>CheckFall</code>, <code>Falling</code>の4つのモード</li>
<li>
<p>パターンマッチングによる状態遷移</p>
</li>
<li>
<p><strong>Option型の活用</strong></p>
</li>
<li><code>CurrentPuyo: PuyoPair option</code>で現在のぷよを管理</li>
<li>
<p><code>None</code>と<code>Some</code>で値の有無を型安全に表現</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>自由落下のテスト（3 テスト）</li>
<li>着地処理のテスト（2 テスト）</li>
<li>重力処理のテスト（3 テスト）</li>
<li>
<p>すべてのテストが成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>Option型による安全な値の管理</li>
<li>時間ベースの更新（deltaTime）</li>
<li>パターンマッチングによる状態遷移</li>
<li>イミュータブルな状態管理の利点</li>
<li>mutableキーワードの適切な使用</li>
</ol>
<p>F#のOption型とパターンマッチングを活かして、型安全で読みやすいゲームループを実装できました。次のイテレーションでは、ぷよの高速落下機能を実装していきます。</p>
<h2 id="5">イテレーション 5: ぷよの高速落下の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「自動的に落ちてくるようになったけど、ぷよぷよってもっと早く落とせたよね？」そうですね！ぷよぷよでは、プレイヤーが下キーを押すことで、ぷよを素早く落下させることができます。今回は、その「高速落下」機能を実装していきましょう！</p>
<h3 id="_49">ユーザーストーリー<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよを素早く落下させることができる</p>
</blockquote>
<p>「早く次のぷよを落としたい！」というときに、下キーを押して素早く落下させる機能は、ゲームのテンポを良くするために重要ですね。</p>
<h3 id="todo_4">TODO リスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ぷよを素早く落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>キー入力の状態管理を実装する（下キーが押されているかを検知する）</li>
<li>高速落下処理を実装する（下キーが押されているときは落下速度を上げる）</li>
<li>落下速度の計算を実装する（通常速度と高速落下速度を切り替える）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_50">テスト: 高速落下<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、落下速度が変わることをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">fastDropTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;高速落下&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;通常の落下速度は1倍&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">                </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="w">                </span><span class="n">DropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span>
<span class="w">                </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">            </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 通常の落下速度を取得</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">getDropSpeed</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="k">false</span>

<span class="w">            </span><span class="c1">// 通常速度は1倍</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;通常速度は1.0&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;下キーが押されていると落下速度が10倍になる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">                </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="w">                </span><span class="n">DropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span>
<span class="w">                </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">            </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 高速落下の速度を取得</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">getDropSpeed</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="k">true</span>

<span class="w">            </span><span class="c1">// 高速落下速度は10倍</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;高速落下速度は10.0&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;高速落下時はタイマーが速く進む&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">puyoPair</span>
<span class="w">                </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="w">                </span><span class="n">DropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span>
<span class="w">                </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">            </span><span class="o">}</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">gameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">                </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span>
<span class="w">                </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span>
<span class="w">            </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 100ms経過、高速落下ON</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Game</span><span class="p">.</span><span class="n">updateWithSpeed</span><span class="w"> </span><span class="mi">100</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="n">gameState</span>

<span class="w">            </span><span class="c1">// タイマーが1000ms進んでいる（100ms * 10倍）</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">updatedState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropTimer</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;タイマーが1000ms進んでいる&quot;</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>通常の落下速度が1倍であること</li>
<li>下キーが押されているときの落下速度が10倍になること</li>
<li>高速落下時にタイマーが速く進むこと</li>
</ol>
<p>「なるほど、落下速度を倍率で管理するんですね！」そうです！F#では、単純な数値の倍率として扱うことで、シンプルに実装できます。では、このテストが通るように実装していきましょう。</p>
<h3 id="_51">実装: 高速落下<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、高速落下の機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（続き）</span>

<span class="c1">// 落下速度を取得する（通常は1.0、高速落下は10.0）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">getDropSpeed</span><span class="w"> </span><span class="o">(</span><span class="n">player</span><span class="o">:</span><span class="w"> </span><span class="n">PlayerState</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">isFastDrop</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">isFastDrop</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。F#では、関数として落下速度を計算するだけです。<code>isFastDrop</code>が<code>true</code>の場合は10倍、<code>false</code>の場合は1倍の速度を返します。</p>
<h3 id="_52">実装: ゲームループとの統合<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>「ゲームループでこの速度を使うにはどうすればいいですか？」良い質問ですね！<code>Game.fs</code>の<code>update</code>関数を拡張して、キー入力の状態を受け取るようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs（更新）</span>

<span class="c1">// 速度を考慮してゲームを更新する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">updateWithSpeed</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">isFastDrop</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">gameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">gameState</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 落下速度を取得</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">dropSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">getDropSpeed</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="n">isFastDrop</span>

<span class="w">            </span><span class="c1">// タイマーを進める（速度を反映）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropTimer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dropSpeed</span><span class="o">)</span>

<span class="w">            </span><span class="c1">// 落下間隔に達したか</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">newTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropInterval</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">canMoveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1">// 下に移動</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="o">.</span><span class="n">Rows</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// 着地したのでステージに固定</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixToStage</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="o">;</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">// タイマーを更新</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newTimer</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 他のモードは既存のupdate関数を使用</span>
<span class="w">        </span><span class="n">update</span><span class="w"> </span><span class="n">deltaTime</span><span class="w"> </span><span class="n">gameState</span>
</code></pre></div>
<p>「なるほど！<code>deltaTime</code>に<code>dropSpeed</code>を掛けることで、下キーが押されているときはタイマーが10倍速く進むんですね！」その通りです！これで下キーを押している間は通常の10倍の速さでぷよが落下するようになりました。</p>
<h3 id="_53">キー入力の管理<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>「でも、キー入力の状態はどこで管理するんですか？」良い質問ですね！実際のゲームでは、キー入力の状態を管理する必要があります。F# Fableでは、ブラウザのキーボードイベントを使います。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Input.fs（新規作成）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Input</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Browser.Types</span>

<span class="c1">// キー入力の状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">InputState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">IsDownPressed</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">    </span><span class="n">IsLeftPressed</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">    </span><span class="n">IsRightPressed</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">    </span><span class="n">IsRotatePressed</span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span>
<span class="o">}</span>

<span class="c1">// 初期状態</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InputState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">IsDownPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">      </span><span class="n">IsLeftPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">      </span><span class="n">IsRightPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">      </span><span class="n">IsRotatePressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// キーダウンイベントを処理</span>
<span class="k">let</span><span class="w"> </span><span class="nv">handleKeyDown</span><span class="w"> </span><span class="o">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">InputState</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="k">event</span><span class="o">:</span><span class="w"> </span><span class="n">KeyboardEvent</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InputState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="k">event</span><span class="o">.</span><span class="n">key</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsDownPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsLeftPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsRightPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsRotatePressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">state</span>

<span class="c1">// キーアップイベントを処理</span>
<span class="k">let</span><span class="w"> </span><span class="nv">handleKeyUp</span><span class="w"> </span><span class="o">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">InputState</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="k">event</span><span class="o">:</span><span class="w"> </span><span class="n">KeyboardEvent</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InputState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="k">event</span><span class="o">.</span><span class="n">key</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsDownPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsLeftPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsRightPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">IsRotatePressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">state</span>
</code></pre></div>
<p>「パターンマッチングでキー入力を処理しているんですね！」その通りです。F#のパターンマッチングを使うと、各キーに対する処理を明確に記述できます。</p>
<h3 id="_54">ゲームステートの拡張<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>「入力状態もゲームステートに含める必要がありますね？」はい、ゲームステートに入力状態を追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Types.fs（更新）</span>

<span class="c1">// ゲームステート</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span>
<span class="w">    </span><span class="n">Player</span><span class="o">:</span><span class="w"> </span><span class="n">PlayerState</span>
<span class="w">    </span><span class="n">Input</span><span class="o">:</span><span class="w"> </span><span class="n">InputState</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Mode</span><span class="o">:</span><span class="w"> </span><span class="n">GameMode</span>
<span class="o">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs（更新）</span>

<span class="c1">// ゲームを初期化する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">        </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="w">        </span><span class="n">DropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span>
<span class="w">        </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Input</span><span class="p">.</span><span class="n">init</span><span class="bp">()</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">      </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span>
<span class="w">      </span><span class="n">Input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span>
<span class="w">      </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// ゲームを更新する（入力状態を使用）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">gameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">updateWithSpeed</span><span class="w"> </span><span class="n">deltaTime</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">IsDownPressed</span><span class="w"> </span><span class="n">gameState</span>
</code></pre></div>
<p>「これで、ゲームの状態に入力状態も含まれるようになりましたね！」その通りです。イミュータブルなアプローチを維持しながら、入力状態を管理できるようになりました。</p>
<h3 id="_55">プロジェクトファイルとテストの更新<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>テストを更新して、新しいテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PlayerTests.fs（更新）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;プレイヤー機能&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">playerTests</span>
<span class="w">        </span><span class="n">puyoMoveTests</span>
<span class="w">        </span><span class="n">puyoPairTests</span>
<span class="w">        </span><span class="n">puyoRotationTests</span>
<span class="w">        </span><span class="n">wallKickTests</span>
<span class="w">        </span><span class="n">freeFallTests</span>
<span class="w">        </span><span class="n">landingTests</span>
<span class="w">        </span><span class="n">fastDropTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  ゲーム
    ゲームの初期化
      ✓ ゲームを初期化すると、ゲームステートが作成される
      ✓ ゲームを初期化すると、ステージが6列12行で作成される

  プレイヤー機能
    プレイヤー
      ✓ 新しいぷよを作成すると、初期位置に配置される
      ✓ 新しいぷよを作成すると、色が設定される
    ぷよの移動
      ✓ 左に移動できる場合、左に移動する
      ✓ 右に移動できる場合、右に移動する
      ✓ 左端にいる場合、左に移動できない
      ✓ 右端にいる場合、右に移動できない
    ぷよペア
      ✓ 新しいぷよペアを作成すると、軸ぷよと子ぷよが作成される
      ✓ 初期状態では子ぷよは軸ぷよの上にある
    ぷよの回転
      ✓ 時計回りに回転すると、子ぷよが右に移動する
      ✓ 2回時計回りに回転すると、子ぷよが下に移動する
      ✓ 4回時計回りに回転すると、元の位置に戻る
    壁キック処理
      ✓ 右端で右向きに回転すると、左に移動して回転する
      ✓ 左端で左向きに回転すると、右に移動して回転する
    自由落下
      ✓ 下に移動できる場合、1マス下に移動する
      ✓ 下端に達している場合、移動できない
      ✓ 子ぷよが下端に達している場合、移動できない
    着地処理
      ✓ 着地したぷよはステージに固定される
      ✓ ステージ上のぷよの上には着地できない
    高速落下
      ✓ 通常の落下速度は1倍
      ✓ 下キーが押されていると落下速度が10倍になる
      ✓ 高速落下時はタイマーが速く進む

  ステージ
    重力処理
      ✓ 個別のぷよに重力が作用する
      ✓ 浮いているぷよがない場合、何も変化しない
      ✓ 複数の浮いているぷよに重力が作用する

  26 passing (Xms)
</code></pre></div>
<h3 id="_56">解説: 速度倍率と入力管理<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通りましたね！」はい、これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>F#での速度倍率と入力管理について、少し詳しく解説しましょう：</p>
<ol>
<li><strong>速度倍率による時間制御</strong>:</li>
<li><code>deltaTime * dropSpeed</code>で時間の進み方を制御</li>
<li>高速落下時は10倍速くタイマーが進む</li>
<li>
<p>シンプルな乗算で実現</p>
</li>
<li>
<p><strong>入力状態の管理</strong>:</p>
</li>
<li><code>InputState</code>レコード型で全ての入力状態を管理</li>
<li>パターンマッチングでキーイベントを処理</li>
<li>
<p>イミュータブルな更新</p>
</li>
<li>
<p><strong>関数による処理の分離</strong>:</p>
</li>
<li><code>getDropSpeed</code>関数：速度の計算</li>
<li><code>handleKeyDown</code>/<code>handleKeyUp</code>関数：キーイベントの処理</li>
<li><code>updateWithSpeed</code>関数：速度を考慮した更新</li>
<li>
<p>各関数が単一の責任を持つ</p>
</li>
<li>
<p><strong>型安全性</strong>:</p>
</li>
<li><code>InputState</code>レコード型により、どのキーが押されているかを明確に管理</li>
<li>Option型で現在のぷよの有無を安全に表現</li>
<li>パターンマッチングで全ケースを処理</li>
</ol>
<p>「TypeScriptのクラスベースの実装と違いますね！」その通りです。F#では、関数とイミュータブルなデータ構造を使って、より宣言的で型安全なコードを書くことができます。</p>
<h3 id="5_1">イテレーション 5 のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>高速落下機能</strong></li>
<li><code>getDropSpeed</code>関数：落下速度の計算（通常1.0、高速10.0）</li>
<li>速度倍率による時間制御</li>
<li>
<p>タイマーへの速度反映</p>
</li>
<li>
<p><strong>入力管理</strong></p>
</li>
<li><code>InputState</code>レコード型：キー入力状態の管理</li>
<li><code>handleKeyDown</code>/<code>handleKeyUp</code>関数：キーイベントの処理</li>
<li>
<p>パターンマッチングによる明確なキー処理</p>
</li>
<li>
<p><strong>ゲームループの拡張</strong></p>
</li>
<li><code>updateWithSpeed</code>関数：速度を考慮した更新処理</li>
<li>入力状態をゲームステートに統合</li>
<li>
<p>イミュータブルな状態管理の維持</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>高速落下のテスト（3 テスト）</li>
<li>通常速度と高速落下速度の確認</li>
<li>タイマーの進み方の確認</li>
<li>
<p>すべてのテストが成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>速度倍率による時間制御</li>
<li>入力状態のイミュータブルな管理</li>
<li>パターンマッチングによるイベント処理</li>
<li>関数による処理の明確な分離</li>
</ol>
<p>F#の関数型プログラミングのアプローチを活かして、シンプルで型安全な高速落下機能を実装できました。次のイテレーションでは、ぷよの消去機能を実装していきます。</p>
<h2 id="6">イテレーション 6: ぷよの消去の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを4つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_57">ユーザーストーリー<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを4つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。これを実装することで、ゲームとしての面白さが大きく向上しますね。</p>
<h3 id="todo_5">TODO リスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li>4つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li>ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li>ゲームモードの拡張（消去チェックと消去処理のモードを追加）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_58">テスト: ぷよの接続判定<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが4つ以上つながっているかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/StageTests.fs（更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">StageTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Types</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Stage</span>

<span class="k">let</span><span class="w"> </span><span class="nv">eraseTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ぷよの消去判定&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;同じ色のぷよが4つつながっていると、消去対象になる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 2×2の正方形に赤ぷよを配置</span>
<span class="w">            </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">            </span><span class="c1">// ...</span>
<span class="w">            </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">            </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">            </span><span class="c1">// 消去判定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkErase</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 4つのぷよが消去対象になっている</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="s">&quot;4つのぷよが消去対象&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="o">(</span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;消去位置がある&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;異なる色のぷよは消去対象にならない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 市松模様に赤と青のぷよを配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">            </span><span class="c1">// 消去判定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkErase</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 消去対象がない</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;消去対象がない&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;消去位置がない&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;3つ以下のつながりは消去対象にならない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// L字型に赤ぷよを3つ配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">            </span><span class="c1">// 消去判定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkErase</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 消去対象がない</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;3つ以下は消去されない&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ステージ&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gravityTests</span>
<span class="w">        </span><span class="n">eraseTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>同じ色のぷよが4つつながっている場合、それらが消去対象になるか</li>
<li>異なる色のぷよが隣接している場合、それらは消去対象にならないか</li>
<li>同じ色のぷよが3つ以下の場合、消去対象にならないか</li>
</ol>
<p>「なるほど、4つ以上という条件が重要なんですね！」そうです！ぷよぷよの基本ルールですね。では、このテストが通るように実装していきましょう。</p>
<h3 id="_59">実装: ぷよの接続判定<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよの接続判定を実装していきましょう。</p>
<p>まず、消去情報を表す型を定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Types.fs（続き）</span>

<span class="c1">// 消去情報</span>
<span class="k">type</span><span class="w"> </span><span class="nc">EraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">ErasePuyoCount</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">ErasePositions</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span>
<span class="o">}</span>
</code></pre></div>
<p>次に、接続判定のロジックを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.fs（続き）</span>

<span class="c1">// ぷよの消去判定を行う</span>
<span class="k">let</span><span class="w"> </span><span class="nv">checkErase</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EraseInfo</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// チェック済みフラグ</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">checked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">false</span><span class="o">)</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">erasePositions</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">[]</span>

<span class="w">    </span><span class="c1">// 接続しているぷよを探索する（深さ優先探索）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">searchConnected</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">connected</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// すでにチェック済みまたは範囲外</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">checked</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">connected</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">cellColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span>

<span class="w">            </span><span class="c1">// 同じ色でない、または空</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">cellColor</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cellColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="n">connected</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">// チェック済みにする</span>
<span class="w">                </span><span class="k">checked</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">true</span>

<span class="w">                </span><span class="c1">// 現在の位置を追加</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">newConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">connected</span>

<span class="w">                </span><span class="c1">// 4方向を探索（右、左、下、上）</span>
<span class="w">                </span><span class="n">newConnected</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">searchConnected</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">color</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">searchConnected</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">color</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">searchConnected</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">color</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">searchConnected</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">color</span>

<span class="w">    </span><span class="c1">// 全マスをチェック</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span>

<span class="w">            </span><span class="c1">// ぷよがあり、まだチェックしていない場合</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">checked</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1">// 接続しているぷよを探索</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">searchConnected</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="bp">[]</span>

<span class="w">                </span><span class="c1">// 4つ以上つながっている場合は消去対象</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">connected</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span>
<span class="w">                        </span><span class="n">connected</span>
<span class="w">                        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">px</span><span class="o">,</span><span class="w"> </span><span class="n">py</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">px</span><span class="o">,</span><span class="w"> </span><span class="n">py</span><span class="o">,</span><span class="w"> </span><span class="n">color</span><span class="o">))</span>
<span class="w">                    </span><span class="n">erasePositions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">erasePositions</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">positions</span>

<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erasePositions</span><span class="o">.</span><span class="n">Length</span>
<span class="w">      </span><span class="n">ErasePositions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erasePositions</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「再帰関数を使っているんですね！」その通りです。F#では、再帰関数を使って深さ優先探索（DFS）を実装しています。<code>searchConnected</code>関数は、指定された位置から同じ色のぷよを再帰的に探索します。</p>
<p>「パイプライン演算子で4方向の探索を連鎖させているのが面白いですね！」はい！F#のパイプライン演算子を使うと、探索の流れを読みやすく表現できます。各方向の探索結果が次の探索の入力になっています。</p>
<h3 id="_60">テスト: ぷよの消去処理<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>「次は実際にぷよを消す処理をテストしましょう！」はい、消去対象のぷよを実際に削除する処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/StageTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">eraseExecutionTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ぷよの消去実行&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;消去対象のぷよを消去する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 2×2の正方形に赤ぷよを配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">            </span><span class="c1">// 消去判定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkErase</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 消去実行</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">erasedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eraseBlocks</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// ぷよが消去されている</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="n">erasedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;位置(1,10)が空&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="n">erasedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;位置(2,10)が空&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">erasedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;位置(1,11)が空&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">erasedStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="s">&quot;位置(2,11)が空&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;消去後、上にあるぷよが落下している&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 赤ぷよの上に青ぷよを配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>

<span class="w">            </span><span class="c1">// 消去判定と実行</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkErase</span><span class="w"> </span><span class="n">stageWithPuyo</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">erasedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eraseBlocks</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 重力を適用</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">fallenStage</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">erasedStage</span>

<span class="w">            </span><span class="c1">// 青ぷよが落下している</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="n">fallenStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w"> </span><span class="s">&quot;青ぷよ1が落下&quot;</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">getPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">fallenStage</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w"> </span><span class="s">&quot;青ぷよ2が落下&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ステージ&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gravityTests</span>
<span class="w">        </span><span class="n">eraseTests</span>
<span class="w">        </span><span class="n">eraseExecutionTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<h3 id="_61">実装: ぷよの消去処理<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>「消去処理を実装しましょう！」はい、消去対象のぷよを削除する関数を実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.fs（続き）</span>

<span class="c1">// ぷよを消去する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">eraseBlocks</span><span class="w"> </span><span class="o">(</span><span class="n">positions</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newCells</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">row</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// この位置が消去対象に含まれているかチェック</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">shouldErase</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">positions</span>
<span class="w">                    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">exists</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">ex</span><span class="o">,</span><span class="w"> </span><span class="n">ey</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="o">)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">shouldErase</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">cell</span><span class="o">))</span>

<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCells</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「<code>List.exists</code>を使って消去対象かどうかをチェックしているんですね！」その通りです。F#の<code>List.exists</code>関数を使うと、リスト内に条件を満たす要素があるかを簡潔に確認できます。</p>
<h3 id="_62">ゲームモードの拡張<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>「ゲームのフローに消去処理を組み込む必要がありますね？」はい、ゲームモードを拡張して、消去チェックと消去処理のモードを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Types.fs（更新）</span>

<span class="c1">// ゲームモード</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">NewPuyo</span><span class="w">      </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w">      </span><span class="c1">// プレイ中（操作可能）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">CheckFall</span><span class="w">    </span><span class="c1">// 重力チェック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Falling</span><span class="w">      </span><span class="c1">// 落下中</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">CheckErase</span><span class="w">   </span><span class="c1">// 消去チェック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Erasing</span><span class="w">      </span><span class="c1">// 消去中</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs（更新）</span>

<span class="c1">// ゲームを更新する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">gameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">gameState</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 落下速度を取得</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">dropSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">getDropSpeed</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">IsDownPressed</span>

<span class="w">            </span><span class="c1">// タイマーを進める（速度を反映）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropTimer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dropSpeed</span><span class="o">)</span>

<span class="w">            </span><span class="c1">// 落下間隔に達したか</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">newTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropInterval</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">canMoveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1">// 下に移動</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="o">.</span><span class="n">Rows</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// 着地したのでステージに固定</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixToStage</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="o">;</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">// タイマーを更新</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newTimer</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 重力を適用</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">updatedStage</span><span class="o">,</span><span class="w"> </span><span class="n">hasFallen</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1">// 落下したので Falling モードへ</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 落下するぷよがないので消去チェックへ</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 落下アニメーション（簡略化のため即座に CheckFall に戻る）</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">checkErase</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">eraseBlocks</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 消去対象がない場合、次のぷよを出す</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 消去アニメーション（簡略化のため即座に CheckFall に戻る）</span>
<span class="w">        </span><span class="c1">// 消去後の重力適用のため</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「ゲームフローがどう変わったんですか？」良い質問ですね！ゲームフローは以下のように拡張されました：</p>
<p><strong>新しいゲームフロー</strong>:
<div class="highlight"><pre><span></span><code>NewPuyo → Playing → (着地) → CheckFall → (重力適用) →
  ├─ 落下した → Falling → CheckFall
  └─ 落下なし → CheckErase →
      ├─ 消去あり → Erasing → CheckFall（消去後の重力適用）
      └─ 消去なし → NewPuyo
</code></pre></div></p>
<p>このフローにより、以下が実現されます：</p>
<ol>
<li><strong>着地後の重力適用</strong>: ぷよが着地したら、まず重力を適用して浮いているぷよを落とす</li>
<li><strong>消去判定</strong>: 重力適用後、落下するぷよがなくなったら消去判定</li>
<li><strong>消去処理</strong>: 4つ以上つながったぷよがあれば消去</li>
<li><strong>消去後の重力適用</strong>: 消去後、再び重力を適用（これが連鎖の基礎になる）</li>
</ol>
<h3 id="_63">プロジェクトファイルとテストの更新<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  ゲーム
    ゲームの初期化
      ✓ ゲームを初期化すると、ゲームステートが作成される
      ✓ ゲームを初期化すると、ステージが6列12行で作成される

  プレイヤー機能
    プレイヤー
      ✓ 新しいぷよを作成すると、初期位置に配置される
      ✓ 新しいぷよを作成すると、色が設定される
    ぷよの移動
      ✓ 左に移動できる場合、左に移動する
      ✓ 右に移動できる場合、右に移動する
      ✓ 左端にいる場合、左に移動できない
      ✓ 右端にいる場合、右に移動できない
    ぷよペア
      ✓ 新しいぷよペアを作成すると、軸ぷよと子ぷよが作成される
      ✓ 初期状態では子ぷよは軸ぷよの上にある
    ぷよの回転
      ✓ 時計回りに回転すると、子ぷよが右に移動する
      ✓ 2回時計回りに回転すると、子ぷよが下に移動する
      ✓ 4回時計回りに回転すると、元の位置に戻る
    壁キック処理
      ✓ 右端で右向きに回転すると、左に移動して回転する
      ✓ 左端で左向きに回転すると、右に移動して回転する
    自由落下
      ✓ 下に移動できる場合、1マス下に移動する
      ✓ 下端に達している場合、移動できない
      ✓ 子ぷよが下端に達している場合、移動できない
    着地処理
      ✓ 着地したぷよはステージに固定される
      ✓ ステージ上のぷよの上には着地できない
    高速落下
      ✓ 通常の落下速度は1倍
      ✓ 下キーが押されていると落下速度が10倍になる
      ✓ 高速落下時はタイマーが速く進む

  ステージ
    重力処理
      ✓ 個別のぷよに重力が作用する
      ✓ 浮いているぷよがない場合、何も変化しない
      ✓ 複数の浮いているぷよに重力が作用する
    ぷよの消去判定
      ✓ 同じ色のぷよが4つつながっていると、消去対象になる
      ✓ 異なる色のぷよは消去対象にならない
      ✓ 3つ以下のつながりは消去対象にならない
    ぷよの消去実行
      ✓ 消去対象のぷよを消去する
      ✓ 消去後、上にあるぷよが落下している

  31 passing (Xms)
</code></pre></div>
<h3 id="_64">解説: 深さ優先探索と消去処理<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通りましたね！」はい、これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>F#での深さ優先探索と消去処理について、少し詳しく解説しましょう：</p>
<ol>
<li><strong>再帰による深さ優先探索（DFS）</strong>:</li>
<li><code>searchConnected</code>関数：再帰的に同じ色のぷよを探索</li>
<li>4方向（右、左、下、上）を順番に探索</li>
<li>
<p>パイプライン演算子で探索結果を連鎖</p>
</li>
<li>
<p><strong>ミュータブルなフラグ配列</strong>:</p>
</li>
<li><code>checked</code>配列：探索済みの位置を記録</li>
<li>同じぷよを重複してカウントしないため</li>
<li>
<p>ローカルスコープでのみ使用</p>
</li>
<li>
<p><strong>リスト操作</strong>:</p>
</li>
<li><code>List.exists</code>：消去対象かどうかの判定</li>
<li><code>List.map</code>：位置情報の変換</li>
<li>
<p><code>@</code>演算子：リストの結合</p>
</li>
<li>
<p><strong>ゲームモードの拡張</strong>:</p>
</li>
<li><code>CheckErase</code>モード：消去判定を実行</li>
<li><code>Erasing</code>モード：消去アニメーション後、重力チェックへ</li>
<li>パターンマッチングで全モードを処理</li>
</ol>
<p>「再帰関数とパイプライン演算子の組み合わせが効果的ですね！」その通りです。F#の関数型プログラミングの特徴を活かして、読みやすく保守しやすいコードを書くことができました。</p>
<h3 id="6_1">イテレーション 6 のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>接続判定機能</strong></li>
<li><code>EraseInfo</code>型：消去対象の情報を表現</li>
<li><code>checkErase</code>関数：4つ以上つながったぷよを検出</li>
<li><code>searchConnected</code>関数：深さ優先探索で接続ぷよを探索</li>
<li>
<p>再帰とパイプライン演算子による実装</p>
</li>
<li>
<p><strong>消去処理機能</strong></p>
</li>
<li><code>eraseBlocks</code>関数：消去対象のぷよを削除</li>
<li><code>List.exists</code>による消去対象の判定</li>
<li>
<p>イミュータブルな配列更新</p>
</li>
<li>
<p><strong>ゲームモードの拡張</strong></p>
</li>
<li><code>CheckErase</code>モード：消去判定を実行</li>
<li><code>Erasing</code>モード：消去アニメーション</li>
<li>
<p>ゲームフローの拡張：着地 → 重力 → 消去 → 重力 → 次のぷよ</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ぷよの消去判定（3 テスト）</li>
<li>ぷよの消去実行（2 テスト）</li>
<li>
<p>すべてのテストが成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>深さ優先探索（DFS）アルゴリズム</li>
<li>再帰的な探索処理</li>
<li>パイプライン演算子による処理の連鎖</li>
<li>ゲームモードによる状態管理</li>
<li>消去と重力の連携処理</li>
</ol>
<p>F#の再帰関数とパターンマッチングを活かして、型安全で読みやすい消去処理を実装できました。次のイテレーションでは、連鎖反応を実装していきます！</p>
<h2 id="7">イテレーション 7: 連鎖反応の実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装していきましょう！</p>
<h3 id="_65">ユーザーストーリー<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="_66">連鎖反応は既に実装されている！<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>「連鎖反応を実装するには、どんな作業が必要ですか？」実は、驚くべきことに、<strong>連鎖反応は既に実装されています</strong>！</p>
<p>「え？本当ですか？」はい。イテレーション6で実装したゲームループの仕組みが、そのまま連鎖反応を実現しているんです。</p>
<h4 id="_67">連鎖が発生する仕組み<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h4>
<p>イテレーション6で実装したゲームフローを思い出してみましょう：</p>
<div class="highlight"><pre><span></span><code>NewPuyo → Playing → (着地) → CheckFall → (重力適用) →
  ├─ 落下した → Falling → CheckFall
  └─ 落下なし → CheckErase →
      ├─ 消去あり → Erasing → CheckFall（消去後の重力適用）
      └─ 消去なし → NewPuyo
</code></pre></div>
<p>「このゲームループの何が連鎖反応を実現しているんですか？」重要なのは、<code>Erasing</code>モード後に<code>CheckFall</code>に戻るという点です。連鎖が発生する流れを見てみましょう：</p>
<h4 id="_68">連鎖の流れ<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>1回目の消去</strong>：
   <div class="highlight"><pre><span></span><code>CheckErase → ぷよが消去される → Erasing → CheckFall
</code></pre></div></p>
</li>
<li>
<p><strong>重力適用</strong>：
   <div class="highlight"><pre><span></span><code>CheckFall → 上のぷよが落下 → Falling → CheckFall → 落下完了 → CheckErase
</code></pre></div></p>
</li>
<li>
<p><strong>2回目の消去（連鎖）</strong>：
   <div class="highlight"><pre><span></span><code>CheckErase → 落下後に新しい消去パターン発見 → Erasing → CheckFall
</code></pre></div></p>
</li>
<li>
<p><strong>連鎖終了</strong>：
   <div class="highlight"><pre><span></span><code>CheckFall → 落下なし → CheckErase → 消去なし → NewPuyo
</code></pre></div></p>
</li>
</ol>
<p>「つまり、<code>Erasing → CheckFall → CheckErase</code>のサイクルが連鎖を作っているんですね！」そのとおりです！このサイクルが、消去対象がなくなるまで繰り返されることで、連鎖反応が実現されています。</p>
<h3 id="_69">テスト: 連鎖反応の確認<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>では、連鎖反応が実際に動作することを確認するテストを書いてみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/GameTests.fs（更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">GameTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Fable.Mocha</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Types</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Game</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Stage</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Player</span>

<span class="k">let</span><span class="w"> </span><span class="nv">chainTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;連鎖反応&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 初期化</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">gameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">            </span><span class="c1">// 赤ぷよの2×2と、その上に青ぷよが縦に3つ、さらに青ぷよが1つ横に</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w">      </span><span class="c1">// 赤</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w">      </span><span class="c1">// 赤</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w">      </span><span class="c1">// 赤</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="w">      </span><span class="c1">// 赤</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w">     </span><span class="c1">// 青（横）</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w">     </span><span class="c1">// 青（上）</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w">     </span><span class="c1">// 青（上）</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w">     </span><span class="c1">// 青（上）</span>

<span class="w">            </span><span class="c1">// checkEraseモードに設定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">initialState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageWithPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 1回目の消去判定と消去実行</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterFirstErase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">initialState</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterFirstErase</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="w"> </span><span class="s">&quot;消去モードになる&quot;</span>

<span class="w">            </span><span class="c1">// 消去後の重力チェック</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterErasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">afterFirstErase</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterErasing</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="s">&quot;重力チェックモードになる&quot;</span>

<span class="w">            </span><span class="c1">// 重力適用（青ぷよが落下）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterCheckFall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">afterErasing</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterCheckFall</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="w"> </span><span class="s">&quot;落下モードになる&quot;</span>

<span class="w">            </span><span class="c1">// 落下完了まで繰り返し</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">waitForCheckErase</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="n">state</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="n">waitForCheckErase</span><span class="w"> </span><span class="o">(</span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">state</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">iterations</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterFalling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitForCheckErase</span><span class="w"> </span><span class="n">afterCheckFall</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="c1">// checkEraseモードに到達している</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterFalling</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="s">&quot;消去チェックモードに到達&quot;</span>

<span class="w">            </span><span class="c1">// 2回目の消去判定（連鎖）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">chainEraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">checkErase</span><span class="w"> </span><span class="n">afterFalling</span><span class="o">.</span><span class="n">Stage</span>

<span class="w">            </span><span class="c1">// 連鎖が発生していることを確認（青ぷよが4つつながっている）</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="o">(</span><span class="n">chainEraseInfo</span><span class="o">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;連鎖が発生している&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ゲーム&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gameInitTests</span>
<span class="w">        </span><span class="n">chainTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは以下を確認しています：</p>
<ol>
<li><strong>初期配置</strong>：赤ぷよ4つ（2×2）と青ぷよ4つ（縦3 + 横1）を配置</li>
<li><strong>1回目の消去</strong>：赤ぷよが消える</li>
<li><strong>重力適用</strong>：青ぷよが落下</li>
<li><strong>2回目の消去</strong>：落下した青ぷよが4つつながり、連鎖が発生</li>
</ol>
<p>「テストは通るんですか？」はい！既存の実装でテストは通ります。イテレーション6で実装したゲームループが、自然に連鎖反応を実現していたんです。</p>
<h3 id="_70">連鎖カウントの実装<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>「連鎖が何連鎖目かを知りたいですね！」良い質問です。連鎖数をカウントする機能を追加しましょう。</p>
<p>まず、ゲームステートに連鎖カウントを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Types.fs（更新）</span>

<span class="c1">// ゲームステート</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span>
<span class="w">    </span><span class="n">Player</span><span class="o">:</span><span class="w"> </span><span class="n">PlayerState</span>
<span class="w">    </span><span class="n">Input</span><span class="o">:</span><span class="w"> </span><span class="n">InputState</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Chain</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w">        </span><span class="c1">// 現在の連鎖数</span>
<span class="w">    </span><span class="n">Mode</span><span class="o">:</span><span class="w"> </span><span class="n">GameMode</span>
<span class="o">}</span>
</code></pre></div>
<p>次に、連鎖カウントの管理ロジックを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs（更新）</span>

<span class="c1">// ゲームを初期化する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">        </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="w">        </span><span class="n">DropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span>
<span class="w">        </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Input</span><span class="p">.</span><span class="n">init</span><span class="bp">()</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">      </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player</span>
<span class="w">      </span><span class="n">Input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span>
<span class="w">      </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// ゲームを更新する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">gameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 新しいぷよを生成（連鎖カウントをリセット）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNewPuyoPair</span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="o">;</span><span class="w"> </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">gameState</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 落下速度を取得</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">dropSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">getDropSpeed</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">IsDownPressed</span>

<span class="w">            </span><span class="c1">// タイマーを進める（速度を反映）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropTimer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dropSpeed</span><span class="o">)</span>

<span class="w">            </span><span class="c1">// 落下間隔に達したか</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">newTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="o">.</span><span class="n">DropInterval</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">canMoveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1">// 下に移動</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">movedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveDown</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="o">.</span><span class="n">Rows</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// 着地したのでステージに固定</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixToStage</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">HasLanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="o">;</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">// タイマーを更新</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Player</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">DropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newTimer</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedPlayer</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 重力を適用</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">updatedStage</span><span class="o">,</span><span class="w"> </span><span class="n">hasFallen</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">hasFallen</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1">// 落下したので Falling モードへ</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 落下するぷよがないので消去チェックへ</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 落下アニメーション（簡略化のため即座に CheckFall に戻る）</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">checkErase</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">eraseBlocks</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>

<span class="w">            </span><span class="c1">// 連鎖カウントを増加</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Chain</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newChain</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 消去対象がない場合、次のぷよを出す</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 消去アニメーション（簡略化のため即座に CheckFall に戻る）</span>
<span class="w">        </span><span class="c1">// 消去後の重力適用のため</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「連鎖カウントはどこで管理されているんですか？」連鎖カウントは以下のように管理されています：</p>
<ol>
<li><strong>新しいぷよ生成時</strong>：連鎖カウントを0にリセット</li>
<li><strong>消去発生時</strong>：連鎖カウントを1増加</li>
<li><strong>連鎖継続</strong>：<code>Erasing → CheckFall → CheckErase</code>のサイクルで連鎖カウントが保持される</li>
<li><strong>連鎖終了</strong>：消去がなくなると次のぷよ生成でリセット</li>
</ol>
<h3 id="_71">テスト: 連鎖カウント<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>連鎖カウントが正しく動作することを確認するテストを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/GameTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">chainCountTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;連鎖カウント&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;連鎖が発生すると連鎖カウントが増加する&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">gameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// ステージにぷよを配置（連鎖が発生する配置）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">initialState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageWithPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 1回目の消去</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterFirstErase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">initialState</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterFirstErase</span><span class="o">.</span><span class="n">Chain</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">&quot;1連鎖目&quot;</span>

<span class="w">            </span><span class="c1">// 重力適用まで進める</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">waitForSecondErase</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="n">state</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="n">waitForSecondErase</span><span class="w"> </span><span class="o">(</span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">state</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">iterations</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">beforeSecondErase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitForSecondErase</span><span class="w"> </span><span class="n">afterFirstErase</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="c1">// 2回目の消去</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterSecondErase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">beforeSecondErase</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterSecondErase</span><span class="o">.</span><span class="n">Chain</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;2連鎖目&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;新しいぷよを生成すると連鎖カウントがリセットされる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">gameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="o">(</span><span class="n">init</span><span class="bp">()</span><span class="o">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterNewPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">gameState</span>

<span class="w">            </span><span class="c1">// 連鎖カウントがリセットされている</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterNewPuyo</span><span class="o">.</span><span class="n">Chain</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="s">&quot;連鎖カウントがリセット&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ゲーム&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gameInitTests</span>
<span class="w">        </span><span class="n">chainTests</span>
<span class="w">        </span><span class="n">chainCountTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<h3 id="_72">プロジェクトファイルとテストの更新<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  ゲーム
    ゲームの初期化
      ✓ ゲームを初期化すると、ゲームステートが作成される
      ✓ ゲームを初期化すると、ステージが6列12行で作成される
    連鎖反応
      ✓ ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する
    連鎖カウント
      ✓ 連鎖が発生すると連鎖カウントが増加する
      ✓ 新しいぷよを生成すると連鎖カウントがリセットされる

  プレイヤー機能
    （省略）

  ステージ
    （省略）

  33 passing (Xms)
</code></pre></div>
<h3 id="_73">解説: シンプルな設計の力<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通りましたね！」はい、これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>連鎖反応の実装から学べる重要な概念について解説しましょう：</p>
<ol>
<li><strong>状態遷移による自然な連鎖</strong>:</li>
<li>複雑な連鎖ロジックを追加せずに、既存の状態遷移だけで実現</li>
<li><code>Erasing → CheckFall → CheckErase</code>のサイクルが自動的に連鎖を生む</li>
<li>
<p>各モードが単一責任を持つことで、組み合わせが自然に機能する</p>
</li>
<li>
<p><strong>パターンマッチングによる状態管理</strong>:</p>
</li>
<li>各モードの処理が明確に分離されている</li>
<li>コンパイラが全ケースをチェックしてくれる</li>
<li>
<p>新しいモードの追加も容易</p>
</li>
<li>
<p><strong>イミュータブルな状態更新</strong>:</p>
</li>
<li>各更新で新しい<code>GameState</code>を作成</li>
<li>連鎖カウントも安全に管理</li>
<li>
<p>デバッグや状態の追跡が容易</p>
</li>
<li>
<p><strong>テストファースト開発の利点</strong>:</p>
</li>
<li>テストを先に書くことで、既存実装の動作を確認できた</li>
<li>新しいコードを追加せずに、テストだけで機能の動作を検証</li>
<li>連鎖カウントの追加も既存のテストを壊さずに実装できた</li>
</ol>
<p>「TypeScriptの実装と同じように、F#でもシンプルな設計で連鎖が実現できたんですね！」その通りです。F#の型システムとパターンマッチングにより、さらに型安全で保守しやすい実装になっています。</p>
<h3 id="7_1">イテレーション 7 のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>連鎖反応の確認</strong></li>
<li>既存のゲームループで連鎖が自動的に発生</li>
<li><code>Erasing → CheckFall → CheckErase</code>のサイクルが連鎖を実現</li>
<li>
<p>新しいコードの追加なしで機能を確認</p>
</li>
<li>
<p><strong>連鎖カウント機能</strong></p>
</li>
<li><code>GameState</code>に<code>Chain</code>フィールドを追加</li>
<li>消去発生時に連鎖カウントを増加</li>
<li>
<p>新しいぷよ生成時にリセット</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>連鎖反応のテスト（1 テスト）</li>
<li>連鎖カウントのテスト（2 テスト）</li>
<li>
<p>すべてのテストが成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>シンプルな設計の力：状態遷移だけで複雑な動作を実現</li>
<li>テストファースト開発：既存機能の動作確認</li>
<li>イミュータブルな状態管理：連鎖カウントの安全な管理</li>
<li>パターンマッチング：明確な状態遷移</li>
</ol>
<p>F#のパターンマッチングとイミュータブルなデータ構造を活かして、シンプルで型安全な連鎖反応を実装できました。次のイテレーションでは、スコア計算と全消しボーナスを実装していきます！</p>
<h2 id="8">イテレーション 8: スコア計算と全消しボーナスの実装<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>「連鎖ができるようになったけど、スコアも欲しいですね！」そうですね！ぷよぷよには、消したぷよの数や連鎖数に応じたスコアシステムと、盤面上のぷよをすべて消すと得られる「全消し（ぜんけし）ボーナス」という特別な報酬があります。今回は、スコア計算と全消しボーナスを実装していきましょう！</p>
<h3 id="_74">ユーザーストーリー<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよを消すとスコアを獲得でき、盤面上のぷよをすべて消したときに全消しボーナスを獲得できる</p>
</blockquote>
<p>「ハイスコアを目指したい！」「やった！全部消えた！」という達成感と共に、スコアを獲得できる機能を実装します。</p>
<h3 id="todo_6">TODO リスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<ul>
<li>スコア計算を実装する（消したぷよの数に応じたスコアを計算する）</li>
<li>連鎖ボーナスを実装する（連鎖数に応じたボーナス点を加算する）</li>
<li>全消し判定を実装する（盤面上のぷよがすべて消えたかどうかを判定する）</li>
<li>全消しボーナスを実装する（全消し時に特別なボーナス点を加算する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_75">テスト: 全消し判定<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、全消し判定をテストしましょう。盤面上のぷよがすべて消えたかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/StageTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">zenkeshiTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;全消し判定&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;盤面上のぷよがすべて消えると全消しになる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">            </span><span class="c1">// 消去判定と実行</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkErase</span><span class="w"> </span><span class="n">stageWithPuyo</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">erasedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eraseBlocks</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 全消し判定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkZenkeshi</span><span class="w"> </span><span class="n">erasedStage</span>

<span class="w">            </span><span class="c1">// 全消しになっている</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="s">&quot;全消しになる&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;盤面上にぷよが残っていると全消しにならない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="w">  </span><span class="c1">// 消えないぷよ</span>

<span class="w">            </span><span class="c1">// 消去判定と実行</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkErase</span><span class="w"> </span><span class="n">stageWithPuyo</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">erasedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eraseBlocks</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="w"> </span><span class="n">stageWithPuyo</span>

<span class="w">            </span><span class="c1">// 全消し判定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkZenkeshi</span><span class="w"> </span><span class="n">erasedStage</span>

<span class="w">            </span><span class="c1">// 全消しになっていない</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isFalse</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="s">&quot;全消しにならない&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ステージ&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gravityTests</span>
<span class="w">        </span><span class="n">eraseTests</span>
<span class="w">        </span><span class="n">eraseExecutionTests</span>
<span class="w">        </span><span class="n">zenkeshiTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>盤面上のぷよがすべて消えた場合、全消しと判定されるか</li>
<li>盤面上にぷよが残っている場合、全消しと判定されないか</li>
</ol>
<p>「なるほど、全消し判定の条件がよく分かりますね！」では、このテストが通るように実装していきましょう。</p>
<h3 id="_76">実装: 全消し判定<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、全消し判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.fs（続き）</span>

<span class="c1">// 全消し判定（盤面上にぷよがあるかチェック）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">checkZenkeshi</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// すべてのセルをチェック</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">hasPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">exists</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">row</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">exists</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="o">))</span>

<span class="w">    </span><span class="c1">// ぷよが存在しなければ全消し</span>
<span class="w">    </span><span class="ow">not</span><span class="w"> </span><span class="n">hasPuyo</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。F#の<code>Array.exists</code>関数を使うと、配列内に条件を満たす要素があるかを簡潔にチェックできます。この実装では、ぷよがある（Empty でない）セルが存在しないかをチェックしています。</p>
<p>「<code>not hasPuyo</code>で反転しているんですね！」その通りです。<code>hasPuyo</code>が<code>true</code>（ぷよが存在する）の場合、全消しではないので<code>false</code>を返します。<code>hasPuyo</code>が<code>false</code>（ぷよが存在しない）の場合、全消しなので<code>true</code>を返します。</p>
<h3 id="_77">テスト: スコア計算<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>「次はスコア計算をテストしましょう！」はい、消したぷよの数と連鎖数に応じたスコアを計算する機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/GameTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">scoreTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;スコア計算&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;ぷよを消すとスコアが加算される&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">gameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 4つのぷよを消す（1連鎖目）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">calculateScore</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">1</span>

<span class="w">            </span><span class="c1">// スコアが加算されている</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="o">(</span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;スコアが加算される&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;連鎖数が多いほどスコアが高くなる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 1連鎖目のスコア</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">score1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">calculateScore</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">1</span>

<span class="w">            </span><span class="c1">// 2連鎖目のスコア</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">score2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">calculateScore</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">2</span>

<span class="w">            </span><span class="c1">// 2連鎖目の方がスコアが高い</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="o">(</span><span class="n">score2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">score1</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;連鎖数が多いとスコアが高い&quot;</span>

<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;消したぷよが多いほどスコアが高くなる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 4つ消した場合</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">score4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">calculateScore</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">1</span>

<span class="w">            </span><span class="c1">// 8つ消した場合</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">score8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">calculateScore</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">1</span>

<span class="w">            </span><span class="c1">// 8つ消した方がスコアが高い</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="o">(</span><span class="n">score8</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">score4</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;消したぷよが多いとスコアが高い&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ゲーム&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gameInitTests</span>
<span class="w">        </span><span class="n">chainTests</span>
<span class="w">        </span><span class="n">chainCountTests</span>
<span class="w">        </span><span class="n">scoreTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<h3 id="_78">実装: スコア計算<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>「スコア計算を実装しましょう！」はい、スコア計算のロジックを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Score.fs（新規作成）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Score</span>

<span class="c1">// 連鎖ボーナステーブル</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">chainBonusTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[|</span>
<span class="w">    </span><span class="mi">0</span><span class="w">    </span><span class="c1">// 0連鎖（使用しない）</span>
<span class="w">    </span><span class="mi">0</span><span class="w">    </span><span class="c1">// 1連鎖</span>
<span class="w">    </span><span class="mi">8</span><span class="w">    </span><span class="c1">// 2連鎖</span>
<span class="w">    </span><span class="mi">16</span><span class="w">   </span><span class="c1">// 3連鎖</span>
<span class="w">    </span><span class="mi">32</span><span class="w">   </span><span class="c1">// 4連鎖</span>
<span class="w">    </span><span class="mi">64</span><span class="w">   </span><span class="c1">// 5連鎖</span>
<span class="w">    </span><span class="mi">96</span><span class="w">   </span><span class="c1">// 6連鎖</span>
<span class="w">    </span><span class="mi">128</span><span class="w">  </span><span class="c1">// 7連鎖</span>
<span class="w">    </span><span class="mi">160</span><span class="w">  </span><span class="c1">// 8連鎖</span>
<span class="w">    </span><span class="mi">192</span><span class="w">  </span><span class="c1">// 9連鎖</span>
<span class="w">    </span><span class="mi">224</span><span class="w">  </span><span class="c1">// 10連鎖</span>
<span class="w">    </span><span class="mi">256</span><span class="w">  </span><span class="c1">// 11連鎖以上</span>
<span class="o">|]</span>

<span class="c1">// 連鎖ボーナスを取得</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">getChainBonus</span><span class="w"> </span><span class="o">(</span><span class="n">chain</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">chainBonusTable</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="n">chainBonusTable</span><span class="o">.[</span><span class="n">chainBonusTable</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">chainBonusTable</span><span class="o">.[</span><span class="n">chain</span><span class="o">]</span>

<span class="c1">// スコアを計算する</span>
<span class="c1">// erasedCount: 消したぷよの数</span>
<span class="c1">// chain: 連鎖数</span>
<span class="k">let</span><span class="w"> </span><span class="nv">calculateScore</span><span class="w"> </span><span class="o">(</span><span class="n">erasedCount</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">chain</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">chainBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChainBonus</span><span class="w"> </span><span class="n">chain</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">chainBonus</span>
<span class="w">    </span><span class="n">erasedCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bonus</span>

<span class="c1">// 全消しボーナス</span>
<span class="k">let</span><span class="w"> </span><span class="nv">zenkeshiBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span>
</code></pre></div>
<p>「連鎖ボーナステーブルを使っているんですね！」その通りです。連鎖数に応じたボーナス倍率をテーブルで管理しています。このテーブルは、本家ぷよぷよのスコア計算を参考にしています。</p>
<p>「スコアの計算式はどうなっているんですか？」スコアは以下の式で計算されます：</p>
<div class="highlight"><pre><span></span><code>スコア = 消したぷよの数 × 10 × ボーナス
</code></pre></div>
<p>ボーナスは連鎖ボーナスで、1連鎖目は0（最低でも1）、2連鎖目は8、3連鎖目は16というように増えていきます。</p>
<h3 id="_79">ゲームステートへの統合<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p>「スコアをゲームステートで管理する必要がありますね？」はい、スコアの加算処理をゲームループに統合しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs（更新）</span>

<span class="c1">// ゲームを更新する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">gameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="c1">// ... 他のケースは省略 ...</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">checkErase</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">updatedStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">eraseBlocks</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePositions</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>

<span class="w">            </span><span class="c1">// 連鎖カウントを増加</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Chain</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">            </span><span class="c1">// スコアを計算して加算</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">addedScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">calculateScore</span><span class="w"> </span><span class="n">eraseInfo</span><span class="o">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="n">newChain</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addedScore</span>

<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updatedStage</span><span class="o">;</span><span class="w"> </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newChain</span><span class="o">;</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newScore</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 消去対象がない場合、全消し判定</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">checkZenkeshi</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1">// 全消しボーナスを加算</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">newScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">zenkeshiBonus</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newScore</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">// 次のぷよを出す</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ... 他のケースは省略 ...</span>
</code></pre></div>
<p>「全消し判定もここで行われているんですね！」その通りです。消去対象がない場合に全消し判定を行い、全消しであればボーナスを加算します。</p>
<h3 id="_80">テスト: 全消しボーナス<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p>「全消しボーナスの統合テストも追加しましょう！」はい、ゲームループ全体が正しく動作することを確認するテストを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/GameTests.fs（続き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">zenkeshiBonusTests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;全消しボーナス&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;盤面上のぷよをすべて消すと全消しボーナスが加算される&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">gameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="bp">()</span>

<span class="w">            </span><span class="c1">// 初期スコア確認</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">initialScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Score</span>

<span class="w">            </span><span class="c1">// 盤面に4つのぷよを配置（すべて消去される）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gameState</span><span class="o">.</span><span class="n">Stage</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">stageWithPuyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">stage</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">            </span><span class="c1">// checkEraseモードに設定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">initialState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">gameState</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageWithPuyo</span><span class="o">;</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">}</span>

<span class="w">            </span><span class="c1">// 消去判定と処理</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterErase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">initialState</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterErase</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="w"> </span><span class="s">&quot;消去モードになる&quot;</span>

<span class="w">            </span><span class="c1">// 消去後の重力チェック</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterErasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">afterErase</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterErasing</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="s">&quot;重力チェックモードになる&quot;</span>

<span class="w">            </span><span class="c1">// 重力適用（落下なし）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterCheckFall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">afterErasing</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterCheckFall</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="s">&quot;消去チェックモードになる&quot;</span>

<span class="w">            </span><span class="c1">// 2回目の消去判定（全消し判定が実行される）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">afterSecondCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="n">afterCheckFall</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterSecondCheck</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="s">&quot;次のぷよモードになる&quot;</span>

<span class="w">            </span><span class="c1">// スコアが増加していることを確認</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="o">(</span><span class="n">afterSecondCheck</span><span class="o">.</span><span class="n">Score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">initialScore</span><span class="o">)</span><span class="w"> </span><span class="s">&quot;スコアが増加している&quot;</span>

<span class="w">            </span><span class="c1">// 全消しボーナスが含まれている</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">expectedScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">calculateScore</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nn">Score</span><span class="p">.</span><span class="n">zenkeshiBonus</span>
<span class="w">            </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">afterSecondCheck</span><span class="o">.</span><span class="n">Score</span><span class="w"> </span><span class="n">expectedScore</span><span class="w"> </span><span class="s">&quot;全消しボーナスが加算されている&quot;</span>
<span class="w">    </span><span class="o">]</span>

<span class="k">let</span><span class="w"> </span><span class="nv">tests</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">testList</span><span class="w"> </span><span class="s">&quot;ゲーム&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">gameInitTests</span>
<span class="w">        </span><span class="n">chainTests</span>
<span class="w">        </span><span class="n">chainCountTests</span>
<span class="w">        </span><span class="n">scoreTests</span>
<span class="w">        </span><span class="n">zenkeshiBonusTests</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<h3 id="_81">プロジェクトファイルとテストの更新<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>成功すれば、以下のような出力が表示されます：</p>
<div class="highlight"><pre><span></span><code>  ゲーム
    ゲームの初期化
      ✓ ゲームを初期化すると、ゲームステートが作成される
      ✓ ゲームを初期化すると、ステージが6列12行で作成される
    連鎖反応
      ✓ ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する
    連鎖カウント
      ✓ 連鎖が発生すると連鎖カウントが増加する
      ✓ 新しいぷよを生成すると連鎖カウントがリセットされる
    スコア計算
      ✓ ぷよを消すとスコアが加算される
      ✓ 連鎖数が多いほどスコアが高くなる
      ✓ 消したぷよが多いほどスコアが高くなる
    全消しボーナス
      ✓ 盤面上のぷよをすべて消すと全消しボーナスが加算される

  プレイヤー機能
    （省略）

  ステージ
    重力処理
      ✓ 個別のぷよに重力が作用する
      ✓ 浮いているぷよがない場合、何も変化しない
      ✓ 複数の浮いているぷよに重力が作用する
    ぷよの消去判定
      ✓ 同じ色のぷよが4つつながっていると、消去対象になる
      ✓ 異なる色のぷよは消去対象にならない
      ✓ 3つ以下のつながりは消去対象にならない
    ぷよの消去実行
      ✓ 消去対象のぷよを消去する
      ✓ 消去後、上にあるぷよが落下している
    全消し判定
      ✓ 盤面上のぷよがすべて消えると全消しになる
      ✓ 盤面上にぷよが残っていると全消しにならない

  37 passing (Xms)
</code></pre></div>
<h3 id="_82">解説: スコアシステムの設計<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通りましたね！」はい、これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>F#でのスコアシステムの実装から学べる重要な概念について解説しましょう：</p>
<ol>
<li><strong>配列によるテーブル管理</strong>:</li>
<li><code>chainBonusTable</code>配列で連鎖ボーナスを管理</li>
<li>インデックスアクセスで効率的な参照</li>
<li>
<p>値の追加や変更が容易</p>
</li>
<li>
<p><strong>関数による計算の分離</strong>:</p>
</li>
<li><code>calculateScore</code>関数：スコア計算ロジック</li>
<li><code>getChainBonus</code>関数：ボーナステーブルの参照</li>
<li><code>checkZenkeshi</code>関数：全消し判定</li>
<li>
<p>各関数が単一の責任を持つ</p>
</li>
<li>
<p><strong>Array.exists による存在チェック</strong>:</p>
</li>
<li>ネストした配列も簡潔に検索</li>
<li>関数型プログラミングのアプローチ</li>
<li>
<p>可読性の高いコード</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong>:</p>
</li>
<li><code>CheckErase</code>モードでスコア計算と全消し判定</li>
<li>イミュータブルな状態更新</li>
<li>パターンマッチングによる明確な処理の分離</li>
</ol>
<p>「F#の配列操作関数を使うと、簡潔に実装できますね！」その通りです。<code>Array.exists</code>や<code>Array.map</code>などの関数を使うと、ループを明示的に書く必要がなく、コードの意図が明確になります。</p>
<h3 id="8_1">イテレーション 8 のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>全消し判定機能</strong></li>
<li><code>checkZenkeshi</code>関数：盤面上のぷよの有無をチェック</li>
<li><code>Array.exists</code>による簡潔な実装</li>
<li>
<p>すべて空であれば全消し</p>
</li>
<li>
<p><strong>スコア計算機能</strong></p>
</li>
<li><code>calculateScore</code>関数：消去数と連鎖数からスコア計算</li>
<li>連鎖ボーナステーブルによる倍率管理</li>
<li>
<p>計算式：消したぷよ数 × 10 × ボーナス</p>
</li>
<li>
<p><strong>全消しボーナス</strong></p>
</li>
<li>固定値（3600点）のボーナス</li>
<li>消去対象がない場合に全消し判定</li>
<li>
<p>戦略的な深みを追加</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong></p>
</li>
<li><code>CheckErase</code>モードでスコア加算</li>
<li>消去時に連鎖カウントとスコアを更新</li>
<li>
<p>全消し時にボーナスを加算</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>全消し判定のテスト（2 テスト）</li>
<li>スコア計算のテスト（3 テスト）</li>
<li>全消しボーナスのテスト（1 テスト）</li>
<li>
<p>すべてのテストが成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>テーブル駆動による設計：連鎖ボーナステーブル</li>
<li>関数による処理の分離：計算ロジックの独立</li>
<li>配列操作関数の活用：簡潔な実装</li>
<li>イミュータブルな状態管理：スコアの安全な更新</li>
</ol>
<p>F#の関数型プログラミングのアプローチを活かして、シンプルで拡張しやすいスコアシステムを実装できました。次のイテレーションでは、ゲームオーバー判定を実装して、ぷよぷよゲームを完成させます！</p>
<hr />
<h2 id="9">イテレーション 9: ゲームオーバーの実装<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="_83">ユーザーストーリー<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。ゲームオーバーになったことを明確に伝え、適切な演出を行うことで、プレイヤーに達成感や次回への意欲を持ってもらうことができます。</p>
<h3 id="todo_7">TODO リスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ゲームオーバーを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出する）</li>
<li>ゲームモードに <code>GameOver</code> を追加する</li>
<li>ゲームオーバー演出を実装する（ゲームオーバー時に特別な表示や効果を追加する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_84">テスト: ゲームオーバー判定<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバー判定をテストしましょう。新しいぷよを配置できない状態を検出する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/tests/Player_test.fs（続き）</span>

<span class="n">testList</span><span class="w"> </span><span class="s">&quot;ゲームオーバー判定&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;新しいぷよを配置できない場合、ゲームオーバーになる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ステージの上部（中央）にぷよを配置</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">stage</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// 新しいぷよの配置位置（中央上部）を確認</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// = 2</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// ゲームオーバーになっていることを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="n">isGameOver</span><span class="w"> </span><span class="s">&quot;配置位置にぷよがある場合はゲームオーバーになる&quot;</span>

<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;新しいぷよを配置できる場合、ゲームオーバーにならない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 空のステージを作成</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">        </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// ゲームオーバーになっていないことを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isFalse</span><span class="w"> </span><span class="n">isGameOver</span><span class="w"> </span><span class="s">&quot;配置位置が空の場合はゲームオーバーにならない&quot;</span>

<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;左側の配置位置にぷよがある場合もゲームオーバーになる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ステージの上部（左側の配置位置）にぷよを配置</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// = 2（左側）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span>

<span class="w">        </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// ゲームオーバーになっていることを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">isTrue</span><span class="w"> </span><span class="n">isGameOver</span><span class="w"> </span><span class="s">&quot;左側の配置位置にぷよがある場合もゲームオーバーになる&quot;</span>
<span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、新しいぷよを配置できない状態がゲームオーバーと判定されるかを確認しています。具体的には：</p>
<ol>
<li>ステージの上部（新しいぷよが配置される位置）にぷよを配置します</li>
<li>ゲームオーバー判定を行い、ゲームオーバーになっていることを確認します</li>
<li>配置位置が空の場合は、ゲームオーバーにならないことも確認します</li>
</ol>
<p>「なるほど、新しいぷよの配置位置にすでにぷよがあると、ゲームオーバーになるんですね！」そうです！ぷよぷよでは、新しいぷよを配置する位置（通常はステージの中央上部）にすでにぷよがある場合、これ以上ゲームを続行できないため、ゲームオーバーとなります。では、このテストが通るように実装していきましょう。</p>
<h3 id="_85">実装: ゲームオーバー判定<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームオーバー判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（続き）</span>

<span class="sd">/// 新しいぷよを配置できるか確認する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">checkGameOver</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 新しいぷよの配置位置（中央上部）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// 配置位置のどちらかにすでにぷよがある場合はゲームオーバー</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">leftCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rightCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">]</span>

<span class="w">    </span><span class="n">leftCell</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">rightCell</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。ゲームオーバー判定の実装自体はとてもシンプルです。新しいぷよの配置位置（中央上部）を計算し、その位置にすでにぷよがあるかどうかをチェックしています。</p>
<p>「<code>x + 1</code> もチェックしているのはなぜですか？」良い質問ですね！ぷよぷよでは、新しいぷよは 2 つ連なった状態で登場します。通常、1 つは中央（x）に、もう 1 つはその右隣（x + 1）に配置されます。そのため、どちらかの位置にすでにぷよがある場合は、新しいぷよを配置できないと判断します。</p>
<p>「F# の論理演算子を使うと、簡潔に書けますね！」その通りです。<code>||</code> 演算子（論理和）を使って、左右どちらかにぷよがあるかをチェックしています。F# の演算子は短絡評価（short-circuit evaluation）をサポートしているので、効率的に判定できます。</p>
<h3 id="_86">解説: ゲームオーバー判定<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー判定では、以下のことを行っています：</p>
<ol>
<li><strong>配置位置の計算</strong>: 新しいぷよの配置位置（中央上部）を計算</li>
<li><strong>セルの取得</strong>: 配置位置のセル（左と右）を取得</li>
<li><strong>判定</strong>: どちらかのセルにぷよがある場合、ゲームオーバーと判定</li>
</ol>
<p>「F# のパターンマッチングは使わないんですか？」この場合は、論理演算子を使った方がシンプルで読みやすいと判断しました。パターンマッチングは強力ですが、すべてのケースで使う必要はありません。状況に応じて適切な方法を選ぶのが大切です。</p>
<p>「テストは通りましたか？」はい、これでテストは通るはずです！次は、ゲームモードに <code>GameOver</code> を追加して、ゲームオーバー演出を実装していきましょう。</p>
<h3 id="_87">テスト: ゲームオーバー演出<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<p>「ゲームオーバー演出はどのようにテストすればいいですか？」ゲームオーバー演出は、ゲームの状態（モード）が変わることをテストするといいでしょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/tests/Game_test.fs（続き）</span>

<span class="n">testList</span><span class="w"> </span><span class="s">&quot;ゲームオーバー処理&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;新しいぷよを配置できない場合、ゲームモードがGameOverに変わる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ステージの上部にぷよを配置してゲームオーバー条件を作る</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">stage</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// ゲームモードをNewPuyoに設定</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">            </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="o">;</span><span class="w"> </span><span class="n">PuyoQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">IsDownPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="o">;</span><span class="w"> </span><span class="n">IsLeftPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="o">;</span><span class="w"> </span><span class="n">IsRightPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="o">;</span><span class="w"> </span><span class="n">IsRotatePressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// ゲームループを実行（NewPuyoモードの処理）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Game</span><span class="p">.</span><span class="n">handleNewPuyo</span><span class="w"> </span><span class="n">state</span>

<span class="w">        </span><span class="c1">// ゲームモードがGameOverになっていることを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">newState</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="w"> </span><span class="s">&quot;配置できない場合はゲームオーバーになる&quot;</span>

<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;新しいぷよを配置できる場合、ゲームモードがPlayingに変わる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 空のステージを作成</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">        </span><span class="c1">// ゲームモードをNewPuyoに設定</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span>
<span class="w">            </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="o">;</span><span class="w"> </span><span class="n">PuyoQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">IsDownPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="o">;</span><span class="w"> </span><span class="n">IsLeftPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="o">;</span><span class="w"> </span><span class="n">IsRightPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="o">;</span><span class="w"> </span><span class="n">IsRotatePressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// ゲームループを実行</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Game</span><span class="p">.</span><span class="n">handleNewPuyo</span><span class="w"> </span><span class="n">state</span>

<span class="w">        </span><span class="c1">// ゲームモードがPlayingになっていることを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">newState</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="s">&quot;配置できる場合はプレイ中になる&quot;</span>
<span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、ゲームオーバー条件が満たされた場合に、ゲームの状態（モード）が <code>GameOver</code> に変わることを確認しています。具体的には：</p>
<ol>
<li>ステージの上部にぷよを配置して、ゲームオーバー条件を作ります</li>
<li>ゲームモードを <code>NewPuyo</code>（新しいぷよを生成するモード）に設定します</li>
<li>ゲームループを実行します</li>
<li>ゲームモードが <code>GameOver</code> に変わっていることを確認します</li>
</ol>
<p>「なるほど、ゲームの状態遷移をテストしているんですね！」そうです！ゲームオーバーになると、ゲームの状態が変わり、それに応じた演出が行われるようになります。では、このテストが通るように実装していきましょう。</p>
<h3 id="_88">実装: ゲームモードの拡張<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h3>
<p>まず、<code>GameMode</code> に <code>GameOver</code> を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Types.fs（GameModeの定義を更新）</span>

<span class="k">type</span><span class="w"> </span><span class="nc">GameMode</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">NewPuyo</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">CheckFall</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">CheckErase</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Erasing</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span><span class="w">  </span><span class="c1">// ゲームオーバーモードを追加</span>
</code></pre></div>
<p>「判別共用体に新しいケースを追加するだけですね！」その通りです。F# の判別共用体は、新しいケースを追加するだけで、パターンマッチングが不完全な場所でコンパイラが警告を出してくれます。これにより、実装漏れを防ぐことができます。</p>
<h3 id="_89">実装: ゲームオーバー演出<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームオーバー演出を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs（続き）</span>

<span class="sd">/// 新しいぷよの生成処理</span>
<span class="k">let</span><span class="w"> </span><span class="nv">handleNewPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">createNewPuyo</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">Player</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">Stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="c1">// ゲームオーバーになった場合</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newPlayer</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="c1">// ゲームを続行できる場合</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newPlayer</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。新しいぷよを作成した後、ゲームオーバー判定を行い、結果に応じてゲームモードを変更しています。</p>
<p>「F# の <code>if</code> 式を使っていますね！」その通りです。F# の <code>if</code> は文（statement）ではなく式（expression）なので、値を返すことができます。これにより、条件に応じて異なる値を返すコードが簡潔に書けます。</p>
<p>次に、ゲームループで <code>GameOver</code> モードを処理できるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.fs（ゲームループの更新）</span>

<span class="sd">/// ゲームの更新処理</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="o">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">Mode</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handleNewPuyo</span><span class="w"> </span><span class="n">state</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handlePlaying</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">deltaTime</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handleCheckFall</span><span class="w"> </span><span class="n">state</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handleCheckErase</span><span class="w"> </span><span class="n">state</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">handleErasing</span><span class="w"> </span><span class="n">state</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nn">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ゲームオーバー時は状態を変更しない</span>
<span class="w">        </span><span class="n">state</span>
</code></pre></div>
<p>「<code>GameOver</code> モードでは何もしないんですか？」そうです。ゲームオーバー状態では、ゲームの進行を停止します。UI の更新は別の場所で処理されるので、ここでは状態を変更せずにそのまま返します。</p>
<h3 id="_90">解説: ゲームオーバー演出<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー演出では、以下のことを行っています：</p>
<ol>
<li><strong>ゲームループでのゲームオーバー判定</strong>: <code>NewPuyo</code> モードで新しいぷよを作成した直後にチェック</li>
<li><strong>ゲームモードの変更</strong>: 条件が満たされた場合は <code>GameOver</code> モードに変更</li>
<li><strong>ゲーム進行の停止</strong>: <code>GameOver</code> モードでは状態を更新しない</li>
</ol>
<p>「ゲームオーバー判定はいつ行われるんですか？」良い質問ですね！ゲームオーバー判定は、新しいぷよを生成するタイミングで行われます。新しいぷよを生成しようとしたときに、配置位置にすでにぷよがあれば、ゲームオーバーとなります。</p>
<p>「UI の表示はどうするんですか？」UI の表示は、Fable で HTML 要素を操作することで実装できます。ゲームオーバー時に特別な要素を表示したり、既存の要素を更新したりします。例えば：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Render.fs（例）</span>

<span class="sd">/// ゲームオーバー表示</span>
<span class="k">let</span><span class="w"> </span><span class="nv">showGameOver</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Browser</span><span class="p">.</span><span class="nn">Dom</span><span class="p">.</span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="o">(</span><span class="s">&quot;gameOver&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">el</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">el</span><span class="o">?</span><span class="n">style</span><span class="o">?</span><span class="n">display</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;block&quot;</span>

<span class="sd">/// ゲームオーバー非表示</span>
<span class="k">let</span><span class="w"> </span><span class="nv">hideGameOver</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Browser</span><span class="p">.</span><span class="nn">Dom</span><span class="p">.</span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="o">(</span><span class="s">&quot;gameOver&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">el</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">el</span><span class="o">?</span><span class="n">style</span><span class="o">?</span><span class="n">display</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;none&quot;</span>
</code></pre></div>
<p>HTML 側では、あらかじめゲームオーバー用の要素を用意しておきます：</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;gameOver&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 48px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); z-index: 1000;&quot;</span><span class="p">&gt;</span>
  GAME OVER
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>
<p>「F# でも DOM 操作ができるんですね！」そうです！Fable は F# を JavaScript に変換するため、JavaScript でできることは F# でもできます。ただし、F# の型安全性を保つために、動的プロパティアクセス（<code>?</code> 演算子）を使う場合は注意が必要です。</p>
<h3 id="_91">テスト結果<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h3>
<p>実装が完了したら、すべてのテストが通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>結果：
<div class="highlight"><pre><span></span><code>  Player module
    ゲームオーバー判定
      ✓ 新しいぷよを配置できない場合、ゲームオーバーになる
      ✓ 新しいぷよを配置できる場合、ゲームオーバーにならない
      ✓ 左側の配置位置にぷよがある場合もゲームオーバーになる

  Game module
    ゲームオーバー処理
      ✓ 新しいぷよを配置できない場合、ゲームモードがGameOverに変わる
      ✓ 新しいぷよを配置できる場合、ゲームモードがPlayingに変わる

  42 passing (Xms)
</code></pre></div></p>
<p>「42 個すべてのテストが通りましたね！」素晴らしいです。これまでのイテレーションで書いたテストも含めて、すべてが正常に動作していることが確認できました。</p>
<h3 id="_92">解説: ゲームオーバーシステムの設計<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通りましたね！」はい、これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>F# でのゲームオーバーシステムの実装から学べる重要な概念について解説しましょう：</p>
<ol>
<li><strong>判別共用体による状態管理</strong>:</li>
<li><code>GameMode</code> に <code>GameOver</code> ケースを追加</li>
<li>パターンマッチングで網羅的な処理</li>
<li>
<p>コンパイラが実装漏れを検出</p>
</li>
<li>
<p><strong>純粋関数による判定</strong>:</p>
</li>
<li><code>checkGameOver</code> 関数：副作用なしの判定</li>
<li>ステージの状態のみに依存</li>
<li>
<p>テストが容易</p>
</li>
<li>
<p><strong>if 式による条件分岐</strong>:</p>
</li>
<li>文ではなく式として扱う</li>
<li>両方のブランチで値を返す</li>
<li>
<p>簡潔で読みやすいコード</p>
</li>
<li>
<p><strong>イミュータブルな状態遷移</strong>:</p>
</li>
<li><code>handleNewPuyo</code> 関数で新しい状態を返す</li>
<li>元の状態は変更しない</li>
<li>
<p>バグの発生を防ぐ</p>
</li>
<li>
<p><strong>型安全な DOM 操作</strong>:</p>
</li>
<li>Option 型で null チェック</li>
<li>動的プロパティアクセス（<code>?</code> 演算子）</li>
<li>JavaScript との相互運用</li>
</ol>
<p>「F# の型システムが安全性を保証してくれますね！」その通りです。判別共用体のパターンマッチングが網羅的でない場合、コンパイラが警告を出してくれます。これにより、実装漏れを防ぎ、安全なコードを書くことができます。</p>
<h3 id="9_1">イテレーション 9 のまとめ<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ゲームオーバー判定機能</strong></li>
<li><code>checkGameOver</code> 関数：配置位置のぷよをチェック</li>
<li>論理演算子による簡潔な判定</li>
<li>
<p>左右どちらかにぷよがあればゲームオーバー</p>
</li>
<li>
<p><strong>ゲームモードの拡張</strong></p>
</li>
<li><code>GameMode</code> に <code>GameOver</code> ケースを追加</li>
<li>判別共用体による型安全な状態管理</li>
<li>
<p>パターンマッチングの更新</p>
</li>
<li>
<p><strong>ゲームオーバー処理</strong></p>
</li>
<li><code>handleNewPuyo</code> 関数でゲームオーバー判定</li>
<li>条件に応じてモードを変更</li>
<li>
<p>ゲームオーバー時は状態を変更しない</p>
</li>
<li>
<p><strong>DOM 操作による演出</strong></p>
</li>
<li>HTML 要素の表示/非表示</li>
<li>Fable による JavaScript 相互運用</li>
<li>
<p>型安全な DOM アクセス</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ゲームオーバー判定のテスト（3 テスト）</li>
<li>ゲームオーバー処理のテスト（2 テスト）</li>
<li>
<p>すべてのテストが成功</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>判別共用体による状態管理：型安全な設計</li>
<li>if 式による条件分岐：簡潔な実装</li>
<li>イミュータブルな状態遷移：バグの防止</li>
<li>Option 型による null 安全性：安全な DOM 操作</li>
</ol>
<p>F# の型システムと関数型プログラミングのアプローチを活かして、安全で拡張しやすいゲームオーバーシステムを実装できました。これで、ぷよぷよゲームの基本的な機能がすべて実装されました！</p>
<hr />
<h2 id="10">イテレーション 10: 衝突判定の修正<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="_93">発見されたバグ<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h3>
<p>ゲームをプレイテストした結果、以下の重大なバグが発見されました：</p>
<ol>
<li><strong>回転時の衝突判定の欠落</strong></li>
<li>既に着地したぷよの位置に回転できてしまう</li>
<li>
<p>回転によって既存のぷよを上書きしてしまう</p>
</li>
<li>
<p><strong>移動時の衝突判定の欠落</strong></p>
</li>
<li>左右に移動する際、既に着地したぷよの位置に移動できてしまう</li>
<li>移動によって既存のぷよを上書きしてしまう</li>
</ol>
<h3 id="_94">なぜテストで検出されなかったのか<a class="headerlink" href="#_94" title="Permanent link">&para;</a></h3>
<p>イテレーション 3 で回転機能を実装した際、以下のテストケースしか作成していませんでした：</p>
<ul>
<li>壁際での回転（壁キック機能のテスト）</li>
<li>回転状態の遷移（<code>Up → Right → Down → Left → Up</code>）</li>
</ul>
<p><strong>欠けていたテストケース</strong>：
- 既存のぷよがある位置への回転
- 既存のぷよがある位置への移動</p>
<p>これは TDD における重要な教訓です。「テストされていない機能は動作しない」という原則を再確認できました。</p>
<h3 id="_95">ユーザーストーリー<a class="headerlink" href="#_95" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで修正する内容をユーザーストーリーとして確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、既に着地したぷよの位置に移動や回転ができないことを期待する</p>
</blockquote>
<p>「既存のぷよを上書きしてしまうのは、ゲームとして致命的なバグですね！」その通りです。このバグを修正しないと、ゲームの基本ルールが成り立ちません。テスト駆動開発の流れに沿って、まずはバグを再現するテストを書いてから修正していきましょう。</p>
<h3 id="todo_8">TODO リスト<a class="headerlink" href="#todo_8" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このバグを修正するために、TODO リストを作成してみましょう。</p>
<p>バグ修正のためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>移動時の衝突判定を実装する（既存のぷよとの衝突を検出する）</li>
<li>回転時の衝突判定を実装する（既存のぷよとの衝突を検出する）</li>
<li>既存のテストを修正する（Y=0 での配置問題を解決する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。バグ発見時の TDD のアプローチは：</p>
<ol>
<li><strong>Red</strong>: バグを再現するテストを書く</li>
<li><strong>Green</strong>: バグを修正してテストを通す</li>
<li><strong>Refactor</strong>: 同様のバグを防ぐためのテストを追加</li>
</ol>
<h3 id="_96">テスト: 移動時の衝突判定<a class="headerlink" href="#_96" title="Permanent link">&para;</a></h3>
<p>「まずは移動時の衝突判定のテストを書きましょう！」バグを再現するテストから始めます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/tests/Player_test.fs（続き）</span>

<span class="n">testList</span><span class="w"> </span><span class="s">&quot;移動時の衝突判定&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;既存のぷよがある位置には左に移動できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ステージを作成し、障害物を配置</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// ぷよペアを作成（軸ぷよを (3, 5) に配置、上向き）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// 左に移動を試みる</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">moved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">moveLeft</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// 移動していないことを確認（X 座標が変わっていない）</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">moved</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="s">&quot;障害物があるため移動できない&quot;</span>

<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;既存のぷよがある位置には右に移動できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ステージを作成し、障害物を配置</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// ぷよペアを作成（軸ぷよを (2, 5) に配置、上向き）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// 右に移動を試みる</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">moved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">moveRight</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// 移動していないことを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">moved</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;障害物があるため移動できない&quot;</span>

<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;子ぷよの位置に障害物がある場合も移動できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ステージを作成し、子ぷよの移動先に障害物を配置</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// ぷよペアを作成（右向き rotation=Right）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// 右に移動を試みる</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">moved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">moveRight</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// 移動していないことを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">moved</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">&quot;子ぷよの位置に障害物があるため移動できない&quot;</span>
<span class="o">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、移動先に既存のぷよがある場合に移動できないことを確認しています。具体的には：</p>
<ol>
<li>ステージに障害物（既存のぷよ）を配置します</li>
<li>ぷよペアを移動させようとします</li>
<li>移動できず、元の位置のままであることを確認します</li>
</ol>
<p>「3 つ目のテストは子ぷよの位置もチェックしているんですね！」その通りです。ぷよペアは 2 つのぷよから構成されているので、軸ぷよだけでなく子ぷよの位置にも障害物がある場合は移動できないことを確認する必要があります。</p>
<h3 id="_97">実装: 移動時の衝突判定<a class="headerlink" href="#_97" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、移動時の衝突判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（続き）</span>

<span class="sd">/// 指定した位置に移動できるか確認する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">canMoveTo</span><span class="w"> </span><span class="o">(</span><span class="n">axisPos</span><span class="o">:</span><span class="w"> </span><span class="n">Position</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">childPos</span><span class="o">:</span><span class="w"> </span><span class="n">Position</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 軸ぷよの範囲チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">axisPos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">axisPos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">axisPos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">axisPos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">false</span>
<span class="w">    </span><span class="c1">// 子ぷよの範囲チェック</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">childPos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childPos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childPos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childPos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">false</span>
<span class="w">    </span><span class="c1">// 軸ぷよの衝突チェック</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">axisPos</span><span class="o">.</span><span class="n">Y</span><span class="o">].[</span><span class="n">axisPos</span><span class="o">.</span><span class="n">X</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">false</span>
<span class="w">    </span><span class="c1">// 子ぷよの衝突チェック</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">childPos</span><span class="o">.</span><span class="n">Y</span><span class="o">].[</span><span class="n">childPos</span><span class="o">.</span><span class="n">X</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">false</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">true</span>

<span class="sd">/// ぷよペアを左に移動する（衝突判定付き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">moveLeft</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newAxisPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newChildPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">canMoveTo</span><span class="w"> </span><span class="n">newAxisPos</span><span class="w"> </span><span class="n">newChildPos</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisPos</span><span class="w"> </span><span class="o">}</span>
<span class="w">          </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newChildPos</span><span class="w"> </span><span class="o">}</span>
<span class="w">          </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">puyoPair</span>

<span class="sd">/// ぷよペアを右に移動する（衝突判定付き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">moveRight</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newAxisPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newChildPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">canMoveTo</span><span class="w"> </span><span class="n">newAxisPos</span><span class="w"> </span><span class="n">newChildPos</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisPos</span><span class="w"> </span><span class="o">}</span>
<span class="w">          </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newChildPos</span><span class="w"> </span><span class="o">}</span>
<span class="w">          </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">puyoPair</span>
</code></pre></div>
<p>「<code>canMoveTo</code> 関数を追加して、衝突判定を行っているんですね！」その通りです。この関数は、移動先の位置が有効かどうかを以下の順序でチェックしています：</p>
<ol>
<li><strong>範囲チェック</strong>: 軸ぷよと子ぷよの位置がステージ内にあるか</li>
<li><strong>衝突チェック</strong>: 軸ぷよと子ぷよの位置に既存のぷよがないか</li>
</ol>
<p>「F# の <code>if-elif-else</code> 式を使って、段階的にチェックしているんですね！」そうです。各条件が false の場合に次の条件をチェックする構造になっています。最終的にすべての条件をクリアした場合のみ <code>true</code> を返します。</p>
<p>「<code>moveLeft</code> と <code>moveRight</code> も更新されていますね！」はい、これらの関数は <code>canMoveTo</code> を使って移動可能かチェックし、移動できる場合は新しい位置を返し、移動できない場合は元の位置をそのまま返します。</p>
<h3 id="_98">テスト: 回転時の衝突判定<a class="headerlink" href="#_98" title="Permanent link">&para;</a></h3>
<p>「次は回転時の衝突判定のテストを書きましょう！」回転時の衝突判定も、移動時と同様にバグを再現するテストから始めます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/tests/Player_test.fs（続き）</span>

<span class="n">testList</span><span class="w"> </span><span class="s">&quot;回転時の衝突判定&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;既存のぷよがある位置には回転できない&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ステージを作成し、回転先に障害物を配置</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// ぷよペアを作成（上向き）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// 右回転を試みる（Up → Right、子ぷよが (3, 5) に移動）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// 回転していないことを確認（回転方向が変わっていない）</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span><span class="w"> </span><span class="s">&quot;障害物があるため回転できない&quot;</span>

<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;回転後の位置が空いていれば回転できる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 空のステージを作成</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">        </span><span class="c1">// ぷよペアを作成（上向き）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// 右回転を試みる</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// 回転していることを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span><span class="w"> </span><span class="s">&quot;障害物がないため回転できる&quot;</span>

<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;壁際での回転時も衝突判定が行われる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ステージを作成し、壁キック先に障害物を配置</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">setPuyo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// ぷよペアを左端に配置（上向き）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// 右回転を試みる（壁キックで X=1 に移動しようとするが、障害物がある）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// 回転していないことを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span><span class="w"> </span><span class="s">&quot;壁キック先に障害物があるため回転できない&quot;</span>
<span class="o">]</span>
</code></pre></div>
<p>「回転時の衝突判定は複雑ですね！」そうですね。回転時は以下の要素を考慮する必要があります：</p>
<ol>
<li><strong>回転後の子ぷよの位置</strong>: 回転方向に応じて子ぷよの位置が変わる</li>
<li><strong>壁キック</strong>: 壁際での回転時は軸ぷよの位置も調整される</li>
<li><strong>衝突判定</strong>: 回転後の位置に既存のぷよがないか確認</li>
</ol>
<h3 id="_99">実装: 回転時の衝突判定<a class="headerlink" href="#_99" title="Permanent link">&para;</a></h3>
<p>「では、回転時の衝突判定を実装していきましょう！」まず、回転可能かどうかを判定する関数を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.fs（続き）</span>

<span class="sd">/// 指定した位置に回転できるか確認する</span>
<span class="k">let</span><span class="w"> </span><span class="nv">canRotateTo</span><span class="w"> </span><span class="o">(</span><span class="n">childPos</span><span class="o">:</span><span class="w"> </span><span class="n">Position</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 子ぷよの範囲チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">childPos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childPos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childPos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childPos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">false</span>
<span class="w">    </span><span class="c1">// 子ぷよの衝突チェック</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">childPos</span><span class="o">.</span><span class="n">Y</span><span class="o">].[</span><span class="n">childPos</span><span class="o">.</span><span class="n">X</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">false</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">true</span>

<span class="sd">/// ぷよペアを右回転する（衝突判定付き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">rotateRight</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 次の回転方向を計算</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newRotation</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Down</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Left</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span>

<span class="w">    </span><span class="c1">// 回転後のオフセットを計算</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">offsetX</span><span class="o">,</span><span class="w"> </span><span class="n">offsetY</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">newRotation</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 壁キック処理</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1">// 回転後の子ぷよの位置を再計算</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">finalChildPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span>
<span class="w">        </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetY</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// 回転可能かチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">canRotateTo</span><span class="w"> </span><span class="n">finalChildPos</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">          </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">finalChildPos</span><span class="w"> </span><span class="o">}</span>
<span class="w">          </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">puyoPair</span>

<span class="sd">/// ぷよペアを左回転する（衝突判定付き）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">rotateLeft</span><span class="w"> </span><span class="o">(</span><span class="n">puyoPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">StageState</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 次の回転方向を計算</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newRotation</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Left</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Down</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span>

<span class="w">    </span><span class="c1">// 回転後のオフセットを計算</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">offsetX</span><span class="o">,</span><span class="w"> </span><span class="n">offsetY</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">newRotation</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 壁キック処理</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">X</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1">// 回転後の子ぷよの位置を再計算</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">finalChildPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetX</span>
<span class="w">        </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offsetY</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// 回転可能かチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">canRotateTo</span><span class="w"> </span><span class="n">finalChildPos</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">          </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">puyoPair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">finalChildPos</span><span class="w"> </span><span class="o">}</span>
<span class="w">          </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">puyoPair</span>
</code></pre></div>
<p>「<code>canRotateTo</code> 関数で回転可能かチェックしているんですね！」その通りです。この関数は、回転後の子ぷよの位置が有効かどうかをチェックしています。</p>
<p>「<code>rotateRight</code> と <code>rotateLeft</code> では、壁キック処理も実装されていますね！」はい、壁際での回転時は、軸ぷよの位置を調整してから回転可能かチェックします。これにより、壁キック先に障害物がある場合は回転できないようになります。</p>
<p>「F# のミュータブル変数（<code>mutable</code>）を使っていますね！」そうです。壁キック処理では、軸ぷよの X 座標を条件に応じて変更する必要があるため、<code>mutable</code> キーワードを使っています。ただし、この変更はローカルスコープ内に限定されており、関数の外部には影響しません。</p>
<h3 id="_100">既存のテストの修正<a class="headerlink" href="#_100" title="Permanent link">&para;</a></h3>
<p>「既存のテストも修正が必要なんですか？」はい、実は既存の回転・移動テストが失敗していた原因は、ぷよペアが Y=0（画面最上部）に配置されており、上向き（<code>RotationDirection.Up</code>）の子ぷよが Y=-1（画面外）に配置されてしまうためでした。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/tests/Player_test.fs（既存テストの修正）</span>

<span class="n">testList</span><span class="w"> </span><span class="s">&quot;ぷよの回転&quot;</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="n">testCase</span><span class="w"> </span><span class="s">&quot;右回転でぷよの向きが変わる&quot;</span><span class="w"> </span><span class="o">&lt;|</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Stage</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">        </span><span class="c1">// ぷよペアを作成（移動可能な位置 Y=5 に配置）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">puyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Up</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// 右回転を実行</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Player</span><span class="p">.</span><span class="n">rotateRight</span><span class="w"> </span><span class="n">puyoPair</span><span class="w"> </span><span class="n">stage</span>

<span class="w">        </span><span class="c1">// 回転方向が変わっていることを確認</span>
<span class="w">        </span><span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span><span class="w"> </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="nn">RotationDirection</span><span class="p">.</span><span class="n">Right</span><span class="w"> </span><span class="s">&quot;右回転で Right になる&quot;</span>

<span class="w">    </span><span class="c1">// 他のテストも同様に Y=5 に配置するよう修正</span>
<span class="o">]</span>
</code></pre></div>
<p>「Y=0 ではなく Y=5 に配置することで、上向きの子ぷよが画面外に出ないようにしているんですね！」その通りです。これにより、すべてのテストが正常に動作するようになります。</p>
<h3 id="_101">テスト結果<a class="headerlink" href="#_101" title="Permanent link">&para;</a></h3>
<p>実装が完了したら、すべてのテストが通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>結果：
<div class="highlight"><pre><span></span><code>  Player module
    移動時の衝突判定
      ✓ 既存のぷよがある位置には左に移動できない
      ✓ 既存のぷよがある位置には右に移動できない
      ✓ 子ぷよの位置に障害物がある場合も移動できない
    回転時の衝突判定
      ✓ 既存のぷよがある位置には回転できない
      ✓ 回転後の位置が空いていれば回転できる
      ✓ 壁際での回転時も衝突判定が行われる

  50 passing (Xms)
</code></pre></div></p>
<p>「50 個すべてのテストが通りましたね！」素晴らしいです。バグを修正し、衝突判定が正しく動作することが確認できました。</p>
<h3 id="_102">解説: 衝突判定の設計<a class="headerlink" href="#_102" title="Permanent link">&para;</a></h3>
<p>「すべてのテストが通りましたね！」はい、これでバグが修正されました。</p>
<p>F# での衝突判定の実装から学べる重要な概念について解説しましょう：</p>
<ol>
<li><strong>ヘルパー関数による責任の分離</strong>:</li>
<li><code>canMoveTo</code> 関数：移動可能性の判定</li>
<li><code>canRotateTo</code> 関数：回転可能性の判定</li>
<li>
<p>各関数が単一の責任を持つ</p>
</li>
<li>
<p><strong>段階的な条件チェック</strong>:</p>
</li>
<li><code>if-elif-else</code> 式で複数の条件を段階的にチェック</li>
<li>早期リターンで効率的な判定</li>
<li>
<p>可読性の高いコード</p>
</li>
<li>
<p><strong>イミュータブルな設計の維持</strong>:</p>
</li>
<li>移動・回転関数は新しいぷよペアを返す</li>
<li>元のぷよペアは変更しない</li>
<li>
<p>条件を満たさない場合は元のぷよペアを返す</p>
</li>
<li>
<p><strong>ミュータブル変数の限定的使用</strong>:</p>
</li>
<li>壁キック処理でのみ <code>mutable</code> を使用</li>
<li>ローカルスコープ内に限定</li>
<li>
<p>関数の外部には影響しない</p>
</li>
<li>
<p><strong>パターンマッチングによる明確な分岐</strong>:</p>
</li>
<li>回転方向の計算</li>
<li>オフセットの計算</li>
<li>網羅的なケース処理</li>
</ol>
<p>「F# の関数型アプローチでも、必要に応じてミュータブル変数が使えるんですね！」その通りです。F# は関数型言語ですが、現実的な問題を解決するために、必要に応じて命令型の要素も使用できます。ただし、その使用は最小限に抑え、関数の外部には影響しないように設計することが重要です。</p>
<h3 id="_103">学んだ教訓<a class="headerlink" href="#_103" title="Permanent link">&para;</a></h3>
<p>このイテレーションから学べる重要な教訓をまとめましょう：</p>
<ol>
<li><strong>テストカバレッジの重要性</strong></li>
<li>機能を実装したら、その機能の「正常系」だけでなく「異常系」もテストする</li>
<li>境界値テストだけでなく、衝突判定のような制約条件もテストする</li>
<li>
<p>テストされていない機能は動作しないと考える</p>
</li>
<li>
<p><strong>プレイテストの重要性</strong></p>
</li>
<li>自動テストでカバーできない部分は手動テストで補完</li>
<li>実際にゲームを遊んでみることで、テストケースの漏れに気づける</li>
<li>
<p>ユーザー視点でのバグ発見</p>
</li>
<li>
<p><strong>TDD のサイクルを守る</strong></p>
</li>
<li>Red（失敗するテストを書く）</li>
<li>Green（テストを通す最小限の実装）</li>
<li>Refactor（リファクタリング）</li>
<li>
<p><strong>重要</strong>: テストを書かずに実装すると、バグを見逃す可能性が高い</p>
</li>
<li>
<p><strong>バグ発見時の対応</strong></p>
</li>
<li>まずテストを書いてバグを再現（Red）</li>
<li>テストが失敗することを確認</li>
<li>バグを修正してテストを通す（Green）</li>
<li>
<p>同様のバグを防ぐためのテストを追加</p>
</li>
<li>
<p><strong>関数型プログラミングにおける設計</strong></p>
</li>
<li>イミュータブルな設計を基本とする</li>
<li>必要に応じてミュータブル変数を使用</li>
<li>ただし、その影響範囲を限定する</li>
<li>関数の外部には副作用を与えない</li>
</ol>
<p>「テスト駆動開発の重要性が改めて理解できました！」そうですね。このバグは、テストを先に書いていれば防げたはずです。TDD の「テストファースト」の原則を守ることで、品質の高いコードを書くことができます。</p>
<h3 id="10_1">イテレーション 10 のまとめ<a class="headerlink" href="#10_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで修正した内容：</p>
<ol>
<li><strong>移動時の衝突判定</strong></li>
<li><code>canMoveTo</code> 関数：移動可能性の判定</li>
<li>軸ぷよと子ぷよの両方をチェック</li>
<li>
<p><code>moveLeft</code> と <code>moveRight</code> 関数の更新</p>
</li>
<li>
<p><strong>回転時の衝突判定</strong></p>
</li>
<li><code>canRotateTo</code> 関数：回転可能性の判定</li>
<li>壁キック処理との統合</li>
<li>
<p><code>rotateRight</code> と <code>rotateLeft</code> 関数の更新</p>
</li>
<li>
<p><strong>既存テストの修正</strong></p>
</li>
<li>ぷよペアの配置位置を Y=5 に変更</li>
<li>画面外への配置問題を解決</li>
<li>
<p>すべてのテストが通ることを確認</p>
</li>
<li>
<p><strong>テストの追加</strong></p>
</li>
<li>移動時の衝突判定のテスト（3 テスト）</li>
<li>回転時の衝突判定のテスト（3 テスト）</li>
<li>
<p>バグの再現と修正の確認</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>テストカバレッジの重要性：正常系と異常系の両方をテスト</li>
<li>プレイテストの重要性：手動テストによる品質保証</li>
<li>TDD のサイクル：Red-Green-Refactor の厳守</li>
<li>バグ発見時の対応：まずテストを書いて再現</li>
<li>関数型設計：イミュータブルを基本、必要に応じてミュータブル</li>
</ol>
<p>F# の関数型プログラミングのアプローチを活かしながら、現実的な問題解決のために必要な柔軟性も取り入れることができました。これで、ぷよぷよゲームの衝突判定が正しく動作するようになり、ゲームの品質が大幅に向上しました！</p>
<hr />
<h2 id="_104">ふりかえり<a class="headerlink" href="#_104" title="Permanent link">&para;</a></h2>
<p>ぷよぷよゲームの実装を完了することができたので、これまでのふりかえりをしておきましょう。</p>
<h3 id="keep">Keep（続けること）<a class="headerlink" href="#keep" title="Permanent link">&para;</a></h3>
<p>まず <strong>TODO リスト</strong> を作成して <strong>テストファースト</strong> で 1 つずつ小さなステップで開発を進めていきました。テスト駆動開発の「Red-Green-Refactor」サイクルに従うことで、コードの品質を保ちながら、段階的に機能を追加していくことができました。</p>
<p>各イテレーションでは、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に進めていきました。この流れは非常に効果的で、実装の方針が明確になり、必要最小限のコードで機能を実現することができました。</p>
<p>特に以下の点は今後も続けていきたいプラクティスです：</p>
<ol>
<li><strong>ユーザーストーリーから TODO リストへの分解</strong>: ユーザーの価値に焦点を当てた開発</li>
<li><strong>テストファーストの原則</strong>: バグを早期に発見し、品質を保証</li>
<li><strong>小さなステップでの開発</strong>: 段階的に機能を追加し、リスクを最小化</li>
<li><strong>リファクタリングによる継続的な改善</strong>: コードの品質を維持しながら進化</li>
</ol>
<h3 id="problem">Problem（課題）<a class="headerlink" href="#problem" title="Permanent link">&para;</a></h3>
<p>開発を進める中で、いくつかの課題も見えてきました。</p>
<p>まず、<strong>テストの粒度</strong> をどの程度にするかという判断が難しい場面がありました。細かすぎるテストは冗長になり、大きすぎるテストは問題の特定が難しくなります。適切なバランスを見つけることが重要です。</p>
<p>また、<strong>リファクタリングのタイミング</strong> も課題でした。機能追加とリファクタリングのバランスをどう取るか、特に初期段階でのリファクタリングの重要性と、後回しにすることのリスクを実感しました。</p>
<p>ゲームロジックの複雑さが増すにつれて、<strong>テストの維持</strong> も難しくなりました。特に、ゲームの状態遷移や重力処理のテストは工夫が必要でした。</p>
<p>さらに、<strong>衝突判定のバグ</strong>（イテレーション 10 で発見）のように、テストカバレッジの不足によって見逃されるバグがあることも課題でした。「テストされていない機能は動作しない」という教訓を再確認できました。</p>
<h3 id="try">Try（挑戦）<a class="headerlink" href="#try" title="Permanent link">&para;</a></h3>
<p>今後は以下のことに挑戦していきたいと思います：</p>
<ol>
<li><strong>より効率的なテスト戦略の模索</strong>:</li>
<li>ユニットテストとインテグレーションテストのバランス</li>
<li>プロパティベーステスト（Property-based Testing）の導入</li>
<li>
<p>テストカバレッジの継続的な監視</p>
</li>
<li>
<p><strong>自動化テストのカバレッジを高める工夫</strong>:</p>
</li>
<li>境界値テストの徹底</li>
<li>異常系テストの充実</li>
<li>
<p>回帰テストの自動化</p>
</li>
<li>
<p><strong>より複雑なゲーム機能への挑戦</strong>:</p>
</li>
<li>マルチプレイヤー対応</li>
<li>ネットワーク対戦</li>
<li>
<p>AI 対戦相手の実装</p>
</li>
<li>
<p><strong>パフォーマンス最適化とそのテスト手法の習得</strong>:</p>
</li>
<li>ゲームループの最適化</li>
<li>描画処理の効率化</li>
<li>
<p>パフォーマンステストの導入</p>
</li>
<li>
<p><strong>F# の高度な機能の活用</strong>:</p>
</li>
<li>コンピュテーション式（Computation Expressions）</li>
<li>非同期処理（Async Workflows）</li>
<li>アクティブパターン（Active Patterns）</li>
</ol>
<p>これらの知識と経験は、他のプロジェクトにも応用できるものです。テスト駆動開発は、コードの品質を高め、保守性を向上させるための強力な手法です。ぜひ、自分のプロジェクトにも取り入れてみてください。</p>
<blockquote>
<p>私がかつて発見した、そして多くの人に気づいてもらいたい効果とは、反復可能な振る舞いを規則にまで還元することで、規則の適用は機械的に反復可能になるということだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="f_1">F# とテスト駆動開発の相乗効果<a class="headerlink" href="#f_1" title="Permanent link">&para;</a></h3>
<p>このチュートリアルを通じて、F# とテスト駆動開発の相乗効果を実感できたと思います：</p>
<p><strong>F# の強み</strong>:
- 型安全性によるコンパイル時のエラー検出
- イミュータブルな設計によるバグの削減
- パターンマッチングによる網羅的な処理
- 簡潔で読みやすいコード</p>
<p><strong>TDD の強み</strong>:
- テストファーストによる設計の改善
- 継続的な品質保証
- リファクタリングの安全性
- ドキュメントとしてのテスト</p>
<p><strong>相乗効果</strong>:
- F# の型システムが TDD のサイクルを加速
- TDD がF# のコードの意図を明確化
- 両方を組み合わせることで、高品質なコードを効率的に作成</p>
<p>「F# とテスト駆動開発の組み合わせは、とても強力ですね！」その通りです。F# の型安全性と TDD の継続的な品質保証を組み合わせることで、安全で保守性の高いコードを効率的に作成できます。</p>
<hr />
<p>これで、ぷよぷよゲームのチュートリアルが完全に完成しました！10 個のイテレーションを通じて、F#、Fable、テスト駆動開発の実践的なスキルを学ぶことができました。</p>
<h3 id="_105">完成したゲームの全体像<a class="headerlink" href="#_105" title="Permanent link">&para;</a></h3>
<p>これまでのイテレーションで実装した機能を振り返ってみましょう：</p>
<p><strong>イテレーション 0-3（基礎実装）</strong>：
- 環境構築とプロジェクト初期化
- ゲームの初期化とステージ描画
- ぷよの移動（左右・下）
- ぷよの回転</p>
<p><strong>イテレーション 4（自由落下）</strong>：
- 落下判定と移動
- ステージへの固定
- 重力処理</p>
<p><strong>イテレーション 5（高速落下）</strong>：
- キーボード入力処理
- 落下速度の制御
- 入力状態の管理</p>
<p><strong>イテレーション 6（消去処理）</strong>：
- 深さ優先探索による連結判定
- ぷよの消去
- 消去情報の管理</p>
<p><strong>イテレーション 7（連鎖）</strong>：
- 連鎖カウント
- ゲームモードの遷移
- 連鎖反応の実装</p>
<p><strong>イテレーション 8（スコア）</strong>：
- スコア計算
- 連鎖ボーナス
- 全消しボーナス</p>
<p><strong>イテレーション 9（ゲームオーバー）</strong>：
- ゲームオーバー判定
- ゲーム終了演出
- 完成！</p>
<p>「すべての機能が実装されて、ぷよぷよゲームが完成しましたね！」はい！テスト駆動開発の流れに沿って、一つずつ機能を追加していくことで、動作するゲームを作ることができました。</p>
<h3 id="f-fable_1">F# Fable でゲーム開発を行うメリット<a class="headerlink" href="#f-fable_1" title="Permanent link">&para;</a></h3>
<p>このチュートリアルを通じて、F# Fable でゲーム開発を行うメリットを実感できたと思います：</p>
<ol>
<li>
<p><strong>型安全性</strong>:</p>
<ul>
<li>判別共用体による状態管理</li>
<li>パターンマッチングの網羅性チェック</li>
<li>コンパイル時のエラー検出</li>
</ul>
</li>
<li>
<p><strong>イミュータブルな設計</strong>:</p>
<ul>
<li>バグの少ないコード</li>
<li>状態遷移の明確化</li>
<li>テストの容易さ</li>
</ul>
</li>
<li>
<p><strong>関数型プログラミング</strong>:</p>
<ul>
<li>純粋関数による処理</li>
<li>副作用の最小化</li>
<li>再利用可能なコード</li>
</ul>
</li>
<li>
<p><strong>JavaScript との相互運用</strong>:</p>
<ul>
<li>ブラウザでの実行</li>
<li>既存の JavaScript ライブラリの利用</li>
<li>DOM 操作</li>
</ul>
</li>
<li>
<p><strong>テスト駆動開発</strong>:</p>
<ul>
<li>Fable.Mocha による統合</li>
<li>高速なテスト実行</li>
<li>継続的な品質保証</li>
</ul>
</li>
</ol>
<p>「F# でゲーム開発ができるなんて、知りませんでした！」F# は、関数型プログラミングの利点を活かしながら、実用的なアプリケーション開発にも適した言語です。Fable を使えば、ブラウザで動作するゲームやアプリケーションを、型安全に開発できます。</p>
<h3 id="_106">次のステップ<a class="headerlink" href="#_106" title="Permanent link">&para;</a></h3>
<p>ゲームの基本機能は完成しましたが、さらに改善できる点がたくさんあります：</p>
<p><strong>UI の改善</strong>：
- スコア表示の追加
- 連鎖数の表示
- 次のぷよの表示
- リスタートボタンの追加</p>
<p><strong>ゲーム性の向上</strong>：
- 難易度の調整
- ぷよの種類を増やす
- 特殊なぷよの追加
- サウンドエフェクト</p>
<p><strong>コードの改善</strong>：
- リファクタリング
- パフォーマンスの最適化
- ドキュメントの充実
- エラーハンドリングの改善</p>
<p><strong>追加機能</strong>：
- ハイスコアの記録
- ゲーム設定画面
- チュートリアルモード
- マルチプレイヤー対応</p>
<p>「これからもっとゲームを改善していきたいです！」素晴らしいですね！テスト駆動開発の流れに沿って、一つずつ機能を追加していけば、どんどんゲームが進化していきます。F# と Fable の力を使って、楽しいゲーム開発を続けてください！</p>
<hr />
<h2 id="_107">まとめ<a class="headerlink" href="#_107" title="Permanent link">&para;</a></h2>
<p>このチュートリアルでは、F# と Fable を使って、テスト駆動開発でぷよぷよゲームを作成しました。</p>
<h3 id="_108">学んだこと<a class="headerlink" href="#_108" title="Permanent link">&para;</a></h3>
<p><strong>F# の基礎</strong>：
- 判別共用体による型定義
- レコード型による構造化データ
- パターンマッチングによる分岐処理
- パイプライン演算子によるデータ変換
- イミュータブルなデータ構造</p>
<p><strong>関数型プログラミング</strong>：
- 純粋関数の設計
- 副作用の最小化
- 関数合成
- 再帰関数
- 高階関数</p>
<p><strong>テスト駆動開発</strong>：
- Red-Green-Refactor サイクル
- テストファーストの開発
- Fable.Mocha によるテスト
- 継続的な品質保証</p>
<p><strong>ゲーム開発</strong>：
- ゲームループの実装
- 状態管理
- 入力処理
- 描画処理
- 衝突判定</p>
<p><strong>Fable</strong>：
- F# から JavaScript への変換
- ブラウザでの実行
- DOM 操作
- JavaScript との相互運用</p>
<h3 id="_109">テスト駆動開発の価値<a class="headerlink" href="#_109" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発（TDD）の 3 つのサイクルを実践することで、以下のような価値を得ることができました：</p>
<ol>
<li>
<p><strong>Red（失敗）フェーズ</strong>:</p>
<ul>
<li>要件を明確化</li>
<li>テストケースの設計</li>
<li>実装の指針を得る</li>
</ul>
</li>
<li>
<p><strong>Green（成功）フェーズ</strong>:</p>
<ul>
<li>最小限の実装</li>
<li>テストの通過を確認</li>
<li>動作する証拠を得る</li>
</ul>
</li>
<li>
<p><strong>Refactor（改善）フェーズ</strong>:</p>
<ul>
<li>コードの品質向上</li>
<li>重複の排除</li>
<li>設計の改善</li>
</ul>
</li>
</ol>
<p>「テスト駆動開発は最初は難しく感じましたが、慣れると安心して開発できますね！」その通りです。テストがあることで、リファクタリングや機能追加を安全に行えます。また、テストが仕様書の役割も果たすため、コードの意図が明確になります。</p>
<h3 id="f_2">F# の関数型プログラミングの強み<a class="headerlink" href="#f_2" title="Permanent link">&para;</a></h3>
<p>F# の関数型プログラミングのアプローチには、以下のような強みがあります：</p>
<ol>
<li>
<p><strong>型安全性</strong>:</p>
<ul>
<li>コンパイル時のエラー検出</li>
<li>実行時エラーの削減</li>
<li>リファクタリングの安全性</li>
</ul>
</li>
<li>
<p><strong>イミュータブルな設計</strong>:</p>
<ul>
<li>予期しない状態変更の防止</li>
<li>並行処理の安全性</li>
<li>バグの削減</li>
</ul>
</li>
<li>
<p><strong>簡潔で読みやすいコード</strong>:</p>
<ul>
<li>パターンマッチング</li>
<li>パイプライン演算子</li>
<li>型推論</li>
</ul>
</li>
<li>
<p><strong>テストの容易さ</strong>:</p>
<ul>
<li>純粋関数のテスト</li>
<li>モックが不要</li>
<li>テストの独立性</li>
</ul>
</li>
</ol>
<p>「F# は型安全性と簡潔さを両立していて、とても使いやすいですね！」そうですね。F# は、関数型プログラミングの利点を保ちながら、実用的な開発にも適した言語です。</p>
<h3 id="_110">最後に<a class="headerlink" href="#_110" title="Permanent link">&para;</a></h3>
<p>「ぷよぷよゲームを作りながら、F#、Fable、テスト駆動開発について学べて楽しかったです！」素晴らしいですね！このチュートリアルで学んだことを活かして、さらに面白いゲームやアプリケーションを作ってみてください。</p>
<p>F# と Fable を使えば、型安全で保守性の高いコードを書きながら、ブラウザで動作するアプリケーションを開発できます。テスト駆動開発の流れに沿って、一つずつ機能を追加していけば、どんな複雑なアプリケーションでも作ることができます。</p>
<p>これからも、楽しくプログラミングを学び続けてください！</p>
<p>Happy Coding with F# and Fable! 🎮</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>