
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 (React + Electron 版) - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#react-electron" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 (React + Electron 版)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="react-electron">ぷよぷよから始めるテスト駆動開発入門 (React + Electron 版)<a class="headerlink" href="#react-electron" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、Electron 版ぷよぷよゲームを作っていきましょう。Electron を使うことで、Web 技術（React + TypeScript）でデスクトップアプリケーションを開発できます。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。Electron の特性を活かしたデスクトップアプリとして、React でリッチな UI を実装し、ネイティブアプリのような体験を提供しましょう。</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発では、以下の3つのステップを繰り返すサイクルで開発を進めます：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。これから実装する機能が何をすべきかを明確にします。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では「とにかく動くこと」を優先します。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除き、わかりやすいコードにします。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>今回のプロジェクトでは、以下のツールを使用します：</p>
<ul>
<li><strong>言語</strong>: TypeScript — 型安全性によりバグを減らします</li>
<li><strong>UI フレームワーク</strong>: React — コンポーネントベースの UI 構築</li>
<li><strong>デスクトップフレームワーク</strong>: Electron — Web 技術でネイティブアプリを作成</li>
<li><strong>ビルドツール</strong>: Vite — 高速な開発サーバーとビルド</li>
<li><strong>テストフレームワーク</strong>: Vitest — Vite と統合された高速なテストランナー</li>
<li><strong>タスクランナー</strong>: Gulp — 反復的なタスクを自動化</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡</li>
</ul>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<h3 id="electron">Electron とは<a class="headerlink" href="#electron" title="Permanent link">&para;</a></h3>
<p>Electron は、Chromium と Node.js を組み合わせて、Web 技術でデスクトップアプリケーションを作成できるフレームワークです。</p>
<p><strong>Electron の特徴：</strong>
- クロスプラットフォーム対応（Windows、macOS、Linux）
- Web 技術（HTML、CSS、JavaScript/TypeScript）でネイティブアプリを開発
- 豊富な Node.js の API とネイティブ機能へのアクセス
- VS Code、Slack、Discord などの有名アプリで採用</p>
<p><strong>Electron のアーキテクチャ：</strong></p>
<p>Electron アプリは2つのプロセスで構成されます：</p>
<ol>
<li><strong>メインプロセス</strong>：アプリのエントリポイント。ウィンドウの管理やネイティブ機能へのアクセスを担当</li>
<li><strong>レンダラープロセス</strong>：各ウィンドウで実行される Web ページ。React などの UI フレームワークがここで動作</li>
</ol>
<div class="highlight"><pre><span></span><code>┌─────────────────────────────────────┐
│      Electron Application           │
├─────────────────────────────────────┤
│  Main Process (Node.js)             │
│  - Window management                │
│  - Native APIs                      │
│  - IPC (Inter-Process Communication)│
├─────────────────────────────────────┤
│  Renderer Process (Chromium)        │
│  - React UI                         │
│  - Game Logic                       │
│  - TypeScript/JavaScript            │
└─────────────────────────────────────┘
</code></pre></div>
<h2 id="_4">要件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">ユーザーストーリー<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>アジャイル開発では、「ユーザーストーリー」という形で要件を表現します。</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>Electron 版ぷよぷよゲームのユーザーストーリー：</p>
<ul>
<li>プレイヤーとして、デスクトップアプリとしてゲームを起動できる</li>
<li>プレイヤーとして、ウィンドウのサイズを変更できる</li>
<li>プレイヤーとして、新しいゲームを開始できる</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</li>
<li>プレイヤーとして、全消しボーナスを獲得できる</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</li>
<li>プレイヤーとして、現在のスコアを確認できる</li>
<li>プレイヤーとして、キーボードでぷよを操作できる</li>
<li>プレイヤーとして、設定をローカルストレージに保存できる（Electron の永続化機能）</li>
</ul>
<h3 id="_6">ユースケース図<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>システムと外部アクター（プレイヤーとシステム）の相互作用を視覚的に表現します。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjU5MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTA1NHB4O2hlaWdodDo1OTFweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMDU0IDU5MSIgd2lkdGg9IjEwNTRweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIEVsZWN0cm9uID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJFbGVjdHJvbiAuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJjbHVzdGVyX0VsZWN0cm9uIC4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU3OCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijg0My43NSIgeD0iMTEyIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyNC4yMTEyIiB4PSI0MjEuNzY5NCIgeT0iMjEuOTk1MSI+RWxlY3Ryb24gJiMxMjQwNzsmIzEyNDI0OyYjMTI0MDc7JiMxMjQyNDsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBMYXVuY2hBcHAtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iTGF1bmNoQXBwIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfTGF1bmNoQXBwIj48ZWxsaXBzZSBjeD0iMjI2LjExNDEiIGN5PSI3MC4wMDI4IiBmaWxsPSIjRjFGMUYxIiByeD0iOTAuMTE0MSIgcnk9IjIwLjQyMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1My45OTkzIiB4PSIxNDkuMTE0NSIgeT0iNzQuNjUxMyI+JiMxMjQ1MDsmIzEyNTAzOyYjMTI1MjI7JiMxMjQ2NTsmIzEyNTQwOyYjMTI0NzE7JiMxMjUxOTsmIzEyNTMxOyYjMTI0MzQ7JiMzNjIxNTsmIzIxMjA1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBNYW5hZ2VXaW5kb3ctLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iTWFuYWdlV2luZG93IiBkYXRhLXNvdXJjZS1saW5lPSIxMyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfTWFuYWdlV2luZG93Ij48ZWxsaXBzZSBjeD0iMjI2LjExMjQiIGN5PSIxNDIuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMTcwLjExMjciIHk9IjE0Ni42NDg5Ij4mIzEyNDU0OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDg5OyYjMTI0NTQ7JiMxMjQzNDsmIzMxNjQ5OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tZW50aXR5IFN0YXJ0TmV3R2FtZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJTdGFydE5ld0dhbWUiIGRhdGEtc291cmNlLWxpbmU9IjE4IiBkYXRhLXVpZD0iZW50MDAwNyIgaWQ9ImVudGl0eV9TdGFydE5ld0dhbWUiPjxlbGxpcHNlIGN4PSI0NjAuMjE1OSIgY3k9IjEzOC45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIzOTcuMjE2MiIgeT0iMTQzLjY0MzYiPiYjMjYwMzI7JiMxMjM3NTsmIzEyMzU2OyYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0MzQ7JiMzODI4MzsmIzIyOTg3OzwvdGV4dD48L2c+PCEtLWVudGl0eSBSZXN0YXJ0R2FtZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSZXN0YXJ0R2FtZSIgZGF0YS1zb3VyY2UtbGluZT0iMTkiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5X1Jlc3RhcnRHYW1lIj48ZWxsaXBzZSBjeD0iNDYwLjIxNTkiIGN5PSI2Ny45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIzOTcuMjE2MiIgeT0iNzIuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQzNDsmIzEyNTIyOyYjMTI0NzM7JiMxMjQ3OTsmIzEyNTQwOyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1vdmVQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIyNCIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJlbnRpdHlfTW92ZVB1eW8iPjxlbGxpcHNlIGN4PSIyMjYuMTEyNCIgY3k9IjM0My4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNzAuMTEyNyIgeT0iMzQ3LjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMjQwMzg7JiMyMTQ5MTsmIzEyMzk1OyYjMzEyMjc7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUm90YXRlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfUm90YXRlUHV5byI+PGVsbGlwc2UgY3g9IjIyNi4xMDczIiBjeT0iMjc3LjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTkxLjEwNzQiIHk9IjI4MS42NTIxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzIyMjM4OyYjMzY1Nzg7PC90ZXh0PjwvZz48IS0tZW50aXR5IFF1aWNrRHJvcFB1eW8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iMjYiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5X1F1aWNrRHJvcFB1eW8iPjxlbGxpcHNlIGN4PSIyMjYuMTEyNCIgY3k9IjIxMS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNzAuMTEyNyIgeT0iMjE1LjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMzIwMzI7JiMyNjA4OTsmIzEyMzY3OyYjMzM4NTM7JiMxOTk3OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgRmFsbFB1eW8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRmFsbFB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjMxIiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9GYWxsUHV5byI+PGVsbGlwc2UgY3g9IjIyNi4xMDUyIiBjeT0iNDczLjk5NSIgZmlsbD0iI0YxRjFGMSIgcng9IjY2LjcyNTIiIHJ5PSIxNS43NDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjE3Ny4xMDU0IiB5PSI0NzguNjQzNSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMzMzI1ODsmIzMwMDAxOyYjMzM4NTM7JiMxOTk3OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgRXJhc2VQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkVyYXNlUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iMzIiIGRhdGEtdWlkPSJlbnQwMDEzIiBpZD0iZW50aXR5X0VyYXNlUHV5byI+PGVsbGlwc2UgY3g9IjIyNi4xMDczIiBjeT0iNDA5LjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTkxLjEwNzQiIHk9IjQxMy42NTIxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzI4MDQwOyYjMjE0MzU7PC90ZXh0PjwvZz48IS0tZW50aXR5IENoYWluUmVhY3Rpb24tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iQ2hhaW5SZWFjdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iMzMiIGRhdGEtdWlkPSJlbnQwMDE0IiBpZD0iZW50aXR5X0NoYWluUmVhY3Rpb24iPjxlbGxpcHNlIGN4PSI0NjAuMjE1MiIgY3k9IjQwMC45OTUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI2Ni43MjUyIiByeT0iMTUuNzQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI0MTEuMjE1NCIgeT0iNDA1LjY0MzUiPiYjMzY4OTk7JiMzNzc4MjsmIzIxNDUzOyYjMjQ1NDA7JiMxMjQzNDsmIzMwMzMwOyYjMjk5ODM7PC90ZXh0PjwvZz48IS0tZW50aXR5IFplbmtlc2hpQm9udXMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iWmVua2VzaGlCb251cyIgZGF0YS1zb3VyY2UtbGluZT0iMzQiIGRhdGEtdWlkPSJlbnQwMDE1IiBpZD0iZW50aXR5X1plbmtlc2hpQm9udXMiPjxlbGxpcHNlIGN4PSI0NjAuMjIzMSIgY3k9IjQ3MC45OTg2IiBmaWxsPSIjRjFGMUYxIiByeD0iODMuOTkzMSIgcnk9IjE5LjE5ODYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzOTAuMjIzNCIgeT0iNDc1LjY0NzEiPiYjMjA4NDA7JiMyODA0MDsmIzEyMzc1OyYjMTI1MDg7JiMxMjU0MDsmIzEyNDkwOyYjMTI0NzM7JiMxMjQzNDsmIzI5NTU0OyYjMjQ0NzE7PC90ZXh0PjwvZz48IS0tZW50aXR5IERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9IjM1IiBkYXRhLXVpZD0iZW50MDAxNiIgaWQ9ImVudGl0eV9EaXNwbGF5U2NvcmUiPjxlbGxpcHNlIGN4PSI2NjUuNzM0MiIgY3k9IjQwMC4wMDI4IiBmaWxsPSIjRjFGMUYxIiByeD0iNjEuNTE0MiIgcnk9IjE0LjcwMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9IjYyMy43MzQ0IiB5PSI0MDQuNjUxMyI+JiMxMjQ3MzsmIzEyNDY3OyYjMTI0NTA7JiMxMjQzNDsmIzM0OTIwOyYjMzEwMzQ7PC90ZXh0PjwvZz48IS0tZW50aXR5IEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjQwIiBkYXRhLXVpZD0iZW50MDAxNyIgaWQ9ImVudGl0eV9LZXlib2FyZENvbnRyb2wiPjxlbGxpcHNlIGN4PSI0NjAuMjIyNCIgY3k9IjI0NC4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSI0MDQuMjIyNyIgeT0iMjQ4LjY0ODkiPiYjMTI0NjE7JiMxMjU0MDsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ4OTsmIzEyMzkxOyYjMjU4MDU7JiMyMDMxNjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgU2F2ZVNldHRpbmdzLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlNhdmVTZXR0aW5ncyIgZGF0YS1zb3VyY2UtbGluZT0iNDUiIGRhdGEtdWlkPSJlbnQwMDE4IiBpZD0iZW50aXR5X1NhdmVTZXR0aW5ncyI+PGVsbGlwc2UgY3g9Ijg1OS40OTczIiBjeT0iMjYxLjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iODI0LjQ5NzQiIHk9IjI2NS42NTIxIj4mIzM1MzczOyYjMjM0NTA7JiMxMjQzNDsmIzIwNDQ1OyYjMjMzODQ7PC90ZXh0PjwvZz48IS0tZW50aXR5IFNhdmVIaWdoU2NvcmUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU2F2ZUhpZ2hTY29yZSIgZGF0YS1zb3VyY2UtbGluZT0iNDYiIGRhdGEtdWlkPSJlbnQwMDE5IiBpZD0iZW50aXR5X1NhdmVIaWdoU2NvcmUiPjxlbGxpcHNlIGN4PSI4NTkuNTAyNCIgY3k9IjMyNy4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSI4MDMuNTAyNyIgeT0iMzMxLjY0ODkiPiYjMTI0OTU7JiMxMjQ1MjsmIzEyNDczOyYjMTI0Njc7JiMxMjQ1MDsmIzEyNDM0OyYjMjA0NDU7JiMyMzM4NDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgR2FtZU92ZXJDaGVjay0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHYW1lT3ZlckNoZWNrIiBkYXRhLXNvdXJjZS1saW5lPSI1MSIgZGF0YS11aWQ9ImVudDAwMjAiIGlkPSJlbnRpdHlfR2FtZU92ZXJDaGVjayI+PGVsbGlwc2UgY3g9IjIyNi4xMDU5IiBjeT0iNTQyLjk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE2My4xMDYyIiB5PSI1NDcuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQ1ODsmIzEyNTQwOyYjMTI0OTY7JiMxMjU0MDsmIzIxMDI4OyYjMjM0NTA7PC90ZXh0PjwvZz48IS0tZW50aXR5IEdhbWVPdmVyQW5pbWF0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI1MiIgZGF0YS11aWQ9ImVudDAwMjEiIGlkPSJlbnRpdHlfR2FtZU92ZXJBbmltYXRpb24iPjxlbGxpcHNlIGN4PSI0NjAuMjE1OSIgY3k9IjU0Mi45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIzOTcuMjE2MiIgeT0iNTQ3LjY0MzYiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0NTg7JiMxMjU0MDsmIzEyNDk2OyYjMTI1NDA7JiMyODQzNjsmIzIwOTg2OzwvdGV4dD48L2c+PCEtLWVudGl0eSBQbGF5ZXItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUGxheWVyIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImVudGl0eV9QbGF5ZXIiPjxlbGxpcHNlIGN4PSI0MC45OTk4IiBjeT0iNzYuMzUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI4IiByeT0iOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTQwLjk5OTgsODQuMzUgTDQwLjk5OTgsMTExLjM1IE0yNy45OTk4LDkyLjM1IEw1My45OTk4LDkyLjM1IE00MC45OTk4LDExMS4zNSBMMjcuOTk5OCwxMjYuMzUgTTQwLjk5OTgsMTExLjM1IEw1My45OTk4LDEyNi4zNSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iNiIgeT0iMTQwLjg0NTEiPiYjMTI1MDM7JiMxMjUyNDsmIzEyNDUyOyYjMTI1MTY7JiMxMjU0MDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgU3lzdGVtLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJlbnRpdHlfU3lzdGVtIj48ZWxsaXBzZSBjeD0iMTAxOS43NDk5IiBjeT0iNTA5LjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0xMDE5Ljc0OTksNTE3LjM1IEwxMDE5Ljc0OTksNTQ0LjM1IE0xMDA2Ljc0OTksNTI1LjM1IEwxMDMyLjc0OTksNTI1LjM1IE0xMDE5Ljc0OTksNTQ0LjM1IEwxMDA2Ljc0OTksNTU5LjM1IE0xMDE5Ljc0OTksNTQ0LjM1IEwxMDMyLjc0OTksNTU5LjM1IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSI5OTEuNzUiIHk9IjU3My44NDUxIj4mIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWxpbmsgUGxheWVyIHRvIExhdW5jaEFwcC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9IkxhdW5jaEFwcCIgZGF0YS1zb3VyY2UtbGluZT0iNTciIGRhdGEtdWlkPSJsbmsyMiIgaWQ9ImxpbmtfUGxheWVyX0xhdW5jaEFwcCI+PHBhdGggZD0iTTc2LjI1LDc5LjE0IEM5NS43Nyw3OS4xNCAxMTQuODgsNzkuMTQgMTM4Ljk1LDc5LjE0IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLUxhdW5jaEFwcCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTQ0Ljk1LDc5LjE0LDEzNS45NSw3NS4xNCwxMzkuOTUsNzkuMTQsMTM1Ljk1LDgzLjE0LDE0NC45NSw3OS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gTWFuYWdlV2luZG93LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iTWFuYWdlV2luZG93IiBkYXRhLXNvdXJjZS1saW5lPSI1OCIgZGF0YS11aWQ9ImxuazIzIiBpZD0ibGlua19QbGF5ZXJfTWFuYWdlV2luZG93Ij48cGF0aCBkPSJNNzYuMjUsMTM0LjY1IEM5OS45NiwxMzQuNjUgMTI1Ljk0LDEzNC42NSAxNTQuMjcsMTM0LjY1IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLU1hbmFnZVdpbmRvdyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTYwLjI3LDEzNC42NSwxNTEuMjcsMTMwLjY1LDE1NS4yNywxMzQuNjUsMTUxLjI3LDEzOC42NSwxNjAuMjcsMTM0LjY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJTdGFydE5ld0dhbWUiIGRhdGEtc291cmNlLWxpbmU9IjU5IiBkYXRhLXVpZD0ibG5rMjQiIGlkPSJsaW5rX1BsYXllcl9TdGFydE5ld0dhbWUiPjxwYXRoIGQ9Ik03Ni4yNywxMTAuOCBDMTgxLjQ2LDExMC44IDQ4NS43NSwxMTAuOCA0ODUuNzUsMTEwLjggQzQ4NS43NSwxMTAuOCA0ODUuNzUsMTA5LjgyIDQ4NS43NSwxMTUuNjIiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tU3RhcnROZXdHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0ODUuNzUsMTIxLjYyLDQ4OS43NSwxMTIuNjIsNDg1Ljc1LDExNi42Miw0ODEuNzUsMTEyLjYyLDQ4NS43NSwxMjEuNjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIFJlc3RhcnRHYW1lLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjYwIiBkYXRhLXVpZD0ibG5rMjUiIGlkPSJsaW5rX1BsYXllcl9SZXN0YXJ0R2FtZSI+PHBhdGggZD0iTTc2LjIsMTAwLjYxIEMxNzIuNiwxMDAuNjEgNDMzLjc1LDEwMC42MSA0MzMuNzUsMTAwLjYxIEM0MzMuNzUsMTAwLjYxIDQzMy43NSw5OC45NiA0MzMuNzUsOTEuMDciIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tUmVzdGFydEdhbWUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQzMy43NSw4NS4wNyw0MjkuNzUsOTQuMDcsNDMzLjc1LDkwLjA3LDQzNy43NSw5NC4wNyw0MzMuNzUsODUuMDciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIE1vdmVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iTW92ZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjYxIiBkYXRhLXVpZD0ibG5rMjYiIGlkPSJsaW5rX1BsYXllcl9Nb3ZlUHV5byI+PHBhdGggZD0iTTE5Ljc1LDE0NC42MSBDMTkuNzUsMjExLjc2IDE5Ljc1LDM0MyAxOS43NSwzNDMgQzE5Ljc1LDM0MyA4OC4xOCwzNDMgMTQ3LjY1LDM0MyIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1Nb3ZlUHV5byIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTUzLjY1LDM0MywxNDQuNjUsMzM5LDE0OC42NSwzNDMsMTQ0LjY1LDM0NywxNTMuNjUsMzQzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBSb3RhdGVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUm90YXRlUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iNjIiIGRhdGEtdWlkPSJsbmsyNyIgaWQ9ImxpbmtfUGxheWVyX1JvdGF0ZVB1eW8iPjxwYXRoIGQ9Ik0zMy43NSwxNDQuMzggQzMzLjc1LDE5NC43OSAzMy43NSwyNzcgMzMuNzUsMjc3IEMzMy43NSwyNzcgMTEwLjM1LDI3NyAxNjcuMjksMjc3IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJvdGF0ZVB1eW8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3My4yOSwyNzcsMTY0LjI5LDI3MywxNjguMjksMjc3LDE2NC4yOSwyODEsMTczLjI5LDI3NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUXVpY2tEcm9wUHV5by0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9IlF1aWNrRHJvcFB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjYzIiBkYXRhLXVpZD0ibG5rMjgiIGlkPSJsaW5rX1BsYXllcl9RdWlja0Ryb3BQdXlvIj48cGF0aCBkPSJNNjEuNzUsMTQ0LjUgQzYxLjc1LDE3NC40NyA2MS43NSwyMTEgNjEuNzUsMjExIEM2MS43NSwyMTEgMTAzLjUxLDIxMSAxNDcuNTQsMjExIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVF1aWNrRHJvcFB1eW8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1My41NCwyMTEsMTQ0LjU0LDIwNywxNDguNTQsMjExLDE0NC41NCwyMTUsMTUzLjU0LDIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2NCIgZGF0YS11aWQ9ImxuazI5IiBpZD0ibGlua19QbGF5ZXJfS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNNDcuNzUsMTQ0LjM0IEM0Ny43NSwxODQuMjcgNDcuNzUsMjQxLjA1IDQ3Ljc1LDI0MS4wNSBDNDcuNzUsMjQxLjA1IDI2NC43OSwyNDEuMDUgMzgyLjg0LDI0MS4wNSIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1LZXlib2FyZENvbnRyb2wiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM4OC44NCwyNDEuMDUsMzc5Ljg0LDIzNy4wNSwzODMuODQsMjQxLjA1LDM3OS44NCwyNDUuMDUsMzg4Ljg0LDI0MS4wNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIEVyYXNlUHV5byB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRXJhc2VQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjY3IiBkYXRhLXVpZD0ibG5rMzAiIGlkPSJsaW5rX0VyYXNlUHV5b19TeXN0ZW0iPjxwYXRoIGQ9Ik0yODQuNzQsNDA5LjMyIEMzMDAuNTMsNDA5LjMyIDMwNy43NSw0MDkuMzIgMzA3Ljc1LDQwOS4zMiBDMzA3Ljc1LDQwOS4zMiAzMDcuNzUsNTEyLjkyIDMwNy43NSw1MTIuOTIgQzMwNy43NSw1MTIuOTIgODU4Ljk3LDUxMi45MiA5OTEuNCw1MTIuOTIiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjc4Ljc0LDQwOS4zMiwyODcuNzQsNDEzLjMyLDI4My43NCw0MDkuMzIsMjg3Ljc0LDQwNS4zMiwyNzguNzQsNDA5LjMyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRmFsbFB1eW8gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkZhbGxQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjY4IiBkYXRhLXVpZD0ibG5rMzEiIGlkPSJsaW5rX0ZhbGxQdXlvX1N5c3RlbSI+PHBhdGggZD0iTTIyNS43NSw0OTYuMjMgQzIyNS43NSw1MDkuMTEgMjI1Ljc1LDUxOC45NiAyMjUuNzUsNTE4Ljk2IEMyMjUuNzUsNTE4Ljk2IDg1MC4wNSw1MTguOTYgOTkxLjQ5LDUxOC45NiIgZmlsbD0ibm9uZSIgaWQ9IkZhbGxQdXlvLWJhY2t0by1TeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjIyNS43NSw0OTAuMjMsMjIxLjc1LDQ5OS4yMywyMjUuNzUsNDk1LjIzLDIyOS43NSw0OTkuMjMsMjI1Ljc1LDQ5MC4yMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIENoYWluUmVhY3Rpb24gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkNoYWluUmVhY3Rpb24iIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNjkiIGRhdGEtdWlkPSJsbmszMiIgaWQ9ImxpbmtfQ2hhaW5SZWFjdGlvbl9TeXN0ZW0iPjxwYXRoIGQ9Ik01MzEuMjcsNDA0LjkgQzU1Ni42NCw0MDQuOSA1NzMuNzUsNDA0LjkgNTczLjc1LDQwNC45IEM1NzMuNzUsNDA0LjkgNTczLjc1LDUwNi44OSA1NzMuNzUsNTA2Ljg5IEM1NzMuNzUsNTA2Ljg5IDg5My40Nyw1MDYuODkgOTkxLjUxLDUwNi44OSIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTI1LjI3LDQwNC45LDUzNC4yNyw0MDguOSw1MzAuMjcsNDA0LjksNTM0LjI3LDQwMC45LDUyNS4yNyw0MDQuOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIFplbmtlc2hpQm9udXMgdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ilplbmtlc2hpQm9udXMiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNzAiIGRhdGEtdWlkPSJsbmszMyIgaWQ9ImxpbmtfWmVua2VzaGlCb251c19TeXN0ZW0iPjxwYXRoIGQ9Ik01NDUuOTgsNDc3LjQgQzY5Ni43OCw0NzcuNCAxMDAyLjc1LDQ3Ny40IDEwMDIuNzUsNDc3LjQgQzEwMDIuNzUsNDc3LjQgMTAwMi43NSw0ODguMTYgMTAwMi43NSw1MDAuNjkiIGZpbGw9Im5vbmUiIGlkPSJaZW5rZXNoaUJvbnVzLWJhY2t0by1TeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUzOS45OCw0NzcuNCw1NDguOTgsNDgxLjQsNTQ0Ljk4LDQ3Ny40LDU0OC45OCw0NzMuNCw1MzkuOTgsNDc3LjQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBEaXNwbGF5U2NvcmUgdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkRpc3BsYXlTY29yZSIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI3MSIgZGF0YS11aWQ9ImxuazM0IiBpZD0ibGlua19EaXNwbGF5U2NvcmVfU3lzdGVtIj48cGF0aCBkPSJNNzMzLjU1LDQwMCBDODMzLjU1LDQwMCAxMDEzLjc1LDQwMCAxMDEzLjc1LDQwMCBDMTAxMy43NSw0MDAgMTAxMy43NSw0NTkuNTEgMTAxMy43NSw1MDAuNjUiIGZpbGw9Im5vbmUiIGlkPSJEaXNwbGF5U2NvcmUtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzI3LjU1LDQwMCw3MzYuNTUsNDA0LDczMi41NSw0MDAsNzM2LjU1LDM5Niw3MjcuNTUsNDAwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgR2FtZU92ZXJDaGVjayB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJDaGVjayIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI3MiIgZGF0YS11aWQ9ImxuazM1IiBpZD0ibGlua19HYW1lT3ZlckNoZWNrX1N5c3RlbSI+PHBhdGggZD0iTTIyNS43NSw1NjcuMzkgQzIyNS43NSw1NzEuNzEgMjI1Ljc1LDU2OS4wOCAyMjUuNzUsNTY5LjA4IEMyMjUuNzUsNTY5LjA4IDg1MC4wNSw1NjkuMDggOTkxLjQ5LDU2OS4wOCIgZmlsbD0ibm9uZSIgaWQ9IkdhbWVPdmVyQ2hlY2stYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjI1Ljc1LDU2MS4zOSwyMjEuNzUsNTcwLjM5LDIyNS43NSw1NjYuMzksMjI5Ljc1LDU3MC4zOSwyMjUuNzUsNTYxLjM5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgR2FtZU92ZXJBbmltYXRpb24gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjczIiBkYXRhLXVpZD0ibG5rMzYiIGlkPSJsaW5rX0dhbWVPdmVyQW5pbWF0aW9uX1N5c3RlbSI+PHBhdGggZD0iTTU0NC42MSw1NDMgQzY3MS4wOCw1NDMgOTA4LjM1LDU0MyA5OTEuMjYsNTQzIiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJBbmltYXRpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTM4LjYxLDU0Myw1NDcuNjEsNTQ3LDU0My42MSw1NDMsNTQ3LjYxLDUzOSw1MzguNjEsNTQzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgU2F2ZVNldHRpbmdzIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJTYXZlU2V0dGluZ3MiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNzQiIGRhdGEtdWlkPSJsbmszNyIgaWQ9ImxpbmtfU2F2ZVNldHRpbmdzX1N5c3RlbSI+PHBhdGggZD0iTTkxOC4yLDI2MSBDOTcwLjQ1LDI2MSAxMDM2Ljc1LDI2MSAxMDM2Ljc1LDI2MSBDMTAzNi43NSwyNjEgMTAzNi43NSw0MjQuMzcgMTAzNi43NSw1MDAuNjQiIGZpbGw9Im5vbmUiIGlkPSJTYXZlU2V0dGluZ3MtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iOTEyLjIsMjYxLDkyMS4yLDI2NSw5MTcuMiwyNjEsOTIxLjIsMjU3LDkxMi4yLDI2MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIFNhdmVIaWdoU2NvcmUgdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlNhdmVIaWdoU2NvcmUiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNzUiIGRhdGEtdWlkPSJsbmszOCIgaWQ9ImxpbmtfU2F2ZUhpZ2hTY29yZV9TeXN0ZW0iPjxwYXRoIGQ9Ik05MzcuOTMsMzI3IEM5ODIuNzMsMzI3IDEwMjUuNzUsMzI3IDEwMjUuNzUsMzI3IEMxMDI1Ljc1LDMyNyAxMDI1Ljc1LDQzOS41MiAxMDI1Ljc1LDUwMC42MSIgZmlsbD0ibm9uZSIgaWQ9IlNhdmVIaWdoU2NvcmUtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iOTMxLjkzLDMyNyw5NDAuOTMsMzMxLDkzNi45MywzMjcsOTQwLjkzLDMyMyw5MzEuOTMsMzI3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIE1vdmVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNb3ZlUHV5byIgZGF0YS1lbnRpdHktMj0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI3OCIgZGF0YS11aWQ9ImxuazM5IiBpZD0ibGlua19Nb3ZlUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yODQuNzUsMzMyLjgyIEMyODQuNzUsMzA5LjUxIDI4NC43NSwyNTQuMjUgMjg0Ljc1LDI1NC4yNSBDMjg0Ljc1LDI1NC4yNSAzNDQuNzUsMjU0LjI1IDM5NS43OSwyNTQuMjUiIGZpbGw9Im5vbmUiIGlkPSJNb3ZlUHV5by10by1LZXlib2FyZENvbnRyb2wiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQwMS43OSwyNTQuMjUsMzkyLjc5LDI1MC4yNSwzOTYuNzksMjU0LjI1LDM5Mi43OSwyNTguMjUsNDAxLjc5LDI1NC4yNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYxLjE4NTEiIHg9IjMwNC45OCIgeT0iMjY3LjMxNjkiPiYjMTcxO2V4dGVuZCYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgUm90YXRlUHV5byB0byBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUm90YXRlUHV5byIgZGF0YS1lbnRpdHktMj0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI3OSIgZGF0YS11aWQ9ImxuazQwIiBpZD0ibGlua19Sb3RhdGVQdXlvX0tleWJvYXJkQ29udHJvbCI+PHBhdGggZD0iTTIyNS43NSwyNjEuOTggQzIyNS43NSwyNTQuNzYgMjI1Ljc1LDI0Ny42NSAyMjUuNzUsMjQ3LjY1IEMyMjUuNzUsMjQ3LjY1IDMxNC4yMiwyNDcuNjUgMzgzLjIzLDI0Ny42NSIgZmlsbD0ibm9uZSIgaWQ9IlJvdGF0ZVB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODkuMjMsMjQ3LjY1LDM4MC4yMywyNDMuNjUsMzg0LjIzLDI0Ny42NSwzODAuMjMsMjUxLjY1LDM4OS4yMywyNDcuNjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2MS4xODUxIiB4PSIyMzguMzMiIHk9IjI0My43MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFF1aWNrRHJvcFB1eW8gdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlF1aWNrRHJvcFB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iODAiIGRhdGEtdWlkPSJsbms0MSIgaWQ9ImxpbmtfUXVpY2tEcm9wUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yOTEuNzUsMjE4LjQyIEMyOTEuNzUsMjI1LjI5IDI5MS43NSwyMzQuNDUgMjkxLjc1LDIzNC40NSBDMjkxLjc1LDIzNC40NSAzNDUuNTMsMjM0LjQ1IDM5My44NywyMzQuNDUiIGZpbGw9Im5vbmUiIGlkPSJRdWlja0Ryb3BQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5Ljg3LDIzNC40NSwzOTAuODcsMjMwLjQ1LDM5NC44NywyMzQuNDUsMzkwLjg3LDIzOC40NSwzOTkuODcsMjM0LjQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzM4LjgiIHk9IjIzMC41MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIExhdW5jaEFwcCB0byBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iTGF1bmNoQXBwIiBkYXRhLWVudGl0eS0yPSJTdGFydE5ld0dhbWUiIGRhdGEtc291cmNlLWxpbmU9IjgzIiBkYXRhLXVpZD0ibG5rNDIiIGlkPSJsaW5rX0xhdW5jaEFwcF9TdGFydE5ld0dhbWUiPjxwYXRoIGQ9Ik0zMTEuNzUsNzYuODIgQzMxMS43NSw5NC42MSAzMTEuNzUsMTQxLjA4IDMxMS43NSwxNDEuMDggQzMxMS43NSwxNDEuMDggMzQwLjU4LDE0MS4wOCAzNzYuNTEsMTQxLjA4IiBmaWxsPSJub25lIiBpZD0iTGF1bmNoQXBwLXRvLVN0YXJ0TmV3R2FtZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzgyLjUxLDE0MS4wOCwzNzMuNTEsMTM3LjA4LDM3Ny41MSwxNDEuMDgsMzczLjUxLDE0NS4wOCwzODIuNTEsMTQxLjA4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjMuMDA2OCIgeD0iMzE2IiB5PSIxNTQuMTQ2OSI+JiMxNzE7aW5jbHVkZSYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgRXJhc2VQdXlvIHRvIENoYWluUmVhY3Rpb24tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRXJhc2VQdXlvIiBkYXRhLWVudGl0eS0yPSJDaGFpblJlYWN0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI4NCIgZGF0YS11aWQ9ImxuazQzIiBpZD0ibGlua19FcmFzZVB1eW9fQ2hhaW5SZWFjdGlvbiI+PHBhdGggZD0iTTI3Mi42NSw0MDEuOSBDMzA3LjE4LDQwMS45IDM0OC43OCw0MDEuOSAzODcuMzgsNDAxLjkiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tdG8tQ2hhaW5SZWFjdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzkzLjM4LDQwMS45LDM4NC4zOCwzOTcuOSwzODguMzgsNDAxLjksMzg0LjM4LDQwNS45LDM5My4zOCw0MDEuOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjMzNC4wMSIgeT0iNDE0Ljk2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIENoYWluUmVhY3Rpb24gdG8gRGlzcGxheVNjb3JlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkNoYWluUmVhY3Rpb24iIGRhdGEtZW50aXR5LTI9IkRpc3BsYXlTY29yZSIgZGF0YS1zb3VyY2UtbGluZT0iODUiIGRhdGEtdWlkPSJsbms0NCIgaWQ9ImxpbmtfQ2hhaW5SZWFjdGlvbl9EaXNwbGF5U2NvcmUiPjxwYXRoIGQ9Ik01MjIuNzIsMzk1LjEgQzU0OS41MiwzOTUuMSA1NzQuNjcsMzk1LjEgNjAxLjA0LDM5NS4xIiBmaWxsPSJub25lIiBpZD0iQ2hhaW5SZWFjdGlvbi10by1EaXNwbGF5U2NvcmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYwNy4wNCwzOTUuMSw1OTguMDQsMzkxLjEsNjAyLjA0LDM5NS4xLDU5OC4wNCwzOTkuMSw2MDcuMDQsMzk1LjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1NjUuODgiIHk9IjM5MS4xNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBaZW5rZXNoaUJvbnVzIHRvIERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJaZW5rZXNoaUJvbnVzIiBkYXRhLWVudGl0eS0yPSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9Ijg2IiBkYXRhLXVpZD0ibG5rNDUiIGlkPSJsaW5rX1plbmtlc2hpQm9udXNfRGlzcGxheVNjb3JlIj48cGF0aCBkPSJNNTM5Ljk4LDQ2NC42IEM1OTcuNzUsNDY0LjYgNjY1Ljc1LDQ2NC42IDY2NS43NSw0NjQuNiBDNjY1Ljc1LDQ2NC42IDY2NS43NSw0NDAuMDcgNjY1Ljc1LDQyMC45OCIgZmlsbD0ibm9uZSIgaWQ9Ilplbmtlc2hpQm9udXMtdG8tRGlzcGxheVNjb3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NjUuNzUsNDE0Ljk4LDY2MS43NSw0MjMuOTgsNjY1Ljc1LDQxOS45OCw2NjkuNzUsNDIzLjk4LDY2NS43NSw0MTQuOTgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1NjMuNjciIHk9IjQ3Ny42NjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBHYW1lT3ZlckNoZWNrIHRvIEdhbWVPdmVyQW5pbWF0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkdhbWVPdmVyQ2hlY2siIGRhdGEtZW50aXR5LTI9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI4NyIgZGF0YS11aWQ9ImxuazQ2IiBpZD0ibGlua19HYW1lT3ZlckNoZWNrX0dhbWVPdmVyQW5pbWF0aW9uIj48cGF0aCBkPSJNMzA0LjM5LDU0MyBDMzI5LjM4LDU0MyAzNTEuMDMsNTQzIDM3Ni4wMiw1NDMiIGZpbGw9Im5vbmUiIGlkPSJHYW1lT3ZlckNoZWNrLXRvLUdhbWVPdmVyQW5pbWF0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODIuMDIsNTQzLDM3My4wMiw1MzksMzc3LjAyLDU0MywzNzMuMDIsNTQ3LDM4Mi4wMiw1NDMiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIyNzkuMiIgeT0iNTU2LjA2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIERpc3BsYXlTY29yZSB0byBTYXZlSGlnaFNjb3JlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkRpc3BsYXlTY29yZSIgZGF0YS1lbnRpdHktMj0iU2F2ZUhpZ2hTY29yZSIgZGF0YS1zb3VyY2UtbGluZT0iODgiIGRhdGEtdWlkPSJsbms0NyIgaWQ9ImxpbmtfRGlzcGxheVNjb3JlX1NhdmVIaWdoU2NvcmUiPjxwYXRoIGQ9Ik02NjUuNzUsMzg0LjkyIEM2NjUuNzUsMzY1LjcyIDY2NS43NSwzMzUgNjY1Ljc1LDMzNSBDNjY1Ljc1LDMzNSA3MzIuNjIsMzM1IDc4OC45OCwzMzUiIGZpbGw9Im5vbmUiIGlkPSJEaXNwbGF5U2NvcmUtdG8tU2F2ZUhpZ2hTY29yZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzk0Ljk4LDMzNSw3ODUuOTgsMzMxLDc4OS45OCwzMzUsNzg1Ljk4LDMzOSw3OTQuOTgsMzM1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjMuMDA2OCIgeD0iNjQxLjQiIHk9IjM0OC4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tU1JDPVtiTExSSm5EMTU3eFZOcDdYbklWeTBPUUc4QThjWVhUdUNGNWp0OHhqZmlqa2lwaTU2c0RZVHFMUUJhOGc1WS1lWTBXOFdibktCNUp3T3dSSkJLXy0xTVRjd05RY1hPMTlpdmRDLVN3U3h2cGxkNUNKRlNHMHN5MG51V2FDT2VRM1Q2cE9ia09jM0lpNTdKVzRLYjFGbVpXUW4xYUowTXc2TGpuNDRpMHFCOEdwQUdIaTFvVGlKUmkwWUJUOGxFXzRnbjJfSkJBUlRGRGpTRlhMV3BnczdUMTFfM2RZVm9GVTRsN1Boem0xZTBsa2MzMjNkMFpYeEg2bEhGcGRuNXlHdmk2Q1l6NkdmYU5IR0tVVm9Td0VSRzZJUFUzU3lUVlJ1SDd6MVZNNW5uZ3N1bVdkYUNFRThKbEVPT3J1c25wRWlGdUF5TlUzcEtfMXA3Q2p4SThUa2VaSkUxYjdsNEJ6dm53VFUyTXV0T0hmSXFfcWY1QW91cEJuRmRFYWRuVmRHbFlxbUZUM1lyTnBkYzc1eDE3allUUEF4SlkxcUU2ZWs3WnF6M0VoOEY2TjFPRElXcWdmNlFyTXQyQlBFUDl6OWNMVkUyZkVxOU05aTdXT0VsV002aGE2WHYzQ2lHYU1BUFFFdlY5cG1jaTBrVG5GRUJNbjVDTWtsUG9nX2ZhXzV5TTZFV013anFvZFRxYnNGTFd2UTFJbXRudjZUejhQLW9KdWttX3JXeU1HWnVxWEZXcU5fNVllcE5xYnNVZHdwOV9neHAzamtzYjNKcnZueDlKbUVSTkdLSlYtTm9CcmlSTFdUYmlBVG5NUXZZZGlRaHpvekNNMUdGS3ZwQUoyTUQyWjVxS3dGS0toeXBvTERfbDF4NFMxeGFyMG1uZjBDMXA4bzg2RWhoOE5rVUotbENYWE43MGoxNUN4ejcxRVVEdjdMWEF2MlVFb1JRTFRNTkU2c25OM01RWF9NV3NNeldOd1lrNmNzRm1Ed2hSSmhaS1RfS0I3dHZzbEVEdzZ1MUVvb2ZGaUlqV1k4aVdEYjdiV0dvVk1RcmppUkNyc0dWbW55THdiamxLeC1GTU1KWFJfYmRFRDhHX29mVGZ5X2N5dnRtbk1OenJXUXVLYktnc3lmbmtsbXF3N21zV0dPTW5PU0piaFZ2ZWw2b2R0NWZWaFJGTVRkQm95SGl2UFdjWWdyaUhYWGRyZlJlYkg1VTd1RURxVUhhdmwwa2Q5Q3puZ3ZMYXdqZy11ekxaNjQxSlR5OEhwdkxMSlRZYlo1ekJLbWVLQUVaa3hmR0tiTklmUklCZk5iZUxxQnd5My1QZDZ4Q2hHdmdIQWotZXVJZVJNbmNXZlVwRWJRN1AwTHNUZHVvLVhDTlJvZEo4dGlhNFAyemFXSnUxeWh5WHJhWTRJSDNSQVJUWHc3X01RUkUxWkRaYkFQelBQZmpNQWZwTWcyWXZVUkFpRmswSXdrajBaWkFuT1R4Vk1oRk5QTTRNMWktNVlweHpkdlF5VTU0Q0hFQk1lY1NHM1NoUzhSeUZJcE5HQ0NWVWNNWG9lSWc4WUxIajdBdEFlTzVOMkN5MmdWMXBTaGZsZ2VKbWNDYkdxS3kzXzAwMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h2 id="_7">リリース計画<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>今回のリリース計画では、以下のイテレーションに従ってぷよぷよゲームを開発します：</p>
<blockquote>
<p>計画づくりとは「なにをいつまでに作ればいいのか？」という質問に答える作業だと私は考えている</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<ul>
<li><strong>イテレーション0</strong>: 環境の構築（Electron + React + TypeScript + テスト環境）</li>
<li><strong>イテレーション1</strong>: ゲーム開始の実装</li>
<li><strong>イテレーション2</strong>: ぷよの移動の実装</li>
<li><strong>イテレーション3</strong>: ぷよの回転の実装</li>
<li><strong>イテレーション4</strong>: ぷよの自由落下の実装</li>
<li><strong>イテレーション5</strong>: ぷよの高速落下の実装</li>
<li><strong>イテレーション6</strong>: ぷよの消去の実装</li>
<li><strong>イテレーション7</strong>: 連鎖反応の実装</li>
<li><strong>イテレーション8</strong>: 全消しボーナスの実装</li>
<li><strong>イテレーション9</strong>: ゲームオーバーの実装</li>
</ul>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ぷよぷよゲーム開発スタートです！</p>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>環境の構築は、家を建てる際の基礎工事のようなものです。しっかりとした基礎があってこそ、安心してコードを書くことができます。</p>
<h3 id="_8">ソフトウェア開発の三種の神器<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本章では、これら三種の神器を Electron + React + TypeScript の環境で準備していきます。</p>
<h3 id="git">バージョン管理: Git とコミットメッセージ<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<h4 id="git_1">Git リポジトリの初期化<a class="headerlink" href="#git_1" title="Permanent link">&para;</a></h4>
<p>まず、プロジェクトフォルダを作成し、Git リポジトリを初期化します：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>puyo-puyo-electron
<span class="nb">cd</span><span class="w"> </span>puyo-puyo-electron
git<span class="w"> </span>init
</code></pre></div>
<h4 id="gitignore">.gitignore の作成<a class="headerlink" href="#gitignore" title="Permanent link">&para;</a></h4>
<p>Node.js と Electron プロジェクトで除外すべきファイルを <code>.gitignore</code> に追加します：</p>
<div class="highlight"><pre><span></span><code># Dependencies
node_modules/

# Build outputs
dist/
out/
*.js
*.d.ts
!*.config.js
!gulpfile.js

# IDEs
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db

# Logs
*.log
npm-debug.log*

# Testing
coverage/

# Environment
.env
.env.local
</code></pre></div>
<h4 id="_9">コミットメッセージの書き方<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>私たちのプロジェクトでは、<a href="https://www.conventionalcommits.org/ja/">Conventional Commits</a> の書式に従ってコミットメッセージを書きます。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p><strong>コミットのタイプ：</strong></p>
<ul>
<li><strong>feat</strong>: 新しい機能</li>
<li><strong>fix</strong>: バグ修正</li>
<li><strong>docs</strong>: ドキュメント変更のみ</li>
<li><strong>style</strong>: コードに影響を与えない変更（空白、フォーマットなど）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更</li>
<li><strong>test</strong>: テストの追加や修正</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更</li>
</ul>
<p><strong>例：</strong></p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Electron アプリケーションの初期化&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: メソッドの抽出&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよ消去のテストケースを追加&#39;</span>
</code></pre></div>
<h3 id="_10">テスティング: パッケージマネージャとプロジェクト初期化<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<h4 id="nodejs-npm">Node.js と npm の確認<a class="headerlink" href="#nodejs-npm" title="Permanent link">&para;</a></h4>
<p>Node.js がインストールされているか確認します：</p>
<div class="highlight"><pre><span></span><code>node<span class="w"> </span>--version
npm<span class="w"> </span>--version
</code></pre></div>
<p>Node.js 18.x 以上が推奨です。</p>
<h4 id="packagejson">package.json の作成<a class="headerlink" href="#packagejson" title="Permanent link">&para;</a></h4>
<p>npm を使ってプロジェクトを初期化します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>init<span class="w"> </span>-y
</code></pre></div>
<p>生成された <code>package.json</code> を以下のように編集します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;puyo-puyo-electron&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;private&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;module&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dist/main/index.js&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;electron-vite dev&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;electron-vite build&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;preview&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;electron-vite preview&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;electron-vite preview&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vitest run&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vitest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vitest run --coverage&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint:fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx --fix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --write .&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format:check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --check .&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;gulp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gulp&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gulp watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;guard&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gulp guard&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gulp checkAndFix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;commit&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;git add . &amp;&amp; git commit&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;setup&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm install &amp;&amp; npm run check&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.3.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;react-dom&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.3.1&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;@types/react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.3.12&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;@types/react-dom&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.3.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;@typescript-eslint/eslint-plugin&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^8.35.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;@typescript-eslint/parser&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^8.35.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;@vitejs/plugin-react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.3.4&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;@vitest/coverage-v8&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^3.2.4&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;c8&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^10.1.3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;electron&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^33.2.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;electron-vite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^2.4.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eslint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^9.30.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eslint-config-prettier&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^10.1.5&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eslint-plugin-prettier&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.5.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eslint-plugin-react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^7.37.3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eslint-plugin-react-hooks&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.1.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eslint-plugin-sonarjs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^2.0.8&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;gulp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.0.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;gulp-shell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^0.8.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;prettier&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^3.6.2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;typescript&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~5.8.3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;vite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^7.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;vitest&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^3.2.4&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_11">依存パッケージのインストール<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>package.json に記載された全ての依存関係をインストールします：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install
</code></pre></div>
<p>これで、Electron、React、TypeScript、Vitest など、必要なすべてのツールがインストールされます。</p>
<h3 id="electron-react-typescript">Electron + React + TypeScript のプロジェクト構造<a class="headerlink" href="#electron-react-typescript" title="Permanent link">&para;</a></h3>
<p>Electron プロジェクトは、メインプロセスとレンダラープロセスの2つに分かれます。以下のようなディレクトリ構造を作成します：</p>
<div class="highlight"><pre><span></span><code>puyo-puyo-electron/
├── src/
│   ├── main/          # メインプロセス（Electron）
│   │   └── index.ts   # アプリケーションのエントリポイント
│   ├── preload/       # プリロードスクリプト（IPC通信）
│   │   └── index.ts
│   └── renderer/      # レンダラープロセス（React）
│       ├── src/
│       │   ├── App.tsx
│       │   ├── App.test.tsx
│       │   ├── main.tsx
│       │   └── vite-env.d.ts
│       └── index.html
├── electron.vite.config.ts
├── tsconfig.json
├── tsconfig.node.json
├── package.json
└── .gitignore
</code></pre></div>
<h4 id="_12">メインプロセスの作成<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p><code>src/main/index.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">app</span><span class="p">,</span><span class="w"> </span><span class="nx">BrowserWindow</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;electron&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">createWindow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mainWindow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BrowserWindow</span><span class="p">({</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">800</span><span class="p">,</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">600</span><span class="p">,</span>
<span class="w">    </span><span class="nx">webPreferences</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">preload</span><span class="o">:</span><span class="w"> </span><span class="kt">path.join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;../preload/index.js&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="nx">contextIsolation</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">nodeIntegration</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="c1">// 開発時は開発サーバーのURL、本番時はビルドされたHTMLファイルを読み込む</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;development&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mainWindow</span><span class="p">.</span><span class="nx">loadURL</span><span class="p">(</span><span class="s1">&#39;http://localhost:5173&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">mainWindow</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">openDevTools</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mainWindow</span><span class="p">.</span><span class="nx">loadFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;../renderer/index.html&#39;</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">whenReady</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">createWindow</span><span class="p">()</span>

<span class="w">  </span><span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;activate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">BrowserWindow</span><span class="p">.</span><span class="nx">getAllWindows</span><span class="p">().</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">createWindow</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;window-all-closed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">platform</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;darwin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">app</span><span class="p">.</span><span class="nx">quit</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="_13">プリロードスクリプトの作成<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p><code>src/preload/index.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">contextBridge</span><span class="p">,</span><span class="w"> </span><span class="nx">ipcRenderer</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;electron&#39;</span>

<span class="c1">// セキュアな API を公開</span>
<span class="nx">contextBridge</span><span class="p">.</span><span class="nx">exposeInMainWorld</span><span class="p">(</span><span class="s1">&#39;electronAPI&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 必要に応じて IPC 通信用の API を追加</span>
<span class="w">  </span><span class="nx">ping</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">ipcRenderer</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="_14">レンダラープロセスの作成<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/index.html</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;ja&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ぷよぷよゲーム<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/src/main.tsx&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p><code>src/renderer/src/main.tsx</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ReactDOM</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom/client&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./App&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="s1">&#39;./index.css&#39;</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">createRoot</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)</span><span class="o">!</span><span class="p">).</span><span class="nx">render</span><span class="p">(</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nt">React</span><span class="p">.</span><span class="na">StrictMode</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">App</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">React</span><span class="p">.</span><span class="na">StrictMode</span><span class="p">&gt;</span>
<span class="p">)</span>
</code></pre></div>
<p><code>src/renderer/src/App.tsx</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;App&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Electron</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">TypeScript</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">App</span>
</code></pre></div>
<p><code>src/renderer/src/vite-env.d.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">/// &lt;reference types=&quot;vite/client&quot; /&gt;</span>
</code></pre></div>
<h4 id="typescript">TypeScript 設定<a class="headerlink" href="#typescript" title="Permanent link">&para;</a></h4>
<p><code>tsconfig.json</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;compilerOptions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;target&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES2020&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;useDefineForClassFields&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lib&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ES2020&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DOM&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DOM.Iterable&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ESNext&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;skipLibCheck&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/* Bundler mode */</span>
<span class="w">    </span><span class="nt">&quot;moduleResolution&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bundler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;allowImportingTsExtensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;resolveJsonModule&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;isolatedModules&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;noEmit&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jsx&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;react-jsx&quot;</span><span class="p">,</span>

<span class="w">    </span><span class="cm">/* Linting */</span>
<span class="w">    </span><span class="nt">&quot;strict&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;noUnusedLocals&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;noUnusedParameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;noFallthroughCasesInSwitch&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;include&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;src/renderer/src&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;references&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./tsconfig.node.json&quot;</span><span class="w"> </span><span class="p">}]</span>
<span class="p">}</span>
</code></pre></div>
<p><code>tsconfig.node.json</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;compilerOptions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;composite&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;skipLibCheck&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ESNext&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;moduleResolution&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bundler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;allowSyntheticDefaultImports&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;strict&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;include&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;src/main&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;src/preload&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="electron-vite">Electron Vite 設定<a class="headerlink" href="#electron-vite" title="Permanent link">&para;</a></h4>
<p><code>electron.vite.config.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineConfig</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;electron-vite&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">react</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@vitejs/plugin-react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">resolve</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineConfig</span><span class="p">({</span>
<span class="w">  </span><span class="nx">main</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">build</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">rollupOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kt">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;src/main/index.ts&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">preload</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">build</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">rollupOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kt">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;src/preload/index.ts&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">renderer</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">root</span><span class="o">:</span><span class="w"> </span><span class="kt">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;src/renderer&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="nx">build</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">rollupOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kt">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;src/renderer/index.html&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">plugins</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">react</span><span class="p">()]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_15">テスティング環境のセットアップ<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<h4 id="vitest">Vitest 設定<a class="headerlink" href="#vitest" title="Permanent link">&para;</a></h4>
<p><code>vitest.config.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineConfig</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest/config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">react</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@vitejs/plugin-react&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineConfig</span><span class="p">({</span>
<span class="w">  </span><span class="nx">plugins</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">react</span><span class="p">()],</span>
<span class="w">  </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">globals</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jsdom&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">setupFiles</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;./src/renderer/src/test/setup.ts&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">coverage</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;v8&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">reporter</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;html&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;json&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">reportsDirectory</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;coverage&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">exclude</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;dist/**&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;node_modules/**&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;**/*.test.{ts,tsx}&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;**/*.config.{js,ts}&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;src/main/**&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;src/preload/**&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;src/renderer/src/vite-env.d.ts&#39;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="_16">テストセットアップファイル<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/test/setup.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">afterEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cleanup</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">matchers</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/jest-dom/matchers&#39;</span>

<span class="c1">// jest-dom matchers を追加</span>
<span class="nx">expect</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">matchers</span><span class="p">)</span>

<span class="c1">// 各テスト後にクリーンアップ</span>
<span class="nx">afterEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">cleanup</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="_17">サンプルテスト<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/App.test.tsx</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">render</span><span class="p">,</span><span class="w"> </span><span class="nx">screen</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./App&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;App&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;タイトルが表示される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span><span class="w"> </span><span class="p">/&gt;)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;ぷよぷよゲーム&#39;</span><span class="p">)).</span><span class="nx">toBeInTheDocument</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;サブタイトルが表示される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span><span class="w"> </span><span class="p">/&gt;)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;Electron + React + TypeScript&#39;</span><span class="p">)).</span><span class="nx">toBeInTheDocument</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<h3 id="_18">自動化: コード品質の自動管理<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<h4 id="eslint">静的コード解析: ESLint<a class="headerlink" href="#eslint" title="Permanent link">&para;</a></h4>
<p>良いコードを書き続けるためには、コードの品質を自動的にチェックする仕組みが必要です。</p>
<blockquote>
<p>静的コード解析とは、プログラムを実行することなく、ソースコードを解析してバグや脆弱性、コーディング規約違反などを検出する手法です。</p>
<p>— Wikipedia</p>
</blockquote>
<p>TypeScript + React 用の <strong>静的コード解析</strong> ツールとして <a href="https://eslint.org/">ESLint</a> を使います。必要なパッケージは package.json に含まれているので、<code>npm install</code> で既にインストールされています。</p>
<p><code>eslint.config.js</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">js</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@eslint/js&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">typescript</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@typescript-eslint/eslint-plugin&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">typescriptParser</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@typescript-eslint/parser&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">react</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;eslint-plugin-react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">reactHooks</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;eslint-plugin-react-hooks&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">prettier</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;eslint-plugin-prettier&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">prettierConfig</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;eslint-config-prettier&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">sonarjs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;eslint-plugin-sonarjs&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="nx">js</span><span class="p">.</span><span class="nx">configs</span><span class="p">.</span><span class="nx">recommended</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">files</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;**/*.{ts,tsx}&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">languageOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parser</span><span class="o">:</span><span class="w"> </span><span class="nx">typescriptParser</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parserOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">ecmaVersion</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;latest&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">ecmaFeatures</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">jsx</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">plugins</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;@typescript-eslint&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">typescript</span><span class="p">,</span>
<span class="w">      </span><span class="nx">react</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;react-hooks&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">reactHooks</span><span class="p">,</span>
<span class="w">      </span><span class="nx">prettier</span><span class="p">,</span>
<span class="w">      </span><span class="nx">sonarjs</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">typescript</span><span class="p">.</span><span class="nx">configs</span><span class="p">.</span><span class="nx">recommended</span><span class="p">.</span><span class="nx">rules</span><span class="p">,</span>
<span class="w">      </span><span class="p">...</span><span class="nx">react</span><span class="p">.</span><span class="nx">configs</span><span class="p">.</span><span class="nx">recommended</span><span class="p">.</span><span class="nx">rules</span><span class="p">,</span>
<span class="w">      </span><span class="p">...</span><span class="nx">reactHooks</span><span class="p">.</span><span class="nx">configs</span><span class="p">.</span><span class="nx">recommended</span><span class="p">.</span><span class="nx">rules</span><span class="p">,</span>
<span class="w">      </span><span class="p">...</span><span class="nx">prettierConfig</span><span class="p">.</span><span class="nx">rules</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;prettier/prettier&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;react/react-in-jsx-scope&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="c1">// 循環的複雑度の制限 - 7を超える場合はエラー</span>
<span class="w">      </span><span class="s1">&#39;complexity&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="p">}],</span>
<span class="w">      </span><span class="c1">// 認知的複雑度の制限 - 4を超える場合はエラー</span>
<span class="w">      </span><span class="s1">&#39;sonarjs/cognitive-complexity&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">],</span>
<span class="w">      </span><span class="c1">// その他の推奨ルール</span>
<span class="w">      </span><span class="s1">&#39;no-console&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">allow</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">}],</span>
<span class="w">      </span><span class="s1">&#39;no-debugger&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;no-var&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;prefer-const&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">react</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;detect&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">files</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;**/*.test.{ts,tsx}&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;@typescript-eslint/no-unused-expressions&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;@typescript-eslint/no-unused-vars&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;no-console&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;off&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ignores</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;dist/**&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node_modules/**&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;coverage/**&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;*.config.js&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;out/**&#39;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<p>設定ファイルを作成したら、以下のコマンドで静的コード解析を実行します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>lint
</code></pre></div>
<p>自動修正を実行します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>lint:fix
</code></pre></div>
<h5 id="_19">コード複雑度のチェック<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h5>
<p>ESLint の設定ファイルには、<strong>循環的複雑度</strong> と <strong>認知的複雑度</strong> の制限が含まれています。これらの指標について説明します。</p>
<p><strong>循環的複雑度 (Cyclomatic Complexity)</strong></p>
<blockquote>
<p>循環的複雑度(サイクロマティック複雑度)とは、ソフトウェア測定法の一つであり、コードがどれぐらい複雑であるかをメソッド単位で数値にして表す指標。</p>
</blockquote>
<p>私たちの設定では、循環的複雑度を <strong>7以下</strong> に制限しています。</p>
<table>
<thead>
<tr>
<th>複雑度の範囲</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>1～10</td>
<td>低複雑度：管理しやすく、問題なし。</td>
</tr>
<tr>
<td>11～20</td>
<td>中程度の複雑度：リファクタリングを検討。</td>
</tr>
<tr>
<td>21～50</td>
<td>高複雑度：リファクタリングが強く推奨される。</td>
</tr>
<tr>
<td>51以上</td>
<td>非常に高い複雑度:コードを分割する必要がある。</td>
</tr>
</tbody>
</table>
<p><strong>認知的複雑度 (Cognitive Complexity)</strong></p>
<blockquote>
<p>認知的複雑度（Cognitive Complexity）
プログラムを読む人の認知負荷を測るための指標のこと。コードの構造が「どれだけ頭を使う必要があるか」を定量的に評価する。循環的複雑度とは異なり、制御構造のネストやコードの流れの読みやすさに重点を置いている</p>
</blockquote>
<p>私たちの設定では、認知的複雑度を <strong>4以下</strong> に制限しています。</p>
<table>
<thead>
<tr>
<th>複雑度の範囲</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>0～4</td>
<td>理解が非常に容易：リファクタリング不要。</td>
</tr>
<tr>
<td>5～14</td>
<td>中程度の難易度:改善が必要な場合もある。</td>
</tr>
<tr>
<td>15以上</td>
<td>理解が困難:コードの簡素化を検討するべき。</td>
</tr>
</tbody>
</table>
<p>コード複雑度の制限により、以下の効果が得られます：</p>
<ul>
<li><strong>可読性向上</strong>: 小さなメソッドは理解しやすい</li>
<li><strong>保守性向上</strong>: 変更の影響範囲が限定される</li>
<li><strong>テスト容易性</strong>: 個別機能のテストが簡単</li>
<li><strong>自動品質管理</strong>: 複雑なコードの混入を自動防止</li>
</ul>
<p>このように、ESLint ルールを活用することで、継続的にコード品質を保つことができます。</p>
<h5 id="_20">循環参照の検知<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h5>
<p>循環参照を検知できるようにします。</p>
<blockquote>
<p>循環参照（じゅんかんさんしょう）とは、複数の物体または情報が、相互の情報を参照し合ってループを成している状態のこと。循環参照が存在すると、コードの理解が困難になり、保守性が低下します。</p>
<p>— Wikipedia</p>
</blockquote>
<p><strong>dependency-cruiser</strong> を使って循環参照を検知します。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>i<span class="w"> </span>-D<span class="w"> </span>dependency-cruiser
npx<span class="w"> </span>depcruise<span class="w"> </span>--init
</code></pre></div>
<p>初期化コマンドを実行すると、<code>.dependency-cruiser.js</code> という設定ファイルが作成されます。以下のように編集して、循環参照の検知を有効にします。</p>
<div class="highlight"><pre><span></span><code><span class="cm">/** @type {import(&#39;dependency-cruiser&#39;).IConfiguration} */</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">forbidden</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-circular&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;循環参照を禁止します&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">circular</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-orphans&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;使用されていないファイルを警告します&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">orphan</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">pathNot</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s1">&#39;(^|/)\\.[^/]+\\.(js|cjs|mjs|ts|json)$&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// ドットファイル</span>
<span class="w">          </span><span class="s1">&#39;\\.d\\.ts$&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 型定義ファイル</span>
<span class="w">          </span><span class="s1">&#39;(^|/)tsconfig\\.json$&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// tsconfig</span>
<span class="w">          </span><span class="s1">&#39;(^|/)(babel|webpack|electron\\.vite)\\.config\\.(js|cjs|mjs|ts|json)$&#39;</span><span class="w"> </span><span class="c1">// 設定ファイル</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">doNotFollow</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;node_modules|dist|out&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">tsPreCompilationDeps</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">tsConfig</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;tsconfig.json&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">enhancedResolveOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">exportsFields</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;exports&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">conditionNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;import&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;require&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">reporterOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">dot</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">collapsePattern</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;node_modules/[^/]+&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">archi</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">collapsePattern</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;^(node_modules|dist|out|src)/[^/]+&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>循環参照をチェックするには、以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><code>npx<span class="w"> </span>depcruise<span class="w"> </span>src/renderer/src
</code></pre></div>
<p>循環参照が検出された場合は、以下のようなエラーメッセージが表示されます。</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span>error<span class="w"> </span>no-circular:<span class="w"> </span>src/renderer/src/module-a.ts<span class="w"> </span>→<span class="w"> </span>src/renderer/src/module-b.ts<span class="w"> </span>→<span class="w"> </span>src/renderer/src/module-a.ts
</code></pre></div>
<p>このエラーが表示された場合は、モジュールの依存関係を見直し、循環参照を解消する必要があります。</p>
<p><strong>循環参照を解消する一般的な方法：</strong></p>
<ol>
<li><strong>依存性逆転の原則を適用</strong>: インターフェースを導入して依存関係を逆転させる</li>
<li><strong>共通モジュールの抽出</strong>: 両方が依存する部分を別のモジュールに抽出する</li>
<li><strong>レイヤーアーキテクチャの導入</strong>: 明確な依存関係の方向性を定義する</li>
</ol>
<p>可視化して依存関係を確認することもできます。</p>
<div class="highlight"><pre><span></span><code>npx<span class="w"> </span>depcruise<span class="w"> </span>src/renderer/src<span class="w"> </span>--include-only<span class="w"> </span><span class="s2">&quot;^src&quot;</span><span class="w"> </span>--output-type<span class="w"> </span>dot<span class="w"> </span><span class="p">|</span><span class="w"> </span>dot<span class="w"> </span>-T<span class="w"> </span>svg<span class="w"> </span>&gt;<span class="w"> </span>dependency-graph.svg
</code></pre></div>
<p>これで依存関係のグラフが SVG 形式で生成されます。</p>
<h4 id="prettier">コードフォーマッタ: Prettier<a class="headerlink" href="#prettier" title="Permanent link">&para;</a></h4>
<p><code>.prettierrc</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;semi&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;singleQuote&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;tabWidth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;trailingComma&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;printWidth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;arrowParens&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;always&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>フォーマットを実行します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>format
</code></pre></div>
<p>フォーマットチェックを実行します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>format:check
</code></pre></div>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>—  リーダブルコード</p>
</blockquote>
<h4 id="gulp">タスクランナー: Gulp<a class="headerlink" href="#gulp" title="Permanent link">&para;</a></h4>
<p><code>gulpfile.js</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">watch</span><span class="p">,</span><span class="w"> </span><span class="nx">series</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;gulp&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;gulp-shell&#39;</span>

<span class="c1">// テストタスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span><span class="s1">&#39;npm run test&#39;</span><span class="p">])</span>

<span class="c1">// テストカバレッジタスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span><span class="s1">&#39;npm run test:coverage&#39;</span><span class="p">])</span>

<span class="c1">// 静的コード解析タスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">lint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span><span class="s1">&#39;npm run lint&#39;</span><span class="p">])</span>

<span class="c1">// 自動修正付き静的コード解析タスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">lintFix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span><span class="s1">&#39;npm run lint:fix&#39;</span><span class="p">])</span>

<span class="c1">// フォーマットタスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span><span class="s1">&#39;npm run format&#39;</span><span class="p">])</span>

<span class="c1">// フォーマットチェックタスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">formatCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span><span class="s1">&#39;npm run format:check&#39;</span><span class="p">])</span>

<span class="c1">// ビルドタスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span><span class="s1">&#39;npm run build&#39;</span><span class="p">])</span>

<span class="c1">// 開発サーバータスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">([</span><span class="s1">&#39;npm run dev&#39;</span><span class="p">])</span>

<span class="c1">// 全体チェックタスク（自動修正付き）</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">checkAndFix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">series</span><span class="p">(</span><span class="nx">lintFix</span><span class="p">,</span><span class="w"> </span><span class="nx">format</span><span class="p">,</span><span class="w"> </span><span class="nx">test</span><span class="p">)</span>

<span class="c1">// ファイル監視タスク（Guard）</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">guard</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;🔍 Guard is watching for file changes...&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Files will be automatically linted, formatted, and tested on change.&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;src/renderer/src/**/*.{ts,tsx}&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">series</span><span class="p">(</span><span class="nx">lintFix</span><span class="p">,</span><span class="w"> </span><span class="nx">format</span><span class="p">,</span><span class="w"> </span><span class="nx">test</span><span class="p">))</span>
<span class="w">  </span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;**/*.test.{ts,tsx}&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">series</span><span class="p">(</span><span class="nx">test</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// ファイル監視タスク</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">watchFiles</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;src/renderer/src/**/*.{ts,tsx}&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">series</span><span class="p">(</span><span class="nx">formatCheck</span><span class="p">,</span><span class="w"> </span><span class="nx">lint</span><span class="p">,</span><span class="w"> </span><span class="nx">test</span><span class="p">))</span>
<span class="w">  </span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;**/*.test.{ts,tsx}&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">series</span><span class="p">(</span><span class="nx">test</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// デフォルトタスク</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">series</span><span class="p">(</span><span class="nx">checkAndFix</span><span class="p">,</span><span class="w"> </span><span class="nx">guard</span><span class="p">)</span>

<span class="c1">// ウォッチタスクのエイリアス</span>
<span class="k">export</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">watchFiles</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">watch</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>登録されたタスクを確認します：</p>
<div class="highlight"><pre><span></span><code>npx<span class="w"> </span>gulp<span class="w"> </span>--tasks
</code></pre></div>
<p>特定のタスクを実行します：</p>
<div class="highlight"><pre><span></span><code>npx<span class="w"> </span>gulp<span class="w"> </span><span class="nb">test</span><span class="w">      </span><span class="c1"># テスト実行</span>
npx<span class="w"> </span>gulp<span class="w"> </span>lint<span class="w">      </span><span class="c1"># 静的解析</span>
npx<span class="w"> </span>gulp<span class="w"> </span>format<span class="w">    </span><span class="c1"># フォーマット</span>
npx<span class="w"> </span>gulp<span class="w"> </span>check<span class="w">     </span><span class="c1"># 全体チェック（自動修正付き）</span>
</code></pre></div>
<h4 id="guard">タスクの自動実行: Guard<a class="headerlink" href="#guard" title="Permanent link">&para;</a></h4>
<p>ファイルの変更を検知して自動的にテストやフォーマットを実行します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>guard
</code></pre></div>
<p>このコマンドを実行すると、ファイルを保存するたびに自動的に以下が実行されます：</p>
<ol>
<li>ESLint による静的解析（自動修正付き）</li>
<li>Prettier によるフォーマット</li>
<li>テストの実行</li>
</ol>
<p>開発を始める際は、まず <code>npm run guard</code> を実行して、後はコードを書くことに集中しましょう！</p>
<h3 id="electron_1">Electron アプリケーションの起動確認<a class="headerlink" href="#electron_1" title="Permanent link">&para;</a></h3>
<p>開発サーバーを起動してアプリケーションを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、「ぷよぷよゲーム」というタイトルが表示されれば成功です！</p>
<h3 id="_21">環境構築の完了とコミット<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！これで Electron + React + TypeScript の開発環境のセットアップが完了しました。</p>
<p>以下のツールが使えるようになりました：</p>
<ul>
<li>✅ <strong>バージョン管理</strong>: Git（Conventional Commits 形式）</li>
<li>✅ <strong>テスティング</strong>: Vitest（カバレッジレポート付き）</li>
<li>✅ <strong>静的コード解析</strong>: ESLint（循環的複雑度・認知的複雑度チェック付き）</li>
<li>✅ <strong>コードフォーマット</strong>: Prettier</li>
<li>✅ <strong>タスクランナー</strong>: Gulp（Guard による自動実行）</li>
<li>✅ <strong>Electron</strong>: デスクトップアプリケーションフレームワーク</li>
<li>✅ <strong>React</strong>: UI フレームワーク</li>
<li>✅ <strong>TypeScript</strong>: 型安全な開発</li>
</ul>
<p>ここまでの作業をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: Electron + React + TypeScript 開発環境のセットアップ&#39;</span>
</code></pre></div>
<p>これで <a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a> の準備が完了しました。次のイテレーションから、テスト駆動開発でぷよぷよゲームを実装していきましょう！</p>
<h3 id="_22">次回予告<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>次のイテレーション1では、ゲーム開始の実装を行います。具体的には：</p>
<ul>
<li>ゲームボードの初期化</li>
<li>ゲーム状態の管理</li>
<li>最初のぷよの生成</li>
</ul>
<p>テスト駆動開発の Red-Green-Refactor サイクルを体験しながら、少しずつゲームを作り上げていきましょう！</p>
<hr />
<h3 id="_23">まとめ<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>イテレーション0では、Electron + React + TypeScript の開発環境を構築しました。重要なポイントは：</p>
<ol>
<li><strong>Electron のアーキテクチャ理解</strong>: メインプロセスとレンダラープロセスの役割分担</li>
<li><strong>ソフトウェア開発の三種の神器</strong>: バージョン管理、テスティング、自動化</li>
<li><strong>テスト駆動開発の準備</strong>: Vitest でのテスト環境構築</li>
<li><strong>コード品質の自動管理</strong>: ESLint、Prettier、Gulp、Guard の活用</li>
<li><strong>型安全な開発</strong>: TypeScript による静的型チェック</li>
</ol>
<p>これらの基盤があることで、安心してテスト駆動開発でぷよぷよゲームを実装できます。次のイテレーションからが本番です。お楽しみに！</p>
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>このイテレーションでは、最初のユーザーストーリー「プレイヤーとして、新しいゲームを開始できる」を実装します。</p>
<h3 id="_24">ユーザーストーリー<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>プレイヤーとして、新しいゲームを開始できる
</code></pre></div>
<h3 id="todo">TODOリストの作成<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発では、実装に入る前に <strong>TODOリスト</strong> を作成します。</p>
<blockquote>
<p>テスト駆動開発はテストのための手法ではない。開発のための手法、つまりプログラムを書くための技術なのだ。
計画作りと学びがコードを書く行為と密接に絡み合ってリズムを作り出し、そのリズムがプログラマーの不安を抑えるとともに、設計に関するフィードバックループを確立している。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><strong>TODOリストの作り方：</strong></p>
<ol>
<li><strong>大きな機能を小さなタスクに分割</strong></li>
<li><strong>テストしやすい単位で項目を作成</strong></li>
<li><strong>完了したら項目を消す</strong>（達成感を味わう）</li>
</ol>
<p>「ゲーム開始」の機能を分解すると、以下のような TODOリストになります：</p>
<div class="highlight"><pre><span></span><code>☐ Gameクラスを作成する
☐ ゲームループを実装する
☐ GameCanvasコンポーネントを作成する
☐ Canvasにゲーム画面を描画する
☐ ゲーム状態を初期化する
☐ Config, PuyoImage, Stage, Player, Score クラスを作成する
</code></pre></div>
<blockquote>
<p>TODOリストは、作業中に新しく気づいたことを書き留める「外部記憶」の役割も果たします。これにより、今やっていることに集中できます。</p>
</blockquote>
<h3 id="game">最初のテスト: Gameクラスの作成<a class="headerlink" href="#game" title="Permanent link">&para;</a></h3>
<p>それでは、テスト駆動開発のサイクルを回していきましょう。最初のタスクは「Gameクラスを作成する」です。</p>
<h4 id="red">Red: 失敗するテストを書く<a class="headerlink" href="#red" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Game.test.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">vi</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="p">,</span><span class="w"> </span><span class="nx">afterEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Game&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Score&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Game&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockConfig</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockPuyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockStage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockPlayer</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockScore</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockCanvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockContext</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// モックオブジェクトの作成</span>
<span class="w">    </span><span class="nx">mockCanvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">mockContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mockCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span><span class="o">!</span>

<span class="w">    </span><span class="nx">mockConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cellSize</span><span class="o">:</span><span class="w"> </span><span class="kt">32</span><span class="p">,</span>
<span class="w">      </span><span class="nx">cols</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Config</span>

<span class="w">    </span><span class="nx">mockPuyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">PuyoImage</span>
<span class="w">    </span><span class="nx">mockStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">draw</span><span class="o">:</span><span class="w"> </span><span class="kt">vi.fn</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Stage</span>
<span class="w">    </span><span class="nx">mockPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">draw</span><span class="o">:</span><span class="w"> </span><span class="kt">vi.fn</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Player</span>
<span class="w">    </span><span class="nx">mockScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">draw</span><span class="o">:</span><span class="w"> </span><span class="kt">vi.fn</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Score</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">afterEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">vi</span><span class="p">.</span><span class="nx">restoreAllMocks</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;初期化&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Gameクラスのインスタンスが作成できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span>
<span class="w">        </span><span class="nx">mockCanvas</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mockConfig</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mockPuyoImage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mockStage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mockPlayer</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mockScore</span>
<span class="w">      </span><span class="p">)</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">).</span><span class="nx">toBeInstanceOf</span><span class="p">(</span><span class="nx">Game</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>このテストを実行すると、当然失敗します（Red）：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>❌ Error: Cannot find module &#39;./Game&#39;
</code></pre></div>
<h4 id="green">Green: 最小限のコードで通す<a class="headerlink" href="#green" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Game.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Score&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span><span class="p">,</span>
<span class="w">    </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span>
<span class="w">    </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span><span class="p">,</span>
<span class="w">    </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Canvas context not found&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">score</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを再実行すると成功します（Green）：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ Test passed!
</code></pre></div>
<h4 id="refactor">Refactor: リファクタリング<a class="headerlink" href="#refactor" title="Permanent link">&para;</a></h4>
<p>現時点では、コードは十分シンプルなので、リファクタリングは不要です。</p>
<p>TODOリストを更新します：</p>
<div class="highlight"><pre><span></span><code>☑ Gameクラスを作成する
☐ ゲームループを実装する
☐ GameCanvasコンポーネントを作成する
☐ Canvasにゲーム画面を描画する
☐ ゲーム状態を初期化する
☐ Config, PuyoImage, Stage, Player, Score クラスを作成する
</code></pre></div>
<h3 id="_25">ゲームループの実装<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>次のタスクは「ゲームループを実装する」です。ゲームは継続的に画面を更新する必要があるため、<code>requestAnimationFrame</code> を使ってゲームループを実装します。</p>
<h4 id="red_1">Red: ゲームループのテスト<a class="headerlink" href="#red_1" title="Permanent link">&para;</a></h4>
<p><code>Game.test.ts</code> にテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ゲームループ&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;startメソッドを呼ぶとゲームループが開始される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">vi</span><span class="p">.</span><span class="nx">spyOn</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;requestAnimationFrame&#39;</span><span class="p">).</span><span class="nx">mockImplementation</span><span class="p">((</span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span>
<span class="w">      </span><span class="nx">mockCanvas</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockConfig</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockPuyoImage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockStage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockPlayer</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockScore</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;updateメソッドが呼ばれると各オブジェクトが描画される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span>
<span class="w">      </span><span class="nx">mockCanvas</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockConfig</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockPuyoImage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockStage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockPlayer</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mockScore</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// updateメソッドを直接呼び出す</span>
<span class="w">    </span><span class="p">;(</span><span class="nx">game</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">).</span><span class="nx">update</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">mockStage</span><span class="p">.</span><span class="nx">draw</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">mockContext</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">mockPlayer</span><span class="p">.</span><span class="nx">draw</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">mockContext</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">mockScore</span><span class="p">.</span><span class="nx">draw</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">mockContext</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを実行すると失敗します：</p>
<div class="highlight"><pre><span></span><code>❌ Error: game.start is not a function
</code></pre></div>
<h4 id="green_1">Green: ゲームループの実装<a class="headerlink" href="#green_1" title="Permanent link">&para;</a></h4>
<p><code>Game.ts</code> にゲームループを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">animationId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span><span class="p">,</span>
<span class="w">    </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span>
<span class="w">    </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span><span class="p">,</span>
<span class="w">    </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Canvas context not found&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">score</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">start</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">gameLoop</span><span class="p">())</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">stop</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">gameLoop</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">gameLoop</span><span class="p">())</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// キャンバスをクリア</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 各オブジェクトを描画</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行すると成功します：</p>
<div class="highlight"><pre><span></span><code>✅ All tests passed!
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ Gameクラスを作成する
☑ ゲームループを実装する
☐ GameCanvasコンポーネントを作成する
☐ Canvasにゲーム画面を描画する
☐ ゲーム状態を初期化する
☐ Config, PuyoImage, Stage, Player, Score クラスを作成する
</code></pre></div>
<h3 id="gamecanvas">GameCanvasコンポーネントの作成<a class="headerlink" href="#gamecanvas" title="Permanent link">&para;</a></h3>
<p>次は React コンポーネントを作成します。ゲームを描画する Canvas を管理する <code>GameCanvas</code> コンポーネントを作ります。</p>
<h4 id="red-gamecanvas">Red: GameCanvasコンポーネントのテスト<a class="headerlink" href="#red-gamecanvas" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/components/GameCanvas.test.tsx</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">vi</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">render</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./GameCanvas&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;GameCanvas&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Canvasが描画される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">GameCanvas</span><span class="w"> </span><span class="p">/&gt;)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">container</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">canvas</span><span class="p">).</span><span class="nx">toBeInTheDocument</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Canvasのサイズが正しく設定される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">GameCanvas</span><span class="w"> </span><span class="p">/&gt;)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">container</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">HTMLCanvasElement</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">192</span><span class="p">)</span><span class="w"> </span><span class="c1">// 6列 × 32ピクセル</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">384</span><span class="p">)</span><span class="w"> </span><span class="c1">// 12行 × 32ピクセル</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ゲームが自動的に開始される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">vi</span><span class="p">.</span><span class="nx">spyOn</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;requestAnimationFrame&#39;</span><span class="p">).</span><span class="nx">mockImplementation</span><span class="p">((</span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">GameCanvas</span><span class="w"> </span><span class="p">/&gt;)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを実行すると失敗します：</p>
<div class="highlight"><pre><span></span><code>❌ Error: Cannot find module &#39;./GameCanvas&#39;
</code></pre></div>
<h4 id="green-gamecanvas">Green: GameCanvasコンポーネントの実装<a class="headerlink" href="#green-gamecanvas" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/components/GameCanvas.tsx</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Game&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Score&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvasRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLCanvasElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">Game</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">)</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvasRef</span><span class="p">.</span><span class="nx">current</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">canvas</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// ゲームの依存オブジェクトを作成</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Canvasのサイズを設定</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>

<span class="w">    </span><span class="c1">// Gameインスタンスを作成して開始</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">)</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// クリーンアップ関数</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">game</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">canvas</span>
<span class="w">      </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">canvasRef</span><span class="p">}</span>
<span class="w">      </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span>
<span class="w">        </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2px solid #333&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">margin</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;20px auto&#39;</span>
<span class="w">      </span><span class="p">}}</span>
<span class="w">    </span><span class="p">/&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>このコードは、依存クラス（Config, PuyoImage, Stage, Player, Score）がまだ実装されていないので、まだ完全には動きません。次のステップで依存クラスを実装します。</p>
<h3 id="_26">依存クラスの実装<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>ゲームに必要な各クラスを実装していきます。</p>
<h4 id="config">Config クラス<a class="headerlink" href="#config" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Config.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">cellSize</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">32</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">cols</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">12</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="puyoimage">PuyoImage クラス<a class="headerlink" href="#puyoimage" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/PuyoImage.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="kt">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">HTMLImageElement</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 今は空の実装。後のイテレーションで画像を読み込む</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getImage</span><span class="p">(</span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">HTMLImageElement</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">color</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="stage">Stage クラス<a class="headerlink" href="#stage" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Stage.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">[][]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createEmptyGrid</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">createEmptyGrid</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">[][]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="kt">this.config.rows</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">      </span><span class="nb">Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージの背景を描画</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#f0f0f0&#39;</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span>
<span class="w">      </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// グリッド線を描画</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">strokeStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#ddd&#39;</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">lineWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">)</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="player">Player クラス<a class="headerlink" href="#player" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Player.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 今は何も描画しない。後のイテレーションでぷよを描画する</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="score">Score クラス<a class="headerlink" href="#score" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Score.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">currentScore</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// スコアを描画</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#333&#39;</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;20px Arial&#39;</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">textAlign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;left&#39;</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="sb">`Score: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">currentScore</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">25</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getScore</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">currentScore</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">addScore</span><span class="p">(</span><span class="nx">points</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">currentScore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">points</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">reset</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">currentScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="apptsx">App.tsx にゲームを組み込む<a class="headerlink" href="#apptsx" title="Permanent link">&para;</a></h3>
<p><code>src/renderer/src/App.tsx</code> を更新して、GameCanvas コンポーネントを表示します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./components/GameCanvas&#39;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;App&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Electron</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">TypeScript</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">GameCanvas</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">App</span>
</code></pre></div>
<h3 id="_27">テストと動作確認<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、グリッド線が描画されたゲーム画面が表示されれば成功です！</p>
<h3 id="todo_1">TODOリストの完了<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>☑ Gameクラスを作成する
☑ ゲームループを実装する
☑ GameCanvasコンポーネントを作成する
☑ Canvasにゲーム画面を描画する
☑ ゲーム状態を初期化する
☑ Config, PuyoImage, Stage, Player, Score クラスを作成する
</code></pre></div>
<p>全てのタスクが完了しました！</p>
<h3 id="_28">コミット<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム開始機能の実装</span>

<span class="s1">- Gameクラスの作成とゲームループの実装</span>
<span class="s1">- GameCanvasコンポーネントの作成</span>
<span class="s1">- Config, PuyoImage, Stage, Player, Scoreクラスの実装</span>
<span class="s1">- テストの追加&#39;</span>
</code></pre></div>
<h3 id="1_1">イテレーション1のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、テスト駆動開発の基本的な流れを実践しながら、ゲームの基盤を作りました：</p>
<p><strong>実装した機能：</strong>
- ✅ ゲームクラスの初期化
- ✅ ゲームループ（requestAnimationFrame）
- ✅ React コンポーネントとの統合
- ✅ Canvas への描画
- ✅ 基本クラスの作成（Config, Stage, Player, Score, PuyoImage）</p>
<p><strong>学んだこと：</strong>
1. <strong>TODOリストの作成</strong>: 大きな機能を小さなタスクに分割
2. <strong>Red-Green-Refactor サイクル</strong>: まずテスト、次に実装、そしてリファクタリング
3. <strong>React と Canvas の統合</strong>: useRef と useEffect を使った Canvas 管理
4. <strong>依存性注入</strong>: Game クラスへの依存オブジェクトの注入
5. <strong>モック</strong>: テストでの依存オブジェクトのモック化</p>
<p><strong>次のイテレーションへ：</strong></p>
<p>次のイテレーション2では、「ぷよの移動」を実装します。キーボード入力を受け取り、落下中のぷよを左右に移動できるようにします。</p>
<blockquote>
<p>テスト駆動開発のリズムができてきましたか？小さなステップで進むことで、不安が減り、自信が増していくことを感じてください。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>前回のイテレーションでゲームの基本的な構造ができました。「ゲームが始まったけど、ぷよが動かないと面白くないよね？」そう思いませんか？このイテレーションでは、ぷよを左右に移動できるようにしていきましょう！</p>
<h3 id="_29">ユーザーストーリー<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>プレイヤーとして、落ちてくるぷよを左右に移動できる
</code></pre></div>
<p>「ぷよぷよって、落ちてくるぷよを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「左右の移動」を実装していきます。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。</p>
<div class="highlight"><pre><span></span><code>☐ Puyoクラスを作成する（ぷよの状態管理）
☐ ぷよペアを生成する機能を実装する
☐ キーボード入力を検出する機能を実装する
☐ ぷよを左右に移動する機能を実装する
☐ 移動可能かチェックする機能を実装する
☐ ぷよをCanvas に描画する機能を実装する
☐ キーボード入力とゲームロジックを統合する
</code></pre></div>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。</p>
<h3 id="puyo">Puyoクラスの作成<a class="headerlink" href="#puyo" title="Permanent link">&para;</a></h3>
<p>まず、ぷよの状態を管理する <code>Puyo</code> クラスを作成します。</p>
<h4 id="red-puyo">Red: Puyoクラスのテスト<a class="headerlink" href="#red-puyo" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Puyo.test.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Puyo&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Puyo&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;初期化&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;位置と色を指定してPuyoを作成できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">5</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="kr">type</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ランダムな色でPuyoを作成できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">.</span><span class="nx">createRandom</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">([</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Blue</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Yellow</span><span class="p">]).</span><span class="nx">toContain</span><span class="p">(</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="kr">type</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;移動&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左に移動できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">5</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右に移動できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">5</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;下に移動できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">moveDown</span><span class="p">()</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">6</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを実行すると失敗します：</p>
<div class="highlight"><pre><span></span><code>❌ Error: Cannot find module &#39;./Puyo&#39;
</code></pre></div>
<h4 id="green-puyo">Green: Puyoクラスの実装<a class="headerlink" href="#green-puyo" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Puyo.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Red</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Green</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Blue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Yellow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">createRandom</span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">Puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Blue</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Yellow</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">randomType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">types</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">randomType</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="o">--</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="o">++</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveDown</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="o">++</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">clone</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">Puyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行すると成功します：</p>
<div class="highlight"><pre><span></span><code>✅ All tests passed!
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ Puyoクラスを作成する（ぷよの状態管理）
☐ ぷよペアを生成する機能を実装する
☐ キーボード入力を検出する機能を実装する
☐ ぷよを左右に移動する機能を実装する
☐ 移動可能かチェックする機能を実装する
☐ ぷよをCanvas に描画する機能を実装する
☐ キーボード入力とゲームロジックを統合する
</code></pre></div>
<h3 id="_30">ぷよペアの生成<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>ぷよぷよでは、2つのぷよがペアで落ちてきます。この「ぷよペア」を管理する機能を実装します。</p>
<h4 id="red_2">Red: ぷよペア生成のテスト<a class="headerlink" href="#red_2" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Player.test.ts</code> にテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="p">,</span><span class="w"> </span><span class="nx">vi</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Puyo&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Player&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockConfig</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockPuyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mockConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cellSize</span><span class="o">:</span><span class="w"> </span><span class="kt">32</span><span class="p">,</span>
<span class="w">      </span><span class="nx">cols</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Config</span>

<span class="w">    </span><span class="nx">mockPuyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">PuyoImage</span>
<span class="w">    </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">mockConfig</span><span class="p">,</span><span class="w"> </span><span class="nx">mockPuyoImage</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよペア生成&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよペアを生成できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyo</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="c1">// 中央に配置</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// 一番上</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyo</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyo</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// メインぷよの上</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ぷよペアはランダムな色で生成される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">([</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Blue</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Yellow</span><span class="p">]).</span><span class="nx">toContain</span><span class="p">(</span>
<span class="w">        </span><span class="nx">mainPuyo</span><span class="o">!</span><span class="p">.</span><span class="kr">type</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">([</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Blue</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Yellow</span><span class="p">]).</span><span class="nx">toContain</span><span class="p">(</span>
<span class="w">        </span><span class="nx">subPuyo</span><span class="o">!</span><span class="p">.</span><span class="kr">type</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="green-player">Green: Player クラスの更新<a class="headerlink" href="#green-player" title="Permanent link">&para;</a></h4>
<p><code>Player.ts</code> を更新します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Puyo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Puyo&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mainPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">subPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">rotation</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// 0: 上, 1: 右, 2: 下, 3: 左</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="nx">createNewPuyoPair</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">.</span><span class="nx">createRandom</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">.</span><span class="nx">createRandom</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 後で実装</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ Puyoクラスを作成する（ぷよの状態管理）
☑ ぷよペアを生成する機能を実装する
☐ キーボード入力を検出する機能を実装する
☐ ぷよを左右に移動する機能を実装する
☐ 移動可能かチェックする機能を実装する
☐ ぷよをCanvas に描画する機能を実装する
☐ キーボード入力とゲームロジックを統合する
</code></pre></div>
<h3 id="_31">キーボード入力の検出<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>React + Electron 環境でキーボード入力を処理するために、カスタムフックを作成します。</p>
<h4 id="_32">キーボード入力フックの作成<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/hooks/useKeyboard.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">KeyboardState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span>
<span class="w">  </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span>
<span class="w">  </span><span class="nx">up</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span>
<span class="w">  </span><span class="nx">down</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">useKeyboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">keys</span><span class="p">,</span><span class="w"> </span><span class="nx">setKeys</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">KeyboardState</span><span class="o">&gt;</span><span class="p">({</span>
<span class="w">    </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">up</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">down</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleKeyDown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">KeyboardEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ArrowLeft&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">setKeys</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}))</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ArrowRight&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">setKeys</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}))</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ArrowUp&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">setKeys</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">up</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}))</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ArrowDown&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">setKeys</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">down</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}))</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleKeyUp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">KeyboardEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ArrowLeft&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">setKeys</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">}))</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ArrowRight&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">setKeys</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">}))</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ArrowUp&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">setKeys</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">up</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">}))</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ArrowDown&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">setKeys</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">down</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">}))</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">handleKeyDown</span><span class="p">)</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">handleKeyUp</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">handleKeyDown</span><span class="p">)</span>
<span class="w">      </span><span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">handleKeyUp</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">keys</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ Puyoクラスを作成する（ぷよの状態管理）
☑ ぷよペアを生成する機能を実装する
☑ キーボード入力を検出する機能を実装する
☐ ぷよを左右に移動する機能を実装する
☐ 移動可能かチェックする機能を実装する
☐ ぷよをCanvas に描画する機能を実装する
☐ キーボード入力とゲームロジックを統合する
</code></pre></div>
<h3 id="_33">ぷよの移動機能<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<h4 id="red_3">Red: 移動機能のテスト<a class="headerlink" href="#red_3" title="Permanent link">&para;</a></h4>
<p><code>Player.test.ts</code> にテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;移動&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左に移動できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右に移動できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左端では左に移動できない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 左端に移動</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右端では右に移動できない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 右端に移動</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="green_2">Green: 移動機能の実装<a class="headerlink" href="#green_2" title="Permanent link">&para;</a></h4>
<p><code>Player.ts</code> に移動メソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// 左端チェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">moveRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// 右端チェック</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">moveDown</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">moveDown</span><span class="p">()</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">moveDown</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ Puyoクラスを作成する（ぷよの状態管理）
☑ ぷよペアを生成する機能を実装する
☑ キーボード入力を検出する機能を実装する
☑ ぷよを左右に移動する機能を実装する
☑ 移動可能かチェックする機能を実装する
☐ ぷよをCanvas に描画する機能を実装する
☐ キーボード入力とゲームロジックを統合する
</code></pre></div>
<h3 id="_34">ぷよの描画機能<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<h4 id="puyoimage_1">PuyoImage クラスの更新<a class="headerlink" href="#puyoimage_1" title="Permanent link">&para;</a></h4>
<p><code>PuyoImage.ts</code> を更新して、実際にぷよを描画できるようにします：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Puyo&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">colors</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="nx">PuyoType</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#888&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ff0000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#00ff00&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Blue</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#0000ff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Yellow</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ffff00&#39;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span>
<span class="w">    </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">,</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">,</span>
<span class="w">    </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">colors</span><span class="p">[</span><span class="kr">type</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">colors</span><span class="p">[</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">]</span>

<span class="w">    </span><span class="c1">// 円の中心座標と半径を計算</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">centerX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">centerY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span>

<span class="w">    </span><span class="c1">// ぷよを円形で描画</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">color</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">centerX</span><span class="p">,</span><span class="w"> </span><span class="nx">centerY</span><span class="p">,</span><span class="w"> </span><span class="nx">radius</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 枠線を描画</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">strokeStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">lineWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">centerX</span><span class="p">,</span><span class="w"> </span><span class="nx">centerY</span><span class="p">,</span><span class="w"> </span><span class="nx">radius</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="player_1">Player クラスの描画メソッド更新<a class="headerlink" href="#player_1" title="Permanent link">&para;</a></h4>
<p><code>Player.ts</code> の draw メソッドを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">draw</span><span class="p">(</span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// サブぷよを描画（画面内の場合のみ）</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// メインぷよを描画</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ Puyoクラスを作成する（ぷよの状態管理）
☑ ぷよペアを生成する機能を実装する
☑ キーボード入力を検出する機能を実装する
☑ ぷよを左右に移動する機能を実装する
☑ 移動可能かチェックする機能を実装する
☑ ぷよをCanvas に描画する機能を実装する
☐ キーボード入力とゲームロジックを統合する
</code></pre></div>
<h3 id="_35">キーボード入力とゲームロジックの統合<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<h4 id="gamecanvas_1">GameCanvas コンポーネントの更新<a class="headerlink" href="#gamecanvas_1" title="Permanent link">&para;</a></h4>
<p><code>GameCanvas.tsx</code> を更新して、キーボード入力を処理します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Game&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Score&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useKeyboard</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../hooks/useKeyboard&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvasRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLCanvasElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">Game</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">playerRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">Player</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useKeyboard</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// ゲームの初期化</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvasRef</span><span class="p">.</span><span class="nx">current</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">canvas</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// ゲームの依存オブジェクトを作成</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Canvasのサイズを設定</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>

<span class="w">    </span><span class="c1">// 最初のぷよペアを生成</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Gameインスタンスを作成して開始</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">)</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span>
<span class="w">    </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// クリーンアップ関数</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">game</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="c1">// キーボード入力の処理</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">keys</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">canvas</span>
<span class="w">      </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">canvasRef</span><span class="p">}</span>
<span class="w">      </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span>
<span class="w">        </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2px solid #333&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">margin</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;20px auto&#39;</span>
<span class="w">      </span><span class="p">}}</span>
<span class="w">    </span><span class="p">/&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ Puyoクラスを作成する（ぷよの状態管理）
☑ ぷよペアを生成する機能を実装する
☑ キーボード入力を検出する機能を実装する
☑ ぷよを左右に移動する機能を実装する
☑ 移動可能かチェックする機能を実装する
☑ ぷよをCanvas に描画する機能を実装する
☑ キーボード入力とゲームロジックを統合する
</code></pre></div>
<p>全てのタスクが完了しました！</p>
<h3 id="_36">テストと動作確認<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、色のついた円形のぷよが2つ表示されます。左右の矢印キーを押すと、ぷよペアが左右に移動します！</p>
<h3 id="_37">コミット<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの移動機能の実装</span>

<span class="s1">- Puyoクラスの作成（状態管理）</span>
<span class="s1">- ぷよペアの生成機能</span>
<span class="s1">- キーボード入力フック（useKeyboard）</span>
<span class="s1">- 移動機能とバウンダリチェック</span>
<span class="s1">- ぷよの描画機能</span>
<span class="s1">- GameCanvasコンポーネントへの統合</span>
<span class="s1">- テストの追加&#39;</span>
</code></pre></div>
<h3 id="2_1">イテレーション2のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの移動機能を実装しました：</p>
<p><strong>実装した機能：</strong>
- ✅ Puyoクラスの作成（位置、色、移動メソッド）
- ✅ ぷよペアの生成（メインぷよとサブぷよ）
- ✅ キーボード入力の検出（useKeyboardフック）
- ✅ 左右移動機能（境界チェック付き）
- ✅ ぷよの描画（円形、色付き）
- ✅ React コンポーネントとの統合</p>
<p><strong>学んだこと：</strong>
1. <strong>カスタムフック</strong>: React でキーボード入力を管理する useKeyboard フック
2. <strong>状態管理</strong>: ぷよの位置と色を Puyo クラスで管理
3. <strong>境界チェック</strong>: 画面端での移動制限
4. <strong>Canvas 描画</strong>: arc メソッドを使った円形描画
5. <strong>テスト駆動開発の継続</strong>: 小さなステップで機能を追加</p>
<p><strong>次のイテレーションへ：</strong></p>
<p>次のイテレーション3では、「ぷよの回転」を実装します。キーボードの上キーを押すと、サブぷよがメインぷよの周りを回転できるようにします。</p>
<blockquote>
<p>小さな成功を積み重ねることで、大きなシステムが完成します。一歩一歩、着実に進んでいきましょう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h2 id="3">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_38">ユーザーストーリー<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>プレイヤーとして、落ちてくるぷよを回転できる
</code></pre></div>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、メインぷよを軸にサブぷよの位置関係を変えることです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？</p>
<div class="highlight"><pre><span></span><code>☐ 回転状態を管理する仕組みを実装する
☐ 回転メソッドを実装する（時計回り）
☐ 回転時のサブぷよの位置を計算する
☐ 壁キック処理を実装する
☐ 回転した状態での描画を実装する
☐ キーボード入力と回転処理を統合する
</code></pre></div>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_39">回転状態の管理<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>まず、回転状態を管理する仕組みを実装します。</p>
<h4 id="red_4">Red: 回転状態のテスト<a class="headerlink" href="#red_4" title="Permanent link">&para;</a></h4>
<p><code>Player.test.ts</code> にテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;回転&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;時計回りに回転すると、回転状態が1増える&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getRotation</span><span class="p">()</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getRotation</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">((</span><span class="nx">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;回転状態が3のときに回転すると0に戻る&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 回転状態を3に設定</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getRotation</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// もう一度回転</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getRotation</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;回転すると、サブぷよの位置が変わる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span>

<span class="w">    </span><span class="c1">// 初期状態：サブぷよは上（y = -1）</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 時計回りに回転：サブぷよは右（x = +1）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subPuyoAfter1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyoAfter1</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyoAfter1</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// もう一度回転：サブぷよは下（y = +1）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subPuyoAfter2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyoAfter2</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyoAfter2</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// もう一度回転：サブぷよは左（x = -1）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subPuyoAfter3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyoAfter3</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">subPuyoAfter3</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="green_3">Green: 回転機能の実装<a class="headerlink" href="#green_3" title="Permanent link">&para;</a></h4>
<p><code>Player.ts</code> を更新します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mainPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">subPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">rotation</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// 0: 上, 1: 右, 2: 下, 3: 左</span>

<span class="w">  </span><span class="c1">// 回転状態のオフセット（サブぷよの相対位置）</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">rotationOffsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 0: 上</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 1: 右</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 2: 下</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1">// 3: 左</span>
<span class="w">  </span><span class="p">]</span>

<span class="w">  </span><span class="nx">createNewPuyoPair</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">.</span><span class="nx">createRandom</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">.</span><span class="nx">createRandom</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getRotation</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">rotateClockwise</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// 回転状態を更新（0→1→2→3→0）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>

<span class="w">    </span><span class="c1">// サブぷよの位置を更新</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">updateSubPuyoPosition</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">updateSubPuyoPosition</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rotationOffsets</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">offset</span><span class="p">.</span><span class="nx">x</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">offset</span><span class="p">.</span><span class="nx">y</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のメソッド</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ 回転状態を管理する仕組みを実装する
☑ 回転メソッドを実装する（時計回り）
☑ 回転時のサブぷよの位置を計算する
☐ 壁キック処理を実装する
☐ 回転した状態での描画を実装する
☐ キーボード入力と回転処理を統合する
</code></pre></div>
<h3 id="_40">壁キック処理の実装<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>次に、壁際での回転時に自動的に位置を調整する壁キック処理を実装します。</p>
<h4 id="red_5">Red: 壁キックのテスト<a class="headerlink" href="#red_5" title="Permanent link">&para;</a></h4>
<p><code>Player.test.ts</code> にテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;壁キック&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右端で右回転すると、左にずれて回転する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 右端に配置</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>

<span class="w">    </span><span class="c1">// 時計回りに回転（サブぷよが右に来る）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// メインぷよが左にずれていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// サブぷよが画面内にあることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左端で左回転すると、右にずれて回転する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 左端に配置（回転状態を2：下向きにする）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">    </span><span class="c1">// もう一度回転（サブぷよが左に来る）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// メインぷよが右にずれていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// サブぷよが画面内にあることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="green_4">Green: 壁キック処理の実装<a class="headerlink" href="#green_4" title="Permanent link">&para;</a></h4>
<p><code>Player.ts</code> の <code>rotateClockwise</code> メソッドを更新します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">rotateClockwise</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// 回転状態を更新</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>

<span class="w">  </span><span class="c1">// サブぷよの位置を更新</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">updateSubPuyoPosition</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// 壁キック処理</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">applyWallKick</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="nx">applyWallKick</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// サブぷよが左の壁を超えている場合</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">shift</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">shift</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// サブぷよが右の壁を超えている場合</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">shift</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">shift</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ 回転状態を管理する仕組みを実装する
☑ 回転メソッドを実装する（時計回り）
☑ 回転時のサブぷよの位置を計算する
☑ 壁キック処理を実装する
☐ 回転した状態での描画を実装する
☐ キーボード入力と回転処理を統合する
</code></pre></div>
<h3 id="_41">回転後の移動制限の更新<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>回転状態によって、ぷよペアの形が変わるため、移動制限も更新する必要があります。</p>
<h4 id="_42">移動メソッドの更新<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h4>
<p><code>Player.ts</code> の移動メソッドを更新します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// 両方のぷよが左端でないことを確認</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">moveRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// 両方のぷよが右端でないことを確認</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_43">キーボード入力との統合<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p><code>GameCanvas.tsx</code> を更新して、上キーで回転できるようにします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// キーボード入力の処理</span>
<span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">up</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">keys</span><span class="p">])</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ 回転状態を管理する仕組みを実装する
☑ 回転メソッドを実装する（時計回り）
☑ 回転時のサブぷよの位置を計算する
☑ 壁キック処理を実装する
☑ 回転した状態での描画を実装する
☑ キーボード入力と回転処理を統合する
</code></pre></div>
<p>全てのタスクが完了しました！</p>
<h3 id="_44">テストと動作確認<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、上矢印キーを押すとぷよペアが回転します！壁際でも適切に位置が調整されることを確認してください。</p>
<h3 id="_45">コミット<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの回転機能の実装</span>

<span class="s1">- 回転状態の管理（0-3の4方向）</span>
<span class="s1">- rotateClockwiseメソッドの実装</span>
<span class="s1">- 回転オフセットによるサブぷよ位置計算</span>
<span class="s1">- 壁キック処理（画面端での位置自動調整）</span>
<span class="s1">- 回転を考慮した移動制限の更新</span>
<span class="s1">- キーボード上キーとの統合</span>
<span class="s1">- テストの追加&#39;</span>
</code></pre></div>
<h3 id="3_1">イテレーション3のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの回転機能を実装しました：</p>
<p><strong>実装した機能：</strong>
- ✅ 回転状態の管理（0: 上、1: 右、2: 下、3: 左）
- ✅ rotateClockwise メソッド（時計回り回転）
- ✅ 回転オフセット配列によるサブぷよ位置計算
- ✅ 壁キック処理（画面端での自動位置調整）
- ✅ 回転を考慮した移動制限
- ✅ キーボード上キーとの統合</p>
<p><strong>学んだこと：</strong>
1. <strong>回転状態の管理</strong>: 配列インデックスで4方向の状態を効率的に管理
2. <strong>オフセット計算</strong>: rotationOffsets配列で相対位置を定義
3. <strong>壁キック</strong>: ユーザビリティ向上のための位置自動調整
4. <strong>境界チェック</strong>: メインぷよとサブぷよ両方の範囲チェック
5. <strong>モジュロ演算</strong>: 回転状態の循環（0→1→2→3→0）</p>
<p><strong>次のイテレーションへ：</strong></p>
<p>次のイテレーション4では、「ぷよの自由落下」を実装します。一定時間ごとにぷよが自動的に下に落ちていく機能を追加します。</p>
<blockquote>
<p>小さな機能を確実に実装することで、複雑なゲームシステムが着実に形になっていきます。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h2 id="4">イテレーション4: ぷよの自由落下の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよって自動で落ちていくよね？」そうですね！ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきます。今回は、その「自由落下」機能を実装していきましょう！</p>
<h3 id="_46">ユーザーストーリー<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>システムとして、ぷよを自由落下させることができる
</code></pre></div>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？</p>
<div class="highlight"><pre><span></span><code>☐ 落下タイマーの実装（一定時間ごとに落下処理を実行）
☐ 自動落下処理の実装（ぷよを1マス下に移動）
☐ 落下可能判定の実装（下に移動できるかチェック）
☐ 着地処理の実装（ぷよが着地したときの処理）
☐ Stageクラスにフィールド管理機能を追加
☐ ゲームループにdeltaTime計算を追加
</code></pre></div>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。</p>
<h3 id="stage_1">Stageクラスのフィールド管理<a class="headerlink" href="#stage_1" title="Permanent link">&para;</a></h3>
<p>まず、Stageクラスにぷよを配置・管理する機能を追加します。</p>
<h4 id="red_6">Red: フィールド管理のテスト<a class="headerlink" href="#red_6" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Stage.test.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Puyo&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Stage&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockConfig</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mockConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cellSize</span><span class="o">:</span><span class="w"> </span><span class="kt">32</span><span class="p">,</span>
<span class="w">      </span><span class="nx">cols</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Config</span>

<span class="w">    </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">mockConfig</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;フィールド管理&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;初期状態では全てのセルが空&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">rows</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ぷよを配置できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;指定位置が空かどうか判定できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">7</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>

<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">7</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Blue</span><span class="p">)</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">7</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="green-stage">Green: Stage クラスの更新<a class="headerlink" href="#green-stage" title="Permanent link">&para;</a></h4>
<p><code>Stage.ts</code> を更新します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Puyo&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoType</span><span class="p">[][]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createEmptyGrid</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">createEmptyGrid</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">[][]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="kt">this.config.rows</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">      </span><span class="nb">Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getPuyo</span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setPuyo</span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">type</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージの背景を描画</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#f0f0f0&#39;</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span>
<span class="w">      </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// グリッド線を描画</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">strokeStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#ddd&#39;</span>
<span class="w">    </span><span class="nx">context</span><span class="p">.</span><span class="nx">lineWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">)</span>
<span class="w">      </span><span class="nx">context</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// フィールドのぷよを描画する処理は後で実装</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☐ 落下タイマーの実装（一定時間ごとに落下処理を実行）
☐ 自動落下処理の実装（ぷよを1マス下に移動）
☐ 落下可能判定の実装（下に移動できるかチェック）
☐ 着地処理の実装（ぷよが着地したときの処理）
☑ Stageクラスにフィールド管理機能を追加
☐ ゲームループにdeltaTime計算を追加
</code></pre></div>
<h3 id="_47">落下タイマーの実装<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>次に、一定時間ごとに落下処理を実行する仕組みを実装します。</p>
<h4 id="red_7">Red: 落下タイマーのテスト<a class="headerlink" href="#red_7" title="Permanent link">&para;</a></h4>
<p><code>Player.test.ts</code> にテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;自由落下&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockStage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mockStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">mockConfig</span><span class="p">)</span>
<span class="w">    </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">mockConfig</span><span class="p">,</span><span class="w"> </span><span class="nx">mockPuyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">mockStage</span><span class="p">)</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;一定時間経過すると、ぷよが1マス下に落ちる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span>

<span class="w">    </span><span class="c1">// 1秒分の時間を進める（1000ms）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;落下間隔未満では、ぷよは落ちない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span>

<span class="w">    </span><span class="c1">// 0.5秒分の時間を進める（500ms）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">500</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;下端に達した場合、それ以上落ちない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// メインぷよを一番下に配置</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">getSubPuyo</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mockConfig</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 着地処理が実行されてフィールドに配置される</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getMainPuyo</span><span class="p">()).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toBeNull</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="green_5">Green: 落下タイマーの実装<a class="headerlink" href="#green_5" title="Permanent link">&para;</a></h4>
<p><code>Player.ts</code> を更新します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mainPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">subPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">rotation</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropTimer</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="c1">// 1秒ごとに落下</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">rotationOffsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 0: 上</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 1: 右</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 2: 下</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1">// 3: 左</span>
<span class="w">  </span><span class="p">]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// 落下タイマーを進める</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaTime</span>

<span class="w">    </span><span class="c1">// 落下間隔を超えたら落下処理を実行</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">dropInterval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">()</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// タイマーをリセット</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">applyGravity</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canMoveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">moveDown</span><span class="p">()</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">moveDown</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 着地処理</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">landPuyos</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">canMoveDown</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>

<span class="w">    </span><span class="c1">// 下端チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">||</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// フィールドとの衝突チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">landPuyos</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// ぷよをフィールドに配置</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のメソッド</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ 落下タイマーの実装（一定時間ごとに落下処理を実行）
☑ 自動落下処理の実装（ぷよを1マス下に移動）
☑ 落下可能判定の実装（下に移動できるかチェック）
☑ 着地処理の実装（ぷよが着地したときの処理）
☑ Stageクラスにフィールド管理機能を追加
☐ ゲームループにdeltaTime計算を追加
</code></pre></div>
<h3 id="deltatime">ゲームループにdeltaTime計算を追加<a class="headerlink" href="#deltatime" title="Permanent link">&para;</a></h3>
<p>最後に、Gameクラスのゲームループで経過時間を計算し、Playerの<code>update</code>メソッドに渡します。</p>
<h4 id="game_1">Game クラスの更新<a class="headerlink" href="#game_1" title="Permanent link">&para;</a></h4>
<p><code>Game.ts</code> を更新します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">animationId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">lastTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span><span class="p">,</span>
<span class="w">    </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span>
<span class="w">    </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span><span class="p">,</span>
<span class="w">    </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Canvas context not found&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">score</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">start</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">((</span><span class="nx">time</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">gameLoop</span><span class="p">(</span><span class="nx">time</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">stop</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">gameLoop</span><span class="p">(</span><span class="nx">currentTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 経過時間を計算（ミリ秒）</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">deltaTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span>

<span class="w">    </span><span class="c1">// ゲーム状態を更新</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 描画</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 次のフレームをリクエスト</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">animationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">((</span><span class="nx">time</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">gameLoop</span><span class="p">(</span><span class="nx">time</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// プレイヤーの更新（落下処理を含む）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">draw</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// キャンバスをクリア</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 各オブジェクトを描画</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>TODOリストを更新：</p>
<div class="highlight"><pre><span></span><code>☑ 落下タイマーの実装（一定時間ごとに落下処理を実行）
☑ 自動落下処理の実装（ぷよを1マス下に移動）
☑ 落下可能判定の実装（下に移動できるかチェック）
☑ 着地処理の実装（ぷよが着地したときの処理）
☑ Stageクラスにフィールド管理機能を追加
☑ ゲームループにdeltaTime計算を追加
</code></pre></div>
<p>全てのタスクが完了しました！</p>
<h3 id="gamecanvas_2">GameCanvasコンポーネントの更新<a class="headerlink" href="#gamecanvas_2" title="Permanent link">&para;</a></h3>
<p>Stageインスタンスを作成する際に、Playerに渡す必要があります。<code>GameCanvas.tsx</code>を更新します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvasRef</span><span class="p">.</span><span class="nx">current</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">canvas</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// ゲームの依存オブジェクトを作成</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">)</span><span class="w">  </span><span class="c1">// stageを渡す</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// Canvasのサイズを設定</span>
<span class="w">  </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">  </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>

<span class="w">  </span><span class="c1">// 最初のぷよペアを生成</span>
<span class="w">  </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// Gameインスタンスを作成して開始</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">)</span>
<span class="w">  </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span>
<span class="w">  </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span>
<span class="w">  </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// クリーンアップ関数</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">},</span><span class="w"> </span><span class="p">[])</span>
</code></pre></div>
<h3 id="_48">テストと動作確認<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、ぷよが自動的に落ちていきます！着地すると新しいぷよペアが生成されます。</p>
<h3 id="_49">コミット<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの自由落下機能の実装</span>

<span class="s1">- 落下タイマーの実装（dropTimer, dropInterval）</span>
<span class="s1">- updateメソッドでdeltaTime管理</span>
<span class="s1">- applyGravityメソッドで自動落下処理</span>
<span class="s1">- canMoveDownメソッドで落下可能判定</span>
<span class="s1">- landPuyosメソッドで着地処理</span>
<span class="s1">- StageクラスにPuyoType配列フィールド管理機能追加</span>
<span class="s1">- GameクラスでdeltaTime計算（performance.now）</span>
<span class="s1">- テストの追加&#39;</span>
</code></pre></div>
<h3 id="4_1">イテレーション4のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの自由落下機能を実装しました：</p>
<p><strong>実装した機能：</strong>
- ✅ 落下タイマー（dropTimer, dropInterval）
- ✅ deltaTime による時間管理
- ✅ 自動落下処理（applyGravity）
- ✅ 落下可能判定（canMoveDown）
- ✅ フィールドとの衝突チェック
- ✅ 着地処理とフィールドへの配置
- ✅ Stageクラスのフィールド管理
- ✅ performance.now()によるdeltaTime計算</p>
<p><strong>学んだこと：</strong>
1. <strong>時間ベースの処理</strong>: deltaTimeによるフレームレート非依存の更新
2. <strong>タイマー管理</strong>: 累積時間と間隔による定期処理
3. <strong>衝突判定</strong>: フィールドとの衝突チェック
4. <strong>状態遷移</strong>: 落下→着地→新ぷよ生成のサイクル
5. <strong>performance.now()</strong>: 高精度タイムスタンプの利用</p>
<p><strong>次のイテレーションへ：</strong></p>
<p>次のイテレーション5では、「ぷよの高速落下」を実装します。下キーを押している間、ぷよが通常より速く落ちる機能を追加します。</p>
<blockquote>
<p>時間ベースの処理を正しく実装することで、どんな環境でも一定の速度でゲームが動くようになります。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<hr />
<h2 id="5">イテレーション5: ぷよの高速落下の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「ぷよが自動的に落ちるようになったけど、ぷよぷよってもっと早く落とせたよね？」そうですね！ぷよぷよでは、プレイヤーが下キーを押すことで、ぷよを素早く落下させることができます。今回は、その「高速落下」機能を実装していきましょう！</p>
<h3 id="_50">ユーザーストーリー<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよを素早く落下させることができる</p>
</blockquote>
<p>「早く次のぷよを落としたい！」というときに、下キーを押して素早く落下させる機能は、ゲームのテンポを良くするために重要ですね。</p>
<h3 id="todo_5">TODOリスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ぷよを素早く落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> 下キー入力の検出を実装する（既に useKeyboard フックで実装済み）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 高速落下処理を実装する（下キーが押されているときは落下速度を上げる）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 落下速度取得メソッドを実装する（getDropSpeed）</li>
<li class="task-list-item"><input type="checkbox" disabled/> Player.update メソッドで高速落下を反映する</li>
</ul>
<p>「useKeyboard フックは既に実装済みなんですね！」そうです！イテレーション2で実装した useKeyboard フックが、down キーの状態も管理しているので、それを活用します。</p>
<h3 id="_51">テスト: 高速落下<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、下キーが押されたときに落下速度が上がることと、実際に速く落下することをテストしましょう。</p>
<h4 id="playertestts">Player.test.ts への追加<a class="headerlink" href="#playertestts" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/__tests__/Player.test.ts</code> に高速落下のテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;高速落下&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;下キーが押されていないときは通常速度（1）を返す&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">speed</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;下キーが押されているときは高速（10）を返す&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">speed</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;下キーが押されていると、タイマーが速く進む&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 通常速度で100ms経過</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;dropTimer&#39;</span><span class="p">]</span>

<span class="w">    </span><span class="c1">// 高速落下で100ms経過</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;dropTimer&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// リセット</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fastTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;dropTimer&#39;</span><span class="p">]</span>

<span class="w">    </span><span class="c1">// 高速落下の方がタイマーが速く進むことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fastTimer</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="nx">normalTimer</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fastTimer</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">normalTimer</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>下キーが押されていないときは通常速度（1）を返すか</li>
<li>下キーが押されているときは高速（10）を返すか</li>
<li>下キーが押されているとタイマーが10倍速く進むか</li>
</ol>
<p>「なるほど、速度の倍率をテストしているんですね！」そうです！テストを実行すると、まだ <code>getDropSpeed</code> メソッドが実装されていないので失敗します。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/renderer/src/game/__tests__/Player.test.ts
  ● 高速落下 › 下キーが押されていないときは通常速度（1）を返す

    TypeError: player.getDropSpeed is not a function
</code></pre></div>
<p>「Red（失敗）フェーズですね！」その通りです。では、実装に進みましょう。</p>
<h3 id="_52">実装: 高速落下速度の取得<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>Player クラスに <code>getDropSpeed</code> メソッドを追加します。</p>
<h4 id="playerts">Player.ts の修正<a class="headerlink" href="#playerts" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Player.ts</code> を修正します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mainPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">subPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">rotation</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropTimer</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">dropInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="c1">// 1秒</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * 落下速度を取得する</span>
<span class="cm">   * @param isDownKeyPressed 下キーが押されているか</span>
<span class="cm">   * @returns 落下速度（通常: 1, 高速: 10）</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">getDropSpeed</span><span class="p">(</span><span class="nx">isDownKeyPressed</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">isDownKeyPressed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">10</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">1</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。下キーが押されていれば10倍速、押されていなければ通常速度（1倍速）を返すだけです。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Player.test.ts (12 tests)
   ✓ Player クラス
     ✓ 高速落下
       ✓ 下キーが押されていないときは通常速度（1）を返す
       ✓ 下キーが押されているときは高速（10）を返す
</code></pre></div>
<p>「最初の2つのテストは通りましたね！」そうです。でも、3つ目のテストはまだ失敗しています。update メソッドが下キーの状態を受け取っていないからです。</p>
<h3 id="update">実装: update メソッドへの統合<a class="headerlink" href="#update" title="Permanent link">&para;</a></h3>
<p>update メソッドを修正して、高速落下を反映させます。</p>
<h4 id="playerts-update">Player.ts の update メソッド修正<a class="headerlink" href="#playerts-update" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * ぷよの状態を更新する</span>
<span class="cm"> * @param deltaTime 前フレームからの経過時間（ミリ秒）</span>
<span class="cm"> * @param isDownKeyPressed 下キーが押されているか</span>
<span class="cm"> */</span>
<span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">isDownKeyPressed</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">  </span><span class="c1">// 落下速度を取得</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dropSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">(</span><span class="nx">isDownKeyPressed</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// タイマーを進める（高速落下時は速く進む）</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">dropSpeed</span>

<span class="w">  </span><span class="c1">// 落下間隔に達したら落下処理</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">dropInterval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>deltaTime * dropSpeed</code> で高速落下を実現しているんですね！」その通りです！下キーが押されているとき（dropSpeed = 10）は、タイマーが10倍速く進むので、結果的にぷよが10倍速く落ちることになります。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Player.test.ts (13 tests) 236ms
   ✓ Player クラス
     ✓ 高速落下
       ✓ 下キーが押されていないときは通常速度（1）を返す
       ✓ 下キーが押されているときは高速（10）を返す
       ✓ 下キーが押されていると、タイマーが速く進む

Test Files  3 passed (3)
     Tests  13 passed (13)
</code></pre></div>
<p>「Green（成功）フェーズですね！全てのテストが通りました！」素晴らしいです！</p>
<h3 id="game_2">Game クラスとの統合<a class="headerlink" href="#game_2" title="Permanent link">&para;</a></h3>
<p>Player.update メソッドのシグネチャを変更したので、Game クラスも修正する必要があります。</p>
<h4 id="gamets">Game.ts の修正<a class="headerlink" href="#gamets" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Game.ts</code> の update メソッドを修正します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">lastTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">animationId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">isDownKeyPressed</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * 下キーの状態を設定する</span>
<span class="cm">   * @param isPressed 下キーが押されているか</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">setDownKeyPressed</span><span class="p">(</span><span class="nx">isPressed</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">isDownKeyPressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isPressed</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// プレイヤーの更新（下キーの状態を渡す）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">isDownKeyPressed</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>
<span class="p">}</span>
</code></pre></div>
<p>「Game クラスが下キーの状態を保持するんですね！」そうです。GameCanvas コンポーネントから下キーの状態を受け取り、Player.update に渡します。</p>
<h3 id="gamecanvas_3">GameCanvas コンポーネントとの統合<a class="headerlink" href="#gamecanvas_3" title="Permanent link">&para;</a></h3>
<p>GameCanvas コンポーネントで、キーボードの状態を Game クラスに渡します。</p>
<h4 id="gamecanvastsx">GameCanvas.tsx の修正<a class="headerlink" href="#gamecanvastsx" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/components/GameCanvas.tsx</code> を修正します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Game&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Score&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useKeyboard</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../hooks/useKeyboard&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvasRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">HTMLCanvasElement</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">Game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">playerRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">Player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useKeyboard</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// ゲームの初期化</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvasRef</span><span class="p">.</span><span class="nx">current</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">canvas</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// ゲームの依存オブジェクトを作成</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Canvas のサイズを設定</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>

<span class="w">    </span><span class="c1">// 最初のぷよペアを生成</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Game インスタンスを作成して開始</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">)</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span>
<span class="w">    </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// クリーンアップ関数</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">game</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="c1">// キーボード入力の処理（下キーの状態を Game に伝える）</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setDownKeyPressed</span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">down</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">down</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// キーボード入力の処理（左右、回転）</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">up</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">keys</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">canvas</span><span class="w"> </span><span class="nx">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">canvasRef</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>「useEffect で keys.down を監視して、Game クラスに伝えるんですね！」その通りです！keys.down が変わるたびに、Game クラスの setDownKeyPressed メソッドを呼び出して、下キーの状態を更新します。</p>
<h3 id="_53">テストと動作確認<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、下キー（↓）を押すとぷよが素早く落ちることを確認できます！</p>
<h3 id="_54">コミット<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの高速落下機能の実装</span>

<span class="s1">- getDropSpeedメソッドの追加（通常: 1, 高速: 10）</span>
<span class="s1">- Player.updateメソッドにisDownKeyPressedパラメータ追加</span>
<span class="s1">- Game.setDownKeyPressedメソッドの追加</span>
<span class="s1">- GameCanvasでkeys.downを監視してGameに伝達</span>
<span class="s1">- 高速落下のテスト追加&#39;</span>
</code></pre></div>
<h3 id="5_1">イテレーション5のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの高速落下機能を実装しました：</p>
<p><strong>実装した機能：</strong>
- ✅ getDropSpeed メソッド（下キー検出で10倍速）
- ✅ Player.update への isDownKeyPressed パラメータ追加
- ✅ Game.setDownKeyPressed メソッド
- ✅ GameCanvas での keys.down 監視
- ✅ dropTimer の速度調整（deltaTime * dropSpeed）</p>
<p><strong>学んだこと：</strong>
1. <strong>速度倍率による時間制御</strong>: deltaTime に速度倍率を掛けることで、速度を動的に変更
2. <strong>React hooks との連携</strong>: useKeyboard で取得したキー状態を Game → Player に伝播
3. <strong>状態の伝達</strong>: Component → Game → Player の階層的な状態伝達
4. <strong>useEffect による監視</strong>: keys.down の変更を監視して即座に反映
5. <strong>boolean パラメータ</strong>: 下キーの押下状態を boolean で管理</p>
<p><strong>次のイテレーションへ：</strong></p>
<p>次のイテレーション6では、「ぷよの消去」を実装します。同じ色のぷよが4つ以上つながったときに消去できる、ぷよぷよの醍醐味となる機能を追加します。</p>
<blockquote>
<p>既存のコードを壊さずに新機能を追加することが、テスト駆動開発の真の価値です。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<hr />
<h2 id="6">イテレーション6: ぷよの消去の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを4つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_55">ユーザーストーリー<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを4つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。これを実装することで、ゲームとしての面白さが大きく向上しますね。</p>
<h3 id="todo_6">TODOリスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 4つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 消去後の落下処理を実装する（消去された後の空きスペースにぷよが落ちてくる）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームループとの統合（消去判定と処理をゲームフローに組み込む）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_56">テスト: ぷよの接続判定<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが4つ以上つながっているかどうかを判定する機能が必要です。</p>
<h4 id="eraseinfo">EraseInfo 型の定義<a class="headerlink" href="#eraseinfo" title="Permanent link">&para;</a></h4>
<p>まず、消去情報を表す型を定義します。<code>src/renderer/src/game/Stage.ts</code> に追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">EraseInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">erasePuyoCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">    </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span>
<span class="w">  </span><span class="p">}[]</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="stagetestts">Stage.test.ts への追加<a class="headerlink" href="#stagetestts" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/__tests__/Stage.test.ts</code> に接続判定のテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="p">,</span><span class="w"> </span><span class="nx">EraseInfo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Puyo&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Stage クラス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの接続判定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;同じ色のぷよが4つつながっていると、消去対象になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ステージにぷよを配置（Redは赤ぷよ）</span>
<span class="w">      </span><span class="c1">// 2×2の正方形に赤ぷよを配置</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// ...</span>
<span class="w">      </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 1 1 0 0 0</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>

<span class="w">      </span><span class="c1">// 4つのぷよが消去対象になっていることを確認</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;異なる色のぷよは消去対象にならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ステージにぷよを配置（Red=赤, Green=緑）</span>
<span class="w">      </span><span class="c1">// 市松模様に配置</span>
<span class="w">      </span><span class="c1">// 0 1 2 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 2 1 0 0 0</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>

<span class="w">      </span><span class="c1">// 消去対象がないことを確認</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;3つ以下のつながりは消去対象にならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ステージにぷよを配置（Red=赤）</span>
<span class="w">      </span><span class="c1">// 縦に3つだけ配置</span>
<span class="w">      </span><span class="c1">// 0 1 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 1 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 1 0 0 0 0</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>

<span class="w">      </span><span class="c1">// 消去対象がないことを確認</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>同じ色のぷよが4つつながっている場合、それらが消去対象になるか</li>
<li>異なる色のぷよが隣接している場合、それらは消去対象にならないか</li>
<li>同じ色のぷよが3つ以下の場合、消去対象にならないか</li>
</ol>
<p>「ステージにぷよを配置しているのはわかりますが、その図はどういう意味ですか？」良い質問ですね！コメントの図は、ステージ上のぷよの配置を視覚的に表現しています。0は空きマス、1は赤ぷよ、2は緑ぷよを表しています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/renderer/src/game/__tests__/Stage.test.ts
  ● Stage クラス › ぷよの接続判定 › 同じ色のぷよが4つつながっていると、消去対象になる

    TypeError: stage.checkErase is not a function
</code></pre></div>
<p>「Red（失敗）フェーズですね！」その通りです。では、実装に進みましょう。</p>
<h3 id="_57">実装: ぷよの接続判定<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよの接続判定を実装していきましょう。</p>
<h4 id="stagets">Stage.ts の修正<a class="headerlink" href="#stagets" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Stage.ts</code> を修正します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Puyo&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">EraseInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">erasePuyoCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">    </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span>
<span class="w">  </span><span class="p">}[]</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoType</span><span class="p">[][]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createEmptyGrid</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">createEmptyGrid</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">[][]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoType</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">grid</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のメソッド（getPuyo, setPuyo, isEmpty）...</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * 消去可能なぷよを検出する</span>
<span class="cm">   * @returns 消去情報</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">checkErase</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">EraseInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="kt">EraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">erasePuyoCount</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// チェック済みフラグ</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">checked</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">checked</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checked</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 全マスをチェック</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ぷよがあり、まだチェックしていない場合</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">checked</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 接続しているぷよを探索</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">connected</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">searchConnectedPuyo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoType</span><span class="p">,</span><span class="w"> </span><span class="nx">checked</span><span class="p">,</span><span class="w"> </span><span class="nx">connected</span><span class="p">)</span>

<span class="w">          </span><span class="c1">// 4つ以上つながっている場合は消去対象</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">connected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">                </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">puyo.x</span><span class="p">,</span>
<span class="w">                </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">puyo.y</span><span class="p">,</span>
<span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">puyoType</span>
<span class="w">              </span><span class="p">})</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">eraseInfo</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * 深さ優先探索で接続しているぷよを探索</span>
<span class="cm">   * @param startX 開始X座標</span>
<span class="cm">   * @param startY 開始Y座標</span>
<span class="cm">   * @param puyoType ぷよの種類</span>
<span class="cm">   * @param checked チェック済みフラグ</span>
<span class="cm">   * @param connected 接続しているぷよのリスト</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">searchConnectedPuyo</span><span class="p">(</span>
<span class="w">    </span><span class="nx">startX</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">startY</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">puyoType</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoType</span><span class="p">,</span>
<span class="w">    </span><span class="nx">checked</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">[][],</span>
<span class="w">    </span><span class="nx">connected</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}[]</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 探索済みにする</span>
<span class="w">    </span><span class="nx">checked</span><span class="p">[</span><span class="nx">startY</span><span class="p">][</span><span class="nx">startX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="nx">connected</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">startX</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">startY</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="c1">// 4方向を探索（右、左、下、上）</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">directions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 右</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 下</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1">// 上</span>
<span class="w">    </span><span class="p">]</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">direction</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">directions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">direction</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">direction</span><span class="p">.</span><span class="nx">dy</span>

<span class="w">      </span><span class="c1">// ボード内かつ同じ色のぷよがあり、まだチェックしていない場合</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">nextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">nextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">nextY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">nextY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">nextX</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">puyoType</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="o">!</span><span class="nx">checked</span><span class="p">[</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">nextX</span><span class="p">]</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 再帰的に探索</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">searchConnectedPuyo</span><span class="p">(</span><span class="nx">nextX</span><span class="p">,</span><span class="w"> </span><span class="nx">nextY</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoType</span><span class="p">,</span><span class="w"> </span><span class="nx">checked</span><span class="p">,</span><span class="w"> </span><span class="nx">connected</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_58">解説: ぷよの接続判定<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>ぷよの接続判定では、以下のことを行っています：</p>
<ol>
<li><strong>ボード上の全マスをスキャン</strong>: 左上から右下まで順番にチェック</li>
<li><strong>接続探索の開始</strong>: まだチェックしていないぷよを見つけたら、そのぷよと同じ色で接続しているぷよを探索</li>
<li><strong>4つ以上で消去対象</strong>: 接続しているぷよが4つ以上ある場合、それらを消去対象として記録</li>
</ol>
<p>接続しているぷよの探索には<strong>深さ優先探索（DFS: Depth-First Search）アルゴリズム</strong>を使用しています。このアルゴリズムでは：</p>
<ul>
<li>あるぷよから始めて、上下左右に隣接する同じ色のぷよを再帰的に探索</li>
<li>探索済みのぷよは <code>checked</code> 配列でマークし、重複カウントを防止</li>
<li>再帰関数 <code>searchConnectedPuyo</code> で実装</li>
</ul>
<p>「再帰的に探索するってどういうことですか？」良い質問ですね！再帰とは、関数が自分自身を呼び出すことです。ぷよの探索では：</p>
<ol>
<li>あるぷよから始める</li>
<li>そのぷよの上下左右を見て、同じ色のぷよがあれば、そのぷよについても同じ探索を行う</li>
<li>これを繰り返すことで、つながっているぷよを全て見つける</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Stage.test.ts (3 tests)
   ✓ Stage クラス
     ✓ ぷよの接続判定
       ✓ 同じ色のぷよが4つつながっていると、消去対象になる
       ✓ 異なる色のぷよは消去対象にならない
       ✓ 3つ以下のつながりは消去対象にならない

Test Files  4 passed (4)
     Tests  16 passed (16)
</code></pre></div>
<p>「Green（成功）フェーズですね！」素晴らしいです！接続判定のテストが全て通りました。</p>
<h3 id="_59">テスト: ぷよの消去と落下<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>次に、ぷよの消去と落下処理をテストします。</p>
<h4 id="stagetestts_1">Stage.test.ts への追加<a class="headerlink" href="#stagetestts_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの消去と落下&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;消去対象のぷよを消去する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 消去実行</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// ぷよが消去されていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;消去後、上にあるぷよが落下する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  (y=8)</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  (y=9)</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0  (y=10)</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0  (y=11)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 落下処理</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">fall</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 上にあったぷよが落下していることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>このテストでは、消去対象のぷよが正しく消去されることと、消去後に上にあるぷよが落下することをテストしています。</p>
<p>テストを実行すると失敗します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/renderer/src/game/__tests__/Stage.test.ts
  ● Stage クラス › ぷよの消去と落下 › 消去対象のぷよを消去する

    TypeError: stage.eraseBoards is not a function
</code></pre></div>
<p>「Red（失敗）フェーズですね！」その通りです。では、実装に進みましょう。</p>
<h3 id="_60">実装: ぷよの消去と落下<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>Stage クラスに <code>eraseBoards</code> と <code>fall</code> メソッドを追加します。</p>
<h4 id="stagets_1">Stage.ts の修正<a class="headerlink" href="#stagets_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * ぷよを消去する</span>
<span class="cm"> * @param eraseInfo 消去対象のぷよ情報</span>
<span class="cm"> */</span>
<span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}[])</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">info</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">info</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">info</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 浮いているぷよを落下させる</span>
<span class="cm"> */</span>
<span class="nx">fall</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 下から上に向かって処理</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 現在のぷよの下が空いている場合、落下させる</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fallY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="nx">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">fallY</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">fallY</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span>
<span class="w">          </span><span class="nx">fallY</span><span class="o">++</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_61">解説: ぷよの消去と落下<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>ぷよの消去と落下処理では、以下のことを行っています：</p>
<ol>
<li><strong>eraseBoards メソッド</strong>: 消去対象のぷよをボード上から削除（Empty にする）</li>
<li><strong>fall メソッド</strong>: 消去後に上にあるぷよを落下させる</li>
</ol>
<p>落下処理のポイント：</p>
<ul>
<li><strong>下から上に向かって処理</strong>: 下の行から順に処理することで、一度の処理で全てのぷよを正しい位置に落とせる</li>
<li><strong>while ループで連続落下</strong>: ぷよの下が空いている限り、連続して落下させる</li>
<li><strong>格子の更新</strong>: 落下先に移動し、元の位置を Empty にする</li>
</ul>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Stage.test.ts (5 tests)
   ✓ Stage クラス
     ✓ ぷよの消去と落下
       ✓ 消去対象のぷよを消去する
       ✓ 消去後、上にあるぷよが落下する

Test Files  4 passed (4)
     Tests  18 passed (18)
</code></pre></div>
<p>「Green（成功）フェーズですね！」素晴らしいです！</p>
<h3 id="_62">実装: ゲームループとの統合<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>ゲームループに消去処理を統合します。Game クラスにゲームモードを追加し、消去判定と処理を組み込みます。</p>
<h4 id="gamets_1">Game.ts の修正<a class="headerlink" href="#gamets_1" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Game.ts</code> を修正します：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">lastTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">animationId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">isDownKeyPressed</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Canvas context not available&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ctx</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のメソッド（start, stop, setDownKeyPressed）...</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// モードに応じた処理</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span>
<span class="w">        </span><span class="k">break</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="c1">// プレイ中の処理（キー入力と自由落下）</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">isDownKeyPressed</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 着地したら重力チェックに移行</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="c1">// 重力を適用</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasFallen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// ぷよが落下した場合、falling モードへ</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 落下するぷよがない場合、消去チェックへ</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="c1">// 落下アニメーション用（一定フレーム待機）</span>
<span class="w">        </span><span class="c1">// 簡略化のため、すぐに checkFall に戻る</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span>
<span class="w">        </span><span class="k">break</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 消去対象がない場合、次のぷよを出す</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="c1">// 消去アニメーション用（一定フレーム待機）</span>
<span class="w">        </span><span class="c1">// 簡略化のため、すぐに checkFall に戻る（消去後の重力適用）</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のメソッド（draw）...</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームの流れがどう変わったんですか？」良い質問ですね！ゲームフローは以下のように拡張されました：</p>
<p><strong>新しいゲームフロー</strong>:
<div class="highlight"><pre><span></span><code>newPuyo → playing → (着地) → checkFall → (重力適用) →
  ├─ 落下した → falling → checkFall
  └─ 落下なし → checkErase →
      ├─ 消去あり → erasing → checkFall（消去後の重力適用）
      └─ 消去なし → newPuyo
</code></pre></div></p>
<p>このフローにより、以下が実現されます：</p>
<ol>
<li><strong>着地後の重力適用</strong>: ぷよが着地したら、まず重力を適用して浮いているぷよを落とす</li>
<li><strong>消去判定</strong>: 重力適用後、落下するぷよがなくなったら消去判定</li>
<li><strong>消去処理</strong>: 4つ以上つながったぷよがあれば消去</li>
<li><strong>消去後の重力適用</strong>: 消去後、再び重力を適用（これが連鎖の基礎になる）</li>
</ol>
<h4 id="playerts_1">Player.ts の修正<a class="headerlink" href="#playerts_1" title="Permanent link">&para;</a></h4>
<p>Player クラスに <code>hasLanded</code> メソッドを追加し、着地判定を行います。</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mainPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">subPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">Puyo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">rotation</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropTimer</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">dropInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="c1">// 1秒</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">landed</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * 着地したかどうかを返す</span>
<span class="cm">   * @returns 着地していれば true</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">hasLanded</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">landed</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * 新しいぷよペアを生成する</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">createNewPuyoPair</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">.</span><span class="nx">createRandom</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="nx">startY</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Puyo</span><span class="p">.</span><span class="nx">createRandom</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="nx">startY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">landed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c1">// 着地フラグをリセット</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">landPuyos</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// フィールドに配置</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 着地フラグを立てる</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">landed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="stagets-applygravity">Stage.ts の修正（applyGravity メソッド追加）<a class="headerlink" href="#stagets-applygravity" title="Permanent link">&para;</a></h4>
<p>Stage クラスに <code>applyGravity</code> メソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * 重力を適用する（1フレームで1マス落下）</span>
<span class="cm"> * @returns 落下したぷよがあれば true</span>
<span class="cm"> */</span>
<span class="nx">applyGravity</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">  </span><span class="c1">// 下から上に向かって処理（1マスずつ落下）</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1マス下に移動</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span>
<span class="w">        </span><span class="nx">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">hasFallen</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_63">テストと動作確認<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、同じ色のぷよを4つ以上つなげると消去されることを確認できます！</p>
<h3 id="_64">コミット<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの消去機能の実装</span>

<span class="s1">- EraseInfo型の定義</span>
<span class="s1">- Stage.checkEraseメソッドの追加（深さ優先探索）</span>
<span class="s1">- searchConnectedPuyoメソッドの追加（再帰的探索）</span>
<span class="s1">- eraseBoardsメソッドの追加（消去処理）</span>
<span class="s1">- fallメソッドの追加（落下処理）</span>
<span class="s1">- applyGravityメソッドの追加（重力適用）</span>
<span class="s1">- GameModeの拡張（checkErase, erasingモード追加）</span>
<span class="s1">- Player.hasLandedメソッドの追加</span>
<span class="s1">- ゲームフローの拡張（消去判定と処理の統合）</span>
<span class="s1">- テストの追加&#39;</span>
</code></pre></div>
<h3 id="6_1">イテレーション6のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの消去機能を実装しました：</p>
<p><strong>実装した機能：</strong>
- ✅ EraseInfo 型の定義（消去情報の表現）
- ✅ checkErase メソッド（4つ以上つながったぷよの検出）
- ✅ searchConnectedPuyo メソッド（深さ優先探索）
- ✅ eraseBoards メソッド（消去処理）
- ✅ fall メソッド（落下処理）
- ✅ applyGravity メソッド（重力適用）
- ✅ ゲームモードの拡張（checkErase, erasing）
- ✅ hasLanded メソッド（着地判定）
- ✅ ゲームフローの拡張（消去サイクル）</p>
<p><strong>学んだこと：</strong>
1. <strong>深さ優先探索（DFS）</strong>: 再帰的なアルゴリズムで接続判定
2. <strong>状態管理</strong>: GameMode による複雑な状態遷移
3. <strong>ゲームフローの設計</strong>: 着地 → 重力 → 消去 → 重力 → 次のぷよ
4. <strong>boolean フラグ</strong>: checked 配列で探索済み管理
5. <strong>再帰関数</strong>: searchConnectedPuyo での再帰的探索</p>
<p><strong>React + Electron 特有の実装：</strong>
- TypeScript の型システムを活用（EraseInfo, GameMode）
- Canvas API での描画との統合
- React コンポーネントのライフサイクルとの統合</p>
<p><strong>次のイテレーションへ：</strong></p>
<p>次のイテレーション7では、「連鎖反応」を実装します。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装します。実は、現在のゲームフローが既に連鎖の基礎を実装しています！</p>
<blockquote>
<p>複雑なアルゴリズムも、小さなステップに分解すれば理解しやすくなります。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<hr />
<h2 id="7">イテレーション7: 連鎖反応の実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装していきましょう！</p>
<h3 id="_65">ユーザーストーリー<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="todo_7">TODOリスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「連鎖反応を実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 連鎖判定を実装する（ぷよが消えた後に新たな消去パターンがあるかを判定する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームループの動作確認（連鎖が自動的に発生するか確認する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 連鎖のテスト追加（連鎖シナリオのテストケースを作成する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。</p>
<h3 id="_66">テスト: 連鎖判定<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、連鎖判定をテストしましょう。ぷよが消えて落下した後に、新たな消去パターンが発生するかどうかを確認する機能が必要です。</p>
<h4 id="stagetestts_2">Stage.test.ts への追加<a class="headerlink" href="#stagetestts_2" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/__tests__/Stage.test.ts</code> に連鎖反応のテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;連鎖反応&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="c1">// 赤ぷよの2×2と、その上に緑ぷよが縦に3つ、さらに緑ぷよが1つ横に</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  (y=7)</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  (y=8)</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  (y=9)</span>
<span class="w">    </span><span class="c1">// 0 1 1 2 0 0  (y=10)</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0  (y=11)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span><span class="w">   </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span><span class="w">   </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span><span class="w">   </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span><span class="w">   </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span><span class="w"> </span><span class="c1">// 緑（横）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">7</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span><span class="w">  </span><span class="c1">// 緑（上）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span><span class="w">  </span><span class="c1">// 緑（上）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span><span class="w">  </span><span class="c1">// 緑（上）</span>

<span class="w">    </span><span class="c1">// 1回目の消去判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 赤ぷよが消去対象になっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 消去実行</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 落下処理</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">fall</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 2回目の消去判定（連鎖）</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chainEraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 連鎖が発生していることを確認（緑ぷよが4つつながっている）</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">chainEraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">chainEraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のシナリオを確認しています：</p>
<ol>
<li><strong>初期配置</strong>: 赤ぷよ4つ（2×2の正方形）と緑ぷよ4つ（縦3つ + 横1つ）を配置</li>
<li><strong>1回目の消去</strong>: 赤ぷよが4つつながっているので消える</li>
<li><strong>落下処理</strong>: 赤ぷよが消えた後、上にあった緑ぷよ3つが落下</li>
<li><strong>2回目の消去（連鎖）</strong>: 落下した緑ぷよ3つと横にあった緑ぷよ1つが合計4つつながり、連鎖が発生</li>
</ol>
<p>「なるほど、連鎖の仕組みがテストで表現されているんですね！」そうです！このテストは、ぷよぷよの連鎖の基本的な仕組みを表現しています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Stage.test.ts (6 tests)
   ✓ Stage クラス
     ✓ 連鎖反応
       ✓ ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する

Test Files  4 passed (4)
     Tests  19 passed (19)
</code></pre></div>
<p>「テストが通りましたね！」そうです。実は、Stage クラスの既存の実装（checkErase, eraseBoards, fall）だけで、連鎖の基本的な動作が実現できているんです。</p>
<h3 id="_67">実装: 連鎖判定<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>「既存のゲームループを見てみると、実は連鎖反応は既に実装されています！」そうなんです。イテレーション6で実装したゲームループの仕組みが、そのまま連鎖反応を実現しているんです。</p>
<p>「え？本当ですか？」はい。ゲームループの実装を見てみましょう：</p>
<h4 id="gamets_2">Game.ts のゲームループ<a class="headerlink" href="#gamets_2" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Game.ts</code> の update メソッドを確認します：</p>
<div class="highlight"><pre><span></span><code><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// モードに応じた処理</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span>
<span class="w">      </span><span class="k">break</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// プレイ中の処理（キー入力と自由落下）</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">isDownKeyPressed</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 着地したら重力チェックに移行</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 重力を適用</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">()</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasFallen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ぷよが落下した場合、falling モードへ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 落下するぷよがない場合、消去チェックへ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 落下アニメーション用（一定フレーム待機）</span>
<span class="w">      </span><span class="c1">// 簡略化のため、すぐに checkFall に戻る</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span>
<span class="w">      </span><span class="k">break</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、次のぷよを出す</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 消去アニメーション用（一定フレーム待機）</span>
<span class="w">      </span><span class="c1">// 簡略化のため、すぐに checkFall に戻る（消去後の重力適用）</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span>
<span class="w">      </span><span class="k">break</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このゲームループの何が連鎖反応を実現しているんですか？」重要なのは、<strong><code>erasing</code> モード後に <code>checkFall</code> に戻る</strong>という点です。連鎖が発生する流れを見てみましょう：</p>
<h3 id="_68">連鎖の流れ<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>連鎖反応は、以下のサイクルで実現されます：</p>
<h4 id="1_2">1回目の消去<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>checkErase → ぷよが消去される → erasing → checkFall
</code></pre></div>
<ol>
<li><code>checkErase</code>: 赤ぷよ4つが消去対象と判定</li>
<li><code>erasing</code>: 赤ぷよを消去</li>
<li><code>checkFall</code>: 消去後の重力チェックへ</li>
</ol>
<h4 id="_69">重力適用<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>checkFall → 上のぷよが落下 → falling → checkFall → 落下完了 → checkErase
</code></pre></div>
<ol>
<li><code>checkFall</code>: 緑ぷよ3つが浮いているので落下</li>
<li><code>falling</code>: 落下アニメーション</li>
<li><code>checkFall</code>: まだ落下中なので繰り返し</li>
<li><code>checkFall</code>: 落下完了したので <code>checkErase</code> へ</li>
</ol>
<h4 id="2_2">2回目の消去（連鎖！）<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>checkErase → 落下後に新しい消去パターン発見 → erasing → checkFall
</code></pre></div>
<ol>
<li><code>checkErase</code>: 緑ぷよ4つが消去対象と判定（連鎖発生！）</li>
<li><code>erasing</code>: 緑ぷよを消去</li>
<li><code>checkFall</code>: 再び重力チェックへ</li>
</ol>
<h4 id="_70">連鎖終了<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>checkFall → 落下なし → checkErase → 消去なし → newPuyo
</code></pre></div>
<ol>
<li><code>checkFall</code>: もう落下するぷよがない</li>
<li><code>checkErase</code>: もう消去対象がない</li>
<li><code>newPuyo</code>: 次のぷよを出す</li>
</ol>
<p>「つまり、<code>erasing → checkFall → checkErase</code> のサイクルが連鎖を作っているんですね！」そのとおりです！このサイクルが、消去対象がなくなるまで繰り返されることで、連鎖反応が実現されています。</p>
<h3 id="_71">ゲームフロー図<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>連鎖反応を含む完全なゲームフローは以下のようになります：</p>
<div class="highlight"><pre><span></span><code>newPuyo → playing → (着地) → checkFall → (重力適用) →
  ├─ 落下した → falling → checkFall （落下完了まで繰り返し）
  └─ 落下なし → checkErase →
      ├─ 消去あり → erasing → checkFall （連鎖のサイクル開始）
      └─ 消去なし → newPuyo （連鎖終了）
</code></pre></div>
<p>「連鎖は <code>erasing → checkFall → checkErase</code> のループで実現されているんですね！」その通りです！各モードが単一責任を持つことで、組み合わせが自然に連鎖を生み出しています。</p>
<h3 id="_72">統合テストの追加<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>Game クラス全体の動作を確認するテストも追加しましょう。</p>
<h4 id="gametestts">Game.test.ts への追加<a class="headerlink" href="#gametestts" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/__tests__/Game.test.ts</code> に統合テストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="p">,</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Game&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Score&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Puyo&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Game クラス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="kt">HTMLCanvasElement</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">game</span><span class="o">:</span><span class="w"> </span><span class="kt">Game</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Canvas要素を作成</span>
<span class="w">    </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">600</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">800</span>

<span class="w">    </span><span class="c1">// 依存オブジェクトを作成</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">)</span>
<span class="w">    </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Gameインスタンスを作成</span>
<span class="w">    </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;連鎖反応&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">7</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>
<span class="w">      </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// checkEraseモードに設定</span>
<span class="w">      </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">GameMode</span>

<span class="w">      </span><span class="c1">// 1回目の消去判定と消去実行</span>
<span class="w">      </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// checkErase → erasing</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;erasing&#39;</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 消去後の重力チェック</span>
<span class="w">      </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// erasing → checkFall</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;checkFall&#39;</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 重力適用（緑ぷよが落下）</span>
<span class="w">      </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// checkFall → falling（落下あり）</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;falling&#39;</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 落下アニメーション</span>
<span class="w">      </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// falling → checkFall</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;checkFall&#39;</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 落下完了まで繰り返し</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxIterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">iterations</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxIterations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span>
<span class="w">        </span><span class="nx">iterations</span><span class="o">++</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// checkEraseモードに到達している</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;checkErase&#39;</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 2回目の消去判定（連鎖）</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chainEraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>

<span class="w">      </span><span class="c1">// 連鎖が発生していることを確認（緑ぷよが4つつながっている）</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">chainEraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">chainEraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「この統合テストでは何を確認しているんですか？」この統合テストでは以下を確認しています：</p>
<ol>
<li><strong>モード遷移の確認</strong>: ゲームが正しくモード遷移することを確認</li>
<li><strong>連鎖の発生</strong>: 1回目の消去 → 落下 → 2回目の消去（連鎖）が発生することを確認</li>
<li><strong>ゲームループ全体の動作</strong>: Game クラス全体が正しく動作することを確認</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Game.test.ts (1 test)
   ✓ Game クラス
     ✓ 連鎖反応
       ✓ ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する

Test Files  5 passed (5)
     Tests  20 passed (20)
</code></pre></div>
<p>「テストが全て通りましたね！」素晴らしいです！既存の実装で連鎖反応が実現できていることが確認できました。</p>
<h3 id="_73">テストと動作確認<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、連鎖が発生することを確認できます！</p>
<h3 id="_74">コミット<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 連鎖反応機能の確認</span>

<span class="s1">- 連鎖反応のテスト追加（Stage.test.ts）</span>
<span class="s1">- 統合テストの追加（Game.test.ts）</span>
<span class="s1">- 連鎖フローの確認と文書化</span>
<span class="s1">- 既存のゲームループで連鎖が実現されていることを確認&#39;</span>
</code></pre></div>
<h3 id="7_1">イテレーション7のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、連鎖反応が既存の実装で実現されていることを確認しました：</p>
<p><strong>確認した内容：</strong>
- ✅ 連鎖反応のテスト追加
- ✅ ゲームループの動作確認
- ✅ モード遷移の確認
- ✅ 統合テストの追加</p>
<p><strong>学んだこと：</strong>
1. <strong>連鎖反応はゲームループの構造から生まれる</strong>:
   - <code>erasing → checkFall → checkErase</code> のサイクルが連鎖を実現
   - 消去対象がなくなるまで自動的に繰り返される</p>
<ol>
<li><strong>テストファースト開発の利点</strong>:</li>
<li>テストを先に書くことで、既存実装の動作を確認できた</li>
<li>
<p>新しいコードを追加せずに、テストだけで機能の動作を検証</p>
</li>
<li>
<p><strong>シンプルな設計の力</strong>:</p>
</li>
<li>複雑な連鎖ロジックを追加せずに、既存の状態遷移だけで実現</li>
<li>
<p>各モードが単一責任を持つことで、組み合わせが自然に連鎖を生む</p>
</li>
<li>
<p><strong>状態遷移による制御</strong>:</p>
</li>
<li>GameMode という型による状態管理</li>
<li>switch 文による明確な状態遷移</li>
<li>各状態での単一責任の処理</li>
</ol>
<p><strong>React + Electron 特有の実装：</strong>
- TypeScript の型システムによる GameMode の明確な定義
- private メソッドのテスト（<code>game['mode']</code>, <code>game['update']</code>）
- Canvas API との統合維持</p>
<p><strong>次のイテレーションへ：</strong></p>
<p>このイテレーションで、ぷよぷよの基本的なゲームループが完成しました。既存の実装が自然に連鎖反応を実現していることを確認できたのは、テスト駆動開発の成果です。</p>
<p>次のイテレーション8では、「全消しボーナス」を実装します。盤面上のぷよをすべて消したときに特別なボーナスを獲得できる機能を追加します。</p>
<blockquote>
<p>シンプルな設計は、複雑な機能を自然に生み出します。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<hr />
<h2 id="8">イテレーション8: 全消しボーナスの実装<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>「連鎖ができるようになったけど、ぷよぷよには全消しボーナスもありますよね？」そうですね！ぷよぷよには、盤面上のぷよをすべて消すと得られる「全消し（ぜんけし）ボーナス」という特別な報酬があります。今回は、その全消しボーナスを実装していきましょう！</p>
<h3 id="_75">ユーザーストーリー<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、盤面上のぷよをすべて消したときに全消しボーナスを獲得できる</p>
</blockquote>
<p>「やった！全部消えた！」という達成感と共に、特別なボーナスポイントを獲得できる機能を実装します。これにより、プレイヤーは全消しを狙った戦略を考えるようになりますね。</p>
<h3 id="todo_8">TODOリスト<a class="headerlink" href="#todo_8" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「全消しボーナスを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 全消し判定を実装する（盤面上のぷよがすべて消えたかどうかを判定する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 全消しボーナスの計算を実装する（全消し時に加算するボーナス点を計算する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームループとの統合（全消し判定をゲームフローに組み込む）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_76">テスト: 全消し判定<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、全消し判定をテストしましょう。盤面上のぷよがすべて消えたかどうかを判定する機能が必要です。</p>
<h4 id="stagetestts_3">Stage.test.ts への追加<a class="headerlink" href="#stagetestts_3" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/__tests__/Stage.test.ts</code> に全消し判定のテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;全消し判定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;盤面上のぷよがすべて消えると全消しになる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 全消し判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkZenkeshi</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 全消しになっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">isZenkeshi</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;盤面上にぷよが残っていると全消しにならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span><span class="w"> </span><span class="c1">// 消えないぷよ</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 全消し判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkZenkeshi</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 全消しになっていないことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">isZenkeshi</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>盤面上のぷよがすべて消えた場合、全消しと判定されるか</li>
<li>盤面上にぷよが残っている場合、全消しと判定されないか</li>
</ol>
<p>「最初のテストでは、2×2の正方形に赤ぷよを配置して、それらが消えた後に全消しになるんですね？」そうです！最初のテストでは、2×2の正方形に赤ぷよを配置し、それらが消去された後に盤面が空になるので、全消しと判定されるはずです。</p>
<p>「2つ目のテストでは、消えないぷよが残るようにしているんですね？」その通りです！2つ目のテストでは、2×2の正方形に赤ぷよを配置した上で、別の場所に緑ぷよを1つ配置しています。赤ぷよは消えますが、緑ぷよは消えないので、全消しにはならないはずです。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/renderer/src/game/__tests__/Stage.test.ts
  ● Stage クラス › 全消し判定 › 盤面上のぷよがすべて消えると全消しになる

    TypeError: stage.checkZenkeshi is not a function
</code></pre></div>
<p>「Red（失敗）フェーズですね！」その通りです。では、実装に進みましょう。</p>
<h3 id="_77">実装: 全消し判定<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、全消し判定を実装していきましょう。</p>
<h4 id="stagets_2">Stage.ts の修正<a class="headerlink" href="#stagets_2" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Stage.ts</code> に <code>checkZenkeshi</code> メソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * 全消し判定</span>
<span class="cm"> * @returns 盤面上のぷよがすべて消えていれば true</span>
<span class="cm"> */</span>
<span class="nx">checkZenkeshi</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 盤面上にぷよがあるかチェック</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。全消し判定の実装自体はとてもシンプルです。盤面上のすべてのマスを順番にチェックし、ぷよがある（Empty でない）マスが見つかった時点で <code>false</code> を返します。すべてのマスをチェックして、ぷよが見つからなければ <code>true</code> を返します。</p>
<p>「二重ループを使って、すべてのマスをチェックしているんですね！」その通りです！外側のループで行（y座標）を、内側のループで列（x座標）を順番にチェックしています。これにより、盤面上のすべてのマスを効率的にチェックできます。</p>
<h3 id="_78">解説: 全消し判定<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>全消し判定では、以下のことを行っています：</p>
<ol>
<li><strong>盤面上のすべてのマスをチェック</strong>: 二重ループで全グリッドをスキャン</li>
<li><strong>ぷよがあるかチェック</strong>: Empty でないマスがあれば全消しではない</li>
<li><strong>すべて空なら全消し</strong>: すべてのマスが Empty であれば全消し</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Stage.test.ts (8 tests)
   ✓ Stage クラス
     ✓ 全消し判定
       ✓ 盤面上のぷよがすべて消えると全消しになる
       ✓ 盤面上にぷよが残っていると全消しにならない

Test Files  5 passed (5)
     Tests  22 passed (22)
</code></pre></div>
<p>「Green（成功）フェーズですね！」素晴らしいです！全消し判定のテストが全て通りました。</p>
<h3 id="_79">テスト: 全消しボーナス<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p>次に、全消しボーナスの加算機能をテストします。</p>
<h4 id="scoretestts">Score.test.ts の作成<a class="headerlink" href="#scoretestts" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/__tests__/Score.test.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Score&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Config&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Score クラス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;全消しボーナス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;全消しするとボーナスが加算される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 初期スコア確認</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">score</span><span class="p">.</span><span class="nx">getScore</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">initialScore</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 全消しボーナス加算</span>
<span class="w">      </span><span class="nx">score</span><span class="p">.</span><span class="nx">addZenkeshiBonus</span><span class="p">()</span>

<span class="w">      </span><span class="c1">// 全消しボーナスが加算されていることを確認</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">score</span><span class="p">.</span><span class="nx">getScore</span><span class="p">()).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="nx">initialScore</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">score</span><span class="p">.</span><span class="nx">getScore</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">3600</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、全消しボーナスが加算されると、スコアが増加することを確認しています。具体的には：</p>
<ol>
<li>初期スコアが0であることを確認</li>
<li>全消しボーナスを加算</li>
<li>スコアが3600点増加していることを確認</li>
</ol>
<p>テストを実行すると失敗します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/renderer/src/game/__tests__/Score.test.ts
  ● Score クラス › 全消しボーナス › 全消しするとボーナスが加算される

    TypeError: score.getScore is not a function
</code></pre></div>
<p>「Red（失敗）フェーズですね！」その通りです。では、Score クラスを実装しましょう。</p>
<h3 id="score_1">実装: Score クラス<a class="headerlink" href="#score_1" title="Permanent link">&para;</a></h3>
<p>Score クラスを作成します。</p>
<h4 id="scorets">Score.ts の作成<a class="headerlink" href="#scorets" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Score.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * 現在のスコアを取得</span>
<span class="cm">   * @returns スコア</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">getScore</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * 全消しボーナスを加算</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">addZenkeshiBonus</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 全消しボーナス（固定値3600点）</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">zenkeshiBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3600</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">zenkeshiBonus</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * スコアをリセット</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">reset</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="score_2">解説: Score クラス<a class="headerlink" href="#score_2" title="Permanent link">&para;</a></h3>
<p>Score クラスでは、以下のことを行っています：</p>
<ol>
<li><strong>スコア管理</strong>: private プロパティでスコアを保持</li>
<li><strong>全消しボーナス</strong>: 固定値3600点を加算</li>
<li><strong>スコア取得</strong>: getScore メソッドでスコアを取得</li>
<li><strong>リセット機能</strong>: reset メソッドでスコアを0にリセット</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Score.test.ts (1 test)
   ✓ Score クラス
     ✓ 全消しボーナス
       ✓ 全消しするとボーナスが加算される

Test Files  6 passed (6)
     Tests  23 passed (23)
</code></pre></div>
<p>「Green（成功）フェーズですね！」素晴らしいです！</p>
<h3 id="_80">実装: ゲームループとの統合<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p>「全消しボーナスはいつ判定されるんですか？」良い質問ですね！全消しボーナスは、ゲームループの <code>checkErase</code> モードで消去対象がない場合に判定されます。</p>
<h4 id="gamets_3">Game.ts の修正<a class="headerlink" href="#gamets_3" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Game.ts</code> の update メソッドを修正します：</p>
<div class="highlight"><pre><span></span><code><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// モードに応じた処理</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 他のケース ...</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">()</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">)</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、全消し判定</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkZenkeshi</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 全消しボーナスを加算</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="p">.</span><span class="nx">addZenkeshiBonus</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// 次のぷよを出す</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span>

<span class="w">    </span><span class="c1">// ... 他のケース ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど！消去するぷよがなくなったタイミングで全消しチェックをするんですね。」そのとおりです。ゲームの流れは以下のようになります：</p>
<p><strong>全消しボーナスが加算されるフロー</strong>:
<div class="highlight"><pre><span></span><code>1. ぷよが着地 → checkFall
2. 重力適用 → falling → checkFall（繰り返し）
3. 落下なし → checkErase
4. 消去判定：
   - 消去あり → erasing → checkFall（重力再適用）
   - 消去なし → 全消し判定 →
     ├─ 全消し → 全消しボーナス加算 → newPuyo
     └─ 全消しでない → newPuyo
</code></pre></div></p>
<h3 id="_81">統合テストの追加<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>Game クラス全体の動作を確認するテストを追加しましょう。</p>
<h4 id="gametestts_1">Game.test.ts への追加<a class="headerlink" href="#gametestts_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;全消しボーナス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;盤面上のぷよをすべて消すと全消しボーナスが加算される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 初期スコア確認</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">score</span><span class="p">.</span><span class="nx">getScore</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 盤面に4つのぷよを配置（すべて消去される）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// checkEraseモードに設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">GameMode</span>

<span class="w">    </span><span class="c1">// 消去判定と処理</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// checkErase → erasing（消去実行）</span>

<span class="w">    </span><span class="c1">// 消去後の重力チェック</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// erasing → checkFall</span>

<span class="w">    </span><span class="c1">// 重力適用（落下なし）</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// checkFall → checkErase</span>

<span class="w">    </span><span class="c1">// 2回目の消去判定（全消し判定が実行される）</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// checkErase → newPuyo（全消しボーナス加算）</span>

<span class="w">    </span><span class="c1">// スコアが増加していることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">score</span><span class="p">.</span><span class="nx">getScore</span><span class="p">()).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="nx">initialScore</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">score</span><span class="p">.</span><span class="nx">getScore</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">3600</span><span class="p">)</span><span class="w"> </span><span class="c1">// 全消しボーナスのみ</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;盤面上にぷよが残っている場合は全消しボーナスが加算されない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 盤面にぷよを配置（一部だけ消去される）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Green</span><span class="p">)</span><span class="w"> </span><span class="c1">// 消えないぷよ</span>

<span class="w">    </span><span class="c1">// checkEraseモードに設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">GameMode</span>

<span class="w">    </span><span class="c1">// 消去判定と処理</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// checkErase → erasing（赤ぷよ消去）</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// erasing → checkFall</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// checkFall → checkErase</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// checkErase → newPuyo（全消しボーナスなし）</span>

<span class="w">    </span><span class="c1">// スコアが0のまま（全消しボーナスが加算されていない）</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">score</span><span class="p">.</span><span class="nx">getScore</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「この統合テストでは何を確認しているんですか？」この統合テストでは以下を確認しています：</p>
<ol>
<li><strong>全消しケース</strong>: 4つのぷよを消去して全消しになり、3600点のボーナスが加算される</li>
<li><strong>全消しでないケース</strong>: 一部のぷよが残り、全消しボーナスが加算されない</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Game.test.ts (3 tests)
   ✓ Game クラス
     ✓ 全消しボーナス
       ✓ 盤面上のぷよをすべて消すと全消しボーナスが加算される
       ✓ 盤面上にぷよが残っている場合は全消しボーナスが加算されない

Test Files  6 passed (6)
     Tests  25 passed (25)
</code></pre></div>
<p>「テストが全て通りましたね！」素晴らしいです！</p>
<h3 id="_82">テストと動作確認<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、全消しすると3600点のボーナスが加算されることを確認できます！</p>
<h3 id="_83">コミット<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 全消しボーナス機能の実装</span>

<span class="s1">- Stage.checkZenkeshiメソッドの追加（全消し判定）</span>
<span class="s1">- Scoreクラスの作成（スコア管理）</span>
<span class="s1">- Score.addZenkeshiBonusメソッドの追加（3600点）</span>
<span class="s1">- Game.updateメソッドの修正（全消し判定の統合）</span>
<span class="s1">- 全消し判定のテスト追加（Stage.test.ts）</span>
<span class="s1">- スコアボーナスのテスト追加（Score.test.ts）</span>
<span class="s1">- 統合テストの追加（Game.test.ts）&#39;</span>
</code></pre></div>
<h3 id="8_1">イテレーション8のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、全消しボーナス機能を実装しました：</p>
<p><strong>実装した機能：</strong>
- ✅ checkZenkeshi メソッド（全消し判定）
- ✅ Score クラスの作成（スコア管理）
- ✅ addZenkeshiBonus メソッド（3600点加算）
- ✅ ゲームループへの統合（checkErase モードでの判定）
- ✅ 全消しケースと非全消しケースのテスト</p>
<p><strong>学んだこと：</strong>
1. <strong>全消し判定の実装</strong>:
   - 二重ループでフィールド全体をスキャン
   - ぷよが1つでも残っていれば全消しではない
   - シンプルなロジックで確実な判定を実現</p>
<ol>
<li><strong>全消しボーナスの設計</strong>:</li>
<li>固定値（3600点）のボーナスを付与</li>
<li>プレイヤーに特別な達成感を与える仕組み</li>
<li>
<p>戦略的な深みを追加</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong>:</p>
</li>
<li><code>checkErase</code> モードで消去対象がない場合に全消し判定</li>
<li>既存の状態遷移に自然に組み込む</li>
<li>
<p>統合テストでエンドツーエンドの動作を確認</p>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>:</p>
</li>
<li>全消しになるケースとならないケースの両方をテスト</li>
<li>境界条件（空の盤面、1つだけ残る）を確認</li>
<li>実装前にテストで仕様を明確化</li>
<li>統合テストで全体の動作を保証</li>
</ol>
<p><strong>React + Electron 特有の実装：</strong>
- TypeScript の型システムを活用した Score クラス
- PuyoType enum による型安全な判定
- private メソッドのテストによる内部動作の確認</p>
<p><strong>次のイテレーションへ：</strong></p>
<p>このイテレーションで、全消しボーナスという特別な報酬システムが実装できました。プレイヤーは全消しを狙った戦略的なプレイができるようになります。</p>
<p>次のイテレーション9では、「ゲームオーバー」を実装します。ゲームの終了条件と、ゲームオーバー時の演出を追加します。</p>
<blockquote>
<p>テスト駆動開発は、小さな成功の積み重ねです。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<hr />
<h2 id="9">イテレーション9: ゲームオーバーの実装<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>「ゲームが終わる条件も必要ですよね？」そうですね！どんなゲームにも終わりがあります。ぷよぷよでは、新しいぷよを配置できなくなったときにゲームオーバーとなります。今回は、そのゲームオーバー判定と演出を実装していきましょう！</p>
<h3 id="_84">ユーザーストーリー<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。ゲームオーバーになったことを明確に伝え、適切な演出を行うことで、プレイヤーに達成感や次回への意欲を持ってもらうことができます。</p>
<h3 id="todo_9">TODOリスト<a class="headerlink" href="#todo_9" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ゲームオーバーを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームオーバー演出を実装する（ゲームオーバー時に特別な表示や効果を追加する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> GameMode に gameOver を追加する</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_85">テスト: ゲームオーバー判定<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバー判定をテストしましょう。新しいぷよを配置できない状態を検出する機能が必要です。</p>
<h4 id="playertestts_1">Player.test.ts への追加<a class="headerlink" href="#playertestts_1" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/__tests__/Player.test.ts</code> にゲームオーバー判定のテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ゲームオーバー判定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できない場合、ゲームオーバーになる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージの上部にぷよを配置</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">checkGameOver</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できる場合、ゲームオーバーにならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 空のステージで新しいぷよペアを生成</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">checkGameOver</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになっていないことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、新しいぷよを配置できない状態がゲームオーバーと判定されるかを確認しています。具体的には：</p>
<ol>
<li>ステージの上部（新しいぷよが配置される位置）にぷよを配置します</li>
<li>新しいぷよを生成します</li>
<li>ゲームオーバー判定を行い、ゲームオーバーになっていることを確認します</li>
</ol>
<p>「なるほど、新しいぷよの配置位置にすでにぷよがあると、ゲームオーバーになるんですね！」そうです！ぷよぷよでは、新しいぷよを配置する位置（通常はステージの中央上部）にすでにぷよがある場合、これ以上ゲームを続行できないため、ゲームオーバーとなります。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/renderer/src/game/__tests__/Player.test.ts
  ● Player クラス › ゲームオーバー判定 › 新しいぷよを配置できない場合、ゲームオーバーになる

    TypeError: player.checkGameOver is not a function
</code></pre></div>
<p>「Red（失敗）フェーズですね！」その通りです。では、実装に進みましょう。</p>
<h3 id="_86">実装: ゲームオーバー判定<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームオーバー判定を実装していきましょう。</p>
<h4 id="playerts_2">Player.ts の修正<a class="headerlink" href="#playerts_2" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Player.ts</code> に <code>checkGameOver</code> メソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * ゲームオーバー判定</span>
<span class="cm"> * @returns 新しいぷよを配置できない場合 true</span>
<span class="cm"> */</span>
<span class="nx">checkGameOver</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>

<span class="w">  </span><span class="c1">// メインぷよの位置にぷよがあるかチェック</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mainPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mainPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mainPuyoType</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// サブぷよの位置にぷよがあるかチェック</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">subPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">subPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">subPuyoType</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。ゲームオーバー判定の実装自体はとてもシンプルです。<code>createNewPuyoPair()</code> で生成されたメインぷよとサブぷよの位置に、すでにぷよがあるかどうかをチェックしています。</p>
<p>「なぜ <code>!== PuyoType.Empty</code> でチェックしているんですか？」良い質問ですね！<code>stage.getPuyo()</code> は、範囲内の座標には PuyoType（Empty, Red, Green, Blue, Yellow）を返し、範囲外の座標には Empty を返すように実装されています。サブぷよは初期状態で画面外（y = -1）にあるため、範囲外チェックも正しく動作します。</p>
<h3 id="_87">解説: ゲームオーバー判定<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー判定では、以下のことを行っています：</p>
<ol>
<li><strong>メインぷよの配置位置を確認</strong>: 中央上部の位置にぷよがあるかチェック</li>
<li><strong>サブぷよの配置位置を確認</strong>: メインぷよの上（または回転位置）にぷよがあるかチェック</li>
<li><strong>どちらかに衝突</strong>: いずれかの位置にぷよがあれば、ゲームオーバーと判定</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Player.test.ts (15 tests)
   ✓ Player クラス
     ✓ ゲームオーバー判定
       ✓ 新しいぷよを配置できない場合、ゲームオーバーになる
       ✓ 新しいぷよを配置できる場合、ゲームオーバーにならない

Test Files  6 passed (6)
     Tests  27 passed (27)
</code></pre></div>
<p>「Green（成功）フェーズですね！」素晴らしいです！ゲームオーバー判定のテストが全て通りました。</p>
<h3 id="_88">実装: ゲームループへの統合<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h3>
<p>「ゲームオーバー判定はいつ行われるんですか？」良い質問ですね！ゲームオーバー判定は、新しいぷよを生成するタイミングで行われます。</p>
<h4 id="gamemode">GameMode の拡張<a class="headerlink" href="#gamemode" title="Permanent link">&para;</a></h4>
<p>まず、GameMode に <code>gameOver</code> を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;gameOver&#39;</span>
</code></pre></div>
<h4 id="gamets-update">Game.ts の update メソッド修正<a class="headerlink" href="#gamets-update" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/game/Game.ts</code> の update メソッドを修正します：</p>
<div class="highlight"><pre><span></span><code><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// モードに応じた処理</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">      </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">checkGameOver</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;gameOver&#39;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span>

<span class="w">    </span><span class="c1">// ... 他のケース ...</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;gameOver&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// ゲームオーバー演出</span>
<span class="w">      </span><span class="c1">// アニメーションループは継続するが、更新は停止</span>
<span class="w">      </span><span class="k">break</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど！新しいぷよを作った直後にチェックするんですね！」そうです。新しいぷよを配置しようとした時点で、配置位置にすでにぷよがあれば、それ以上ゲームを続けられないと判断します。</p>
<h3 id="_89">実装: ゲームオーバー演出<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー時の演出を React コンポーネントで実装します。</p>
<h4 id="gamecanvastsx_1">GameCanvas.tsx の修正<a class="headerlink" href="#gamecanvastsx_1" title="Permanent link">&para;</a></h4>
<p><code>src/renderer/src/components/GameCanvas.tsx</code> にゲームオーバー表示を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Game&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Score&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useKeyboard</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../hooks/useKeyboard&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvasRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">HTMLCanvasElement</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">Game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">playerRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">Player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useKeyboard</span><span class="p">()</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isGameOver</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsGameOver</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ゲームの初期化</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvasRef</span><span class="p">.</span><span class="nx">current</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">canvas</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// ゲームの依存オブジェクトを作成</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Canvas のサイズを設定</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">cellSize</span>

<span class="w">    </span><span class="c1">// 最初のぷよペアを生成</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyoPair</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Game インスタンスを作成して開始</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">)</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span>
<span class="w">    </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームオーバーチェック用のインターバル</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">checkGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;gameOver&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setIsGameOver</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">checkGameOver</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// クリーンアップ関数</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">game</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
<span class="w">      </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">checkGameOver</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="c1">// キーボード入力の処理（下キーの状態を Game に伝える）</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setDownKeyPressed</span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">down</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">down</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// キーボード入力の処理（左右、回転）</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">up</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">playerRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">rotateClockwise</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">keys</span><span class="p">,</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">position</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;relative&#39;</span><span class="w"> </span><span class="p">}}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">canvas</span><span class="w"> </span><span class="nx">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">canvasRef</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">isGameOver</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">div</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span>
<span class="w">            </span><span class="nx">position</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;50%&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;50%&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">transform</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;translate(-50%, -50%)&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;48px&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">textShadow</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2px 2px 4px rgba(0, 0, 0, 0.8)&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">pointerEvents</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="nx">GAME</span><span class="w"> </span><span class="nx">OVER</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>「React の state でゲームオーバー状態を管理しているんですね！」その通りです！<code>isGameOver</code> という state を使って、ゲームオーバー時の UI を条件付きレンダリングしています。</p>
<h3 id="_90">解説: ゲームオーバー演出<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー演出では、以下のことを行っています：</p>
<ol>
<li><strong>ゲームオーバー検出</strong>: setInterval で定期的に Game の mode をチェック</li>
<li><strong>state の更新</strong>: gameOver モードになったら <code>setIsGameOver(true)</code> を実行</li>
<li><strong>条件付きレンダリング</strong>: isGameOver が true のときに GAME OVER 表示</li>
<li><strong>キー入力の無効化</strong>: isGameOver が true のときはキー入力を無視</li>
<li><strong>オーバーレイ表示</strong>: position: absolute で Canvas の上に表示</li>
</ol>
<p>「<code>pointerEvents: 'none'</code> は何のためですか？」良い質問ですね！これは、GAME OVER のテキストがマウスイベントを妨げないようにするためです。ただし、このゲームではマウスを使わないので、実際には不要かもしれませんが、一般的な Web 開発のベストプラクティスとして含めています。</p>
<h3 id="_91">統合テストの追加<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h3>
<p>Game クラス全体の動作を確認するテストを追加しましょう。</p>
<h4 id="gametestts_2">Game.test.ts への追加<a class="headerlink" href="#gametestts_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ゲームオーバー&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できない場合、ゲームモードがgameOverに変わる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージの上部にぷよを配置</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoType</span><span class="p">.</span><span class="nx">Red</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// newPuyoモードに設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">GameMode</span>

<span class="w">    </span><span class="c1">// ゲームループを実行（新しいぷよ生成とゲームオーバー判定）</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// ゲームモードがgameOverになっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;gameOver&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できる場合、playingモードに移行する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 空のステージで新しいぷよを生成</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">GameMode</span>

<span class="w">    </span><span class="c1">// ゲームループを実行</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// ゲームモードがplayingになっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;playing&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「この統合テストでは何を確認しているんですか？」この統合テストでは以下を確認しています：</p>
<ol>
<li><strong>ゲームオーバーケース</strong>: 配置位置にぷよがある場合、gameOver モードに移行</li>
<li><strong>通常ケース</strong>: 配置位置が空いている場合、playing モードに移行</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> ✓ src/renderer/src/game/__tests__/Game.test.ts (5 tests)
   ✓ Game クラス
     ✓ ゲームオーバー
       ✓ 新しいぷよを配置できない場合、ゲームモードがgameOverに変わる
       ✓ 新しいぷよを配置できる場合、playingモードに移行する

Test Files  6 passed (6)
     Tests  29 passed (29)
</code></pre></div>
<p>「テストが全て通りましたね！」素晴らしいです！</p>
<h3 id="_92">テストと動作確認<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h3>
<p>全てのテストが通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>開発サーバーを起動して実際の動作を確認します：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>Electron ウィンドウが開き、ぷよが画面上部まで積み上がるとゲームオーバーになることを確認できます！</p>
<h3 id="_93">コミット<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームオーバー機能の実装</span>

<span class="s1">- Player.checkGameOverメソッドの追加（配置判定）</span>
<span class="s1">- GameModeにgameOverを追加</span>
<span class="s1">- Game.updateメソッドの修正（newPuyoでのゲームオーバー判定）</span>
<span class="s1">- GameCanvasコンポーネントの修正（ゲームオーバー表示）</span>
<span class="s1">- isGameOver stateでUI制御</span>
<span class="s1">- ゲームオーバー時のキー入力無効化</span>
<span class="s1">- ゲームオーバー判定のテスト追加（Player.test.ts）</span>
<span class="s1">- 統合テストの追加（Game.test.ts）&#39;</span>
</code></pre></div>
<h3 id="9_1">イテレーション9のまとめ<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ゲームオーバー機能を実装しました：</p>
<p><strong>実装した機能：</strong>
- ✅ checkGameOver メソッド（配置可否判定）
- ✅ GameMode に gameOver を追加
- ✅ newPuyo モードでのゲームオーバー判定
- ✅ React state でのゲームオーバー管理
- ✅ 条件付きレンダリングでの GAME OVER 表示
- ✅ ゲームオーバー時のキー入力無効化
- ✅ 包括的なテスト</p>
<p><strong>学んだこと：</strong>
1. <strong>ゲームオーバー判定の実装</strong>:
   - 新しいぷよの配置位置チェック
   - メインぷよとサブぷよの両方を確認
   - シンプルなロジックで確実な判定</p>
<ol>
<li><strong>React との統合</strong>:</li>
<li>useState でゲームオーバー状態を管理</li>
<li>setInterval でゲームモードを監視</li>
<li>
<p>条件付きレンダリングで UI 切り替え</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong>:</p>
</li>
<li>newPuyo モードで新しいぷよ生成後に判定</li>
<li>gameOver モードでゲームループを継続（描画は維持）</li>
<li>
<p>状態遷移の自然な組み込み</p>
</li>
<li>
<p><strong>ユーザー体験の向上</strong>:</p>
</li>
<li>明確なゲームオーバー表示</li>
<li>ゲームオーバー時の操作無効化</li>
<li>オーバーレイによる視認性向上</li>
</ol>
<p><strong>React + Electron 特有の実装：</strong>
- useState によるゲームオーバー状態管理
- setInterval によるゲームモード監視
- 条件付きレンダリング（<code>{isGameOver &amp;&amp; &lt;div&gt;...&lt;/div&gt;}</code>）
- CSS-in-JS によるスタイリング
- React のライフサイクルとの統合</p>
<p><strong>次のステップ：</strong></p>
<p>これでぷよぷよの基本的な機能が完成しました！</p>
<ul>
<li>✅ ぷよの生成と移動</li>
<li>✅ 回転機能</li>
<li>✅ 自由落下と高速落下</li>
<li>✅ ぷよの消去（4つ以上）</li>
<li>✅ 連鎖反応</li>
<li>✅ 全消しボーナス</li>
<li>✅ ゲームオーバー判定</li>
</ul>
<p>プレイ可能なぷよぷよゲームが完成しました！さらに改善するとしたら、以下のような機能を追加できます：</p>
<ul>
<li>スコア計算とスコア表示</li>
<li>連鎖数の表示</li>
<li>次のぷよの表示</li>
<li>リスタート機能</li>
<li>音楽と効果音</li>
<li>ハイスコア記録</li>
</ul>
<blockquote>
<p>完璧なソフトウェアは存在しない。しかし、テストがあれば、継続的に改善できる。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>