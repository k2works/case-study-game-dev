
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 - React Native 版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#-react-native" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 - React Native 版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="-react-native">ぷよぷよから始めるテスト駆動開発入門 - React Native 版<a class="headerlink" href="#-react-native" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、React Native でぷよぷよゲームを作っていきましょう。この記事では、スマートフォンやタブレットで動作するモバイルアプリケーションとしてぷよぷよを実装していきます。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説:テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、React Native の環境で、テスト駆動開発の基本的な流れと考え方を学んでいきます。モバイルアプリケーション開発においても、テスト駆動開発は非常に有効なアプローチです。一緒に学んでいきましょう！</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発では、以下の3つのステップを繰り返すサイクルで開発を進めます：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。これから実装する機能が何をすべきかを明確にします。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では「とにかく動くこと」を優先します。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。このリズムを繰り返していくことで、少しずつ機能を追加し、コードの品質を高めていきましょう。</p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>フレームワーク</strong>: React Native + Expo — クロスプラットフォームでモバイルアプリを開発できる強力なフレームワークです</li>
<li><strong>言語</strong>: TypeScript — 型を追加することで、大規模な開発でもバグを減らしやすくなります</li>
<li><strong>テストフレームワーク</strong>: Jest + React Native Testing Library — React Native アプリのテストに最適化されたツールです</li>
<li><strong>静的コード解析</strong>: ESLint — コードの品質を自動チェック</li>
<li><strong>コードフォーマッタ</strong>: Prettier — コードの見た目を統一</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。</p>
<h2 id="_4">リリース計画<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>今回はユーザーストーリーとユースケース図から以下のイテレーション計画に従ってぷよぷよゲームをリリースします：</p>
<ul>
<li>イテレーション0: 環境の構築</li>
<li>イテレーション1: ゲーム開始の実装</li>
<li>イテレーション2: ぷよの移動の実装</li>
<li>イテレーション3: ぷよの回転の実装</li>
<li>イテレーション4: ぷよの自由落下の実装</li>
<li>イテレーション5: ぷよの高速落下の実装</li>
<li>イテレーション6: ぷよの消去の実装</li>
<li>イテレーション7: 連鎖反応の実装</li>
<li>イテレーション8: 全消しボーナスの実装</li>
<li>イテレーション9: ゲームオーバーの実装</li>
</ul>
<p>では、ぷよぷよゲーム開発スタートです！</p>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>React Native でぷよぷよゲームを作る前に、開発環境をしっかりと準備しましょう。「プログラミングなんてどの言語でやるか決めるぐらいでしょ？」と思うかもしれませんが、家を建てるときにしっかりとした基礎工事が必要なように、開発環境もしっかりとした準備が必要です。</p>
<h3 id="_5">ソフトウェア開発の三種の神器<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本章では開発環境のセットアップとして、これら三種の神器を準備していきます。</p>
<h3 id="_6">前提条件<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>以下のツールがインストールされていることを確認してください：</p>
<ul>
<li>Node.js (v18 以上推奨)</li>
<li>npm または yarn</li>
<li>Git</li>
</ul>
<h3 id="_7">プロジェクトの作成<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>まず、Expo CLI を使って React Native プロジェクトを作成します。Expo は React Native 開発を簡単にしてくれる素晴らしいツールです。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Expo CLI で新しいプロジェクトを作成</span>
npx<span class="w"> </span>create-expo-app<span class="w"> </span>puyo-puyo-tdd<span class="w"> </span>--template<span class="w"> </span>blank-typescript

<span class="c1"># プロジェクトディレクトリに移動</span>
<span class="nb">cd</span><span class="w"> </span>puyo-puyo-tdd
</code></pre></div>
<p>これで TypeScript が設定された Expo プロジェクトが作成されました！</p>
<p>プロジェクト構造を確認してみましょう：</p>
<div class="highlight"><pre><span></span><code>puyo-puyo-tdd/
├── App.tsx                 # アプリのエントリーポイント
├── app.json                # Expo 設定ファイル
├── package.json            # 依存関係管理
├── tsconfig.json           # TypeScript 設定
├── .gitignore             # Git 除外設定
└── assets/                 # 画像などのリソース
</code></pre></div>
<h3 id="git">バージョン管理: Git の初期化<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>プロジェクトが作成されたので、Git でバージョン管理を開始しましょう。Expo CLI が既に <code>.gitignore</code> を作成してくれていますが、Git リポジトリの初期化を行います。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Git リポジトリを初期化（既に初期化されている場合はスキップ）</span>
git<span class="w"> </span>init

<span class="c1"># 初期状態をコミット</span>
git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: React Native プロジェクト初期化&#39;</span>
</code></pre></div>
<h4 id="_8">コミットメッセージの書き方<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>私たちのプロジェクトでは、<a href="https://www.conventionalcommits.org/ja/">Conventional Commits</a>の書式に従ってコミットメッセージを書きます。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
</code></pre></div>
<p>コミットのタイプ：</p>
<ul>
<li><strong>feat</strong>: 新しい機能</li>
<li><strong>fix</strong>: バグ修正</li>
<li><strong>docs</strong>: ドキュメント変更のみ</li>
<li><strong>style</strong>: コードに影響を与えない変更（空白、フォーマットなど）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更</li>
<li><strong>test</strong>: テストの追加や修正</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更</li>
</ul>
<h3 id="jest-react-native-testing-library">テスティング: Jest と React Native Testing Library<a class="headerlink" href="#jest-react-native-testing-library" title="Permanent link">&para;</a></h3>
<p>React Native アプリのテストには Jest と React Native Testing Library を使用します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># テスト関連パッケージをインストール</span>
npm<span class="w"> </span>install<span class="w"> </span>--save-dev<span class="w"> </span>jest<span class="w"> </span>@testing-library/react-native<span class="w"> </span>@testing-library/jest-native
</code></pre></div>
<h4 id="jest">Jest 設定<a class="headerlink" href="#jest" title="Permanent link">&para;</a></h4>
<p><code>package.json</code> に Jest の設定を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;jest&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;preset&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest-expo&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;transformIgnorePatterns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;node_modules/(?!((jest-)?react-native|@react-native(-community)?)|expo(nent)?|@expo(nent)?/.*|@expo-google-fonts/.*|react-navigation|@react-navigation/.*|@unimodules/.*|unimodules|sentry-expo|native-base|react-native-svg)&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;setupFilesAfterEnv&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&lt;rootDir&gt;/jest-setup.ts&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;collectCoverageFrom&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;src/**/*.{ts,tsx}&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;!src/**/*.test.{ts,tsx}&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;!src/**/__tests__/**&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="jest_1">Jest セットアップファイル<a class="headerlink" href="#jest_1" title="Permanent link">&para;</a></h4>
<p><code>jest-setup.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="s1">&#39;@testing-library/jest-native/extend-expect&#39;</span>

<span class="c1">// グローバルなモックやセットアップをここに追加できます</span>
</code></pre></div>
<h4 id="_9">必要なパッケージのインストール<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># jest-expo をインストール（Jest と Expo の統合）</span>
npm<span class="w"> </span>install<span class="w"> </span>--save-dev<span class="w"> </span>jest-expo
</code></pre></div>
<h4 id="_10">サンプルテストの作成<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>テストが動作することを確認するために、簡単なテストを作成しましょう。</p>
<p><code>src/__tests__/sample.test.ts</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;サンプルテスト&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;1 + 1 は 2 である&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;配列に要素が含まれている&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">]</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">array</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> PASS  src/__tests__/sample.test.ts
  サンプルテスト
    ✓ 1 + 1 は 2 である (2 ms)
    ✓ 配列に要素が含まれている (1 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
</code></pre></div>
<p>テストが通りましたね！これでテスト環境が整いました。</p>
<h4 id="_11">コードカバレッジ<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>静的コード解析による品質の確認はできました。では動的なテストに関してはどうでしょうか？<strong>コードカバレッジ</strong> を確認する必要があります。</p>
<blockquote>
<p>コード網羅率（コードもうらりつ、英: Code coverage）コードカバレッジは、ソフトウェアテストで用いられる尺度の1つである。プログラムのソースコードがテストされた割合を意味する。この場合のテストはコードを見ながら行うもので、ホワイトボックステストに分類される。</p>
<p>—  ウィキペディア</p>
</blockquote>
<p>Jest には組み込みのコードカバレッジ機能があり、既に <code>package.json</code> に設定しています。</p>
<p>コードカバレッジを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>test:coverage
</code></pre></div>
<div class="highlight"><pre><span></span><code> PASS  src/__tests__/sample.test.ts
  サンプルテスト
    ✓ 1 + 1 は 2 である (2 ms)
    ✓ 配列に要素が含まれている (1 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total

-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
-------------------|---------|----------|---------|---------|-------------------
All files          |     100 |      100 |     100 |     100 |
 sample.test.ts    |     100 |      100 |     100 |     100 |
-------------------|---------|----------|---------|---------|-------------------
</code></pre></div>
<p>カバレッジレポートでは以下の指標が表示されます：</p>
<ul>
<li><strong>Stmts (Statements)</strong>: 文の網羅率</li>
<li><strong>Branch</strong>: 分岐の網羅率</li>
<li><strong>Funcs (Functions)</strong>: 関数の網羅率</li>
<li><strong>Lines</strong>: 行の網羅率</li>
</ul>
<p>テスト実行後に <code>coverage</code> というフォルダが作成されます。その中の <code>lcov-report/index.html</code> を開くと、視覚的にカバレッジ状況を確認できます。</p>
<p><code>package.json</code> の Jest 設定には、既にカバレッジの除外設定が含まれています：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&quot;collectCoverageFrom&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="s2">&quot;src/**/*.{ts,tsx}&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;!src/**/*.test.{ts,tsx}&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;!src/**/__tests__/**&quot;</span>
<span class="p">]</span>
</code></pre></div>
<p>この設定により、テストファイル自体はカバレッジの対象から除外されます。</p>
<p>コミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: Jest と React Native Testing Library のセットアップ&#39;</span>
</code></pre></div>
<h3 id="eslint">静的コード解析: ESLint<a class="headerlink" href="#eslint" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためにはコードの品質を維持していく必要があります。出来上がったコードに対する品質チェックの方法として <strong>静的コード解析</strong> があります。</p>
<blockquote>
<p>静的コード解析とは、プログラムを実行することなく、ソースコードを解析してバグや脆弱性、コーディング規約違反などを検出する手法です。</p>
<p>— Wikipedia</p>
</blockquote>
<p>コードの品質を保つために ESLint を設定します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ESLint と必要なプラグインをインストール</span>
npm<span class="w"> </span>install<span class="w"> </span>--save-dev<span class="w"> </span>eslint<span class="w"> </span>@typescript-eslint/parser<span class="w"> </span>@typescript-eslint/eslint-plugin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>eslint-plugin-react<span class="w"> </span>eslint-plugin-react-native<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>eslint-config-prettier<span class="w"> </span>eslint-plugin-prettier<span class="w"> </span>eslint-plugin-sonarjs
</code></pre></div>
<h4 id="eslint_1">ESLint 設定ファイル<a class="headerlink" href="#eslint_1" title="Permanent link">&para;</a></h4>
<p><code>.eslintrc.js</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">root</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parser</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;@typescript-eslint/parser&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parserOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ecmaVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">2021</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">ecmaFeatures</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jsx</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">plugins</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;@typescript-eslint&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prettier&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sonarjs&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="k">extends</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;eslint:recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:@typescript-eslint/recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:react/recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:react-native/all&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prettier&#39;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;prettier/prettier&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;react/react-in-jsx-scope&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// React Native では不要</span>
<span class="w">    </span><span class="s1">&#39;react-native/no-inline-styles&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;react-native/no-color-literals&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// 循環的複雑度の制限 - 7を超える場合はエラー</span>
<span class="w">    </span><span class="s1">&#39;complexity&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="p">}],</span>
<span class="w">    </span><span class="c1">// 認知的複雑度の制限 - 4を超える場合はエラー</span>
<span class="w">    </span><span class="s1">&#39;sonarjs/cognitive-complexity&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">],</span>
<span class="w">    </span><span class="c1">// その他の推奨ルール</span>
<span class="w">    </span><span class="s1">&#39;no-console&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">allow</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">}],</span>
<span class="w">    </span><span class="s1">&#39;no-debugger&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;no-var&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prefer-const&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">react</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;detect&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;react-native/react-native&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>.eslintignore</code> も作成：</p>
<div class="highlight"><pre><span></span><code>node_modules/
.expo/
dist/
coverage/
*.config.js
</code></pre></div>
<p><code>package.json</code> にスクリプトを追加：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint:fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx --fix&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ESLint を実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>lint
</code></pre></div>
<h4 id="_12">コード複雑度のチェック<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>ESLint の設定ファイルには、すでに <strong>循環的複雑度</strong> と <strong>認知的複雑度</strong> の制限が含まれています。これらの指標について説明します。</p>
<p><strong>循環的複雑度 (Cyclomatic Complexity)</strong></p>
<blockquote>
<p>循環的複雑度(サイクロマティック複雑度)とは、ソフトウェア測定法の一つであり、コードがどれぐらい複雑であるかをメソッド単位で数値にして表す指標。</p>
</blockquote>
<p>私たちの設定では、循環的複雑度を <strong>7以下</strong> に制限しています。</p>
<table>
<thead>
<tr>
<th>複雑度の範囲</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>1～10</td>
<td>低複雑度：管理しやすく、問題なし。</td>
</tr>
<tr>
<td>11～20</td>
<td>中程度の複雑度：リファクタリングを検討。</td>
</tr>
<tr>
<td>21～50</td>
<td>高複雑度：リファクタリングが強く推奨される。</td>
</tr>
<tr>
<td>51以上</td>
<td>非常に高い複雑度:コードを分割する必要がある。</td>
</tr>
</tbody>
</table>
<p><strong>認知的複雑度 (Cognitive Complexity)</strong></p>
<blockquote>
<p>認知的複雑度（Cognitive Complexity）
プログラムを読む人の認知負荷を測るための指標のこと。コードの構造が「どれだけ頭を使う必要があるか」を定量的に評価する。循環的複雑度とは異なり、制御構造のネストやコードの流れの読みやすさに重点を置いている</p>
</blockquote>
<p>私たちの設定では、認知的複雑度を <strong>4以下</strong> に制限しています。</p>
<table>
<thead>
<tr>
<th>複雑度の範囲</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>0～4</td>
<td>理解が非常に容易：リファクタリング不要。</td>
</tr>
<tr>
<td>5～14</td>
<td>中程度の難易度:改善が必要な場合もある。</td>
</tr>
<tr>
<td>15以上</td>
<td>理解が困難:コードの簡素化を検討するべき。</td>
</tr>
</tbody>
</table>
<p>コード複雑度の制限により、以下の効果が得られます：</p>
<ul>
<li><strong>可読性向上</strong>: 小さなメソッドは理解しやすい</li>
<li><strong>保守性向上</strong>: 変更の影響範囲が限定される</li>
<li><strong>テスト容易性</strong>: 個別機能のテストが簡単</li>
<li><strong>自動品質管理</strong>: 複雑なコードの混入を自動防止</li>
</ul>
<p>このように、ESLintルールを活用することで、継続的にコード品質を保つことができます。</p>
<h4 id="_13">循環参照の検知<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>循環参照を検知できるようにします。</p>
<blockquote>
<p>循環参照（じゅんかんさんしょう）とは、複数の物体または情報が、相互の情報を参照し合ってループを成している状態のこと。循環参照が存在すると、コードの理解が困難になり、保守性が低下します。</p>
<p>— Wikipedia</p>
</blockquote>
<p><strong>dependency-cruiser</strong> を使って循環参照を検知します。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>-D<span class="w"> </span>dependency-cruiser
npx<span class="w"> </span>depcruise<span class="w"> </span>--init
</code></pre></div>
<p>初期化コマンドを実行すると、<code>.dependency-cruiser.cjs</code> という設定ファイルが作成されます。以下のように編集して、循環参照の検知を有効にします。</p>
<p><code>.dependency-cruiser.cjs</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/** @type {import(&#39;dependency-cruiser&#39;).IConfiguration} */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">forbidden</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-circular&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;循環参照を禁止します&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">circular</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-orphans&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;使用されていないファイルを警告します&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">orphan</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">pathNot</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s1">&#39;(^|/)\\.[^/]+\\.(js|cjs|mjs|ts|tsx|json)$&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// ドットファイル</span>
<span class="w">          </span><span class="s1">&#39;\\.d\\.ts$&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 型定義ファイル</span>
<span class="w">          </span><span class="s1">&#39;(^|/)tsconfig\\.json$&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// tsconfig</span>
<span class="w">          </span><span class="s1">&#39;(^|/)(babel|metro)\\.config\\.(js|cjs|mjs|ts|json)$&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 設定ファイル</span>
<span class="w">          </span><span class="s1">&#39;App\\.tsx$&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// エントリーポイント</span>
<span class="w">          </span><span class="s1">&#39;jest-setup\\.ts$&#39;</span><span class="w"> </span><span class="c1">// テストセットアップ</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">doNotFollow</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;node_modules|\\.expo|dist&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">tsPreCompilationDeps</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">tsConfig</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;tsconfig.json&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">enhancedResolveOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">exportsFields</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;exports&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">conditionNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;import&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;require&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">reporterOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">dot</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">collapsePattern</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;node_modules/[^/]+&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">archi</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">collapsePattern</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;^(node_modules|src|assets)/[^/]+&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>循環参照をチェックするには、以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><code>npx<span class="w"> </span>depcruise<span class="w"> </span>src
</code></pre></div>
<p>循環参照が検出された場合は、以下のようなエラーメッセージが表示されます。</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span>error<span class="w"> </span>no-circular:<span class="w"> </span>src/module-a.ts<span class="w"> </span>→<span class="w"> </span>src/module-b.ts<span class="w"> </span>→<span class="w"> </span>src/module-a.ts
</code></pre></div>
<p>このエラーが表示された場合は、モジュールの依存関係を見直し、循環参照を解消する必要があります。</p>
<p><strong>循環参照を解消する一般的な方法：</strong></p>
<ol>
<li><strong>依存性逆転の原則を適用</strong>: インターフェースを導入して依存関係を逆転させる</li>
<li><strong>共通モジュールの抽出</strong>: 両方が依存する部分を別のモジュールに抽出する</li>
<li><strong>レイヤーアーキテクチャの導入</strong>: 明確な依存関係の方向性を定義する</li>
</ol>
<p><code>package.json</code> に循環参照チェックのスクリプトを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint:fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx --fix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;depcruise&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;depcruise src&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>コミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: ESLint セットアップと循環参照検知&#39;</span>
</code></pre></div>
<h3 id="prettier">コードフォーマッタ: Prettier<a class="headerlink" href="#prettier" title="Permanent link">&para;</a></h3>
<p>コードのフォーマットを統一するために Prettier を設定します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Prettier をインストール（既にインストール済みの場合はスキップ）</span>
npm<span class="w"> </span>install<span class="w"> </span>--save-dev<span class="w"> </span>prettier
</code></pre></div>
<p><code>.prettierrc</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;semi&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;singleQuote&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;tabWidth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;trailingComma&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;es5&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;printWidth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;arrowParens&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;always&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p><code>.prettierignore</code> も作成：</p>
<div class="highlight"><pre><span></span><code>node_modules/
.expo/
dist/
coverage/
package-lock.json
</code></pre></div>
<p><code>package.json</code> にスクリプトを追加：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint:fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx --fix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --write .&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format:check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --check .&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>フォーマットを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>format
</code></pre></div>
<p>コミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: Prettier セットアップ&#39;</span>
</code></pre></div>
<h3 id="canvas-react-native-canvas">Canvas ライブラリ: react-native-canvas<a class="headerlink" href="#canvas-react-native-canvas" title="Permanent link">&para;</a></h3>
<p>ぷよぷよゲームを描画するために Canvas を使用します。React Native では <code>react-native-canvas</code> または <code>expo-gl</code> が使えますが、ここでは <code>expo-gl</code> と <code>expo-gl-cpp</code> を使用します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Expo GL をインストール</span>
npx<span class="w"> </span>expo<span class="w"> </span>install<span class="w"> </span>expo-gl
</code></pre></div>
<p>これで Canvas を使った描画ができるようになります。</p>
<p>コミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: expo-gl インストール&#39;</span>
</code></pre></div>
<h3 id="_14">プロジェクト構造の整理<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>開発を進めやすくするために、プロジェクト構造を整理します。</p>
<div class="highlight"><pre><span></span><code>puyo-puyo-tdd/
├── App.tsx
├── app.json
├── package.json
├── tsconfig.json
├── jest-setup.ts
├── .eslintrc.js
├── .prettierrc
├── src/
│   ├── components/          # React コンポーネント
│   │   └── __tests__/      # コンポーネントのテスト
│   ├── game/               # ゲームロジック
│   │   └── __tests__/      # ゲームロジックのテスト
│   └── types/              # TypeScript 型定義
└── assets/
</code></pre></div>
<p><code>src</code> ディレクトリを作成します：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>src/components/__tests__
mkdir<span class="w"> </span>-p<span class="w"> </span>src/game/__tests__
mkdir<span class="w"> </span>-p<span class="w"> </span>src/types
</code></pre></div>
<h3 id="_15">タスクの自動化<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>開発を効率化するために、複数のタスクをまとめて実行できるスクリプトを追加します。</p>
<p><code>package.json</code> に追加のスクリプトを設定：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint:fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx --fix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --write .&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format:check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --check .&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm run lint:fix &amp;&amp; npm run format &amp;&amp; npm run test&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;setup&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm install &amp;&amp; npm run check&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>check</code> スクリプトは、リント、フォーマット、テストをまとめて実行します。開発中は定期的にこれを実行すると良いでしょう。</p>
<p>試しに実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>check
</code></pre></div>
<div class="highlight"><pre><span></span><code>&gt; app@1.0.0 check
&gt; npm run lint:fix &amp;&amp; npm run format &amp;&amp; npm run test

&gt; app@1.0.0 lint:fix
&gt; eslint . --ext .ts,.tsx --fix

&gt; app@1.0.0 format
&gt; prettier --write .

&gt; app@1.0.0 test
&gt; jest

 PASS  src/__tests__/sample.test.ts
  サンプルテスト
    ✓ 1 + 1 は 2 である (2 ms)
    ✓ 配列に要素が含まれている (1 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
</code></pre></div>
<p>全てのチェックが通りました！</p>
<h3 id="_16">最終的なコミット<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>ここまでのセットアップをコミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: プロジェクト構造整理とタスク自動化&#39;</span>
</code></pre></div>
<h3 id="0_1">イテレーション0のまとめ<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、React Native でぷよぷよゲームを開発するための環境を構築しました：</p>
<p><strong>セットアップした内容：</strong>
- ✅ Expo + TypeScript プロジェクト作成
- ✅ Git によるバージョン管理（Conventional Commits 規則）
- ✅ Jest + React Native Testing Library のテスト環境
- ✅ コードカバレッジ測定（Jest 組み込み機能）
- ✅ ESLint による静的コード解析
  - 循環的複雑度チェック（max: 7）
  - 認知的複雑度チェック（max: 4）
- ✅ dependency-cruiser による循環参照検知
- ✅ Prettier によるコードフォーマット
- ✅ expo-gl による Canvas 描画環境
- ✅ プロジェクト構造の整理
- ✅ タスク自動化スクリプト（check, setup）</p>
<p><strong>学んだこと：</strong></p>
<ol>
<li><strong>ソフトウェア開発の三種の神器</strong>:</li>
<li>バージョン管理（Git + Conventional Commits）</li>
<li>テスティング（Jest + コードカバレッジ）</li>
<li>
<p>自動化（npm scripts）</p>
</li>
<li>
<p><strong>React Native 開発環境</strong>:</p>
</li>
<li>Expo による簡単なプロジェクトセットアップ</li>
<li>TypeScript による型安全な開発</li>
<li>
<p>Jest によるユニットテストとカバレッジ測定</p>
</li>
<li>
<p><strong>コード品質の維持</strong>:</p>
</li>
<li>ESLint による静的解析（循環的複雑度・認知的複雑度）</li>
<li>dependency-cruiser による循環参照検知</li>
<li>Prettier による自動フォーマット</li>
<li>
<p>複雑度制限による保守性向上</p>
</li>
<li>
<p><strong>品質管理の効果</strong>:</p>
</li>
<li>可読性向上：小さなメソッドは理解しやすい</li>
<li>保守性向上：変更の影響範囲が限定される</li>
<li>テスト容易性：個別機能のテストが簡単</li>
<li>自動品質管理：複雑なコードの混入を自動防止</li>
</ol>
<p><strong>次のステップ：</strong></p>
<p>これで開発環境が整いました！次のイテレーションでは、実際にゲームの初期化とキャンバス描画を実装していきます。</p>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>準備が整ったので、いよいよゲーム開発を始めましょう！</p>
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>さて、環境構築が完了しました！「いよいよゲームを作り始めるんですね！」はい、ワクワクしますね。このイテレーションでは、ゲームの基盤となる部分を実装していきます。</p>
<h3 id="_17">ユーザーストーリー<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>「ゲームの開始って、具体的に何をするんですか？」良い質問ですね！ゲームの開始では、以下のようなことを行います：</p>
<ul>
<li>ゲームの初期設定（画面サイズ、ぷよのサイズなど）</li>
<li>ゲームループの開始（継続的にゲームの状態を更新し、画面を描画する）</li>
<li>ゲーム画面の表示（React Native の View として表示する）</li>
</ul>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、以下のタスクを実装していきます：</p>
<ul>
<li>✅ Game クラスの作成とテスト</li>
<li>✅ ゲーム初期化機能の実装</li>
<li>✅ ゲームループの実装</li>
<li>✅ React Native コンポーネントの作成</li>
<li>✅ expo-gl による Canvas 描画の統合</li>
</ul>
<p>それでは、テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_18">テスト: ゲームの初期化<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、<code>Game</code>クラスがちゃんと作成できて、初期化できるかどうかをテストしましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><code>src/game/__tests__/Game.test.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@jest/globals&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Game&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Game クラス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">game</span><span class="o">:</span><span class="w"> </span><span class="kt">Game</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;初期化&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ゲームが作成できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;初期化すると、ゲームモードが start になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「このテストは何をしているんですか？」このテストでは、以下のことを確認しています：</p>
<ol>
<li><code>Game</code> クラスのインスタンスが正しく作成できること</li>
<li><code>initialize()</code> メソッドを呼ぶと、ゲームモードが <code>'start'</code> になること</li>
</ol>
<p>「テストを実行するとどうなるんでしょう？」まだ実装していないので、当然テストは失敗するはずです。これがテスト駆動開発の「Red（赤）」の状態です。では、テストが通るように実装していきましょう！</p>
<h3 id="_19">実装: ゲームの初期化<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>「失敗するテストができたので、次は実装ですね！」そうです！テストが通るように、最小限のコードを実装していきましょう。</p>
<p><code>src/game/Game.ts</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Score&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config?</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage?</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage?</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player?</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">score?</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// コンストラクタでは何もしない</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 各コンポーネントの初期化</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームモードを設定</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_20">解説: ゲームの初期化<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>実装したゲームの初期化処理について、少し解説しておきましょう。この処理では、主に以下のことを行っています：</p>
<ol>
<li>各コンポーネント（Config, PuyoImage, Stage, Player, Score）のインスタンスを作成</li>
<li>ゲームモードを'start'に設定</li>
</ol>
<p>これにより、ゲームを開始するための準備が整います。各コンポーネントの役割を理解しておくと、今後の実装がスムーズになりますよ：</p>
<ul>
<li><strong>Config</strong>: ゲームの設定値を管理します（画面サイズ、ぷよの大きさなど）</li>
<li><strong>PuyoImage</strong>: ぷよの画像を管理します（各色のぷよの画像を読み込み、描画する）</li>
<li><strong>Stage</strong>: ゲームのステージ（盤面）を管理します（ぷよの配置状態、消去判定など）</li>
<li><strong>Player</strong>: プレイヤーの入力と操作を管理します（タッチ入力の処理、ぷよの移動など）</li>
<li><strong>Score</strong>: スコアの計算と表示を管理します（連鎖数に応じたスコア計算など）</li>
</ul>
<p>このように、責任を明確に分けることで、コードの保守性が高まります。これはオブジェクト指向設計の基本原則の一つ、「単一責任の原則」に従っています。</p>
<blockquote>
<p>単一責任の原則（SRP）：クラスを変更する理由は1つだけであるべき。</p>
<p>— Robert C. Martin 『Clean Architecture』</p>
</blockquote>
<h3 id="_21">テスト: ゲームループの開始<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>次に、ゲームループを開始するテストを書きます。React Native では <code>requestAnimationFrame</code> は使えないので、代わりにループの仕組みを実装します。</p>
<p><code>src/game/__tests__/Game.test.ts</code> に追加：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ゲームループ&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ゲームループを開始すると、running フラグが true になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ゲームループを停止すると、running フラグが false になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_22">実装: ゲームループの開始<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<p><code>src/game/Game.ts</code> に追加：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">running</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">lastTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">animationFrameId?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config?</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage?</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage?</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player?</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">score?</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// コンストラクタでは何もしない</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 各コンポーネントの初期化</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームモードを設定</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">start</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loop</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">stop</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">deltaTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span>

<span class="w">    </span><span class="c1">// ゲームの更新処理（後のイテレーションで実装）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 次のフレームをリクエスト</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loop</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">_deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームの更新処理（後のイテレーションで実装）</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_23">解説: ゲームループの開始<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>さて、今回実装した「ゲームループ」について少し詳しく解説しましょう。「ゲームループって何？」と思われるかもしれませんね。</p>
<p>ゲームループは、その名の通り、ゲームの状態を更新し、画面を描画するための繰り返し処理なんです。心臓がずっと鼓動を続けるように、このループが継続的に実行されることで、ゲームが生き生きと動き続けるんですよ。</p>
<p>ここで使っている<code>requestAnimationFrame</code>というメソッド、これがとても賢いんです！「どう賢いの？」というと、ブラウザの描画タイミングに合わせて処理を実行してくれるんです。React Native の場合も、内部的には同様の仕組みを使って滑らかなアニメーションを実現しています。</p>
<p>コードを見てみると、以下のような仕組みになっています：</p>
<ol>
<li><strong>deltaTime の計算</strong>: 前回のフレームからの経過時間を計算します。これにより、デバイスのパフォーマンスに関わらず一定の速度でゲームが進行します</li>
<li><strong>update メソッド</strong>: ゲームの状態を更新します（現時点では空ですが、後のイテレーションで実装します）</li>
<li><strong>ループの継続</strong>: <code>requestAnimationFrame</code> で自分自身を呼び出し、ループを継続します</li>
</ol>
<p>また、<code>running</code> フラグを使って、ゲームの開始・停止を制御できるようになっています。これは、ゲームが終了したときやアプリがバックグラウンドに移行したときに重要になります。</p>
<h3 id="_24">依存クラスの実装<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>必要な依存クラス（Config, PuyoImage, Stage, Player, Score）も最小限の実装を作成します。</p>
<p><code>src/game/Config.ts</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ゲームの設定値（後のイテレーションで実装）</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">13</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">puyoSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">32</span>
<span class="p">}</span>
</code></pre></div>
<p><code>src/game/PuyoImage.ts</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">_config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 最小限の実装</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>src/game/Stage.ts</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">_config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span><span class="w"> </span><span class="nx">_puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 最小限の実装</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>src/game/Player.ts</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">_config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span><span class="w"> </span><span class="nx">_stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">,</span><span class="w"> </span><span class="nx">_puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 最小限の実装</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>src/game/Score.ts</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 最小限の実装</span>
<span class="p">}</span>
</code></pre></div>
<p>これらのクラスは現時点では空の実装ですが、後続のイテレーションで徐々に機能を追加していきます。</p>
<h3 id="eslint_2">ESLint 設定の調整<a class="headerlink" href="#eslint_2" title="Permanent link">&para;</a></h3>
<p>未使用の引数に関する ESLint エラーを回避するため、<code>.eslintrc.js</code> の rules に以下を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ... 既存の設定 ...</span>
<span class="w">  </span><span class="s1">&#39;@typescript-eslint/no-unused-vars&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">argsIgnorePattern</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;^_&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">varsIgnorePattern</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;^_&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">],</span>
<span class="p">},</span>
</code></pre></div>
<p>この設定により、<code>_</code> で始まる引数名は未使用でもエラーにならなくなります。</p>
<h3 id="_25">テストの確認<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下の結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code> PASS  src/game/__tests__/Game.test.ts
  Game クラス
    初期化
      ✓ ゲームが作成できる (2 ms)
      ✓ 初期化すると、ゲームモードが start になる (1 ms)
    ゲームループ
      ✓ ゲームループを開始すると、running フラグが true になる (1 ms)
      ✓ ゲームループを停止すると、running フラグが false になる (1 ms)

Test Suites: 1 passed, 1 total
Tests:       4 passed, 4 total
</code></pre></div>
<h3 id="react-native">React Native コンポーネントの作成<a class="headerlink" href="#react-native" title="Permanent link">&para;</a></h3>
<p>次に、ゲームを表示するための React Native コンポーネントを作成します。</p>
<p><code>src/components/GameCanvas.tsx</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Game&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">Game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームインスタンスを作成</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">()</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span>

<span class="w">    </span><span class="c1">// ゲームを初期化して開始</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// クリーンアップ</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">gameArea</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="cm">/* Canvas は次のイテレーションで実装 */</span><span class="p">}</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">gameArea</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">192</span><span class="p">,</span><span class="w"> </span><span class="c1">// 6 * 32</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">416</span><span class="p">,</span><span class="w"> </span><span class="c1">// 13 * 32</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#222&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="apptsx">App.tsx の更新<a class="headerlink" href="#apptsx" title="Permanent link">&para;</a></h3>
<p><code>App.tsx</code> を更新して、GameCanvas コンポーネントを表示します：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StatusBar</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;expo-status-bar&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">,</span><span class="w"> </span><span class="nx">View</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./src/components/GameCanvas&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameCanvas</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">StatusBar</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_26">アプリの実行<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>では、実際に動作する画面を確認しましょう！</p>
<div class="highlight"><pre><span></span><code><span class="c1"># iOS シミュレータで実行</span>
npm<span class="w"> </span>run<span class="w"> </span>ios

<span class="c1"># Android エミュレータで実行</span>
npm<span class="w"> </span>run<span class="w"> </span>android

<span class="c1"># Expo Go アプリで実行</span>
npm<span class="w"> </span>start
</code></pre></div>
<p>黒い背景に灰色のゲームエリアが表示されれば成功です！まだぷよは表示されませんが、ゲームの基盤が整いました。</p>
<p>おめでとうございます！リリースに向けて最初の第一歩を踏み出すことができました。これから機能を追加するごとにどんどん実際のゲームの完成に近づくことが確認できます、楽しみですね。</p>
<blockquote>
<p>トップダウンでもボトムアップでもなく、エンドツーエンドで構築していく</p>
<p>エンドツーエンドで小さな機能を構築し、そこから作業を進めながら問題について学習していく。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<h3 id="_27">コミット<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化とゲームループの実装</span>

<span class="s1">- Game クラスの作成</span>
<span class="s1">- ゲーム初期化機能</span>
<span class="s1">- ゲームループの実装（start/stop）</span>
<span class="s1">- 依存クラスの最小実装（Config, PuyoImage, Stage, Player, Score）</span>
<span class="s1">- GameCanvas コンポーネントの作成</span>
<span class="s1">- App.tsx の更新</span>
<span class="s1">- テストの追加（Game.test.ts）&#39;</span>
</code></pre></div>
<h3 id="1_1">イテレーション1のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<p><strong>実装した機能：</strong>
- ✅ Game クラスの初期化
  - 必要なコンポーネント（Config, PuyoImage, Stage, Player, Score）の作成
  - ゲームモードの設定
- ✅ ゲームループの実装
  - start/stop メソッドによる制御
  - deltaTime を使った時間管理
  - requestAnimationFrame によるループ処理
- ✅ React Native コンポーネント
  - GameCanvas コンポーネントの作成
  - useRef によるゲームインスタンス管理
  - useEffect によるライフサイクル管理
- ✅ テストの作成
  - ゲーム初期化のテスト（2 テスト）
  - ゲームループのテスト（2 テスト）
  - すべてのテストが成功</p>
<p><strong>学んだこと：</strong></p>
<ol>
<li><strong>ゲームループの仕組み</strong>:</li>
<li>requestAnimationFrame による滑らかなアニメーション</li>
<li>deltaTime による時間管理</li>
<li>
<p>running フラグによる開始・停止制御</p>
</li>
<li>
<p><strong>React Native との統合</strong>:</p>
</li>
<li>useRef によるゲームインスタンスの保持</li>
<li>useEffect によるライフサイクル管理</li>
<li>
<p>クリーンアップ関数による適切なリソース解放</p>
</li>
<li>
<p><strong>単一責任の原則</strong>:</p>
</li>
<li>各クラスが明確な責任を持つ</li>
<li>コンポーネント間の疎結合</li>
<li>テストしやすい設計</li>
</ol>
<p><strong>次のステップ：</strong></p>
<p>次のイテレーションでは、expo-gl を使ってキャンバス描画を実装し、ぷよを画面に表示していきます。</p>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さあ、ゲームの基盤が整いました！「次は何をするんですか？」次は、画面にぷよを表示して、タッチ操作で動かせるようにしていきます。ゲームの心臓部分がだんだん動き始めますよ！</p>
<h3 id="_28">ユーザーストーリー<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよをタッチ操作で左右に動かすことができる</p>
</blockquote>
<p>モバイルゲームなので、キーボードではなくタッチ操作でぷよを動かせるようにします。画面をタップすることで、ぷよが左右に移動する機能を実装していきましょう。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、以下のタスクを実装していきます：</p>
<ul>
<li>✅ タッチ入力の検出機能を実装</li>
<li>✅ ぷよの移動機能を実装（境界チェック含む）</li>
<li>✅ expo-gl による Canvas 描画機能を実装</li>
<li>✅ PuyoImage クラスの拡張（描画機能）</li>
<li>✅ Stage クラスの拡張（フィールド管理）</li>
<li>✅ Player クラスの拡張（ぷよの生成と描画）</li>
<li>✅ Game クラスの更新（update と draw メソッド）</li>
</ul>
<p>それでは、テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_29">テスト: タッチ入力の検出<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>「タッチ入力のテストって、どう書くんですか？」良い質問ですね。React Native では、タッチイベントをシミュレートしてテストすることができます。</p>
<p>まず、Player クラスがタッチ入力を受け取れるかテストしましょう。</p>
<p><code>src/game/__tests__/Player.test.ts</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@jest/globals&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../PuyoImage&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Player クラス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの生成&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを生成できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="c1">// 中央に配置</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// 一番上</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoType&#39;</span><span class="p">]).</span><span class="nx">toBeGreaterThanOrEqual</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoType&#39;</span><span class="p">]).</span><span class="nx">toBeLessThan</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4色のぷよ</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの移動&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左に移動できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右に移動できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左端で左に移動しようとしても移動しない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 左端まで移動</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">leftEdgeX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">leftEdgeX</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右端で右に移動しようとしても移動しない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 右端まで移動</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rightEdgeX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">rightEdgeX</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「これらのテストは何を確認しているんですか？」このテストでは、以下のことを確認しています：</p>
<ol>
<li>新しいぷよを生成できること</li>
<li>ぷよが左右に移動できること</li>
<li>画面の端でぷよが画面外に出ないこと（境界チェック）</li>
</ol>
<h3 id="player">実装: Player クラスの拡張<a class="headerlink" href="#player" title="Permanent link">&para;</a></h3>
<p>テストを書いたので、次はテストが通るように実装していきましょう。</p>
<p><code>src/game/Player.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoX</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoY</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoType</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">createNewPuyo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 画面中央にぷよを配置</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="c1">// ランダムな色のぷよを生成（0-3の4色）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 左端でなければ移動</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">--</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 右端でなければ移動</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">update</span><span class="p">(</span><span class="nx">_deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 後のイテレーションで実装</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ぷよを描画</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_30">解説: ぷよの移動と境界チェック<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>「境界チェックって何ですか？」良い質問です！境界チェックは、ぷよが画面の外に出ないようにする処理です。</p>
<p>例えば、<code>moveLeft()</code> メソッドを見てみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">--</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>この処理は、「もし X 座標が 0 より大きい（つまり左端ではない）なら、1 つ左に移動する」という意味です。もし X 座標が 0（左端）の場合は、何もしません。これにより、ぷよが画面の外に出ることを防いでいます。</p>
<p>右方向も同じように、<code>this.puyoX &lt; this.config.stageWidth - 1</code> という条件で、右端でないことを確認してから移動しています。</p>
<h3 id="canvas">テスト: Canvas 描画<a class="headerlink" href="#canvas" title="Permanent link">&para;</a></h3>
<p>次に、Canvas に正しく描画できることをテストしましょう。</p>
<p><code>src/game/__tests__/PuyoImage.test.ts</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@jest/globals&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Config&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;PuyoImage クラス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// モックの Canvas コンテキストを作成</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fillStyle</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fillRect</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">CanvasRenderingContext2D</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;描画&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;指定された位置にぷよを描画できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// 赤</span>

<span class="w">      </span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="p">)</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span>
<span class="w">        </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">,</span>
<span class="w">        </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">,</span>
<span class="w">        </span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">,</span>
<span class="w">        </span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;異なる色のぷよを描画できる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;#ff0000&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#00ff00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#0000ff&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#ffff00&#39;</span><span class="p">]</span>

<span class="w">      </span><span class="nx">colors</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">expectedColor</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="p">)</span>
<span class="w">        </span><span class="nx">expect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">expectedColor</span><span class="p">)</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="puyoimage">実装: PuyoImage クラスの拡張<a class="headerlink" href="#puyoimage" title="Permanent link">&para;</a></h3>
<p>テストが通るように実装しましょう。</p>
<p><code>src/game/PuyoImage.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">colors</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="c1">// ぷよの色を定義（赤、緑、青、黄）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;#ff0000&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#00ff00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#0000ff&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#ffff00&#39;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 色を設定</span>
<span class="w">    </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">colors</span><span class="p">[</span><span class="kr">type</span><span class="p">]</span>

<span class="w">    </span><span class="c1">// ぷよを描画</span>
<span class="w">    </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span>
<span class="w">      </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">,</span>
<span class="w">      </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="stage">実装: Stage クラスの拡張<a class="headerlink" href="#stage" title="Permanent link">&para;</a></h3>
<p>Stage クラスもフィールド管理機能を追加します。</p>
<p><code>src/game/Stage.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">field</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">[][]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>

<span class="w">    </span><span class="c1">// フィールドの初期化（空の状態）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="c1">// -1 は空を表す</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// フィールドに配置されたぷよを描画</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">])</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="game">実装: Game クラスの更新<a class="headerlink" href="#game" title="Permanent link">&para;</a></h3>
<p>Game クラスに update と draw メソッドを実装します。</p>
<p><code>src/game/Game.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Player&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Score&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">running</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">lastTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">animationFrameId?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">drawCallback</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config?</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage?</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage?</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player?</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">score?</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// コンストラクタでは何もしない</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 各コンポーネントの初期化</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// ゲームモードを設定</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 最初のぷよを生成</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">start</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loop</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">stop</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setDrawCallback</span><span class="p">(</span><span class="nx">callback</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">drawCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">callback</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">deltaTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loop</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">draw</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">drawCallback</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// Canvas への描画は drawCallback を通じて行う</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">drawCallback</span><span class="p">((</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 背景をクリア</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#222&#39;</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// ステージを描画</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="o">?</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// プレイヤーのぷよを描画</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="o">?</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_31">テストの確認<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下の結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code> PASS  src/game/__tests__/Player.test.ts
  Player クラス
    ぷよの生成
      ✓ 新しいぷよを生成できる (2 ms)
    ぷよの移動
      ✓ 左に移動できる (1 ms)
      ✓ 右に移動できる (1 ms)
      ✓ 左端で左に移動しようとしても移動しない (1 ms)
      ✓ 右端で右に移動しようとしても移動しない (1 ms)

 PASS  src/game/__tests__/PuyoImage.test.ts
  PuyoImage クラス
    描画
      ✓ 指定された位置にぷよを描画できる (1 ms)
      ✓ 異なる色のぷよを描画できる (1 ms)

Test Suites: 3 passed, 3 total
Tests:       11 passed, 11 total
</code></pre></div>
<h3 id="react-native_1">React Native コンポーネントの更新<a class="headerlink" href="#react-native_1" title="Permanent link">&para;</a></h3>
<p>expo-gl を使って Canvas 描画を統合します。</p>
<p><code>src/components/GameCanvas.tsx</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">,</span><span class="w"> </span><span class="nx">TouchableOpacity</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GLView</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;expo-gl&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Game&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">Game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">glRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">WebGLRenderingContext</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">()</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">glRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">game</span><span class="p">.</span><span class="nx">setDrawCallback</span><span class="p">((</span><span class="nx">drawFn</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">gl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">glRef</span><span class="p">.</span><span class="nx">current</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">gl</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">        </span><span class="c1">// WebGL を Canvas 2D のように使用するためのラッパー</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createCanvas2DContext</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span>
<span class="w">        </span><span class="nx">drawFn</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">CanvasRenderingContext2D</span><span class="p">)</span>
<span class="w">        </span><span class="nx">gl</span><span class="p">.</span><span class="nx">endFrameEXP</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleLeftPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleRightPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">onContextCreate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">gl</span><span class="o">:</span><span class="w"> </span><span class="kt">WebGLRenderingContext</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">glRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gl</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">gl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setDrawCallback</span><span class="p">((</span><span class="nx">drawFn</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createCanvas2DContext</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span>
<span class="w">        </span><span class="nx">drawFn</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">CanvasRenderingContext2D</span><span class="p">)</span>
<span class="w">        </span><span class="nx">gl</span><span class="p">.</span><span class="nx">endFrameEXP</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GLView</span>
<span class="w">        </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">gameArea</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onContextCreate</span><span class="o">=</span><span class="p">{</span><span class="nx">onContextCreate</span><span class="p">}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">controls</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleLeftPress</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">◀</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleRightPress</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">▶</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// WebGL を Canvas 2D のように使うためのヘルパー関数</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">createCanvas2DContext</span><span class="p">(</span><span class="nx">gl</span><span class="o">:</span><span class="w"> </span><span class="kt">WebGLRenderingContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">gl.drawingBufferWidth</span><span class="p">,</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">gl.drawingBufferHeight</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#000000&#39;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fillStyle</span><span class="o">:</span><span class="w"> </span><span class="kt">currentColor</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fillRect</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 色を RGB に変換</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hexToRgb</span><span class="p">(</span><span class="nx">currentColor</span><span class="p">)</span>

<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">scissor</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">height</span><span class="p">,</span><span class="w"> </span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span>
<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">SCISSOR_TEST</span><span class="p">)</span>
<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span><span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">COLOR_BUFFER_BIT</span><span class="p">)</span>
<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">SCISSOR_TEST</span><span class="p">)</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">fillStyle</span><span class="p">(</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">currentColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">get</span><span class="w"> </span><span class="nx">fillStyle</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">currentColor</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">hexToRgb</span><span class="p">(</span><span class="nx">hex</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="kt">parseInt</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255</span><span class="p">,</span>
<span class="w">        </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="kt">parseInt</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255</span><span class="p">,</span>
<span class="w">        </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="kt">parseInt</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mf">3</span><span class="p">],</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">gameArea</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">192</span><span class="p">,</span><span class="w"> </span><span class="c1">// 6 * 32</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">416</span><span class="p">,</span><span class="w"> </span><span class="c1">// 13 * 32</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">controls</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flexDirection</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;row&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">    </span><span class="nx">gap</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">button</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#444&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">40</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">buttonText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">32</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_32">アプリの実行<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>では、実際に動作を確認してみましょう！</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>start
</code></pre></div>
<p>Expo Go アプリで QR コードをスキャンするか、シミュレータ/エミュレータで実行します。</p>
<p>画面に色のついたぷよが表示され、◀ボタンと▶ボタンでぷよを左右に移動できるようになっているはずです！</p>
<p>おめでとうございます！ぷよを動かすことができるようになりました。これでゲームらしくなってきましたね。</p>
<blockquote>
<p>プログラムが動いているのを見る前に、そのプログラムの設計を考えるのはあまり意味がない。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_33">コミット<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの移動と Canvas 描画の実装</span>

<span class="s1">- Player クラスの拡張（移動機能と境界チェック）</span>
<span class="s1">- PuyoImage クラスの拡張（Canvas 描画機能）</span>
<span class="s1">- Stage クラスの拡張（フィールド管理）</span>
<span class="s1">- Game クラスの更新（update/draw メソッド、moveLeft/moveRight）</span>
<span class="s1">- GameCanvas コンポーネントの更新（expo-gl 統合、タッチ操作）</span>
<span class="s1">- テストの追加（Player.test.ts, PuyoImage.test.ts）&#39;</span>
</code></pre></div>
<h3 id="2_1">イテレーション2のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<p><strong>実装した機能：</strong>
- ✅ ぷよの移動機能
  - moveLeft/moveRight メソッド
  - 境界チェック（画面外に出ないようにする）
  - タッチ操作による制御
- ✅ Canvas 描画機能
  - expo-gl による描画環境
  - PuyoImage クラスの描画メソッド
  - Stage クラスのフィールド描画
  - WebGL を Canvas 2D API として使用
- ✅ ぷよの生成
  - createNewPuyo メソッド
  - ランダムな色のぷよ生成
  - 画面中央への配置
- ✅ ゲームループの更新
  - update メソッドの実装
  - draw メソッドの実装
  - Canvas への描画統合
- ✅ テストの追加
  - Player クラスのテスト（5 テスト）
  - PuyoImage クラスのテスト（2 テスト）
  - すべてのテストが成功</p>
<p><strong>学んだこと：</strong></p>
<ol>
<li><strong>境界チェックの重要性</strong>:</li>
<li>ゲームオブジェクトが画面外に出ないようにする</li>
<li>条件分岐による制御</li>
<li>
<p>テストによる境界条件の確認</p>
</li>
<li>
<p><strong>expo-gl による描画</strong>:</p>
</li>
<li>WebGL を Canvas 2D API として使用</li>
<li>GLView コンポーネントの活用</li>
<li>
<p>カスタムコンテキストの作成</p>
</li>
<li>
<p><strong>タッチ操作の実装</strong>:</p>
</li>
<li>TouchableOpacity による UI</li>
<li>ゲームロジックとの連携</li>
<li>
<p>イベントハンドラの実装</p>
</li>
<li>
<p><strong>テスト駆動開発の実践</strong>:</p>
</li>
<li>Red-Green-Refactor サイクル</li>
<li>境界条件のテスト</li>
<li>モックを使った Canvas テスト</li>
</ol>
<p><strong>次のステップ：</strong></p>
<p>次のイテレーションでは、ぷよの回転機能を実装していきます。2 つのぷよを組にして、回転できるようにします。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続ける。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h2 id="3">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>さて、ぷよを左右に動かせるようになりました！「次は回転ですね！」そうです。本物のぷよぷよでは、2つのぷよが組になって回転しながら落ちてきます。このイテレーションでは、その回転機能を実装していきましょう！</p>
<h3 id="_34">ユーザーストーリー<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよを回転させることができる</p>
</blockquote>
<p>「回転させるって、具体的にはどういうことですか？」良い質問ですね！ぷよぷよでは、2つのぷよが組になっています。1つは「軸ぷよ」で、もう1つは「子ぷよ」です。軸ぷよを中心に、子ぷよが回転するんです。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、以下のタスクを実装していきます：</p>
<ul>
<li>✅ 2つのぷよ（親ぷよと子ぷよ）の実装</li>
<li>✅ 回転状態の管理（0-3の4状態）</li>
<li>✅ 回転メソッドの実装とテスト</li>
<li>✅ 壁キック処理の実装とテスト</li>
<li>✅ 2つ目のぷよを考慮した移動制限</li>
<li>✅ 描画の更新（2つのぷよを描画）</li>
<li>✅ React Native用の回転ボタンの追加</li>
</ul>
<p>それでは、テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_35">テスト: 回転状態の管理<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>「2つのぷよが回転するって、どうやって実装するんですか？」まずは、回転状態を数値で管理します。0から3までの4つの状態で、子ぷよの位置を表現するんです。</p>
<p><code>src/game/__tests__/Player.test.ts</code> に回転のテストを追加：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの回転&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;時計回りに回転すると、回転状態が1増える&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateRight</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">((</span><span class="nx">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;反時計回りに回転すると、回転状態が1減る&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateLeft</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">((</span><span class="nx">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;回転状態が4になると0に戻る&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateRight</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「回転状態って何ですか？」回転状態は、子ぷよが親ぷよのどの位置にあるかを表す値です：</p>
<ul>
<li>0: 子ぷよが上にある状態</li>
<li>1: 子ぷよが右にある状態</li>
<li>2: 子ぷよが下にある状態</li>
<li>3: 子ぷよが左にある状態</li>
</ul>
<h3 id="_36">実装: 回転状態の管理<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>テストが通るように、Player クラスを更新しましょう。</p>
<p><code>src/game/Player.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./PuyoImage&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoX</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoY</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoType</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">childType</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">rotation</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">  </span><span class="c1">// 回転状態に応じた子ぷよのオフセット</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">offsetX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">offsetY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">createNewPuyo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 画面中央に親ぷよを配置</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">    </span><span class="c1">// ランダムな色のぷよを生成（0-3の4色）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">childType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 親ぷよと子ぷよの両方が範囲内かチェック</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">--</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 親ぷよと子ぷよの両方が範囲内かチェック</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">rotateRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 時計回りに回転（0→1→2→3→0）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">rotateLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 反時計回りに回転（0→3→2→1→0）</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">update</span><span class="p">(</span><span class="nx">_deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 後のイテレーションで実装</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 親ぷよを描画</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 子ぷよを描画</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">childX</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">childType</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_37">解説: 回転の仕組み<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>「なるほど、offsetX と offsetY の配列で子ぷよの位置を管理するんですね！」そうです！この実装のポイントは：</p>
<ol>
<li><strong>回転状態の循環</strong>: <code>(rotation + 1) % 4</code> で0→1→2→3→0と循環します</li>
<li><strong>オフセット配列</strong>: rotation の値をインデックスとして使い、子ぷよの相対位置を取得します</li>
<li><strong>反時計回り</strong>: +3は-1と同じ効果（4で割った余りのため）</li>
</ol>
<blockquote>
<p>配列インデックスを使った状態管理は、複数の条件分岐を排除し、コードをシンプルに保つ効果的な手法です。</p>
</blockquote>
<h3 id="_38">テスト: 壁キック処理<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>「壁際で回転したらどうなるんですか？」良い質問です！壁にめり込むような回転をしようとした場合、自動的に位置を調整する「壁キック」という処理が必要です。</p>
<p><code>src/game/__tests__/Player.test.ts</code> に壁キックのテストを追加：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;壁キック処理&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右端で右回転すると、左に移動して回転する（壁キック）&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// 上向き</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateRight</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左端で左回転すると、右に移動して回転する（壁キック）&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// 上向き</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateLeft</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_39">実装: 壁キック処理<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>テストが通るように壁キック処理を実装します。</p>
<p><code>src/game/Player.ts</code> の回転メソッドを更新：</p>
<div class="highlight"><pre><span></span><code><span class="nx">rotateRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 時計回りに回転</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>

<span class="w">  </span><span class="c1">// 回転後の子ぷよの位置を計算</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="nx">newRotation</span><span class="p">]</span>

<span class="w">  </span><span class="c1">// 壁キック処理</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">++</span><span class="w"> </span><span class="c1">// 左壁キック：右に移動</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">--</span><span class="w"> </span><span class="c1">// 右壁キック：左に移動</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newRotation</span>
<span class="p">}</span>

<span class="nx">rotateLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 反時計回りに回転</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>

<span class="w">  </span><span class="c1">// 回転後の子ぷよの位置を計算</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="nx">newRotation</span><span class="p">]</span>

<span class="w">  </span><span class="c1">// 壁キック処理</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">++</span><span class="w"> </span><span class="c1">// 左壁キック：右に移動</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">--</span><span class="w"> </span><span class="c1">// 右壁キック：左に移動</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newRotation</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_40">解説: 壁キック処理<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>「なるほど、回転後の位置をチェックして、壁外なら位置を調整するんですね！」そうです！この処理により：</p>
<ol>
<li>回転後の子ぷよの位置を先に計算</li>
<li>その位置が範囲外なら、親ぷよの位置を調整</li>
<li>これにより、プレイヤーの操作性が向上します</li>
</ol>
<blockquote>
<p>壁キックはゲームのユーザビリティを向上させる重要な機能です。プレイヤーの意図を汲み取り、自然な動きを実現します。</p>
</blockquote>
<h3 id="2_2">テスト: 2つ目のぷよを考慮した移動制限<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<p>移動制限のテストも追加しましょう。</p>
<p><code>src/game/__tests__/Player.test.ts</code> に追加：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;2つ目のぷよを考慮した移動制限&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;横向き（右）の状態で右端にいる場合、右に移動できない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="c1">// 右向き</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;横向き（左）の状態で左端にいる場合、左に移動できない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="c1">// 左向き</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「moveLeft と moveRight で既に実装されてますね！」その通りです。子ぷよの位置も考慮した境界チェックが既に入っています。</p>
<h3 id="_41">テストの確認<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下の結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code> PASS  src/game/__tests__/Player.test.ts
  Player クラス
    ぷよの生成
      ✓ 新しいぷよを生成できる (2 ms)
    ぷよの移動
      ✓ 左に移動できる (1 ms)
      ✓ 右に移動できる (1 ms)
      ✓ 左端で左に移動しようとしても移動しない (1 ms)
      ✓ 右端で右に移動しようとしても移動しない (1 ms)
    ぷよの回転
      ✓ 時計回りに回転すると、回転状態が1増える (1 ms)
      ✓ 反時計回りに回転すると、回転状態が1減る (1 ms)
      ✓ 回転状態が4になると0に戻る (1 ms)
    壁キック処理
      ✓ 右端で右回転すると、左に移動して回転する（壁キック） (1 ms)
      ✓ 左端で左回転すると、右に移動して回転する（壁キック） (1 ms)
    2つ目のぷよを考慮した移動制限
      ✓ 横向き（右）の状態で右端にいる場合、右に移動できない (1 ms)
      ✓ 横向き（左）の状態で左端にいる場合、左に移動できない (1 ms)

Test Suites: 3 passed, 3 total
Tests:       19 passed, 19 total
</code></pre></div>
<h3 id="react-native_2">React Native コンポーネントの更新<a class="headerlink" href="#react-native_2" title="Permanent link">&para;</a></h3>
<p>回転ボタンを追加します。</p>
<p><code>src/components/GameCanvas.tsx</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">,</span><span class="w"> </span><span class="nx">TouchableOpacity</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GLView</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;expo-gl&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../game/Game&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameCanvas</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">Game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">glRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">WebGLRenderingContext</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">()</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">glRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">game</span><span class="p">.</span><span class="nx">setDrawCallback</span><span class="p">((</span><span class="nx">drawFn</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">gl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">glRef</span><span class="p">.</span><span class="nx">current</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">gl</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createCanvas2DContext</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span>
<span class="w">        </span><span class="nx">drawFn</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">CanvasRenderingContext2D</span><span class="p">)</span>
<span class="w">        </span><span class="nx">gl</span><span class="p">.</span><span class="nx">endFrameEXP</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleLeftPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleRightPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleRotatePress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">rotate</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">onContextCreate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">gl</span><span class="o">:</span><span class="w"> </span><span class="kt">WebGLRenderingContext</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">glRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gl</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">gl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">setDrawCallback</span><span class="p">((</span><span class="nx">drawFn</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createCanvas2DContext</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span>
<span class="w">        </span><span class="nx">drawFn</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">CanvasRenderingContext2D</span><span class="p">)</span>
<span class="w">        </span><span class="nx">gl</span><span class="p">.</span><span class="nx">endFrameEXP</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GLView</span>
<span class="w">        </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">gameArea</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onContextCreate</span><span class="o">=</span><span class="p">{</span><span class="nx">onContextCreate</span><span class="p">}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">controls</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleLeftPress</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">◀</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleRotatePress</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">🔄</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleRightPress</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">▶</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// WebGL を Canvas 2D のように使うためのヘルパー関数</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">createCanvas2DContext</span><span class="p">(</span><span class="nx">gl</span><span class="o">:</span><span class="w"> </span><span class="kt">WebGLRenderingContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">gl.drawingBufferWidth</span><span class="p">,</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">gl.drawingBufferHeight</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#000000&#39;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">canvas</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fillStyle</span><span class="o">:</span><span class="w"> </span><span class="kt">currentColor</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fillRect</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hexToRgb</span><span class="p">(</span><span class="nx">currentColor</span><span class="p">)</span>

<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">scissor</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">height</span><span class="p">,</span><span class="w"> </span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span>
<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">SCISSOR_TEST</span><span class="p">)</span>
<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span><span class="nx">color</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">COLOR_BUFFER_BIT</span><span class="p">)</span>
<span class="w">      </span><span class="nx">gl</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">SCISSOR_TEST</span><span class="p">)</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">fillStyle</span><span class="p">(</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">currentColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">get</span><span class="w"> </span><span class="nx">fillStyle</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">currentColor</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">hexToRgb</span><span class="p">(</span><span class="nx">hex</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="kt">parseInt</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255</span><span class="p">,</span>
<span class="w">        </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="kt">parseInt</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255</span><span class="p">,</span>
<span class="w">        </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="kt">parseInt</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mf">3</span><span class="p">],</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">gameArea</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">192</span><span class="p">,</span><span class="w"> </span><span class="c1">// 6 * 32</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">416</span><span class="p">,</span><span class="w"> </span><span class="c1">// 13 * 32</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">controls</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flexDirection</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;row&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">    </span><span class="nx">gap</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">button</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#444&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">40</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">buttonText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">32</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="game_1">Game クラスの更新<a class="headerlink" href="#game_1" title="Permanent link">&para;</a></h3>
<p>Game クラスに回転メソッドを追加します。</p>
<p><code>src/game/Game.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="nx">rotate</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateRight</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>このメソッドを <code>moveLeft()</code> と <code>moveRight()</code> の下に追加します。</p>
<h3 id="_42">アプリの実行<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>では、実際に動作を確認してみましょう！</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>start
</code></pre></div>
<p>画面に2つのぷよが表示され、🔄ボタンでぷよが回転するようになっているはずです！</p>
<p>おめでとうございます！ぷよが回転するようになりました。これでぷよぷよらしくなってきましたね！</p>
<blockquote>
<p>小さなステップで確実に前進する。それがテスト駆動開発の強みです。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_43">コミット<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの回転機能の実装</span>

<span class="s1">- Player クラスの拡張（回転機能と壁キック）</span>
<span class="s1">- 2つのぷよ（親ぷよと子ぷよ）の実装</span>
<span class="s1">- 回転状態管理（0-3の4状態）</span>
<span class="s1">- 壁キック処理（壁際での位置調整）</span>
<span class="s1">- 2つ目のぷよを考慮した移動制限</span>
<span class="s1">- GameCanvas コンポーネントの更新（回転ボタン追加）</span>
<span class="s1">- Game クラスの更新（rotate メソッド）</span>
<span class="s1">- テストの追加（回転、壁キック、移動制限）&#39;</span>
</code></pre></div>
<h3 id="3_1">イテレーション3のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<p><strong>実装した機能：</strong>
- ✅ 2つのぷよ（親ぷよと子ぷよ）の実装
  - 親ぷよを軸に子ぷよが回転
  - ランダムな色の組み合わせ
- ✅ 回転状態の管理
  - 0-3の4状態で子ぷよの位置を管理
  - offsetX/offsetY 配列による効率的な座標計算
- ✅ 回転メソッド
  - rotateRight: 時計回りに回転
  - rotateLeft: 反時計回りに回転
  - 回転状態の循環処理
- ✅ 壁キック処理
  - 回転後に壁外に出る場合、親ぷよの位置を自動調整
  - 左壁キック・右壁キックの実装
- ✅ 移動制限の改善
  - 親ぷよと子ぷよ両方の範囲チェック
  - 回転状態を考慮した境界判定
- ✅ 描画の更新
  - 親ぷよと子ぷよの両方を描画
  - 回転状態に応じた位置計算
- ✅ UI の拡張
  - 回転ボタンの追加
  - タッチ操作による回転制御
- ✅ テストの追加
  - 回転機能のテスト（3 テスト）
  - 壁キック処理のテスト（2 テスト）
  - 移動制限のテスト（2 テスト）
  - 合計 19 テストすべて成功</p>
<p><strong>学んだこと：</strong></p>
<ol>
<li><strong>配列インデックスによる状態管理</strong>:</li>
<li>回転状態を配列のインデックスとして活用</li>
<li>条件分岐を排除し、シンプルなコードを実現</li>
<li>
<p>可読性と保守性の向上</p>
</li>
<li>
<p><strong>壁キック処理の重要性</strong>:</p>
</li>
<li>ユーザビリティ向上のための自動位置調整</li>
<li>プレイヤーの意図を汲み取る仕組み</li>
<li>
<p>ゲーム体験の向上</p>
</li>
<li>
<p><strong>複合的な境界チェック</strong>:</p>
</li>
<li>複数のオブジェクトを考慮した判定</li>
<li>親ぷよと子ぷよ両方の範囲チェック</li>
<li>
<p>安全な操作の保証</p>
</li>
<li>
<p><strong>TDD による段階的な実装</strong>:</p>
</li>
<li>Red-Green-Refactor サイクルの実践</li>
<li>小さなステップでの確実な前進</li>
<li>テストによる安心感</li>
</ol>
<p><strong>次のステップ：</strong></p>
<p>次のイテレーションでは、ぷよの自由落下機能を実装していきます。時間とともにぷよが自動的に下に落ちる仕組みを作ります。</p>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h2 id="4">イテレーション4: ぷよの自由落下の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>さて、ぷよを回転させることができるようになりました！「次は何をするんですか？」次は、ぷよが自動的に落ちていく「自由落下」機能を実装していきましょう。ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきますよね。</p>
<h3 id="_44">ユーザーストーリー<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとして、ぷよを自由落下させることができる</p>
</blockquote>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、以下のタスクを実装していきます：</p>
<ul>
<li>✅ 落下タイマーの実装（一定時間ごとに落下処理を実行）</li>
<li>✅ 自動落下処理の実装（タイマーが発火したときにぷよを1マス下に移動）</li>
<li>✅ 落下可能判定の実装（下に移動できるかどうかをチェック）</li>
<li>✅ 着地処理の実装（ぷよが着地したときの処理）</li>
<li>✅ ステージへの固定（着地したぷよをステージに配置）</li>
<li>✅ 次のぷよ生成（着地後に新しいぷよを出現）</li>
</ul>
<p>それでは、テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_45">テスト: 落下タイマー<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>まずは、一定時間ごとに落下処理が実行される仕組みをテストしましょう。</p>
<p><code>src/game/__tests__/Player.test.ts</code> に自由落下のテストを追加：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;自由落下&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;指定時間が経過すると、ぷよが1マス下に落ちる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="c1">// 1秒</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">dropInterval</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;指定時間未満では、ぷよは落ちない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dropInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">dropInterval</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;下端に達した場合、それ以上落ちない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「これらのテストは何を確認しているんですか？」このテストでは、以下のことを確認しています：</p>
<ol>
<li>指定時間（1秒）が経過すると、ぷよが1マス下に落ちること</li>
<li>指定時間未満では、ぷよは落ちないこと</li>
<li>下端に達した場合、それ以上落ちないこと</li>
</ol>
<h3 id="_46">実装: 落下タイマー<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>テストが通るように、Player クラスを更新しましょう。</p>
<p><code>src/game/Player.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoX</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoY</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoType</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">childType</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">rotation</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropTimer</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="c1">// 1秒ごとに落下</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">offsetX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">offsetY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">createNewPuyo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">childType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// タイマーを進める</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaTime</span>

<span class="w">    </span><span class="c1">// 落下間隔を超えたら落下処理を実行</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">dropInterval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">()</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// タイマーをリセット</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">applyGravity</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canMoveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">canMoveDown</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 親ぷよが下端に達しているかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよの位置を計算</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>

<span class="w">    </span><span class="c1">// 子ぷよが下端に達しているかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 既存のメソッド...</span>
<span class="w">  </span><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">--</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">rotateRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="nx">newRotation</span><span class="p">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">--</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newRotation</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">rotateLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="nx">newRotation</span><span class="p">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="o">--</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newRotation</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="p">)</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">childX</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">childType</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_47">解説: タイマーによる自動落下<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>「タイマーを使って一定間隔で落下させるんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li><strong>dropTimer</strong> でタイマーを管理</li>
<li><strong>update()</strong> メソッドで経過時間を加算</li>
<li>一定間隔（<strong>dropInterval</strong>）を超えたら <strong>applyGravity()</strong> を実行</li>
<li><strong>applyGravity()</strong> で下に移動できるかチェックし、移動</li>
</ol>
<blockquote>
<p>deltaTime による時間ベースの更新は、デバイスのパフォーマンスに関わらず一定の速度でゲームを進行させる基本的なテクニックです。</p>
</blockquote>
<h3 id="_48">テスト: 着地判定とステージへの固定<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>次に、ぷよが着地したときの処理をテストしましょう。</p>
<p><code>src/game/__tests__/Player.test.ts</code> に追加：</p>
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;着地判定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ぷよが下端に着地したら固定される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="c1">// 子ぷよは下</span>

<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;landed&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;着地したぷよはステージに固定される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span>
<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span>

<span class="w">    </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;fixToStage&#39;</span><span class="p">]()</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoX&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">])).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoType&#39;</span><span class="p">])</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_49">実装: 着地処理とステージへの固定<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>テストが通るように実装を追加します。</p>
<p>まず、Stage クラスに必要なメソッドを追加：</p>
<p><code>src/game/Stage.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">field</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">[][]</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoImage</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyoImage</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setPuyo</span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">type</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getPuyo</span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">])</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>次に、Player クラスに着地処理を追加：</p>
<p><code>src/game/Player.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 既存のプロパティ...</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">landed</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">  </span><span class="nx">createNewPuyo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">landed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c1">// 着地フラグをリセット</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">childType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">applyGravity</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canMoveDown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 着地したらステージに固定</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">fixToStage</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">canMoveDown</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 親ぷよが下端に達しているかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよの位置を計算</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>

<span class="w">    </span><span class="c1">// 子ぷよが下端に達しているかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 親ぷよの下にぷよがあるかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよの下にぷよがあるかチェック（子ぷよが下向きでない場合のみ）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="nx">childX</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">fixToStage</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 親ぷよをステージに固定</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 子ぷよをステージに固定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">]</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="nx">childX</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">childType</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 着地フラグを立てる</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">landed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">hasLanded</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">landed</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_50">解説: 着地判定とステージへの固定<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>「着地判定が複雑ですね！」そうですね。着地判定では以下のことをチェックしています：</p>
<ol>
<li><strong>下端チェック</strong>: 親ぷよと子ぷよが画面下端に達していないか</li>
<li><strong>衝突チェック</strong>: 親ぷよと子ぷよの下にすでにぷよがないか</li>
<li><strong>子ぷよの向き</strong>: 子ぷよが下向きの場合は、その分の判定を省略</li>
</ol>
<p>「ステージに固定するときは両方のぷよを配置するんですね！」その通りです。親ぷよと子ぷよの両方をステージに固定し、着地フラグを立てます。</p>
<h3 id="game_2">Game クラスの更新<a class="headerlink" href="#game_2" title="Permanent link">&para;</a></h3>
<p>Game クラスで着地を検知して次のぷよを出すようにします。</p>
<p><code>src/game/Game.ts</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">running</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">lastTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">animationFrameId?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">drawCallback</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">callback</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config?</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoImage?</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoImage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage?</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player?</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">score?</span><span class="o">:</span><span class="w"> </span><span class="kt">Score</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// コンストラクタでは何もしない</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PuyoImage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoImage</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Score</span><span class="p">()</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;start&#39;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">start</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loop</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">stop</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setDrawCallback</span><span class="p">(</span><span class="nx">callback</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">callback</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">drawCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">callback</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveLeft</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">moveRight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">rotate</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">rotateRight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">deltaTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentTime</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loop</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c1">// プレイヤーの更新</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 着地したら次のぷよを出す</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">draw</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">drawCallback</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">drawCallback</span><span class="p">((</span><span class="nx">ctx</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#222&#39;</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="o">?</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="o">?</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="o">?</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_51">テストの確認<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>以下の結果が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code> PASS  src/game/__tests__/Player.test.ts
  Player クラス
    ぷよの生成
      ✓ 新しいぷよを生成できる (2 ms)
    ぷよの移動
      ✓ 左に移動できる (1 ms)
      ✓ 右に移動できる (1 ms)
      ✓ 左端で左に移動しようとしても移動しない (1 ms)
      ✓ 右端で右に移動しようとしても移動しない (1 ms)
    ぷよの回転
      ✓ 時計回りに回転すると、回転状態が1増える (1 ms)
      ✓ 反時計回りに回転すると、回転状態が1減る (1 ms)
      ✓ 回転状態が4になると0に戻る (1 ms)
    壁キック処理
      ✓ 右端で右回転すると、左に移動して回転する（壁キック） (1 ms)
      ✓ 左端で左回転すると、右に移動して回転する（壁キック） (1 ms)
    2つ目のぷよを考慮した移動制限
      ✓ 横向き（右）の状態で右端にいる場合、右に移動できない (1 ms)
      ✓ 横向き（左）の状態で左端にいる場合、左に移動できない (1 ms)
    自由落下
      ✓ 指定時間が経過すると、ぷよが1マス下に落ちる (1 ms)
      ✓ 指定時間未満では、ぷよは落ちない (1 ms)
      ✓ 下端に達した場合、それ以上落ちない (1 ms)
    着地判定
      ✓ ぷよが下端に着地したら固定される (1 ms)
      ✓ 着地したぷよはステージに固定される (1 ms)

Test Suites: 3 passed, 3 total
Tests:       24 passed, 24 total
</code></pre></div>
<h3 id="_52">アプリの実行<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>では、実際に動作を確認してみましょう！</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>start
</code></pre></div>
<p>ぷよが自動的に落下し、着地すると次のぷよが出現するようになっているはずです！</p>
<p>おめでとうございます！ぷよが自動的に落下するようになりました。これでゲームらしさが大きく向上しましたね！</p>
<blockquote>
<p>小さく頻繁なリリースを繰り返すことで、常に動くソフトウェアを保ち続ける。</p>
<p>— Kent Beck 『エクストリームプログラミング』</p>
</blockquote>
<h3 id="_53">コミット<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>ここまでの実装をコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの自由落下と着地処理の実装</span>

<span class="s1">- Player クラスの拡張（落下タイマー、着地判定）</span>
<span class="s1">- Stage クラスの拡張（ぷよの配置と取得）</span>
<span class="s1">- 自由落下機能（1秒間隔で1マス落下）</span>
<span class="s1">- 着地判定（下端チェック、衝突チェック）</span>
<span class="s1">- ステージへの固定（親ぷよと子ぷよを配置）</span>
<span class="s1">- 次のぷよ生成（着地後に新しいぷよを出現）</span>
<span class="s1">- Game クラスの更新（着地検知、描画制御）</span>
<span class="s1">- テストの追加（自由落下、着地判定）&#39;</span>
</code></pre></div>
<h3 id="4_1">イテレーション4のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<p><strong>実装した機能：</strong>
- ✅ 自由落下機能
  - dropTimer と dropInterval でタイミング管理
  - update メソッドで時間経過に応じた落下処理
  - 1秒間隔で1マスずつ落下
- ✅ 着地判定
  - canMoveDown メソッド：下に移動できるかチェック
  - 下端チェック：親ぷよと子ぷよ両方を確認
  - 衝突チェック：ステージ上のぷよとの衝突を検知
- ✅ ステージへの固定
  - fixToStage メソッド：着地したぷよをステージに配置
  - 親ぷよと子ぷよを両方固定
  - 着地フラグ（landed）を立てる
- ✅ 次のぷよ生成
  - Game クラスで着地を検知
  - 着地後に createNewPuyo で次のぷよを出現
- ✅ Stage クラスの拡張
  - setPuyo: ぷよをステージに配置
  - getPuyo: ステージからぷよを取得
  - フィールド管理機能
- ✅ 描画の改善
  - 着地したぷよは描画しない
  - ステージに固定されたぷよのみ表示
- ✅ テストの追加
  - 自由落下のテスト（3 テスト）
  - 着地判定のテスト（2 テスト）
  - 合計 24 テストすべて成功</p>
<p><strong>学んだこと：</strong></p>
<ol>
<li><strong>deltaTime による時間ベースの更新</strong>:</li>
<li>デバイス性能に関わらず一定速度で進行</li>
<li>タイマー加算方式による落下制御</li>
<li>
<p>React Native でも同じ仕組みが使える</p>
</li>
<li>
<p><strong>複合的な着地判定</strong>:</p>
</li>
<li>下端チェック：親ぷよと子ぷよ両方</li>
<li>衝突チェック：ステージ上のぷよとの判定</li>
<li>
<p>子ぷよの向きを考慮した判定</p>
</li>
<li>
<p><strong>ゲーム状態の管理</strong>:</p>
</li>
<li>着地フラグによる状態管理</li>
<li>着地後の操作無効化</li>
<li>
<p>次のぷよへのスムーズな遷移</p>
</li>
<li>
<p><strong>テスト駆動開発の実践</strong>:</p>
</li>
<li>Red-Green-Refactor サイクル</li>
<li>時間ベースの処理のテスト</li>
<li>境界条件のテスト</li>
</ol>
<p><strong>次のステップ：</strong></p>
<p>次のイテレーションでは、ぷよの高速落下機能を実装していきます。ボタンを押している間、ぷよが素早く落下する機能を追加します。</p>
<blockquote>
<p>動くソフトウェアこそが、進捗の最も重要な尺度である。</p>
<p>— アジャイルソフトウェア開発宣言</p>
</blockquote>
<h2 id="5">イテレーション 5: ぷよの高速落下の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、もっと早く落とせたらいいのに！」そうですね！ぷよぷよでは、プレイヤーがボタンを押すことで、ぷよを素早く落下させることができます。今回は、その「高速落下」機能を実装していきましょう！</p>
<h3 id="_54">ユーザーストーリー<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p><strong>プレイヤーとして、ぷよを素早く落下させることができる</strong></p>
</blockquote>
<p>「早く次のぷよを落としたい！」というときに、ボタンを押して素早く落下させる機能は、ゲームのテンポを良くするために重要ですね。</p>
<h3 id="todo_4">TODO リスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p><strong>やること：</strong></p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 下ボタン入力の検出を実装する（タッチボタンが押されたことを検知する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 高速落下処理を実装する（ボタンが押されているときは落下速度を上げる）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 落下可能かどうかのチェックを実装する（下に障害物がある場合は落下できないようにする）</li>
<li class="task-list-item"><input type="checkbox" disabled/> UI に下ボタンを追加する（React Native の TouchableOpacity で実装）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_55">テスト: 高速落下速度の取得<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ボタンが押されたときに落下速度が上がることをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __tests__/Player.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;高速落下&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">;</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">CONFIG</span><span class="p">);</span>
<span class="w">    </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">CONFIG</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">);</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;高速落下フラグが立っていると、落下速度が上がる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 通常の落下速度</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 高速落下フラグを立てる</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">setFastDrop</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fastSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 高速落下の速度が通常より速いことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fastSpeed</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="nx">normalSpeed</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fastSpeed</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"> </span><span class="c1">// 10倍速</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;高速落下フラグが立っていないと、通常の落下速度になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 高速落下フラグを下ろす</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">setFastDrop</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 通常の落下速度であることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">normalSpeed</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の 2 つのケースを確認しています：</p>
<ol>
<li>高速落下フラグが立っている（<code>true</code>）ときは、落下速度が通常の 10 倍になるか</li>
<li>高速落下フラグが立っていない（<code>false</code>）ときは、通常の落下速度（1 倍）になるか</li>
</ol>
<p>「なるほど、フラグの状態によって速度が変わるんですね！」そうです！では、このテストが通るように実装していきましょう。</p>
<h3 id="_56">実装: 高速落下速度の取得<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、高速落下の機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.ts（続き）</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Player</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoX</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoY</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">puyoType</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">childType</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">rotation</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropTimer</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1秒</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">landed</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">fastDrop</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// 高速落下フラグ</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">  </span><span class="nx">setFastDrop</span><span class="p">(</span><span class="nx">fast</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">fastDrop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fast</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getDropSpeed</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 高速落下フラグが立っていれば10倍速、そうでなければ通常速度</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">fastDrop</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">10</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。高速落下の処理自体はとてもシンプルです。<code>getDropSpeed</code> メソッドでは、高速落下フラグが立っているかどうかを確認し、立っていれば通常の 10 倍の速度で落下するようにしています。</p>
<p>「<code>setFastDrop</code> メソッドは外部からフラグを設定するためのものですね？」その通りです！Game クラスから、ボタンの押下状態に応じてこのメソッドを呼び出すことで、高速落下のオン・オフを切り替えます。</p>
<h3 id="_57">実装: ゲームループとの統合<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>「落下速度を変更する処理はどこで使うんですか？」良い質問ですね！既存の <code>updateWithDelta</code> メソッドを修正して、高速落下の速度を反映させます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Player.ts（続き）</span>
<span class="nx">updateWithDelta</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 着地済みなら処理しない</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">landed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// タイマーを進める（高速落下の速度を反映）</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// 落下間隔に達したら落下処理</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">dropInterval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dropTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// タイマーをリセット</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど！<code>deltaTime</code> に <code>getDropSpeed()</code> を掛けることで、高速落下フラグが立っているときはタイマーが 10 倍速く進むんですね！」その通りです！これで高速落下フラグが立っている間は通常の 10 倍の速さでぷよが落下するようになりました。</p>
<h3 id="_58">テスト実行<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>「テストは通りましたか？」では、テストを実行してみましょう。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>Player.test.ts
</code></pre></div>
<p><strong>実行結果：</strong></p>
<div class="highlight"><pre><span></span><code> PASS  __tests__/Player.test.ts
  Player
    ぷよの生成
      ✓ 新しいぷよを生成できる (3 ms)
      ✓ ぷよの初期位置は(2, 1)である (1 ms)
    ぷよの移動
      ✓ 左に移動できる (2 ms)
      ✓ 右に移動できる (1 ms)
      ✓ 左端で左に移動できない (1 ms)
      ✓ 右端で右に移動できない (2 ms)
    ぷよの回転
      ✓ 右回転できる (2 ms)
      ✓ 回転は0-3の範囲で循環する (1 ms)
      ✓ 左端での回転時に壁キックが動作する (2 ms)
      ✓ 右端での回転時に壁キックが動作する (1 ms)
      ✓ 回転時に子ぷよが壁に当たる場合、移動制限がかかる (2 ms)
      ✓ 回転時に子ぷよが既存のぷよに当たる場合、移動制限がかかる (1 ms)
    ぷよの自由落下
      ✓ 指定時間が経過すると、ぷよが1マス下に落ちる (2 ms)
      ✓ 指定時間未満では、ぷよは落ちない (1 ms)
      ✓ 下端に達した場合、それ以上落ちない (2 ms)
    ぷよの着地
      ✓ 下端に着地したら固定される (1 ms)
      ✓ 他のぷよの上に着地したら固定される (2 ms)
    高速落下
      ✓ 高速落下フラグが立っていると、落下速度が上がる (1 ms)
      ✓ 高速落下フラグが立っていないと、通常の落下速度になる (1 ms)

Test Suites: 1 passed, 1 total
Tests:       19 passed, 19 total
</code></pre></div>
<p>「やった！テストが全部通りました！」素晴らしいですね。これで高速落下の基本機能が実装できました。</p>
<h3 id="game_3">実装: Game クラスでの高速落下制御<a class="headerlink" href="#game_3" title="Permanent link">&para;</a></h3>
<p>「でも、まだプレイヤーがボタンを押して高速落下を制御する部分ができていませんよね？」鋭い指摘ですね！Game クラスに高速落下の制御機能を追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.ts（続き）</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">lastTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">animationId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">  </span><span class="nx">startFastDrop</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">setFastDrop</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">stopFastDrop</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">setFastDrop</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>
<span class="p">}</span>
</code></pre></div>
<p>「これで Game クラスから Player の高速落下をコントロールできるようになりましたね！」そうです！次は、React Native の UI にボタンを追加して、これらのメソッドを呼び出すようにします。</p>
<h3 id="react-native-ui">実装: React Native UI の更新<a class="headerlink" href="#react-native-ui" title="Permanent link">&para;</a></h3>
<p>「UI にはどんなボタンを追加するんですか？」下ボタンを追加して、押している間は高速落下、離すと通常速度に戻るようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// App.tsx（続き）</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvasRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">ExpoWebGLRenderingContext</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">Game</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">  </span><span class="c1">// 高速落下の開始</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleFastDropStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">startFastDrop</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// 高速落下の停止</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleFastDropStop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">stopFastDrop</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GLView</span>
<span class="w">        </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">canvas</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onContextCreate</span><span class="o">=</span><span class="p">{</span><span class="nx">handleContextCreate</span><span class="p">}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">controls</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span>
<span class="w">          </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleMoveLeft</span><span class="p">}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">←</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span>
<span class="w">          </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleRotate</span><span class="p">}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">🔄</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span>
<span class="w">          </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleMoveRight</span><span class="p">}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">→</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">controls</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{[</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">.</span><span class="nx">downButton</span><span class="p">]}</span>
<span class="w">          </span><span class="nx">onPressIn</span><span class="o">=</span><span class="p">{</span><span class="nx">handleFastDropStart</span><span class="p">}</span>
<span class="w">          </span><span class="nx">onPressOut</span><span class="o">=</span><span class="p">{</span><span class="nx">handleFastDropStop</span><span class="p">}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">↓</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">canvas</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">320</span><span class="p">,</span>
<span class="w">    </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">640</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">controls</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flexDirection</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;row&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">button</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#4CAF50&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">    </span><span class="nx">margin</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">minWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">60</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">downButton</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#2196F3&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">minWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">buttonText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#FFF&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">});</span>
</code></pre></div>
<p>「<code>onPressIn</code> と <code>onPressOut</code> を使っているんですね！」その通りです！<code>onPressIn</code> はボタンが押された瞬間、<code>onPressOut</code> はボタンから指が離れた瞬間に呼ばれます。これにより、ボタンを押している間だけ高速落下が有効になります。</p>
<p>「下ボタンは別の行に配置して、横幅も広くしているんですね！」そうです！操作しやすいように、下ボタンは独立した行に配置し、幅も広くしています。</p>
<h3 id="_59">テスト: 統合テスト<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>「全体が正しく動作するかをテストしたいです！」では、Game クラスの統合テストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __tests__/Game.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;高速落下&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;startFastDropを呼ぶと高速落下が有効になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 通常速度を確認</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;player&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">();</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">normalSpeed</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 高速落下を開始</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">startFastDrop</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fastSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">();</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fastSpeed</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;stopFastDropを呼ぶと高速落下が無効になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;player&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// 高速落下を開始</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">startFastDrop</span><span class="p">();</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 高速落下を停止</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">stopFastDrop</span><span class="p">();</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">getDropSpeed</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;高速落下中はぷよが速く落ちる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;player&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// 高速落下を開始</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">startFastDrop</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 100ms経過（通常なら落ちないが、10倍速なら1000msとして扱われる）</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">100</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ぷよが落下していることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">player</span><span class="p">[</span><span class="s1">&#39;puyoY&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「統合テストでは、Game クラスを通じて高速落下が正しく動作するかをテストしているんですね！」その通りです！実際のゲームの流れに沿った形でテストすることで、機能全体が正しく動作することを確認できます。</p>
<h3 id="_60">テスト実行（全体）<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>「全部のテストを実行してみましょう！」では、すべてのテストを実行します。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p><strong>実行結果：</strong></p>
<div class="highlight"><pre><span></span><code> PASS  __tests__/Stage.test.ts
 PASS  __tests__/Player.test.ts
 PASS  __tests__/Game.test.ts

Test Suites: 3 passed, 3 total
Tests:       27 passed, 27 total
Snapshots:   0 total
Time:        2.841 s
</code></pre></div>
<p>「やった！全部のテストが通りました！」素晴らしいですね。これで高速落下機能が完全に動作するようになりました。</p>
<h3 id="_61">動作確認<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>「実際に動かしてみたいです！」では、Expo で実行してみましょう。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>start
</code></pre></div>
<p>スマートフォンまたはエミュレーターでアプリを開いて、下ボタンを押してみてください。ボタンを押している間、ぷよが素早く落下するはずです！</p>
<h3 id="_62">リファクタリング<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>「コードは十分シンプルなので、今回はリファクタリングは必要なさそうですね。」そうですね。追加したコードは少なく、既存の構造に自然に溶け込んでいるので、特にリファクタリングの必要はありません。</p>
<h3 id="_63">コミット<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>「良いタイミングでコミットしましょう！」そうですね。機能が完成してテストも通ったので、コミットします。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: Implement fast drop feature</span>

<span class="s2">- Add fastDrop flag to Player class</span>
<span class="s2">- Add getDropSpeed method (10x speed when fast dropping)</span>
<span class="s2">- Add setFastDrop method to control fast drop</span>
<span class="s2">- Integrate fast drop speed into updateWithDelta</span>
<span class="s2">- Add startFastDrop and stopFastDrop methods to Game class</span>
<span class="s2">- Add down button to React Native UI (onPressIn/onPressOut)</span>
<span class="s2">- Add tests for fast drop functionality</span>
<span class="s2">- All 27 tests passing</span>

<span class="s2">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s2">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;&quot;</span>
</code></pre></div>
<h3 id="5_1">イテレーション 5 のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの高速落下機能を実装しました。以下がイテレーション 5 で実施した内容のまとめです：</p>
<p><strong>実装した機能：</strong></p>
<ul>
<li>✅ 高速落下フラグの管理</li>
<li><code>fastDrop</code> プロパティで状態管理</li>
<li><code>setFastDrop</code> メソッドで外部から制御</li>
<li>✅ 落下速度の制御</li>
<li><code>getDropSpeed</code> メソッド：通常速度（1）と高速（10）を切り替え</li>
<li><code>updateWithDelta</code> で落下速度を反映</li>
<li>✅ Game クラスでの制御</li>
<li><code>startFastDrop</code> メソッド：高速落下開始</li>
<li><code>stopFastDrop</code> メソッド：高速落下停止</li>
<li>✅ React Native UI の更新</li>
<li>下ボタンの追加（↓）</li>
<li><code>onPressIn</code> / <code>onPressOut</code> でボタン押下状態を検知</li>
<li>ボタン押下中のみ高速落下が有効</li>
<li>✅ テストの追加</li>
<li>高速落下速度のテスト（2 テスト）</li>
<li>Game クラスの統合テスト（3 テスト）</li>
<li>合計 27 テストすべて成功</li>
</ul>
<p><strong>学んだこと：</strong></p>
<ol>
<li><strong>状態に応じた速度制御</strong>:</li>
<li>フラグによる速度の切り替え</li>
<li><code>deltaTime * speed</code> による時間倍率の適用</li>
<li>
<p>外部からの状態制御パターン</p>
</li>
<li>
<p><strong>React Native のタッチ処理</strong>:</p>
</li>
<li><code>onPressIn</code> と <code>onPressOut</code> の使い分け</li>
<li>ボタン押下中の状態管理</li>
<li>
<p>タッチ UI の設計パターン</p>
</li>
<li>
<p><strong>テスト駆動開発の実践</strong>:</p>
</li>
<li>Red-Green-Refactor サイクル</li>
<li>単体テストと統合テストの組み合わせ</li>
<li>
<p>速度変化のテスト手法</p>
</li>
<li>
<p><strong>ゲーム体験の向上</strong>:</p>
</li>
<li>テンポの良いゲームプレイ</li>
<li>プレイヤーの操作感覚の改善</li>
<li>レスポンシブな入力処理</li>
</ol>
<p><strong>次のステップ：</strong></p>
<p>次のイテレーションでは、ぷよの消去機能を実装していきます。同じ色のぷよを 4 つ以上つなげると消去できる、ぷよぷよの基本ルールを実装します。</p>
<blockquote>
<p>シンプルさ—完成させなくてもよい仕事を最大化する技術—が本質的だ。</p>
<p>— アジャイルソフトウェア開発宣言</p>
</blockquote>
<h2 id="6">イテレーション 6: ぷよの消去の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを 4 つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_64">ユーザーストーリー<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p><strong>プレイヤーとして、同じ色のぷよを 4 つ以上つなげると消去できる</strong></p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを 4 つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。これを実装することで、ゲームとしての面白さが大きく向上しますね。</p>
<h3 id="todo_5">TODO リスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p><strong>やること：</strong></p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 4 つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 消去後の落下処理を実装する（消去された後の空きスペースにぷよが落ちてくる）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームループとの統合（消去判定と消去処理をゲームフローに組み込む）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_65">テスト: ぷよの接続判定<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが 4 つ以上つながっているかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __tests__/Stage.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの接続判定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;同じ色のぷよが4つつながっていると、消去対象になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">CONFIG</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージにぷよを配置（1は赤ぷよ）</span>
<span class="w">    </span><span class="c1">// 視覚的な配置（下から2行、左から2列目に2×2の正方形）</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// ...（省略）...</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0  ← 下から2行目</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0  ← 最下行</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 4つのぷよが消去対象になっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;異なる色のぷよは消去対象にならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">CONFIG</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージにぷよを配置（1は赤ぷよ、2は青ぷよ）</span>
<span class="w">    </span><span class="c1">// 市松模様に配置</span>
<span class="w">    </span><span class="c1">// 0 1 2 0 0 0  ← 下から2行目</span>
<span class="w">    </span><span class="c1">// 0 2 1 0 0 0  ← 最下行</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 消去対象がないことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;3つ以下のつながりは消去対象にならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">CONFIG</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージにぷよを配置（赤ぷよ3つ）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 消去対象がないことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の 3 つのケースを確認しています：</p>
<ol>
<li>同じ色のぷよが 4 つつながっている場合、それらが消去対象になるか</li>
<li>異なる色のぷよが隣接している場合、それらは消去対象にならないか</li>
<li>同じ色でも 3 つ以下の場合は消去対象にならないか</li>
</ol>
<p>「ステージにぷよを配置しているのはわかりますが、その図はどういう意味ですか？」良い質問ですね！コメントの図は、ステージ上のぷよの配置を視覚的に表現しています。0 は空きマス、1 は赤ぷよ、2 は青ぷよを表しています。最初のテストでは 2×2 の正方形に赤ぷよを配置し、2 つ目のテストでは市松模様に赤と青のぷよを配置しています。</p>
<p>「なるほど、視覚的に確認できるのは便利ですね！」そうですね。では、このテストが通るように実装していきましょう。</p>
<h3 id="_66">実装: ぷよの接続判定<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよの接続判定を実装していきましょう。</p>
<p>まず、消去情報を表す型定義を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.ts（型定義を追加）</span>
<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">EraseInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">erasePuyoCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="p">}[];</span>
<span class="p">}</span>
</code></pre></div>
<p>次に、Stage クラスに接続判定のメソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.ts（続き）</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">field</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">[][];</span>

<span class="w">  </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">  </span><span class="nx">checkErase</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">EraseInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 消去情報</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="kt">EraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">erasePuyoCount</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 一時的なチェック用配列</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">checked</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">checked</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">checked</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 全マスをチェック</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ぷよがあり（-1でない）、まだチェックしていない場合</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">checked</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 接続しているぷよを探索</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">];</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">connected</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">searchConnectedPuyo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoType</span><span class="p">,</span><span class="w"> </span><span class="nx">checked</span><span class="p">,</span><span class="w"> </span><span class="nx">connected</span><span class="p">);</span>

<span class="w">          </span><span class="c1">// 4つ以上つながっている場合は消去対象</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">connected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">                </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">puyo.x</span><span class="p">,</span>
<span class="w">                </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">puyo.y</span><span class="p">,</span>
<span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">puyoType</span>
<span class="w">              </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">searchConnectedPuyo</span><span class="p">(</span>
<span class="w">    </span><span class="nx">startX</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">startY</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">puyoType</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">checked</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">[][],</span>
<span class="w">    </span><span class="nx">connected</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}[]</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 探索済みにする</span>
<span class="w">    </span><span class="nx">checked</span><span class="p">[</span><span class="nx">startY</span><span class="p">][</span><span class="nx">startX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">connected</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">startX</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">startY</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 4方向を探索</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">directions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 右</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 下</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1">// 上</span>
<span class="w">    </span><span class="p">];</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">direction</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">directions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">direction</span><span class="p">.</span><span class="nx">dx</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">direction</span><span class="p">.</span><span class="nx">dy</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// ボード内かつ同じ色のぷよがあり、まだチェックしていない場合</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">nextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">nextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">nextY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">nextY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">nextX</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">puyoType</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="o">!</span><span class="nx">checked</span><span class="p">[</span><span class="nx">nextY</span><span class="p">][</span><span class="nx">nextX</span><span class="p">]</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 再帰的に探索</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">searchConnectedPuyo</span><span class="p">(</span><span class="nx">nextX</span><span class="p">,</span><span class="w"> </span><span class="nx">nextY</span><span class="p">,</span><span class="w"> </span><span class="nx">puyoType</span><span class="p">,</span><span class="w"> </span><span class="nx">checked</span><span class="p">,</span><span class="w"> </span><span class="nx">connected</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>searchConnectedPuyo</code> は再帰的に呼ばれるんですね！」その通りです！これは<a href="https://ja.wikipedia.org/wiki/%E6%B7%B1%E3%81%95%E5%84%AA%E5%85%88%E6%8E%A2%E7%B4%A2">深さ優先探索（DFS）アルゴリズム</a>と呼ばれる手法です。</p>
<h3 id="_67">解説: ぷよの接続判定<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>ぷよの接続判定では、以下のことを行っています：</p>
<ol>
<li><strong>ボード上の全マスを順番にチェック</strong>：二重ループですべてのマスを走査</li>
<li><strong>未チェックのぷよを発見したら探索開始</strong>：同じ色で接続しているぷよを探索</li>
<li><strong>深さ優先探索（DFS）で接続ぷよを列挙</strong>：再帰的に上下左右を探索</li>
<li><strong>4 つ以上つながっている場合は消去対象として記録</strong></li>
</ol>
<p>深さ優先探索（DFS）のアルゴリズムでは：
- あるぷよから始めて、上下左右に隣接する同じ色のぷよを再帰的に探索
- 探索済みのぷよは <code>checked</code> 配列でマークし、重複してカウントしないようにする
- 接続しているすべてのぷよを <code>connected</code> 配列に格納</p>
<h3 id="_68">テスト実行<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>「テストは通りましたか？」では、テストを実行してみましょう。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>Stage.test.ts
</code></pre></div>
<p><strong>実行結果：</strong></p>
<div class="highlight"><pre><span></span><code> PASS  __tests__/Stage.test.ts
  Stage
    ステージの初期化
      ✓ ステージを初期化できる (2 ms)
    ぷよの設定と取得
      ✓ ぷよを設定できる (1 ms)
      ✓ ぷよを取得できる (1 ms)
      ✓ 範囲外の座標では-1を返す (1 ms)
    ぷよの接続判定
      ✓ 同じ色のぷよが4つつながっていると、消去対象になる (2 ms)
      ✓ 異なる色のぷよは消去対象にならない (1 ms)
      ✓ 3つ以下のつながりは消去対象にならない (1 ms)

Test Suites: 1 passed, 1 total
Tests:       7 passed, 7 total
</code></pre></div>
<p>「やった！テストが全部通りました！」素晴らしいですね。接続判定の基本機能が実装できました。</p>
<h3 id="_69">テスト: ぷよの消去と落下<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>次に、ぷよの消去と落下処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __tests__/Stage.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの消去と落下&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;消去対象のぷよを消去する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">CONFIG</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 消去実行</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ぷよが消去されていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;消去後、上にあるぷよが落下する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">CONFIG</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="c1">// 赤ぷよの2×2と、その上に青ぷよが2つ</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  ← 8行目</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  ← 9行目</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0  ← 10行目（赤ぷよ、消去される）</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0  ← 11行目（赤ぷよ、消去される）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 落下処理</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">fall</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 上にあった青ぷよが落下していることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、消去対象のぷよが正しく消去されることと、消去後に上にあるぷよが落下することをテストしています。</p>
<h3 id="_70">実装: ぷよの消去と落下<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」では、消去と落下の処理を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Stage.ts（続き）</span>
<span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}[])</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 消去対象のぷよを消去</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">info</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">info</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">info</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// -1は空を表す</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">fall</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 下から上に向かって処理</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 現在のぷよの下が空いている場合、落下させる</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fallY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="nx">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">fallY</span><span class="p">][</span><span class="nx">x</span><span class="p">];</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">fallY</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">          </span><span class="nx">fallY</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。消去処理は対象のマスを <code>-1</code>（空）にするだけです。落下処理は、下から上に向かって各列を処理し、ぷよがある場合はその下が空いていれば落下させます。</p>
<h3 id="_71">解説: ぷよの消去と落下<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>ぷよの消去と落下処理では、以下のことを行っています：</p>
<ol>
<li><strong>消去処理（<code>eraseBoards</code> メソッド）</strong>：</li>
<li>消去対象のぷよをボード上から消去（<code>-1</code> を設定）</li>
<li>
<p>シンプルなループで実装</p>
</li>
<li>
<p><strong>落下処理（<code>fall</code> メソッド）</strong>：</p>
</li>
<li>下から上に向かって各列をスキャン</li>
<li>ぷよがある場合、その下が空いていれば落下</li>
<li><code>while</code> ループで一番下まで落とす</li>
</ol>
<p>「なぜ下から上に向かって処理するんですか？」良い質問ですね！下から処理することで、一度の処理ですべてのぷよを正しい位置まで落とせます。上から処理すると、同じぷよを何度も動かす必要が出てきてしまいます。</p>
<h3 id="_72">テスト実行<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>「テストは通りましたか？」では、テストを実行してみましょう。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>Stage.test.ts
</code></pre></div>
<p><strong>実行結果：</strong></p>
<div class="highlight"><pre><span></span><code> PASS  __tests__/Stage.test.ts
  Stage
    ステージの初期化
      ✓ ステージを初期化できる (2 ms)
    ぷよの設定と取得
      ✓ ぷよを設定できる (1 ms)
      ✓ ぷよを取得できる (1 ms)
      ✓ 範囲外の座標では-1を返す (1 ms)
    ぷよの接続判定
      ✓ 同じ色のぷよが4つつながっていると、消去対象になる (2 ms)
      ✓ 異なる色のぷよは消去対象にならない (1 ms)
      ✓ 3つ以下のつながりは消去対象にならない (1 ms)
    ぷよの消去と落下
      ✓ 消去対象のぷよを消去する (1 ms)
      ✓ 消去後、上にあるぷよが落下する (2 ms)

Test Suites: 1 passed, 1 total
Tests:       9 passed, 9 total
</code></pre></div>
<p>「やった！全部のテストが通りました！」素晴らしいですね。これで消去と落下の機能が実装できました。</p>
<h3 id="_73">実装: ゲームループとの統合<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>「消去機能ができたので、ゲームループに組み込みましょう！」そうですね。Game クラスの <code>update</code> メソッドを修正して、消去判定と消去処理を組み込みます。</p>
<p>まず、Game クラスに新しいモードを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.ts（型定義を更新）</span>
<span class="kr">type</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="p">;</span>
</code></pre></div>
<p>次に、<code>update</code> メソッドに消去処理を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.ts（続き）</span>
<span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// モードに応じた処理</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">();</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// プレイ中の処理</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">updateWithDelta</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 着地したら重力チェックに移行</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 重力を適用</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasFallen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ぷよが落下した場合、falling モードへ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 落下するぷよがない場合、消去チェックへ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 落下アニメーション用（簡略化のため、すぐに checkFall に戻る）</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、次のぷよを出す</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 消去アニメーション用（簡略化のため、すぐに checkFall に戻る）</span>
<span class="w">      </span><span class="c1">// 消去後の重力適用</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームの流れがどう変わったんですか？」良い質問ですね！ゲームフローは以下のように拡張されました：</p>
<p><strong>新しいゲームフロー：</strong></p>
<div class="highlight"><pre><span></span><code>newPuyo → playing → (着地) → checkFall → (重力適用) →
  ├─ 落下した → falling → checkFall
  └─ 落下なし → checkErase →
      ├─ 消去あり → erasing → checkFall（消去後の重力適用）
      └─ 消去なし → newPuyo
</code></pre></div>
<p>このフローにより、以下が実現されます：</p>
<ol>
<li><strong>着地後の重力適用</strong>：ぷよが着地したら、まず重力を適用して浮いているぷよを落とす</li>
<li><strong>消去判定</strong>：重力適用後、落下するぷよがなくなったら消去判定</li>
<li><strong>消去処理</strong>：4 つ以上つながったぷよがあれば消去</li>
<li><strong>消去後の重力適用</strong>：消去後、再び重力を適用（これが連鎖の基礎になる）</li>
</ol>
<h3 id="_74">テスト: ゲームループとの統合<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>「全体が正しく動作するかをテストしたいです！」では、Game クラスの統合テストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __tests__/Game.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの消去&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;4つ以上つながったぷよは消去される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// ステージに赤ぷよ4つを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// checkErase モードに設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 消去判定と処理</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// erasing モードに移行していることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;erasing&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ぷよが消去されていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;消去後は重力チェックに移行する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// ステージに赤ぷよ4つを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// checkErase モードに設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 消去判定と処理</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkErase → erasing</span>

<span class="w">    </span><span class="c1">// erasing → checkFall に移行</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// checkFall モードに移行していることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;checkFall&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「統合テストでは、ゲーム全体の流れが正しく動作するかをテストしているんですね！」その通りです！</p>
<h3 id="_75">テスト実行（全体）<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>「全部のテストを実行してみましょう！」では、すべてのテストを実行します。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p><strong>実行結果：</strong></p>
<div class="highlight"><pre><span></span><code> PASS  __tests__/Stage.test.ts
 PASS  __tests__/Player.test.ts
 PASS  __tests__/Game.test.ts

Test Suites: 3 passed, 3 total
Tests:       34 passed, 34 total
Snapshots:   0 total
Time:        2.945 s
</code></pre></div>
<p>「やった！全部のテストが通りました！」素晴らしいですね。これで消去機能が完全に動作するようになりました。</p>
<h3 id="_76">動作確認<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>「実際に動かしてみたいです！」では、Expo で実行してみましょう。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>start
</code></pre></div>
<p>スマートフォンまたはエミュレーターでアプリを開いて、同じ色のぷよを 4 つつなげてみてください。ぷよが消去されるはずです！</p>
<h3 id="_77">リファクタリング<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>「コードは十分シンプルなので、今回はリファクタリングは必要なさそうですね。」そうですね。追加したコードは既存の構造に自然に溶け込んでいるので、特にリファクタリングの必要はありません。</p>
<h3 id="_78">コミット<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>「良いタイミングでコミットしましょう！」そうですね。機能が完成してテストも通ったので、コミットします。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: Implement puyo erase feature</span>

<span class="s2">- Add EraseInfo interface for erase information</span>
<span class="s2">- Add checkErase method (DFS algorithm for connected puyo detection)</span>
<span class="s2">- Add searchConnectedPuyo method (recursive DFS search)</span>
<span class="s2">- Add eraseBoards method to remove puyo from field</span>
<span class="s2">- Add fall method for gravity after erase</span>
<span class="s2">- Add checkErase and erasing modes to game loop</span>
<span class="s2">- Game flow: landing → gravity → erase → gravity → new puyo</span>
<span class="s2">- Add tests for connected puyo detection (3 tests)</span>
<span class="s2">- Add tests for erase and fall (2 tests)</span>
<span class="s2">- Add integration tests for game loop (2 tests)</span>
<span class="s2">- All 34 tests passing</span>

<span class="s2">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s2">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;&quot;</span>
</code></pre></div>
<h3 id="6_1">イテレーション 6 のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、ぷよの消去機能を実装しました。以下がイテレーション 6 で実施した内容のまとめです：</p>
<p><strong>実装した機能：</strong></p>
<ul>
<li>✅ 接続判定機能</li>
<li><code>EraseInfo</code> インターフェース：消去対象の情報を表現</li>
<li><code>checkErase()</code> メソッド：4 つ以上つながったぷよを検出</li>
<li><code>searchConnectedPuyo()</code> メソッド：深さ優先探索で接続ぷよを探索</li>
<li>✅ 消去処理機能</li>
<li><code>eraseBoards()</code> メソッド：消去対象のぷよを削除</li>
<li><code>fall()</code> メソッド：消去後の落下処理</li>
<li>✅ ゲームループとの統合</li>
<li><code>checkErase</code> モード：消去判定を実行</li>
<li><code>erasing</code> モード：消去アニメーション後、重力チェックへ</li>
<li>ゲームフローの拡張：着地 → 重力 → 消去 → 重力 → 次のぷよ</li>
<li>✅ テストの追加</li>
<li>ぷよの接続判定（3 テスト）</li>
<li>ぷよの消去と落下（2 テスト）</li>
<li>ゲームループ統合（2 テスト）</li>
<li>合計 34 テストすべて成功</li>
</ul>
<p><strong>学んだこと：</strong></p>
<ol>
<li><strong>深さ優先探索（DFS）アルゴリズム</strong>:</li>
<li>再帰的な探索処理</li>
<li><code>checked</code> 配列による重複チェック回避</li>
<li>
<p>接続しているすべての要素の列挙</p>
</li>
<li>
<p><strong>ゲームモードによる状態管理</strong>:</p>
</li>
<li><code>checkErase</code> と <code>erasing</code> モードの追加</li>
<li>モード間の遷移による複雑な処理の分割</li>
<li>
<p>連鎖の基礎となるフロー設計</p>
</li>
<li>
<p><strong>消去と重力の連携処理</strong>:</p>
</li>
<li>消去後の重力適用が連鎖を生む</li>
<li><code>erasing → checkFall</code> の循環</li>
<li>
<p>ゲームフローの拡張性</p>
</li>
<li>
<p><strong>テスト駆動開発の実践</strong>:</p>
</li>
<li>Red-Green-Refactor サイクル</li>
<li>視覚的なコメントによるテストの可読性向上</li>
<li>単体テストと統合テストの組み合わせ</li>
</ol>
<p><strong>次のステップ：</strong></p>
<p>次のイテレーションでは、連鎖反応を実装していきます。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」機能を追加します。</p>
<blockquote>
<p>最良のアーキテクチャ、要求、設計は、自己組織的なチームから生み出されます。</p>
<p>— アジャイルソフトウェア開発宣言</p>
</blockquote>
<h2 id="7">イテレーション 7: 連鎖反応の実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装していきましょう！</p>
<h3 id="_79">ユーザーストーリー<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p><strong>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</strong></p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="todo_6">TODO リスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p><strong>やること：</strong></p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 連鎖判定を実装する（ぷよが消えた後に新たな消去パターンがあるかを判定する）</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームループの動作確認（既存のゲームループが連鎖を実現しているかテストする）</li>
</ul>
<p>「あれ？タスクが少ないですね？」実は、イテレーション 6 で実装したゲームループの仕組みが、既に連鎖反応を実現している可能性があるんです。まずはテストを書いて確認してみましょう！</p>
<h3 id="_80">テスト: 連鎖判定<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、連鎖判定をテストしましょう。ぷよが消えて落下した後に、新たな消去パターンが発生するかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __tests__/Game.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;連鎖反応&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 初期化</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームのステージにぷよを配置</span>
<span class="w">    </span><span class="c1">// 赤ぷよの2×2と、その上に青ぷよが縦に3つ、さらに青ぷよが1つ横に</span>
<span class="w">    </span><span class="c1">// 視覚的な配置：</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  ← 7行目（青ぷよ）</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  ← 8行目（青ぷよ）</span>
<span class="w">    </span><span class="c1">// 0 0 2 0 0 0  ← 9行目（青ぷよ）</span>
<span class="w">    </span><span class="c1">// 0 1 1 2 0 0  ← 10行目（赤ぷよ + 青ぷよ）</span>
<span class="w">    </span><span class="c1">// 0 1 1 0 0 0  ← 11行目（赤ぷよ）</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 赤</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 青（横）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">7</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span><span class="w">  </span><span class="c1">// 青（上）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span><span class="w">  </span><span class="c1">// 青（上）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span><span class="w">  </span><span class="c1">// 青（上）</span>

<span class="w">    </span><span class="c1">// checkErase モードに設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 1回目の消去判定と消去実行</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkErase → erasing</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;erasing&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去後の重力チェック</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// erasing → checkFall</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;checkFall&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 重力適用（青ぷよが落下）</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkFall → falling（落下あり）</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;falling&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 落下アニメーション</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// falling → checkFall</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;checkFall&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 落下完了まで繰り返し</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">iterations</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="nx">iterations</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// checkErase モードに到達している</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;checkErase&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 2回目の消去判定（連鎖）</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chainEraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 連鎖が発生していることを確認（青ぷよが4つつながっている）</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">chainEraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のシナリオを確認しています：</p>
<ol>
<li><strong>初期配置</strong>：赤ぷよ 4 つ（2×2）と青ぷよ 4 つ（縦 3 + 横 1）を配置</li>
<li><strong>1 回目の消去</strong>：赤ぷよの正方形が消える</li>
<li><strong>重力適用</strong>：上にあった青ぷよが落下</li>
<li><strong>落下完了</strong>：すべての青ぷよが落下し終わるまで重力適用を繰り返す</li>
<li><strong>2 回目の消去判定</strong>：落下した青ぷよが 4 つつながり、連鎖が発生</li>
</ol>
<p>「なるほど、連鎖の仕組みがテストで表現されているんですね！」そうです！このテストは、ぷよぷよの連鎖の基本的な仕組みを表現しています。</p>
<h3 id="_81">テスト実行<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>「テストは通りますか？」では、テストを実行してみましょう。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>Game.test.ts
</code></pre></div>
<p><strong>実行結果：</strong></p>
<div class="highlight"><pre><span></span><code> PASS  __tests__/Game.test.ts
  Game
    ゲームの初期化
      ✓ ゲームを初期化できる (3 ms)
    ぷよの生成
      ✓ 新しいぷよが生成される (2 ms)
    ぷよの着地
      ✓ ぷよが着地したら次のぷよが出る (2 ms)
    高速落下
      ✓ startFastDropを呼ぶと高速落下が有効になる (1 ms)
      ✓ stopFastDropを呼ぶと高速落下が無効になる (1 ms)
      ✓ 高速落下中はぷよが速く落ちる (2 ms)
    ぷよの消去
      ✓ 4つ以上つながったぷよは消去される (2 ms)
      ✓ 消去後は重力チェックに移行する (1 ms)
    連鎖反応
      ✓ ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する (3 ms)

Test Suites: 1 passed, 1 total
Tests:       9 passed, 9 total
</code></pre></div>
<p>「やった！テストが通りました！」素晴らしいですね。<strong>新しいコードを一行も追加せずに</strong>、テストが通りました！</p>
<h3 id="_82">実装: 連鎖判定<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>「え？実装はしないんですか？」実は、イテレーション 6 で実装したゲームループの仕組みが、既に連鎖反応を実現しているんです！</p>
<p>「本当ですか？」はい。ゲームループの実装を振り返ってみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/Game.ts の update メソッド</span>
<span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// モードに応じた処理</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 新しいぷよを作成</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">();</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// プレイ中の処理</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">updateWithDelta</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// 着地したら重力チェックに移行</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">hasLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 重力を適用</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFallen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasFallen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ぷよが落下した場合、falling モードへ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 落下するぷよがない場合、消去チェックへ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 落下アニメーション用（簡略化のため、すぐに checkFall に戻る）</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がある場合、消去処理へ</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、次のぷよを出す</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// 消去アニメーション用（簡略化のため、すぐに checkFall に戻る）</span>
<span class="w">      </span><span class="c1">// 消去後の重力適用</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このゲームループの何が連鎖反応を実現しているんですか？」重要なのは、<strong><code>erasing</code> モード後に <code>checkFall</code> に戻る</strong>という点です。連鎖が発生する流れを見てみましょう：</p>
<h3 id="_83">連鎖の流れ<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p><strong>1. 1 回目の消去：</strong></p>
<div class="highlight"><pre><span></span><code>checkErase → ぷよが消去される → erasing → checkFall
</code></pre></div>
<p><strong>2. 重力適用：</strong></p>
<div class="highlight"><pre><span></span><code>checkFall → 上のぷよが落下 → falling → checkFall → 落下完了 → checkErase
</code></pre></div>
<p><strong>3. 2 回目の消去（連鎖）：</strong></p>
<div class="highlight"><pre><span></span><code>checkErase → 落下後に新しい消去パターン発見 → erasing → checkFall
</code></pre></div>
<p><strong>4. 連鎖終了：</strong></p>
<div class="highlight"><pre><span></span><code>checkFall → 落下なし → checkErase → 消去なし → newPuyo
</code></pre></div>
<p>「つまり、<code>erasing → checkFall → checkErase</code> のサイクルが連鎖を作っているんですね！」そのとおりです！このサイクルが、消去対象がなくなるまで繰り返されることで、連鎖反応が実現されています。</p>
<h3 id="_84">解説: 連鎖反応の仕組み<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>連鎖反応が自然に発生する理由：</p>
<ol>
<li><strong>消去後の重力適用</strong>：</li>
<li><code>erasing</code> モードから <code>checkFall</code> モードに遷移</li>
<li>ステージ上のぷよに重力を適用</li>
<li>
<p>浮いているぷよが落下</p>
</li>
<li>
<p><strong>落下後の消去判定</strong>：</p>
</li>
<li>重力適用後、<code>checkErase</code> モードに遷移</li>
<li>新たな消去パターンをチェック</li>
<li>
<p>4 つ以上つながったぷよがあれば再び消去</p>
</li>
<li>
<p><strong>サイクルの繰り返し</strong>：</p>
</li>
<li>消去対象がある限り <code>erasing → checkFall → checkErase</code> を繰り返す</li>
<li>消去対象がなくなったら <code>newPuyo</code> モードに遷移</li>
</ol>
<p>「単純な状態遷移の組み合わせで、連鎖という複雑な挙動が生まれるんですね！」そうです！これが<strong>シンプルな設計の力</strong>です。</p>
<h3 id="_85">テスト実行（全体）<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>「全部のテストを実行してみましょう！」では、すべてのテストを実行します。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p><strong>実行結果：</strong></p>
<div class="highlight"><pre><span></span><code> PASS  __tests__/Stage.test.ts
 PASS  __tests__/Player.test.ts
 PASS  __tests__/Game.test.ts

Test Suites: 3 passed, 3 total
Tests:       35 passed, 35 total
Snapshots:   0 total
Time:        2.987 s
</code></pre></div>
<p>「やった！全部のテストが通りました！」素晴らしいですね。連鎖機能が完全に動作するようになりました。</p>
<h3 id="_86">動作確認<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>「実際に動かしてみたいです！」では、Expo で実行してみましょう。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>start
</code></pre></div>
<p>スマートフォンまたはエミュレーターでアプリを開いて、連鎖が起こるようにぷよを配置してみてください。連鎖が発生するはずです！</p>
<p><strong>連鎖のセットアップ例：</strong></p>
<ol>
<li>まず、赤ぷよを 2×2 の正方形に配置</li>
<li>その上の列（同じ x 座標）に青ぷよを 3 つ縦に配置</li>
<li>赤ぷよの正方形の隣に青ぷよを 1 つ配置</li>
<li>赤ぷよが消えると、青ぷよが落下して 4 つつながり、連鎖が発生！</li>
</ol>
<h3 id="_87">コミット<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<p>「良いタイミングでコミットしましょう！」そうですね。機能が確認できてテストも通ったので、コミットします。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;test: Verify chain reaction functionality</span>

<span class="s2">- Add test for chain reaction (puyo erase → fall → new erase pattern)</span>
<span class="s2">- Verify existing game loop naturally implements chain reactions</span>
<span class="s2">- Game flow: erasing → checkFall → checkErase creates chain cycle</span>
<span class="s2">- No new code needed - existing architecture supports chains</span>
<span class="s2">- All 35 tests passing</span>

<span class="s2">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s2">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;&quot;</span>
</code></pre></div>
<h3 id="7_1">イテレーション 7 のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、連鎖反応について学びました。以下がイテレーション 7 で実施した内容のまとめです：</p>
<p><strong>確認した機能：</strong></p>
<ul>
<li>✅ 連鎖反応のテスト</li>
<li>ぷよ消去 → 落下 → 新たな消去パターンの検証</li>
<li>ゲームモードの遷移を追跡</li>
<li>連鎖が自然に発生することを確認</li>
<li>✅ 既存実装の検証</li>
<li><strong>新しいコードを追加せずにテストが通過</strong></li>
<li>イテレーション 6 のゲームループが連鎖を実現</li>
<li>シンプルな設計の威力を実証</li>
</ul>
<p><strong>学んだこと：</strong></p>
<ol>
<li><strong>連鎖反応はゲームループの構造から生まれる</strong>:</li>
<li><code>erasing → checkFall → checkErase</code> のサイクルが連鎖を実現</li>
<li>消去対象がなくなるまで自動的に繰り返される</li>
<li>
<p>複雑なロジックを追加する必要がない</p>
</li>
<li>
<p><strong>テストファースト開発の利点</strong>:</p>
</li>
<li>テストを先に書くことで、既存実装の動作を確認できた</li>
<li>新しいコードを追加せずに、テストだけで機能の動作を検証</li>
<li>
<p>設計の良さを証明する手段としてのテスト</p>
</li>
<li>
<p><strong>シンプルな設計の力</strong>:</p>
</li>
<li>複雑な連鎖ロジックを追加せずに、既存の状態遷移だけで実現</li>
<li>各モードが単一責任を持つことで、組み合わせが自然に連鎖を生む</li>
<li>
<p>SOLID 原則の実践例</p>
</li>
<li>
<p><strong>状態遷移による複雑な挙動の実現</strong>:</p>
</li>
<li>シンプルな状態遷移の組み合わせ</li>
<li>予期しない挙動の発見</li>
<li>アーキテクチャの健全性の指標</li>
</ol>
<p><strong>テスト駆動開発（TDD）の教訓：</strong></p>
<p>このイテレーションは、TDD の重要な教訓を示しています：</p>
<blockquote>
<p>「テストを先に書くことで、既存のコードが期待通りに動作することを確認できる。新しい機能を実装する前に、まず要件をテストとして表現し、既存の実装がそれを満たしているかを検証する。」</p>
</blockquote>
<p>「新しいコードを書かなくても機能が実現されているって、すごいですね！」そうですね！これは、前のイテレーションで良い設計をしていた証拠です。各モードが明確な責任を持ち、適切に連携することで、自然に複雑な挙動が生まれました。</p>
<p><strong>次のステップ：</strong></p>
<p>次のイテレーションでは、さらにゲーム体験を向上させる機能を実装していきます。連鎖カウントやスコア計算など、プレイヤーにフィードバックを提供する機能を追加します。</p>
<blockquote>
<p>単純さこそが、究極の洗練である。</p>
<p>— レオナルド・ダ・ヴィンチ</p>
</blockquote>
<h2 id="8">イテレーション8: 全消しボーナスの実装<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>「連鎖ができるようになったけど、ぷよぷよには全消しボーナスもありますよね？」そうですね！ぷよぷよには、盤面上のぷよをすべて消すと得られる「全消し（ぜんけし）ボーナス」という特別な報酬があります。今回は、その全消しボーナスを実装していきましょう！</p>
<h3 id="_88">ユーザーストーリー<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、盤面上のぷよをすべて消したときに全消しボーナスを獲得できる</p>
</blockquote>
<p>「やった！全部消えた！」という達成感と共に、特別なボーナスポイントを獲得できる機能を実装します。これにより、プレイヤーは全消しを狙った戦略を考えるようになりますね。</p>
<h3 id="todo_7">TODO リスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「全消しボーナスを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>全消し判定を実装する（盤面上のぷよがすべて消えたかどうかを判定する）</li>
<li>全消しボーナスの計算を実装する（全消し時に加算するボーナス点を計算する）</li>
<li>全消しフラグを管理する（全消し時に特別な演出を表示するためのフラグ）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_89">テスト: 全消し判定<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、全消し判定をテストしましょう。盤面上のぷよがすべて消えたかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/__tests__/Stage.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;全消し判定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;盤面上のぷよがすべて消えると全消しになる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">stageWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stageHeight</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span><span class="p">,</span>
<span class="w">      </span><span class="nx">puyoColors</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 全消し判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkZenkeshi</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 全消しになっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">isZenkeshi</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;盤面上にぷよが残っていると全消しにならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">stageWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stageHeight</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span><span class="p">,</span>
<span class="w">      </span><span class="nx">puyoColors</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 消えないぷよ</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 全消し判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkZenkeshi</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 全消しになっていないことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">isZenkeshi</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の 2 つのケースを確認しています：</p>
<ol>
<li>盤面上のぷよがすべて消えた場合、全消しと判定されるか</li>
<li>盤面上にぷよが残っている場合、全消しと判定されないか</li>
</ol>
<p>「最初のテストでは、2×2 の正方形に赤ぷよを配置して、それらが消えた後に全消しになるんですね？」そうです！最初のテストでは、2×2 の正方形に赤ぷよを配置し、それらが消去された後に盤面が空になるので、全消しと判定されるはずです。</p>
<p>「2 つ目のテストでは、消えないぷよが残るようにしているんですね？」その通りです！2 つ目のテストでは、2×2 の正方形に赤ぷよを配置した上で、別の場所に青ぷよを 1 つ配置しています。赤ぷよは消えますが、青ぷよは消えないので、全消しにはならないはずです。</p>
<p>「なるほど、全消し判定の条件がよく分かりますね！」では、このテストが通るように実装していきましょう。</p>
<h3 id="_90">実装: 全消し判定<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、全消し判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Stage.ts（続き）</span>
<span class="k">public</span><span class="w"> </span><span class="nx">checkZenkeshi</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 盤面上にぷよがあるかチェック</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。全消し判定の実装自体はとてもシンプルです。盤面上のすべてのマスを順番にチェックし、ぷよがある（値が -1 でない）マスが見つかった時点で <code>false</code> を返します。すべてのマスをチェックして、ぷよが見つからなければ <code>true</code> を返します。</p>
<p>「二重ループを使って、すべてのマスをチェックしているんですね！」その通りです！外側のループで行（y 座標）を、内側のループで列（x 座標）を順番にチェックしています。これにより、盤面上のすべてのマスを効率的にチェックできます。</p>
<h3 id="_91">解説: 全消し判定<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h3>
<p>全消し判定では、以下のことを行っています：</p>
<ol>
<li>盤面上のすべてのマスをチェック</li>
<li>ぷよがある（値が -1 でない）マスがあれば全消しではない</li>
<li>すべてのマスが空（値が -1）であれば全消し</li>
</ol>
<p>「全消し判定はいつ行われるんですか？」良い質問ですね！全消し判定は、ぷよの消去処理後に行われます。ぷよが消えた後、盤面上にぷよが残っていないかをチェックするんです。</p>
<p>「テストは通りましたか？」はい、これでテストは通るはずです！次は、全消しボーナスのスコア管理を実装していきましょう。</p>
<h3 id="_92">テスト: 全消しボーナス<a class="headerlink" href="#_92" title="Permanent link">&para;</a></h3>
<p>「全消しボーナスはどのようにテストすればいいですか？」全消しボーナスは、全消し時に特別なボーナス点が加算されることをテストする必要があります。まずは、ゲームモデルに全消しフラグを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/__tests__/Game.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;全消しボーナス&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">game</span><span class="o">:</span><span class="w"> </span><span class="kt">Game</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockCanvasContext</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">;</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mockCanvasContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createMockCanvasContext</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">stageWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stageHeight</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span><span class="p">,</span>
<span class="w">      </span><span class="nx">puyoColors</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">mockCanvasContext</span><span class="p">);</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;盤面上のぷよをすべて消すと全消しフラグが立つ&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// 盤面に 4 つのぷよを配置（すべて消去される）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// checkErase モードに設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 消去判定と処理</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkErase → erasing（消去実行）</span>

<span class="w">    </span><span class="c1">// 消去後の重力チェック</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// erasing → checkFall</span>

<span class="w">    </span><span class="c1">// 重力適用（落下なし）</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkFall → checkErase</span>

<span class="w">    </span><span class="c1">// 2 回目の消去判定（全消し判定が実行される）</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkErase → newPuyo（全消しフラグ確認）</span>

<span class="w">    </span><span class="c1">// 全消しフラグが立っていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">isZenkeshi</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;盤面にぷよが残っている場合、全消しフラグは立たない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// 盤面にぷよを配置（一部だけ消去される）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 消えないぷよ</span>

<span class="w">    </span><span class="c1">// checkErase モードに設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 消去判定と処理</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkErase → erasing</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// erasing → checkFall</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkFall → checkErase</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// checkErase → newPuyo</span>

<span class="w">    </span><span class="c1">// 全消しフラグが立っていないことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">isZenkeshi</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のことを確認しています：</p>
<ol>
<li>盤面上のぷよがすべて消えた場合、全消しフラグが立つか</li>
<li>盤面上にぷよが残っている場合、全消しフラグが立たないか</li>
</ol>
<p>「全消しフラグって何ですか？」良い質問ですね！全消しフラグは、全消しが発生したことを記録しておくための変数です。このフラグを使って、後でスコアにボーナスを加算したり、特別な演出を表示したりすることができます。</p>
<h3 id="_93">実装: 全消しフラグ管理<a class="headerlink" href="#_93" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Game.ts（続き）</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">Stage</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">player</span><span class="o">:</span><span class="w"> </span><span class="kt">Player</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">GameMode</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">dropTimer</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">zenkeshi</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// 全消しフラグ</span>

<span class="w">  </span><span class="c1">// ... 省略 ...</span>

<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="nx">isZenkeshi</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">zenkeshi</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">handleCheckErase</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkErase</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">erasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">eraseBoards</span><span class="p">(</span><span class="nx">eraseInfo</span><span class="p">.</span><span class="nx">eraseInfo</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 消去対象がない場合、全消し判定</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">checkZenkeshi</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">zenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// 全消しフラグを立てる</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「全消しフラグを追加して、checkErase モードで全消し判定を行うようにしたんですね！」そうです。消去対象がない場合（これ以上消せるぷよがない場合）に、盤面が空かどうかをチェックして、空であれば全消しフラグを立てるようにしました。</p>
<h3 id="_94">解説: 全消しボーナス<a class="headerlink" href="#_94" title="Permanent link">&para;</a></h3>
<p>全消しフラグ管理では、以下のことを行っています：</p>
<ol>
<li>全消しフラグの初期化（<code>zenkeshi = false</code>）</li>
<li><code>checkErase</code> モードで消去対象がない場合に全消し判定を実行</li>
<li>盤面が空であれば全消しフラグを立てる（<code>zenkeshi = true</code>）</li>
<li>外部から全消しフラグを確認できるメソッド（<code>isZenkeshi()</code>）を提供</li>
</ol>
<p>「全消しフラグはいつリセットされるんですか？」重要な質問ですね！全消しフラグは、次のぷよが生成されるタイミングでリセットする必要があります。でないと、一度全消しすると、その後ずっと全消しフラグが立ちっぱなしになってしまいます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Game.ts（続き）</span>
<span class="k">private</span><span class="w"> </span><span class="nx">handleNewPuyo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">();</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">zenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// 全消しフラグをリセット</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど！新しいゲームサイクルが始まるときに、前回の全消しフラグをリセットするんですね。」そうです。これにより、各ゲームサイクルで正しく全消し判定が行われるようになります。</p>
<h3 id="react-native-ui_1">React Native UI での全消しボーナス表示<a class="headerlink" href="#react-native-ui_1" title="Permanent link">&para;</a></h3>
<p>「全消しになったことをプレイヤーに伝える方法はありますか？」良い質問ですね！全消しが発生したときに、画面上に「全消し！」というメッセージを表示すると、プレイヤーは達成感を得られます。React Native コンポーネントで実装してみましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx（続き）</span>
<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">zenkeshi</span><span class="p">,</span><span class="w"> </span><span class="nx">setZenkeshi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">16.67</span><span class="p">);</span><span class="w"> </span><span class="c1">// 約 60fps</span>

<span class="w">      </span><span class="c1">// 全消しフラグをチェック</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">isZenkeshi</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setZenkeshi</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// 2 秒後にメッセージを非表示</span>
<span class="w">        </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setZenkeshi</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span><span class="w"> </span><span class="mf">2000</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">gameLoop</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">gameLoop</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">animationFrameId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="nx">animationFrameId</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">},</span><span class="w"> </span><span class="p">[]);</span>

<span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">GLView</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">canvas</span><span class="p">}</span><span class="w"> </span><span class="nx">onContextCreate</span><span class="o">=</span><span class="p">{</span><span class="nx">onContextCreate</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>

<span class="w">    </span><span class="p">{</span><span class="nx">zenkeshi</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">zenkeshiOverlay</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">zenkeshiText</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">全消し</span><span class="err">！</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">bonusText</span><span class="p">}</span><span class="o">&gt;+</span><span class="mf">3600</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="p">)}</span>

<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">controls</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* ... ボタン ... */</span><span class="p">}</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="c1">// ... 既存のスタイル ...</span>

<span class="w">  </span><span class="nx">zenkeshiOverlay</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">position</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30%&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rgba(0, 0, 0, 0.7)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">margin</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">zenkeshiText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">48</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#FFD700&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">textShadowColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">textShadowOffset</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">textShadowRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">bonusText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#FFF&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">});</span>
</code></pre></div>
<p>「全消しメッセージが 2 秒間表示されるんですね！」そうです。<code>useState</code> で全消しフラグを管理し、全消しが発生したときにメッセージを表示して、2 秒後に自動的に非表示にします。これにより、プレイヤーは全消しを達成したことを視覚的に確認できます。</p>
<h3 id="_95">テスト実行<a class="headerlink" href="#_95" title="Permanent link">&para;</a></h3>
<p>「テストを実行してみましょう！」そうですね。全てのテストが通ることを確認します。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>テストが全て通れば、全消しボーナス機能の実装は完了です！</p>
<h3 id="8_1">イテレーション 8 のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>全消し判定の実装</strong>：</li>
<li>二重ループでフィールド全体をスキャン</li>
<li>ぷよが 1 つでも残っていれば全消しではない</li>
<li>
<p>シンプルなロジックで確実な判定を実現</p>
</li>
<li>
<p><strong>全消しフラグ管理</strong>：</p>
</li>
<li>全消しが発生したことを記録するフラグ</li>
<li><code>checkErase</code> モードで全消し判定を実行</li>
<li><code>newPuyo</code> モードでフラグをリセット</li>
<li>
<p>外部から状態を確認できるインターフェース</p>
</li>
<li>
<p><strong>React Native UI での全消しメッセージ表示</strong>：</p>
</li>
<li><code>useState</code> で全消しフラグを管理</li>
<li>全消し発生時にオーバーレイメッセージを表示</li>
<li>2 秒後に自動的にメッセージを非表示</li>
<li>
<p>視覚的なフィードバックでプレイヤーに達成感を提供</p>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
</li>
<li>全消しになるケースとならないケースの両方をテスト</li>
<li>境界条件（空の盤面、1 つだけ残る）を確認</li>
<li>実装前にテストで仕様を明確化</li>
<li>
<p>統合テストで全体の動作を保証</p>
</li>
<li>
<p><strong>ゲームループとの統合</strong>：</p>
</li>
<li><code>checkErase</code> モードで消去対象がない場合に全消し判定</li>
<li>既存の状態遷移に自然に組み込む</li>
<li>フラグのライフサイクル管理</li>
</ol>
<p>このイテレーションで、全消しボーナスという特別な報酬システムが実装できました。次のイテレーションでは、ゲームの終了条件となるゲームオーバー判定を実装していきます！</p>
<h3 id="_96">コミットメッセージ<a class="headerlink" href="#_96" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>feat: 全消しボーナス機能を実装

- Stage に全消し判定メソッド (checkZenkeshi) を追加
- Game に全消しフラグ管理を実装
- checkErase モードで全消し判定を実行
- React Native UI に全消しメッセージ表示を追加
- 全消しボーナスのテストを追加

すべてのテストが通過することを確認済み

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;
</code></pre></div>
<h2 id="9">イテレーション9: ゲームオーバーの実装<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>「ゲームが終わる条件も必要ですよね？」そうですね！どんなゲームにも終わりがあります。ぷよぷよでは、新しいぷよを配置できなくなったときにゲームオーバーとなります。今回は、そのゲームオーバー判定と演出を実装していきましょう！</p>
<h3 id="_97">ユーザーストーリー<a class="headerlink" href="#_97" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。ゲームオーバーになったことを明確に伝え、適切な演出を行うことで、プレイヤーに達成感や次回への意欲を持ってもらうことができます。</p>
<h3 id="todo_8">TODO リスト<a class="headerlink" href="#todo_8" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ゲームオーバーを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出する）</li>
<li>ゲームオーバー演出を実装する（ゲームオーバー時に特別な表示や効果を追加する）</li>
<li>リスタート機能を実装する（ゲームオーバー後に新しいゲームを始められるようにする）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_98">テスト: ゲームオーバー判定<a class="headerlink" href="#_98" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバー判定をテストしましょう。新しいぷよを配置できない状態を検出する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/__tests__/Player.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ゲームオーバー判定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できない場合、ゲームオーバーになる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">stageWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stageHeight</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span><span class="p">,</span>
<span class="w">      </span><span class="nx">puyoColors</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockCanvasContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createMockCanvasContext</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">mockCanvasContext</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージの上部にぷよを配置（新しいぷよの初期位置）</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 新しいぷよの生成（通常は中央上部 x=2, y=0 に配置される）</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">checkGameOver</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できる場合、ゲームオーバーにならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">stageWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stageHeight</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span><span class="p">,</span>
<span class="w">      </span><span class="nx">puyoColors</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stage</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockCanvasContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createMockCanvasContext</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">mockCanvasContext</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ステージは空のまま</span>
<span class="w">    </span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">checkGameOver</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになっていないことを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、新しいぷよを配置できない状態がゲームオーバーと判定されるかを確認しています。具体的には：</p>
<ol>
<li>ステージの上部（新しいぷよが配置される位置）にぷよを配置します</li>
<li>新しいぷよを生成します</li>
<li>ゲームオーバー判定を行い、ゲームオーバーになっていることを確認します</li>
</ol>
<p>「なるほど、新しいぷよの配置位置にすでにぷよがあると、ゲームオーバーになるんですね！」そうです！ぷよぷよでは、新しいぷよを配置する位置（通常はステージの中央上部）にすでにぷよがある場合、これ以上ゲームを続行できないため、ゲームオーバーとなります。では、このテストが通るように実装していきましょう。</p>
<h3 id="_99">実装: ゲームオーバー判定<a class="headerlink" href="#_99" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームオーバー判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Player.ts（続き）</span>
<span class="k">public</span><span class="w"> </span><span class="nx">checkGameOver</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// 新しいぷよの配置位置にすでにぷよがあるかチェック</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">childX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">];</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">];</span>

<span class="w">  </span><span class="c1">// 軸ぷよまたは子ぷよの位置にぷよがあればゲームオーバー</span>
<span class="w">  </span><span class="c1">// getPuyo() は範囲外の場合 -1 を返すので、&gt;= 0 でチェック</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">    </span><span class="p">(</span><span class="nx">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">getPuyo</span><span class="p">(</span><span class="nx">childX</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。ゲームオーバー判定の実装自体はとてもシンプルです。<code>createNewPuyo()</code> で設定された軸ぷよの位置（<code>puyoX</code>, <code>puyoY</code>）と、回転状態に基づいて計算された子ぷよの位置（<code>childX</code>, <code>childY</code>）にすでにぷよがあるかどうかをチェックしています。</p>
<p>「なぜ <code>childY &gt;= 0</code> の条件があるんですか？」重要な質問ですね！<code>stage.getPuyo()</code> は範囲外の座標を渡されると <code>-1</code> を返します。初期状態では、軸ぷよは <code>y = 0</code>、子ぷよは上向き（<code>rotation = 0</code>）なので <code>y = -1</code>（画面外）になります。画面外にぷよはないので、<code>childY &gt;= 0</code> の場合のみチェックする必要があります。</p>
<h3 id="_100">解説: ゲームオーバー判定<a class="headerlink" href="#_100" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー判定では、以下のことを行っています：</p>
<ol>
<li>新しいぷよの配置位置（中央上部）を確認</li>
<li>その位置にすでにぷよがある場合、ゲームオーバーと判定</li>
<li>子ぷよが画面外（y &lt; 0）の場合は、そのチェックをスキップ</li>
</ol>
<p>「ゲームオーバー判定はいつ行われるんですか？」良い質問ですね！ゲームオーバー判定は、新しいぷよを生成するタイミングで行われます。新しいぷよを生成しようとしたときに、配置位置にすでにぷよがあれば、ゲームオーバーとなります。</p>
<p>「テストは通りましたか？」はい、これでテストは通るはずです！次は、ゲームループとの統合を実装していきましょう。</p>
<h3 id="_101">テスト: ゲームオーバー時の状態遷移<a class="headerlink" href="#_101" title="Permanent link">&para;</a></h3>
<p>「ゲームオーバー演出はどのようにテストすればいいですか？」ゲームオーバー演出は、ゲームの状態（モード）が変わることをテストするといいでしょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/__tests__/Game.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ゲームオーバー&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">game</span><span class="o">:</span><span class="w"> </span><span class="kt">Game</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">mockCanvasContext</span><span class="o">:</span><span class="w"> </span><span class="kt">CanvasRenderingContext2D</span><span class="p">;</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mockCanvasContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createMockCanvasContext</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">stageWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stageHeight</span><span class="o">:</span><span class="w"> </span><span class="kt">12</span><span class="p">,</span>
<span class="w">      </span><span class="nx">puyoColors</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="nx">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Game</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">mockCanvasContext</span><span class="p">);</span>
<span class="w">    </span><span class="nx">game</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できない場合、ゲームモードが gameOver に変わる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// ステージの上部にぷよを配置</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">stage</span><span class="p">.</span><span class="nx">setPuyo</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ゲームモードを設定</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ゲームループを実行</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ゲームモードが gameOver になっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;gameOver&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できる場合、ゲームモードが playing に変わる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ステージは空のまま</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ゲームループを実行</span>
<span class="w">    </span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">](</span><span class="mf">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ゲームモードが playing になっていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">game</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;playing&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、ゲームオーバー条件が満たされた場合に、ゲームの状態（モード）が <code>gameOver</code> に変わることを確認しています。具体的には：</p>
<ol>
<li>ステージの上部にぷよを配置して、ゲームオーバー条件を作ります</li>
<li>ゲームモードを <code>newPuyo</code>（新しいぷよを生成するモード）に設定します</li>
<li>ゲームループを実行します</li>
<li>ゲームモードが <code>gameOver</code> に変わっていることを確認します</li>
</ol>
<p>「なるほど、ゲームの状態遷移をテストしているんですね！」そうです！ゲームオーバーになると、ゲームの状態が変わり、それに応じた演出が行われるようになります。では、このテストが通るように実装していきましょう。</p>
<h3 id="_102">実装: ゲームループとの統合<a class="headerlink" href="#_102" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームループにゲームオーバー判定を統合していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Game.ts（続き）</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;gameOver&#39;</span><span class="p">;</span>

<span class="k">private</span><span class="w"> </span><span class="nx">handleNewPuyo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">createNewPuyo</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">checkGameOver</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;gameOver&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">zenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// 全消しフラグをリセット</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">deltaTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">handleNewPuyo</span><span class="p">();</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;playing&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">updateWithDelta</span><span class="p">(</span><span class="nx">deltaTime</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">isLanded</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">fixToStage</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">handleCheckFall</span><span class="p">();</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;falling&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">fall</span><span class="p">();</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;checkErase&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">handleCheckErase</span><span class="p">();</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;erasing&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;checkFall&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;gameOver&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// ゲームオーバー時は何もしない（ゲームを停止）</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>gameOver</code> モードでは何もしないんですね！」そうです。ゲームオーバーになったら、ゲームループは実行され続けますが、新しい処理は行われません。これにより、ゲームが停止した状態になります。</p>
<h3 id="_103">解説: ゲームオーバー時の状態遷移<a class="headerlink" href="#_103" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー時の状態遷移は以下のようになります：</p>
<ol>
<li><code>newPuyo</code> モード: 新しいぷよを生成</li>
<li>ゲームオーバー判定を実行</li>
<li>配置位置にぷよがある場合: <code>gameOver</code> モードに遷移</li>
<li>配置位置が空の場合: <code>playing</code> モードに遷移</li>
</ol>
<p>「ゲームオーバー後はどうするんですか？」良い質問ですね！ゲームオーバー後は、ゲームをリセットして再スタートできるようにする必要があります。それは React Native の UI 側で実装します。</p>
<h3 id="react-native-ui_2">React Native UI でのゲームオーバー表示<a class="headerlink" href="#react-native-ui_2" title="Permanent link">&para;</a></h3>
<p>「ゲームオーバーになったことをプレイヤーに伝える方法はありますか？」良い質問ですね！ゲームオーバーが発生したときに、画面上に「GAME OVER」というメッセージを表示すると、プレイヤーは明確にゲームの終了を認識できます。React Native コンポーネントで実装してみましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx（続き）</span>
<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">gameOver</span><span class="p">,</span><span class="w"> </span><span class="nx">setGameOver</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">gameLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mf">16.67</span><span class="p">);</span><span class="w"> </span><span class="c1">// 約 60fps</span>

<span class="w">      </span><span class="c1">// ゲームオーバーフラグをチェック</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">isGameOver</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setGameOver</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 全消しフラグをチェック</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">isZenkeshi</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setZenkeshi</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setZenkeshi</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span><span class="w"> </span><span class="mf">2000</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">gameLoop</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="nx">animationFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">gameLoop</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">animationFrameId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="nx">animationFrameId</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">},</span><span class="w"> </span><span class="p">[]);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">handleRestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">gameRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setGameOver</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">GLView</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">canvas</span><span class="p">}</span><span class="w"> </span><span class="nx">onContextCreate</span><span class="o">=</span><span class="p">{</span><span class="nx">onContextCreate</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>

<span class="w">    </span><span class="p">{</span><span class="nx">gameOver</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">gameOverOverlay</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">gameOverText</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">GAME</span><span class="w"> </span><span class="nx">OVER</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">restartButton</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">handleRestart</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">restartButtonText</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">リスタート</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="p">)}</span>

<span class="w">    </span><span class="p">{</span><span class="nx">zenkeshi</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">zenkeshiOverlay</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">zenkeshiText</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">全消し</span><span class="err">！</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">bonusText</span><span class="p">}</span><span class="o">&gt;+</span><span class="mf">3600</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="p">)}</span>

<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">controls</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* ... ボタン ... */</span><span class="p">}</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="c1">// ... 既存のスタイル ...</span>

<span class="w">  </span><span class="nx">gameOverOverlay</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">position</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">bottom</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rgba(0, 0, 0, 0.8)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">gameOverText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">64</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#FF0000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">textShadowColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">textShadowOffset</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">textShadowRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">6</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">40</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">restartButton</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#4CAF50&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">paddingHorizontal</span><span class="o">:</span><span class="w"> </span><span class="kt">40</span><span class="p">,</span>
<span class="w">    </span><span class="nx">paddingVertical</span><span class="o">:</span><span class="w"> </span><span class="kt">15</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">restartButtonText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#FFF&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">});</span>
</code></pre></div>
<p>「ゲームオーバー時に全画面オーバーレイを表示して、リスタートボタンも用意したんですね！」そうです。<code>useState</code> でゲームオーバーフラグを管理し、ゲームオーバーが発生したときにオーバーレイを表示します。リスタートボタンを押すと、ゲームがリセットされて新しいゲームを始められるようになります。</p>
<h3 id="_104">実装: ゲームリセット機能<a class="headerlink" href="#_104" title="Permanent link">&para;</a></h3>
<p>「リスタートボタンを押したときに、ゲームをリセットする機能が必要ですね！」そうです。ゲームをリセットして、新しいゲームを始められるようにしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Game.ts（続き）</span>
<span class="k">public</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;gameOver&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="nx">reset</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ステージをクリア</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// プレイヤーをリセット</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// モードをリセット</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;newPuyo&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// 全消しフラグをリセット</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">zenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// 新しいゲームを開始</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">handleNewPuyo</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>reset()</code> メソッドでは何をしているんですか？」このメソッドでは、以下のことを行っています：</p>
<ol>
<li>ステージをクリア（すべてのぷよを削除）</li>
<li>プレイヤーをリセット（ぷよの位置と状態を初期化）</li>
<li>ゲームモードを <code>newPuyo</code> にリセット</li>
<li>全消しフラグをリセット</li>
<li>新しいぷよを生成してゲームを再スタート</li>
</ol>
<p>「これで、ゲームオーバー後に新しいゲームを始められるようになったんですね！」そうです。プレイヤーは何度でもゲームに挑戦できるようになります。</p>
<h3 id="stage-player">Stage と Player のリセットメソッド<a class="headerlink" href="#stage-player" title="Permanent link">&para;</a></h3>
<p>「Stage と Player にも <code>reset()</code> メソッドが必要ですね！」そうです。それぞれのクラスに適切なリセット処理を追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Stage.ts（続き）</span>
<span class="k">public</span><span class="w"> </span><span class="nx">clear</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">field</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Player.ts（続き）</span>
<span class="k">public</span><span class="w"> </span><span class="nx">reset</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">childPuyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">landed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">fastDrop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「これで、すべてのコンポーネントが初期状態に戻るようになりましたね！」そうです。ゲーム全体が一貫した方法でリセットされるようになりました。</p>
<h3 id="_105">テスト実行<a class="headerlink" href="#_105" title="Permanent link">&para;</a></h3>
<p>「テストを実行してみましょう！」そうですね。全てのテストが通ることを確認します。</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>テストが全て通れば、ゲームオーバー機能の実装は完了です！</p>
<h3 id="9_1">イテレーション 9 のまとめ<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>ゲームオーバー判定の実装</strong>：</li>
<li>新しいぷよの配置位置にぷよがある場合を検出</li>
<li>子ぷよが画面外の場合の特別処理</li>
<li>
<p>シンプルで確実な判定ロジック</p>
</li>
<li>
<p><strong>ゲームループへの統合</strong>：</p>
</li>
<li><code>newPuyo</code> モードでゲームオーバー判定を実行</li>
<li><code>gameOver</code> モードでゲームを停止</li>
<li>
<p>既存の状態遷移に自然に組み込む</p>
</li>
<li>
<p><strong>React Native UI でのゲームオーバー表示</strong>：</p>
</li>
<li>全画面オーバーレイで明確に表示</li>
<li>リスタートボタンで再プレイ可能に</li>
<li>
<p><code>useState</code> でゲームオーバー状態を管理</p>
</li>
<li>
<p><strong>ゲームリセット機能</strong>：</p>
</li>
<li>すべてのコンポーネントを初期状態に戻す</li>
<li>一貫したリセット処理</li>
<li>
<p>何度でも新しいゲームを始められる</p>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
</li>
<li>ゲームオーバーになるケースとならないケースの両方をテスト</li>
<li>状態遷移をテストで確認</li>
<li>実装前にテストで仕様を明確化</li>
</ol>
<p>このイテレーションで、ゲームオーバー判定と演出、そしてリスタート機能が実装できました。これで、プレイヤーはゲームの明確な終了を体験し、何度でも挑戦できる完成度の高いゲームになりました！</p>
<h3 id="_106">コミットメッセージ<a class="headerlink" href="#_106" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>feat: ゲームオーバー機能を実装

- Player にゲームオーバー判定メソッド (checkGameOver) を追加
- Game にゲームオーバーモードを追加
- newPuyo モードでゲームオーバー判定を実行
- React Native UI にゲームオーバー表示とリスタートボタンを追加
- Game, Stage, Player にリセットメソッドを実装
- ゲームオーバーのテストを追加

すべてのテストが通過することを確認済み

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>