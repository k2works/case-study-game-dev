
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 - Go/Ebiten版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#-goebiten" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 - Go/Ebiten版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="-goebiten">ぷよぷよから始めるテスト駆動開発入門 - Go/Ebiten版<a class="headerlink" href="#-goebiten" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、ぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの？」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>言語</strong>: Go — 「なぜGo？」と思われるかもしれませんが、Goはシンプルで学びやすく、並行処理が得意で、クロスプラットフォーム対応も簡単な言語です。</li>
<li><strong>ゲームライブラリ</strong>: Ebiten — 「ゲームライブラリって難しそう...」と思うかもしれませんが、Ebitenはシンプルで使いやすい2Dゲームライブラリです。</li>
<li><strong>テストフレームワーク</strong>: Go標準のtestingパッケージとtestify — Goに標準で付属している強力なテストツールです。</li>
<li><strong>タスクランナー</strong>: Task — 「同じ作業の繰り返しって退屈じゃないですか？」そんな反復的なタスクを自動化してくれます。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ？昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション0: 環境の構築で解説します。</p>
<h2 id="_4">リリース計画<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>要件もわかった、プログラミング開始だ！ちょっと待ってください、何事も計画を立てる事は大事なことです。何から取り組みますか？「スコアの表示」ですか？「ゲームオーバー判定」ですか？でもまずは「新しいゲームを開始」しないとつながりとして難しいですよね。</p>
<blockquote>
<p>計画づくりとは「なにをいつまでに作ればいいのか？」という質問に答える作業だと私は考えている</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>今回の目的はぷよぷよゲームを遊べるための最小限の機能の実装です。目的を実現するためにやるべきことをイテレーションという単位でまとめましょう。今回はユーザーストーリーから以下のイテレーション計画に従ってぷよぷよゲームをリリースします。</p>
<ul>
<li>イテレーション0: 環境の構築</li>
<li>イテレーション1: ゲーム開始とボード表示の実装</li>
<li>イテレーション2: ぷよペアの表示と移動の実装</li>
<li>イテレーション3: ぷよペアの回転の実装</li>
<li>イテレーション4: ぷよの自動落下の実装</li>
<li>イテレーション5: ぷよの消去ロジックの実装</li>
<li>イテレーション6: 連鎖反応とスコアの実装</li>
<li>イテレーション7-9: ゲームオーバーと追加機能の実装</li>
</ul>
<p>では、ぷよぷよゲーム開発スタートです！</p>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>...と言いたいところですがまずは環境の構築をしなければなりません。「プログラミングなんてどの言語でやるか決めるぐらいでしょ？」と思うかもしれませんが家を建てるときにしっかりとした基礎工事が必要なように開発環境もしっかりとした準備が必要です。
家を建てた後に基礎がダメだと困ったことになりますからね。</p>
<ol>
<li><strong>バージョン管理</strong>: コードの変更履歴を記録し、必要に応じて過去の状態に戻れる</li>
<li><strong>テスティング</strong>: コードが正しく動作することを自動的に確認できる</li>
<li><strong>自動化</strong>: 繰り返し作業を自動化して、ミスを減らし効率を上げる</li>
</ol>
<p>これらの神器を使うことで、安心してコードを変更し、改善していけるんです。</p>
<h3 id="git">バージョン管理: Git<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>プロジェクトのバージョン管理には <strong>Git</strong> を使用します。「コードを変更したけど、前の状態に戻したい...」というときに役立ちます。</p>
<p>まず、プロジェクトディレクトリを作成し、Gitリポジトリを初期化しましょう：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>puyo-puyo-go
<span class="nb">cd</span><span class="w"> </span>puyo-puyo-go
git<span class="w"> </span>init
</code></pre></div>
<p><code>.gitignore</code> ファイルを作成して、バージョン管理から除外するファイルを指定します：</p>
<div class="highlight"><pre><span></span><code># Binaries
*.exe
*.exe~
*.dll
*.so
*.dylib
/puyo-puyo-go

# Test binary
*.test

# Output of the go coverage tool
*.out

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db
</code></pre></div>
<p>最初のコミットをしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.gitignore
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: プロジェクトの初期セットアップ&#39;</span>
</code></pre></div>
<h4 id="_5">コミットメッセージ規約<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>コミットメッセージは <a href="https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#type">Angularルール</a> に従います：</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
</code></pre></div>
<p>タイプは以下を使用します：</p>
<ul>
<li><code>feat</code>: 新機能</li>
<li><code>fix</code>: バグ修正</li>
<li><code>docs</code>: ドキュメント変更のみ</li>
<li><code>style</code>: コードの意味に影響しない変更</li>
<li><code>refactor</code>: 機能追加でもバグ修正でもないコード変更</li>
<li><code>test</code>: テストの追加・修正</li>
<li><code>chore</code>: ビルドプロセスや補助ツールの変更</li>
</ul>
<h3 id="go-modules">テスティング環境: Go modules<a class="headerlink" href="#go-modules" title="Permanent link">&para;</a></h3>
<p>Go言語には標準で強力なテストフレームワークが付属しています。まず、Go modulesを初期化しましょう：</p>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>mod<span class="w"> </span>init<span class="w"> </span>github.com/yourusername/puyo-puyo-go
</code></pre></div>
<p>「Go modulesって何ですか？」良い質問ですね！</p>
<blockquote>
<p>Go modulesとは、Goで記述されたサードパーティ製のライブラリを管理するためのツールで、Go modulesで扱うライブラリをmoduleと呼びます。</p>
<p>— Go公式ドキュメント</p>
</blockquote>
<p>Ebitenとtestifyをインストールします：</p>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>get<span class="w"> </span>github.com/hajimehoshi/ebiten/v2
go<span class="w"> </span>get<span class="w"> </span>github.com/stretchr/testify
</code></pre></div>
<p>これで <code>go.mod</code> ファイルが更新され、依存関係が記録されます。</p>
<h3 id="_6">自動化: コード品質の自動管理<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質を自動的にチェックし、維持していく仕組みが必要です。</p>
<h4 id="golangci-lint">静的コード解析: golangci-lint<a class="headerlink" href="#golangci-lint" title="Permanent link">&para;</a></h4>
<p>Go用の静的コード解析ツール <strong>golangci-lint</strong> を使います。まずインストールします：</p>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>install<span class="w"> </span>github.com/golangci/golangci-lint/cmd/golangci-lint@latest
</code></pre></div>
<p><strong>重要</strong>: インストール後、ツールが正しくインストールされたか確認しましょう：</p>
<div class="highlight"><pre><span></span><code>golangci-lint<span class="w"> </span>--version
<span class="c1"># 出力例: golangci-lint has version 1.xx.x built with go1.xx from ...</span>
</code></pre></div>
<p>もし「command not found」と表示される場合は、<code>$HOME/go/bin</code>（またはWindowsの場合<code>%USERPROFILE%\go\bin</code>）がPATHに追加されていることを確認してください。</p>
<p>設定ファイル <code>.golangci.yml</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="nt">run</span><span class="p">:</span>
<span class="w">  </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">  </span><span class="nt">issues-exit-code</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">tests</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">output</span><span class="p">:</span>
<span class="w">  </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">colored-line-number</span>
<span class="w">  </span><span class="nt">print-issued-lines</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">print-linter-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">linters-settings</span><span class="p">:</span>
<span class="w">  </span><span class="nt">govet</span><span class="p">:</span>
<span class="w">    </span><span class="nt">check-shadowing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">enable-all</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">gocyclo</span><span class="p">:</span>
<span class="w">    </span><span class="nt">min-complexity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span>
<span class="w">  </span><span class="nt">misspell</span><span class="p">:</span>
<span class="w">    </span><span class="nt">locale</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">US</span>
<span class="w">  </span><span class="nt">lll</span><span class="p">:</span>
<span class="w">    </span><span class="nt">line-length</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120</span>
<span class="w">  </span><span class="nt">gofmt</span><span class="p">:</span>
<span class="w">    </span><span class="nt">simplify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">goconst</span><span class="p">:</span>
<span class="w">    </span><span class="nt">min-len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">min-occurrences</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>

<span class="nt">linters</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enable</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gosimple</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">govet</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ineffassign</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">misspell</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gofmt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">goimports</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gocyclo</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">goconst</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gosec</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unconvert</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unused</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">staticcheck</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">typecheck</span>
<span class="w">  </span><span class="nt">disable</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">errcheck</span>

<span class="nt">issues</span><span class="p">:</span>
<span class="w">  </span><span class="nt">exclude-rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">_test\.go</span>
<span class="w">      </span><span class="nt">linters</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gosec</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">goconst</span>
</code></pre></div>
<p>「サイクロマティック複雑度を7に設定していますね！」そうです！</p>
<blockquote>
<p>循環的複雑度（Cyclomatic complexity、CC）は、プログラムの複雑さを測るソフトウェア測定法のひとつである。1976年にトーマス・J・マッケイブによって開発された。</p>
<p>— Wikipedia 『循環的複雑度』</p>
</blockquote>
<p>複雑度が高いとテストが書きにくく、バグが混入しやすくなります。7という値は、「これ以上複雑になったら関数を分割しましょう」という目安です。</p>
<p>静的解析を実行します：</p>
<div class="highlight"><pre><span></span><code>golangci-lint<span class="w"> </span>run
</code></pre></div>
<h4 id="gofmtgoimports">コードフォーマッタ: gofmt/goimports<a class="headerlink" href="#gofmtgoimports" title="Permanent link">&para;</a></h4>
<p>Goには標準でコードフォーマッタが付属しています：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># フォーマット実行</span>
gofmt<span class="w"> </span>-s<span class="w"> </span>-w<span class="w"> </span>.

<span class="c1"># インポート文の整理も含む</span>
goimports<span class="w"> </span>-w<span class="w"> </span>.
</code></pre></div>
<h4 id="_7">コードカバレッジ<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>テストカバレッジを確認します：</p>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-cover<span class="w"> </span>./...
go<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-coverprofile<span class="o">=</span>coverage.out<span class="w"> </span>./...
go<span class="w"> </span>tool<span class="w"> </span>cover<span class="w"> </span>-html<span class="o">=</span>coverage.out
</code></pre></div>
<h4 id="taskfile">タスクランナー: Taskfile<a class="headerlink" href="#taskfile" title="Permanent link">&para;</a></h4>
<p>複数のコマンドを管理するために <strong>Task</strong> を使います。まずインストールします：</p>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>install<span class="w"> </span>github.com/go-task/task/v3/cmd/task@latest
</code></pre></div>
<p><strong>重要</strong>: インストール後、ツールが正しくインストールされたか確認しましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span>--version
<span class="c1"># 出力例: Task version: v3.xx.x</span>
</code></pre></div>
<p>もし「command not found」と表示される場合は、以下を確認してください：</p>
<p><strong>Linux/macOS の場合</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># PATHに追加されているか確認</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$PATH</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>go/bin

<span class="c1"># 追加されていない場合は~/.bashrcや~/.zshrcに追加</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$HOME</span>/go/bin
</code></pre></div></p>
<p><strong>Windows (PowerShell) の場合</strong>:
<div class="highlight"><pre><span></span><code><span class="c"># PATHに追加</span>
<span class="no">[Environment]</span><span class="p">::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s2">&quot;Path&quot;</span><span class="p">,</span> <span class="nv">$env:Path</span> <span class="p">+</span> <span class="s2">&quot;;$env:USERPROFILE\go\bin&quot;</span><span class="p">,</span> <span class="s2">&quot;User&quot;</span><span class="p">)</span>
<span class="c"># 新しいターミナルを開いて確認</span>
</code></pre></div></p>
<p><code>Taskfile.yml</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3&#39;</span>

<span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">default</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>

<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go test -v ./...</span>

<span class="w">  </span><span class="nt">test-cover</span><span class="p">:</span>
<span class="w">    </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with coverage</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go test -coverprofile=coverage.out ./...</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go tool cover -html=coverage.out -o coverage.html</span>

<span class="w">  </span><span class="nt">lint</span><span class="p">:</span>
<span class="w">    </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run linters</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">golangci-lint run</span>

<span class="w">  </span><span class="nt">fmt</span><span class="p">:</span>
<span class="w">    </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Format code</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gofmt -s -w .</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">goimports -w .</span>

<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build application</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go build -o puyo-puyo-go .</span>

<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run application</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">go run .</span>

<span class="w">  </span><span class="nt">check</span><span class="p">:</span>
<span class="w">    </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run all checks</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fmt</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lint</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>

<span class="w">  </span><span class="nt">clean</span><span class="p">:</span>
<span class="w">    </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Clean build artifacts</span>
<span class="w">    </span><span class="nt">cmds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rm -f puyo-puyo-go coverage.out coverage.html</span>
</code></pre></div>
<p>タスクを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span><span class="w">        </span><span class="c1"># テスト実行</span>
task<span class="w"> </span>lint<span class="w">        </span><span class="c1"># 静的解析</span>
task<span class="w"> </span>fmt<span class="w">         </span><span class="c1"># フォーマット</span>
task<span class="w"> </span>check<span class="w">       </span><span class="c1"># 全チェック実行</span>
</code></pre></div>
<h3 id="_8">プロジェクト構成<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>最後に、プロジェクトのフォルダ構成を確認しておきましょう：</p>
<div class="highlight"><pre><span></span><code>puyo-puyo-go/
├── cmd/
│   └── puyo/
│       └── main.go          # エントリーポイント
├── internal/
│   ├── game/
│   │   ├── game.go          # ゲームロジック
│   │   └── game_test.go     # ゲームテスト
│   ├── board/
│   │   ├── board.go         # ボード（盤面）
│   │   └── board_test.go    # ボードテスト
│   └── puyo/
│       ├── puyo.go          # ぷよ定義
│       └── puyo_test.go     # ぷよテスト
├── go.mod                   # モジュール定義
├── go.sum                   # 依存関係のチェックサム
├── Taskfile.yml             # タスク定義
├── .golangci.yml            # Linter設定
└── .gitignore               # Git除外設定
</code></pre></div>
<p>「<code>internal/</code> ディレクトリって何ですか？」良い質問ですね！</p>
<blockquote>
<p><code>internal</code> ディレクトリは、そのパッケージが外部からインポートされないことを保証する特別なディレクトリです。</p>
<p>— Go公式ドキュメント</p>
</blockquote>
<p>これにより、プロジェクト内部のコードが外部から誤って使用されることを防げます。</p>
<h3 id="_9">セットアップの確認<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>環境構築が完了したら、すべてが正しく動作するか確認しましょう。</p>
<h4 id="1">ステップ1: ツールのインストール確認<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<p>まず、各ツールが正しくインストールされているか確認します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Goのバージョン確認</span>
go<span class="w"> </span>version

<span class="c1"># golangci-lintの確認</span>
golangci-lint<span class="w"> </span>--version

<span class="c1"># taskの確認</span>
task<span class="w"> </span>--version
</code></pre></div>
<p>すべてのコマンドでバージョン情報が表示されればOKです。もし「command not found」エラーが出る場合は、該当ツールの再インストールとPATH設定を確認してください。</p>
<h4 id="2">ステップ2: 利用可能なタスクの確認<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<p>taskコマンドで利用可能なタスク一覧を表示します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span>--list
<span class="c1"># または</span>
task<span class="w"> </span>-l
</code></pre></div>
<p>以下のようなタスク一覧が表示されれば成功です：</p>
<div class="highlight"><pre><span></span><code>task: Available tasks for this project:
* build:         Build application
* check:         Run all checks
* clean:         Clean build artifacts
* fmt:           Format code
* lint:          Run linters
* run:           Run application
* test:          Run tests
* test-cover:    Run tests with coverage
</code></pre></div>
<h4 id="3">ステップ3: 品質チェックの実行<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<p>実際に品質チェックを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span>check
</code></pre></div>
<p>このコマンドは以下を順次実行します：
1. <code>task fmt</code> - コードフォーマット
2. <code>task lint</code> - 静的解析（サイクロマティック複雑度チェック含む）
3. <code>task test</code> - テスト実行</p>
<p><strong>期待される結果</strong>:
- すべてのチェックがエラーなく完了すること
- テストが全て通過すること
- lintエラーが0件であること</p>
<p>もしエラーが発生した場合は、該当するツールが正しくインストールされているか、設定ファイルが正しく配置されているかを確認してください。</p>
<h4 id="4">ステップ4: コミット<a class="headerlink" href="#4" title="Permanent link">&para;</a></h4>
<p>セットアップが完了し、すべての確認が成功したら、ここでコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: プロジェクトの環境構築を完了</span>

<span class="s1">- Go modulesの初期化</span>
<span class="s1">- Ebiten, testifyの導入</span>
<span class="s1">- golangci-lintの設定（サイクロマティック複雑度7）</span>
<span class="s1">- Taskfileの作成</span>
<span class="s1">- プロジェクト構造の定義&#39;</span>
</code></pre></div>
<h3 id="0_1">イテレーション0のまとめ<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで準備した内容：</p>
<ol>
<li><strong>バージョン管理</strong></li>
<li>Gitのセットアップ</li>
<li>
<p>コミットメッセージ規約（Angularルール）</p>
</li>
<li>
<p><strong>テスティング環境</strong></p>
</li>
<li>Go modules（パッケージマネージャ）</li>
<li>Ebiten（ゲームライブラリ）</li>
<li>
<p>標準testingパッケージ + testify</p>
</li>
<li>
<p><strong>自動化ツール</strong></p>
</li>
<li>golangci-lint（静的コード解析、サイクロマティック複雑度7）</li>
<li>gofmt/goimports（コードフォーマッタ）</li>
<li>go test（コードカバレッジ）</li>
<li>
<p>Task（タスクランナー）</p>
</li>
<li>
<p><strong>プロジェクト構成</strong></p>
</li>
<li>cmd/internal構造の採用</li>
<li>設定ファイルの準備（.golangci.yml、Taskfile.yml）</li>
</ol>
<h3 id="_10">学んだこと<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ソフトウェア開発の三種の神器</strong>: バージョン管理、テスティング、自動化の重要性</li>
<li><strong>Goエコシステム</strong>: Go modules、golangci-lint、gofmtなどの標準ツール</li>
<li><strong>タスク自動化</strong>: 反復的な作業を自動化してミスを減らす</li>
<li><strong>品質維持</strong>: 静的解析とフォーマットでコードの品質を保つ</li>
<li><strong>複雑度管理</strong>: サイクロマティック複雑度を7に制限することで、テスタブルで保守しやすいコードを維持</li>
</ul>
<h3 id="_11">重要な注意点<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p><strong>設定ファイルの作成だけでは不十分です！</strong></p>
<p>環境構築では以下の3ステップをすべて完了させることが重要です：</p>
<ol>
<li><strong>ツール本体のインストール</strong> - <code>go install</code>コマンドの実行</li>
<li><strong>設定ファイルの作成</strong> - <code>.golangci.yml</code>、<code>Taskfile.yml</code>など</li>
<li><strong>動作確認の実行</strong> - 各ツールのバージョン確認と<code>task check</code>の実行</li>
</ol>
<p>特に、以下のような失敗例に注意してください：</p>
<p>❌ <strong>よくある失敗</strong>: 設定ファイルだけ作成して、ツール本体をインストールし忘れる
- <code>Taskfile.yml</code>は作成したが、<code>task</code>コマンドがインストールされていない
- <code>.golangci.yml</code>は作成したが、<code>golangci-lint</code>がインストールされていない</p>
<p>✅ <strong>正しい手順</strong>: インストール → 確認 → 設定 → 動作確認
<div class="highlight"><pre><span></span><code><span class="c1"># 1. インストール</span>
go<span class="w"> </span>install<span class="w"> </span>github.com/go-task/task/v3/cmd/task@latest

<span class="c1"># 2. インストール確認</span>
task<span class="w"> </span>--version

<span class="c1"># 3. 設定ファイル作成</span>
<span class="c1"># Taskfile.ymlを作成</span>

<span class="c1"># 4. 動作確認</span>
task<span class="w"> </span>check
</code></pre></div></p>
<p>この3ステップの確認を徹底することで、後のイテレーションで「なぜツールが動かないの？」という問題を防げます。</p>
<p>「準備完了！これから本格的にぷよぷよゲームを作っていきますよ！」</p>
<p>次のイテレーションでは、ゲーム開始の実装に進みます！</p>
<h2 id="1_1">イテレーション1: ゲーム開始とボード表示の実装<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」と「ボードの表示」を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_12">ユーザーストーリー<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始してボードを見ることができる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始してボードを見ることができる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ボード構造体を実装する（ゲームの盤面を管理する）</li>
<li>ぷよの色を定義する（赤、青、緑、黄の4色）</li>
<li>ゲーム構造体を実装する（ゲーム全体の状態を管理する）</li>
<li>Ebitenのゲームインターフェースを実装する（Update、Draw、Layoutメソッド）</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ぷよの色定義」から始めましょう！</p>
<h3 id="_13">テスト: ぷよの色定義<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「ぷよの色を定義する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ぷよの色をテストするコードを書いてみましょう。何をテストすべきでしょうか？ぷよの色が正しく定義され、色の文字列表現が取得できることを確認しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/puyo/puyo_test.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">puyo</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;testing&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/stretchr/testify/assert&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestPuyoColor</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;空のぷよは空文字列を返す&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ColorNone</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;赤いぷよは赤を表す文字列を返す&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ColorRed</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;赤&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;青いぷよは青を表す文字列を返す&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ColorBlue</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;青&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;緑のぷよは緑を表す文字列を返す&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ColorGreen</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;緑&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;黄色いぷよは黄を表す文字列を返す&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ColorYellow</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;黄&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、各ぷよの色が正しい文字列表現を返すことを確認しています。testifyの<code>assert.Equal</code>を使って期待値と実際の値を比較しています。</p>
<h3 id="_14">実装: ぷよの色定義<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>no such file or directory: internal/puyo/puyo_test.go
</code></pre></div>
<p>おっと！まだ<code>puyo</code>パッケージを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<blockquote>
<p>アサートファースト</p>
<p>ではテストはどこから書き始めるべきだろうか。それはテストの終わりにパスすべきアサーションを書くところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストを通すための最小限のコードを実装しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/puyo/puyo.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">puyo</span>

<span class="c1">// Color はぷよの色を表す型</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Color</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">ColorNone</span><span class="w"> </span><span class="nx">Color</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">    </span><span class="nx">ColorRed</span>
<span class="w">    </span><span class="nx">ColorBlue</span>
<span class="w">    </span><span class="nx">ColorGreen</span>
<span class="w">    </span><span class="nx">ColorYellow</span>
<span class="p">)</span>

<span class="c1">// String はぷよの色を文字列で返す</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="nx">Color</span><span class="p">)</span><span class="w"> </span><span class="nx">String</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ColorRed</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;赤&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ColorBlue</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;青&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ColorGreen</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;緑&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ColorYellow</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;黄&quot;</span>
<span class="w">    </span><span class="k">default</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Goでは、<code>iota</code>を使って列挙型（enum）を定義できます。<code>Color</code>型に<code>String()</code>メソッドを実装することで、色の文字列表現を取得できるようにしています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/puyo      0.002s
</code></pre></div>
<p>やった！テストが通りました。これが「Green（緑）」の状態です。</p>
<h3 id="_15">リファクタリング: ぷよの色定義<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>テストが通ったので、リファクタリングの機会を探しましょう。今回のコードはシンプルで明確なので、特にリファクタリングする必要はありません。次のタスクに進みましょう！</p>
<h3 id="_16">テスト: ボード構造体の実装<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>次は、ボード構造体を実装します。ボードは12行×6列の盤面で、各セルにぷよの色情報を保持します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/board/board_test.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">board</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;testing&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/stretchr/testify/assert&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/puyo&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestBoard</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;新しいボードは12行6列の空の盤面を持つ&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">))</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="w">        </span><span class="c1">// すべてのセルが空であることを確認</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">])</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;指定した位置にぷよを配置できる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;指定した位置のぷよを取得できる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>
<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span>

<span class="w">        </span><span class="nx">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、ボードが正しく初期化され、ぷよの配置と取得ができることを確認しています。</p>
<h3 id="_17">実装: ボード構造体<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、実装に進みましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/board/board.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">board</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/puyo&quot;</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="c1">// Rows はボードの行数</span>
<span class="w">    </span><span class="nx">Rows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="c1">// Cols はボードの列数</span>
<span class="w">    </span><span class="nx">Cols</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">6</span>
<span class="p">)</span>

<span class="c1">// Board はぷよぷよの盤面を表す</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Board</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Cells</span><span class="w"> </span><span class="p">[</span><span class="nx">Rows</span><span class="p">][</span><span class="nx">Cols</span><span class="p">]</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span>
<span class="p">}</span>

<span class="c1">// New は新しいボードを作成する</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">Board</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Board</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// Set は指定した位置にぷよを配置する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="nx">Set</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Cols</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">color</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Get は指定した位置のぷよの色を取得する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Cols</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span>
<span class="p">}</span>
</code></pre></div>
<p>Goでは、配列は値型なので、構造体の初期化時にゼロ値（<code>puyo.ColorNone</code>）で埋められます。これにより、明示的な初期化処理なしで空のボードが作成できます。</p>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/board     0.002s
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="ebiten">テスト: Ebitenゲームの実装<a class="headerlink" href="#ebiten" title="Permanent link">&para;</a></h3>
<p>次は、Ebitenのゲームインターフェースを実装します。Ebitenでは、<code>Update</code>、<code>Draw</code>、<code>Layout</code>の3つのメソッドを持つ構造体を定義する必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game_test.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">game</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;testing&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/stretchr/testify/assert&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/board&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestGame</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;新しいゲームはボードを持つ&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NotNil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">IsType</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span><span class="p">{},</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;Updateメソッドは正常に動作する&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;Layoutメソッドは画面サイズを返す&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Layout</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span><span class="w"> </span><span class="mi">480</span><span class="p">)</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">240</span><span class="p">,</span><span class="w"> </span><span class="nx">width</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">360</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="ebiten_1">実装: Ebitenゲーム<a class="headerlink" href="#ebiten_1" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装をしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">game</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;github.com/hajimehoshi/ebiten/v2&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/board&quot;</span>
<span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="c1">// ScreenWidth は画面の幅</span>
<span class="w">    </span><span class="nx">ScreenWidth</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">240</span>
<span class="w">    </span><span class="c1">// ScreenHeight は画面の高さ</span>
<span class="w">    </span><span class="nx">ScreenHeight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">360</span>
<span class="p">)</span>

<span class="c1">// Game はゲームの状態を管理する</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Board</span><span class="w"> </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span>
<span class="p">}</span>

<span class="c1">// New は新しいゲームを作成する</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Game</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Board</span><span class="p">:</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">New</span><span class="p">(),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Update はゲームの状態を更新する（1フレームごとに呼ばれる）</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Update</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Draw は画面を描画する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 次のイテレーションで実装</span>
<span class="p">}</span>

<span class="c1">// Layout は画面のレイアウトを決定する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Layout</span><span class="p">(</span><span class="nx">outsideWidth</span><span class="p">,</span><span class="w"> </span><span class="nx">outsideHeight</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">ScreenWidth</span><span class="p">,</span><span class="w"> </span><span class="nx">ScreenHeight</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/game      0.003s
</code></pre></div>
<p>完璧です！すべてのテストが通りました。</p>
<h3 id="_18">実装: メインエントリーポイント<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>最後に、ゲームを実行するためのメインファイルを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// cmd/puyo/main.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;log&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/hajimehoshi/ebiten/v2&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/game&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">game</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>

<span class="w">    </span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">SetWindowSize</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span><span class="w"> </span><span class="mi">720</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">SetWindowTitle</span><span class="p">(</span><span class="s">&quot;ぷよぷよ&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">RunGame</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_19">ゲームの実行<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>ゲームを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span>run
</code></pre></div>
<p>黒い画面が表示されるはずです。まだ描画処理を実装していないので、これで正しいです！</p>
<h3 id="1_2">イテレーション1のまとめ<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ぷよの色定義</strong></li>
<li><code>Color</code>型の定義（iota使用）</li>
<li>
<p><code>String()</code>メソッドによる文字列表現</p>
</li>
<li>
<p><strong>ボード構造体</strong></p>
</li>
<li>12行×6列の盤面</li>
<li>
<p><code>Set()</code>と<code>Get()</code>メソッド</p>
</li>
<li>
<p><strong>ゲーム構造体</strong></p>
</li>
<li>Ebitenのゲームインターフェース実装</li>
<li>
<p><code>Update</code>、<code>Draw</code>、<code>Layout</code>メソッド</p>
</li>
<li>
<p><strong>メインエントリーポイント</strong></p>
</li>
<li>ゲームウィンドウの起動</li>
</ol>
<h3 id="_20">学んだこと<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Goの列挙型</strong>: <code>iota</code>を使った定数定義</li>
<li><strong>構造体とメソッド</strong>: Goにおけるオブジェクト指向的な設計</li>
<li><strong>配列の初期化</strong>: ゼロ値による自動初期化</li>
<li><strong>Ebitenの基本</strong>: ゲームループの構造（Update/Draw/Layout）</li>
<li><strong>テーブル駆動テスト</strong>: <code>t.Run()</code>による複数テストケースの実行</li>
</ul>
<h3 id="_21">コミット<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>イテレーション1が完了したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム開始とボード表示の基本機能を実装</span>

<span class="s1">- ぷよの色定義（Red/Blue/Green/Yellow）</span>
<span class="s1">- ボード構造体（12x6グリッド）</span>
<span class="s1">- ゲーム構造体（Ebitenインターフェース実装）</span>
<span class="s1">- メインエントリーポイント&#39;</span>
</code></pre></div>
<p>次のイテレーションでは、ぷよペアの表示と移動を実装します！</p>
<h2 id="2_1">イテレーション2: ぷよペアの表示と移動の実装<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームの基本的な構造ができましたね。「ゲームが始まったけど、ぷよが動かないと面白くないよね？」と思いませんか？そこで次は、ぷよペアを表示して左右に移動できるようにしていきましょう！</p>
<h3 id="_22">ユーザーストーリー<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう:</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよペアを見て、左右に移動できる</p>
</blockquote>
<p>「ぷよぷよって、落ちてくるぷよペアを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「ぷよペアの表示と左右の移動」を実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。
「ぷよペアを表示して左右に移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよペア構造体を実装する（軸ぷよと子ぷよの2つのぷよ）</li>
<li>ぷよペアをランダムに生成する</li>
<li>ぷよペアを画面に描画する</li>
<li>プレイヤーの入力を検出する（キーボードの左右キーが押されたことを検知する）</li>
<li>ぷよペアを左右に移動する処理を実装する（実際にぷよペアの位置を変更する）</li>
<li>移動可能かどうかのチェックを実装する（画面の端や他のぷよにぶつかる場合は移動できないようにする）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_23">テスト: ぷよペア構造体<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよペアの基本構造からテストしていきましょう。ぷよペアは軸ぷよ（axis）と子ぷよ（child）の2つのぷよで構成されます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/pair/pair_test.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">pair</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;testing&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/stretchr/testify/assert&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/puyo&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestPuyoPair</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;新しいぷよペアは軸ぷよと子ぷよを持つ&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisColor</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildY</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildColor</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;左に移動すると位置が1減る&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>

<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">MoveLeft</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;右に移動すると位置が1増える&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>

<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">MoveRight</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、ぷよペアの初期化と左右移動の基本動作を確認しています。</p>
<h3 id="_24">実装: ぷよペア構造体<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実装しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/pair/pair.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">pair</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/puyo&quot;</span>

<span class="c1">// PuyoPair は落下中のぷよペアを表す</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">PuyoPair</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">AxisX</span><span class="w">      </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">AxisY</span><span class="w">      </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">AxisColor</span><span class="w">  </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span>
<span class="w">    </span><span class="nx">ChildX</span><span class="w">     </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">ChildY</span><span class="w">     </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">ChildColor</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span>
<span class="p">}</span>

<span class="c1">// New は新しいぷよペアを作成する</span>
<span class="c1">// 初期状態では子ぷよは軸ぷよの上（Y-1）に配置される</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">New</span><span class="p">(</span><span class="nx">axisX</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">axisColor</span><span class="p">,</span><span class="w"> </span><span class="nx">childColor</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">PuyoPair</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">PuyoPair</span><span class="p">{</span>
<span class="w">        </span><span class="nx">AxisX</span><span class="p">:</span><span class="w">      </span><span class="nx">axisX</span><span class="p">,</span>
<span class="w">        </span><span class="nx">AxisY</span><span class="p">:</span><span class="w">      </span><span class="nx">axisY</span><span class="p">,</span>
<span class="w">        </span><span class="nx">AxisColor</span><span class="p">:</span><span class="w">  </span><span class="nx">axisColor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">ChildX</span><span class="p">:</span><span class="w">     </span><span class="nx">axisX</span><span class="p">,</span>
<span class="w">        </span><span class="nx">ChildY</span><span class="p">:</span><span class="w">     </span><span class="nx">axisY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nx">ChildColor</span><span class="p">:</span><span class="w"> </span><span class="nx">childColor</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MoveLeft は軸ぷよと子ぷよを左に移動する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">PuyoPair</span><span class="p">)</span><span class="w"> </span><span class="nx">MoveLeft</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">--</span>
<span class="w">    </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="o">--</span>
<span class="p">}</span>

<span class="c1">// MoveRight は軸ぷよと子ぷよを右に移動する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">PuyoPair</span><span class="p">)</span><span class="w"> </span><span class="nx">MoveRight</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">++</span>
<span class="w">    </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="o">++</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/pair      0.002s
</code></pre></div>
<p>やった！テストが通りました。</p>
<h3 id="_25">テスト: 衝突判定<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>次は、ぷよペアが移動できるかどうかを判定する衝突検出を実装します。画面の端や他のぷよにぶつかる場合は移動できません。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/pair/pair_test.go に追加</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestPuyoPairCollision</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;ボード範囲外の位置は衝突と判定される&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 左端（X=-1）は衝突</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">True</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="w">        </span><span class="c1">// 右端（X=6）は衝突</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">True</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="w">        </span><span class="c1">// 上端（Y=-2）は衝突</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">True</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>

<span class="w">        </span><span class="c1">// 下端（Y=12）は衝突</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">True</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;ぷよがある位置は衝突と判定される&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorGreen</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// ぷよがある位置は衝突</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">True</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;空いている位置は衝突しない&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 空いている位置は衝突しない</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">False</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_26">実装: 衝突判定<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/pair/pair.go に追加</span>
<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/board&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/puyo&quot;</span>
<span class="p">)</span>

<span class="c1">// IsCollision は指定した位置に衝突があるかチェックする</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">PuyoPair</span><span class="p">)</span><span class="w"> </span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span><span class="p">,</span><span class="w"> </span><span class="nx">axisX</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span><span class="p">,</span><span class="w"> </span><span class="nx">childX</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 軸ぷよの衝突判定</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">isValidPosition</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">axisX</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよの衝突判定（画面上部は許可）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">isValidPosition</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">childX</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>

<span class="c1">// isValidPosition は指定した位置が有効かチェックする</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">isValidPosition</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 範囲外チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">Cols</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">Rows</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ぷよが既にあるかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>

<span class="c1">// CanMoveLeft は左に移動できるかチェックする</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">PuyoPair</span><span class="p">)</span><span class="w"> </span><span class="nx">CanMoveLeft</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildY</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// CanMoveRight は右に移動できるかチェックする</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">PuyoPair</span><span class="p">)</span><span class="w"> </span><span class="nx">CanMoveRight</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildY</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/pair      0.003s
</code></pre></div>
<p>素晴らしい！衝突判定が正しく動作しています。</p>
<h3 id="_27">実装: ゲームへの統合<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>次に、ぷよペアをゲームに統合します。ゲームにぷよペアを追加し、キー入力で移動できるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">game</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;math/rand&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/hajimehoshi/ebiten/v2&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/hajimehoshi/ebiten/v2/ebitenutil&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/board&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/pair&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/puyo&quot;</span>
<span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">ScreenWidth</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">240</span>
<span class="w">    </span><span class="nx">ScreenHeight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">360</span>
<span class="w">    </span><span class="nx">CellSize</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span>
<span class="w">    </span><span class="nx">BoardOffsetX</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span>
<span class="w">    </span><span class="nx">BoardOffsetY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Board</span><span class="w">       </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span>
<span class="w">    </span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">*</span><span class="nx">pair</span><span class="p">.</span><span class="nx">PuyoPair</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Game</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Board</span><span class="p">:</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">New</span><span class="p">(),</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">g</span>
<span class="p">}</span>

<span class="c1">// spawnNewPair は新しいぷよペアを生成する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">spawnNewPair</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">colors</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span><span class="p">{</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorGreen</span><span class="p">,</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorYellow</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">axisColor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">colors</span><span class="p">))]</span>
<span class="w">    </span><span class="nx">childColor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">colors</span><span class="p">))]</span>

<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">pair</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">axisColor</span><span class="p">,</span><span class="w"> </span><span class="nx">childColor</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Update</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 左キー</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">IsKeyPressed</span><span class="p">(</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">KeyArrowLeft</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">CanMoveLeft</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">MoveLeft</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 右キー</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">IsKeyPressed</span><span class="p">(</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">KeyArrowRight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">CanMoveRight</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">MoveRight</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードを描画</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawBoard</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyoPair</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">drawBoard</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードの枠を描画</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">Rows</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">Cols</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">BoardOffsetX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">col</span><span class="o">*</span><span class="nx">CellSize</span><span class="p">)</span>
<span class="w">            </span><span class="nx">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">BoardOffsetY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">row</span><span class="o">*</span><span class="nx">CellSize</span><span class="p">)</span>

<span class="w">            </span><span class="nx">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyo</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">drawPuyoPair</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="nx">axisX</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">BoardOffsetX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">*</span><span class="nx">CellSize</span><span class="p">)</span>
<span class="w">    </span><span class="nx">axisY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">BoardOffsetY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">AxisY</span><span class="o">*</span><span class="nx">CellSize</span><span class="p">)</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyo</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">axisX</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">AxisColor</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 子ぷよ（画面内の場合のみ）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">ChildY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">childX</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">BoardOffsetX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">ChildX</span><span class="o">*</span><span class="nx">CellSize</span><span class="p">)</span>
<span class="w">        </span><span class="nx">childY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">BoardOffsetY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">ChildY</span><span class="o">*</span><span class="nx">CellSize</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyo</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">childX</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">ChildColor</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">drawPuyo</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">float64</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">gr</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="kt">uint8</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">:</span>
<span class="w">        </span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">gr</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">:</span>
<span class="w">        </span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">gr</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorGreen</span><span class="p">:</span>
<span class="w">        </span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">gr</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorYellow</span><span class="p">:</span>
<span class="w">        </span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">gr</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">default</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ぷよを円として描画</span>
<span class="w">    </span><span class="nx">ebitenutil</span><span class="p">.</span><span class="nx">DrawRect</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">CellSize</span><span class="o">-</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">CellSize</span><span class="o">-</span><span class="mi">4</span><span class="p">),</span>
<span class="w">        </span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">gr</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Layout</span><span class="p">(</span><span class="nx">outsideWidth</span><span class="p">,</span><span class="w"> </span><span class="nx">outsideHeight</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">ScreenWidth</span><span class="p">,</span><span class="w"> </span><span class="nx">ScreenHeight</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_28">ゲームの実行<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>ゲームを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span>run
</code></pre></div>
<p>ぷよペアが表示され、左右の矢印キーで移動できるはずです！</p>
<h3 id="2_2">イテレーション2のまとめ<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ぷよペア構造体</strong></li>
<li>軸ぷよと子ぷよの管理</li>
<li>
<p>左右移動メソッド</p>
</li>
<li>
<p><strong>衝突判定</strong></p>
</li>
<li>ボード範囲外のチェック</li>
<li>既存ぷよとの衝突チェック</li>
<li>
<p>移動可否の判定</p>
</li>
<li>
<p><strong>ゲーム統合</strong></p>
</li>
<li>ぷよペアのランダム生成</li>
<li>キー入力による移動</li>
<li>
<p>画面描画（ボードとぷよペア）</p>
</li>
<li>
<p><strong>描画機能</strong></p>
</li>
<li>色別のぷよ描画</li>
<li>ボード全体の描画</li>
</ol>
<h3 id="_29">学んだこと<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Goの入力処理</strong>: Ebitenの<code>IsKeyPressed</code>を使った入力検出</li>
<li><strong>乱数生成</strong>: <code>math/rand</code>を使ったランダムな色選択</li>
<li><strong>描画処理</strong>: <code>ebitenutil.DrawRect</code>を使った図形描画</li>
<li><strong>衝突判定</strong>: ゲームロジックにおける基本的な衝突検出アルゴリズム</li>
<li><strong>テスト駆動開発</strong>: 複雑な機能も小さなステップで確実に実装</li>
</ul>
<h3 id="_30">コミット<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>イテレーション2が完了したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよペアの表示と移動機能を実装</span>

<span class="s1">- ぷよペア構造体（軸ぷよと子ぷよ）</span>
<span class="s1">- 衝突判定ロジック</span>
<span class="s1">- キー入力による左右移動</span>
<span class="s1">- ぷよの描画機能&#39;</span>
</code></pre></div>
<p>次のイテレーションでは、ぷよペアの回転機能を実装します！</p>
<h2 id="3_1">イテレーション3: ぷよペアの回転の実装<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h2>
<h3 id="_31">ユーザーストーリー<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよペアを回転できる</p>
</blockquote>
<p>「ぷよを回転できないと、積み方の自由度が少ないですよね？」そうです！今回はぷよペアを回転する機能を実装します。</p>
<h3 id="_32">実装概要<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>ぷよペアの回転は、軸ぷよを中心に子ぷよを90度回転させます。回転パターンは以下の4種類です：</p>
<ul>
<li>上（0度）: 子ぷよが軸ぷよの上</li>
<li>右（90度）: 子ぷよが軸ぷよの右</li>
<li>下（180度）: 子ぷよが軸ぷよの下</li>
<li>左（270度）: 子ぷよが軸ぷよの左</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/pair/pair.go に追加</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Direction</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">DirUp</span><span class="w"> </span><span class="nx">Direction</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">    </span><span class="nx">DirRight</span>
<span class="w">    </span><span class="nx">DirDown</span>
<span class="w">    </span><span class="nx">DirLeft</span>
<span class="p">)</span>

<span class="c1">// Rotate は右回転する（壁キック付き）</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">PuyoPair</span><span class="p">)</span><span class="w"> </span><span class="nx">Rotate</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">newDir</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Direction</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="nx">newChildX</span><span class="p">,</span><span class="w"> </span><span class="nx">newChildY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">calcChildPosition</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">,</span><span class="w"> </span><span class="nx">newDir</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 回転可能かチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">,</span><span class="w"> </span><span class="nx">newChildX</span><span class="p">,</span><span class="w"> </span><span class="nx">newChildY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">Direction</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newDir</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newChildX</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newChildY</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 壁キック: 左にずらして回転</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">,</span><span class="w"> </span><span class="nx">newChildX</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">newChildY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">--</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newChildX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newChildY</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">Direction</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newDir</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 壁キック: 右にずらして回転</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">,</span><span class="w"> </span><span class="nx">newChildX</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">newChildY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">AxisX</span><span class="o">++</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildX</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newChildX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">ChildY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newChildY</span>
<span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">Direction</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newDir</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">PuyoPair</span><span class="p">)</span><span class="w"> </span><span class="nx">calcChildPosition</span><span class="p">(</span><span class="nx">axisX</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">dir</span><span class="w"> </span><span class="nx">Direction</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">dir</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">DirUp</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">axisX</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">DirRight</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">axisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">DirDown</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">axisX</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">DirLeft</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">axisX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span>
<span class="w">    </span><span class="k">default</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">axisX</span><span class="p">,</span><span class="w"> </span><span class="nx">axisY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_33">入力処理の追加<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go のUpdate()に追加</span>
<span class="c1">// Zキーで回転</span>
<span class="k">if</span><span class="w"> </span><span class="nx">inpututil</span><span class="p">.</span><span class="nx">IsKeyJustPressed</span><span class="p">(</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">KeyZ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">Rotate</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_34">学んだこと<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>回転アルゴリズム</strong>: 軸を中心とした90度回転</li>
<li><strong>壁キック</strong>: 回転できない場合の位置調整</li>
<li><strong>入力検出</strong>: <code>IsKeyJustPressed</code>による1回だけの入力検出</li>
</ul>
<h2 id="4_1">イテレーション4: ぷよの自動落下の実装<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h2>
<h3 id="_35">ユーザーストーリー<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<blockquote>
<p>システムとして、ぷよペアが自動的に落下する</p>
</blockquote>
<p>「ぷよが自動的に落ちないと、ゲームとして成り立たないですね！」そうです！今回はぷよペアの自動落下を実装します。</p>
<h3 id="_36">実装概要<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go に追加</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">ModePlaying</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">    </span><span class="nx">ModeFalling</span>
<span class="w">    </span><span class="nx">ModeChecking</span>
<span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">FallInterval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="c1">// 0.5秒ごとに落下</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Board</span><span class="w">       </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span>
<span class="w">    </span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">*</span><span class="nx">pair</span><span class="p">.</span><span class="nx">PuyoPair</span>
<span class="w">    </span><span class="nx">Mode</span><span class="w">        </span><span class="nx">GameMode</span>
<span class="w">    </span><span class="nx">FallTimer</span><span class="w">   </span><span class="kt">float64</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Update</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">dt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60.0</span><span class="w"> </span><span class="c1">// 60FPS</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModePlaying</span><span class="p">:</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">handleInput</span><span class="p">()</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">updateFall</span><span class="p">(</span><span class="nx">dt</span><span class="p">)</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeFalling</span><span class="p">:</span>
<span class="w">        </span><span class="c1">// 落下中のぷよを処理</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">applyGravity</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">g</span><span class="p">.</span><span class="nx">hasFloatingPuyo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">updateFall</span><span class="p">(</span><span class="nx">dt</span><span class="w"> </span><span class="kt">float64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">FallTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">dt</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">FallTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">FallInterval</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">FallTimer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">CanMoveDown</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">MoveDown</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 着地</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">lockPair</span><span class="p">()</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeFalling</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">lockPair</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 軸ぷよをボードに配置</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">AxisX</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">AxisColor</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 子ぷよをボードに配置（画面内の場合のみ）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">ChildY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">ChildY</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">ChildX</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">.</span><span class="nx">ChildColor</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_37">学んだこと<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ゲームモード管理</strong>: 状態遷移による処理の分岐</li>
<li><strong>タイマー処理</strong>: deltaTimeを使った時間管理</li>
<li><strong>着地処理</strong>: ぷよペアをボードに固定</li>
</ul>
<h2 id="5">イテレーション5: ぷよの消去ロジックの実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="_38">ユーザーストーリー<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<blockquote>
<p>システムとして、同じ色のぷよが4つ以上つながると消える</p>
</blockquote>
<p>「4つ以上つながったぷよが消えるのが、ぷよぷよの醍醐味ですよね！」そうです！今回は消去判定を実装します。</p>
<h3 id="dfs">実装概要：深さ優先探索（DFS）<a class="headerlink" href="#dfs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/board/board.go に追加</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Position</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Row</span><span class="p">,</span><span class="w"> </span><span class="nx">Col</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>

<span class="c1">// CheckErase は消去可能なぷよを検出する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="nx">CheckErase</span><span class="p">()</span><span class="w"> </span><span class="p">[]</span><span class="nx">Position</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">visited</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">Position</span><span class="p">]</span><span class="kt">bool</span><span class="p">)</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">toErase</span><span class="w"> </span><span class="p">[]</span><span class="nx">Position</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Rows</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Cols</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">pos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">Position</span><span class="p">{</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">visited</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">continue</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">group</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">dfs</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">],</span><span class="w"> </span><span class="nx">visited</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">group</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">toErase</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">toErase</span><span class="p">,</span><span class="w"> </span><span class="nx">group</span><span class="o">...</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">toErase</span>
<span class="p">}</span>

<span class="c1">// dfs は深さ優先探索で同じ色のぷよグループを見つける</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="nx">dfs</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span><span class="p">,</span><span class="w"> </span><span class="nx">visited</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">Position</span><span class="p">]</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">[]</span><span class="nx">Position</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">pos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">Position</span><span class="p">{</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">visited</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">Rows</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">Cols</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">visited</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="nx">group</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">Position</span><span class="p">{</span><span class="nx">pos</span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 上下左右を探索</span>
<span class="w">    </span><span class="nx">group</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">dfs</span><span class="p">(</span><span class="nx">row</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="nx">visited</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="nx">group</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">dfs</span><span class="p">(</span><span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="nx">visited</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="nx">group</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">dfs</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="nx">visited</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="nx">group</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">dfs</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="nx">visited</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">group</span>
<span class="p">}</span>

<span class="c1">// Erase は指定した位置のぷよを消去する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="nx">Erase</span><span class="p">(</span><span class="nx">positions</span><span class="w"> </span><span class="p">[]</span><span class="nx">Position</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">pos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">positions</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">pos</span><span class="p">.</span><span class="nx">Row</span><span class="p">][</span><span class="nx">pos</span><span class="p">.</span><span class="nx">Col</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_39">重力処理<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// ApplyGravity はぷよを下に落とす</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="nx">ApplyGravity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Cols</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 下から順に詰める</span>
<span class="w">        </span><span class="nx">writePos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">--</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">writePos</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">writePos</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span>
<span class="w">                    </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nx">writePos</span><span class="o">--</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_40">学んだこと<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>深さ優先探索（DFS）</strong>: 再帰的なグラフ探索アルゴリズム</li>
<li><strong>訪問済み管理</strong>: mapを使った重複チェック</li>
<li><strong>重力処理</strong>: 列ごとにぷよを下に詰める</li>
</ul>
<h2 id="6">イテレーション6: 連鎖反応とスコアの実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="_41">ユーザーストーリー<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<blockquote>
<p>プレイヤーとして、連鎖したときにスコアが増える</p>
</blockquote>
<p>「連鎖が決まったときの爽快感がいいですよね！」そうです！今回は連鎖とスコアシステムを実装します。</p>
<h3 id="_42">スコア構造体<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/score/score.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">score</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Total</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">Chain</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Score</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// Add はスコアを加算する</span>
<span class="c1">// 基本スコア: 消したぷよの数 × 10</span>
<span class="c1">// 連鎖ボーナス: 2^(chain-1)</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="p">)</span><span class="w"> </span><span class="nx">Add</span><span class="p">(</span><span class="nx">erasedCount</span><span class="p">,</span><span class="w"> </span><span class="nx">chain</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">chainBonus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">chain</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">chainBonus</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nb">uint</span><span class="p">(</span><span class="nx">chain</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 2^(chain-1)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">points</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">erasedCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">chainBonus</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">points</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="p">)</span><span class="w"> </span><span class="nx">IncrementChain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="o">++</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="p">)</span><span class="w"> </span><span class="nx">ResetChain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_43">ゲームループへの統合<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Update</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeChecking</span><span class="p">:</span>
<span class="w">        </span><span class="nx">positions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">CheckErase</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">IncrementChain</span><span class="p">()</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">positions</span><span class="p">),</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Erase</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeFalling</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">ResetChain</span><span class="p">()</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModePlaying</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeFalling</span><span class="p">:</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">ApplyGravity</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">g</span><span class="p">.</span><span class="nx">hasFloatingPuyo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_44">スコア表示<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go のDraw()に追加</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードとぷよを描画</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawBoard</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyoPair</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// スコア表示</span>
<span class="w">    </span><span class="nx">scoreText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Score: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ebitenutil</span><span class="p">.</span><span class="nx">DebugPrintAt</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">scoreText</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">chainText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Chain: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">        </span><span class="nx">ebitenutil</span><span class="p">.</span><span class="nx">DebugPrintAt</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">chainText</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_45">学んだこと<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ビット演算</strong>: <code>1 &lt;&lt; n</code> による2のべき乗計算</li>
<li><strong>状態機械</strong>: Playing → Falling → Checking のループ</li>
<li><strong>テキスト描画</strong>: <code>ebitenutil.DebugPrintAt</code>によるデバッグ表示</li>
<li><strong>連鎖検出</strong>: 消去→重力→再消去のサイクル</li>
</ul>
<h3 id="_46">コミット<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>イテレーション3-6が完了したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 回転、落下、消去、スコアシステムを実装</span>

<span class="s1">- ぷよペアの回転と壁キック（イテレーション3）</span>
<span class="s1">- 自動落下とタイマー処理（イテレーション4）</span>
<span class="s1">- DFSによる消去判定と重力処理（イテレーション5）</span>
<span class="s1">- 連鎖システムとスコア計算（イテレーション6）&#39;</span>
</code></pre></div>
<p>次のイテレーションでは、ゲームオーバーと追加機能を実装します！</p>
<h2 id="7">イテレーション7: スコアと連鎖数の表示<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでぷよが消えるようになりましたね。「連鎖が決まったときに、スコアが表示されないと達成感がないですよね？」そうですね！今回は、スコアと連鎖数を画面に表示する機能を実装していきましょう。</p>
<h3 id="_47">ユーザーストーリー<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、スコアと連鎖数を確認できる</p>
</blockquote>
<p>「スコアと連鎖数を見られるようになると、ゲームがもっと楽しくなりそうですね！」そうです！連鎖が続くほどスコアが上がっていくのを見るのは、ぷよぷよの醍醐味の一つですよ。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>スコア構造体を実装する（スコアと連鎖数を管理する）</li>
<li>スコア計算ロジックを実装する（消したぷよの数と連鎖数からスコアを計算する）</li>
<li>連鎖数をカウントする仕組みを追加する（連鎖が続いているか判定する）</li>
<li>スコアと連鎖数を画面に表示する（プレイヤーが確認できるようにする）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_48">テスト: スコア構造体<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、スコア構造体の基本機能からテストしていきましょう。スコアの初期化と加算ができることを確認します。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/score/score_test.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">score</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;testing&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/stretchr/testify/assert&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestScore</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;新しいスコアは0で初期化される&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;スコアを加算できる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 4つのぷよを消去（連鎖なし）</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 * 10 = 40</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;連鎖数に応じてボーナスが付く&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 1連鎖: 4つ消去</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 * 10 * 1 = 40</span>

<span class="w">        </span><span class="c1">// 2連鎖: 4つ消去</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span><span class="w"> </span><span class="c1">// 40 + (4 * 10 * 2) = 120</span>

<span class="w">        </span><span class="c1">// 3連鎖: 4つ消去</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">280</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span><span class="w"> </span><span class="c1">// 120 + (4 * 10 * 4) = 280</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestChainCounter</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;連鎖数を増やせる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">IncrementChain</span><span class="p">()</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">IncrementChain</span><span class="p">()</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;連鎖数をリセットできる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">ResetChain</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、スコアの初期化、加算、連鎖ボーナスの計算が正しく動作することを確認しています。「連鎖ボーナスって、どういう計算なんですか？」良い質問ですね！連鎖ボーナスは <code>2^(chain-1)</code> で計算されます。1連鎖なら1倍、2連鎖なら2倍、3連鎖なら4倍というように、連鎖が続くほど大きくなるんです。</p>
<h3 id="_49">実装: スコア構造体<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実装しましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>no such file or directory: internal/score/score_test.go
</code></pre></div>
<p>おっと！まだ<code>score</code>パッケージを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<blockquote>
<p>仮実装</p>
<p>テストをパスさせるための実装にはどんな方法があるだろうか。仮実装を使えばすぐにテストを動かすことができる。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストを通すための実装を書いていきましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/score/score.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">score</span>

<span class="c1">// Score はゲームのスコアと連鎖数を管理する</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Score</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Total</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">Chain</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>

<span class="c1">// New は新しいスコアを作成する</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Score</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Chain</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Add はスコアを加算する</span>
<span class="c1">// 基本スコア: 消したぷよの数 × 10</span>
<span class="c1">// 連鎖ボーナス: 2^(chain-1) 倍（chainが0の場合は1倍）</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="p">)</span><span class="w"> </span><span class="nx">Add</span><span class="p">(</span><span class="nx">erasedCount</span><span class="p">,</span><span class="w"> </span><span class="nx">chain</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">chainBonus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">chain</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 2^(chain-1) を計算</span>
<span class="w">        </span><span class="c1">// 1連鎖: 2^0 = 1</span>
<span class="w">        </span><span class="c1">// 2連鎖: 2^1 = 2</span>
<span class="w">        </span><span class="c1">// 3連鎖: 2^2 = 4</span>
<span class="w">        </span><span class="nx">chainBonus</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nb">uint</span><span class="p">(</span><span class="nx">chain</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">points</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">erasedCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">chainBonus</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">points</span>
<span class="p">}</span>

<span class="c1">// IncrementChain は連鎖数を1増やす</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="p">)</span><span class="w"> </span><span class="nx">IncrementChain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="o">++</span>
<span class="p">}</span>

<span class="c1">// ResetChain は連鎖数を0にリセットする</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="p">)</span><span class="w"> </span><span class="nx">ResetChain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>1 &lt;&lt; uint(chain-1)</code> って何ですか？」良い質問ですね！これはビット左シフト演算で、2のべき乗を計算する効率的な方法なんです。<code>1 &lt;&lt; n</code> は <code>2^n</code> と同じ結果になります。例えば、<code>1 &lt;&lt; 2</code> は <code>4</code> （2の2乗）になります。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/score     0.002s
</code></pre></div>
<p>やった！テストが通りました。これが「Green（緑）」の状態です。</p>
<h3 id="_50">リファクタリング: スコア構造体<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>テストが通ったので、リファクタリングの機会を探しましょう。今回のコードはシンプルで明確なので、特にリファクタリングする必要はありません。次のタスクに進みましょう！</p>
<h3 id="_51">テスト: ゲームへのスコア統合<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>次は、スコアをゲームに統合します。消去が発生したときに連鎖数をカウントし、スコアを加算する機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game_test.go に追加</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestGameScore</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;ぷよを消すとスコアが加算される&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// ボードに4つの赤ぷよを配置（消去可能な状態）</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 消去判定モードに設定</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// スコアが加算されていることを確認</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 * 10 = 40</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span><span class="w">  </span><span class="c1">// 1連鎖</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;連鎖するとボーナスが付く&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 1連鎖目の配置（赤4つ）</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 2連鎖目の配置（青4つ、赤の上）</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 1回目の消去判定</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="nx">firstScore</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nx">firstScore</span><span class="p">)</span><span class="w"> </span><span class="c1">// 4 * 10 * 1 = 40</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 重力適用</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeFalling</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 2回目の消去判定（青が落ちて4つ揃う）</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 2連鎖ボーナスが付いていることを確認</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span><span class="w"> </span><span class="c1">// 40 + (4 * 10 * 2) = 120</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;消去できないときは連鎖がリセットされる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span>

<span class="w">        </span><span class="c1">// 消去できない状態</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 連鎖がリセットされていることを確認</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、ぷよが消えたときのスコア加算、連鎖時のボーナス、連鎖のリセットを確認しています。</p>
<h3 id="_52">実装: ゲームへのスコア統合<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装をしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go に追加</span>
<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;github.com/yourusername/puyo-puyo-go/internal/score&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Game</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Board</span><span class="w">       </span><span class="o">*</span><span class="nx">board</span><span class="p">.</span><span class="nx">Board</span>
<span class="w">    </span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">*</span><span class="nx">pair</span><span class="p">.</span><span class="nx">PuyoPair</span>
<span class="w">    </span><span class="nx">Mode</span><span class="w">        </span><span class="nx">GameMode</span>
<span class="w">    </span><span class="nx">FallTimer</span><span class="w">   </span><span class="kt">float64</span>
<span class="w">    </span><span class="nx">Score</span><span class="w">       </span><span class="o">*</span><span class="nx">score</span><span class="p">.</span><span class="nx">Score</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Game</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Board</span><span class="p">:</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">New</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">Mode</span><span class="p">:</span><span class="w">  </span><span class="nx">ModePlaying</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Score</span><span class="p">:</span><span class="w"> </span><span class="nx">score</span><span class="p">.</span><span class="nx">New</span><span class="p">(),</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">g</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Update</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">dt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60.0</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModePlaying</span><span class="p">:</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">handleInput</span><span class="p">()</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">updateFall</span><span class="p">(</span><span class="nx">dt</span><span class="p">)</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeFalling</span><span class="p">:</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">ApplyGravity</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">g</span><span class="p">.</span><span class="nx">hasFloatingPuyo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeChecking</span><span class="p">:</span>
<span class="w">        </span><span class="nx">positions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">CheckErase</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 連鎖数を増やす</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">IncrementChain</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// スコアを加算</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">positions</span><span class="p">),</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>

<span class="w">            </span><span class="c1">// ぷよを消去</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Erase</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span>

<span class="w">            </span><span class="c1">// 重力適用モードへ</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeFalling</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 消去するぷよがない場合は連鎖終了</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">ResetChain</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// プレイモードへ</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModePlaying</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// hasFloatingPuyo は浮いているぷよがあるかチェックする</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">hasFloatingPuyo</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">--</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">Cols</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ぷよがあり、その下が空の場合</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>
<p>「連鎖の仕組みってどうなってるんですか？」良い質問ですね！連鎖は以下の流れで発生します：</p>
<ol>
<li><strong>Checking モード</strong>: ぷよを消去し、連鎖数を増やす</li>
<li><strong>Falling モード</strong>: 重力を適用してぷよを落とす</li>
<li><strong>Checking モード</strong>: 再度消去判定（消えるぷよがあれば連鎖継続）</li>
<li>消えるぷよがなくなるまで Checking ⇄ Falling を繰り返す</li>
</ol>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/game      0.003s
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="_53">実装: スコアと連鎖数の表示<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>最後に、スコアと連鎖数を画面に表示する機能を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go の Draw メソッドを更新</span>
<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;image/color&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/hajimehoshi/ebiten/v2&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/hajimehoshi/ebiten/v2/ebitenutil&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/hajimehoshi/ebiten/v2/text&quot;</span>
<span class="w">    </span><span class="s">&quot;golang.org/x/image/font&quot;</span>
<span class="w">    </span><span class="s">&quot;golang.org/x/image/font/basicfont&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードを描画</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawBoard</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyoPair</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// スコアを表示</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawScore</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 連鎖数を表示（連鎖中のみ）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawChain</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">drawScore</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">scoreText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Score: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// テキストの描画位置</span>
<span class="w">    </span><span class="nx">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="nx">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">20</span>

<span class="w">    </span><span class="c1">// 白色でスコアを描画</span>
<span class="w">    </span><span class="nx">ebitenutil</span><span class="p">.</span><span class="nx">DebugPrintAt</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">scoreText</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">drawChain</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">chainText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Chain: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// テキストの描画位置（スコアの下）</span>
<span class="w">    </span><span class="nx">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="nx">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">40</span>

<span class="w">    </span><span class="c1">// 黄色で連鎖数を描画</span>
<span class="w">    </span><span class="c1">// 注: ebitenutil.DebugPrintAt は色を指定できないため、</span>
<span class="w">    </span><span class="c1">// より詳細な描画が必要な場合は text.Draw を使用</span>
<span class="w">    </span><span class="nx">ebitenutil</span><span class="p">.</span><span class="nx">DebugPrintAt</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">chainText</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>「色を変えて表示したいんですが...」そうですね！より見やすくするために、色付きテキストを表示する実装も追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// より詳細なテキスト描画（色付き）</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">,</span><span class="w"> </span><span class="nx">str</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">clr</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">Color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 基本フォントを使用</span>
<span class="w">    </span><span class="nx">face</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">basicfont</span><span class="p">.</span><span class="nx">Face7x13</span>

<span class="w">    </span><span class="c1">// テキストを描画</span>
<span class="w">    </span><span class="nx">text</span><span class="p">.</span><span class="nx">Draw</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">str</span><span class="p">,</span><span class="w"> </span><span class="nx">face</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">clr</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードを描画</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawBoard</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyoPair</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// スコアを白色で表示</span>
<span class="w">    </span><span class="nx">scoreText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Score: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">scoreText</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">White</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 連鎖数を黄色で表示（連鎖中のみ）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">chainText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Chain: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">chainText</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_54">ゲームの実行<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>ゲームを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span>run
</code></pre></div>
<p>ぷよを消すとスコアが表示され、連鎖が続くと連鎖数と高いスコアが表示されるはずです！</p>
<h3 id="7_1">イテレーション7のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>スコア構造体</strong></li>
<li>スコアの初期化と加算</li>
<li>連鎖数のカウント機能</li>
<li>
<p>連鎖ボーナスの計算（2^(chain-1)）</p>
</li>
<li>
<p><strong>ゲーム統合</strong></p>
</li>
<li>消去時のスコア加算</li>
<li>連鎖の検出と継続</li>
<li>
<p>連鎖のリセット</p>
</li>
<li>
<p><strong>画面表示</strong></p>
</li>
<li>スコアの表示（白色）</li>
<li>連鎖数の表示（黄色、連鎖中のみ）</li>
<li>
<p>色付きテキスト描画</p>
</li>
<li>
<p><strong>ゲームループの改善</strong></p>
</li>
<li>Checking → Falling → Checking のサイクル</li>
<li>浮いているぷよの検出</li>
</ol>
<h3 id="_55">学んだこと<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ビット演算</strong>: <code>1 &lt;&lt; n</code> による2のべき乗計算</li>
<li><strong>状態遷移</strong>: モード間の遷移による連鎖の実現</li>
<li><strong>テキスト描画</strong>: Ebitenでの文字表示方法</li>
<li><strong>色の指定</strong>: <code>color.RGBA</code> による色の定義</li>
<li><strong>テスト戦略</strong>: 連鎖のような複雑な処理のテスト方法</li>
</ul>
<h3 id="_56">コミット<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>イテレーション7が完了したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: スコアと連鎖数の表示機能を実装</span>

<span class="s1">- スコア構造体（Total/Chain）</span>
<span class="s1">- 連鎖ボーナス計算（2^(chain-1)倍）</span>
<span class="s1">- スコアと連鎖数の画面表示</span>
<span class="s1">- 連鎖継続ロジック（Checking/Falling切り替え）&#39;</span>
</code></pre></div>
<p>次のイテレーションでは、ゲームオーバー判定を実装します！</p>
<h2 id="8">イテレーション8: ゲームオーバー判定<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでスコアと連鎖数が表示されるようになりましたね。「でも、ぷよが積み重なって画面の上まで行ったらどうなるんですか？」それがゲームオーバーです！今回は、ゲームオーバーの判定と表示、そしてリスタート機能を実装していきましょう。</p>
<h3 id="_57">ユーザーストーリー<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとして、ぷよが画面上端に到達したらゲームオーバーになる</p>
<p>プレイヤーとして、ゲームオーバー後にリスタートできる</p>
</blockquote>
<p>「ゲームオーバーになったら、もう一度遊べないと困りますよね？」そうです！だから、ゲームオーバーの判定だけでなく、リスタート機能も一緒に実装しますよ。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>ゲームオーバーのゲームモードを追加する</li>
<li>新しいぷよペアを生成できない場合にゲームオーバーと判定する</li>
<li>ゲームオーバー画面を表示する</li>
<li>リスタート機能を実装する（Rキーでゲームをリセット）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_58">テスト: ゲームオーバー判定<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバーの判定ロジックからテストしていきましょう。新しいぷよペアが配置できない場合にゲームオーバーになることを確認します。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game_test.go に追加</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestGameOver</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;出現位置が埋まっているとゲームオーバーになる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 出現位置(2, 0)にぷよを配置</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 新しいぷよペアを生成しようとする</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// ゲームオーバーモードになっていることを確認</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">ModeGameOver</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="p">)</span>
<span class="w">        </span><span class="c1">// 現在のぷよペアがnilになっていることを確認</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Nil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;出現位置の上（子ぷよの位置）が埋まっていてもゲームオーバーになる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 出現位置の上(-1, 2)にぷよを配置</span>
<span class="w">        </span><span class="c1">// 注: 画面外なので実際にはSetできないが、</span>
<span class="w">        </span><span class="c1">// 子ぷよの初期位置が画面外でも衝突判定される</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 新しいぷよペアを生成しようとする</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// ゲームオーバーモードになっていることを確認</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">ModeGameOver</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;出現位置が空いているとゲームオーバーにならない&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 出現位置を空けておく</span>
<span class="w">        </span><span class="c1">// （何も配置しない）</span>

<span class="w">        </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// プレイモードのままであることを確認</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NotEqual</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">ModeGameOver</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="p">)</span>
<span class="w">        </span><span class="c1">// ぷよペアが生成されていることを確認</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NotNil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、ぷよペアが配置できない状況でゲームオーバーになることを確認しています。「出現位置って、どこですか？」良い質問ですね！ぷよペアは画面上部の中央（X座標2、Y座標0）に出現します。そこに既にぷよがあると、新しいぷよペアを配置できないのでゲームオーバーになるんです。</p>
<h3 id="_59">実装: ゲームオーバー判定<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実装しましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>undefined: ModeGameOver
</code></pre></div>
<p>おっと！<code>ModeGameOver</code>がまだ定義されていませんね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<blockquote>
<p>明白な実装</p>
<p>シンプルな操作をどう実装すればいいだろうか。ただ実装すればいいのだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストを通すための実装を書いていきましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go に追加</span>
<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">ModePlaying</span><span class="w"> </span><span class="nx">GameMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">    </span><span class="nx">ModeFalling</span>
<span class="w">    </span><span class="nx">ModeChecking</span>
<span class="w">    </span><span class="nx">ModeGameOver</span><span class="w">  </span><span class="c1">// ゲームオーバーモードを追加</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">spawnNewPair</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">colors</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">Color</span><span class="p">{</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">,</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorGreen</span><span class="p">,</span>
<span class="w">        </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorYellow</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">axisColor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">colors</span><span class="p">))]</span>
<span class="w">    </span><span class="nx">childColor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">colors</span><span class="p">))]</span>

<span class="w">    </span><span class="nx">newPair</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">pair</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">axisColor</span><span class="p">,</span><span class="w"> </span><span class="nx">childColor</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定：新しいぷよペアが配置できるかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">newPair</span><span class="p">.</span><span class="nx">IsCollision</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">,</span><span class="w"> </span><span class="nx">newPair</span><span class="p">.</span><span class="nx">AxisX</span><span class="p">,</span><span class="w"> </span><span class="nx">newPair</span><span class="p">.</span><span class="nx">AxisY</span><span class="p">,</span>
<span class="w">        </span><span class="nx">newPair</span><span class="p">.</span><span class="nx">ChildX</span><span class="p">,</span><span class="w"> </span><span class="nx">newPair</span><span class="p">.</span><span class="nx">ChildY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 配置できない場合はゲームオーバー</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeGameOver</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 配置できる場合は通常通りセット</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newPair</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">FallTimer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、<code>spawnNewPair</code>で衝突判定をして、配置できない場合はゲームオーバーにするんですね！」そうです。新しいぷよペアを作成してから、実際に配置する前に衝突判定を行います。配置できなければゲームオーバー、配置できれば通常通りゲームを続けます。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/game      0.003s
</code></pre></div>
<p>やった！テストが通りました。これが「Green（緑）」の状態です。</p>
<h3 id="_60">リファクタリング: ゲームオーバー判定<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>テストが通ったので、リファクタリングの機会を探しましょう。今回のコードはシンプルで明確なので、特にリファクタリングする必要はありません。次のタスクに進みましょう！</p>
<h3 id="_61">テスト: ゲームオーバー時の入力処理<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>次は、ゲームオーバー時の入力処理をテストします。ゲームオーバー中は通常の操作ができず、Rキーでリスタートできることを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game_test.go に追加</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestGameOverInput</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;ゲームオーバー中は通常の入力を受け付けない&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeGameOver</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">nil</span>

<span class="w">        </span><span class="c1">// Updateを呼んでも何も起こらない</span>
<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">ModeGameOver</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="p">)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Nil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、ゲームオーバー中に<code>Update</code>を呼んでも状態が変わらないことを確認しています。「Rキーでのリスタートはテストしないんですか？」キーボード入力のテストは少し複雑なので、今回は手動テストで確認することにしましょう。</p>
<h3 id="_62">実装: ゲームオーバー時の処理<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー時の処理を実装しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go の Update を修正</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Update</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームオーバー中の処理</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">ModeGameOver</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Rキーでリスタート</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">inpututil</span><span class="p">.</span><span class="nx">IsKeyJustPressed</span><span class="p">(</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">KeyR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">restart</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">dt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60.0</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModePlaying</span><span class="p">:</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">handleInput</span><span class="p">()</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">updateFall</span><span class="p">(</span><span class="nx">dt</span><span class="p">)</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeFalling</span><span class="p">:</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">ApplyGravity</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">g</span><span class="p">.</span><span class="nx">hasFloatingPuyo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeChecking</span><span class="p">:</span>
<span class="w">        </span><span class="nx">positions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">CheckErase</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">IncrementChain</span><span class="p">()</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">positions</span><span class="p">),</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Erase</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeFalling</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">ResetChain</span><span class="p">()</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModePlaying</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// restart はゲームを初期状態に戻す</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">restart</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードをクリア</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">board</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// スコアをリセット</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">score</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// モードをプレイモードに</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModePlaying</span>

<span class="w">    </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// タイマーをリセット</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">FallTimer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>inpututil.IsKeyJustPressed</code>って何ですか？」良い質問ですね！これは、キーが<strong>押された瞬間だけ</strong> trueを返す関数です。<code>ebiten.IsKeyPressed</code>は押している間ずっとtrueを返しますが、<code>IsKeyJustPressed</code>は1フレームだけtrueを返すので、リスタートのような1回だけ実行したい処理に適しています。</p>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/game      0.003s
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="_63">実装: ゲームオーバー画面の表示<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>最後に、ゲームオーバー画面を表示する機能を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go の Draw メソッドに追加</span>
<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;image/color&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードを描画</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawBoard</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyoPair</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// スコアを表示</span>
<span class="w">    </span><span class="nx">scoreText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Score: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">scoreText</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">White</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 連鎖数を表示（連鎖中のみ）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">chainText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Chain: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">chainText</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー表示</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">ModeGameOver</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawGameOver</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">drawGameOver</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 半透明の黒い背景</span>
<span class="w">    </span><span class="nx">overlay</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">NewImage</span><span class="p">(</span><span class="nx">ScreenWidth</span><span class="p">,</span><span class="w"> </span><span class="nx">ScreenHeight</span><span class="p">)</span>
<span class="w">    </span><span class="nx">overlay</span><span class="p">.</span><span class="nx">Fill</span><span class="p">(</span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">})</span>
<span class="w">    </span><span class="nx">screen</span><span class="p">.</span><span class="nx">DrawImage</span><span class="p">(</span><span class="nx">overlay</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// &quot;GAME OVER&quot; テキストを赤色で表示</span>
<span class="w">    </span><span class="nx">gameOverText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;GAME OVER&quot;</span>
<span class="w">    </span><span class="c1">// 中央揃えのためのX座標計算（フォント幅7、文字数9で計算）</span>
<span class="w">    </span><span class="nx">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="nx">ScreenWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">gameOverText</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nx">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ScreenHeight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">gameOverText</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">})</span>

<span class="w">    </span><span class="c1">// リスタート案内を白色で表示</span>
<span class="w">    </span><span class="nx">restartText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;Press R to Restart&quot;</span>
<span class="w">    </span><span class="nx">x</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">ScreenWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">restartText</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nx">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ScreenHeight</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">30</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">restartText</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">White</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 最終スコアを表示</span>
<span class="w">    </span><span class="nx">finalScoreText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Final Score: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>
<span class="w">    </span><span class="nx">x</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">ScreenWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">finalScoreText</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nx">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ScreenHeight</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">60</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">finalScoreText</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>「半透明の背景を作ってるんですね！」そうです！<code>color.RGBA{0, 0, 0, 180}</code>の最後の数字（180）が透明度を表しています。255が完全に不透明、0が完全に透明です。180は少し透けて見える感じになりますよ。</p>
<h3 id="_64">ゲームの実行<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>ゲームを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span>run
</code></pre></div>
<p>ぷよが画面上部まで積み上がると「GAME OVER」と表示され、Rキーを押すとゲームがリスタートされるはずです！</p>
<h3 id="8_1">イテレーション8のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ゲームオーバー判定</strong></li>
<li>新しいぷよペアが配置できない場合にゲームオーバー</li>
<li><code>ModeGameOver</code>の追加</li>
<li>
<p><code>spawnNewPair</code>での衝突チェック</p>
</li>
<li>
<p><strong>リスタート機能</strong></p>
</li>
<li><code>restart()</code>メソッドによるゲーム初期化</li>
<li>Rキーでのリスタート</li>
<li>
<p>ボード、スコア、モード、タイマーのリセット</p>
</li>
<li>
<p><strong>ゲームオーバー画面</strong></p>
</li>
<li>半透明の黒い背景</li>
<li>"GAME OVER"テキスト（赤色）</li>
<li>リスタート案内（白色）</li>
<li>最終スコア表示（黄色）</li>
<li>
<p>中央揃え表示</p>
</li>
<li>
<p><strong>入力処理の改善</strong></p>
</li>
<li>ゲームオーバー中の通常入力の無効化</li>
<li><code>IsKeyJustPressed</code>による1回だけの入力検出</li>
</ol>
<h3 id="_65">学んだこと<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ゲーム状態管理</strong>: ゲームオーバーモードの追加と処理</li>
<li><strong>入力処理</strong>: <code>IsKeyPressed</code> vs <code>IsKeyJustPressed</code>の違い</li>
<li><strong>画面効果</strong>: 半透明オーバーレイの作成</li>
<li><strong>テキスト配置</strong>: 中央揃えの計算方法</li>
<li><strong>リスタート処理</strong>: ゲーム状態の完全なリセット</li>
</ul>
<h3 id="_66">コミット<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>イテレーション8が完了したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームオーバー判定とリスタート機能を実装</span>

<span class="s1">- 配置不可能時のゲームオーバー判定</span>
<span class="s1">- Rキーによるリスタート機能</span>
<span class="s1">- ゲームオーバー画面表示（半透明背景付き）</span>
<span class="s1">- 最終スコア表示&#39;</span>
</code></pre></div>
<p>次のイテレーションでは、全消しボーナスを実装します！</p>
<h2 id="9">イテレーション9: 全消しボーナス<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームオーバーとリスタート機能が実装できましたね。「すべてのぷよを消したときに、特別なボーナスがあるんですよね？」そうです！全消しは大きなボーナスポイントが得られる特別な達成です。今回は、全消しボーナスを実装していきましょう。</p>
<h3 id="_67">ユーザーストーリー<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、すべてのぷよを消したときに全消しボーナスを得られる</p>
</blockquote>
<p>「全消しって、すごく難しそうですね！」そうですね！でも、成功したときの達成感は格別ですよ。だから、ボーナスポイントも大きくしましょう！</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>ボードが空かどうかを判定する機能を実装する</li>
<li>全消しボーナスポイントをスコアに加算する機能を実装する</li>
<li>全消し時に特別な表示を行う</li>
<li>全消しボーナスの計算ロジックをゲームに統合する</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_68">テスト: 全消し判定<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ボードが空かどうかを判定する機能からテストしていきましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/board/board_test.go に追加</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestIsAllClear</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;空のボードは全消しと判定される&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">isAllClear</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">IsAllClear</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">True</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">isAllClear</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;ぷよが1つでもあると全消しでないと判定される&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 1つだけぷよを配置</span>
<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>

<span class="w">        </span><span class="nx">isAllClear</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">IsAllClear</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">False</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">isAllClear</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;複数のぷよがある場合も全消しでないと判定される&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 複数のぷよを配置</span>
<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span>
<span class="w">        </span><span class="nx">b</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorGreen</span><span class="p">)</span>

<span class="w">        </span><span class="nx">isAllClear</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">IsAllClear</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">False</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">isAllClear</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、ボードが完全に空の場合のみ全消しと判定され、ぷよが1つでも残っている場合は全消しでないと判定されることを確認しています。</p>
<h3 id="_69">実装: 全消し判定<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実装しましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>undefined: Board.IsAllClear
</code></pre></div>
<p>おっと！<code>IsAllClear</code>メソッドがまだ実装されていませんね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<blockquote>
<p>明白な実装</p>
<p>シンプルな操作をどう実装すればいいだろうか。ただ実装すればいいのだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストを通すための実装を書いていきましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/board/board.go に追加</span>
<span class="c1">// IsAllClear は盤面上のぷよが全て消えているかチェックする</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">Board</span><span class="p">)</span><span class="w"> </span><span class="nx">IsAllClear</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Rows</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Cols</span><span class="p">;</span><span class="w"> </span><span class="nx">col</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">Cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorNone</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// ぷよが1つでもあればfalse</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// すべてのセルが空ならtrue</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうです。全てのセルをチェックして、1つでもぷよがあればfalseを返し、すべて空ならtrueを返すだけです。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/board     0.002s
</code></pre></div>
<p>やった！テストが通りました。これが「Green（緑）」の状態です。</p>
<h3 id="_70">リファクタリング: 全消し判定<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>テストが通ったので、リファクタリングの機会を探しましょう。今回のコードはシンプルで明確なので、特にリファクタリングする必要はありません。次のタスクに進みましょう！</p>
<h3 id="_71">テスト: 全消しボーナス<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>次は、全消しボーナスをスコアに加算する機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/score/score_test.go に追加</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestAllClearBonus</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;全消しボーナスは5000点&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1000</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">AddAllClearBonus</span><span class="p">()</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span><span class="w"> </span><span class="c1">// 1000 + 5000 = 6000</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;全消しボーナスは何度でも加算できる&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">AddAllClearBonus</span><span class="p">()</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">AddAllClearBonus</span><span class="p">()</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span><span class="w"> </span><span class="c1">// 5000 + 5000 = 10000</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、全消しボーナスとして5000点が加算されることを確認しています。「5000点って、けっこう大きいですね！」そうです！全消しは難しい達成なので、大きなボーナスにしているんです。</p>
<h3 id="_72">実装: 全消しボーナス<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/score/score.go に追加</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">AllClearBonus</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5000</span>

<span class="c1">// AddAllClearBonus は全消しボーナスを加算する</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Score</span><span class="p">)</span><span class="w"> </span><span class="nx">AddAllClearBonus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">Total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">AllClearBonus</span>
<span class="p">}</span>
</code></pre></div>
<p>「定数で定義しているんですね！」そうです。ボーナスの値を変更したくなったとき、1箇所だけ修正すればいいようにしています。</p>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/score     0.002s
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="_73">テスト: ゲームへの全消しボーナス統合<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>次は、ゲームに全消しボーナスを統合します。ぷよを消した後にボードが空になっていたら、ボーナスが加算されることをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game_test.go に追加</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">TestAllClearBonus</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;全てのぷよを消すと全消しボーナスが加算される&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 消去可能な4つの赤ぷよのみを配置</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 通常スコア(40) + 全消しボーナス(5000)</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">5040</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;ぷよが残っている場合は全消しボーナスが加算されない&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">New</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 消去可能な4つの赤ぷよと、残る1つの青ぷよを配置</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorRed</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">ColorBlue</span><span class="p">)</span><span class="w">  </span><span class="c1">// 残るぷよ</span>

<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 通常スコア(40)のみ</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>このテストでは、全てのぷよを消したときだけ全消しボーナスが加算されることを確認しています。</p>
<h3 id="_74">実装: ゲームへの全消しボーナス統合<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装をしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go の Update を修正</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Update</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームオーバー中の処理</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">ModeGameOver</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">inpututil</span><span class="p">.</span><span class="nx">IsKeyJustPressed</span><span class="p">(</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">KeyR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">restart</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">dt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60.0</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModePlaying</span><span class="p">:</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">handleInput</span><span class="p">()</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">updateFall</span><span class="p">(</span><span class="nx">dt</span><span class="p">)</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeFalling</span><span class="p">:</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">ApplyGravity</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">g</span><span class="p">.</span><span class="nx">hasFloatingPuyo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeChecking</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">ModeChecking</span><span class="p">:</span>
<span class="w">        </span><span class="nx">positions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">CheckErase</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 連鎖数を増やす</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">IncrementChain</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// スコアを加算</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">positions</span><span class="p">),</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>

<span class="w">            </span><span class="c1">// ぷよを消去</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">Erase</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span>

<span class="w">            </span><span class="c1">// 全消しチェック</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">IsAllClear</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">AddAllClearBonus</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 重力適用モードへ</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModeFalling</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 消去するぷよがない場合は連鎖終了</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">ResetChain</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">spawnNewPair</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// プレイモードへ</span>
<span class="w">            </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ModePlaying</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>
<p>「消去した直後に全消しチェックをするんですね！」そうです。ぷよを消去した後、ボードが空になっていたら全消しボーナスを加算します。</p>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS
ok      github.com/yourusername/puyo-puyo-go/internal/game      0.003s
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="_75">実装: 全消し表示<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>最後に、全消しを達成したときの表示を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// internal/game/game.go の Draw メソッドに追加</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードを描画</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawBoard</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 現在のぷよペアを描画</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">CurrentPair</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawPuyoPair</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// スコアを表示</span>
<span class="w">    </span><span class="nx">scoreText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Score: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Total</span><span class="p">)</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">scoreText</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">White</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 連鎖数を表示（連鎖中のみ）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">chainText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Chain: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Score</span><span class="p">.</span><span class="nx">Chain</span><span class="p">)</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">chainText</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 全消し表示</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Board</span><span class="p">.</span><span class="nx">IsAllClear</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">ModeChecking</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawAllClear</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー表示</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">ModeGameOver</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawGameOver</span><span class="p">(</span><span class="nx">screen</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Game</span><span class="p">)</span><span class="w"> </span><span class="nx">drawAllClear</span><span class="p">(</span><span class="nx">screen</span><span class="w"> </span><span class="o">*</span><span class="nx">ebiten</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// &quot;ALL CLEAR!&quot; テキストを金色で表示</span>
<span class="w">    </span><span class="nx">allClearText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;ALL CLEAR!&quot;</span>
<span class="w">    </span><span class="c1">// 中央揃えのためのX座標計算</span>
<span class="w">    </span><span class="nx">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="nx">ScreenWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">allClearText</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nx">y</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ScreenHeight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="c1">// 金色（R:255, G:215, B:0）</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">allClearText</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">215</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">})</span>

<span class="w">    </span><span class="c1">// ボーナスポイント表示</span>
<span class="w">    </span><span class="nx">bonusText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;+%d BONUS!&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">.</span><span class="nx">AllClearBonus</span><span class="p">)</span>
<span class="w">    </span><span class="nx">x</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">ScreenWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">bonusText</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nx">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ScreenHeight</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span>
<span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">drawColoredText</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">bonusText</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>「金色で "ALL CLEAR!" って表示されるんですね！かっこいい！」そうでしょう？達成したときの喜びが大きくなるように、目立つ表示にしました。</p>
<h3 id="_76">ゲームの実行<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>ゲームを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>task<span class="w"> </span>run
</code></pre></div>
<p>すべてのぷよを消すと「ALL CLEAR!」と金色のテキストが表示され、5000点のボーナスが加算されるはずです！</p>
<h3 id="9_1">イテレーション9のまとめ<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>全消し判定</strong></li>
<li><code>IsAllClear()</code>メソッドによるボード空判定</li>
<li>
<p>全セルのチェック</p>
</li>
<li>
<p><strong>全消しボーナス</strong></p>
</li>
<li>5000点の固定ボーナス</li>
<li><code>AddAllClearBonus()</code>メソッド</li>
<li>
<p>定数による値管理</p>
</li>
<li>
<p><strong>ゲーム統合</strong></p>
</li>
<li>消去後の全消しチェック</li>
<li>ボーナスポイント加算</li>
<li>
<p>チェックタイミングの最適化</p>
</li>
<li>
<p><strong>全消し表示</strong></p>
</li>
<li>"ALL CLEAR!"テキスト（金色）</li>
<li>ボーナスポイント表示（黄色）</li>
<li>中央揃え表示</li>
<li>表示タイミング制御</li>
</ol>
<h3 id="_77">学んだこと<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>全探索</strong>: 2次元配列の全要素チェック</li>
<li><strong>定数管理</strong>: マジックナンバーの排除</li>
<li><strong>色の選択</strong>: 金色の表現（RGB: 255, 215, 0）</li>
<li><strong>条件表示</strong>: モードとボード状態の組み合わせ判定</li>
<li><strong>ユーザー体験</strong>: 達成感を高める視覚的フィードバック</li>
</ul>
<h3 id="_78">コミット<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>イテレーション9が完了したので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 全消しボーナス機能を実装</span>

<span class="s1">- ボード空判定（IsAllClear）</span>
<span class="s1">- 5000点の全消しボーナス</span>
<span class="s1">- &quot;ALL CLEAR!&quot;表示（金色）</span>
<span class="s1">- ボーナスポイント表示&#39;</span>
</code></pre></div>
<h3 id="_79">ゲーム完成！<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p>おめでとうございます！これですべてのイテレーションが完了し、ぷよぷよゲームが完成しました！</p>
<h2 id="_80">まとめ<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h2>
<h3 id="_81">完成したゲームの機能<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>このチュートリアルで実装した機能：</p>
<ol>
<li><strong>基本操作</strong></li>
<li>ぷよペアの左右移動</li>
<li>ぷよペアの回転（壁キック付き）</li>
<li>
<p>高速落下（下キー）</p>
</li>
<li>
<p><strong>ゲームロジック</strong></p>
</li>
<li>自動落下（タイマー制御）</li>
<li>着地判定</li>
<li>消去判定（DFSによる4つ以上の検出）</li>
<li>重力処理</li>
<li>
<p>連鎖システム</p>
</li>
<li>
<p><strong>スコアシステム</strong></p>
</li>
<li>基本スコア（消した数 × 10）</li>
<li>連鎖ボーナス（2^(chain-1)倍）</li>
<li>
<p>全消しボーナス（5000点）</p>
</li>
<li>
<p><strong>ゲーム管理</strong></p>
</li>
<li>ゲームオーバー判定</li>
<li>リスタート機能（Rキー）</li>
<li>スコアと連鎖数の表示</li>
<li>全消し表示</li>
</ol>
<h3 id="tdd">TDDで学んだこと<a class="headerlink" href="#tdd" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Red-Green-Refactor サイクル</strong></li>
<li>失敗するテストを先に書く</li>
<li>最小限の実装でテストを通す</li>
<li>
<p>コードを改善する</p>
</li>
<li>
<p><strong>Goの重要な概念</strong></p>
</li>
<li>構造体とメソッド</li>
<li>インターフェース設計</li>
<li>ポインタとゼロ値</li>
<li>エラーハンドリング</li>
<li>パッケージ構成（cmd/internal）</li>
<li>ビット演算</li>
<li>
<p>定数管理</p>
</li>
<li>
<p><strong>アルゴリズム</strong></p>
</li>
<li>深さ優先探索（DFS）</li>
<li>衝突判定</li>
<li>回転計算</li>
<li>重力処理</li>
<li>
<p>2次元配列の操作</p>
</li>
<li>
<p><strong>ゲーム開発パターン</strong></p>
</li>
<li>Ebitenゲームループ（Update/Draw/Layout）</li>
<li>状態遷移（Playing → Falling → Checking）</li>
<li>タイマー管理（deltaTime）</li>
<li>入力処理（IsKeyPressed/IsKeyJustPressed）</li>
</ol>
<h3 id="go">Goの特徴を活かした実装<a class="headerlink" href="#go" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>シンプルさ</strong>: 複雑な継承なしでの設計</li>
<li><strong>明示性</strong>: エラーハンドリングが明示的</li>
<li><strong>高速性</strong>: コンパイル型言語の性能</li>
<li><strong>並行性</strong>: （将来的にgoroutineで拡張可能）</li>
</ul>
<h3 id="_82">次のステップ<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>このゲームをさらに発展させるアイデア：</p>
<ol>
<li><strong>グラフィックの改善</strong></li>
<li>画像アセットの使用（<code>ebiten/v2/ebitenutil.NewImageFromFile</code>）</li>
<li>アニメーション効果（消去時のエフェクト）</li>
<li>
<p>パーティクルシステム</p>
</li>
<li>
<p><strong>音声の追加</strong></p>
</li>
<li><code>github.com/hajimehoshi/ebiten/v2/audio</code>を使用</li>
<li>BGM再生</li>
<li>
<p>効果音（移動、回転、消去、連鎖）</p>
</li>
<li>
<p><strong>追加機能</strong></p>
</li>
<li>ネクストぷよの表示（次に来るぷよの予告）</li>
<li>ハイスコア記録（JSONファイルで保存）</li>
<li>難易度調整（落下速度の変更）</li>
<li>
<p>おじゃまぷよ（対戦時に送られる邪魔なぷよ）</p>
</li>
<li>
<p><strong>マルチプレイ</strong></p>
</li>
<li>2Pモード（同一画面で対戦）</li>
<li>ネットワーク対戦（<code>net</code>パッケージ使用）</li>
</ol>
<h3 id="_83">最終コミット<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p>すべての機能が完成したので、最終コミットとタグを作成しましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよぷよゲーム完成！</span>

<span class="s1">全イテレーション完了：</span>
<span class="s1">- イテレーション0: 環境構築</span>
<span class="s1">- イテレーション1: ゲーム開始とボード表示</span>
<span class="s1">- イテレーション2: ぷよペアの表示と移動</span>
<span class="s1">- イテレーション3: ぷよペアの回転</span>
<span class="s1">- イテレーション4: ぷよの自動落下</span>
<span class="s1">- イテレーション5: ぷよの消去ロジック</span>
<span class="s1">- イテレーション6: 連鎖反応とスコア</span>
<span class="s1">- イテレーション7: スコアと連鎖数の表示</span>
<span class="s1">- イテレーション8: ゲームオーバー判定</span>
<span class="s1">- イテレーション9: 全消しボーナス&#39;</span>

git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span>v1.0.0<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;ぷよぷよゲーム v1.0.0 リリース&#39;</span>
</code></pre></div>
<h3 id="_84">終わりに<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>「TDDでゲームを作るのは楽しかったです！」そうですね！テスト駆動開発は、最初は面倒に感じるかもしれませんが、確実に品質の高いコードを書くことができます。</p>
<p>「Goはシンプルで書きやすいですね！」はい、Goの設計思想である「シンプルさ」と「明示性」は、保守しやすいコードを書くのに最適です。</p>
<blockquote>
<p>Simplicity is complicated.</p>
<p>— Rob Pike（Go言語開発者）</p>
</blockquote>
<p>この言葉は、「シンプルなものを作るのは実は複雑だ」という意味です。Goは、シンプルさを実現するために、多くの工夫がされている言語なんです。</p>
<p>「次は何を作りましょうか？」良い質問ですね！学んだTDDの技術を使って、自分のオリジナルなゲームやアプリケーションを作ってみてください。Goのシンプルさとテストの力を借りれば、安全で高品質なソフトウェアを作ることができます。</p>
<p>ぷよぷよを通じてテスト駆動開発とGo/Ebitenの基礎を学べたことを願っています。Happy Coding!</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;ぷよぷよゲーム、完成！🎉&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Simple made easy.&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>テスト駆動開発を使うことで、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>皆さんも、このゴールに一歩近づけたのではないでしょうか？これからも、テストを書きながら、楽しく開発を続けてください！</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>