
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 F# Elmish.WPF版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#f-elmishwpf" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 F# Elmish.WPF版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="f-elmishwpf">ぷよぷよから始めるテスト駆動開発入門 F# Elmish.WPF版<a class="headerlink" href="#f-elmishwpf" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>注記</strong>: このドキュメントのイテレーション2以降は、Bolero版から自動変換されたものです。
View部分のコード例は、Bolero (Bolero.Html) の記法のままになっている箇所があります。
実際のWPF実装では、以下のような対応関係になります:</p>
<ul>
<li><strong>Bolero</strong>: <code>div []</code> / <code>button []</code> → <strong>WPF</strong>: XAML <code>&lt;StackPanel&gt;</code> / <code>&lt;Button&gt;</code></li>
<li><strong>Bolero</strong>: <code>on.click</code> → <strong>WPF</strong>: <code>Command="{Binding ...}"</code></li>
<li><strong>Bolero</strong>: <code>on.keydown</code> → <strong>WPF</strong>: <code>&lt;Window.InputBindings&gt;&lt;KeyBinding .../&gt;&lt;/Window.InputBindings&gt;</code></li>
<li><strong>Bolero</strong>: <code>attr.classes</code> → <strong>WPF</strong>: <code>Style="{StaticResource ...}"</code></li>
</ul>
<p>ドメインロジック部分 (GameLogic, PuyoPair, Board など) とElmish層 (Model, Update) のコードは、
Bolero版とWPF版で共通です。</p>
</blockquote>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは!今日は私と一緒にテスト駆動開発(TDD)を使って、F#とElmish.WPFでぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか?もしかしたら「テストって、コードを書いた後にするものじゃないの?」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説:テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの?」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう!</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか?「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか?</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう:</p>
<ol>
<li><strong>Red(赤)</strong>: まず失敗するテストを書きます。「え?わざと失敗するテストを?」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green(緑)</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor(リファクタリング)</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください!</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか?プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅(第2版)</p>
</blockquote>
<p>「どんなツールを使えばいいの?」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます:</p>
<ul>
<li><strong>言語</strong>: F# — 関数型プログラミングの力で、型安全で表現力豊かなコードを書きましょう。</li>
<li><strong>UIフレームワーク</strong>: Elmish.WPF — WPFベースのF#フレームワークで、Elmishアーキテクチャによる予測可能な状態管理を実現します。</li>
<li><strong>テストフレームワーク</strong>: xUnit — .NET標準のテストフレームワークです。</li>
<li><strong>アサーションライブラリ</strong>: FsUnit — F#らしいテストコードを書くためのライブラリです。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ?昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション0: 環境の構築で解説します。</p>
<h2 id="_4">要件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">ユーザーストーリー<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーは、ソフトウェア要求を表現するための軽量な手法である。ユーザーストーリーは、システムについてユーザーまたは顧客の視点からフィーチャの概要を記述したものだ。
ユーザーストーリーには形式が定められておらず、標準的な記法もない。とはいえ、次のような形式でストーリーを考えてみると便利である。「＜ユーザーの種類＞として、＜機能や性能＞がほしい。それは＜ビジネス価値＞のためだ」という形のテンプレートに従うと、
たとえば次のようなストーリーを書ける。「本の購入者として、ＩＳＢＮで本を検索したい。それは探している本をすばやく見つけるためだ」</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう：</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜ん！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PCでプレイするなら必須ですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_6">ユースケース図<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>ユーザーストーリーを整理したところで、「これらの機能がどのように関連しているのか、全体像が見えるといいな」と思いませんか？そんなときに役立つのが「ユースケース図」です。
「ユースケース図って何？」と思われるかもしれませんね。ユースケース図は、システムと外部アクター（ここではプレイヤーとシステム自体）の相互作用を視覚的に表現するための図です。「絵に描いて整理すると分かりやすい」というやつですね。</p>
<blockquote>
<p>ユースケースは、システムの振る舞いに関する利害関係者の契約を表現するものです。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<p>「百聞は一見にしかず」というように、実際に見てみるのが一番分かりやすいですよね。では、私たちのぷよぷよゲームのユースケース図を見てみましょう：</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjU4OXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODI2cHg7aGVpZ2h0OjU4OXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgyNiA1ODkiIHdpZHRoPSI4MjZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU3NiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxNS4wNyIgeD0iMTEyIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1My45OTkzIiB4PSIzNDIuNTM1MyIgeT0iMjEuOTk1MSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MDc7JiMxMjQyNDsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfU3RhcnROZXdHYW1lIj48ZWxsaXBzZSBjeD0iMjE0LjAyNTkiIGN5PSI0NjkuOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMTUxLjAyNjIiIHk9IjQ3NC42NDM2Ij4mIzI2MDMyOyYjMTIzNzU7JiMxMjM1NjsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDM0OyYjMzgyODM7JiMyMjk4Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9SZXN0YXJ0R2FtZSI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iNTQwLjk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI1NDUuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQzNDsmIzEyNTIyOyYjMTI0NzM7JiMxMjQ3OTsmIzEyNTQwOyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1vdmVQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfTW92ZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjE5OS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNTguMDMyNyIgeT0iMjAzLjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMjQwMzg7JiMyMTQ5MTsmIzEyMzk1OyYjMzEyMjc7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUm90YXRlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfUm90YXRlUHV5byI+PGVsbGlwc2UgY3g9IjIxNC4wMjczIiBjeT0iMTMzLjAwMzYiIGZpbGw9IiNGMUYxRjEiIHJ4PSI1Mi40OTczIiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMTc5LjAyNzQiIHk9IjEzNy42NTIxIj4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzIyMjM4OyYjMzY1Nzg7PC90ZXh0PjwvZz48IS0tZW50aXR5IFF1aWNrRHJvcFB1eW8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X1F1aWNrRHJvcFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjY3LjAwMDUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3Mi4yNTI0IiByeT0iMTYuODUwNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjE1OC4wMzI3IiB5PSI3MS42NDg5Ij4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzMyMDMyOyYjMjYwODk7JiMxMjM2NzsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZhbGxQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZhbGxQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfRmFsbFB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI1MiIgY3k9IjMyOS45OTUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI2Ni43MjUyIiByeT0iMTUuNzQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSIxNjUuMDI1NCIgeT0iMzM0LjY0MzUiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMzMyNTg7JiMzMDAwMTsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEVyYXNlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJFcmFzZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9FcmFzZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI3MyIgY3k9IjI2NS4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjE3OS4wMjc0IiB5PSIyNjkuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyODA0MDsmIzIxNDM1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjI3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9DaGFpblJlYWN0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTIiIGN5PSIyNTYuOTk1IiBmaWxsPSIjRjFGMUYxIiByeD0iNjYuNzI1MiIgcnk9IjE1Ljc0NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMzg3LjAzNTQiIHk9IjI2MS42NDM1Ij4mIzM2ODk5OyYjMzc3ODI7JiMyMTQ1MzsmIzI0NTQwOyYjMTI0MzQ7JiMzMDMzMDsmIzI5OTgzOzwvdGV4dD48L2c+PCEtLWVudGl0eSBaZW5rZXNoaUJvbnVzLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ilplbmtlc2hpQm9udXMiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0iZW50MDAxMyIgaWQ9ImVudGl0eV9aZW5rZXNoaUJvbnVzIj48ZWxsaXBzZSBjeD0iNDM2LjA0MzEiIGN5PSIzMjYuOTk4NiIgZmlsbD0iI0YxRjFGMSIgcng9IjgzLjk5MzEiIHJ5PSIxOS4xOTg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iMzY2LjA0MzQiIHk9IjMzMS42NDcxIj4mIzIwODQwOyYjMjgwNDA7JiMxMjM3NTsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ5MDsmIzEyNDczOyYjMTI0MzQ7JiMyOTU1NDsmIzI0NDcxOzwvdGV4dD48L2c+PCEtLWVudGl0eSBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSIyOSIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJlbnRpdHlfRGlzcGxheVNjb3JlIj48ZWxsaXBzZSBjeD0iNjQxLjU1NDIiIGN5PSIyNTYuMDAyOCIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1OTkuNTU0NCIgeT0iMjYwLjY1MTMiPiYjMTI0NzM7JiMxMjQ2NzsmIzEyNDUwOyYjMTI0MzQ7JiMzNDkyMDsmIzMxMDM0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzNCIgZGF0YS11aWQ9ImVudDAwMTUiIGlkPSJlbnRpdHlfS2V5Ym9hcmRDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjA0MjQiIGN5PSIxMDAuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMzgwLjA0MjciIHk9IjEwNC42NDg5Ij4mIzEyNDYxOyYjMTI1NDA7JiMxMjUwODsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5MTsmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IEdhbWVPdmVyQ2hlY2stLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR2FtZU92ZXJDaGVjayIgZGF0YS1zb3VyY2UtbGluZT0iMzkiIGRhdGEtdWlkPSJlbnQwMDE2IiBpZD0iZW50aXR5X0dhbWVPdmVyQ2hlY2siPjxlbGxpcHNlIGN4PSIyMTQuMDI1OSIgY3k9IjM5OC45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIxNTEuMDI2MiIgeT0iNDAzLjY0MzYiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0NTg7JiMxMjU0MDsmIzEyNDk2OyYjMTI1NDA7JiMyMTAyODsmIzIzNDUwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBHYW1lT3ZlckFuaW1hdGlvbi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHYW1lT3ZlckFuaW1hdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iNDAiIGRhdGEtdWlkPSJlbnQwMDE3IiBpZD0iZW50aXR5X0dhbWVPdmVyQW5pbWF0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTkiIGN5PSIzOTguOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMzczLjAzNjIiIHk9IjQwMy42NDM2Ij4mIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDU4OyYjMTI1NDA7JiMxMjQ5NjsmIzEyNTQwOyYjMjg0MzY7JiMyMDk4Njs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUGxheWVyLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlBsYXllciIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJlbnRpdHlfUGxheWVyIj48ZWxsaXBzZSBjeD0iNDAuOTk5OCIgY3k9IjEzNi4zNSIgZmlsbD0iI0YxRjFGMSIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNDAuOTk5OCwxNDQuMzUgTDQwLjk5OTgsMTcxLjM1IE0yNy45OTk4LDE1Mi4zNSBMNTMuOTk5OCwxNTIuMzUgTTQwLjk5OTgsMTcxLjM1IEwyNy45OTk4LDE4Ni4zNSBNNDAuOTk5OCwxNzEuMzUgTDUzLjk5OTgsMTg2LjM1IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI2IiB5PSIyMDAuODQ1MSI+JiMxMjUwMzsmIzEyNTI0OyYjMTI0NTI7JiMxMjUxNjsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTeXN0ZW0tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImVudGl0eV9TeXN0ZW0iPjxlbGxpcHNlIGN4PSI3OTEuMDY5OSIgY3k9IjQzNi4zNSIgZmlsbD0iI0YxRjFGMSIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNzkxLjA2OTksNDQ0LjM1IEw3OTEuMDY5OSw0NzEuMzUgTTc3OC4wNjk5LDQ1Mi4zNSBMODA0LjA2OTksNDUyLjM1IE03OTEuMDY5OSw0NzEuMzUgTDc3OC4wNjk5LDQ4Ni4zNSBNNzkxLjA2OTksNDcxLjM1IEw4MDQuMDY5OSw0ODYuMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9Ijc2My4wNyIgeT0iNTAwLjg0NTEiPiYjMTI0NzE7JiMxMjQ3MzsmIzEyNDg2OyYjMTI1MTI7PC90ZXh0PjwvZz48IS0tbGluayBQbGF5ZXIgdG8gU3RhcnROZXdHYW1lLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSI0NSIgZGF0YS11aWQ9ImxuazE4IiBpZD0ibGlua19QbGF5ZXJfU3RhcnROZXdHYW1lIj48cGF0aCBkPSJNNTMuMDcsMjA0LjUgQzUzLjA3LDI4Ni4zIDUzLjA3LDQ3MCA1My4wNyw0NzAgQzUzLjA3LDQ3MCA4OC44OSw0NzAgMTI5LjksNDcwIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVN0YXJ0TmV3R2FtZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTM1LjksNDcwLDEyNi45LDQ2NiwxMzAuOSw0NzAsMTI2LjksNDc0LDEzNS45LDQ3MCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSZXN0YXJ0R2FtZSIgZGF0YS1zb3VyY2UtbGluZT0iNDYiIGRhdGEtdWlkPSJsbmsxOSIgaWQ9ImxpbmtfUGxheWVyX1Jlc3RhcnRHYW1lIj48cGF0aCBkPSJNMjkuMDcsMjA0LjM3IEMyOS4wNywyOTkuOTQgMjkuMDcsNTQxIDI5LjA3LDU0MSBDMjkuMDcsNTQxIDc5LjE4LDU0MSAxMjkuNTksNTQxIiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJlc3RhcnRHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNTksNTQxLDEyNi41OSw1MzcsMTMwLjU5LDU0MSwxMjYuNTksNTQ1LDEzNS41OSw1NDEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIE1vdmVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iTW92ZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjQ3IiBkYXRhLXVpZD0ibG5rMjAiIGlkPSJsaW5rX1BsYXllcl9Nb3ZlUHV5byI+PHBhdGggZD0iTTc2LjQzLDE5My4xNSBDOTYuNCwxOTMuMTUgMTE2LjAzLDE5My4xNSAxMzkuNzUsMTkzLjE1IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLU1vdmVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDUuNzUsMTkzLjE1LDEzNi43NSwxODkuMTUsMTQwLjc1LDE5My4xNSwxMzYuNzUsMTk3LjE1LDE0NS43NSwxOTMuMTUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIFJvdGF0ZVB1eW8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSI0OCIgZGF0YS11aWQ9ImxuazIxIiBpZD0ibGlua19QbGF5ZXJfUm90YXRlUHV5byI+PHBhdGggZD0iTTc2LjQzLDE0MC45NyBDMTAzLjMyLDE0MC45NyAxMzQuNDgsMTQwLjk3IDE2My40LDE0MC45NyIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1Sb3RhdGVQdXlvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNjkuNCwxNDAuOTcsMTYwLjQsMTM2Ljk3LDE2NC40LDE0MC45NywxNjAuNCwxNDQuOTcsMTY5LjQsMTQwLjk3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBRdWlja0Ryb3BQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUXVpY2tEcm9wUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iNDkiIGRhdGEtdWlkPSJsbmsyMiIgaWQ9ImxpbmtfUGxheWVyX1F1aWNrRHJvcFB1eW8iPjxwYXRoIGQ9Ik03Ni40NSwxMzQuNDEgQzEwOC45NSwxMzQuNDEgMTUyLjA3LDEzNC40MSAxNTIuMDcsMTM0LjQxIEMxNTIuMDcsMTM0LjQxIDE1Mi4wNywxMDAuNDkgMTUyLjA3LDgyLjA5IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVF1aWNrRHJvcFB1eW8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1Mi4wNyw3Ni4wOSwxNDguMDcsODUuMDksMTUyLjA3LDgxLjA5LDE1Ni4wNyw4NS4wOSwxNTIuMDcsNzYuMDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNTAiIGRhdGEtdWlkPSJsbmsyMyIgaWQ9ImxpbmtfUGxheWVyX0tleWJvYXJkQ29udHJvbCI+PHBhdGggZD0iTTQxLjA3LDEyNy40OSBDNDEuMDcsMTExLjcgNDEuMDcsOTcuMDUgNDEuMDcsOTcuMDUgQzQxLjA3LDk3LjA1IDI0NC42OSw5Ny4wNSAzNTguNTIsOTcuMDUiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjQuNTIsOTcuMDUsMzU1LjUyLDkzLjA1LDM1OS41Miw5Ny4wNSwzNTUuNTIsMTAxLjA1LDM2NC41Miw5Ny4wNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIEVyYXNlUHV5byB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRXJhc2VQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjUzIiBkYXRhLXVpZD0ibG5rMjQiIGlkPSJsaW5rX0VyYXNlUHV5b19TeXN0ZW0iPjxwYXRoIGQ9Ik0yNzIuODMsMjY1LjMyIEMzMDQuMjYsMjY1LjMyIDMzMi4wNywyNjUuMzIgMzMyLjA3LDI2NS4zMiBDMzMyLjA3LDI2NS4zMiAzMzIuMDcsNDM3LjUxIDMzMi4wNyw0MzcuNTEgQzMzMi4wNyw0MzcuNTEgNjYyLjYzLDQzNy41MSA3NjIuNyw0MzcuNTEiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjY2LjgzLDI2NS4zMiwyNzUuODMsMjY5LjMyLDI3MS44MywyNjUuMzIsMjc1LjgzLDI2MS4zMiwyNjYuODMsMjY1LjMyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRmFsbFB1eW8gdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkZhbGxQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU0IiBkYXRhLXVpZD0ibG5rMjUiIGlkPSJsaW5rX0ZhbGxQdXlvX1N5c3RlbSI+PHBhdGggZD0iTTI4Ny4wNSwzMzAgQzMwNC4yOCwzMzAgMzEyLjA3LDMzMCAzMTIuMDcsMzMwIEMzMTIuMDcsMzMwIDMxMi4wNyw0NDIuMzQgMzEyLjA3LDQ0Mi4zNCBDMzEyLjA3LDQ0Mi4zNCA2NjAuMjEsNDQyLjM0IDc2Mi44OSw0NDIuMzQiIGZpbGw9Im5vbmUiIGlkPSJGYWxsUHV5by1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyODEuMDUsMzMwLDI5MC4wNSwzMzQsMjg2LjA1LDMzMCwyOTAuMDUsMzI2LDI4MS4wNSwzMzAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBDaGFpblJlYWN0aW9uIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJDaGFpblJlYWN0aW9uIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU1IiBkYXRhLXVpZD0ibG5rMjYiIGlkPSJsaW5rX0NoYWluUmVhY3Rpb25fU3lzdGVtIj48cGF0aCBkPSJNNTAzLjczLDI2My4zNSBDNTMwLjU5LDI2My4zNSA1NTAuMDcsMjYzLjM1IDU1MC4wNywyNjMuMzUgQzU1MC4wNywyNjMuMzUgNTUwLjA3LDQzMi42OCA1NTAuMDcsNDMyLjY4IEM1NTAuMDcsNDMyLjY4IDY5OS4zOCw0MzIuNjggNzYyLjk1LDQzMi42OCIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDk3LjczLDI2My4zNSw1MDYuNzMsMjY3LjM1LDUwMi43MywyNjMuMzUsNTA2LjczLDI1OS4zNSw0OTcuNzMsMjYzLjM1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgWmVua2VzaGlCb251cyB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iWmVua2VzaGlCb251cyIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NiIgZGF0YS11aWQ9ImxuazI3IiBpZD0ibGlua19aZW5rZXNoaUJvbnVzX1N5c3RlbSI+PHBhdGggZD0iTTUyNi4xOCwzMjcgQzYzMS4xNiwzMjcgNzkxLjA3LDMyNyA3OTEuMDcsMzI3IEM3OTEuMDcsMzI3IDc5MS4wNywzODYuNTEgNzkxLjA3LDQyNy42NSIgZmlsbD0ibm9uZSIgaWQ9Ilplbmtlc2hpQm9udXMtYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTIwLjE4LDMyNyw1MjkuMTgsMzMxLDUyNS4xOCwzMjcsNTI5LjE4LDMyMyw1MjAuMTgsMzI3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRGlzcGxheVNjb3JlIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJEaXNwbGF5U2NvcmUiIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTciIGRhdGEtdWlkPSJsbmsyOCIgaWQ9ImxpbmtfRGlzcGxheVNjb3JlX1N5c3RlbSI+PHBhdGggZD0iTTcwOS4zNywyNTYgQzc1NS42NywyNTYgODA1LjA3LDI1NiA4MDUuMDcsMjU2IEM4MDUuMDcsMjU2IDgwNS4wNywzNjYuODYgODA1LjA3LDQyNy40OCIgZmlsbD0ibm9uZSIgaWQ9IkRpc3BsYXlTY29yZS1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MDMuMzcsMjU2LDcxMi4zNywyNjAsNzA4LjM3LDI1Niw3MTIuMzcsMjUyLDcwMy4zNywyNTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckNoZWNrIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJHYW1lT3ZlckNoZWNrIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU4IiBkYXRhLXVpZD0ibG5rMjkiIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfU3lzdGVtIj48cGF0aCBkPSJNMjE0LjA3LDQyMy40OCBDMjE0LjA3LDQzNy4wNyAyMTQuMDcsNDQ3LjE3IDIxNC4wNyw0NDcuMTcgQzIxNC4wNyw0NDcuMTcgNjQ3LDQ0Ny4xNyA3NjIuODUsNDQ3LjE3IiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJDaGVjay1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMTQuMDcsNDE3LjQ4LDIxMC4wNyw0MjYuNDgsMjE0LjA3LDQyMi40OCwyMTguMDcsNDI2LjQ4LDIxNC4wNyw0MTcuNDgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckFuaW1hdGlvbiB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTkiIGRhdGEtdWlkPSJsbmszMCIgaWQ9ImxpbmtfR2FtZU92ZXJBbmltYXRpb25fU3lzdGVtIj48cGF0aCBkPSJNNTIwLjI4LDM5OSBDNjIwLjk2LDM5OSA3NzcuMDcsMzk5IDc3Ny4wNywzOTkgQzc3Ny4wNywzOTkgNzc3LjA3LDQxMi41MiA3NzcuMDcsNDI3LjQxIiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJBbmltYXRpb24tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTE0LjI4LDM5OSw1MjMuMjgsNDAzLDUxOS4yOCwzOTksNTIzLjI4LDM5NSw1MTQuMjgsMzk5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIE1vdmVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNb3ZlUHV5byIgZGF0YS1lbnRpdHktMj0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI2MiIgZGF0YS11aWQ9ImxuazMxIiBpZD0ibGlua19Nb3ZlUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yNzMuMDcsMTg5LjE2IEMyNzMuMDcsMTY2LjA2IDI3My4wNywxMTAuMjUgMjczLjA3LDExMC4yNSBDMjczLjA3LDExMC4yNSAzMjQuOSwxMTAuMjUgMzcxLjY3LDExMC4yNSIgZmlsbD0ibm9uZSIgaWQ9Ik1vdmVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc3LjY3LDExMC4yNSwzNjguNjcsMTA2LjI1LDM3Mi42NywxMTAuMjUsMzY4LjY3LDExNC4yNSwzNzcuNjcsMTEwLjI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjg2LjkxIiB5PSIxMjMuMzE2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBSb3RhdGVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSb3RhdGVQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjYzIiBkYXRhLXVpZD0ibG5rMzIiIGlkPSJsaW5rX1JvdGF0ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjE0LjA3LDExNy45OCBDMjE0LjA3LDExMC43NiAyMTQuMDcsMTAzLjY1IDIxNC4wNywxMDMuNjUgQzIxNC4wNywxMDMuNjUgMjk0LjI0LDEwMy42NSAzNTkuMiwxMDMuNjUiIGZpbGw9Im5vbmUiIGlkPSJSb3RhdGVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY1LjIsMTAzLjY1LDM1Ni4yLDk5LjY1LDM2MC4yLDEwMy42NSwzNTYuMiwxMDcuNjUsMzY1LjIsMTAzLjY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjIwLjQ3IiB5PSI5OS43MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIFF1aWNrRHJvcFB1eW8gdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlF1aWNrRHJvcFB1eW8iIGRhdGEtZW50aXR5LTI9IktleWJvYXJkQ29udHJvbCIgZGF0YS1zb3VyY2UtbGluZT0iNjQiIGRhdGEtdWlkPSJsbmszMyIgaWQ9ImxpbmtfUXVpY2tEcm9wUHV5b19LZXlib2FyZENvbnRyb2wiPjxwYXRoIGQ9Ik0yODAuMDcsNzQuMTYgQzI4MC4wNyw4MS4wNiAyODAuMDcsOTAuNDUgMjgwLjA3LDkwLjQ1IEMyODAuMDcsOTAuNDUgMzI1Ljg1LDkwLjQ1IDM2OS43NCw5MC40NSIgZmlsbD0ibm9uZSIgaWQ9IlF1aWNrRHJvcFB1eW8tdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNzUuNzQsOTAuNDUsMzY2Ljc0LDg2LjQ1LDM3MC43NCw5MC40NSwzNjYuNzQsOTQuNDUsMzc1Ljc0LDkwLjQ1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMzIwLjc2IiB5PSI4Ni41MTY5Ij4mIzE3MTtleHRlbmQmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIEVyYXNlUHV5byB0byBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkVyYXNlUHV5byIgZGF0YS1lbnRpdHktMj0iQ2hhaW5SZWFjdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iNjciIGRhdGEtdWlkPSJsbmszNCIgaWQ9ImxpbmtfRXJhc2VQdXlvX0NoYWluUmVhY3Rpb24iPjxwYXRoIGQ9Ik0yNjAuNTcsMjU3LjkgQzI5Mi4xLDI1Ny45IDMyOC4yNiwyNTcuOSAzNjMuMzUsMjU3LjkiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tdG8tQ2hhaW5SZWFjdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY5LjM1LDI1Ny45LDM2MC4zNSwyNTMuOSwzNjQuMzUsMjU3LjksMzYwLjM1LDI2MS45LDM2OS4zNSwyNTcuOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjI1MC45NiIgeT0iMjUzLjk2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIENoYWluUmVhY3Rpb24gdG8gRGlzcGxheVNjb3JlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkNoYWluUmVhY3Rpb24iIGRhdGEtZW50aXR5LTI9IkRpc3BsYXlTY29yZSIgZGF0YS1zb3VyY2UtbGluZT0iNjgiIGRhdGEtdWlkPSJsbmszNSIgaWQ9ImxpbmtfQ2hhaW5SZWFjdGlvbl9EaXNwbGF5U2NvcmUiPjxwYXRoIGQ9Ik00OTMuNTYsMjQ4LjY1IEM1MjMuMDEsMjQ4LjY1IDU1Mi42NSwyNDguNjUgNTgxLjU4LDI0OC42NSIgZmlsbD0ibm9uZSIgaWQ9IkNoYWluUmVhY3Rpb24tdG8tRGlzcGxheVNjb3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1ODcuNTgsMjQ4LjY1LDU3OC41OCwyNDQuNjUsNTgyLjU4LDI0OC42NSw1NzguNTgsMjUyLjY1LDU4Ny41OCwyNDguNjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1NDEuNTciIHk9IjI0NC43MTY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBaZW5rZXNoaUJvbnVzIHRvIERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJaZW5rZXNoaUJvbnVzIiBkYXRhLWVudGl0eS0yPSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9IjY5IiBkYXRhLXVpZD0ibG5rMzYiIGlkPSJsaW5rX1plbmtlc2hpQm9udXNfRGlzcGxheVNjb3JlIj48cGF0aCBkPSJNNTE0LjA3LDMxOS42NyBDNTE0LjA3LDMwMS41MyA1MTQuMDcsMjU2IDUxNC4wNywyNTYgQzUxNC4wNywyNTYgNTQxLjE5LDI1NiA1NzMuNjgsMjU2IiBmaWxsPSJub25lIiBpZD0iWmVua2VzaGlCb251cy10by1EaXNwbGF5U2NvcmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU3OS42OCwyNTYsNTcwLjY4LDI1Miw1NzQuNjgsMjU2LDU3MC42OCwyNjAsNTc5LjY4LDI1NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYzLjAwNjgiIHg9IjUxNi4wNCIgeT0iMjY5LjA2NjkiPiYjMTcxO2luY2x1ZGUmIzE4Nzs8L3RleHQ+PC9nPjwhLS1saW5rIEdhbWVPdmVyQ2hlY2sgdG8gR2FtZU92ZXJBbmltYXRpb24tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJDaGVjayIgZGF0YS1lbnRpdHktMj0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtc291cmNlLWxpbmU9IjcwIiBkYXRhLXVpZD0ibG5rMzciIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfR2FtZU92ZXJBbmltYXRpb24iPjxwYXRoIGQ9Ik0yOTIuMywzOTkgQzMxMy41MiwzOTkgMzMwLjUsMzk5IDM1MS43MywzOTkiIGZpbGw9Im5vbmUiIGlkPSJHYW1lT3ZlckNoZWNrLXRvLUdhbWVPdmVyQW5pbWF0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNTcuNzMsMzk5LDM0OC43MywzOTUsMzUyLjczLDM5OSwzNDguNzMsNDAzLDM1Ny43MywzOTkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIyNjEuMDEiIHk9IjQxMi4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tU1JDPVtiTEpUSlhEMTZCdFZmelhtdXJMdjA0RDg1OUdCZW9CU1VKVGtudFJKeEt3cEVxS1JHczl0MUllOEQxTlJBQVkwb0EtWVcxNmJfM3BDVEJoak1wV3BJeFNwNTU5Q0RmbERWRVZpVHh1cFB5UTJKeDZFYVV3T1lJSk11d08zM01tWU10REpmZnExM2FaaDZNMmFHMEFFdWZtNVRMdTZUaUEyNGkwb1JPWHA2UVdaMW9VSGZqdEdZUlRBbDFfNEVvRi1DU2RscWpxRm1VY00xV29DN0JzNy0xTllWb0ZVNmw3UFN6b1owclNWamEwRUVYNzJFb0pVTi05RjRkelBiNFRwQmVQZkpPa3dDcW9VT0doZFJzLVZEX0FOTFU4QjNRQzRuNGRlaTR5a3dYbUx4QXU0blNiY1VSTnZ5V2pKSF9ucmxpdnV0Ynh1ZU1MVFEwMk5UUWNOVnY5eVhVSFZJSXJBcFY4Q3RQVzlYTTdXdTBWbXNIMThtcFBCMVhEX01fblFNRTROMTZpNGtmbWRJRUZRMVBMWWVsaFJzVGg5cWhLYWpZbWVxU0RyRWR6MHlabDFIZk5FbDFFVHhnQ25FOXBEZVNsV1l2eVFyVExHM3k4ME51S0JWWXROQXJpYUZ6eWVkakotWDZDX29mZjZRajExNlM3ZjYyNFFseE5KX3BUOE9zZXhNRFlKc2pxNWJkTTVrbGhsMGZzaDJqR1RYdkxLNjZsUWQybEotTGJ3amlIN1VOeUtCN21NdTg0YUNFcUgyQ0FtSG1Hd2lTZC1vQlZTTm44cEowa2pmTTFzZHZ2TTFGQ25qNUZHSlBndGFQcnJ2SnJkazBDSF81OVpQSkRPRW5CZUdURkRpNm9GNmlaZnQ2aXd5UExFQnJ4RjdFLXhxMUVnVWF0bzZzNTRIOUR4Q0ZTNDBJUy1XNnBpOEVrSTNNYVZZc2pzWW1BeUJKd0F4NHFCUS1tV1l1T3lrR183ZTNFR1g0UWcyd3ItbDQyZFpYSlFCVGpDMHM3eUVEVkExQWZOMGJDTm9qSjJVcTZGblZoTGVvUWpvdVQ5TWV3SUJxRlJFUFRNckoxQlhPa3NOZDJvaEo5QWRqdU5ZeEtrZ3JQZXZKS2JUTjkxMlBMU2FGQ1pob2l4UzVhWHliV2t5aW96Y1EzNTdJUXlUa1BmQlBGcXRqd0VTVk1SVWJ5VlY4d1g3VV9scnpoTVRTU2dYZFE3WXFsbDh0RXBMWXM3ZGQ5ZlJLX3YzckpaRURzcTNJaVJYdW9sclpYUUNLcTVncVB0MFFpY1N0MmRrbWhaN20wMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p>この図を見ると、プレイヤーとシステムの役割分担がよくわかりますね。プレイヤーはゲームの開始や操作を担当し、システムはぷよの消去判定やスコア計算などの内部処理を担当しています。</p>
<p>このようにユースケース図を作成することで、システムの全体像を把握し、実装すべき機能の関連性を明確にすることができます。それでは、実際のコード実装に進んでいきましょう！</p>
<p>誤解しないでもらいたいのですが本来ユースケースとはテキストで記述するものでありユースケース図は概要を把握するための手段に過ぎないということです。</p>
<blockquote>
<p>楕円、矢印、人型おアイコンから構成されているUMLのユースケース図は、ユースケースを把握するための表記法ではありません。
楕円や矢印は、ユースケースをのパッケージや分解を表すもので、内容を表すものではありません。</p>
<p>— アリスター・コーバーン 『ユースケース実践ガイド』</p>
</blockquote>
<h2 id="_7">リリース計画<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>要件もわかった、プログラミング開始だ！ちょっと待ってください、何事も計画を立てる事は大事なことです。ユースケース図を見てください、結構いろんなことがありますよね。何から取り組みますか？
「スコアの表示」ですか？「ゲームオーバー判定」ですか？でもまずは「新しいゲームを開始」しないとつながりとして難しいですよね。もちろん実際にプログラミングしながら順番を考えてもいいですけど間違った順番で進めると直すのが大変ですよね。
それにこれからどんなものを作るのかは事前にある程度イメージを固めておきたいものです（いきなり「ゲームオーバー」になるゲームはやりたくないですよね）。</p>
<blockquote>
<p>計画づくりとは「なにをいつまでに作ればいいのか？」という質問に答える作業だと私は考えている</p>
<p>— Mike Cohn 『アジャイルな見積と計画づくり』</p>
</blockquote>
<p>今回の目的はぷよぷよゲームを遊べるための最小限の機能の実装です。目的を実現するためにやるべきことをイテレーションという単位でまとめましょう。「全部やること洗い出すの？そんな先のことはわからないよ！」と思いますよね。安心してください今決めることは大まかな作業の流れと前後関係の整理だけです。
細かい部分は各イテレーションでおいおい明確になってきます。その手助けをしてくれるのがテスト駆動開発なのです。</p>
<blockquote>
<p>正しい設計を、正しいタイミングで行う。動かしてから、正しくする。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>今回はユーザーストーリーとユースケース図から以下のイテレーション計画に従ってぷよぷよゲームをリリースします。</p>
<ul>
<li>イテレーション0: 環境の構築</li>
<li>イテレーション1: ゲーム開始の実装</li>
<li>イテレーション2: ぷよの移動の実装</li>
<li>イテレーション3: ぷよの回転の実装</li>
<li>イテレーション4: ぷよの自由落下の実装</li>
<li>イテレーション5: ぷよの高速落下の実装</li>
<li>イテレーション6: ぷよの消去の実装</li>
<li>イテレーション7: 連鎖反応の実装</li>
<li>イテレーション8: 全消しボーナスの実装</li>
<li>イテレーション9: ゲームオーバーの実装</li>
</ul>
<p>では、ぷよぷよゲーム開発スタートです！</p>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>...と言いたいところですがまずは環境の構築をしなければなりません。「プログラミングなんてどの言語でやるか決めるぐらいでしょ?」と思うかもしれませんが家を建てるときにしっかりとした基礎工事が必要なように開発環境もしっかりとした準備が必要です。
家を建てた後に基礎がダメだと困ったことになりますからね。</p>
<h3 id="_8">ソフトウェア開発の三種の神器<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本章では開発環境のセットアップとして、これら三種の神器を準備していきます。環境構築は退屈に感じるかもしれませんが、これらのツールがあることで、安心してコードを書くことができるようになります。一緒に進めていきましょう！</p>
<h3 id="git">バージョン管理: Gitとコミットメッセージ<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>バージョン管理システムとして Git を使います。Git については既に使用していると仮定しますが、コミットメッセージについて1つだけ重要なルールを確認しておきましょう。</p>
<h4 id="_9">コミットメッセージの書き方<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>私たちのプロジェクトでは、<a href="https://www.conventionalcommits.org/ja/">Conventional Commits</a>の書式に従ってコミットメッセージを書きます。具体的には、それぞれのコミットメッセージはヘッダ、ボディ、フッタで構成されます。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p>ヘッダは必須で、スコープは任意です。コミットメッセージのタイトルは50文字までにしましょう（GitHub上で読みやすくなります）。</p>
<p>コミットのタイプは次を用います：</p>
<ul>
<li><strong>feat</strong>: 新しい機能</li>
<li><strong>fix</strong>: バグ修正</li>
<li><strong>docs</strong>: ドキュメント変更のみ</li>
<li><strong>style</strong>: コードに影響を与えない変更（空白、フォーマットなど）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更</li>
<li><strong>test</strong>: テストの追加や修正</li>
<li><strong>chore</strong>: ビルドプロセスや補助ツールの変更</li>
</ul>
<p>例えば：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム初期化機能を追加&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: メソッドの抽出&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよ消去のテストケースを追加&#39;</span>
</code></pre></div>
<h3 id="elmishwpf-f">Elmish.WPF: F#のデスクトップアプリケーションフレームワーク<a class="headerlink" href="#elmishwpf-f" title="Permanent link">&para;</a></h3>
<p>「F#でデスクトップゲームを作る?どうやって?」と思われるかもしれませんね。ここで登場するのが <strong>Elmish.WPF</strong> です。Elmish.WPF は WPF(Windows Presentation Foundation) 上で動作するF#フレームワークで、Elmishアーキテクチャ(Model-View-Update パターン)による予測可能な状態管理を実現します。</p>
<h4 id="elmishwpf">Elmish.WPFとは<a class="headerlink" href="#elmishwpf" title="Permanent link">&para;</a></h4>
<p>Elmish.WPF は F# で Windows デスクトップアプリケーションを開発するためのフレームワークです。WPF をベースにしており、F# のコードで XAML を使った UI を構築できます。</p>
<p>「なぜElmish.WPFを使うの?直接WPFを書けばいいじゃない」と思われるかもしれませんね。それにはいくつかの理由があります:</p>
<p><strong>1. Elmishアーキテクチャ</strong></p>
<p>Elmish.WPF は Elmish という状態管理パターンを採用しています。これは The Elm Architecture(TEA)に基づいた、予測可能で保守性の高いアーキテクチャです。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Elmish の基本構造</span>

<span class="c1">// Model: アプリケーションの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Count</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="o">}</span>

<span class="c1">// Message: 状態を変更するイベント</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Increment</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Decrement</span>

<span class="c1">// Init: 初期状態</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// Update: メッセージに応じて状態を更新</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Increment</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Decrement</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// Bindings: XAML へのデータバインディング定義</span>
<span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Binding</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="s">&quot;Count&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Count</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;Increment&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Increment</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;Decrement&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Decrement</span><span class="o">)</span>
<span class="o">]</span>
</code></pre></div>
<p>「Elmishって何が良いの?」と思われるかもしれませんね。Elmish の素晴らしい点は、状態の変更が予測可能で、テストしやすいことです。すべての状態変更は <code>update</code> 関数を通じて行われるため、バグを減らすことができます。</p>
<p><strong>2. 型安全性</strong></p>
<p>F# の強力な型システムにより、コンパイル時に多くのエラーを検出できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: 型安全な状態管理</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameState</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">score</span><span class="o">:</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">level</span><span class="o">:</span><span class="n">int</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Paused</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">score</span><span class="o">:</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">level</span><span class="o">:</span><span class="n">int</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">finalScore</span><span class="o">:</span><span class="n">int</span>

<span class="k">let</span><span class="w"> </span><span class="nv">handleGameState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">(</span><span class="n">score</span><span class="o">,</span><span class="w"> </span><span class="n">level</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sprintf</span><span class="w"> </span><span class="s">&quot;Playing - Score: %d, Level: %d&quot;</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="n">level</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Paused</span><span class="w"> </span><span class="o">(</span><span class="n">score</span><span class="o">,</span><span class="w"> </span><span class="n">level</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sprintf</span><span class="w"> </span><span class="s">&quot;Paused - Score: %d, Level: %d&quot;</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="n">level</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="n">finalScore</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sprintf</span><span class="w"> </span><span class="s">&quot;Game Over - Final Score: %d&quot;</span><span class="w"> </span><span class="n">finalScore</span>

<span class="c1">// すべてのケースを処理しないとコンパイルエラー</span>
</code></pre></div>
<p><strong>3. 関数型プログラミング</strong></p>
<p>F# の関数型プログラミングの恩恵を受けられます:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: イミュータブルなデータ構造</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">}</span>

<span class="k">let</span><span class="w"> </span><span class="nv">position1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="k">let</span><span class="w"> </span><span class="nv">position2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">position1</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">}</span><span class="w">  </span><span class="c1">// 新しいインスタンスを作成</span>

<span class="c1">// position1 は変更されない</span>
<span class="n">printfn</span><span class="w"> </span><span class="s">&quot;%A&quot;</span><span class="w"> </span><span class="n">position1</span><span class="w">  </span><span class="c1">// { X = 0; Y = 0 }</span>
<span class="n">printfn</span><span class="w"> </span><span class="s">&quot;%A&quot;</span><span class="w"> </span><span class="n">position2</span><span class="w">  </span><span class="c1">// { X = 10; Y = 0 }</span>
</code></pre></div>
<p>「イミュータブルって何?」と思われるかもしれませんね。イミュータブルとは、一度作成したデータを変更できないという性質のことです。これにより、予期しない状態変更によるバグを防ぐことができます。</p>
<p><strong>4. パターンマッチング</strong></p>
<p>F# のパターンマッチングは、複雑な条件分岐を簡潔に書くことができる強力な機能です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// F#: パターンマッチング</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span>

<span class="k">let</span><span class="w"> </span><span class="nv">getPuyoName</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;赤ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;青ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;緑ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;黄ぷよ&quot;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;空&quot;</span>

<span class="c1">// コンパイラがすべてのケースをチェック</span>
<span class="c1">// ケースの漏れがあるとコンパイルエラーになる</span>
</code></pre></div>
<h4 id="elmish">Elmishアーキテクチャの詳細<a class="headerlink" href="#elmish" title="Permanent link">&para;</a></h4>
<p>Elmish は単方向データフローによる状態管理パターンです。以下の3つの要素で構成されます:</p>
<p><strong>Model(状態)</strong></p>
<p>アプリケーションの現在の状態を表現します:</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Board</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">[,]</span>
<span class="w">    </span><span class="n">CurrentPuyo</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">GameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span>
<span class="o">}</span>
</code></pre></div>
<p><strong>Message(イベント)</strong></p>
<p>状態を変更するためのイベントを定義します:</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Drop</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span>
</code></pre></div>
<p><strong>Update(更新関数)</strong></p>
<p>メッセージを受け取り、新しい状態を返します:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movePuyoLeft</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="n">newModel</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">movePuyoRight</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPuyo</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="n">newModel</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="n">newModel</span>
<span class="w">    </span><span class="c1">// ... 他のメッセージ処理</span>
</code></pre></div>
<p><strong>Bindings(バインディング)</strong></p>
<p>XAML との接続を定義します:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Binding</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="s">&quot;Board&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Board</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;Score&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Score</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;MoveLeft&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveLeft</span><span class="o">)</span>
<span class="w">    </span><span class="s">&quot;MoveRight&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveRight</span><span class="o">)</span>
<span class="o">]</span>
</code></pre></div>
<h4 id="elmishwpf_1">Elmish.WPFのメリット<a class="headerlink" href="#elmishwpf_1" title="Permanent link">&para;</a></h4>
<p>「結局、Elmish.WPFを使うメリットは何?」とまとめたくなりますよね。以下がElmish.WPFの主なメリットです:</p>
<ol>
<li><strong>型安全性</strong>: コンパイル時に多くのバグを防ぐ</li>
<li><strong>予測可能な状態管理</strong>: Elmish による単方向データフロー</li>
<li><strong>テストしやすい</strong>: 純粋関数による実装</li>
<li><strong>関数型プログラミング</strong>: 再利用可能で保守しやすいコード</li>
<li><strong>.NETエコシステムとの統合</strong>: 既存の.NETライブラリを活用できる</li>
<li><strong>WPFの豊富なUIコントロール</strong>: 成熟したUIフレームワークを活用</li>
</ol>
<p>「難しそう...」と思われるかもしれませんが、心配いりません。このチュートリアルを通じて、F# と Elmish.WPF の基本を一緒に学んでいきましょう。テスト駆動開発の流れに沿って、一つずつ機能を実装していけば、自然と F# と Elmish.WPF の使い方が身につきますよ!</p>
<h3 id="fxunit">テスティング: F#とxUnit<a class="headerlink" href="#fxunit" title="Permanent link">&para;</a></h3>
<p>良いコードを書くためには、コードが正しく動作することを確認するテストが欠かせません。F# + Elmish.WPFのテスト環境をセットアップしていきましょう。</p>
<p>「F#でどうやってテストを書くの?」と思われるかもしれませんね。F#のテストは、.NETの標準的なテストフレームワークであるxUnitと、F#らしいアサーションを提供するFsUnitを組み合わせて書きます。</p>
<h4 id="f">F#プロジェクトの作成<a class="headerlink" href="#f" title="Permanent link">&para;</a></h4>
<p>まず、F#プロジェクトの構造を作成します:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトディレクトリの作成</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>app/fsharp-2/wpf
<span class="nb">cd</span><span class="w"> </span>app/fsharp-2/wpf

<span class="c1"># ソリューションの作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>sln<span class="w"> </span>-n<span class="w"> </span>PuyoPuyo

<span class="c1"># WPFプロジェクトの作成</span>
<span class="c1"># 注: F#のWPFテンプレートが存在しないため、classlibから作成して後で設定変更</span>
dotnet<span class="w"> </span>new<span class="w"> </span>classlib<span class="w"> </span>-lang<span class="w"> </span>F#<span class="w"> </span>-o<span class="w"> </span>src/PuyoPuyo.WPF

<span class="c1"># テストプロジェクトの作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>xunit<span class="w"> </span>-lang<span class="w"> </span>F#<span class="w"> </span>-o<span class="w"> </span>tests/PuyoPuyo.Tests

<span class="c1"># ソリューションにプロジェクトを追加</span>
dotnet<span class="w"> </span>sln<span class="w"> </span>add<span class="w"> </span>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj
dotnet<span class="w"> </span>sln<span class="w"> </span>add<span class="w"> </span>tests/PuyoPuyo.Tests/PuyoPuyo.Tests.fsproj

<span class="c1"># テストプロジェクトからWPFプロジェクトを参照</span>
dotnet<span class="w"> </span>add<span class="w"> </span>tests/PuyoPuyo.Tests<span class="w"> </span>reference<span class="w"> </span>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj
</code></pre></div>
<p>WPFプロジェクトの設定を変更します（<code>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj</code>）:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>

<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;OutputType&gt;</span>WinExe<span class="nt">&lt;/OutputType&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net9.0-windows<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">    </span><span class="nt">&lt;GenerateDocumentationFile&gt;</span>true<span class="nt">&lt;/GenerateDocumentationFile&gt;</span>
<span class="w">    </span><span class="nt">&lt;UseWPF&gt;</span>true<span class="nt">&lt;/UseWPF&gt;</span>
<span class="w">    </span><span class="nt">&lt;EnableDefaultPageItems&gt;</span>false<span class="nt">&lt;/EnableDefaultPageItems&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Domain.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Program.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Elmish.WPF&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;3.5.8&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<p><strong>重要</strong>: .NET 9 を使用します。.NET 10 は FSharpLint との互換性に問題があるため、<code>global.json</code> で SDK バージョンを固定します:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># global.jsonの作成</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>global.json<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">{</span>
<span class="s">  &quot;sdk&quot;: {</span>
<span class="s">    &quot;version&quot;: &quot;9.0.305&quot;,</span>
<span class="s">    &quot;rollForward&quot;: &quot;latestPatch&quot;</span>
<span class="s">  }</span>
<span class="s">}</span>
<span class="s">EOF</span>
</code></pre></div>
<h4 id="elmishwpffsunit">Elmish.WPFとFsUnitのセットアップ<a class="headerlink" href="#elmishwpffsunit" title="Permanent link">&para;</a></h4>
<p>必要なパッケージをインストールします:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># WPFプロジェクトへElmish.WPFを追加（既に.fsprojに含まれている場合はスキップ）</span>
dotnet<span class="w"> </span>add<span class="w"> </span>src/PuyoPuyo.WPF<span class="w"> </span>package<span class="w"> </span>Elmish.WPF

<span class="c1"># テストプロジェクトへFsUnitを追加</span>
dotnet<span class="w"> </span>add<span class="w"> </span>tests/PuyoPuyo.Tests<span class="w"> </span>package<span class="w"> </span>FsUnit.xUnit
</code></pre></div>
<p>テストプロジェクトの設定も .NET 9 に変更します（<code>tests/PuyoPuyo.Tests/PuyoPuyo.Tests.fsproj</code>）:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>

<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net9.0-windows<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">    </span><span class="nt">&lt;IsPackable&gt;</span>false<span class="nt">&lt;/IsPackable&gt;</span>
<span class="w">    </span><span class="nt">&lt;GenerateProgramFile&gt;</span>false<span class="nt">&lt;/GenerateProgramFile&gt;</span>
<span class="w">    </span><span class="nt">&lt;IsTestProject&gt;</span>true<span class="nt">&lt;/IsTestProject&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Tests.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;coverlet.msbuild&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;6.0.4&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;PrivateAssets&gt;</span>all<span class="nt">&lt;/PrivateAssets&gt;</span>
<span class="w">      </span><span class="nt">&lt;IncludeAssets&gt;</span>runtime;<span class="w"> </span>build;<span class="w"> </span>native;<span class="w"> </span>contentfiles;<span class="w"> </span>analyzers;<span class="w"> </span>buildtransitive<span class="nt">&lt;/IncludeAssets&gt;</span>
<span class="w">    </span><span class="nt">&lt;/PackageReference&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;FsUnit.xUnit&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;7.1.1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Microsoft.NET.Test.Sdk&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;17.14.1&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;xunit.v3&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;3.0.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;xunit.runner.visualstudio&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;3.1.3&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;IncludeAssets&gt;</span>runtime;<span class="w"> </span>build;<span class="w"> </span>native;<span class="w"> </span>contentfiles;<span class="w"> </span>analyzers;<span class="w"> </span>buildtransitive<span class="nt">&lt;/IncludeAssets&gt;</span>
<span class="w">      </span><span class="nt">&lt;PrivateAssets&gt;</span>all<span class="nt">&lt;/PrivateAssets&gt;</span>
<span class="w">    </span><span class="nt">&lt;/PackageReference&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;ProjectReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;..\..\src\PuyoPuyo.WPF\PuyoPuyo.WPF.fsproj&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<h3 id="_10">自動化: ビルドとタスク管理<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>開発の効率を上げるため、繰り返し実行するタスクを自動化しましょう。</p>
<h4 id="dotnet-watch">dotnet watch によるホットリロード<a class="headerlink" href="#dotnet-watch" title="Permanent link">&para;</a></h4>
<p>開発中は、コードを変更するたびに自動的にビルドして再読み込みする機能が便利です：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 開発サーバーを起動（ファイル変更を監視）</span>
<span class="nb">cd</span><span class="w"> </span>src/PuyoPuyo.WPF
dotnet<span class="w"> </span>watch<span class="w"> </span>run
</code></pre></div>
<p>アプリケーションが起動し、コードを変更すると、自動的にビルドされて再起動されます。</p>
<h4 id="_11">テストの自動実行<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>テスト駆動開発では、テストを頻繁に実行します。ファイルが変更されるたびに自動的にテストを実行する設定も便利です：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># テストを監視モードで実行</span>
dotnet<span class="w"> </span>watch<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--project<span class="w"> </span>tests/PuyoPuyo.Tests
</code></pre></div>
<h4 id="cake">Cake によるビルド自動化<a class="headerlink" href="#cake" title="Permanent link">&para;</a></h4>
<p>「ビルド自動化ツールは何を使えばいいですか？」.NETエコシステムでは Cake がよく使われます。CakeはC#で書けるクロスプラットフォームなビルド自動化ツールです。</p>
<h5 id="cake_1">Cakeとは<a class="headerlink" href="#cake_1" title="Permanent link">&para;</a></h5>
<p>Cake（C# Make）は、.NET開発者向けのビルド自動化システムです：</p>
<p><strong>特徴</strong>
- C#で書けるビルドスクリプト（型安全、IntelliSense対応）
- クロスプラットフォーム（Windows、macOS、Linux）
- 豊富なアドインとヘルパー
- .NETツールとの統合</p>
<p><strong>Makefileとの比較</strong></p>
<table>
<thead>
<tr>
<th>機能</th>
<th>Makefile</th>
<th>Cake</th>
</tr>
</thead>
<tbody>
<tr>
<td>記述言語</td>
<td>シェルスクリプト</td>
<td>C#</td>
</tr>
<tr>
<td>型チェック</td>
<td>なし</td>
<td>あり（コンパイル時）</td>
</tr>
<tr>
<td>IntelliSense</td>
<td>限定的</td>
<td>完全対応</td>
</tr>
<tr>
<td>.NET統合</td>
<td>外部コマンド</td>
<td>ネイティブ</td>
</tr>
<tr>
<td>依存関係</td>
<td>タブ文字必須</td>
<td>柔軟</td>
</tr>
</tbody>
</table>
<h5 id="cake_2">Cakeのセットアップ<a class="headerlink" href="#cake_2" title="Permanent link">&para;</a></h5>
<p>まず、Cakeをローカルツールとしてインストールします：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .NET ローカルツールマニフェストを作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>tool-manifest

<span class="c1"># Cakeをインストール</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>Cake.Tool

<span class="c1"># Fantomasをインストール（コードフォーマッタ）</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>fantomas

<span class="c1"># FSharpLintをインストール（静的解析）</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>dotnet-fsharplint
</code></pre></div>
<p>次に、ビルドスクリプト <code>build.cake</code> をプロジェクトルートに作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// 引数</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="kt">var</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argument</span><span class="p">(</span><span class="s">&quot;target&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Default&quot;</span><span class="p">);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argument</span><span class="p">(</span><span class="s">&quot;configuration&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Release&quot;</span><span class="p">);</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// タスク定義</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetClean</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./src/**/bin&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./src/**/obj&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./tests/**/bin&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./tests/**/obj&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Restore&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetRestore</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Restore&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetBuild</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetBuildSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetTest</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetTestSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Run&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetRun</span><span class="p">(</span><span class="s">&quot;./src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Watch&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;watch run --project ./src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Watch-Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;watch test --project ./tests/PuyoPuyo.Tests/PuyoPuyo.Tests.fsproj&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードを自動フォーマット&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fantomas src tests&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format-Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードフォーマットをチェック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fantomas src tests --check&quot;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;コードフォーマットエラーが検出されました。dotnet cake --target=Format で修正してください。&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;静的コード解析を実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fsharplint lint PuyoPuyo.sln&quot;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;静的コード解析でエラーが検出されました。&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;テストカバレッジを測定&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetTest</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetTestSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">ArgumentCustomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CollectCoverage=true&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CoverletOutputFormat=opencover&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CoverletOutput=./coverage/&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;カバレッジレポート: ./tests/PuyoPuyo.Tests/coverage/coverage.opencover.xml&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// ターゲット</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Default&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">);</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;CI&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;CI環境での完全なビルドとテスト&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Format-Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">);</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// 実行</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">RunTarget</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
</code></pre></div>
<p>「このスクリプトは何をしているんですか？」良い質問ですね！各タスクを見ていきましょう：</p>
<p><strong>タスクの説明</strong></p>
<ol>
<li>
<p><strong>Clean</strong>：ビルド成果物を削除
   <div class="highlight"><pre><span></span><code><span class="n">DotNetClean</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">);</span>
<span class="n">CleanDirectories</span><span class="p">(</span><span class="s">&quot;./src/**/bin&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// binフォルダを削除</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Restore</strong>：NuGetパッケージを復元
   <div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Cleanタスクに依存</span>
<span class="n">DotNetRestore</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Build</strong>：プロジェクトをビルド
   <div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Restore&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Restoreタスクに依存</span>
<span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">  </span><span class="c1">// 既に復元済みなのでスキップ</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Test</strong>：テストを実行
   <div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// Buildタスクに依存</span>
<span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="w">  </span><span class="c1">// 既にビルド済みなのでスキップ</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Run</strong>：アプリケーションを起動</p>
</li>
<li><strong>Watch</strong>：ファイル変更を監視して自動再起動</li>
<li><strong>Watch-Test</strong>：ファイル変更を監視して自動テスト実行</li>
</ol>
<p>「<code>.IsDependentOn()</code>は何ですか？」これは、タスク間の依存関係を定義するメソッドです。例えば<code>Test</code>タスクは<code>Build</code>タスクに依存しているので、<code>Test</code>を実行すると自動的に<code>Build</code>も実行されます。依存関係は連鎖するので、<code>Test</code>を実行すると<code>Clean</code> → <code>Restore</code> → <code>Build</code> → <code>Test</code>の順に実行されます。</p>
<h5 id="cake_3">Cakeの実行<a class="headerlink" href="#cake_3" title="Permanent link">&para;</a></h5>
<p>Cakeスクリプトを実行するには、以下のコマンドを使用します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># デフォルトタスク（Test）を実行</span>
dotnet<span class="w"> </span>cake

<span class="c1"># 特定のタスクを実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Run
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch

<span class="c1"># CI環境でのビルド</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>CI

<span class="c1"># 設定を指定</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build<span class="w"> </span>--configuration<span class="o">=</span>Debug
</code></pre></div>
<h5 id="powershell-windows">PowerShell スクリプト（Windows用）<a class="headerlink" href="#powershell-windows" title="Permanent link">&para;</a></h5>
<p>Windows環境では、PowerShellスクリプトを作成すると便利です：</p>
<div class="highlight"><pre><span></span><code><span class="c"># build.ps1</span>
<span class="p">[</span><span class="k">CmdletBinding</span><span class="p">()]</span>
<span class="k">Param</span><span class="p">(</span>
    <span class="no">[string]</span><span class="nv">$Target</span> <span class="p">=</span> <span class="s2">&quot;Default&quot;</span><span class="p">,</span>
    <span class="no">[string]</span><span class="nv">$Configuration</span> <span class="p">=</span> <span class="s2">&quot;Release&quot;</span>
<span class="p">)</span>

<span class="p">&amp;</span> <span class="n">dotnet</span> <span class="n">cake</span> <span class="p">-</span><span class="n">-target</span><span class="p">=</span><span class="nv">$Target</span> <span class="p">-</span><span class="n">-configuration</span><span class="p">=</span><span class="nv">$Configuration</span>
</code></pre></div>
<p>実行方法：</p>
<div class="highlight"><pre><span></span><code><span class="c"># デフォルトタスクを実行</span>
<span class="p">.\</span><span class="n">build</span><span class="p">.</span><span class="n">ps1</span>

<span class="c"># 特定のタスクを実行</span>
<span class="p">.\</span><span class="n">build</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Target</span> <span class="n">Build</span>
<span class="p">.\</span><span class="n">build</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Target</span> <span class="n">Test</span>
</code></pre></div>
<h5 id="bashmacoslinux">Bashスクリプト（macOS/Linux用）<a class="headerlink" href="#bashmacoslinux" title="Permanent link">&para;</a></h5>
<p>macOS/Linux環境では、Bashスクリプトを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># build.sh</span>
<span class="c1">#!/usr/bin/env bash</span>

<span class="nv">TARGET</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">Default</span><span class="si">}</span>
<span class="nv">CONFIGURATION</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">Release</span><span class="si">}</span>

dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$TARGET</span><span class="s2">&quot;</span><span class="w"> </span>--configuration<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$CONFIGURATION</span><span class="s2">&quot;</span>
</code></pre></div>
<p>実行権限を付与して実行：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 実行権限を付与</span>
chmod<span class="w"> </span>+x<span class="w"> </span>build.sh

<span class="c1"># デフォルトタスクを実行</span>
./build.sh

<span class="c1"># 特定のタスクを実行</span>
./build.sh<span class="w"> </span>Build
./build.sh<span class="w"> </span>Test
</code></pre></div>
<h5 id="cake_4">Cakeの利点<a class="headerlink" href="#cake_4" title="Permanent link">&para;</a></h5>
<p>「なぜCakeを使うのですか？」Cakeを使う利点は以下の通りです：</p>
<ol>
<li><strong>型安全性</strong>：C#で書くのでコンパイル時に型チェックされる</li>
<li><strong>IntelliSense</strong>：Visual Studio CodeやRiderで補完が効く</li>
<li><strong>再利用性</strong>：NuGetパッケージとしてビルドロジックを共有できる</li>
<li><strong>統合性</strong>：.NETツールとシームレスに統合</li>
<li><strong>可読性</strong>：複雑なビルドロジックも構造化して書ける</li>
<li><strong>クロスプラットフォーム</strong>：Windows、macOS、Linuxで同じスクリプトが動く</li>
</ol>
<h3 id="_12">自動化: コード品質の自動管理<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質を自動的にチェックし、維持していく仕組みが必要です。F#エコシステムのツールを活用しましょう。</p>
<h4 id="fantomas">コードフォーマッタ: Fantomas<a class="headerlink" href="#fantomas" title="Permanent link">&para;</a></h4>
<p>F#のコードフォーマットを統一するために <strong>Fantomas</strong> を使います。</p>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>—  リーダブルコード</p>
</blockquote>
<p>Fantomasのインストール：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>fantomas
</code></pre></div>
<p><code>build.cake</code>にフォーマット用のタスクを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake に追加</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードを自動フォーマット&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fantomas src tests&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format-Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードフォーマットをチェック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fantomas src tests --check&quot;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;コードフォーマットエラーが検出されました。dotnet cake --target=Format で修正してください。&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>フォーマットの実行：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format-Check<span class="w">  </span><span class="c1"># チェックのみ</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format<span class="w">        </span><span class="c1"># 自動修正</span>
</code></pre></div>
<h4 id="fsharplint">静的コード解析: FSharpLint<a class="headerlink" href="#fsharplint" title="Permanent link">&para;</a></h4>
<p>静的コード解析ツールとして <strong>FSharpLint</strong> を使います。</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>dotnet-fsharplint
</code></pre></div>
<p>プロジェクトルートに<code>fsharplint.json</code>を作成して、ルールをカスタマイズします：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;ignoreFiles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;**/obj/**/*.fs&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;**/bin/**/*.fs&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;hints&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;add&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;formatting&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;typedItemSpacing&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;typePrefixing&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;conventions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;naming&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;nestedStatements&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;depth&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;cyclomaticComplexity&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;maxComplexity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>build.cake</code>にlint用のタスクを追加：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake に追加</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;静的コード解析を実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;dotnet&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fsharplint lint PuyoPuyo.sln&quot;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;静的コード解析でエラーが検出されました。&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>静的解析の実行：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Lint
</code></pre></div>
<h4 id="_13">テストカバレッジ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>F#でのコードカバレッジ測定には、.NETエコシステムの <strong>coverlet</strong> や <strong>altcover</strong> を使用します。</p>
<p>coverletのインストール：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># coverletをテストプロジェクトに追加</span>
dotnet<span class="w"> </span>add<span class="w"> </span>tests/PuyoPuyo.Tests<span class="w"> </span>package<span class="w"> </span>coverlet.msbuild
</code></pre></div>
<p><code>build.cake</code>にカバレッジタスクを追加：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake に追加</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;テストカバレッジを測定&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DotNetTest</span><span class="p">(</span><span class="s">&quot;./PuyoPuyo.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetTestSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">ArgumentCustomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CollectCoverage=true&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CoverletOutputFormat=opencover&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;/p:CoverletOutput=./coverage/&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;カバレッジレポート: ./tests/PuyoPuyo.Tests/coverage/coverage.opencover.xml&quot;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>カバレッジの実行：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Coverage
</code></pre></div>
<h4 id="ci">CI環境での品質チェック<a class="headerlink" href="#ci" title="Permanent link">&para;</a></h4>
<p>CI環境では、すべての品質チェックを自動実行します。<code>build.cake</code>のCIタスクを拡張：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake の CI タスクを更新</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;CI&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;CI環境での完全なビルドとテスト&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Format-Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">);</span>
</code></pre></div>
<p>これにより、CI環境では以下が自動実行されます：</p>
<ol>
<li>クリーンビルド</li>
<li>フォーマットチェック</li>
<li>静的コード解析</li>
<li>テスト実行</li>
<li>カバレッジ測定</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># CI環境での実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>CI
</code></pre></div>
<h3 id="git_1">Git の設定<a class="headerlink" href="#git_1" title="Permanent link">&para;</a></h3>
<p>プロジェクトのバージョン管理を開始しましょう。</p>
<h4 id="gitignore">.gitignoreの設定<a class="headerlink" href="#gitignore" title="Permanent link">&para;</a></h4>
<p>F#プロジェクト固有のファイルを除外するため、<code>.gitignore</code> ファイルを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトルートに .gitignore を作成</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>.gitignore<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s"># Build results</span>
<span class="s">[Dd]ebug/</span>
<span class="s">[Rr]elease/</span>
<span class="s">x64/</span>
<span class="s">x86/</span>
<span class="s">[Bb]in/</span>
<span class="s">[Oo]bj/</span>

<span class="s"># Visual Studio</span>
<span class="s">.vs/</span>
<span class="s">*.user</span>
<span class="s">*.suo</span>
<span class="s">*.userosscache</span>
<span class="s">*.sln.docstates</span>

<span class="s"># Rider</span>
<span class="s">.idea/</span>
<span class="s">*.sln.iml</span>

<span class="s"># User-specific files</span>
<span class="s">*.rsuser</span>
<span class="s">*.suo</span>
<span class="s">*.user</span>
<span class="s">*.userosscache</span>
<span class="s">*.sln.docstates</span>

<span class="s"># Mono Auto Generated Files</span>
<span class="s">mono_crash.*</span>

<span class="s"># Build Results</span>
<span class="s">[Dd]ebug/</span>
<span class="s">[Dd]ebugPublic/</span>
<span class="s">[Rr]elease/</span>
<span class="s">[Rr]eleases/</span>
<span class="s">x64/</span>
<span class="s">x86/</span>
<span class="s">[Aa][Rr][Mm]/</span>
<span class="s">[Aa][Rr][Mm]64/</span>
<span class="s">bld/</span>
<span class="s">[Bb]in/</span>
<span class="s">[Oo]bj/</span>
<span class="s">[Ll]og/</span>
<span class="s">[Ll]ogs/</span>

<span class="s"># .NET Core</span>
<span class="s">project.lock.json</span>
<span class="s">project.fragment.lock.json</span>
<span class="s">artifacts/</span>

<span class="s"># Cake</span>
<span class="s">tools/**</span>
<span class="s">!tools/packages.config</span>

<span class="s"># Coverage</span>
<span class="s">coverage/</span>
<span class="s">*.opencover.xml</span>
<span class="s">EOF</span>
</code></pre></div>
<h4 id="_14">初期コミット<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>プロジェクトを Git で管理開始します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gitリポジトリを初期化</span>
git<span class="w"> </span>init

<span class="c1"># すべてのファイルをステージング</span>
git<span class="w"> </span>add<span class="w"> </span>.

<span class="c1"># 初期コミット</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: initialize F# Elmish.WPF Puyo Puyo project with test setup&quot;</span>
</code></pre></div>
<h3 id="0_1">イテレーション0のまとめ<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで準備した環境：</p>
<ol>
<li><strong>バージョン管理</strong></li>
<li>既存の Git リポジトリを使用（case-study-game-dev）</li>
<li>.gitignoreの設定（.NET / F# 対応）</li>
<li>
<p>Conventional Commitsの規約</p>
</li>
<li>
<p><strong>プロジェクト構造</strong>
   <div class="highlight"><pre><span></span><code>app/fsharp-2/wpf/
├── .config/
│   └── dotnet-tools.json       # ローカルツール設定
├── global.json                 # .NET SDK バージョン固定 (9.0.305)
├── PuyoPuyo.sln                # ソリューションファイル
├── build.cake                  # Cake ビルドスクリプト
├── build.ps1 / build.sh        # ビルドスクリプトラッパー
├── fsharplint.json             # FSharpLint 設定
├── src/
│   └── PuyoPuyo.WPF/
│       ├── PuyoPuyo.WPF.fsproj # WPF プロジェクト (.NET 9)
│       ├── Domain.fs           # Elmish ドメインロジック
│       └── Program.fs          # アプリケーションエントリーポイント
└── tests/
    └── PuyoPuyo.Tests/
        ├── PuyoPuyo.Tests.fsproj # テストプロジェクト (.NET 9)
        └── Tests.fs              # テストファイル
</code></pre></div></p>
</li>
<li>
<p><strong>テスティング</strong></p>
</li>
<li>xUnit v3 のセットアップ</li>
<li>FsUnit.xUnit 7.1.1 の導入</li>
<li>coverlet.msbuild 6.0.4 によるカバレッジ測定</li>
<li>
<p>テストプロジェクトから WPF プロジェクトへの参照</p>
</li>
<li>
<p><strong>自動化</strong></p>
</li>
<li>dotnet watch によるホットリロード</li>
<li>Cake によるビルド自動化（型安全な C# スクリプト）</li>
<li>タスク依存関係の管理</li>
<li>クロスプラットフォーム対応（build.ps1 / build.sh）</li>
<li>Fantomas によるコードフォーマット自動化</li>
<li>FSharpLint による静的コード解析</li>
<li>coverlet によるテストカバレッジ測定</li>
<li>
<p>CI 環境での品質チェック自動化（<code>dotnet cake --target=CI</code>）</p>
</li>
<li>
<p><strong>Elmish.WPF の理解</strong></p>
</li>
<li>Elmish.WPF 3.5.8 のセットアップ</li>
<li>Elmish アーキテクチャの基本（Model-View-Update）</li>
<li>型安全な状態管理</li>
<li>コードベースの UI 構築（XAML を使用しない）</li>
<li>
<p>データバインディングの実装</p>
</li>
<li>
<p><strong>技術的な決定事項</strong></p>
</li>
<li>.NET 9 の使用（.NET 10 は FSharpLint 非互換のため）</li>
<li>global.json による SDK バージョン固定（9.0.305）</li>
<li>コード重視のアプローチ（XAML ファイルを使用しない）</li>
<li>
<p>最小限の Elmish.WPF セットアップ（Model、Message、init、update、bindings）</p>
</li>
<li>
<p><strong>動作確認</strong></p>
</li>
<li><code>dotnet cake --target=Run</code> でアプリケーションが起動</li>
<li>ウィンドウに「ぷよぷよゲーム」が表示されることを確認</li>
<li><code>dotnet cake --target=CI</code> ですべての品質チェックがパス</li>
</ol>
<p>「環境構築って面倒だな...」と思われたかもしれませんが、ここで準備したツールがこれからの開発を助けてくれます。テスト駆動開発では、テストを頻繁に実行し、小さな変更を積み重ねていきます。そのため、自動化されたテスト環境とバージョン管理が不可欠なのです。</p>
<p>次のイテレーションから、実際にぷよぷよゲームの実装を始めていきます。Elmishアーキテクチャの力を使って、予測可能で保守性の高いコードを書いていきましょう！</p>
<h3 id="elmishwpf_2">Elmish.WPF 最小セットアップ<a class="headerlink" href="#elmishwpf_2" title="Permanent link">&para;</a></h3>
<p>環境構築の最後に、Elmish.WPF が正しく動作することを確認するための最小限のアプリケーションを作成します。</p>
<p>このセットアップでは、Elmish.WPF の公式 Getting Started ガイドに従い、F# と C# の混合プロジェクト構成を採用します。F# でビジネスロジックを、C# で WPF の UI とエントリーポイントを管理します。</p>
<h4 id="_15">プロジェクト構成の概要<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>F# Class Library</strong> (<code>src/PuyoPuyo.WPF</code>): Elmish のロジック（Model、Update、Bindings）を定義</li>
<li><strong>C# WPF App</strong> (<code>src/PuyoPuyo.App</code>): XAML による UI 定義とアプリケーションのエントリーポイント</li>
</ul>
<h4 id="1-f">ステップ 1: F# プロジェクトの設定<a class="headerlink" href="#1-f" title="Permanent link">&para;</a></h4>
<p>F# Class Library プロジェクトファイル (<code>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj</code>) を以下のように設定します:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net9.0-windows<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">    </span><span class="nt">&lt;UseWpf&gt;</span>true<span class="nt">&lt;/UseWpf&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Counter.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Compile</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Program.fs&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Elmish.WPF&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;3.5.8&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<h4 id="2-model-message">ステップ 2: Model と Message の定義<a class="headerlink" href="#2-model-message" title="Permanent link">&para;</a></h4>
<p><code>src/PuyoPuyo.WPF/Counter.fs</code> にカウンターの例を実装します:</p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="nn">Counter</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.WPF</span>

<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Count</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">;</span><span class="w"> </span><span class="n">StepSize</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">}</span>

<span class="k">type</span><span class="w"> </span><span class="nc">Msg</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Increment</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Decrement</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">SetStepSize</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">int</span>

<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">StepSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>

<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Increment</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">StepSize</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Decrement</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">StepSize</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">SetStepSize</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">StepSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<h4 id="3-bindings">ステップ 3: Bindings の定義<a class="headerlink" href="#3-bindings" title="Permanent link">&para;</a></h4>
<p>同じファイルに bindings 関数を追加します:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;CounterValue&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Count</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Increment&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Increment</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Decrement&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Decrement</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;StepSize&quot;</span>
<span class="w">      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">twoWay</span><span class="w"> </span><span class="o">((</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">StepSize</span><span class="o">),</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">newVal</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">newVal</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">SetStepSize</span><span class="o">))</span><span class="w"> </span><span class="o">]</span>
</code></pre></div>
<h4 id="4-programmain">ステップ 4: Program.main の作成<a class="headerlink" href="#4-programmain" title="Permanent link">&para;</a></h4>
<p><code>src/PuyoPuyo.WPF/Program.fs</code> に Elmish ループを起動する関数を定義します:</p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="nn">Program</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.WPF</span>

<span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="n">window</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">ElmConfig</span><span class="p">.</span><span class="n">Default</span>
<span class="w">    </span><span class="nn">Program</span><span class="p">.</span><span class="n">mkProgram</span>
<span class="w">        </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Counter</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span><span class="o">)</span>
<span class="w">        </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Counter</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span><span class="o">)</span>
<span class="w">        </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Counter</span><span class="p">.</span><span class="n">bindings</span><span class="w"> </span><span class="bp">()</span><span class="o">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">withConsoleTrace</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">startElmishLoop</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="n">window</span>
</code></pre></div>
<p><strong>重要</strong>: Elmish.WPF 3.5.8 では <code>runElmishLoop</code> 関数は存在しません。代わりに <code>startElmishLoop</code> を使用します。この関数は既存の WPF Application の Dispatcher を使用し、非ブロッキングで Elmish ループを開始します。</p>
<h4 id="5-c-wpf">ステップ 5: C# WPF プロジェクトの作成<a class="headerlink" href="#5-c-wpf" title="Permanent link">&para;</a></h4>
<p>Visual Studio テンプレート「WPF App (.NET)」を使用して C# プロジェクトを作成します。</p>
<p>プロジェクトファイル (<code>src/PuyoPuyo.App/PuyoPuyo.App.csproj</code>) を以下のように設定:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;OutputType&gt;</span>Exe<span class="nt">&lt;/OutputType&gt;</span><span class="w">  </span><span class="cm">&lt;!-- コンソールログを表示したい場合 --&gt;</span>
<span class="w">    </span><span class="nt">&lt;DisableWinExeOutputInference&gt;</span>true<span class="nt">&lt;/DisableWinExeOutputInference&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net9.0-windows<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">    </span><span class="nt">&lt;UseWPF&gt;</span>true<span class="nt">&lt;/UseWPF&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;ProjectReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;..\PuyoPuyo.WPF\PuyoPuyo.WPF.fsproj&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<h4 id="6-appxaml">ステップ 6: App.xaml の設定<a class="headerlink" href="#6-appxaml" title="Permanent link">&para;</a></h4>
<p><code>App.xaml</code> に StartupUri を設定します:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Application</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyo.App.App&quot;</span>
<span class="w">             </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">             </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">             </span><span class="na">StartupUri=</span><span class="s">&quot;MainWindow.xaml&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Application.Resources&gt;</span>

<span class="w">    </span><span class="nt">&lt;/Application.Resources&gt;</span>
<span class="nt">&lt;/Application&gt;</span>
</code></pre></div>
<h4 id="7-appxamlcs">ステップ 7: App.xaml.cs の変更<a class="headerlink" href="#7-appxamlcs" title="Permanent link">&para;</a></h4>
<p><code>App.xaml.cs</code> を編集して、アプリケーション起動時に Elmish を初期化します:</p>
<div class="highlight"><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.App</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Application</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">App</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="n">Activated</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">StartElmish</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">StartElmish</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">EventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="n">Activated</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">StartElmish</span><span class="p">;</span>
<span class="w">            </span><span class="n">Program</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="n">MainWindow</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="8-mainwindowxaml">ステップ 8: MainWindow.xaml の作成<a class="headerlink" href="#8-mainwindowxaml" title="Permanent link">&para;</a></h4>
<p>XAML でバインディングを定義します:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Window</span>
<span class="w">    </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyo.App.MainWindow&quot;</span>
<span class="w">    </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">    </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">    </span><span class="na">Title=</span><span class="s">&quot;Counter Sample&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;200&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Horizontal&quot;</span><span class="w"> </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="w"> </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding CounterValue}&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding Decrement}&quot;</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding Increment}&quot;</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;+&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding StepSize}&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;18&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;Slider</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;{Binding StepSize}&quot;</span><span class="w"> </span><span class="na">TickFrequency=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Minimum=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Maximum=</span><span class="s">&quot;10&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;150&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<h4 id="_16">動作確認<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>Cake タスクでアプリケーションを実行します:</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>run
</code></pre></div>
<p>カウンターアプリケーションが起動し、以下の機能が動作することを確認できます:</p>
<ul>
<li>カウンター値が表示される</li>
<li><code>+</code> / <code>-</code> ボタンでカウントが増減する</li>
<li>スライダーでステップサイズを変更できる</li>
<li>コンソールに状態遷移のログが表示される（<code>Program.withConsoleTrace</code> による）</li>
</ul>
<p>この構成により、F# でロジックを、XAML で UI を管理する明確な分離が実現します。</p>
<p>[注: 以降のイテレーションでは、このアーキテクチャを踏襲し、ドメインロジックは F# で、UI は XAML で実装します]</p>
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>「環境構築が終わったので、いよいよゲームの実装を始めましょう！」そうですね！最初のイテレーションでは、ゲームの基本となるボードとぷよのデータ構造を実装していきます。</p>
<h3 id="_17">ユーザーストーリー<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームを開始して初期状態のボードとぷよが表示される</p>
</blockquote>
<p>「ゲームを開始するって、具体的に何が必要なんですか？」良い質問ですね！ゲームを開始するためには、以下のような要素が必要です：</p>
<ol>
<li><strong>ゲームボード</strong>：ぷよを配置する場所</li>
<li><strong>ぷよ</strong>：落ちてくるゲームの主役</li>
<li><strong>初期状態</strong>：ゲームが始まったときの状態</li>
</ol>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの色を表現する型を定義する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ゲームボードを表現する型を定義する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 空のボードを作成する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよをボードに配置する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ボードからぷよを取得する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<p>「結構たくさんありますね！」そうですね。でも、一つ一つは小さな機能なので、TDDサイクルに従って着実に進めていけば大丈夫ですよ。</p>
<h3 id="_18">テスト: ぷよの色定義<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>「最初は何からテストしますか？」まずは最も基本的な「ぷよの色」から始めましょう。F#では判別共用体（Discriminated Union）を使って、型安全にぷよの色を表現できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/PuyoTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Domain.PuyoTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよの色は4種類定義されている``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">]</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``赤色のぷよが作成できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Red</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">puyo</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Red</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``緑色のぷよが作成できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">puyo</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Green</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下の点を確認しています：</p>
<ol>
<li>ぷよの色が4種類（赤、緑、青、黄）定義されているか</li>
<li>それぞれの色のぷよが作成できるか</li>
</ol>
<p>「シンプルですね！」そうです。まずは基本から始めましょう。では、このテストが通るように実装していきます。</p>
<h3 id="_19">実装: ぷよの色定義<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。まずはテストを実行してみてください：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>テストが失敗することを確認したら、実装を進めます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Puyo.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Domain</span>

<span class="sd">/// ぷよの色</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Puyo</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// ぷよの色をHEX形式の文字列に変換</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">toHex</span><span class="w"> </span><span class="o">(</span><span class="n">color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#FF0000&quot;</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#00FF00&quot;</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#0000FF&quot;</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;#FFFF00&quot;</span>
</code></pre></div>
<p>「判別共用体を使うと、色を型安全に扱えるんですね！」そうです！TypeScriptでは数値で色を表現していましたが、F#では判別共用体を使うことで、コンパイル時に存在しない色を使おうとするとエラーになります。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="_20">テスト: ゲームボードの作成<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>「次は何をテストしますか?」次は、ぷよを配置するゲームボードを実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Domain.BoardTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``空のボードを作成できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">13</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``作成直後のボードはすべて空である``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ボードにぷよを配置できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ボードにぷよを配置しても元のボードは変更されない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
</code></pre></div>
<p>「イミュータブルなデータ構造のテストもあるんですね！」そうです！F#ではデフォルトでデータ構造がイミュータブルなので、<code>setCell</code>を呼び出しても元のボードは変更されず、新しいボードが返されます。これが最後のテストで確認している内容です。</p>
<h3 id="_21">実装: ゲームボードの作成<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ボードの実装を進めます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Domain</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="sd">/// セルの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">PuyoColor</span>

<span class="sd">/// ゲームボード</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Cols</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Rows</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Cells</span><span class="o">:</span><span class="w"> </span><span class="n">Cell</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">array</span>
<span class="o">}</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// 空のボードを作成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">create</span><span class="w"> </span><span class="o">(</span><span class="n">cols</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">rows</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="n">Cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cols</span>
<span class="w">            </span><span class="n">Rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rows</span>
<span class="w">            </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="n">Empty</span><span class="o">)</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// セルの取得</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">getCell</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Cell</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">board</span><span class="o">.</span><span class="n">Cells</span><span class="o">.[</span><span class="n">y</span><span class="o">].[</span><span class="n">x</span><span class="o">]</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">Empty</span>

<span class="w">    </span><span class="sd">/// セルの設定（イミュータブル）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">setCell</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">cell</span><span class="o">:</span><span class="w"> </span><span class="n">Cell</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newCells</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">board</span><span class="o">.</span><span class="n">Cells</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">rowIndex</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">rowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="n">row</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">colIndex</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="n">colIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">c</span><span class="o">)</span>
<span class="w">                    </span><span class="k">else</span>
<span class="w">                        </span><span class="n">row</span><span class="o">)</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCells</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">board</span>
</code></pre></div>
<p>「<code>Array.mapi</code>を使って新しい配列を作成しているんですね！」そうです！F#では元のデータを変更せず、新しいデータを作成して返すのが基本です。<code>mapi</code>は<code>map</code>にインデックスが追加されたバージョンで、各要素の位置を確認しながら変換できます。</p>
<blockquote>
<p><strong>💡 ポイント</strong>: <code>setCell</code> の引数順序を <code>(x: int) (y: int) (cell: Cell) (board: Board)</code> にすることで、F# のパイプライン演算子 <code>|&gt;</code> との相性が良くなります。<code>board |&gt; setCell 2 10 (Filled Red)</code> のように自然に記述できます。</p>
</blockquote>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="_22">テスト: ぷよペアの定義<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>「ぷよぷよでは2つのぷよが一緒に落ちてきますよね？」そうです！次は、2つのぷよをペアとして扱うデータ構造を実装しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/PuyoPairTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Domain.PuyoPairTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを作成できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Red</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Green</span>
<span class="w">    </span><span class="n">pair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態0のとき2つ目のぷよは上にある``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">4</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは上</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態1のとき2つ目のぷよは右にある``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは右</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態2のとき2つ目のぷよは下にある``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">2</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">6</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは下</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態3のとき2つ目のぷよは左にある``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">3</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは左</span>
</code></pre></div>
<p>「回転状態によって2つ目のぷよの位置が変わるんですね！」そうです！回転状態（0-3）によって、2つ目のぷよが軸ぷよの上下左右のどこにあるかが決まります。</p>
<h3 id="_23">実装: ぷよペアの定義<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/PuyoPair.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Domain</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="sd">/// ぷよペア</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Puyo1Color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w">  </span><span class="c1">// 軸ぷよ</span>
<span class="w">    </span><span class="n">Puyo2Color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w">  </span><span class="c1">// 2つ目のぷよ</span>
<span class="w">    </span><span class="n">Rotation</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w">          </span><span class="c1">// 0: 上, 1: 右, 2: 下, 3: 左</span>
<span class="o">}</span>

<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// ぷよペアを作成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">create</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">color1</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">color2</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">rotation</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="w">            </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span>
<span class="w">            </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color1</span>
<span class="w">            </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color2</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotation</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// ぷよペアの各ぷよの位置を取得</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">getPositions</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">pos1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">pos2</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w">      </span><span class="c1">// 上</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="o">)</span><span class="w">      </span><span class="c1">// 右</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w">      </span><span class="c1">// 下</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="o">)</span><span class="w">      </span><span class="c1">// 左</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">X</span><span class="o">,</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w">      </span><span class="c1">// デフォルトは上</span>
<span class="w">        </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span>

<span class="w">    </span><span class="sd">/// ランダムなぷよペアを生成</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">createRandom</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">rotation</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="n">Random</span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[|</span><span class="w"> </span><span class="n">Red</span><span class="o">;</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">|]</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">color1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="o">.[</span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="o">)]</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">color2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colors</span><span class="o">.[</span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="n">colors</span><span class="o">.</span><span class="n">Length</span><span class="o">)]</span>
<span class="w">        </span><span class="n">create</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">color1</span><span class="w"> </span><span class="n">color2</span><span class="w"> </span><span class="n">rotation</span>
</code></pre></div>
<p>「パターンマッチングで回転状態に応じた位置を計算しているんですね！」そうです！F#のパターンマッチングを使うことで、回転状態に応じた処理を明確に書けます。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="elmish-model">Elmish Model の定義<a class="headerlink" href="#elmish-model" title="Permanent link">&para;</a></h3>
<p>「ドメインの型ができたので、次はElmishのModelを定義しましょう！」そうですね。ゲームの状態を表すModelを定義します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Model.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Elmish</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>

<span class="sd">/// ゲームの状態</span>
<span class="k">type</span><span class="w"> </span><span class="nc">GameStatus</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">NotStarted</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span>

<span class="sd">/// ゲームのModel</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">Board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span>
<span class="w">    </span><span class="n">CurrentPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">NextPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span>
<span class="w">    </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Level</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">GameTime</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">LastChainCount</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">    </span><span class="n">Status</span><span class="o">:</span><span class="w"> </span><span class="n">GameStatus</span>
<span class="o">}</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// 初期状態</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">            </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">            </span><span class="n">NextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">GameTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">LastChainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span>
<span class="w">        </span><span class="o">}</span>
</code></pre></div>
<p>「<code>option</code>型を使っているのはなぜですか？」良い質問ですね！<code>option</code>型は「値があるかもしれないし、ないかもしれない」を表現する型です。ゲーム開始前や、ぷよが固定された直後は<code>CurrentPiece</code>が<code>None</code>になり、ぷよが落下中は<code>Some puyoPair</code>になります。これにより、nullチェックが不要になり、安全にコードが書けます。</p>
<h3 id="elmish-message">Elmish Message の定義<a class="headerlink" href="#elmish-message" title="Permanent link">&para;</a></h3>
<p>「次はMessageを定義しましょう！」はい、ユーザーの操作やゲームイベントを表すMessageを定義します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Model.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Elmish.Model</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.GameLogic</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.Score</span>

<span class="c1">// ゲームモデル</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">Board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span>
<span class="w">      </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">Score</span>
<span class="w">      </span><span class="n">GameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span>
<span class="w">      </span><span class="n">CurrentPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// メッセージ定義</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>

<span class="c1">// 初期化関数</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>
<span class="w">      </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initialScore</span>
<span class="w">      </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span>
<span class="w">      </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「たくさんのメッセージがありますね！」そうですね。それぞれのメッセージが特定のイベントや操作を表しています。今回のイテレーションでは、まず<code>StartGame</code>だけを実装していきます。</p>
<h3 id="update">Update 関数の実装<a class="headerlink" href="#update" title="Permanent link">&para;</a></h3>
<p>「Update関数を実装しましょう！」はい、まずは基本的な部分だけを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Elmish.Update</span>

<span class="k">open</span><span class="w"> </span><span class="nn">System</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.GameLogic</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Model</span>

<span class="c1">// ランダム生成器を受け取る更新関数（テスト用）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">updateWithRandom</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span><span class="o">)</span>
<span class="w">            </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">model</span>

<span class="c1">// 更新関数（Elmish用）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="bp">()</span>
<span class="w">    </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>「Bolero 版と違って <code>Cmd.none</code> を返していませんね？」そうです！これが重要な違いです：</p>
<p><strong>Elmish.WPF での Update 関数の特徴</strong>:
- <strong>戻り値</strong>: <code>Model</code> のみ（<code>Model * Cmd&lt;Message&gt;</code> ではない）
- <strong>Cmd の使用</strong>: <code>update</code> 関数では使用しない（<code>init</code> 関数でのみ使用）
- <strong>理由</strong>: Elmish.WPF は WPF の UI スレッドと統合するための設計</p>
<p>「<code>with</code>キーワードを使っているのはなぜですか？」F#のレコード型には「レコードコピー式」という機能があり、<code>{ model with Score = 0 }</code>のように書くことで、一部のフィールドだけを変更した新しいレコードを作成できます。元の<code>model</code>は変更されません。</p>
<p>「<code>updateWithRandom</code> 関数があるのはなぜですか？」テストで <code>Random</code> を注入できるようにするためです。これにより、テストで決定的な値を使って検証できます。</p>
<h3 id="xaml-view">XAML View の実装<a class="headerlink" href="#xaml-view" title="Permanent link">&para;</a></h3>
<p>「最後にViewを実装しましょう！」はい、WPFではXAMLでUIを定義します。</p>
<h4 id="mainwindowxaml">MainWindow.xaml<a class="headerlink" href="#mainwindowxaml" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- src/PuyoPuyo.App/MainWindow.xaml --&gt;</span>
<span class="nt">&lt;Window</span>
<span class="w">    </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyo.App.MainWindow&quot;</span>
<span class="w">    </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">    </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">    </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよゲーム&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;690&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;500&quot;</span>
<span class="w">    </span><span class="na">Focusable=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Vertical&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- タイトル --&gt;</span>
<span class="w">    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;ぷよぷよゲーム&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span><span class="w"> </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- ゲームエリア（ボードと情報パネルを横に並べる） --&gt;</span>
<span class="w">    </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Horizontal&quot;</span><span class="w"> </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="cm">&lt;!-- ゲームボード --&gt;</span>
<span class="w">      </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;Canvas</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;WhiteSmoke&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;240&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;520&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;ItemsControl</span><span class="w"> </span><span class="na">ItemsSource=</span><span class="s">&quot;{Binding Puyos}&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;ItemsControl.ItemsPanel&gt;</span>
<span class="w">              </span><span class="nt">&lt;ItemsPanelTemplate&gt;</span>
<span class="w">                </span><span class="nt">&lt;Canvas/&gt;</span>
<span class="w">              </span><span class="nt">&lt;/ItemsPanelTemplate&gt;</span>
<span class="w">            </span><span class="nt">&lt;/ItemsControl.ItemsPanel&gt;</span>
<span class="w">            </span><span class="nt">&lt;ItemsControl.ItemContainerStyle&gt;</span>
<span class="w">              </span><span class="nt">&lt;Style&gt;</span>
<span class="w">                </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Canvas.Left&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;{Binding X}&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Canvas.Top&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;{Binding Y}&quot;</span><span class="nt">/&gt;</span>
<span class="w">              </span><span class="nt">&lt;/Style&gt;</span>
<span class="w">            </span><span class="nt">&lt;/ItemsControl.ItemContainerStyle&gt;</span>
<span class="w">            </span><span class="nt">&lt;ItemsControl.ItemTemplate&gt;</span>
<span class="w">              </span><span class="nt">&lt;DataTemplate&gt;</span>
<span class="w">                </span><span class="nt">&lt;Ellipse</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;36&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;36&quot;</span><span class="w"> </span><span class="na">Fill=</span><span class="s">&quot;{Binding Color}&quot;</span><span class="w"> </span><span class="na">Stroke=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">StrokeThickness=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="w">              </span><span class="nt">&lt;/DataTemplate&gt;</span>
<span class="w">            </span><span class="nt">&lt;/ItemsControl.ItemTemplate&gt;</span>
<span class="w">          </span><span class="nt">&lt;/ItemsControl&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Canvas&gt;</span>
<span class="w">      </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">      </span><span class="cm">&lt;!-- 情報パネル --&gt;</span>
<span class="w">      </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Vertical&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="w"> </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Top&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- スコア表示 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;Score&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;14&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;0,5,0,5&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Score}&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;16&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,10&quot;</span><span class="nt">/&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- 連鎖数表示 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;Chain&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;14&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;0,5,0,5&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Chain}&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;16&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,10&quot;</span><span class="nt">/&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- 次のぷよ表示 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;Next&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;14&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="w"> </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;0,5,0,5&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;LightGray&quot;</span><span class="w"> </span><span class="na">BorderThickness=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,10&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;Canvas</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;Transparent&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;50&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- 次のぷよはここに表示される（将来実装） --&gt;</span>
<span class="w">          </span><span class="nt">&lt;/Canvas&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>
<span class="w">      </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">    </span><span class="nt">&lt;/StackPanel&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- コントロールボタン --&gt;</span>
<span class="w">    </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding StartGame}&quot;</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;ゲーム開始&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;120&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="w"> </span><span class="na">IsEnabled=</span><span class="s">&quot;{Binding CanStartGame}&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>「Bolero 版と大きく違いますね！」そうです！重要な違いを説明します：</p>
<p><strong>Bolero 版との違い</strong>:
- <strong>Bolero</strong>: <code>ItemsControl</code> で <code>Grid</code> を使用して行・列を表示
- <strong>Elmish.WPF</strong>: <code>Canvas</code> を使用して絶対位置指定でぷよを配置</p>
<p>WPF の <code>Canvas</code> を使うことで、以下の利点があります：</p>
<ol>
<li><strong>絶対位置指定</strong>: 各ぷよの位置を <code>Canvas.Left</code> と <code>Canvas.Top</code> で正確に指定</li>
<li><strong>シンプルなバインディング</strong>: ぷよのリスト（<code>Puyos</code>）を直接バインド</li>
<li><strong>パフォーマンス</strong>: グリッド全体ではなく、必要なぷよだけを描画</li>
</ol>
<p>「<code>IsEnabled="{Binding CanStartGame}"</code> で何をしているんですか？」良い質問ですね！<code>CanStartGame</code> は、ゲームが NotStarted 状態のときだけ <code>true</code> を返すバインディングです。これにより、ゲーム開始ボタンは最初だけ有効になり、ゲーム中は無効になります。</p>
<h4 id="elmish-bindings">Elmish Bindings の実装<a class="headerlink" href="#elmish-bindings" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Components.GameView</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.WPF</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.GameLogic</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.Puyo</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Model</span>

<span class="c1">// ぷよ表示用ViewModel</span>
<span class="k">type</span><span class="w"> </span><span class="nc">PuyoViewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="kt">float</span><span class="o">;</span><span class="w"> </span><span class="n">Color</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">}</span>

<span class="k">let</span><span class="w"> </span><span class="nv">getAllPuyos</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">cellSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="o">.</span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">yOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="c1">// Y座標-1のぷよを表示するためのオフセット</span>
<span class="w">    </span><span class="c1">// ボード上のぷよを収集</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">boardPuyos</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">[</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">5</span><span class="w"> </span><span class="k">do</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">11</span><span class="w"> </span><span class="k">do</span>
<span class="w">                  </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCellColor</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span>

<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">                      </span><span class="k">yield</span>
<span class="w">                          </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span>
<span class="w">                            </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">yOffset</span>
<span class="w">                            </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoColorToString</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">]</span>
<span class="w">    </span><span class="c1">// 現在のぷよペアを追加</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pairPuyos</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="bp">[]</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="o">[</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span>
<span class="w">                </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">yOffset</span>
<span class="w">                </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoColorToString</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Axis</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span>
<span class="w">                </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cellSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">yOffset</span>
<span class="w">                </span><span class="n">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoColorToString</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Child</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">]</span>

<span class="w">    </span><span class="nn">List</span><span class="p">.</span><span class="n">append</span><span class="w"> </span><span class="n">boardPuyos</span><span class="w"> </span><span class="n">pairPuyos</span>

<span class="c1">// Elmish バインディング</span>
<span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;Score&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Score</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Chain&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="c1">// 連鎖数（将来実装予定）</span>
<span class="w">      </span><span class="s">&quot;Puyos&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getAllPuyos</span><span class="w"> </span><span class="n">m</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;StartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">StartGame</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;CanStartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="o">)</span><span class="w"> </span><span class="o">]</span>
</code></pre></div>
<p>「<code>Binding.cmd</code> と <code>Binding.oneWay</code> の違いは何ですか？」良い質問ですね！</p>
<ul>
<li><strong><code>Binding.cmd</code></strong>: コマンド（ユーザーアクション）をバインド</li>
<li>例: <code>"StartGame" |&gt; Binding.cmd (fun _ -&gt; StartGame)</code></li>
<li>
<p>XAML での使用: <code>Command="{Binding StartGame}"</code></p>
</li>
<li>
<p><strong><code>Binding.oneWay</code></strong>: データの一方向バインディング</p>
</li>
<li>例: <code>"Score" |&gt; Binding.oneWay (fun m -&gt; m.Score)</code></li>
<li>XAML での使用: <code>Text="{Binding Score}"</code></li>
</ul>
<p>「<code>getAllPuyos</code> 関数で何をしているんですか？」この関数は、ボード上の固定されたぷよと現在落下中のぷよペアを結合して、表示用の <code>PuyoViewModel</code> のリストを作成しています。各ぷよは <code>X</code>、<code>Y</code> 座標と <code>Color</code> を持ち、XAML の <code>Canvas</code> 上に絶対位置で配置されます。</p>
<h4 id="_24">アプリケーションのエントリーポイント<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Program.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Program</span>

<span class="k">open</span><span class="w"> </span><span class="nn">System</span>
<span class="k">open</span><span class="w"> </span><span class="nn">System.Windows</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.WPF</span>

<span class="o">[&lt;</span><span class="n">STAThread</span><span class="o">&gt;]</span>
<span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Application</span><span class="bp">()</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">window</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="nn">App</span><span class="p">.</span><span class="n">MainWindow</span><span class="bp">()</span>
<span class="w">    </span><span class="n">window</span><span class="o">.</span><span class="n">Loaded</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">window</span><span class="o">.</span><span class="n">Focus</span><span class="bp">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">ignore</span><span class="o">)</span>

<span class="w">    </span><span class="nn">Program</span><span class="p">.</span><span class="n">mkSimple</span><span class="w"> </span><span class="nn">Elmish</span><span class="p">.</span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="nn">Elmish</span><span class="p">.</span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="nn">Components</span><span class="p">.</span><span class="nn">GameView</span><span class="p">.</span><span class="n">bindings</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">runElmishLoop</span><span class="w"> </span><span class="n">window</span>

<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="n">Run</span><span class="o">(</span><span class="n">window</span><span class="o">)</span>
</code></pre></div>
<p>「<code>Program.mkSimple</code> でElmishを起動するんですね！」そうです！Elmish.WPFでは、<code>Program.mkSimple</code>に3つの関数を渡すことでElmishループを開始します：</p>
<ol>
<li><strong>init</strong>: 初期状態を作成する関数</li>
<li><strong>update</strong>: メッセージを受け取って状態を更新する関数</li>
<li><strong>bindings</strong>: Model と View をつなぐバインディング定義</li>
</ol>
<p>「<code>Program.runElmishLoop</code> は何をしているんですか？」この関数は、Elmish のメインループを開始し、WPF の <code>Window</code> と統合します。これにより、Model の変更が自動的に UI に反映されます。</p>
<h3 id="update_1">テスト: Update 関数の統合テスト<a class="headerlink" href="#update_1" title="Permanent link">&para;</a></h3>
<p>「Update 関数の動作もテストしたいです！」良いですね！Elmish の統合テストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Elmish.UpdateTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">System</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.GameLogic</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Model</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Update</span>

<span class="k">module</span><span class="w"> </span><span class="n">``ゲーム初期化``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``初期化時にゲーム状態がNotStarted``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">model</span><span class="o">.</span><span class="n">GameState</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">NotStarted</span>

<span class="k">module</span><span class="w"> </span><span class="n">``ゲームループ``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``StartGameメッセージで新しいぷよペアが生成される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="ow">not</span><span class="k">&#39;</span><span class="w"> </span><span class="o">(</span><span class="n">equal</span><span class="w"> </span><span class="n">None</span><span class="o">)</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``StartGameメッセージでゲーム状態がPlayingになる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">newModel</span><span class="o">.</span><span class="n">GameState</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Playing</span>
</code></pre></div>
<p>「<code>updateWithRandom</code> を使っているのはなぜですか？」良い質問ですね！テストでは、ランダム性を排除して決定的な結果を得るために、シード値を指定した <code>Random</code> インスタンスを注入します。これにより、毎回同じ結果が得られ、テストが安定します。</p>
<p>「Bolero 版のテストと何が違いますか？」重要な違いがあります：</p>
<p><strong>Bolero 版との違い</strong>:
- <strong>Bolero</strong>: <code>let newModel, _ = update StartGame model</code> のようにタプルを分解
- <strong>Elmish.WPF</strong>: <code>let newModel = updateWithRandom random StartGame model</code> で Model だけを受け取る</p>
<p>Elmish.WPF の <code>update</code> 関数は <code>Model</code> のみを返すため、タプル分解は不要です。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="_25">動作確認<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、アプリケーションを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>run<span class="w"> </span>--project<span class="w"> </span>src/PuyoPuyo.WPF/PuyoPuyo.WPF.fsproj
</code></pre></div>
<p>または Cake タスクで：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Run
</code></pre></div>
<p>WPFウィンドウが開き、「ゲーム開始」ボタンが表示され、クリックするとボードとぷよが表示されるはずです！</p>
<h3 id="_26">コミット<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement basic game board and puyo display (Elmish.WPF)</span>

<span class="s2">- Add PuyoColor discriminated union (Red, Green, Blue, Yellow)</span>
<span class="s2">- Add Board type with create, getCell, setCell functions</span>
<span class="s2">- Add PuyoPair type with AxisPosition and ChildPosition</span>
<span class="s2">- Add Elmish Model and Message types</span>
<span class="s2">- Add Update function with updateWithRandom for testing</span>
<span class="s2">- Add XAML View with Canvas-based board rendering</span>
<span class="s2">- Add Elmish.WPF Bindings with getAllPuyos function</span>
<span class="s2">- Add CanStartGame binding for button enable/disable</span>
<span class="s2">- All tests passing (21 tests)&quot;</span>
</code></pre></div>
<h3 id="1_1">イテレーション1のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ドメイン層</strong></li>
<li><code>PuyoColor</code>：判別共用体を使った型安全な色定義（Red、Green、Blue、Yellow）</li>
<li><code>Board</code>：2次元配列による不変のゲームボード</li>
<li><code>PuyoPair</code>：軸ぷよと子ぷよの2つの位置と色を持つペア</li>
<li>
<p><code>GameState</code>：ゲーム状態（NotStarted、Playing、GameOver）</p>
</li>
<li>
<p><strong>Elmish層</strong></p>
</li>
<li><code>Model</code>：ゲーム状態の定義（Board、CurrentPair、Score、GameState）</li>
<li><code>Message</code>：イベントの定義（StartGame、Tick、MoveLeft、MoveRight、MoveDown、Rotate）</li>
<li><code>Update</code>：状態遷移ロジック（<code>updateWithRandom</code> でテスト容易性を確保）</li>
<li>
<p><strong>重要</strong>: Elmish.WPF では <code>update</code> 関数は <code>Model</code> のみを返す（<code>Cmd</code> は返さない）</p>
</li>
<li>
<p><strong>View層（WPF固有）</strong></p>
</li>
<li>XAML による UI の宣言的定義</li>
<li><code>Canvas</code> を使用した絶対位置指定によるぷよの配置</li>
<li><code>ItemsControl</code> による動的なぷよリストの描画</li>
<li>
<p><code>Command</code> バインディングによるイベント処理</p>
</li>
<li>
<p><strong>Bindings層（WPF固有）</strong></p>
</li>
<li><code>getAllPuyos</code> 関数：ボード上のぷよと現在のぷよペアを <code>PuyoViewModel</code> のリストに変換</li>
<li><code>Binding.oneWay</code>：データの一方向バインディング（Score、Chain、Puyos）</li>
<li><code>Binding.cmd</code>：コマンドバインディング（StartGame）</li>
<li>
<p><code>CanStartGame</code>：ゲーム状態に基づくボタンの有効/無効制御</p>
</li>
<li>
<p><strong>TDDサイクルの実践</strong></p>
</li>
<li>Red：失敗するテストを先に作成</li>
<li>Green：テストを通す実装</li>
<li>
<p>Refactor：コードの整理</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>判別共用体による型安全な定義</li>
<li>イミュータブルなデータ構造（レコード型）</li>
<li>レコードコピー式（<code>with</code>キーワード）</li>
<li>Option型による安全なnull処理</li>
<li>パターンマッチング</li>
<li>Elmishの基本（Model-Message-Update）</li>
<li><strong>Elmish.WPF固有</strong>: <code>update</code> 関数は <code>Model</code> のみを返す（<code>Model * Cmd</code> ではない）</li>
<li><strong>Elmish.WPF固有</strong>: テスト用に <code>updateWithRandom</code> で Random を注入</li>
<li><strong>WPF固有</strong>: XAML の <code>Canvas</code> による絶対位置指定</li>
<li><strong>WPF固有</strong>: データバインディング（<code>Binding.oneWay</code>、<code>Binding.cmd</code>）</li>
<li><strong>WPF固有</strong>: <code>IsEnabled</code> バインディングによる動的UI制御</li>
</ol>
<p>次のイテレーションでは、ぷよの移動機能を実装していきます。</p>
<h3 id="1_2">イテレーション1の実施内容<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、wpf プロジェクトの実装を参考にしながら、wpf-2 プロジェクトのファイル構成と UI を整備しました。</p>
<h4 id="_27">実施したリファクタリング<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<p><strong>1. ファイル構成の再組織化 (commit 7a37fe2)</strong></p>
<p>ソースコードをドメイン駆動設計に準拠した構成に再組織化：</p>
<div class="highlight"><pre><span></span><code>wpf-2/src/PuyoPuyo.WPF/
├── Domain/              # ドメイン層
│   ├── Puyo.fs         # ぷよの色定義
│   ├── Board.fs        # ボード管理
│   ├── Score.fs        # スコア型
│   ├── PuyoPair.fs     # ぷよペアロジック
│   └── GameLogic.fs    # ゲーム状態
├── Elmish/             # Elmish 層
│   ├── Model.fs        # モデルとメッセージ定義
│   ├── Update.fs       # 更新ロジック
│   └── Subscription.fs # タイマー購読
├── Components/         # コンポーネント層
│   └── GameView.fs     # ビューモデルとバインディング
└── Program.fs          # エントリーポイント
</code></pre></div>
<p>削除したファイル：
- Counter.fs (サンプルコード)
- Library.fs (未使用)
- Game.fs (上記ファイルに分割)</p>
<p><strong>2. テストファイル構成の再組織化 (commit cac81f7)</strong></p>
<p>テストも同様にモジュール別に分割：</p>
<div class="highlight"><pre><span></span><code>wpf-2/tests/PuyoPuyo.Tests/
├── Domain/
│   ├── PuyoTests.fs        # ぷよ色テスト (2 tests)
│   ├── BoardTests.fs       # ボード操作テスト (3 tests)
│   ├── ScoreTests.fs       # スコアテスト (1 test)
│   ├── PuyoPairTests.fs    # ぷよペアテスト (5 tests)
│   └── GameLogicTests.fs   # ゲーム状態テスト (4 tests)
├── Elmish/
│   └── UpdateTests.fs      # 更新ロジックテスト (6 tests)
└── Tests.fs                # エントリーポイント
</code></pre></div>
<p>テスト数: 19 → 21 テスト</p>
<h4 id="ui">UI の改善<a class="headerlink" href="#ui" title="Permanent link">&para;</a></h4>
<p><strong>3. MainWindow.xaml レイアウト更新 (commit 71428bf)</strong></p>
<p>wpf の GameView.fs に合わせてレイアウトを改善：
- タイトル、ボード、情報パネルを横並びに配置
- Score、Chain、Next 表示エリアを追加
- Chain バインディングを追加（現在は 0 を返す、将来実装予定）
- ウィンドウ幅を 400px → 500px に拡張</p>
<p><strong>4. NotStarted 状態の追加 (commit 3728859)</strong></p>
<p>ゲーム状態に NotStarted を追加してボタン制御を実装：
- GameState に NotStarted を追加
- 初期状態を NotStarted に変更
- StartGame メッセージで GameState を Playing に更新
- CanStartGame バインディングを追加
- MainWindow.xaml のボタンに IsEnabled バインディングを追加
- テスト 2 件追加（合計 21 テスト）</p>
<p><strong>5. ウィンドウ高さ調整 (commit 649a1ba)</strong></p>
<p>スタートボタンが隠れる問題を解決：
- ウィンドウ高さを 600px → 650px に変更</p>
<p><strong>6. Y 座標-1 の子ぷよ表示対応 (commit 1e5f766)</strong></p>
<p>初期表示で上のぷよ（子ぷよ）を表示できるように：
- GameView.fs で Y 座標に 40px のオフセットを追加
- Canvas 高さを 480px → 520px に拡張（13 行分）
- ウィンドウ高さを 650px → 690px に調整</p>
<p>これにより、ぷよペアの初期位置 (Axis: Y=0, Child: Y=-1) の両方のぷよが画面に表示されるようになりました。</p>
<h4 id="ci_1">CI パイプライン実行結果<a class="headerlink" href="#ci_1" title="Permanent link">&para;</a></h4>
<p>全てのタスクが成功：</p>
<table>
<thead>
<tr>
<th>タスク</th>
<th>ステータス</th>
<th>詳細</th>
</tr>
</thead>
<tbody>
<tr>
<td>Clean</td>
<td>✅ 完了</td>
<td>ビルド成果物クリーンアップ</td>
</tr>
<tr>
<td>Format-Check</td>
<td>✅ 完了</td>
<td>コードフォーマットチェック</td>
</tr>
<tr>
<td>Lint</td>
<td>✅ 完了</td>
<td>0 warnings</td>
</tr>
<tr>
<td>Restore</td>
<td>✅ 完了</td>
<td>NuGet パッケージ復元</td>
</tr>
<tr>
<td>Build</td>
<td>✅ 成功</td>
<td>0 errors, 0 warnings</td>
</tr>
<tr>
<td>Test</td>
<td>✅ 成功</td>
<td><strong>21/21 テスト合格</strong></td>
</tr>
<tr>
<td>Coverage</td>
<td>✅ 完了</td>
<td>Line: 48.30%, Branch: 58.33%, Method: 56.60%</td>
</tr>
</tbody>
</table>
<h4 id="_28">学んだこと<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>ドメイン駆動設計のファイル構成</strong></li>
<li>Domain、Elmish、Components の明確な分離</li>
<li>各層の責務の明確化</li>
<li>
<p>テストも同じ構成で整理</p>
</li>
<li>
<p><strong>WPF データバインディング</strong></p>
</li>
<li>IsEnabled バインディングによる動的な UI 制御</li>
<li>
<p>CanStartGame で NotStarted 状態の時のみボタンを有効化</p>
</li>
<li>
<p><strong>Canvas の座標系</strong></p>
</li>
<li>負の Y 座標を表示するためのオフセット技法</li>
<li>
<p>Canvas のサイズ調整とウィンドウサイズの連動</p>
</li>
<li>
<p><strong>F# のモジュールシステム</strong></p>
</li>
<li>1 ファイル 1 モジュールの原則</li>
<li>
<p>コンパイル順序の重要性（.fsproj の Compile 順序）</p>
</li>
<li>
<p><strong>TDD の継続的な実践</strong></p>
</li>
<li>リファクタリング後もテストが全て通過</li>
<li>テスト数の増加（19 → 21 テスト）</li>
<li>CI パイプラインによる品質保証</li>
</ol>
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>「ゲームが開始できるようになったので、次は何をしますか？」次は、ぷよを動かせるようにしましょう！プレイヤーがキーボードでぷよを左右に移動できる機能を実装します。</p>
<h3 id="_29">ユーザーストーリー<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「左右に移動するって、具体的にどうやるんですか？」良い質問ですね！キーボードの左右矢印キーを押すと、ぷよが左右に1マスずつ移動します。ただし、壁やボードの端には移動できません。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> キー入力を検出する機能を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを左に移動する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> ぷよを右に移動する関数を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 移動時の境界チェックを実装する（壁を越えない）</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update関数にキー入力処理を組み込む</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<h3 id="_30">テスト: ぷよの移動ロジック<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>「最初は何からテストしますか？」まずは、ぷよの移動ロジックをテストしましょう。Elmish.WPF では、キー入力は View 層で処理し、Message として dispatch します。Domain 層では、純粋な移動ロジックだけをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/GameLogicTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Domain.GameLogicTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.GameLogic</span>

<span class="k">module</span><span class="w"> </span><span class="n">``ぷよペアの移動``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを左に移動できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="n">AxisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Red</span>
<span class="w">              </span><span class="n">ChildColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Left</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">movedPair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">            </span><span class="n">movedPair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;移動できるはずです&quot;</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを右に移動できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="n">AxisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Red</span>
<span class="w">              </span><span class="n">ChildColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Right</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">movedPair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">3</span>
<span class="w">            </span><span class="n">movedPair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;移動できるはずです&quot;</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``左端では左に移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="n">AxisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Red</span>
<span class="w">              </span><span class="n">ChildColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Left</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``右端では右に移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>
<span class="w">              </span><span class="n">AxisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Red</span>
<span class="w">              </span><span class="n">ChildColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Right</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>
</code></pre></div>
<p>「ぷよペアの構造が TypeScript 版と違いますね？」そうです！Elmish.WPF 版では、ぷよペアを以下のレコード型で表現しています：</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">AxisPosition</span><span class="o">:</span><span class="w"> </span><span class="n">Position</span><span class="w">    </span><span class="c1">// 軸ぷよの位置</span>
<span class="w">      </span><span class="n">ChildPosition</span><span class="o">:</span><span class="w"> </span><span class="n">Position</span><span class="w">   </span><span class="c1">// 子ぷよの位置</span>
<span class="w">      </span><span class="n">AxisColor</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w">      </span><span class="c1">// 軸ぷよの色</span>
<span class="w">      </span><span class="n">ChildColor</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="o">}</span><span class="w">   </span><span class="c1">// 子ぷよの色</span>
</code></pre></div>
<p>これにより、2つのぷよの位置と色を明示的に管理できます。</p>
<h3 id="_31">実装: 移動ロジック<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。まず、移動方向を表す型と移動ロジックを実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.Domain/GameLogic.fs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="n">Domain</span>

<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.PuyoPair</span>

<span class="sd">/// 移動方向</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Direction</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span>

<span class="k">module</span><span class="w"> </span><span class="nn">GameLogic</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="sd">/// 指定位置が盤面内で空かチェック</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">isValidPosition</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pos</span><span class="o">:</span><span class="w"> </span><span class="n">Position</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">pos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Rows</span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="o">.</span><span class="n">Cols</span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pos</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="n">pos</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Empty</span>

<span class="w">    </span><span class="sd">/// ぷよペアが配置可能かチェック</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">canPlacePuyoPair</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">isValidPosition</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isValidPosition</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span>

<span class="w">    </span><span class="sd">/// ぷよペアを指定方向に移動（可能な場合のみ）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">tryMovePuyoPair</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">direction</span><span class="o">:</span><span class="w"> </span><span class="n">Direction</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="o">.</span><span class="n">X</span>
<span class="w">                      </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="o">.</span><span class="n">X</span>
<span class="w">                      </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">None</span>
</code></pre></div>
<p>「<code>tryMovePuyoPair</code> が <code>option</code> 型を返しているのはなぜですか？」良い質問ですね！移動できる場合は <code>Some newPair</code> を返し、移動できない場合（壁や障害物がある）は <code>None</code> を返します。これにより、呼び出し側で移動の成功/失敗を安全に判定できます。</p>
<p>「<code>Position</code> を使っているのはどうしてですか？」Elmish.WPF 版では、座標を以下のレコード型で表現しています：</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>タプル <code>(int * int)</code> ではなく、名前付きレコードを使うことで、X と Y を明示的に区別でき、コードの可読性が向上します。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="update_2">Update 関数の拡張<a class="headerlink" href="#update_2" title="Permanent link">&para;</a></h3>
<p>「ドメインロジックができたので、次は Elmish の Update 関数を拡張しましょう！」はい、MoveLeft と MoveRight メッセージを処理できるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（updateWithRandom 関数の続き）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>「Bolero 版と何が違いますか？」重要な違いがあります！</p>
<p><strong>Bolero 版との違い</strong>:
- <strong>Bolero</strong>: <code>Model * Cmd&lt;Message&gt;</code> のタプルを返す
- <strong>Elmish.WPF</strong>: <code>Model</code> のみを返す</p>
<p>Elmish.WPF では、<code>Cmd</code> は <code>init</code> 関数で使用され、<code>update</code> 関数は新しい <code>Model</code> だけを返します。これは Elmish.WPF が WPF の UI スレッドと統合するための設計です。</p>
<p>「パターンマッチングを使って、安全に処理しているんですね！」そうです！以下の点をチェックしています：</p>
<ol>
<li><code>match model.CurrentPair</code>：現在のぷよペアが存在するか</li>
<li><code>match tryMovePuyoPair</code>：移動が成功したか</li>
</ol>
<p>すべての条件が満たされた場合のみ、新しい位置で Model を更新します。ゲーム状態のチェック（Playing かどうか）は、この時点ではまだ実装していません（イテレーション 3 で追加します）。</p>
<h3 id="view">View の拡張<a class="headerlink" href="#view" title="Permanent link">&para;</a></h3>
<p>「次は View でキーボード入力を受け取るようにしましょう！」はい、Elmish.WPF では XAML と F# の両方を更新します。</p>
<p>まず、F# 側で Message コマンドをバインディングします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（bindings 関数の更新）</span>
<span class="k">module</span><span class="w"> </span><span class="nn">GameView</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;Score&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Score</span><span class="o">)</span>
<span class="w">          </span><span class="s">&quot;Chain&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>
<span class="w">          </span><span class="s">&quot;Puyos&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getAllPuyos</span><span class="w"> </span><span class="n">m</span><span class="o">)</span>
<span class="w">          </span><span class="s">&quot;StartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">StartGame</span><span class="o">)</span>
<span class="w">          </span><span class="s">&quot;CanStartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="o">)</span>
<span class="w">          </span><span class="c1">// 左右移動コマンドを追加</span>
<span class="w">          </span><span class="s">&quot;MoveLeft&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveLeft</span><span class="o">)</span>
<span class="w">          </span><span class="s">&quot;MoveRight&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveRight</span><span class="o">)</span><span class="w"> </span><span class="o">]</span>
</code></pre></div>
<p>次に、XAML 側でキーバインディングを設定します：</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- src/PuyoPuyo.App/MainWindow.xaml --&gt;</span>
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyo.App.MainWindow&quot;</span>
<span class="w">        </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよゲーム&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;600&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- キーボード入力バインディング --&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.InputBindings&gt;</span>
<span class="w">        </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Left&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding MoveLeft}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Right&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding MoveRight}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.InputBindings&gt;</span>

<span class="w">    </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- ... 既存の UI 定義 ... --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>「Bolero 版と大きく違いますね！」そうです！重要な違いを説明します：</p>
<p><strong>Bolero 版との違い</strong>:
- <strong>Bolero</strong>: <code>handleKeyDown</code> 関数で <code>KeyboardEventArgs</code> を処理
- <strong>Elmish.WPF</strong>: XAML の <code>KeyBinding</code> と <code>Binding.cmd</code> を使用</p>
<p>WPF では、キーボード入力を処理する標準的な方法として <code>InputBindings</code> を使います。これにより、以下の利点があります：</p>
<ol>
<li><strong>宣言的な定義</strong>: XAML でキーバインディングを明示的に定義</li>
<li><strong>WPF の標準機能</strong>: フォーカス管理が自動</li>
<li><strong>分離</strong>: UI 定義（XAML）とロジック（F#）の明確な分離</li>
</ol>
<p>「<code>tabindex</code> は不要なんですか？」はい、WPF では Window 全体がキーボード入力を受け取るため、HTML のような <code>tabindex</code> 設定は不要です。</p>
<h3 id="update_3">テスト: Update 関数の統合テスト<a class="headerlink" href="#update_3" title="Permanent link">&para;</a></h3>
<p>「Update 関数の動作もテストしたいです！」良いですね！Elmish の統合テストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.Elmish.UpdateTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">System</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Elmish.Model</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Elmish.Update</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.Domain.Puyo</span>

<span class="k">module</span><span class="w"> </span><span class="n">``ぷよの移動``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``MoveLeftメッセージでぷよペアが左に移動する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">initialPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">                            </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;CurrentPair should exist&quot;</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``MoveRightメッセージでぷよペアが右に移動する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">initialPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">                            </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">3</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;CurrentPair should exist&quot;</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``左端では左に移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">initialPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">                            </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">// 位置が変わらない</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;CurrentPair should exist&quot;</span>
</code></pre></div>
<p>「Bolero 版と何が違いますか？」重要な違いがあります！</p>
<p><strong>Bolero 版との違い</strong>:
- <strong>Bolero</strong>: <code>Update.update MoveLeft model</code> → <code>(newModel, _)</code> でタプル分解
- <strong>Elmish.WPF</strong>: <code>updateWithRandom random MoveLeft model</code> → <code>newModel</code> のみ</p>
<p>Elmish.WPF では、update 関数が <code>Cmd</code> を返さないため、タプル分解は不要です。また、<code>Random</code> インスタンスを渡す必要があります。</p>
<p>「Elmish 層のテストでは、Model の状態遷移を確認しているんですね！」そうです！これにより、以下の点を確認できます：</p>
<ol>
<li>メッセージを受け取ったときの正しい状態遷移</li>
<li>ぷよペアの位置の正確な更新</li>
<li>境界条件での動作（移動できない場合）</li>
</ol>
<h3 id="_32">動作確認<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、まずテストを実行します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>すべてのテストが通ることを確認したら、アプリケーションを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Run
</code></pre></div>
<p>ウィンドウが表示されたら、左右矢印キーを押すとぷよが左右に移動するはずです！WPF では、ウィンドウが自動的にキーボードフォーカスを持つため、特別な操作は不要です。</p>
<h3 id="_33">コミット<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commits の規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement puyo movement with keyboard input</span>

<span class="s2">- Add Direction type (Left, Right, Down)</span>
<span class="s2">- Add GameLogic module with tryMovePuyoPair function</span>
<span class="s2">- Add boundary checking (canPlacePuyoPair)</span>
<span class="s2">- Update Update.fs for MoveLeft/MoveRight messages</span>
<span class="s2">- Add KeyBinding in XAML for Left/Right arrow keys</span>
<span class="s2">- Add MoveLeft/MoveRight command bindings in GameView.fs</span>
<span class="s2">- Add unit tests for movement logic (4 tests)</span>
<span class="s2">- Add integration tests for Update function (3 tests)</span>
<span class="s2">- All tests passing&quot;</span>
</code></pre></div>
<h3 id="2_1">イテレーション 2 のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ドメイン層</strong></li>
<li><code>Direction</code> 判別共用体（Left, Right, Down）</li>
<li>
<p><code>GameLogic</code> モジュール：</p>
<ul>
<li><code>isValidPosition</code>：位置の有効性チェック（Position レコード使用）</li>
<li><code>canPlacePuyoPair</code>：ぷよペアの配置可能性チェック</li>
<li><code>tryMovePuyoPair</code>：移動試行（Option 型を返す）</li>
</ul>
</li>
<li>
<p><strong>Elmish 層</strong></p>
</li>
<li><code>MoveLeft</code> / <code>MoveRight</code> メッセージの処理</li>
<li>パターンマッチによる安全な状態遷移</li>
<li>
<p><code>updateWithRandom</code> 関数で Model のみを返す（Cmd なし）</p>
</li>
<li>
<p><strong>View 層</strong></p>
</li>
<li>XAML の <code>Window.InputBindings</code> でキーバインディング定義</li>
<li><code>Binding.cmd</code> で MoveLeft/MoveRight コマンド公開</li>
<li>
<p>WPF の標準的なキーボード入力処理</p>
</li>
<li>
<p><strong>テスト</strong></p>
</li>
<li>ドメインロジックのテスト（4 テスト）<ul>
<li>左右移動の成功ケース</li>
<li>境界でのエラーケース</li>
</ul>
</li>
<li>
<p>Elmish 統合テスト（3 テスト）</p>
<ul>
<li>メッセージによる状態遷移</li>
<li><code>updateWithRandom</code> の動作確認</li>
<li>タプル分解不要（Model のみ返す）</li>
</ul>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>Option 型による安全なエラーハンドリング</li>
<li>関数型プログラミングの純粋関数（副作用なし）</li>
<li>Elmish における関心の分離（Domain/Elmish/View）</li>
<li>パターンマッチングによる網羅的な処理</li>
<li>Position レコードによる座標の表現（タプルより明示的）</li>
<li>
<p>WPF の InputBindings による宣言的なキーバインディング</p>
</li>
<li>
<p><strong>Bolero 版との違い</strong></p>
</li>
<li><strong>Update 関数</strong>: <code>Model * Cmd&lt;Message&gt;</code> ではなく <code>Model</code> のみを返す</li>
<li><strong>キー入力</strong>: <code>handleKeyDown</code> 関数ではなく XAML の <code>KeyBinding</code> を使用</li>
<li><strong>フォーカス</strong>: <code>tabindex</code> 不要（Window が自動的にフォーカスを持つ）</li>
<li><strong>テスト</strong>: タプル分解 <code>(newModel, _)</code> が不要</li>
<li>
<p><strong>座標</strong>: タプル <code>(int * int)</code> ではなく Position レコード <code>{ X: int; Y: int }</code> を使用</p>
</li>
<li>
<p><strong>WPF 固有の利点</strong></p>
</li>
<li>宣言的な UI 定義（XAML）とロジック（F#）の明確な分離</li>
<li>WPF の標準機能を活用（InputBindings、Command パターン）</li>
<li>キーボードフォーカスの自動管理</li>
</ol>
<p>次のイテレーションでは、ぷよの回転機能を実装していきます。</p>
<h2 id="3">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_34">ユーザーストーリー<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、この2つのぷよの相対的な位置関係を変えることです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> ぷよの回転処理を実装する（時計回り）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 回転可能かどうかのチェックを実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 壁キック処理を実装する（壁際での回転を可能にする）</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update関数に回転処理を組み込む</li>
<li class="task-list-item"><input type="checkbox" disabled/> View にキー入力を追加する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_35">テスト: ぷよの回転<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは基本的な回転機能のテストから書いていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/PuyoPairTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``時計回りに回転すると回転状態が1増える``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転状態3から時計回りに回転すると0に戻る``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">3</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転すると2つ目のぷよの位置が変わる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 回転状態0（上）</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span><span class="w">  </span><span class="c1">// 回転状態1（右）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">rotated</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">pos1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 軸ぷよは変わらない</span>
<span class="w">    </span><span class="n">pos2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2つ目のぷよは右に</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下の点を確認しています：</p>
<ol>
<li>時計回りに回転すると、回転状態が1増えるか</li>
<li>回転状態が最大値（3）から回転すると、0に戻るか（循環するか）</li>
<li>回転によって2つ目のぷよの位置が正しく変わるか</li>
</ol>
<p>「回転状態って何ですか？」回転状態は、ぷよの向きを表す値です。0から3までの値を取り、それぞれ以下の状態を表します：
- 0: 2つ目のぷよが上にある状態
- 1: 2つ目のぷよが右にある状態
- 2: 2つ目のぷよが下にある状態
- 3: 2つ目のぷよが左にある状態</p>
<h3 id="_36">実装: ぷよの回転<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよを回転させる機能を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/PuyoPair.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// 時計回りに回転</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotateClockwise</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="sd">/// 反時計回りに回転</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotateCounterClockwise</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>「シンプルですね！」そうです！回転処理自体はとてもシンプルです。<code>rotateClockwise</code>では回転状態を1増やし、<code>rotateCounterClockwise</code>では回転状態を3増やしています（これは1減らすのと同じ効果があります）。</p>
<p>「なぜ反時計回りの場合は3を足すんですか？」鋭い質問ですね！F#でも、負の数の剰余演算の結果が負になることがあります。例えば、<code>(0 - 1) % 4</code>は<code>-1</code>になります。しかし、私たちは常に0から3の範囲の値が欲しいので、3を足して（これは1を引くのと同じ効果）から4で割ることで、確実に正の値の範囲内に収めています。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="_37">テスト: 壁キック処理<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>「壁キック処理のテストはどうやって書くんですか？」壁キック処理は、ぷよが壁際にあるときに回転すると自動的に位置を調整する機能です。これをテストするには、ぷよを壁際に配置し、回転させたときに適切に位置が調整されるかを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/GameLogicTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``右端で回転すると左にキックされる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 右端、回転状態0（上）</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">rotated</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 回転成功</span>
<span class="w">        </span><span class="n">rotated</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="c1">// 左に1マスキック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;回転できるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``左端で回転すると右にキックされる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 左端、回転状態0（上）</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">}</span><span class="w">  </span><span class="c1">// 左向き</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">rotated</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">kicked</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">kicked</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 右に1マスキック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;回転できるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``壁キックできない場合は回転しない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="c1">// 右端にぷよを配置（壁キックできない状況を作る）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li>右端にいるときに回転すると、左に1マス移動して回転するか</li>
<li>左端にいるときに回転すると、右に1マス移動して回転するか</li>
<li>壁キックもできない場合は、回転が失敗するか</li>
</ol>
<h3 id="_38">実装: 壁キック処理<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、壁キック処理を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/GameLogic.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">GameLogic</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// ぷよペアを回転（壁キック処理付き）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">tryRotatePuyoPair</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// 通常回転を試す</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">rotateClockwise</span><span class="w"> </span><span class="n">pair</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">Some</span><span class="w"> </span><span class="n">rotated</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// 壁キックを試す（左に1マス）</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">kickedLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotated</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">kickedLeft</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="n">Some</span><span class="w"> </span><span class="n">kickedLeft</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">// 壁キックを試す（右に1マス）</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">kickedRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">rotated</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotated</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">kickedRight</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="n">Some</span><span class="w"> </span><span class="n">kickedRight</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// 回転できない</span>
<span class="w">                    </span><span class="n">None</span>
</code></pre></div>
<p>「段階的にチェックしているんですね！」そうです！この実装では、以下のことを行っています：</p>
<ol>
<li>まず通常の回転を試す</li>
<li>配置できない場合、左に1マスずらして（壁キック）試す</li>
<li>それでもダメなら右に1マスずらして試す</li>
<li>すべて失敗したら<code>None</code>を返す</li>
</ol>
<p>「F#のパイプライン演算子を使うともっと綺麗に書けませんか？」良い質問ですね！確かに、関数型のスタイルで書き直すこともできます。でも、今回は可読性を優先して、段階的なチェックを明示的に書いています。</p>
<h3 id="update_4">Update 関数の拡張<a class="headerlink" href="#update_4" title="Permanent link">&para;</a></h3>
<p>「ドメインロジックができたので、次は Elmish の Update 関数を拡張しましょう！」はい、Rotate メッセージを処理できるようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（updateWithRandom の Rotate 処理）</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>「シンプルですね！」そうです！以下の処理を行っています：</p>
<ol>
<li>現在のぷよペアが存在するか確認</li>
<li><code>tryRotatePuyoPair</code> で回転を試みる（壁キック処理含む）</li>
<li>成功したら新しい回転状態のペアでモデルを更新</li>
<li>失敗したら現在のモデルをそのまま返す</li>
</ol>
<p><strong>Elmish.WPF 版の特徴</strong>:
- <code>Cmd</code> を返さず、<code>Model</code> のみを返す
- <code>when model.GameState = Playing</code> のような条件は不要（シンプルな実装）</p>
<h3 id="view_1">View の拡張<a class="headerlink" href="#view_1" title="Permanent link">&para;</a></h3>
<p>「次は View でキーボード入力を受け取るようにしましょう！」はい、上矢印キーで回転できるようにします。</p>
<p>Elmish.WPF では、XAML の <code>KeyBinding</code> と F# の <code>Binding.cmd</code> を組み合わせて使います。</p>
<p>まず、GameView.fs に Rotate コマンドのバインディングを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（bindingsの更新）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;Score&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Score</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Chain&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Puyos&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getAllPuyos</span><span class="w"> </span><span class="n">m</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;StartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">StartGame</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;CanStartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveLeft&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveLeft</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveRight&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveRight</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveDown&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveDown</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Rotate&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Rotate</span><span class="o">)</span><span class="w"> </span><span class="o">]</span><span class="w">  </span><span class="c1">// 追加</span>
</code></pre></div>
<p>次に、XAML でキーバインディングを定義します：</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- src/PuyoPuyo.App/MainWindow.xaml --&gt;</span>
<span class="nt">&lt;Window.InputBindings&gt;</span>
<span class="w">    </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Left&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding MoveLeft}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Right&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding MoveRight}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Down&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding MoveDown}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Up&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding Rotate}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- 追加 --&gt;</span>
<span class="nt">&lt;/Window.InputBindings&gt;</span>
</code></pre></div>
<p>「Bolero 版と何が違うんですか？」いくつか大きな違いがあります：</p>
<ol>
<li><strong>キーバインディングの定義場所</strong>:</li>
<li>Bolero: JavaScript の <code>keydown</code> イベントハンドラ</li>
<li>
<p>Elmish.WPF: XAML の <code>KeyBinding</code> による宣言的定義</p>
</li>
<li>
<p><strong>コマンドの実行</strong>:</p>
</li>
<li>Bolero: <code>dispatch</code> 関数でメッセージを送信</li>
<li>
<p>Elmish.WPF: WPF のコマンドバインディングで自動的にメッセージが送信される</p>
</li>
<li>
<p><strong>コードの場所</strong>:</p>
</li>
<li>Bolero: すべて F# コード内</li>
<li>Elmish.WPF: XAML で UI 定義、F# でバインディング定義</li>
</ol>
<p>「なぜ XAML を使うんですか？」WPF の標準的な方法で、宣言的に UI を定義できます。また、デザイナーツールとの統合も容易になります。Elmish.WPF は WPF のエコシステムを活用しながら、Elmish アーキテクチャの利点を享受できます。</p>
<h3 id="update_5">テスト: Update関数の統合テスト<a class="headerlink" href="#update_5" title="Permanent link">&para;</a></h3>
<p>「Update関数の回転処理もテストしましょう！」はい、Elmishの統合テストを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``Rotateメッセージでぷよが回転する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転時に壁キックが発生する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 右端</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span><span class="w">  </span><span class="c1">// 左にキック</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``回転できない場合は状態が変わらない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Model</span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="o">;</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="o">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">newModel</span><span class="o">,</span><span class="w"> </span><span class="o">_)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Update</span><span class="p">.</span><span class="n">update</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="n">model</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 回転していない</span>
<span class="w">        </span><span class="n">newPair</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="c1">// 位置も変わらない</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;ぷよが存在するはずです&quot;</span>
</code></pre></div>
<p>「Bolero版と同じテストコードですね！」そうです！Update関数の実装がBoleroとElmish.WPFで同じため、テストコードも同じです。これは、Elmishアーキテクチャの優れた点の一つです。</p>
<p>「どういうことですか？」Elmishアーキテクチャでは、Update関数はプラットフォームに依存しないピュアな関数です。入力（Message, Model）に対して出力（Model, Cmd）を返すだけで、副作用がありません。このため、Web（Bolero）でもデスクトップ（Elmish.WPF）でも同じテストコードでテストできます。</p>
<p>プラットフォーム固有の違いは、View層にのみ現れます：
- <strong>Bolero</strong>: Blazorのコンポーネントとイベントハンドラ
- <strong>Elmish.WPF</strong>: WPFのコントロールとネイティブイベント</p>
<p>このように、ビジネスロジック（Domain + Update）とUI（View）を明確に分離することで、テスタビリティと移植性が向上します。</p>
<h3 id="_39">動作確認<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、WPFアプリケーションを起動します：</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>app/fsharp-2/wpf
dotnet<span class="w"> </span>run<span class="w"> </span>--project<span class="w"> </span>src/PuyoPuyo.WPF
</code></pre></div>
<p>または、テストを実行して動作を確認することもできます：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span><span class="w"> </span>tests/PuyoPuyo.Tests
</code></pre></div>
<p>アプリケーションが起動したら、「ゲーム開始」ボタンをクリックして、上矢印キーを押すとぷよが回転し、壁際では自動的に位置が調整されるはずです！</p>
<p>「Bolero版と違ってブラウザを開かないんですね！」そうです！Elmish.WPFはデスクトップアプリケーションなので、Windowsのネイティブウィンドウとして起動します。これにより、ブラウザを必要とせず、デスクトップアプリケーションとしての利点を活かせます。</p>
<h3 id="_40">コミット<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement puyo rotation with wall kick</span>

<span class="s2">- Add rotateClockwise and rotateCounterClockwise to PuyoPair</span>
<span class="s2">- Add tryRotatePuyoPair with wall kick logic in GameLogic</span>
<span class="s2">- Update Elmish Update function for Rotate message</span>
<span class="s2">- Add ArrowUp key handler for rotation</span>
<span class="s2">- Add unit tests for rotation logic (3 tests)</span>
<span class="s2">- Add unit tests for wall kick (3 tests)</span>
<span class="s2">- Add integration tests for Update function (3 tests)</span>
<span class="s2">- All tests passing (28 tests)&quot;</span>
</code></pre></div>
<h3 id="3_1">イテレーション3のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ドメイン層</strong></li>
<li><code>PuyoPair.rotateClockwise</code>：時計回り回転（回転状態を+1）</li>
<li><code>PuyoPair.rotateCounterClockwise</code>：反時計回り回転（回転状態を+3）</li>
<li><code>GameLogic.tryRotatePuyoPair</code>：回転試行（壁キック処理付き）</li>
<li>
<p>壁キックロジック：左、右の順に1マスずらして配置可能性をチェック</p>
</li>
<li>
<p><strong>Elmish層</strong></p>
</li>
<li><code>Rotate</code> メッセージの処理</li>
<li>回転失敗時の状態維持</li>
<li>パターンマッチによる安全な処理</li>
<li>
<p><strong>Bolero版との共通点</strong>：Update関数の実装は完全に同じ</p>
</li>
<li>
<p><strong>View層（Elmish.WPF固有）</strong></p>
</li>
<li>WPFの<code>KeyEventArgs</code>を使用したキーボードイベント処理</li>
<li><code>Key.Up</code>列挙型による型安全なキー判定</li>
<li><code>updateModelAndUI</code>による直接的なモデル更新とUI再描画</li>
<li>F#コードによるWindowの作成とイベントハンドラの設定</li>
<li>
<p><strong>Bolero版との違い</strong>：</p>
<ul>
<li>Blazorのイベントハンドラ → WPFネイティブイベント</li>
<li><code>"ArrowUp"</code>文字列 → <code>Key.Up</code>列挙型</li>
<li><code>dispatch</code>関数 → <code>updateModelAndUI</code>関数</li>
</ul>
</li>
<li>
<p><strong>テスト</strong></p>
</li>
<li>回転ロジックの単体テスト（3テスト）<ul>
<li>通常回転</li>
<li>回転状態の循環</li>
<li>位置の変化</li>
</ul>
</li>
<li>壁キックのテスト（3テスト）<ul>
<li>右端での左キック</li>
<li>左端での右キック</li>
<li>キック不可の場合</li>
</ul>
</li>
<li>Elmish統合テスト（3テスト）<ul>
<li>通常回転</li>
<li>壁キック発生</li>
<li>回転失敗</li>
</ul>
</li>
<li>
<p><strong>Bolero版との共通点</strong>：テストコードは完全に同じ（プラットフォーム非依存）</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>剰余演算による循環処理（<code>(n + k) % m</code>）</li>
<li>段階的なフォールバック処理（通常→左キック→右キック）</li>
<li>Option型による連続的な試行</li>
<li>イミュータブルなレコード更新（<code>{ pair with ... }</code>）</li>
<li>
<p><strong>Elmishアーキテクチャの利点</strong>：</p>
<ul>
<li>Update関数のプラットフォーム非依存性</li>
<li>テストコードの再利用性</li>
<li>ビジネスロジックとUIの明確な分離</li>
</ul>
</li>
<li>
<p><strong>壁キック処理の工夫</strong></p>
</li>
<li>まず通常回転を試す</li>
<li>失敗したら左に1マスずらす</li>
<li>さらに失敗したら右に1マスずらす</li>
<li>すべて失敗したら<code>None</code>を返す</li>
<li>
<p>これにより、プレイヤーの意図を最大限尊重</p>
</li>
<li>
<p><strong>TypeScript版との違い</strong></p>
</li>
<li>壁キック処理を<code>tryRotatePuyoPair</code>に統合</li>
<li>Option型による段階的な試行</li>
<li>
<p>重複コードなし（関数型のコンポジション）</p>
</li>
<li>
<p><strong>Bolero版（Web）とElmish.WPF版（Desktop）の比較</strong></p>
</li>
</ol>
<p><strong>共通部分（プラットフォーム非依存）</strong>：
   - Domain層：完全に同じ実装
   - Elmish層（Model, Message, Update）：完全に同じ実装
   - テストコード：完全に同じコードで動作</p>
<p><strong>異なる部分（プラットフォーム固有）</strong>：
   - View層のイベント処理：
     - Bolero: Blazorの<code>KeyboardEventArgs</code>, <code>"ArrowUp"</code>文字列, <code>dispatch</code>関数
     - Elmish.WPF: WPFの<code>KeyEventArgs</code>, <code>Key.Up</code>列挙型, <code>updateModelAndUI</code>関数
   - UI構築方法：
     - Bolero: HTMLライクなBolero DSL
     - Elmish.WPF: F#コードによるWPFコントロール生成
   - 実行環境：
     - Bolero: ブラウザ上で実行
     - Elmish.WPF: Windowsネイティブアプリとして実行</p>
<p>この構造により、ビジネスロジックを一度実装すれば、WebとDesktopの両方で動作するアプリケーションを効率的に開発できます。</p>
<p>次のイテレーションでは、ぷよの自由落下機能を実装していきます。</p>
<h2 id="4">イテレーション4: ぷよの自由落下の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよって自動で落ちていくよね？」そうですね！ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきます。今回は、その「自由落下」機能を実装していきましょう！</p>
<h3 id="_41">ユーザーストーリー<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとしてぷよを自由落下させることができる</p>
</blockquote>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> 自動落下のタイマーメッセージを追加する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 落下可能判定を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> 着地処理を実装する（ぷよをボードに固定）</li>
<li class="task-list-item"><input type="checkbox" disabled/> 新しいぷよを生成する処理を実装する</li>
<li class="task-list-item"><input type="checkbox" disabled/> タイマーを使った定期的な落下処理を組み込む</li>
<li class="task-list-item"><input type="checkbox" disabled/> 各機能に対応するテストを作成する</li>
</ul>
<h3 id="_42">テスト: 落下可能判定<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>「最初は何からテストしますか？」まずは、ぷよが下に移動できるかを判定する機能からテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/GameLogicTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを下に移動できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">movedPair</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;下に移動できるはずです&quot;</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``下端では下に移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 回転状態0（上）なので2つ目のぷよは y=10</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``下にぷよがある場合は移動できない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Blue</span><span class="o">)</span><span class="w">  </span><span class="c1">// 下に障害物</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">None</span>
</code></pre></div>
<p>「これらのテストは既に<code>tryMovePuyoPair</code>で実装済みですね！」そうです！イテレーション2で<code>Direction.Down</code>を定義していたので、下方向の移動も既に対応済みです。テストを実行して確認しましょう。</p>
<h3 id="_43">テスト: ぷよの固定<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>「次はぷよをボードに固定する処理をテストしましょう！」はい、ぷよが着地したときの処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアをボードに固定できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x1</span><span class="o">,</span><span class="w"> </span><span class="n">y1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x2</span><span class="o">,</span><span class="w"> </span><span class="n">y2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Green</span><span class="o">)</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアを固定しても元のボードは変更されない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x1</span><span class="o">,</span><span class="w"> </span><span class="n">y1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span><span class="w">  </span><span class="c1">// 元のボードは空のまま</span>
<span class="w">    </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span><span class="w">  </span><span class="c1">// 新しいボードには固定</span>
</code></pre></div>
<p>「イミュータブルなデータ構造のテストですね！」そうです！F#では、<code>fixPuyoPair</code>は新しいボードを返し、元のボードは変更されません。</p>
<h3 id="_44">実装: ぷよの固定<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// ぷよペアをボードに固定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">fixPuyoPair</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">pair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">pair</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x1</span><span class="o">,</span><span class="w"> </span><span class="n">y1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">x2</span><span class="o">,</span><span class="w"> </span><span class="n">y2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>

<span class="w">        </span><span class="n">board</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCell</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Puyo1Color</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCell</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">pair</span><span class="o">.</span><span class="n">Puyo2Color</span><span class="o">)</span>
</code></pre></div>
<p>「パイプライン演算子を使って連鎖的に処理していますね！」そうです！<code>board</code>に対して、まず1つ目のぷよを配置し、その結果に対して2つ目のぷよを配置しています。これが関数型プログラミングのスタイルです。</p>
<p>テストを実行して、すべて通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<h3 id="elmish-subscription">Elmish Subscription によるタイマー<a class="headerlink" href="#elmish-subscription" title="Permanent link">&para;</a></h3>
<p>「自動落下のタイマーはどうやって実装しますか？」Elmishでは、Subscriptionという仕組みを使ってタイマーを実装します。</p>
<p>まず、タイマーメッセージを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Model.fs（Messageの追加）</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>
</code></pre></div>
<p>次に、Subscriptionを定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Subscription.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Elmish.Subscription</span>

<span class="k">open</span><span class="w"> </span><span class="nn">System</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.GameLogic</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Model</span>

<span class="c1">// タイマーサブスクリプション（ゲームループ）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">timerSubscription</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Cmd</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">sub</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="nn">Timers</span><span class="p">.</span><span class="n">Timer</span><span class="o">(</span><span class="mi">500</span><span class="o">.</span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="c1">// 500ms間隔</span>
<span class="w">        </span><span class="n">timer</span><span class="o">.</span><span class="n">AutoReset</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">true</span>
<span class="w">        </span><span class="n">timer</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Tick</span><span class="o">)</span>
<span class="w">        </span><span class="n">timer</span><span class="o">.</span><span class="n">Start</span><span class="bp">()</span>

<span class="w">    </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">ofSub</span><span class="w"> </span><span class="n">sub</span>
</code></pre></div>
<p><strong>Elmish.WPF 版と Bolero 版の違い</strong>:</p>
<ol>
<li><strong>タイマーの実装</strong>:</li>
<li>Elmish.WPF: <code>System.Timers.Timer</code> を使用</li>
<li>
<p>Bolero: <code>requestAnimationFrame</code> や <code>DispatcherTimer</code> を使用</p>
</li>
<li>
<p><strong>戻り値の型</strong>:</p>
</li>
<li>Elmish.WPF: <code>Cmd&lt;Message&gt;</code> を返す</li>
<li>
<p>Bolero: <code>Sub&lt;Message&gt;</code> を返す（タプル形式 <code>[["id"], sub]</code>）</p>
</li>
<li>
<p><strong>リソース管理</strong>:</p>
</li>
<li>Elmish.WPF: 明示的な <code>IDisposable</code> 実装は不要（<code>Cmd.ofSub</code> が管理）</li>
<li>Bolero: <code>IDisposable</code> を明示的に実装</li>
</ol>
<p>「Subscriptionって何ですか？」良い質問ですね！Subscriptionは、外部のイベント（タイマー、WebSocket、キーボードなど）をElmishのメッセージに変換する仕組みです。WPF 版では <code>System.Timers.Timer</code> を使って、定期的に <code>Tick</code> メッセージを発行します。</p>
<h3 id="update_6">Update 関数の拡張<a class="headerlink" href="#update_6" title="Permanent link">&para;</a></h3>
<p>「Tickメッセージを受け取ったときの処理を実装しましょう！」はい、自動落下のロジックを追加します。</p>
<p>まず、ぷよを下に落とす共通処理を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs</span>

<span class="c1">// ぷよを下に移動させる（共通処理）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 下に移動を試みる</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できた場合</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できない場合、ぷよを固定して新しいぷよを生成</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newBoard</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>次に、Update 関数で <code>Tick</code> メッセージを処理します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ランダム生成器を受け取る更新関数（テスト用）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">updateWithRandom</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span><span class="o">)</span>
<span class="w">            </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">model</span>

<span class="c1">// 更新関数（Elmish用）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="bp">()</span>
<span class="w">    </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p><strong>Elmish.WPF 版と Bolero 版の違い</strong>:</p>
<ol>
<li><strong>戻り値の型</strong>:</li>
<li>Elmish.WPF: <code>Model</code> のみを返す（Cmd は使用しない）</li>
<li>
<p>Bolero: <code>Model * Cmd&lt;Message&gt;</code> のタプルを返す</p>
</li>
<li>
<p><strong>共通処理の抽出</strong>:</p>
</li>
<li>
<p><code>dropPuyo</code> 関数で <code>Tick</code> と <code>MoveDown</code> の共通処理を実装</p>
</li>
<li>
<p><strong>テスト容易性</strong>:</p>
</li>
<li><code>updateWithRandom</code> でランダム生成器を外部から注入可能</li>
</ol>
<p>「着地したら新しいぷよを生成するんですね！」そうです！以下の処理を行っています：</p>
<ol>
<li>下に移動できるか試す</li>
<li>移動できたら新しい位置に更新</li>
<li>移動できない（着地）場合：</li>
<li>現在のぷよをボードに固定</li>
<li>新しいぷよを生成</li>
<li>Modelを更新</li>
</ol>
<h3 id="update_7">テスト: Update関数の統合テスト<a class="headerlink" href="#update_7" title="Permanent link">&para;</a></h3>
<p>「Update関数の自動落下処理もテストしましょう！」はい、統合テストを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="n">``ゲームループ``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``Tickメッセージでぷよペアが下に移動する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">initialPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">                            </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">6</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;CurrentPair should exist&quot;</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``Tickメッセージで下に移動できない場合はぷよが固定される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">initialPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">}</span>
<span class="w">                            </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="c1">// ぷよが固定されてボードに配置される</span>
<span class="w">        </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">initialPair</span><span class="o">.</span><span class="n">Axis</span>

<span class="w">        </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">initialPair</span><span class="o">.</span><span class="n">Child</span>

<span class="w">        </span><span class="c1">// 新しいぷよペアが生成される</span>
<span class="w">        </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="ow">not</span><span class="k">&#39;</span><span class="w"> </span><span class="o">(</span><span class="n">equal</span><span class="w"> </span><span class="n">None</span><span class="o">)</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``Tickメッセージでぷよ固定後に新しいぷよが生成される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">initialPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">}</span>
<span class="w">                            </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 初期位置に配置される</span>
<span class="w">            </span><span class="n">newPair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">2</span>
<span class="w">            </span><span class="n">newPair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;新しいぷよペアが生成されるべきです&quot;</span>
</code></pre></div>
<p><strong>Elmish.WPF 版と Bolero 版の違い</strong>:</p>
<ol>
<li><strong>Update 関数の呼び出し</strong>:</li>
<li>Elmish.WPF: <code>updateWithRandom random Tick model</code> → <code>newModel</code></li>
<li>
<p>Bolero: <code>Update.update Tick model</code> → <code>(newModel, _)</code></p>
</li>
<li>
<p><strong>戻り値の処理</strong>:</p>
</li>
<li>Elmish.WPF: タプル分解不要（Model のみ返る）</li>
<li>
<p>Bolero: タプルから Model を取り出す <code>(newModel, _)</code></p>
</li>
<li>
<p><strong>テストの明確性</strong>:</p>
</li>
<li><code>updateWithRandom</code> を使うことでランダム性を制御可能</li>
</ol>
<h3 id="program">Program の設定<a class="headerlink" href="#program" title="Permanent link">&para;</a></h3>
<p>「Subscriptionを使うには、Programの設定が必要ですね！」そうです！メインのエントリーポイントでSubscriptionを登録します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Program.fs</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Program</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Elmish</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.WPF</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Model</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Update</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Subscription</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Components.GameView</span>

<span class="k">let</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="n">window</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">ElmConfig</span><span class="p">.</span><span class="n">Default</span>

<span class="w">    </span><span class="nn">Program</span><span class="p">.</span><span class="n">mkProgram</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">bindings</span><span class="w"> </span><span class="bp">()</span><span class="o">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">withSubscription</span><span class="w"> </span><span class="n">timerSubscription</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">withConsoleTrace</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Program</span><span class="p">.</span><span class="n">startElmishLoop</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="n">window</span>
</code></pre></div>
<p><strong>Elmish.WPF 版と Bolero 版の違い</strong>:</p>
<ol>
<li><strong>Program の構築</strong>:</li>
<li>Elmish.WPF: <code>Program.mkProgram</code> に <code>(fun () -&gt; init(), Cmd.none)</code> を直接渡す</li>
<li>
<p>Bolero: <code>Program.mkProgram init update view</code> のように関数を渡す</p>
</li>
<li>
<p><strong>実行方法</strong>:</p>
</li>
<li>Elmish.WPF: <code>Program.startElmishLoop config window</code></li>
<li>
<p>Bolero: <code>Program.withHost</code> で Blazor のホストに統合</p>
</li>
<li>
<p><strong>デバッグ機能</strong>:</p>
</li>
<li><code>Program.withConsoleTrace</code> でコンソールに状態遷移をログ出力可能</li>
</ol>
<p>「<code>Program.withSubscription</code>でタイマーを登録するんですね！」そうです！これにより、タイマーが定期的に<code>Tick</code>メッセージを発行し、ぷよの自動落下を実現します。</p>
<h3 id="_45">動作確認<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、アプリケーションを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Run
</code></pre></div>
<p>WPF アプリケーションが起動し、「スタート」ボタンをクリックすると、ぷよが自動的に 500ms 間隔で落下し、着地すると新しいぷよが生成されるはずです！</p>
<p>コンソールに <code>Program.withConsoleTrace</code> によって状態遷移のログが出力されるので、動作を確認できます。</p>
<h3 id="_46">コミット<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement auto-falling puyo with gravity</span>

<span class="s2">- Add dropPuyo function for common drop logic</span>
<span class="s2">- Add Tick message for timer events</span>
<span class="s2">- Add Subscription module with System.Timers.Timer</span>
<span class="s2">- Update Elmish Update function for Tick message</span>
<span class="s2">- Auto-generate new puyo when current puyo lands</span>
<span class="s2">- Add integration tests for Tick handling (3 tests)</span>
<span class="s2">- All tests passing&quot;</span>
</code></pre></div>
<h3 id="4_1">イテレーション4のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ドメイン層</strong></li>
<li>既に実装済みの <code>tryMovePuyoPair</code> で下方向の移動に対応</li>
<li><code>fixPuyoPair</code> でぷよペアをボードに固定（イミュータブル）</li>
<li>
<p>パイプライン演算子による連鎖的な処理</p>
</li>
<li>
<p><strong>Elmish層</strong></p>
</li>
<li><code>Tick</code> メッセージ：タイマーイベント</li>
<li><code>dropPuyo</code> 関数：<code>Tick</code> と <code>MoveDown</code> の共通処理</li>
<li>自動落下ロジック：<ul>
<li>下に移動を試みる</li>
<li>移動できたら位置を更新</li>
<li>着地したらボードに固定し新しいぷよを生成</li>
</ul>
</li>
<li>
<p>Subscription：<code>System.Timers.Timer</code> によるタイマーの実装</p>
</li>
<li>
<p><strong>Program設定</strong></p>
</li>
<li><code>Program.withSubscription</code> でタイマーを登録</li>
<li><code>Program.withConsoleTrace</code> でデバッグログを出力</li>
<li>
<p><code>Program.startElmishLoop</code> で WPF アプリに統合</p>
</li>
<li>
<p><strong>テスト</strong></p>
</li>
<li>自動落下の統合テスト（3テスト）<ul>
<li>通常の落下</li>
<li>着地と新ぷよ生成</li>
<li>新ぷよの初期位置確認</li>
</ul>
</li>
<li>
<p><code>updateWithRandom</code> によるテスト容易性の向上</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>Elmish Subscription：外部イベントの統合</li>
<li><code>System.Timers.Timer</code>：WPF でのタイマー実装</li>
<li><code>Cmd.ofSub</code>：サブスクリプションの登録</li>
<li>パイプライン演算子による関数合成</li>
<li>
<p>タイマーのライフサイクル管理</p>
</li>
<li>
<p><strong>Elmish.WPF と Bolero の違い</strong></p>
</li>
<li><strong>Subscription の定義</strong>:<ul>
<li>Elmish.WPF: <code>Cmd&lt;Message&gt;</code> を返す、<code>Cmd.ofSub</code> を使用</li>
<li>Bolero: <code>Sub&lt;Message&gt;</code> を返す、タプル形式</li>
</ul>
</li>
<li><strong>Update 関数の戻り値</strong>:<ul>
<li>Elmish.WPF: <code>Model</code> のみ（Cmd は使用しない）</li>
<li>Bolero: <code>Model * Cmd&lt;Message&gt;</code> のタプル</li>
</ul>
</li>
<li><strong>タイマーの実装</strong>:<ul>
<li>Elmish.WPF: <code>System.Timers.Timer</code></li>
<li>Bolero: <code>requestAnimationFrame</code> や <code>DispatcherTimer</code></li>
</ul>
</li>
<li>
<p><strong>Program の構築</strong>:</p>
<ul>
<li>Elmish.WPF: <code>Program.startElmishLoop</code></li>
<li>Bolero: <code>Program.withHost</code></li>
</ul>
</li>
<li>
<p><strong>WPF 版の利点</strong></p>
</li>
<li>デスクトップアプリケーションとしてのネイティブな動作</li>
<li><code>System.Timers.Timer</code> による正確なタイミング制御</li>
<li><code>Program.withConsoleTrace</code> による簡単なデバッグ</li>
<li>Elmish アーキテクチャの理解がしやすい（Cmd を使わないシンプルな実装）</li>
</ol>
<p>次のイテレーションでは、ぷよの高速落下機能（<code>MoveDown</code> メッセージ）を実装していきます。</p>
<h2 id="5">イテレーション5: ぷよの高速落下の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「自動で落ちるようになったけど、もっと速く落としたいときもあるよね？」そうですね！ぷよぷよでは、下矢印キーを押すとぷよが速く落ちるようになります。今回は、その「高速落下」機能を実装していきましょう！</p>
<h3 id="_47">ユーザーストーリー<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、下キーを押している間、ぷよを高速で落下させることができる</p>
</blockquote>
<p>「高速落下って具体的にどういう動きですか？」良い質問ですね！下矢印キーを押している間は、通常よりも速い間隔でぷよが落ちていきます。キーを離すと、通常の速度に戻ります。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> 下矢印キーの入力を検出する（XAML KeyBinding）</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> MoveDownメッセージを処理する</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 落下処理を共通化する（dropPuyo 関数）</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> 各機能に対応するテストを作成する</li>
</ul>
<p>WPF 版では、以下は不要です：
- ~~高速落下用のタイマーを実装する~~（WPF のキーリピート機能を使用）
- ~~通常タイマーと高速タイマーを切り替える~~（状態管理不要）</p>
<h3 id="_48">テスト: 下方向への移動<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>「下方向への移動は既に実装済みですよね？」そうです！イテレーション2で<code>tryMovePuyoPair</code>に<code>Direction.Down</code>を実装済みなので、基本的な機能は既にあります。念のため、テストを追加して確認しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="n">``ぷよの高速落下``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``MoveDownメッセージでぷよペアが下に移動する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">initialPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">                            </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">AxisPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">6</span>
<span class="w">            </span><span class="n">pair</span><span class="o">.</span><span class="n">ChildPosition</span><span class="o">.</span><span class="n">Y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;CurrentPair should exist&quot;</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``MoveDownメッセージで下端に到達した場合はぷよが固定される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">initialPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">initialPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">}</span>
<span class="w">                            </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="c1">// ぷよが固定されてボードに配置される</span>
<span class="w">        </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">initialPair</span><span class="o">.</span><span class="n">Axis</span>

<span class="w">        </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">initialPair</span><span class="o">.</span><span class="n">Child</span>

<span class="w">        </span><span class="c1">// 新しいぷよペアが生成される</span>
<span class="w">        </span><span class="n">newModel</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="ow">not</span><span class="k">&#39;</span><span class="w"> </span><span class="o">(</span><span class="n">equal</span><span class="w"> </span><span class="n">None</span><span class="o">)</span>
</code></pre></div>
<p>「Tickメッセージと同じ処理になりそうですね！」そうです！下に移動を試みて、着地したらボードに固定して新しいぷよを生成する、という処理は共通です。</p>
<h3 id="update_8">Update 関数の拡張<a class="headerlink" href="#update_8" title="Permanent link">&para;</a></h3>
<p>「MoveDownメッセージの処理を追加しましょう！」はい、Tickと同じロジックを使います。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（Update関数の続き）</span>

<span class="c1">// ランダム生成器を受け取る更新関数（テスト用）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">updateWithRandom</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span><span class="o">)</span>
<span class="w">            </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">model</span><span class="w">  </span><span class="c1">// Tick と同じ処理を使用</span>
</code></pre></div>
<p>「Tickメッセージの処理と全く同じですね！」そうです！重複していますね。後でリファクタリングして共通化することもできますが、今は動作を優先しましょう。</p>
<h3 id="view_2">View の拡張<a class="headerlink" href="#view_2" title="Permanent link">&para;</a></h3>
<p>「下矢印キーの入力を受け取るようにしましょう！」はい、Elmish.WPF では XAML の KeyBinding を使ってキー入力を処理します。</p>
<p>まず、GameView.fs に MoveDown コマンドのバインディングを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Components/GameView.fs（bindingsの更新）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;Score&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Score</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Chain&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">)</span><span class="w"> </span><span class="c1">// 連鎖数（将来実装予定）</span>
<span class="w">      </span><span class="s">&quot;Puyos&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getAllPuyos</span><span class="w"> </span><span class="n">m</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;StartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">StartGame</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;CanStartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveLeft&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveLeft</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveRight&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveRight</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveDown&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveDown</span><span class="o">)</span><span class="w">  </span><span class="c1">// 追加</span>
<span class="w">      </span><span class="s">&quot;Rotate&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Rotate</span><span class="o">)</span><span class="w"> </span><span class="o">]</span>
</code></pre></div>
<p>次に、XAML でキーバインディングを定義します：</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- src/PuyoPuyo.App/MainWindow.xaml --&gt;</span>
<span class="nt">&lt;Window</span>
<span class="w">    </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyo.App.MainWindow&quot;</span>
<span class="w">    </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">    </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">    </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよゲーム&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;690&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;500&quot;</span>
<span class="w">    </span><span class="na">Focusable=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;Window.InputBindings&gt;</span>
<span class="w">    </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Left&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding MoveLeft}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Right&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding MoveRight}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Down&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding MoveDown}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w">  </span><span class="cm">&lt;!-- 追加 --&gt;</span>
<span class="w">    </span><span class="nt">&lt;KeyBinding</span><span class="w"> </span><span class="na">Key=</span><span class="s">&quot;Up&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding Rotate}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/Window.InputBindings&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- ... 既存のUI定義 ... --&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>「Bolero 版の handleKeyDown 関数とは違いますね！」そうです！WPF では XAML で宣言的にキー入力を定義し、Elmish.WPF のバインディングを通じてメッセージをディスパッチします。コードでイベントハンドラを書く必要はありません。</p>
<p>「下キーを押している間だけ速く落ちるようにはできますか？」Elmish.WPF 版では、シンプルに MoveDown メッセージを使って高速落下を実現します。キーを押している間は連続して MoveDown メッセージが送られるため、特別な状態管理は不要です。WPF のキーボードイベントが自動的にキーリピートを処理してくれます。</p>
<h3 id="_49">リファクタリング: 落下処理の共通化<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>「TickとMoveDownの処理が重複していますね。リファクタリングしましょう！」良いですね！共通の処理を関数として抽出します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（ヘルパー関数の追加）</span>

<span class="c1">// ぷよを下に移動させる（共通処理）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 下に移動を試みる</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できた場合</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できない場合、ぷよを固定して新しいぷよを生成</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newBoard</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>

<span class="c1">// ランダム生成器を受け取る更新関数（テスト用）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">updateWithRandom</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="o">(</span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span><span class="o">)</span>
<span class="w">            </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Left</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Right</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">tryRotatePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">rotatedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">model</span>

<span class="c1">// 更新関数（Elmish用）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="bp">()</span>
<span class="w">    </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>「重複がなくなってスッキリしましたね！」そうです！これで、落下処理のロジックが一箇所にまとまりました。<code>dropPuyo</code> 関数は <code>Tick</code> と <code>MoveDown</code> の両方で使用されています。</p>
<h3 id="_50">動作確認<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、アプリケーションをビルドして実行します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># テストを実行して確認</span>
dotnet<span class="w"> </span><span class="nb">test</span>

<span class="c1"># アプリケーションを実行</span>
dotnet<span class="w"> </span>run<span class="w"> </span>--project<span class="w"> </span>src/PuyoPuyo.App
</code></pre></div>
<p>「ゲーム開始」ボタンをクリックして、下矢印キーを押してみてください。キーを押している間は WPF のキーリピート機能により、連続して MoveDown メッセージが送られ、ぷよが速く落ちます！</p>
<h3 id="_51">コミット<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commitsの規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: implement fast falling with down arrow key</span>

<span class="s2">- Add MoveDown message to Model</span>
<span class="s2">- Add MoveDown command binding to GameView</span>
<span class="s2">- Add KeyBinding for Down key in MainWindow.xaml</span>
<span class="s2">- Extract common dropPuyo function to eliminate duplication</span>
<span class="s2">- Add unit tests for MoveDown message (2 tests)</span>
<span class="s2">- All tests passing&quot;</span>
</code></pre></div>
<h3 id="5_1">イテレーション5のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ドメイン層</strong></li>
<li>既存の<code>tryMovePuyoPair</code>を活用（Down方向）</li>
<li>
<p>変更なし（既存機能を再利用）</p>
</li>
<li>
<p><strong>Elmish層</strong></p>
</li>
<li><code>MoveDown</code> メッセージの処理</li>
<li><code>dropPuyo</code>：落下処理の共通化（リファクタリング）</li>
<li>
<p><code>updateWithRandom</code>：テスト用の更新関数</p>
</li>
<li>
<p><strong>View層（Elmish.WPF）</strong></p>
</li>
<li><code>GameView.fs</code>：MoveDown コマンドのバインディング追加</li>
<li><code>MainWindow.xaml</code>：Down キーの KeyBinding 追加</li>
<li>
<p>XAML による宣言的なキー入力処理</p>
</li>
<li>
<p><strong>テスト</strong></p>
</li>
<li>MoveDownメッセージのテスト（2テスト）</li>
<li>下端到達時の挙動確認</li>
<li>
<p><code>updateWithRandom</code> を使った決定論的テスト</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>WPF KeyBinding による宣言的キー入力</li>
<li>Elmish.WPF の Binding.cmd でのコマンドバインディング</li>
<li>リファクタリング：重複コードの関数抽出</li>
<li>WPF のキーリピート機能の活用</li>
<li>
<p>XAML と F# の責任分離</p>
</li>
<li>
<p><strong>リファクタリングの実践</strong></p>
</li>
<li>Before：TickとMoveDownで重複コード</li>
<li>After：<code>dropPuyo</code>関数に共通処理を抽出</li>
<li>DRY原則（Don't Repeat Yourself）の実践</li>
<li>
<p>保守性の向上</p>
</li>
<li>
<p><strong>Bolero版との違い</strong></p>
</li>
<li>IsFastFalling 状態フラグは不要</li>
<li>StartFastFall / StopFastFall メッセージは不要</li>
<li>handleKeyDown / handleKeyUp 関数は不要</li>
<li>Subscription のタイマー速度切り替えは不要</li>
<li>WPF のキーリピートが自動的に高速落下を実現</li>
<li>XAML で宣言的にキー入力を定義</li>
<li>
<p>よりシンプルな実装</p>
</li>
<li>
<p><strong>WPF の利点</strong></p>
</li>
<li>キーボードイベントの自動リピート処理</li>
<li>XAML による宣言的な UI 定義</li>
<li>コマンドバインディングによる疎結合</li>
<li>イベントハンドラのコード削減</li>
</ol>
<p>次のイテレーションでは、ぷよの消去機能を実装していきます。</p>
<h2 id="6">イテレーション6: ぷよの消去の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを4つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_52">ユーザーストーリー<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを4つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。これを実装することで、ゲームとしての面白さが大きく向上しますね。</p>
<h3 id="todo_5">TODO リスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li><strong>ぷよの接続判定を実装する</strong>：隣接する同じ色のぷよを検出する（幅優先探索 BFS を使用）</li>
<li><strong>4つ以上つながったぷよの検出を実装する</strong>：消去対象となるぷよのグループを特定する</li>
<li><strong>ぷよの消去処理を実装する</strong>：消去対象のぷよを実際に消す</li>
<li><strong>重力の適用を実装する</strong>：消去後にぷよを落下させる</li>
<li><strong>Update 関数への統合</strong>：ぷよ固定時に消去判定と消去処理を実行する</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_53">テスト: ぷよの接続判定<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが4つ以上つながっているかどうかを判定する機能が必要です。</p>
<p><code>BoardTests.fs</code> に新しいテストモジュールを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs（追加）</span>

<span class="k">module</span><span class="w"> </span><span class="n">``ぷよの消去``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``横に4つ並んだぷよを検出できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">board</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``縦に4つ並んだぷよを検出できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">board</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">Green</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">Green</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">Green</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Green</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">4</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``L字型につながった5つのぷよを検出できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">board</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Blue</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Blue</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">5</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``3つ以下のぷよは検出されない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">board</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Yellow</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Yellow</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Yellow</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の4つのケースを確認しています：</p>
<ol>
<li><strong>横に4つ並んだ場合</strong>：水平方向につながったぷよが検出されるか</li>
<li><strong>縦に4つ並んだ場合</strong>：垂直方向につながったぷよが検出されるか</li>
<li><strong>L字型の場合</strong>：複雑な形でつながったぷよが検出されるか</li>
<li><strong>3つ以下の場合</strong>：消去条件を満たさないぷよは検出されないか</li>
</ol>
<p>「なるほど、4つ以上という条件が重要なんですね！」そうです！ぷよぷよの基本ルールですね。</p>
<h3 id="red">テスト実行（RED）<a class="headerlink" href="#red" title="Permanent link">&para;</a></h3>
<p>「テストを実行して、失敗することを確認しましょう！」はい、まだ <code>findConnectedGroups</code> 関数を実装していないので、コンパイルエラーになるはずです。</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
</code></pre></div>
<p>予想通り、コンパイルエラーが発生します。これが TDD の RED フェーズです。</p>
<h3 id="green">実装: ぷよの接続判定（GREEN）<a class="headerlink" href="#green" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよの接続判定を実装していきましょう。</p>
<p><code>Board.fs</code> に新しい関数を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（追加）</span>

<span class="c1">// 隣接するセルの座標を取得</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">getNeighbors</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">      </span><span class="o">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">      </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">      </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="c1">// 下</span>

<span class="c1">// ボードの範囲内かチェック</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">isInBounds</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">length1</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">length2</span><span class="w"> </span><span class="n">board</span>

<span class="c1">// 指定位置から同じ色のつながったぷよを探索（BFS）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">findConnectedPuyos</span>
<span class="w">    </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span>
<span class="w">    </span><span class="o">(</span><span class="n">startX</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span>
<span class="w">    </span><span class="o">(</span><span class="n">startY</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span>
<span class="w">    </span><span class="o">(</span><span class="n">color</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoColor</span><span class="o">)</span>
<span class="w">    </span><span class="o">(</span><span class="n">visited</span><span class="o">:</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">bfs</span><span class="w"> </span><span class="o">(</span><span class="n">queue</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">visited</span><span class="o">:</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">result</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">contains</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="n">bfs</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="n">result</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">newVisited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">add</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="n">visited</span>

<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">neighbors</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">getNeighbors</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span>
<span class="w">                    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">nx</span><span class="o">,</span><span class="w"> </span><span class="n">ny</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="ow">not</span><span class="w"> </span><span class="o">(</span><span class="nn">Set</span><span class="p">.</span><span class="n">contains</span><span class="w"> </span><span class="o">(</span><span class="n">nx</span><span class="o">,</span><span class="w"> </span><span class="n">ny</span><span class="o">)</span><span class="w"> </span><span class="n">newVisited</span><span class="o">)</span>
<span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isInBounds</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="n">ny</span>
<span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">getCellColor</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="o">)</span>

<span class="w">                </span><span class="n">bfs</span><span class="w"> </span><span class="o">(</span><span class="n">rest</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">neighbors</span><span class="o">)</span><span class="w"> </span><span class="n">newVisited</span><span class="w"> </span><span class="o">((</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">result</span><span class="o">)</span>

<span class="w">    </span><span class="n">bfs</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="o">(</span><span class="n">startX</span><span class="o">,</span><span class="w"> </span><span class="n">startY</span><span class="o">)</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="bp">[]</span>

<span class="c1">// 4つ以上つながっているぷよのグループを検出</span>
<span class="k">let</span><span class="w"> </span><span class="nv">findConnectedGroups</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">((</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">empty</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">[]</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">(</span><span class="nn">Array2D</span><span class="p">.</span><span class="n">length2</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">(</span><span class="nn">Array2D</span><span class="p">.</span><span class="n">length1</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="o">(</span><span class="nn">Set</span><span class="p">.</span><span class="n">contains</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="n">visited</span><span class="o">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCellColor</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">board</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedPuyos</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="n">visited</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="n">groups</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">groups</span>

<span class="w">                    </span><span class="n">visited</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nn">Set</span><span class="p">.</span><span class="n">ofList</span><span class="w"> </span><span class="n">group</span>

<span class="w">    </span><span class="n">groups</span>
</code></pre></div>
<p>「BFS（幅優先探索）を使っているんですね！」その通りです。F# では、再帰関数を使って BFS を実装しています。<code>findConnectedPuyos</code> 関数は、指定された位置から同じ色のぷよを再帰的に探索します。</p>
<p>「<code>visited</code> Set で訪問済みのセルを管理しているのがポイントですね！」はい！これにより、同じセルを複数回訪問することを防ぎ、効率的に探索できます。</p>
<h3 id="green_1">テスト実行（GREEN）<a class="headerlink" href="#green_1" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、テストを実行しましょう！」はい、テストが通るはずです。</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>すべてのテストが通ることを確認します。</p>
<h3 id="_54">テスト: ぷよの消去処理<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>「次は実際にぷよを消す処理をテストしましょう！」はい、消去対象のぷよを実際に削除する処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs（追加）</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``指定した位置のぷよを消去できる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">board</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">11</span><span class="o">);</span><span class="w"> </span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">11</span><span class="o">);</span><span class="w"> </span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">11</span><span class="o">);</span><span class="w"> </span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="mi">11</span><span class="o">)</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">positions</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">        </span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">        </span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
<span class="w">        </span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``消去後にぷよが落下する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Green</span>

<span class="w">        </span><span class="c1">// Act - (0, 11) のぷよを消去</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">11</span><span class="o">)</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">droppedBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newBoard</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">applyGravity</span>

<span class="w">        </span><span class="c1">// Assert - (0, 8) にあった赤いぷよが (0, 11) に落下</span>
<span class="w">        </span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">droppedBoard</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Red</span>
<span class="w">        </span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">droppedBoard</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">Empty</span>
</code></pre></div>
<h3 id="red_1">テスト実行（RED）<a class="headerlink" href="#red_1" title="Permanent link">&para;</a></h3>
<p>テストを実行して、コンパイルエラーを確認します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
</code></pre></div>
<h3 id="green_2">実装: ぷよの消去処理と重力適用（GREEN）<a class="headerlink" href="#green_2" title="Permanent link">&para;</a></h3>
<p>「消去処理と重力を実装しましょう！」はい、2つの関数を実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（追加）</span>

<span class="c1">// 指定した位置のぷよを消去</span>
<span class="k">let</span><span class="w"> </span><span class="nv">clearPuyos</span><span class="w"> </span><span class="o">(</span><span class="n">positions</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">copy</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="n">positions</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">iter</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">newBoard</span><span class="o">.[</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Empty</span><span class="o">)</span>
<span class="w">    </span><span class="n">newBoard</span>

<span class="c1">// 重力を適用してぷよを落下させる</span>
<span class="k">let</span><span class="w"> </span><span class="nv">applyGravity</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newBoard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">copy</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">length1</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">length2</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="c1">// 各列ごとに処理</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1">// 下から上に向かって詰める</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">writeY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">(</span><span class="n">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newBoard</span><span class="o">.[</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">]</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">writeY</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="n">newBoard</span><span class="o">.[</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">writeY</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color</span>
<span class="w">                    </span><span class="n">newBoard</span><span class="o">.[</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Empty</span>

<span class="w">                </span><span class="n">writeY</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">writeY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="n">newBoard</span>
</code></pre></div>
<p>「<code>clearPuyos</code> は指定位置を Empty にして、<code>applyGravity</code> は各列を下から詰めていくんですね！」その通りです。重力処理では、各列ごとに下から上へスキャンし、空でないセルを下に詰めていきます。</p>
<h3 id="green_3">テスト実行（GREEN）<a class="headerlink" href="#green_3" title="Permanent link">&para;</a></h3>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>すべてのテストが通ることを確認します。</p>
<h3 id="update_9">Update 関数への統合<a class="headerlink" href="#update_9" title="Permanent link">&para;</a></h3>
<p>「最後に、ゲームの Update 関数に消去処理を組み込みましょう！」はい、ぷよが固定されたときに消去処理を実行するように変更します。</p>
<p>まず、統合テストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（追加）</span>

<span class="k">module</span><span class="w"> </span><span class="n">``ぷよの消去``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``着地時に4つ以上つながったぷよが消える``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>

<span class="w">        </span><span class="c1">// ボードに赤いぷよを 3 つ並べておく</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">init</span><span class="bp">()</span><span class="o">.</span><span class="n">Board</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// 赤いぷよペアを上から落とす</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                          </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                          </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">}</span>
<span class="w">                          </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">}</span>
<span class="w">                          </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act - 着地させる</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert - 4つつながって消える</span>
<span class="w">        </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Empty</span>
<span class="w">        </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Empty</span>
<span class="w">        </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Empty</span>
<span class="w">        </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">getCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">newModel</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Empty</span>
</code></pre></div>
<h3 id="red_2">テスト実行（RED）<a class="headerlink" href="#red_2" title="Permanent link">&para;</a></h3>
<p>テストを実行して、失敗することを確認します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>現在の実装では消去処理がないため、テストは失敗します。</p>
<h3 id="update-green">実装: Update 関数の修正（GREEN）<a class="headerlink" href="#update-green" title="Permanent link">&para;</a></h3>
<p>「Update 関数を修正して、消去処理を組み込みましょう！」はい、<code>dropPuyo</code> 関数を修正します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs（修正）</span>

<span class="c1">// ぷよを下に移動させる（共通処理）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 下に移動を試みる</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できた場合</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できない場合、ぷよを固定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span>

<span class="w">            </span><span class="c1">// 消去処理</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">boardWithPuyo</span>

<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterClear</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">boardWithPuyo</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">                    </span><span class="n">boardWithPuyo</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">applyGravity</span>

<span class="w">            </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterClear</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>「ぷよを固定した後、消去判定をして、消去対象があれば消去→重力、なければ重力だけ適用するんですね！」その通りです！ロジックはシンプルですが、これでぷよ消去機能が完成します。</p>
<h3 id="green_4">テスト実行（GREEN）<a class="headerlink" href="#green_4" title="Permanent link">&para;</a></h3>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>すべてのテストが通ることを確認します。57 個のテストがすべて成功するはずです。</p>
<h3 id="_55">リファクタリング<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>「リファクタリングは必要ですか？」今回の実装は既にシンプルで明確なので、大きなリファクタリングは不要です。ただし、コードフォーマットを確認しておきましょう。</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format
</code></pre></div>
<h3 id="_56">動作確認<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>「実装が終わったので、動かしてみましょう！」はい、アプリケーションを起動します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>run<span class="w"> </span>--project<span class="w"> </span>src/PuyoPuyo.App/PuyoPuyo.App.csproj
</code></pre></div>
<p>ゲームを開始して、同じ色のぷよを4つつなげてみてください。ぷよが消えて、上にあったぷよが落下することを確認できるはずです！</p>
<h3 id="ci_2">CI 実行<a class="headerlink" href="#ci_2" title="Permanent link">&para;</a></h3>
<p>「すべてのチェックが通ることを確認しましょう！」はい、CI パイプラインを実行します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>ci
</code></pre></div>
<p>すべてのタスクが成功することを確認します：
- ✅ Format-Check
- ✅ Lint
- ✅ Build
- ✅ Test（57 tests passed）
- ✅ Coverage（75%以上）</p>
<h3 id="_57">コミット<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>「動作確認できたので、コミットしましょう！」はい、Conventional Commits の規約に従ってコミットします：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">feat: イテレーション 6 - ぷよの消去機能を実装</span>

<span class="s">- Board.fs に接続判定関数を追加（BFS アルゴリズム）</span>
<span class="s">  - getNeighbors: 隣接セル座標取得</span>
<span class="s">  - isInBounds: 範囲内チェック</span>
<span class="s">  - findConnectedPuyos: 同色の接続ぷよを探索（BFS）</span>
<span class="s">  - findConnectedGroups: 4つ以上のグループを検出</span>
<span class="s">- Board.fs にぷよ消去と重力関数を追加</span>
<span class="s">  - clearPuyos: 指定位置のぷよを消去</span>
<span class="s">  - applyGravity: 消去後にぷよを落下</span>
<span class="s">- Update.fs の dropPuyo 関数を拡張</span>
<span class="s">  - ぷよ固定時に消去判定を実行</span>
<span class="s">  - 4つ以上つながったぷよを消去</span>
<span class="s">  - 消去後に重力を適用</span>
<span class="s">- BoardTests.fs にぷよ消去のテストを追加（6件）</span>
<span class="s">- UpdateTests.fs に統合テストを追加（1件）</span>
<span class="s">- All 57 tests passing</span>

<span class="s">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;</span>
<span class="s">EOF</span>
<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="6_1">イテレーション 6 のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li>
<p><strong>BFS による接続判定</strong>：</p>
<ul>
<li>幅優先探索アルゴリズムを使用</li>
<li><code>visited</code> Set で訪問済みセルを管理</li>
<li>再帰関数とパターンマッチングによる実装</li>
<li>4つ以上つながったぷよのグループを検出</li>
</ul>
</li>
<li>
<p><strong>ぷよの消去処理</strong>：</p>
<ul>
<li><code>clearPuyos</code> 関数で指定位置を Empty に設定</li>
<li>イミュータブルな実装（Array2D.copy を使用）</li>
<li>シンプルで理解しやすいロジック</li>
</ul>
</li>
<li>
<p><strong>重力の適用</strong>：</p>
<ul>
<li><code>applyGravity</code> 関数で列ごとにぷよを落下</li>
<li>下から上へスキャンして詰める</li>
<li>効率的なアルゴリズム</li>
</ul>
</li>
<li>
<p><strong>Update 関数への統合</strong>：</p>
<ul>
<li>ぷよ固定時に消去処理を自動実行</li>
<li>消去→重力→新ぷよ生成の流れ</li>
<li>ゲームループにシームレスに統合</li>
</ul>
</li>
<li>
<p><strong>TDD サイクルの実践</strong>：</p>
<ul>
<li>Red：6件の Board テスト + 1件の統合テスト</li>
<li>Green：最小限の実装で通す</li>
<li>Refactor：コードフォーマットの適用</li>
</ul>
</li>
<li>
<p><strong>F# の表現力</strong>：</p>
<ul>
<li>再帰関数による BFS 実装</li>
<li>パターンマッチングによるリスト処理</li>
<li>パイプライン演算子による関数合成</li>
<li>イミュータブルなデータ構造</li>
</ul>
</li>
</ol>
<p><strong>学んだこと</strong>：
- グラフ探索アルゴリズム（BFS）の実装方法
- F# での可変状態（<code>mutable</code>）の適切な使用
- 複雑なロジックのテスト分割戦略
- ドメインロジックと UI の分離の重要性</p>
<p>これで、ぷよぷよゲームの核心的な機能である「ぷよの消去」が実装できました！次のイテレーションでは、連鎖反応を実装していきます。</p>
<hr />
<h2 id="7">イテレーション7: 連鎖反応の実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装していきましょう！</p>
<h3 id="_58">ユーザーストーリー<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="_59">現在の実装を確認する<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>「連鎖反応を実装するには、どんな作業が必要ですか？」まずは、現在の <code>Update.fs</code> の <code>dropPuyo</code> 関数を見てみましょう。</p>
<p><code>src/PuyoPuyo.WPF/Elmish/Update.fs</code> の現在の実装：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ぷよを下に移動させる（共通処理）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 下に移動を試みる</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できた場合</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できない場合、ぷよを固定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span>
<span class="w">            </span><span class="c1">// 重力適用</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">boardWithPuyo</span>

<span class="w">            </span><span class="c1">// 消去判定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">boardAfterGravity</span>

<span class="w">            </span><span class="c1">// 消去処理</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterClear</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="n">boardAfterGravity</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">                    </span><span class="n">boardAfterGravity</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">positions</span>

<span class="w">            </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterClear</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>「この実装の問題は何ですか？」現在の実装では、「固定 → 重力 → 消去 → 新ぷよ生成」という流れで、<strong>1回しか消去判定をしていません</strong>。連鎖を実現するには、消去後に再度「重力 → 消去判定」を繰り返す必要があります。</p>
<h3 id="tdd">TDD サイクル開始<a class="headerlink" href="#tdd" title="Permanent link">&para;</a></h3>
<h4 id="red_3">RED: 連鎖のテストを書く<a class="headerlink" href="#red_3" title="Permanent link">&para;</a></h4>
<p>まず、連鎖が発生することを確認するテストを書きましょう。<code>tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs</code> に新しいテストモジュールを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">``連鎖反応``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``初期化時の連鎖カウントは0``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">model</span><span class="o">.</span><span class="n">Chain</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``連鎖が発生すると連鎖カウントが増加する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>

<span class="w">        </span><span class="c1">// 連鎖が発生する配置:</span>
<span class="w">        </span><span class="c1">// 赤ぷよ 4つ（下）+ 青ぷよ 4つ（上）</span>
<span class="w">        </span><span class="c1">// 赤が消えると青が落ちて4つつながり、連鎖発生</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">init</span><span class="bp">()</span><span class="o">.</span><span class="n">Board</span>
<span class="w">            </span><span class="c1">// 赤ぷよ（下）</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="c1">// 青ぷよ（縦3 + 横1）</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Blue</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Blue</span>

<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                          </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                          </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>
<span class="w">                          </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">}</span>
<span class="w">                          </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act - 着地させて連鎖を発生させる</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert - 2連鎖が発生（1回目の消去 + 2回目の消去）</span>
<span class="w">        </span><span class="n">newModel</span><span class="o">.</span><span class="n">Chain</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">(</span><span class="n">greaterThanOrEqualTo</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは以下を確認しています：</p>
<ol>
<li><strong>初期配置</strong>：赤ぷよ4つ（縦）と青ぷよ4つ（縦3 + 横1）を配置</li>
<li><strong>1回目の消去</strong>：赤ぷよ4つと新しく着地した赤ぷよ2つの計6つが消える</li>
<li><strong>重力適用</strong>：青ぷよが落下</li>
<li><strong>2回目の消去</strong>：落下した青ぷよが4つつながり、連鎖が発生</li>
</ol>
<h3 id="_60">実装: 連鎖判定<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>連鎖反応を実装するために、まず連鎖カウントを管理する必要があります。TDD のサイクルに従って進めていきましょう。</p>
<h4 id="red-model-chain">RED: Model に Chain フィールドを追加<a class="headerlink" href="#red-model-chain" title="Permanent link">&para;</a></h4>
<p>まず、<code>Model</code> に <code>Chain</code> フィールドを追加する必要があります。これがないとテストがコンパイルエラーになります。</p>
<p><code>src/PuyoPuyo.WPF/Elmish/Model.fs</code> を更新：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ゲームモデル</span>
<span class="k">type</span><span class="w"> </span><span class="nc">Model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">Board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span>
<span class="w">      </span><span class="n">Score</span><span class="o">:</span><span class="w"> </span><span class="n">Score</span>
<span class="w">      </span><span class="n">Chain</span><span class="o">:</span><span class="w"> </span><span class="n">int</span>
<span class="w">      </span><span class="n">GameState</span><span class="o">:</span><span class="w"> </span><span class="n">GameState</span>
<span class="w">      </span><span class="n">CurrentPair</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// 初期化関数</span>
<span class="k">let</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">{</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>
<span class="w">      </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initialScore</span>
<span class="w">      </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span>
<span class="w">      </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<p>テストをビルドして実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
</code></pre></div>
<p>「ビルドは成功しますか？」はい、成功します。次にテストを実行します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>成功!   -失敗:     1、合格:    58、スキップ:     0、合計:    59
</code></pre></div>
<p>「1つ失敗しましたね！」はい、連鎖カウントのテストが失敗します。現在の実装では連鎖が発生しないので、<code>Chain</code> が 0 のままです。</p>
<h4 id="green_5">GREEN: 連鎖処理を実装<a class="headerlink" href="#green_5" title="Permanent link">&para;</a></h4>
<p>連鎖を実現するために、<code>Update.fs</code> に再帰的な連鎖処理関数を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 連鎖処理を再帰的に実行</span>
<span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="n">processChain</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">chainCount</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、連鎖終了</span>
<span class="w">        </span><span class="o">(</span><span class="n">board</span><span class="o">,</span><span class="w"> </span><span class="n">chainCount</span><span class="o">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="c1">// 消去処理</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">positions</span>
<span class="w">        </span><span class="c1">// 重力適用</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">boardAfterClear</span>
<span class="w">        </span><span class="c1">// 連鎖カウントを増やして再帰呼び出し</span>
<span class="w">        </span><span class="n">processChain</span><span class="w"> </span><span class="n">boardAfterGravity</span><span class="w"> </span><span class="o">(</span><span class="n">chainCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
</code></pre></div>
<p>「この関数は何をしているんですか？」<code>processChain</code> 関数は以下の処理を行います：</p>
<ol>
<li><strong>消去判定</strong>：<code>findConnectedGroups</code> で消去可能なぷよを検索</li>
<li><strong>連鎖終了判定</strong>：消去対象がなければ終了</li>
<li><strong>消去処理</strong>：消去対象があれば <code>clearPuyos</code> で消去</li>
<li><strong>重力適用</strong>：<code>applyGravity</code> で落下</li>
<li><strong>再帰呼び出し</strong>：連鎖カウントを増やして再度消去判定</li>
</ol>
<p>次に、<code>dropPuyo</code> 関数を更新して、<code>processChain</code> を使用するようにします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ぷよを下に移動させる（共通処理）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 下に移動を試みる</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できた場合</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できない場合、ぷよを固定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span>
<span class="w">            </span><span class="c1">// 重力適用</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">boardWithPuyo</span>

<span class="w">            </span><span class="c1">// 連鎖処理</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">boardAfterChain</span><span class="o">,</span><span class="w"> </span><span class="n">chainCount</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processChain</span><span class="w"> </span><span class="n">boardAfterGravity</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterChain</span>
<span class="w">                </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chainCount</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>「どこが変わったんですか？」主な変更点は：</p>
<ol>
<li><strong>消去処理を processChain に置き換え</strong>：再帰的に連鎖を処理</li>
<li><strong>Chain フィールドを更新</strong>：連鎖カウントを Model に保存</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>成功!   -失敗:     0、合格:    59、スキップ:     0、合計:    59
</code></pre></div>
<p>「全テスト成功しましたね！」はい、連鎖機能が正しく実装できました！</p>
<h3 id="view_3">View の更新<a class="headerlink" href="#view_3" title="Permanent link">&para;</a></h3>
<p>連鎖カウントを表示するために、<code>GameView.fs</code> のバインディングを更新します：</p>
<p><code>src/PuyoPuyo.WPF/Components/GameView.fs</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Elmish バインディング</span>
<span class="k">let</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;Score&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Score</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Chain&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Chain</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Puyos&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getAllPuyos</span><span class="w"> </span><span class="n">m</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;StartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">StartGame</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;CanStartGame&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">oneWay</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotStarted</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveLeft&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveLeft</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveRight&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveRight</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;MoveDown&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MoveDown</span><span class="o">)</span>
<span class="w">      </span><span class="s">&quot;Rotate&quot;</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Binding</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Rotate</span><span class="o">)</span><span class="w"> </span><span class="o">]</span>
</code></pre></div>
<p>「Chain の表示は XAML に既にあるんですか？」はい、<code>src/PuyoPuyo.App/MainWindow.xaml</code> には既に Chain の表示が定義されています（49-51行目）。</p>
<h3 id="_61">動作確認<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>アプリケーションを起動して、連鎖が発生することを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>run<span class="w"> </span>--project<span class="w"> </span>src/PuyoPuyo.App/PuyoPuyo.App.csproj
</code></pre></div>
<p>同じ色のぷよを縦に4つ並べて、その上に別の色のぷよを配置してみてください。下のぷよが消えると、上のぷよが落下して新たに4つつながり、連鎖が発生します！</p>
<h3 id="ci_3">CI 実行<a class="headerlink" href="#ci_3" title="Permanent link">&para;</a></h3>
<p>すべてのチェックが通ることを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>ci
</code></pre></div>
<p>すべてのタスクが成功することを確認します：
- ✅ Format-Check
- ✅ Lint
- ✅ Build
- ✅ Test（59 tests passed）
- ✅ Coverage（76%以上）</p>
<h3 id="_62">コミット<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>動作確認できたので、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">feat: イテレーション 7 - 連鎖反応を実装</span>

<span class="s">- Model に Chain フィールドを追加</span>
<span class="s">- 連鎖処理を再帰的に実行する processChain 関数を実装</span>
<span class="s">  - 消去判定 → 消去 → 重力 → 再帰呼び出し</span>
<span class="s">  - 連鎖カウントを増やしながら繰り返し</span>
<span class="s">  - 消去対象がなくなったら終了</span>
<span class="s">- dropPuyo 関数を連鎖対応に修正</span>
<span class="s">  - ぷよ固定後に processChain を呼び出し</span>
<span class="s">  - 連鎖カウントを Model に保存</span>
<span class="s">- GameView の bindings に Chain バインディングを追加</span>
<span class="s">- UpdateTests に連鎖反応のテストを追加（2件）</span>
<span class="s">- All 59 tests passing</span>

<span class="s">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;</span>
<span class="s">EOF</span>
<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="7_1">イテレーション７のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>再帰関数による連鎖処理</strong>：</li>
<li><code>rec</code> キーワードで再帰関数を定義</li>
<li>終了条件を明確にする</li>
<li>
<p>末尾再帰最適化によるパフォーマンス</p>
</li>
<li>
<p><strong>宣言的なコード</strong>：</p>
</li>
<li>TypeScript 版の状態遷移と比較してシンプル</li>
<li>関数型プログラミングの利点を活用</li>
<li>
<p>不変性により安全な処理</p>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
</li>
<li>連鎖が発生するケースをテスト</li>
<li>消去なしのケースもテスト</li>
<li>複数連鎖のケースで動作確認</li>
<li>
<p>テストで仕様を明確化</p>
</li>
<li>
<p><strong>F# の表現力</strong>：</p>
</li>
<li>再帰による自然な連鎖表現</li>
<li>パターンマッチングによる分岐</li>
<li>パイプライン演算子での処理の流れ</li>
</ol>
<p>このイテレーションで、ぷよぷよの醍醐味である連鎖反応が実装できました。次のイテレーションでは、全消しボーナスを実装して、プレイヤーに特別な達成感を提供します！</p>
<h2 id="8">イテレーション8: 全消しボーナスの実装<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>「ぷよぷよといえば、全消しボーナスもありますよね？」そうですね！全てのぷよが消えた状態を「全消し」（ぜんけし、別名「ぜんけし」または "All Clear"）と呼びます。これを達成したプレイヤーには特別なボーナス点が与えられます。今回は、この全消し判定とボーナス加算を実装していきましょう！</p>
<h3 id="_63">ユーザーストーリー<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、盤面上の全てのぷよを消すと全消しボーナスが加算される</p>
</blockquote>
<p>「全消しは達成が難しいから、特別なボーナスがあるといいですね！」そうですね。全消しは上級者向けのテクニックで、これを達成したプレイヤーには特別な報酬を与えることで、ゲームの戦略性と達成感を高めることができます。</p>
<h3 id="todo_6">TODOリスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「全消しボーナスを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>全消し判定を実装する（盤面上にぷよが残っていないかチェック）</li>
<li>Update 関数に全消し処理を統合する（連鎖処理後にボーナス加算）</li>
<li>テストを追加・実行して確認する</li>
<li>CI パイプラインを実行する</li>
<li>変更をコミットする</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="red_4">テスト: 全消し判定（RED フェーズ）<a class="headerlink" href="#red_4" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、全消し判定をテストしましょう。盤面上に残っているぷよがあるかどうかをチェックする機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Domain/BoardTests.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="n">``全消し判定``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``盤面が空の場合は全消しと判定される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">isAllClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isAllClear</span><span class="w"> </span><span class="n">board</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">isAllClear</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">true</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``盤面にぷよが残っている場合は全消しと判定されない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBoard</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">isAllClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isAllClear</span><span class="w"> </span><span class="n">board</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">isAllClear</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>盤面が空の場合、全消しと判定されるか</li>
<li>盤面上にぷよが残っている場合、全消しと判定されないか</li>
</ol>
<p>「シンプルなテストですね！」そうです。最もシンプルなケースから始めるのがTDDの基本です。</p>
<p>まずテストを実行して、失敗することを確認します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「コンパイルエラーが出ましたか？」はい、<code>isAllClear</code> 関数が定義されていないためエラーになりました。これが RED フェーズです。</p>
<h3 id="green_6">実装: 全消し判定（GREEN フェーズ）<a class="headerlink" href="#green_6" title="Permanent link">&para;</a></h3>
<p>「それでは実装に進みましょう！」そうですね。では、全消し判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/Board.fs（続き）</span>

<span class="c1">// 全消し判定（盤面上のぷよがすべて消えたかをチェック）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">isAllClear</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">length1</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Array2D</span><span class="p">.</span><span class="n">length2</span><span class="w"> </span><span class="n">board</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">hasAnyPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">getCellColor</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="n">hasAnyPuyo</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">true</span>

<span class="w">    </span><span class="ow">not</span><span class="w"> </span><span class="n">hasAnyPuyo</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。全消し判定の実装自体はとてもシンプルです。盤面上のすべてのセルをチェックし、全てが <code>Empty</code> であれば <code>true</code> を返します。</p>
<p>「ミュータブルな変数を使っているんですね！」その通りです！このような判定処理では、フラグを使って結果を追跡する方法がシンプルで分かりやすいです。</p>
<p>テストを再実行します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「テストは通りましたか？」はい！全 61 テストがパスしました。GREEN フェーズ完了です。</p>
<h3 id="_64">解説: 全消し判定<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>全消し判定では、以下のことを行っています：</p>
<ol>
<li>盤面のサイズを取得（<code>Array2D.length1</code> で幅、<code>Array2D.length2</code> で高さ）</li>
<li>すべてのセルを走査してぷよの有無をチェック</li>
<li>ぷよが1つでも見つかったら <code>hasAnyPuyo</code> フラグを立てる</li>
<li>フラグの否定を返す（ぷよがなければ全消し）</li>
</ol>
<p>「全消し判定はいつ行われるんですか？」良い質問ですね！全消し判定は、連鎖処理が完了した後に行われます。ぷよが消えた後、盤面上にぷよが残っていないかをチェックするんです。</p>
<h3 id="red_5">テスト: 全消しボーナス（RED フェーズ）<a class="headerlink" href="#red_5" title="Permanent link">&para;</a></h3>
<p>次に、全消しボーナスの加算をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/Elmish/UpdateTests.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="n">``全消しボーナス``</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``全消し時に3600点のボーナスが加算される``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>

<span class="w">        </span><span class="c1">// ボードに赤いぷよを 3 つ並べておく（全消しになる配置）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">init</span><span class="bp">()</span><span class="o">.</span><span class="n">Board</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>

<span class="w">        </span><span class="c1">// 赤いぷよペアを上から落として全消しさせる</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                          </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                          </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">}</span>
<span class="w">                          </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">}</span>
<span class="w">                          </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">                </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act - 着地させて全消しさせる</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert - 全消しボーナス3600点が加算される</span>
<span class="w">        </span><span class="n">newModel</span><span class="o">.</span><span class="n">Score</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">3600</span>

<span class="w">    </span><span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="n">``全消しでない場合はボーナスが加算されない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>

<span class="w">        </span><span class="c1">// ボードに赤いぷよ 3 つ + 緑のぷよ 1 つ（全消しにならない配置）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">init</span><span class="bp">()</span><span class="o">.</span><span class="n">Board</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Board</span><span class="p">.</span><span class="n">setCellColor</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Green</span>

<span class="w">        </span><span class="c1">// 赤いぷよペアを上から落とす（赤だけ消えて緑が残る）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">Some</span>
<span class="w">                        </span><span class="o">{</span><span class="w"> </span><span class="n">Axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                          </span><span class="n">Child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Domain</span><span class="p">.</span><span class="nn">Puyo</span><span class="p">.</span><span class="n">Red</span>
<span class="w">                          </span><span class="n">AxisPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">}</span>
<span class="w">                          </span><span class="n">ChildPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">}</span>
<span class="w">                          </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>
<span class="w">                </span><span class="n">GameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">                </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">        </span><span class="c1">// Act - 着地させる（赤だけ消えて緑が残る）</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateWithRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">model</span>

<span class="w">        </span><span class="c1">// Assert - ボーナスは加算されない（スコア0のまま）</span>
<span class="w">        </span><span class="n">newModel</span><span class="o">.</span><span class="n">Score</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<p>「全消しボーナスのテストでは何を確認しているんですか？」これらのテストでは、以下を確認しています：</p>
<ol>
<li>全消し時に 3600 点のボーナスが加算されること</li>
<li>全消しでない場合はボーナスが加算されないこと</li>
</ol>
<p>テストを実行して、失敗することを確認します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「期待値と実際の値が異なりましたか？」はい、期待値は 3600 ですが、実際は 0 でした。これが RED フェーズです。</p>
<h3 id="update-green_1">実装: Update 関数への統合（GREEN フェーズ）<a class="headerlink" href="#update-green_1" title="Permanent link">&para;</a></h3>
<p>全消し判定を Update 関数の連鎖処理に組み込みます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Elmish/Update.fs</span>

<span class="k">open</span><span class="w"> </span><span class="nn">System</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.GameLogic</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">Elmish.Model</span>

<span class="c1">// 全消しボーナスの定数</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">allClearBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span>

<span class="c1">// 連鎖処理を再帰的に実行（戻り値: ボード、連鎖数、ボーナススコア）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="n">processChain</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">chainCount</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findConnectedGroups</span><span class="w"> </span><span class="n">board</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、連鎖終了</span>
<span class="w">        </span><span class="c1">// 全消しチェック</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isAllClear</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">allClearBonus</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="o">(</span><span class="n">board</span><span class="o">,</span><span class="w"> </span><span class="n">chainCount</span><span class="o">,</span><span class="w"> </span><span class="n">bonus</span><span class="o">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="c1">// 消去処理</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">clearPuyos</span><span class="w"> </span><span class="n">positions</span>
<span class="w">        </span><span class="c1">// 重力適用</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">boardAfterClear</span>
<span class="w">        </span><span class="c1">// 連鎖カウントを増やして再帰呼び出し</span>
<span class="w">        </span><span class="n">processChain</span><span class="w"> </span><span class="n">boardAfterGravity</span><span class="w"> </span><span class="o">(</span><span class="n">chainCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>

<span class="c1">// ぷよを下に移動させる（共通処理）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">dropPuyo</span><span class="w"> </span><span class="o">(</span><span class="n">random</span><span class="o">:</span><span class="w"> </span><span class="n">Random</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// 下に移動を試みる</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できた場合</span>
<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1">// 移動できない場合、ぷよを固定</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">pair</span>
<span class="w">            </span><span class="c1">// 重力適用</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyGravity</span><span class="w"> </span><span class="n">boardWithPuyo</span>

<span class="w">            </span><span class="c1">// 連鎖処理</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">boardAfterChain</span><span class="o">,</span><span class="w"> </span><span class="n">chainCount</span><span class="o">,</span><span class="w"> </span><span class="n">bonusScore</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processChain</span><span class="w"> </span><span class="n">boardAfterGravity</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generatePuyoPair</span><span class="w"> </span><span class="n">random</span>

<span class="w">            </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterChain</span>
<span class="w">                </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chainCount</span>
<span class="w">                </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bonusScore</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>
<p>「戻り値が3つになったんですね！」そうです。<code>processChain</code> 関数は、最終的なボード、連鎖数、そしてボーナススコアの3つを返すように変更しました。</p>
<p>「全消しのときだけボーナスが加算されるんですね！」その通りです。<code>if isAllClear board</code> で全消し判定を行い、全消しの場合は 3600 点、そうでない場合は 0 点を返します。</p>
<p>テストを実行します：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「テストは通りましたか？」はい！全 63 テストがパスしました。GREEN フェーズ完了です。</p>
<h3 id="_65">コミット<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>テストが全て通ったら、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">feat: イテレーション8 - 全消しボーナスを実装</span>

<span class="s">全消し時に3600点のボーナスが加算される機能を実装しました。</span>

<span class="s">## 変更内容</span>

<span class="s">### Domain/Board.fs</span>
<span class="s">- `isAllClear` 関数を追加</span>
<span class="s">  - 盤面上のすべてのセルが Empty かどうかを判定</span>

<span class="s">### Elmish/Update.fs</span>
<span class="s">- `processChain` 関数を拡張</span>
<span class="s">  - 連鎖処理後に全消し判定を実行</span>
<span class="s">  - 全消し時に3600点のボーナスを返すように変更</span>
<span class="s">  - 戻り値を (Board * int * int) に変更（ボード、連鎖数、ボーナススコア）</span>
<span class="s">- `dropPuyo` 関数を修正</span>
<span class="s">  - processChain から受け取ったボーナススコアをモデルに加算</span>

<span class="s">### テスト</span>
<span class="s">- BoardTests.fs に全消し判定のテストを追加</span>
<span class="s">- UpdateTests.fs に全消しボーナスのテストを追加</span>
<span class="s">  - 全消し時に3600点のボーナスが加算されることを確認</span>
<span class="s">  - 全消しでない場合はボーナスが加算されないことを確認</span>

<span class="s">全テスト(63件)がパスし、CI パイプラインも成功しました。</span>

<span class="s">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;</span>
<span class="s">EOF</span>
<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="8_1">イテレーション８のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>全消し判定の実装</strong>：</li>
<li>ミュータブルなフラグによる判定処理</li>
<li>二重ループで2次元配列を処理</li>
<li>
<p>シンプルなロジックで確実な判定を実現</p>
</li>
<li>
<p><strong>TDD サイクルの実践</strong>：</p>
</li>
<li>RED フェーズ：失敗するテストを書く</li>
<li>GREEN フェーズ：テストを通す最小限の実装</li>
<li>
<p>テストファーストで機能を構築</p>
</li>
<li>
<p><strong>タプルによる複数戻り値</strong>：</p>
</li>
<li><code>Board * int * int</code> で最終盤面、連鎖数、ボーナススコアを返す</li>
<li>パターンマッチングで分解して利用</li>
<li>
<p>F# の簡潔な複数値の扱い</p>
</li>
<li>
<p><strong>条件分岐によるボーナス加算</strong>：</p>
</li>
<li>if 式による全消しチェック</li>
<li>全消しの場合のみボーナス加算</li>
<li>
<p>不変性を保ちながら状態更新</p>
</li>
<li>
<p><strong>Elmish.WPF のアーキテクチャ</strong>：</p>
</li>
<li>Model-View-Update パターンの活用</li>
<li>イミュータブルなモデル更新</li>
<li>
<p>副作用のない純粋関数</p>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
</li>
<li>全消しになるケースとならないケースの両方をテスト</li>
<li>統合テストで全体の動作を保証</li>
<li>CI パイプラインで品質を継続的に確認</li>
</ol>
<p>このイテレーションで、全消しボーナスという特別な報酬システムが実装できました。次のイテレーションでは、ゲームの終了条件となるゲームオーバー判定を実装していきます！</p>
<h2 id="9">イテレーション9: ゲームオーバーの実装<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>「ゲームが終わる条件も必要ですよね？」そうですね！どんなゲームにも終わりがあります。ぷよぷよでは、新しいぷよを配置できなくなったときにゲームオーバーとなります。今回は、そのゲームオーバー判定と演出を実装していきましょう！</p>
<h3 id="_66">ユーザーストーリー<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。ゲームオーバーになったことを明確に伝え、適切な演出を行うことで、プレイヤーに達成感や次回への意欲を持ってもらうことができます。</p>
<h3 id="todo_7">TODOリスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODO リストを作成してみましょう。</p>
<p>「ゲームオーバーを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出する）</li>
<li>ゲームオーバー状態を Model に追加する（ゲーム状態の管理）</li>
<li>ゲームオーバー演出を実装する（ゲームオーバー時に特別な表示を追加する）</li>
<li>リスタート機能を実装する（ゲームオーバー後に新しいゲームを始められるようにする）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_67">テスト: ゲームオーバー判定<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバー判定をテストしましょう。新しいぷよを配置できない状態を検出する機能が必要です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/GameLogicTests.fs（新規作成）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests.GameLogicTests</span>

<span class="k">open</span><span class="w"> </span><span class="nn">Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">FsUnit.Xunit</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Domain.Board</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Domain.PuyoPair</span>
<span class="k">open</span><span class="w"> </span><span class="nn">PuyoPuyo.WPF.Domain.GameLogic</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``新しいぷよを配置できない場合、ゲームオーバーになる``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ボードの上部（新しいぷよが配置される位置）にぷよを配置</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよペア（通常は x=2, y=0 と x=2, y=1 に配置される）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになっていることを確認</span>
<span class="w">    </span><span class="n">isGameOver</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">true</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``新しいぷよを配置できる場合、ゲームオーバーにならない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// 空のボード</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">    </span><span class="c1">// 新しいぷよペア</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span>

<span class="w">    </span><span class="c1">// ゲームオーバーにならないことを確認</span>
<span class="w">    </span><span class="n">isGameOver</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>新しいぷよの配置位置にすでにぷよがある場合、ゲームオーバーと判定されるか</li>
<li>新しいぷよの配置位置が空の場合、ゲームオーバーにならないか</li>
</ol>
<p>「最初のテストでは、ボードの上部にぷよを配置しているんですね？」そうです！新しいぷよが配置される位置（x=2, y=0 など）にすでにぷよがあると、新しいぷよを配置できないため、ゲームオーバーと判定されるはずです。</p>
<p>「なるほど、ゲームオーバー判定の条件がよく分かりますね！」では、このテストが通るように実装していきましょう。</p>
<h3 id="_68">実装: ゲームオーバー判定<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームオーバー判定を実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/GameLogic.fs（続き）</span>

<span class="k">module</span><span class="w"> </span><span class="nn">GameLogic</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="sd">/// ゲームオーバー判定（新しいぷよを配置できるかチェック）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">checkGameOver</span><span class="w"> </span><span class="o">(</span><span class="n">board</span><span class="o">:</span><span class="w"> </span><span class="n">Board</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">newPiece</span><span class="o">:</span><span class="w"> </span><span class="n">PuyoPair</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="c1">// 新しいぷよが配置できない場合はゲームオーバー</span>
<span class="w">        </span><span class="ow">not</span><span class="w"> </span><span class="o">(</span><span class="n">canPlacePuyoPair</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span><span class="o">)</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。ゲームオーバー判定の実装自体はとてもシンプルです。既存の <code>canPlacePuyoPair</code> 関数を利用して、新しいぷよが配置できるかをチェックし、配置できない場合はゲームオーバーと判定します。</p>
<p>「<code>canPlacePuyoPair</code> をそのまま使えるんですね！」その通りです！<code>canPlacePuyoPair</code> は、ぷよペアが配置可能かどうかを判定する関数で、これまでの実装で既に存在しています。この関数が <code>false</code> を返す場合（配置できない）、それは新しいぷよを置けない、つまりゲームオーバーということになります。</p>
<h3 id="gamestatus-gameover">GameStatus への GameOver 追加<a class="headerlink" href="#gamestatus-gameover" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー状態を表すために、<code>GameStatus</code> 型に <code>GameOver</code> を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Domain/GameStatus.fs（修正）</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo</span><span class="p">.</span><span class="nn">WPF</span><span class="p">.</span><span class="n">Domain</span>

<span class="k">type</span><span class="w"> </span><span class="nc">GameStatus</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GameOver</span><span class="w">  </span><span class="c1">// ← 追加</span>
</code></pre></div>
<h3 id="message-restart">Message への Restart 追加<a class="headerlink" href="#message-restart" title="Permanent link">&para;</a></h3>
<p>リスタート機能のために、新しいメッセージを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の Message 型を修正</span>

<span class="k">type</span><span class="w"> </span><span class="nc">Message</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveLeft</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveRight</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">MoveDown</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Rotate</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartFastFall</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StopFastFall</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Restart</span><span class="w">  </span><span class="c1">// ← 追加</span>
</code></pre></div>
<h3 id="update_10">update 関数の修正<a class="headerlink" href="#update_10" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー判定とリスタート処理を update 関数に追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の update 関数を修正</span>

<span class="k">let</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">StartGame</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Restart</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ゲームを初期状態に戻す</span>
<span class="w">        </span><span class="n">init</span><span class="w"> </span><span class="bp">()</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">tryMovePuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">movedPiece</span><span class="w"> </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="c1">// 着地処理</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">boardWithPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">fixPuyoPair</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">piece</span>

<span class="w">                </span><span class="c1">// 連鎖処理（消去と重力を繰り返し適用）</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">boardAfterChain</span><span class="o">,</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">clearAndApplyGravityRepeatedly</span><span class="w"> </span><span class="n">boardWithPuyo</span>

<span class="w">                </span><span class="c1">// 全消しの場合はボーナス加算</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">newScore</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">isZenkeshi</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="nn">Score</span><span class="p">.</span><span class="n">addZenkeshiBonus</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Score</span>
<span class="w">                    </span><span class="k">else</span>
<span class="w">                        </span><span class="n">model</span><span class="o">.</span><span class="n">Score</span>

<span class="w">                </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">nextPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">createRandom</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>

<span class="w">                </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">boardAfterChain</span><span class="w"> </span><span class="n">nextPiece</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">isGameOver</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1">// ゲームオーバー</span>
<span class="w">                    </span><span class="o">{</span>
<span class="w">                        </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterChain</span>
<span class="w">                            </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">                            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newScore</span>
<span class="w">                            </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameOver</span>
<span class="w">                    </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// ゲーム続行</span>
<span class="w">                    </span><span class="o">{</span>
<span class="w">                        </span><span class="n">model</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boardAfterChain</span>
<span class="w">                            </span><span class="n">CurrentPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">nextPiece</span>
<span class="w">                            </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newScore</span>
<span class="w">                    </span><span class="o">},</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="c1">// ゲームオーバー時は何もしない</span>
<span class="w">        </span><span class="n">model</span><span class="o">,</span><span class="w"> </span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>

<span class="w">    </span><span class="c1">// ... 既存のコード（MoveLeft, MoveRight, Rotate, MoveDown, StartFastFall, StopFastFall）...</span>
</code></pre></div>
<p>「ゲームオーバーになったら、CurrentPiece を None にするんですね！」そうです。ゲームオーバー時は、新しいぷよを配置できないため、<code>CurrentPiece</code> を <code>None</code> にします。また、Status を <code>GameOver</code> に変更することで、ゲームループが停止します。</p>
<h3 id="subscription">Subscription の修正<a class="headerlink" href="#subscription" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー時はタイマーを停止するように修正します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の Subscription.gameTimer を修正</span>

<span class="k">module</span><span class="w"> </span><span class="nn">Subscription</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">gameTimer</span><span class="w"> </span><span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Sub</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Playing</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">IsFastFalling</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">100</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">1000</span><span class="o">.</span><span class="mi">0</span>
<span class="w">            </span><span class="k">let</span><span class="w"> </span><span class="nv">sub</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nn">System</span><span class="p">.</span><span class="nn">Timers</span><span class="p">.</span><span class="n">Timer</span><span class="o">(</span><span class="n">interval</span><span class="o">)</span>
<span class="w">                </span><span class="n">timer</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Tick</span><span class="o">)</span>
<span class="w">                </span><span class="n">timer</span><span class="o">.</span><span class="n">Start</span><span class="bp">()</span>
<span class="w">                </span><span class="o">{</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IDisposable</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="k">member</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="nf">Dispose</span><span class="bp">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="o">.</span><span class="n">Stop</span><span class="bp">()</span><span class="o">;</span><span class="w"> </span><span class="n">timer</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="o">[</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s">&quot;gameTimer&quot;</span><span class="w"> </span><span class="o">],</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="bp">[]</span><span class="w">  </span><span class="c1">// GameOver 時はタイマーなし</span>
</code></pre></div>
<p>「Status が Playing のときだけタイマーが動くんですね！」そうです。ゲームオーバー時は、Status が <code>GameOver</code> になるため、タイマーが停止し、Tick メッセージが送られなくなります。</p>
<h3 id="view_4">View への統合<a class="headerlink" href="#view_4" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー演出と リスタートボタンを view に追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/PuyoPuyo.WPF/Main.fs の view 関数を修正</span>

<span class="k">let</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;font-family: monospace; text-align: center; padding: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="n">h1</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ&quot;</span><span class="w"> </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// スコア表示</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-bottom: 10px; font-size: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">text</span><span class="w"> </span><span class="o">$</span><span class="s">&quot;Score: {model.Score.Value}&quot;</span>
<span class="w">        </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// ゲームオーバー表示</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-bottom: 20px; font-size: 30px; color: red; font-weight: bold;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;GAME OVER&quot;</span>
<span class="w">            </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// ゲームボード</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;display: inline-block; border: 2px solid black; background-color: #f0f0f0;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="o">.</span><span class="n">Rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;display: flex;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="o">.</span><span class="n">Cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">getCell</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Board</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">match</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Empty</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;white&quot;</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Filled</span><span class="w"> </span><span class="n">puyoColor</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="k">match</span><span class="w"> </span><span class="n">puyoColor</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>

<span class="w">                        </span><span class="c1">// 現在のぷよペアを描画（ゲームオーバー時は表示しない）</span>
<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">isPuyoPair</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="o">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">Playing</span><span class="o">,</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                                </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span>
<span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">false</span>

<span class="w">                        </span><span class="k">let</span><span class="w"> </span><span class="nv">finalColor</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="n">isPuyoPair</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="k">match</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">CurrentPiece</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">piece</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                    </span><span class="k">let</span><span class="w"> </span><span class="o">(</span><span class="n">pos1</span><span class="o">,</span><span class="w"> </span><span class="n">pos2</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PuyoPair</span><span class="p">.</span><span class="n">getPositions</span><span class="w"> </span><span class="n">piece</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos1</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                        </span><span class="k">match</span><span class="w"> </span><span class="n">piece</span><span class="o">.</span><span class="n">Puyo1Color</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>
<span class="w">                                    </span><span class="k">elif</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos2</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                        </span><span class="k">match</span><span class="w"> </span><span class="n">piece</span><span class="o">.</span><span class="n">Puyo2Color</span><span class="w"> </span><span class="k">with</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;blue&quot;</span>
<span class="w">                                        </span><span class="o">|</span><span class="w"> </span><span class="n">Yellow</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span>
<span class="w">                                    </span><span class="k">else</span>
<span class="w">                                        </span><span class="n">color</span>
<span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">color</span>
<span class="w">                            </span><span class="k">else</span>
<span class="w">                                </span><span class="n">color</span>

<span class="w">                        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span>
<span class="w">                            </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="o">$</span><span class="s">&quot;width: 30px; height: 30px; border: 1px solid #ccc; background-color: {finalColor};&quot;</span>
<span class="w">                        </span><span class="o">]</span><span class="w"> </span><span class="bp">[]</span>
<span class="w">                </span><span class="o">]</span>
<span class="w">        </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// リスタートボタン（ゲームオーバー時のみ表示）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameOver</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-top: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">                </span><span class="n">button</span><span class="w"> </span><span class="o">[</span>
<span class="w">                    </span><span class="n">on</span><span class="o">.</span><span class="n">click</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">Restart</span><span class="o">)</span>
<span class="w">                    </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;padding: 10px 20px; font-size: 16px; cursor: pointer;&quot;</span>
<span class="w">                </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;Restart&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">            </span><span class="o">]</span>

<span class="w">        </span><span class="c1">// 操作説明</span>
<span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">attr</span><span class="o">.</span><span class="n">style</span><span class="w"> </span><span class="s">&quot;margin-top: 20px;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;← → : 移動&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↑ : 回転&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="s">&quot;↓ : 高速落下&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">        </span><span class="o">]</span>
<span class="w">    </span><span class="o">]</span>
</code></pre></div>
<p>「ゲームオーバー時には "GAME OVER" と表示されて、リスタートボタンが出るんですね！」そうです。プレイヤーにゲームが終了したことを明確に伝え、新しいゲームを始めるためのボタンを提供します。</p>
<h3 id="_69">テスト実行<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストは通りましたか？」はい！ゲームオーバー判定のテストを含めて、全てのテストがパスしました。</p>
<h3 id="_70">統合テスト<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー機能が正しく動作することを確認する統合テストを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// tests/PuyoPuyo.Tests/GameLogicTests.fs（続き）</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよペアの回転位置も考慮してゲームオーバー判定する``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ボードの上部にぷよを配置</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span><span class="w">  </span><span class="c1">// 回転後の位置にぷよがある</span>

<span class="w">    </span><span class="c1">// 縦向きのぷよペア（Rotation = 0 なら y=0 と y=1 に配置される）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span>

<span class="w">    </span><span class="c1">// ゲームオーバーになっていることを確認</span>
<span class="w">    </span><span class="n">isGameOver</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">true</span>

<span class="o">[&lt;</span><span class="n">Fact</span><span class="o">&gt;]</span>
<span class="k">let</span><span class="w"> </span><span class="n">``ぷよが盤面の上部ギリギリでもゲームオーバーにならない``</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1">// ボードの下の方にぷよを配置</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nn">Board</span><span class="p">.</span><span class="n">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Board</span><span class="p">.</span><span class="n">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">(</span><span class="n">Filled</span><span class="w"> </span><span class="n">Red</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 新しいぷよペア（上部に配置される）</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">newPiece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo1Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Blue</span><span class="o">;</span><span class="w"> </span><span class="n">Puyo2Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Green</span><span class="o">;</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">isGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GameLogic</span><span class="p">.</span><span class="n">checkGameOver</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">newPiece</span>

<span class="w">    </span><span class="c1">// ゲームオーバーにならないことを確認</span>
<span class="w">    </span><span class="n">isGameOver</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="k">false</span>
</code></pre></div>
<p>「これらのテストは何を確認しているんですか？」これらのテストでは、以下を確認しています：</p>
<ol>
<li><strong>回転位置の考慮</strong>：ぷよペアの回転状態（Rotation）も考慮してゲームオーバー判定が行われるか</li>
<li><strong>境界条件</strong>：盤面の上部ギリギリにぷよがあってもゲームオーバーにならないか</li>
</ol>
<p>「なるほど、<code>canPlacePuyoPair</code> が回転も考慮するから、自動的に正しく判定されるんですね！」そうです。既存の関数を再利用することで、複雑なロジックを書かずに正確な判定ができています。</p>
<h3 id="_71">コミット<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>テストが全て通ったら、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">feat: implement game over detection and restart</span>

<span class="s">- Add checkGameOver function to GameLogic module</span>
<span class="s">- Add GameOver state to GameStatus type</span>
<span class="s">- Add Restart message for restarting the game</span>
<span class="s">- Update update function to check game over after landing</span>
<span class="s">- Stop game timer when status is GameOver</span>
<span class="s">- Add &quot;GAME OVER&quot; display to view</span>
<span class="s">- Add restart button that appears on game over</span>
<span class="s">- Add tests for game over detection (4 tests)</span>
<span class="s">- All tests passing (67 tests)</span>

<span class="s">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;</span>
<span class="s">EOF</span>
<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="9_1">イテレーション９のまとめ<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>ゲームオーバー判定の実装</strong>：</li>
<li>既存の <code>canPlacePuyoPair</code> 関数を再利用</li>
<li>シンプルなロジックで確実な判定を実現</li>
<li>
<p>回転状態も自動的に考慮される</p>
</li>
<li>
<p><strong>GameStatus の拡張</strong>：</p>
</li>
<li><code>GameOver</code> 状態を追加</li>
<li>判別共用体による安全な状態管理</li>
<li>
<p>パターンマッチングで状態に応じた処理</p>
</li>
<li>
<p><strong>Elmish のメッセージ追加</strong>：</p>
</li>
<li><code>Restart</code> メッセージでゲームリセット</li>
<li><code>init ()</code> を呼び出して初期状態に戻す</li>
<li>
<p>シンプルなリスタート実装</p>
</li>
<li>
<p><strong>Subscription の制御</strong>：</p>
</li>
<li>Status に応じてタイマーを制御</li>
<li>GameOver 時はタイマーを停止</li>
<li>
<p>リソースの適切な管理</p>
</li>
<li>
<p><strong>View の条件分岐</strong>：</p>
</li>
<li>if 式によるゲームオーバー表示</li>
<li>Status に応じた UI の切り替え</li>
<li>
<p>リスタートボタンの表示制御</p>
</li>
<li>
<p><strong>テスト駆動開発の継続</strong>：</p>
</li>
<li>ゲームオーバーになるケースとならないケースをテスト</li>
<li>回転位置を考慮したテスト</li>
<li>
<p>境界条件のテスト</p>
</li>
<li>
<p><strong>F# の表現力</strong>：</p>
</li>
<li>判別共用体による状態管理</li>
<li>パターンマッチングによる分岐</li>
<li>if 式による条件付き View 要素</li>
</ol>
<p>このイテレーションで、ゲームオーバー判定とリスタート機能が実装できました。これで、ぷよぷよゲームの基本的な機能が完成しました！</p>
<h2 id="f-elmishwpf_1">まとめ: F# と Elmish.WPF で学ぶテスト駆動開発<a class="headerlink" href="#f-elmishwpf_1" title="Permanent link">&para;</a></h2>
<p>「ついに完成しましたね!」そうです!イテレーション 0 から 9 まで、一緒にぷよぷよゲームを作ってきました。お疲れ様でした!このチュートリアルを通じて、F# と Elmish.WPF を使ったテスト駆動開発の実践を学んできました。</p>
<h3 id="elmishwpf_3">Elmish.WPF の強み<a class="headerlink" href="#elmishwpf_3" title="Permanent link">&para;</a></h3>
<p>このチュートリアルを通じて、Elmish.WPF の強みを実感できたと思います:</p>
<p><strong>デスクトップアプリケーション開発</strong>:
- ネイティブな Windows アプリケーション
- WPF の成熟した UI コントロール
- ハードウェアアクセラレーション</p>
<p><strong>XAML との統合</strong>:
- 宣言的な UI 定義
- データバインディングによる自動更新
- デザイナーとの分業が可能</p>
<p><strong>Elmish アーキテクチャ</strong>:
- シンプルな状態管理
- 予測可能な動作
- デバッグのしやすさ</p>
<h3 id="bolero">Bolero 版との比較<a class="headerlink" href="#bolero" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>観点</th>
<th>Bolero 版</th>
<th>Elmish.WPF 版</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>実行環境</strong></td>
<td>ブラウザ(WebAssembly)</td>
<td>Windows デスクトップ</td>
</tr>
<tr>
<td><strong>UI定義</strong></td>
<td>Bolero.Html(F#コード)</td>
<td>XAML</td>
</tr>
<tr>
<td><strong>イベント処理</strong></td>
<td>on.click, on.keydown</td>
<td>Command バインディング</td>
</tr>
<tr>
<td><strong>スタイル</strong></td>
<td>CSS</td>
<td>XAML Resources/Styles</td>
</tr>
<tr>
<td><strong>配布</strong></td>
<td>Web サーバー</td>
<td>インストーラー/実行ファイル</td>
</tr>
<tr>
<td><strong>起動速度</strong></td>
<td>初回ロード時間あり</td>
<td>即座に起動</td>
</tr>
</tbody>
</table>
<p><strong>Elmish.WPF 版の利点</strong>:
- デスクトップアプリケーションとして配布可能
- WPF の豊富な UI コントロール
- ネイティブなパフォーマンス
- オフラインでの動作</p>
<p><strong>Bolero 版の利点</strong>:
- クロスプラットフォーム(ブラウザがあれば動く)
- インストール不要
- Web での配布が容易</p>
<p>このチュートリアルが、あなたのソフトウェア開発の旅の一助となれば幸いです。Happy coding!</p>
<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>