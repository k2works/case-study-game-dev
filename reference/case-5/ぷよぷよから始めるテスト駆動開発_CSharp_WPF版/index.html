
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="テスト駆動開発の手法を用いてC# WPFでぷよぷよゲームを実装する過程を解説">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発 C# WPF版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#c-wpf" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発 C# WPF版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="c-wpf">ぷよぷよから始めるテスト駆動開発 C# WPF版<a class="headerlink" href="#c-wpf" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、C# WPF（Windows Presentation Foundation）でぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テスト駆動開発とは、プログラミングの手法の一種で、「テストファースト」の原則に従い、実装前にテストを書くことで、コードの品質を高め、設計を改善していく開発手法です。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの？」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の3つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>テスト駆動開発のリズム：赤、緑、リファクタリング。まず失敗するテストを書き（赤）、次にテストが通るようにする（緑）、そして重複を除去する（リファクタリング）。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>良いツールは良い仕事の第一歩です。適切な道具を選ぶことで、開発の効率と品質が大きく向上します。</p>
<p>— Andrew Hunt &amp; David Thomas 『達人プログラマー』</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>言語</strong>: C# — 「.NETって難しそう...」と思われるかもしれませんが、C#は強力な型システムと豊富なライブラリにより、大規模な開発でもバグを減らしやすくなるんです。</li>
<li><strong>フレームワーク</strong>: WPF（Windows Presentation Foundation）— 「デスクトップアプリって今更？」と思われるかもしれませんが、WPFは強力なデータバインディングとXAMLによる宣言的UI定義により、保守性の高いデスクトップアプリケーションを作成できます。</li>
<li><strong>アーキテクチャパターン</strong>: MVVM（Model-View-ViewModel）— WPFの強力なデータバインディング機能を最大限に活用するアーキテクチャパターンです。</li>
<li><strong>テストフレームワーク</strong>: xUnit — .NETエコシステムで広く使われている信頼性の高いテストフレームワークです。テスト駆動開発には欠かせないツールですね。</li>
<li><strong>コードカバレッジ</strong>: Coverlet — テストがどれだけコードをカバーしているかを可視化してくれます。「どこをテストすべき？」という疑問に答えてくれますよ。</li>
<li><strong>静的コード解析</strong>: Microsoft.CodeAnalysis.Analyzers — コードの品質を自動的にチェックし、潜在的な問題を早期に発見してくれます。</li>
<li><strong>コードフォーマッタ</strong>: dotnet format — 「チーム内でコーディングスタイルが統一されていない...」そんな悩みを解決してくれます。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ？昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが、今回のイテレーション0では、その環境構築についてしっかり解説していきますね！</p>
<h2 id="_4">要件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">ユーザーストーリー<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書き始める前に、少し立ち止まって考えてみましょう。「何を作るのか？」という基本的な問いかけです。私たちが作るぷよぷよゲームは、どのような機能を持つべきでしょうか？</p>
<p>アジャイル開発では、この「何を作るのか？」という問いに対して、「ユーザーストーリー」という形で答えを出します。皆さんは「ユーザーストーリー」という言葉を聞いたことがありますか？</p>
<blockquote>
<p>ユーザーストーリーとは、ソフトウェアの機能を「誰が」「何を」「なぜ」したいのかという形式で表現したものです。これにより、開発チームは常にユーザーの視点を忘れずに開発を進めることができます。</p>
<p>— Mike Cohn 『User Stories Applied』</p>
</blockquote>
<p>つまり、「プレイヤーとして、〇〇ができる（〇〇したいから）」という形式で機能を表現するんです。これによって、「誰のため」の「どんな機能」を「なぜ」作るのかが明確になります。素晴らしいですよね！</p>
<p>では、私たちのぷよぷよゲームでは、どんなユーザーストーリーが考えられるでしょうか？一緒に考えてみましょう：</p>
<ul>
<li>プレイヤーとして、新しいゲームを開始できる（ゲームの基本機能として必要ですよね！）</li>
<li>プレイヤーとして、落ちてくるぷよを左右に移動できる（ぷよを適切な位置に配置したいですよね）</li>
<li>プレイヤーとして、落ちてくるぷよを回転できる（戦略的にぷよを配置するために必要です）</li>
<li>プレイヤーとして、ぷよを素早く落下させることができる（「早く次のぷよを落としたい！」というときのために）</li>
<li>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる（これがぷよぷよの醍醐味ですよね！）</li>
<li>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる（「れ〜んさ〜ん！」と叫びたくなりますよね）</li>
<li>プレイヤーとして、全消し（ぜんけし）ボーナスを獲得できる（「やった！全部消えた！」という達成感を味わいたいですよね）</li>
<li>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる（終わりが明確でないとモヤモヤしますよね）</li>
<li>プレイヤーとして、現在のスコアを確認できる（「今どれくらい点数取れてるかな？」と気になりますよね）</li>
<li>プレイヤーとして、キーボードでぷよを操作できる（PCでプレイするなら必須ですよね）</li>
</ul>
<p>「うわ、結構たくさんあるな...」と思われるかもしれませんが、心配いりません！これらのユーザーストーリーを一つずつ実装していくことで、徐々にゲームを完成させていきましょう。テスト駆動開発の素晴らしいところは、各ストーリーを小さなタスクに分解し、テスト→実装→リファクタリングのサイクルで少しずつ進められることなんです。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_6">ユースケース図<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>ユーザーストーリーを整理したところで、「これらの機能がどのように関連しているのか、全体像が見えるといいな」と思いませんか？そんなときに役立つのが「ユースケース図」です。</p>
<p>「ユースケース図って何？」と思われるかもしれませんね。ユースケース図は、システムと外部アクター（ここではプレイヤーとシステム自体）の相互作用を視覚的に表現するための図です。「絵に描いて整理すると分かりやすい」というやつですね。</p>
<blockquote>
<p>ユースケース図は、システムが外部に提供する機能と、それを利用するアクターとの関係を表現します。これにより、システムの境界と責任範囲が明確になります。</p>
<p>— Martin Fowler 『UMLモデリングのエッセンス』</p>
</blockquote>
<p>「百聞は一見にしかず」というように、実際に見てみるのが一番分かりやすいですよね。では、私たちのぷよぷよゲームのユースケース図を見てみましょう：</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjU3OHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODI2cHg7aGVpZ2h0OjU3OHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgyNiA1NzgiIHdpZHRoPSI4MjZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjU2NSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxNS4wNyIgeD0iMTEyIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1My45OTkzIiB4PSIzNDIuNTM1MyIgeT0iMjEuOTk1MSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MDc7JiMxMjQyNDsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3RhcnROZXdHYW1lIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfU3RhcnROZXdHYW1lIj48ZWxsaXBzZSBjeD0iMjE0LjAyNTkiIGN5PSI1MjkuOTk1MiIgZmlsbD0iI0YxRjFGMSIgcng9Ijc4LjAyNTkiIHJ5PSIxOC4wMDUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iMTUxLjAyNjIiIHk9IjUzNC42NDM2Ij4mIzI2MDMyOyYjMTIzNzU7JiMxMjM1NjsmIzEyNDY2OyYjMTI1NDA7JiMxMjUxMjsmIzEyNDM0OyYjMzgyODM7JiMyMjk4Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVzdGFydEdhbWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9SZXN0YXJ0R2FtZSI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iNDU4Ljk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSI0NjMuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQzNDsmIzEyNTIyOyYjMTI0NzM7JiMxMjQ3OTsmIzEyNTQwOyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1vdmVQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfTW92ZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDMyNCIgY3k9IjEzMS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNTguMDMyNyIgeT0iMTM1LjY0ODkiPiYjMTI0MDc7JiMxMjQyNDsmIzEyNDM0OyYjMjQwMzg7JiMyMTQ5MTsmIzEyMzk1OyYjMzEyMjc7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUm90YXRlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSb3RhdGVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfUm90YXRlUHV5byI+PGVsbGlwc2UgY3g9IjIxNC4wMjczIiBjeT0iNjUuMDAzNiIgZmlsbD0iI0YxRjFGMSIgcng9IjUyLjQ5NzMiIHJ5PSIxNC41MjM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSIxNzkuMDI3NCIgeT0iNjkuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyMjIzODsmIzM2NTc4OzwvdGV4dD48L2c+PCEtLWVudGl0eSBRdWlja0Ryb3BQdXlvLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlF1aWNrRHJvcFB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjIwIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV9RdWlja0Ryb3BQdXlvIj48ZWxsaXBzZSBjeD0iMjE0LjAzMjQiIGN5PSIyMDAuMDAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjcyLjI1MjQiIHJ5PSIxNi44NTA1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMTU4LjAzMjciIHk9IjIwNC42NDg5Ij4mIzEyNDA3OyYjMTI0MjQ7JiMxMjQzNDsmIzMyMDMyOyYjMjYwODk7JiMxMjM2NzsmIzMzODUzOyYjMTk5Nzk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEVyYXNlUHV5by0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJFcmFzZVB1eW8iIGRhdGEtc291cmNlLWxpbmU9IjI1IiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9FcmFzZVB1eW8iPjxlbGxpcHNlIGN4PSIyMTQuMDI3MyIgY3k9IjI5My4wMDM2IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjE3OS4wMjc0IiB5PSIyOTcuNjUyMSI+JiMxMjQwNzsmIzEyNDI0OyYjMTI0MzQ7JiMyODA0MDsmIzIxNDM1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBDaGFpblJlYWN0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkNoYWluUmVhY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9DaGFpblJlYWN0aW9uIj48ZWxsaXBzZSBjeD0iNDM2LjAzNTIiIGN5PSIyNTYuOTk1IiBmaWxsPSIjRjFGMUYxIiByeD0iNjYuNzI1MiIgcnk9IjE1Ljc0NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMzg3LjAzNTQiIHk9IjI2MS42NDM1Ij4mIzM2ODk5OyYjMzc3ODI7JiMyMTQ1MzsmIzI0NTQwOyYjMTI0MzQ7JiMzMDMzMDsmIzI5OTgzOzwvdGV4dD48L2c+PCEtLWVudGl0eSBaZW5rZXNoaUJvbnVzLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ilplbmtlc2hpQm9udXMiIGRhdGEtc291cmNlLWxpbmU9IjI3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9aZW5rZXNoaUJvbnVzIj48ZWxsaXBzZSBjeD0iNDM2LjA0MzEiIGN5PSIzMjYuOTk4NiIgZmlsbD0iI0YxRjFGMSIgcng9IjgzLjk5MzEiIHJ5PSIxOS4xOTg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iMzY2LjA0MzQiIHk9IjMzMS42NDcxIj4mIzIwODQwOyYjMjgwNDA7JiMxMjM3NTsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ5MDsmIzEyNDczOyYjMTI0MzQ7JiMyOTU1NDsmIzI0NDcxOzwvdGV4dD48L2c+PCEtLWVudGl0eSBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSIyOCIgZGF0YS11aWQ9ImVudDAwMTMiIGlkPSJlbnRpdHlfRGlzcGxheVNjb3JlIj48ZWxsaXBzZSBjeD0iNjQxLjU1NDIiIGN5PSIyNTYuMDAyOCIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1OTkuNTU0NCIgeT0iMjYwLjY1MTMiPiYjMTI0NzM7JiMxMjQ2NzsmIzEyNDUwOyYjMTI0MzQ7JiMzNDkyMDsmIzMxMDM0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBLZXlib2FyZENvbnRyb2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSIzMyIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJlbnRpdHlfS2V5Ym9hcmRDb250cm9sIj48ZWxsaXBzZSBjeD0iNDM2LjA0MjQiIGN5PSI5OS4wMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNzIuMjUyNCIgcnk9IjE2Ljg1MDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIzODAuMDQyNyIgeT0iMTAzLjY0ODkiPiYjMTI0NjE7JiMxMjU0MDsmIzEyNTA4OyYjMTI1NDA7JiMxMjQ4OTsmIzEyMzkxOyYjMjU4MDU7JiMyMDMxNjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgR2FtZU92ZXJDaGVjay0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHYW1lT3ZlckNoZWNrIiBkYXRhLXNvdXJjZS1saW5lPSIzOCIgZGF0YS11aWQ9ImVudDAwMTUiIGlkPSJlbnRpdHlfR2FtZU92ZXJDaGVjayI+PGVsbGlwc2UgY3g9IjIxNC4wMjU5IiBjeT0iMzg3Ljk5NTIiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjE1MS4wMjYyIiB5PSIzOTIuNjQzNiI+JiMxMjQ2NjsmIzEyNTQwOyYjMTI1MTI7JiMxMjQ1ODsmIzEyNTQwOyYjMTI0OTY7JiMxMjU0MDsmIzIxMDI4OyYjMjM0NTA7PC90ZXh0PjwvZz48IS0tZW50aXR5IEdhbWVPdmVyQW5pbWF0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSIzOSIgZGF0YS11aWQ9ImVudDAwMTYiIGlkPSJlbnRpdHlfR2FtZU92ZXJBbmltYXRpb24iPjxlbGxpcHNlIGN4PSI0MzYuMDM1OSIgY3k9IjM5OC45OTUyIiBmaWxsPSIjRjFGMUYxIiByeD0iNzguMDI1OSIgcnk9IjE4LjAwNTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIzNzMuMDM2MiIgeT0iNDAzLjY0MzYiPiYjMTI0NjY7JiMxMjU0MDsmIzEyNTEyOyYjMTI0NTg7JiMxMjU0MDsmIzEyNDk2OyYjMTI1NDA7JiMyODQzNjsmIzIwOTg2OzwvdGV4dD48L2c+PCEtLWVudGl0eSBQbGF5ZXItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUGxheWVyIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImVudGl0eV9QbGF5ZXIiPjxlbGxpcHNlIGN4PSI0MC45OTk4IiBjeT0iMTM2LjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik00MC45OTk4LDE0NC4zNSBMNDAuOTk5OCwxNzEuMzUgTTI3Ljk5OTgsMTUyLjM1IEw1My45OTk4LDE1Mi4zNSBNNDAuOTk5OCwxNzEuMzUgTDI3Ljk5OTgsMTg2LjM1IE00MC45OTk4LDE3MS4zNSBMNTMuOTk5OCwxODYuMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjYiIHk9IjIwMC44NDUxIj4mIzEyNTAzOyYjMTI1MjQ7JiMxMjQ1MjsmIzEyNTE2OyYjMTI1NDA7PC90ZXh0PjwvZz48IS0tZW50aXR5IFN5c3RlbS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X1N5c3RlbSI+PGVsbGlwc2UgY3g9Ijc5MS4wNjk5IiBjeT0iNDAxLjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik03OTEuMDY5OSw0MDkuMzUgTDc5MS4wNjk5LDQzNi4zNSBNNzc4LjA2OTksNDE3LjM1IEw4MDQuMDY5OSw0MTcuMzUgTTc5MS4wNjk5LDQzNi4zNSBMNzc4LjA2OTksNDUxLjM1IE03OTEuMDY5OSw0MzYuMzUgTDgwNC4wNjk5LDQ1MS4zNSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iNzYzLjA3IiB5PSI0NjUuODQ1MSI+JiMxMjQ3MTsmIzEyNDczOyYjMTI0ODY7JiMxMjUxMjs8L3RleHQ+PC9nPjwhLS1saW5rIFBsYXllciB0byBTdGFydE5ld0dhbWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJTdGFydE5ld0dhbWUiIGRhdGEtc291cmNlLWxpbmU9IjQ0IiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rX1BsYXllcl9TdGFydE5ld0dhbWUiPjxwYXRoIGQ9Ik0yOS4wNywyMDQuNjEgQzI5LjA3LDI5OC4yOSAyOS4wNyw1MzAgMjkuMDcsNTMwIEMyOS4wNyw1MzAgNzkuMTgsNTMwIDEyOS41OSw1MzAiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tU3RhcnROZXdHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNTksNTMwLDEyNi41OSw1MjYsMTMwLjU5LDUzMCwxMjYuNTksNTM0LDEzNS41OSw1MzAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIFJlc3RhcnRHYW1lLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUmVzdGFydEdhbWUiIGRhdGEtc291cmNlLWxpbmU9IjQ1IiBkYXRhLXVpZD0ibG5rMTgiIGlkPSJsaW5rX1BsYXllcl9SZXN0YXJ0R2FtZSI+PHBhdGggZD0iTTUzLjA3LDIwNC42MSBDNTMuMDcsMjg0LjE3IDUzLjA3LDQ1OSA1My4wNyw0NTkgQzUzLjA3LDQ1OSA4OC44OSw0NTkgMTI5LjksNDU5IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJlc3RhcnRHYW1lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuOSw0NTksMTI2LjksNDU1LDEzMC45LDQ1OSwxMjYuOSw0NjMsMTM1LjksNDU5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBNb3ZlUHV5by0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJQbGF5ZXIiIGRhdGEtZW50aXR5LTI9Ik1vdmVQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSI0NiIgZGF0YS11aWQ9ImxuazE5IiBpZD0ibGlua19QbGF5ZXJfTW92ZVB1eW8iPjxwYXRoIGQ9Ik03Ni40MywxMzcuODUgQzk2LjksMTM3Ljg1IDExNy4zMSwxMzcuODUgMTQxLjUxLDEzNy44NSIgZmlsbD0ibm9uZSIgaWQ9IlBsYXllci10by1Nb3ZlUHV5byIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTQ3LjUxLDEzNy44NSwxMzguNTEsMTMzLjg1LDE0Mi41MSwxMzcuODUsMTM4LjUxLDE0MS44NSwxNDcuNTEsMTM3Ljg1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIFBsYXllciB0byBSb3RhdGVQdXlvLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iUm90YXRlUHV5byIgZGF0YS1zb3VyY2UtbGluZT0iNDciIGRhdGEtdWlkPSJsbmsyMCIgaWQ9ImxpbmtfUGxheWVyX1JvdGF0ZVB1eW8iPjxwYXRoIGQ9Ik0yOS4wNywxMjcuNTMgQzI5LjA3LDk4Ljk5IDI5LjA3LDY1IDI5LjA3LDY1IEMyOS4wNyw2NSAxMDAuODQsNjUgMTU1LjUyLDY1IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVJvdGF0ZVB1eW8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE2MS41Miw2NSwxNTIuNTIsNjEsMTU2LjUyLDY1LDE1Mi41Miw2OSwxNjEuNTIsNjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgUGxheWVyIHRvIFF1aWNrRHJvcFB1eW8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUGxheWVyIiBkYXRhLWVudGl0eS0yPSJRdWlja0Ryb3BQdXlvIiBkYXRhLXNvdXJjZS1saW5lPSI0OCIgZGF0YS11aWQ9ImxuazIxIiBpZD0ibGlua19QbGF5ZXJfUXVpY2tEcm9wUHV5byI+PHBhdGggZD0iTTc2LjQzLDE5My42NSBDOTYuNiwxOTMuNjUgMTE2LjU0LDE5My42NSAxNDAuNDUsMTkzLjY1IiBmaWxsPSJub25lIiBpZD0iUGxheWVyLXRvLVF1aWNrRHJvcFB1eW8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE0Ni40NSwxOTMuNjUsMTM3LjQ1LDE4OS42NSwxNDEuNDUsMTkzLjY1LDEzNy40NSwxOTcuNjUsMTQ2LjQ1LDE5My42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBQbGF5ZXIgdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlBsYXllciIgZGF0YS1lbnRpdHktMj0iS2V5Ym9hcmRDb250cm9sIiBkYXRhLXNvdXJjZS1saW5lPSI0OSIgZGF0YS11aWQ9ImxuazIyIiBpZD0ibGlua19QbGF5ZXJfS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNNTMuMDcsMTI3LjcxIEM1My4wNywxMTIuMzIgNTMuMDcsOTguMTUgNTMuMDcsOTguMTUgQzUzLjA3LDk4LjE1IDI0Ni41Myw5OC4xNSAzNTcuNTYsOTguMTUiIGZpbGw9Im5vbmUiIGlkPSJQbGF5ZXItdG8tS2V5Ym9hcmRDb250cm9sIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjMuNTYsOTguMTUsMzU0LjU2LDk0LjE1LDM1OC41Niw5OC4xNSwzNTQuNTYsMTAyLjE1LDM2My41Niw5OC4xNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIEVyYXNlUHV5byB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRXJhc2VQdXlvIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjUyIiBkYXRhLXVpZD0ibG5rMjMiIGlkPSJsaW5rX0VyYXNlUHV5b19TeXN0ZW0iPjxwYXRoIGQ9Ik0yNzIuNzksMjkzIEM0MTYuMzIsMjkzIDc5Ny4wNywyOTMgNzk3LjA3LDI5MyBDNzk3LjA3LDI5MyA3OTcuMDcsMzUxLjczIDc5Ny4wNywzOTIuNTYiIGZpbGw9Im5vbmUiIGlkPSJFcmFzZVB1eW8tYmFja3RvLVN5c3RlbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjY2Ljc5LDI5MywyNzUuNzksMjk3LDI3MS43OSwyOTMsMjc1Ljc5LDI4OSwyNjYuNzksMjkzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgQ2hhaW5SZWFjdGlvbiB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iQ2hhaW5SZWFjdGlvbiIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1MyIgZGF0YS11aWQ9ImxuazI0IiBpZD0ibGlua19DaGFpblJlYWN0aW9uX1N5c3RlbSI+PHBhdGggZD0iTTUwMy43MywyNjMuMzUgQzUzMC41OSwyNjMuMzUgNTUwLjA3LDI2My4zNSA1NTAuMDcsMjYzLjM1IEM1NTAuMDcsMjYzLjM1IDU1MC4wNyw0MDAuOSA1NTAuMDcsNDAwLjkgQzU1MC4wNyw0MDAuOSA2OTkuMzgsNDAwLjkgNzYyLjk1LDQwMC45IiBmaWxsPSJub25lIiBpZD0iQ2hhaW5SZWFjdGlvbi1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0OTcuNzMsMjYzLjM1LDUwNi43MywyNjcuMzUsNTAyLjczLDI2My4zNSw1MDYuNzMsMjU5LjM1LDQ5Ny43MywyNjMuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBaZW5rZXNoaUJvbnVzIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJaZW5rZXNoaUJvbnVzIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU0IiBkYXRhLXVpZD0ibG5rMjUiIGlkPSJsaW5rX1plbmtlc2hpQm9udXNfU3lzdGVtIj48cGF0aCBkPSJNNTI2LjUzLDMyNyBDNjI5LjgzLDMyNyA3ODUuMDcsMzI3IDc4NS4wNywzMjcgQzc4NS4wNywzMjcgNzg1LjA3LDM2Mi45NCA3ODUuMDcsMzkyLjU3IiBmaWxsPSJub25lIiBpZD0iWmVua2VzaGlCb251cy1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1MjAuNTMsMzI3LDUyOS41MywzMzEsNTI1LjUzLDMyNyw1MjkuNTMsMzIzLDUyMC41MywzMjciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBEaXNwbGF5U2NvcmUgdG8gU3lzdGVtLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkRpc3BsYXlTY29yZSIgZGF0YS1lbnRpdHktMj0iU3lzdGVtIiBkYXRhLXNvdXJjZS1saW5lPSI1NSIgZGF0YS11aWQ9ImxuazI2IiBpZD0ibGlua19EaXNwbGF5U2NvcmVfU3lzdGVtIj48cGF0aCBkPSJNNzA5LjU2LDI1NiBDNzU2LjksMjU2IDgwOC4wNywyNTYgODA4LjA3LDI1NiBDODA4LjA3LDI1NiA4MDguMDcsMzQxLjA4IDgwOC4wNywzOTIuNiIgZmlsbD0ibm9uZSIgaWQ9IkRpc3BsYXlTY29yZS1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MDMuNTYsMjU2LDcxMi41NiwyNjAsNzA4LjU2LDI1Niw3MTIuNTYsMjUyLDcwMy41NiwyNTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckNoZWNrIHRvIFN5c3RlbS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJHYW1lT3ZlckNoZWNrIiBkYXRhLWVudGl0eS0yPSJTeXN0ZW0iIGRhdGEtc291cmNlLWxpbmU9IjU2IiBkYXRhLXVpZD0ibG5rMjciIGlkPSJsaW5rX0dhbWVPdmVyQ2hlY2tfU3lzdGVtIj48cGF0aCBkPSJNMjc3Ljg1LDM3NS40OSBDNDIwLjk0LDM3NS40OSA3NzQuMDcsMzc1LjQ5IDc3NC4wNywzNzUuNDkgQzc3NC4wNywzNzUuNDkgNzc0LjA3LDM4Mi45OCA3NzQuMDcsMzkyLjQ1IiBmaWxsPSJub25lIiBpZD0iR2FtZU92ZXJDaGVjay1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNzEuODUsMzc1LjQ5LDI4MC44NSwzNzkuNDksMjc2Ljg1LDM3NS40OSwyODAuODUsMzcxLjQ5LDI3MS44NSwzNzUuNDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHYW1lT3ZlckFuaW1hdGlvbiB0byBTeXN0ZW0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR2FtZU92ZXJBbmltYXRpb24iIGRhdGEtZW50aXR5LTI9IlN5c3RlbSIgZGF0YS1zb3VyY2UtbGluZT0iNTciIGRhdGEtdWlkPSJsbmsyOCIgaWQ9ImxpbmtfR2FtZU92ZXJBbmltYXRpb25fU3lzdGVtIj48cGF0aCBkPSJNNTA3Ljk5LDQwOC45NSBDNTg2LjE5LDQwOC45NSA3MDYuOTksNDA4Ljk1IDc2Mi45Nyw0MDguOTUiIGZpbGw9Im5vbmUiIGlkPSJHYW1lT3ZlckFuaW1hdGlvbi1iYWNrdG8tU3lzdGVtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1MDEuOTksNDA4Ljk1LDUxMC45OSw0MTIuOTUsNTA2Ljk5LDQwOC45NSw1MTAuOTksNDA0Ljk1LDUwMS45OSw0MDguOTUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgTW92ZVB1eW8gdG8gS2V5Ym9hcmRDb250cm9sLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ik1vdmVQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjYwIiBkYXRhLXVpZD0ibG5rMjkiIGlkPSJsaW5rX01vdmVQdXlvX0tleWJvYXJkQ29udHJvbCI+PHBhdGggZD0iTTI3Ni4wNywxMjIuMDMgQzI3Ni4wNywxMTQuOTEgMjc2LjA3LDEwNi4xNSAyNzYuMDcsMTA2LjE1IEMyNzYuMDcsMTA2LjE1IDMxOS45OCwxMDYuMTUgMzY0LjA1LDEwNi4xNSIgZmlsbD0ibm9uZSIgaWQ9Ik1vdmVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzcwLjA1LDEwNi4xNSwzNjEuMDUsMTAyLjE1LDM2NS4wNSwxMDYuMTUsMzYxLjA1LDExMC4xNSwzNzAuMDUsMTA2LjE1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMTg1MSIgeD0iMjUzLjEyIiB5PSIxMDIuMjE2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBSb3RhdGVQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSb3RhdGVQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjYxIiBkYXRhLXVpZD0ibG5rMzAiIGlkPSJsaW5rX1JvdGF0ZVB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjE0LjA3LDc5LjkyIEMyMTQuMDcsODUuMzQgMjE0LjA3LDkwLjE1IDIxNC4wNyw5MC4xNSBDMjE0LjA3LDkwLjE1IDMwMS45Niw5MC4xNSAzNjcuNjIsOTAuMTUiIGZpbGw9Im5vbmUiIGlkPSJSb3RhdGVQdXlvLXRvLUtleWJvYXJkQ29udHJvbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzczLjYyLDkwLjE1LDM2NC42Miw4Ni4xNSwzNjguNjIsOTAuMTUsMzY0LjYyLDk0LjE1LDM3My42Miw5MC4xNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYxLjE4NTEiIHg9IjI4OS43MyIgeT0iODYuMjE2OSI+JiMxNzE7ZXh0ZW5kJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBRdWlja0Ryb3BQdXlvIHRvIEtleWJvYXJkQ29udHJvbC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJRdWlja0Ryb3BQdXlvIiBkYXRhLWVudGl0eS0yPSJLZXlib2FyZENvbnRyb2wiIGRhdGEtc291cmNlLWxpbmU9IjYyIiBkYXRhLXVpZD0ibG5rMzEiIGlkPSJsaW5rX1F1aWNrRHJvcFB1eW9fS2V5Ym9hcmRDb250cm9sIj48cGF0aCBkPSJNMjg2LjczLDIwMCBDMzUxLjQ5LDIwMCA0MzYuMDcsMjAwIDQzNi4wNywyMDAgQzQzNi4wNywyMDAgNDM2LjA3LDE1MC45NSA0MzYuMDcsMTIyLjEzIiBmaWxsPSJub25lIiBpZD0iUXVpY2tEcm9wUHV5by10by1LZXlib2FyZENvbnRyb2wiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQzNi4wNywxMTYuMTMsNDMyLjA3LDEyNS4xMyw0MzYuMDcsMTIxLjEzLDQ0MC4wNywxMjUuMTMsNDM2LjA3LDExNi4xMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYxLjE4NTEiIHg9IjM0MS4zMyIgeT0iMjEzLjA2NjkiPiYjMTcxO2V4dGVuZCYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgRXJhc2VQdXlvIHRvIENoYWluUmVhY3Rpb24tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iRXJhc2VQdXlvIiBkYXRhLWVudGl0eS0yPSJDaGFpblJlYWN0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI2NSIgZGF0YS11aWQ9ImxuazMyIiBpZD0ibGlua19FcmFzZVB1eW9fQ2hhaW5SZWFjdGlvbiI+PHBhdGggZD0iTTIxNC4wNywyNzguMzYgQzIxNC4wNywyNjguMzkgMjE0LjA3LDI1NyAyMTQuMDcsMjU3IEMyMTQuMDcsMjU3IDI5Ny41MSwyNTcgMzYyLjg0LDI1NyIgZmlsbD0ibm9uZSIgaWQ9IkVyYXNlUHV5by10by1DaGFpblJlYWN0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjguODQsMjU3LDM1OS44NCwyNTMsMzYzLjg0LDI1NywzNTkuODQsMjYxLDM2OC44NCwyNTciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIyMTYuNzciIHk9IjI3MC4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBDaGFpblJlYWN0aW9uIHRvIERpc3BsYXlTY29yZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJDaGFpblJlYWN0aW9uIiBkYXRhLWVudGl0eS0yPSJEaXNwbGF5U2NvcmUiIGRhdGEtc291cmNlLWxpbmU9IjY2IiBkYXRhLXVpZD0ibG5rMzMiIGlkPSJsaW5rX0NoYWluUmVhY3Rpb25fRGlzcGxheVNjb3JlIj48cGF0aCBkPSJNNDkzLjU2LDI0OC42NSBDNTIzLjAxLDI0OC42NSA1NTIuNjUsMjQ4LjY1IDU4MS41OCwyNDguNjUiIGZpbGw9Im5vbmUiIGlkPSJDaGFpblJlYWN0aW9uLXRvLURpc3BsYXlTY29yZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTg3LjU4LDI0OC42NSw1NzguNTgsMjQ0LjY1LDU4Mi41OCwyNDguNjUsNTc4LjU4LDI1Mi42NSw1ODcuNTgsMjQ4LjY1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjMuMDA2OCIgeD0iNTQxLjU3IiB5PSIyNDQuNzE2OSI+JiMxNzE7aW5jbHVkZSYjMTg3OzwvdGV4dD48L2c+PCEtLWxpbmsgWmVua2VzaGlCb251cyB0byBEaXNwbGF5U2NvcmUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iWmVua2VzaGlCb251cyIgZGF0YS1lbnRpdHktMj0iRGlzcGxheVNjb3JlIiBkYXRhLXNvdXJjZS1saW5lPSI2NyIgZGF0YS11aWQ9ImxuazM0IiBpZD0ibGlua19aZW5rZXNoaUJvbnVzX0Rpc3BsYXlTY29yZSI+PHBhdGggZD0iTTUxNC4wNywzMTkuNjcgQzUxNC4wNywzMDEuNTMgNTE0LjA3LDI1NiA1MTQuMDcsMjU2IEM1MTQuMDcsMjU2IDU0MS4xOSwyNTYgNTczLjY4LDI1NiIgZmlsbD0ibm9uZSIgaWQ9Ilplbmtlc2hpQm9udXMtdG8tRGlzcGxheVNjb3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NzkuNjgsMjU2LDU3MC42OCwyNTIsNTc0LjY4LDI1Niw1NzAuNjgsMjYwLDU3OS42OCwyNTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSI1MTYuMDQiIHk9IjI2OS4wNjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tbGluayBHYW1lT3ZlckNoZWNrIHRvIEdhbWVPdmVyQW5pbWF0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkdhbWVPdmVyQ2hlY2siIGRhdGEtZW50aXR5LTI9IkdhbWVPdmVyQW5pbWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI2OCIgZGF0YS11aWQ9ImxuazM1IiBpZD0ibGlua19HYW1lT3ZlckNoZWNrX0dhbWVPdmVyQW5pbWF0aW9uIj48cGF0aCBkPSJNMjg4Ljg4LDM5My41IEMzMTIuMTcsMzkzLjUgMzMxLjg0LDM5My41IDM1NS4xNCwzOTMuNSIgZmlsbD0ibm9uZSIgaWQ9IkdhbWVPdmVyQ2hlY2stdG8tR2FtZU92ZXJBbmltYXRpb24iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM2MS4xNCwzOTMuNSwzNTIuMTQsMzg5LjUsMzU2LjE0LDM5My41LDM1Mi4xNCwzOTcuNSwzNjEuMTQsMzkzLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wMDY4IiB4PSIzMjYuMDEiIHk9IjM4OS41NjY5Ij4mIzE3MTtpbmNsdWRlJiMxODc7PC90ZXh0PjwvZz48IS0tU1JDPVtiTEpUSlhEMTZCdFZmdlh1dXJMdjA0RDg1OG1OSGFNdXlzeFNaa3Njc3ZyY1R1ZXNYaUprMmJPR1EyZ3NLTDAxYUx6NTFJREEtTmNPd05KZk1wV3BJeFNwNTVEQ0RmbERWRVZDVHh1cFB6UDZabVdXNkJYTUFhcjBxZEFISUlwaTY1eDZTZEJHWExjR1dzTzZmajBlQVRXOFkzOXFLWlBJMEJSYjg1Qjg4TzFUYWlRNlNITEdWdU53dHdYX0dlRDNNam5YRS1fMnVxcTNjV0l4dTBlRFFaSnVHbHJMNmwzZHkwZzA3WFlzT0c2dkNTQlZmX3VWNmFwSU80Y01IbWlVR0xkM1lCanBKOTVaSWNUbFZyU3EyZlBxdWJFM3UxR1lRVUpvSm83ZzMxTmtCOFZib0xQcmZWTmk0clQ3V3BNbnBkZC1aLVozbzdsOFgxeGxxZ24tZnlLUUJKdk5NYkhRck1jc0ZYcTk4ejBiVHo3Wk1wMkJFWW1MSjhDamtSTXE4WVg5cldabzE0LUluZXJwQWtMNHBUU3BaUUY1SXFiaU1yMVgtc2ppUmV5TWp5RnJFZmotOHBsVG1NRGVFNV8wNXk0TkZmcE1Mbzh6YzQzb0JycHVTd2JQc3dKNWtURm9LVUR0REZSemw2TGNYYm9TYXZvazRVQm5zb1Z6VnVDcVZ2Tk9SNXFza2tkb2FZd0NSeklRaFJBdjZOUW9BRUl6RkdaZEZxaG1PMWZRcFdZMktPMVowZmxPdTNrQU9tbU1mUXVmc1J5SXBrb291dmZhRmExRTFkYmZ3bVBzeWZ2d1pYb3Q5eURTRUx0VTI1U0Y5N2g4eWQ4eWh3Q2NUaGxGWnFyeVBiQ0JibmxPX29ockhBZlVxazl3VEVvb29NcktVOFlYY25wNDNkNm5WTzc5ZFFYVmliaVNvWXR2S1VQbExiaGJickNzNTZjeUR1UlNtSkdvQ3ByZXBTRHZ6azkwZXJydGgyb0tuZXlCaExvV1Zpc3ZrYVljNFRycmE0V0N3RFQ3TUxTbFlCOFNmcmM1VGhBaGhFZTFMR2hkUkp0ZFA0VGJkM3BHZHFZcVZxMVFtakkyNVkycmU2UDVOVFZTbGdXRy13YU1IUnZVSlIzb0RYVlBFRjZEalk2V2h3emhENzBEekZVWjltR3ZvTzQxZXNESlJ3bmNOYy11XzZjenZ5dXJ3ak44Rm82anV2X09HM1RFcTJ0N2pGRDluRmJ3SlEwcnF0SW1SZEdGaTZ3bzA3VXhncDctMFcwMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p>この図を見ると、プレイヤーとシステムの役割分担がよくわかりますね。プレイヤーはゲームの開始や操作を担当し、システムはぷよの消去判定やスコア計算などの内部処理を担当しています。また、キーボード操作は「拡張（extend）」関係にあり、ぷよの移動や回転などの基本操作を実現していることがわかります。</p>
<p>このようにユースケース図を作成することで、システムの全体像を把握し、実装すべき機能の関連性を明確にすることができます。それでは、実際のコード実装に進んでいきましょう！</p>
<h2 id="0">イテレーション0: 開発環境の準備<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>「いきなりコードを書き始める前に、まず環境を整えましょう！」実は、この準備がとても重要なんです。良い道具を揃えておくことで、後の作業がとてもスムーズになりますよ。</p>
<h3 id="_7">自動化から始めるテスト駆動開発<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>エピソード1ではテスト駆動開発のゴールが <strong>動作するきれいなコード</strong> であることを学びました。では、良いコードを書き続けるためには何が必要になるでしょうか？それは<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>と呼ばれるものです。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>
<p>バージョン管理</p>
</li>
<li>
<p>テスティング</p>
</li>
<li>
<p>自動化</p>
</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works </p>
</blockquote>
<p>これから、これら3つの神器を一つずつ準備していきます。「なんだか大変そう...」と思われるかもしれませんが、一度準備してしまえば、後は自動で動いてくれるので楽になりますよ！</p>
<h3 id="_8">プロジェクトの作成<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>まずは、WPFプロジェクトを作成しましょう。「どうやって作るの？」というと、.NET CLIを使います。コマンド一つで簡単に作れるんですよ！</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトディレクトリに移動</span>
<span class="nb">cd</span><span class="w"> </span>/workspaces/case-study-game-dev/app/csharp

<span class="c1"># WPFプロジェクトを作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>wpf<span class="w"> </span>-n<span class="w"> </span>PuyoPuyoWPF<span class="w"> </span>-o<span class="w"> </span>PuyoPuyoWPF

<span class="c1"># テストプロジェクトを作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>xunit<span class="w"> </span>-n<span class="w"> </span>PuyoPuyoWPF.Tests<span class="w"> </span>-o<span class="w"> </span>PuyoPuyoWPF.Tests

<span class="c1"># ソリューションファイルを作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>sln<span class="w"> </span>-n<span class="w"> </span>PuyoPuyoWPF

<span class="c1"># プロジェクトをソリューションに追加</span>
dotnet<span class="w"> </span>sln<span class="w"> </span>add<span class="w"> </span>PuyoPuyoWPF/PuyoPuyoWPF.csproj
dotnet<span class="w"> </span>sln<span class="w"> </span>add<span class="w"> </span>PuyoPuyoWPF.Tests/PuyoPuyoWPF.Tests.csproj

<span class="c1"># テストプロジェクトからメインプロジェクトへの参照を追加</span>
<span class="nb">cd</span><span class="w"> </span>PuyoPuyoWPF.Tests
dotnet<span class="w"> </span>add<span class="w"> </span>reference<span class="w"> </span>../PuyoPuyoWPF/PuyoPuyoWPF.csproj
<span class="nb">cd</span><span class="w"> </span>..
</code></pre></div>
<p>「たくさんコマンドがあるなぁ...」と思われるかもしれませんが、一つずつ見ていきましょう：</p>
<ol>
<li><code>dotnet new wpf</code> - WPFのプロジェクトを作成します</li>
<li><code>dotnet new xunit</code> - xUnitのテストプロジェクトを作成します</li>
<li><code>dotnet new sln</code> - ソリューションファイルを作成します（複数のプロジェクトをまとめて管理するため）</li>
<li><code>dotnet sln add</code> - プロジェクトをソリューションに追加します</li>
<li><code>dotnet add reference</code> - テストプロジェクトからメインプロジェクトを参照できるようにします</li>
</ol>
<p>これでプロジェクトの基本構造ができました！</p>
<h3 id="_9">バージョン管理<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<h4 id="git">Gitリポジトリの初期化<a class="headerlink" href="#git" title="Permanent link">&para;</a></h4>
<p>次に、バージョン管理の準備をしましょう。「バージョン管理って何？」という方もいるかもしれませんね。簡単に言うと、「コードの変更履歴を記録して、いつでも過去の状態に戻れるようにする仕組み」なんです。</p>
<p><code>.gitignore</code>ファイルを作成します：</p>
<div class="highlight"><pre><span></span><code>// .gitignore
## Ignore Visual Studio temporary files, build results, and
## files generated by popular Visual Studio add-ons.

# User-specific files
*.suo
*.user
*.userosscache
*.sln.docstates

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
x64/
x86/
[Bb]in/
[Oo]bj/

# Visual Studio cache/options directory
.vs/

# Test results
[Tt]est[Rr]esult*/
[Bb]uild[Ll]og.*

# Coverage reports
coverage/
TestResults/

# NuGet Packages
*.nupkg
.nuget/
</code></pre></div>
<p><code>.gitignore</code>ファイルは、「このファイルはGitで管理しなくていいよ」と指定するためのファイルです。ビルド結果やテスト結果など、自動生成されるファイルは管理する必要がないですからね。</p>
<h4 id="_10">コミットメッセージの規約<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>Gitでコードを記録するとき、「コミットメッセージ」というものを書きます。「どんなふうに書けばいいの？」という疑問があるかもしれませんね。実は、わかりやすいメッセージを書くための規約があるんです。</p>
<p>これまで作業の区切りごとにリポジトリにコミットしていましたが、その際に以下のような書式でメッセージを書いていきます：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 新機能を追加&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;fix: バグを修正&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;refactor: コードをリファクタリング&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: テストを追加&#39;</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: ビルド設定を変更&#39;</span>
</code></pre></div>
<p>この書式は <a href="https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#type">Angularルール</a>に従っています。具体的には、それぞれのコミットメッセージはヘッダ、ボディ、フッタで構成されています。ヘッダはタイプ、スコープ、タイトルというフォーマットで構成されています。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p>ヘッダは必須です。ヘッダのスコープは任意です。コミットメッセージの長さは50文字までにしてください（そうすることでその他のGitツールと同様にGitHub上で読みやすくなります）。</p>
<p>コミットのタイプは次を用いて下さい：</p>
<ul>
<li><strong>feat</strong>: 新しい機能の追加</li>
<li><strong>fix</strong>: バグ修正</li>
<li><strong>docs</strong>: ドキュメント変更のみ</li>
<li><strong>style</strong>: コードに影響を与えない変更（フォーマット、セミコロンの欠落など）</li>
<li><strong>refactor</strong>: 機能追加でもバグ修正でもないコード変更</li>
<li><strong>perf</strong>: パフォーマンスを改善するコード変更</li>
<li><strong>test</strong>: 存在しないテストの追加、または既存のテストの修正</li>
<li><strong>chore</strong>: ドキュメント生成のような、補助ツールやライブラリやビルドプロセスの変更</li>
</ul>
<p>「なるほど、こうやって書けば、後から見たときに何をしたかがすぐわかりますね！」その通りです！</p>
<p>では、最初のコミットをしてみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>PuyoPuyoWPF
git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: プロジェクトの初期設定&#39;</span>
</code></pre></div>
<h3 id="_11">パッケージマネージャ<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>では <strong>自動化</strong> の準備に入りたいのですが、そのためにはいくつかの外部ライブラリを利用する必要があります。.NETでは <strong>NuGet</strong> がパッケージマネージャとしての役割を果たします。</p>
<blockquote>
<p>NuGetとは、.NET用のパッケージマネージャーです。開発者が作成・共有したライブラリやツールを「パッケージ」として配布・利用することができます。</p>
</blockquote>
<p><strong>NuGet</strong>を使ってパッケージをインストールするのは簡単です：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># WPFプロジェクトに必要なパッケージを追加</span>
<span class="nb">cd</span><span class="w"> </span>PuyoPuyoWPF
<span class="c1"># MVVMライブラリ（CommunityToolkit.Mvvm）を追加</span>
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>CommunityToolkit.Mvvm
<span class="nb">cd</span><span class="w"> </span>..

<span class="c1"># テストプロジェクトに必要なパッケージを追加</span>
<span class="nb">cd</span><span class="w"> </span>PuyoPuyoWPF.Tests
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>Microsoft.NET.Test.Sdk
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>xunit
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>xunit.runner.visualstudio
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>Moq<span class="w">  </span><span class="c1"># モックフレームワーク</span>
<span class="nb">cd</span><span class="w"> </span>..
</code></pre></div>
<p>「CommunityToolkit.Mvvmって何？」と思われるかもしれませんね。これはMicrosoft公式のMVVMライブラリで、WPFアプリケーション開発を強力にサポートしてくれます。「WPFでMVVMやるならCommunityToolkit.Mvvm」と覚えておくといいですよ！</p>
<p>C#/.NETプロジェクトでは、プロジェクトファイル（<code>.csproj</code>）にパッケージの依存関係が記述されます。これにより、プロジェクトをクローンした際に <code>dotnet restore</code> を実行するだけで必要なパッケージが自動的にインストールされます。便利ですよね！</p>
<p>実際にプロジェクトファイルを見てみましょう：</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>PuyoPuyoWPF.Tests/PuyoPuyoWPF.Tests.csproj
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;Project</span><span class="w"> </span><span class="na">Sdk=</span><span class="s">&quot;Microsoft.NET.Sdk&quot;</span><span class="nt">&gt;</span>

<span class="w">  </span><span class="nt">&lt;PropertyGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;TargetFramework&gt;</span>net8.0<span class="nt">&lt;/TargetFramework&gt;</span>
<span class="w">    </span><span class="nt">&lt;ImplicitUsings&gt;</span>enable<span class="nt">&lt;/ImplicitUsings&gt;</span>
<span class="w">    </span><span class="nt">&lt;Nullable&gt;</span>enable<span class="nt">&lt;/Nullable&gt;</span>
<span class="w">    </span><span class="nt">&lt;IsPackable&gt;</span>false<span class="nt">&lt;/IsPackable&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PropertyGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Microsoft.NET.Test.Sdk&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;17.8.0&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;Moq&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;4.20.70&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;xunit&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;2.6.2&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;PackageReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;xunit.runner.visualstudio&quot;</span><span class="w"> </span><span class="na">Version=</span><span class="s">&quot;2.5.4&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;IncludeAssets&gt;</span>runtime;<span class="w"> </span>build;<span class="w"> </span>native;<span class="w"> </span>contentfiles;<span class="w"> </span>analyzers;<span class="w"> </span>buildtransitive<span class="nt">&lt;/IncludeAssets&gt;</span>
<span class="w">      </span><span class="nt">&lt;PrivateAssets&gt;</span>all<span class="nt">&lt;/PrivateAssets&gt;</span>
<span class="w">    </span><span class="nt">&lt;/PackageReference&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="w">  </span><span class="nt">&lt;ItemGroup&gt;</span>
<span class="w">    </span><span class="nt">&lt;ProjectReference</span><span class="w"> </span><span class="na">Include=</span><span class="s">&quot;..\PuyoPuyoWPF\PuyoPuyoWPF.csproj&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ItemGroup&gt;</span>

<span class="nt">&lt;/Project&gt;</span>
</code></pre></div>
<p>「こうやって見ると、どんなパッケージを使っているかが一目瞭然ですね！」その通りです！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: テスト用パッケージの追加&#39;</span>
</code></pre></div>
<h3 id="_12">静的コード解析<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質を維持していく必要があります。<strong>テスト駆動開発</strong>によりプログラムを動かしながら品質を改善していきますが、出来上がったコードに対する品質チェックの方法として<strong>静的コード解析</strong>があります。</p>
<p>C#/.NET用の<strong>静的コード解析</strong>ツールとして<a href="https://github.com/dotnet/roslyn-analyzers">Microsoft.CodeAnalysis.Analyzers</a>を使って確認してみましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># アナライザパッケージをインストール</span>
<span class="nb">cd</span><span class="w"> </span>PuyoPuyoWPF
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>Microsoft.CodeAnalysis.Analyzers
<span class="nb">cd</span><span class="w"> </span>..
</code></pre></div>
<p>次に、コード分析の設定ファイルを作成します。<code>.editorconfig</code>ファイルでコーディングスタイルを定義できます：</p>
<div class="highlight"><pre><span></span><code><span class="na">// .editorconfig</span>
<span class="na">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>

<span class="k">[*]</span>
<span class="na">indent_style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">space</span>
<span class="na">indent_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">4</span>
<span class="na">end_of_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">crlf</span>
<span class="na">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">utf-8</span>
<span class="na">trim_trailing_whitespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">insert_final_newline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>

<span class="k">[*.cs]</span>
<span class="c1"># C# coding conventions</span>
<span class="na">dotnet_sort_using_directives</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">dotnet_separate_import_directive_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">false</span>

<span class="c1"># Language rules</span>
<span class="na">csharp_prefer_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">false:suggestion</span>
<span class="na">csharp_prefer_braces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true:warning</span>

<span class="c1"># Code quality rules</span>
<span class="na">dotnet_diagnostic.CA1502.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">warning</span>
<span class="c1"># CA1502: メソッドの循環的複雑度を7以下に制限</span>
<span class="na">dotnet_code_quality.CA1502.cyclomatic_complexity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">7</span>

<span class="c1"># Naming conventions</span>
<span class="na">dotnet_naming_rule.interface_should_be_begins_with_i.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">warning</span>
<span class="na">dotnet_naming_rule.interface_should_be_begins_with_i.symbols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">interface</span>
<span class="na">dotnet_naming_rule.interface_should_be_begins_with_i.style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">begins_with_i</span>

<span class="na">dotnet_naming_rule.types_should_be_pascal_case.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">warning</span>
<span class="na">dotnet_naming_rule.types_should_be_pascal_case.symbols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">types</span>
<span class="na">dotnet_naming_rule.types_should_be_pascal_case.style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pascal_case</span>

<span class="na">dotnet_naming_symbols.interface.applicable_kinds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">interface</span>
<span class="na">dotnet_naming_symbols.interface.applicable_accessibilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">public, internal, private, protected, protected_internal, private_protected</span>

<span class="na">dotnet_naming_symbols.types.applicable_kinds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">class, struct, interface, enum</span>
<span class="na">dotnet_naming_symbols.types.applicable_accessibilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">public, internal, private, protected, protected_internal, private_protected</span>

<span class="na">dotnet_naming_style.begins_with_i.required_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">I</span>
<span class="na">dotnet_naming_style.begins_with_i.capitalization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pascal_case</span>

<span class="na">dotnet_naming_style.pascal_case.capitalization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pascal_case</span>
</code></pre></div>
<p>「.editorconfigって何？」と思われるかもしれませんね。これは、コーディングスタイル（インデントの幅や命名規則など）を定義するファイルです。チーム全体で同じスタイルを共有できるので、「この人のコードは読みにくいな...」という問題が減りますよ！</p>
<p><strong>循環複雑度について</strong></p>
<p>ここで設定している<code>cyclomatic_complexity = 7</code>について少し説明しましょう。循環複雑度（Cyclomatic Complexity）とは、コードの複雑さを測る指標の一つです。</p>
<blockquote>
<p>循環複雑度とは、プログラムの制御フローの複雑さを測る指標です。if文、for文、while文などの分岐や繰り返しが増えるほど、この値は大きくなります。値が高いほどコードの理解が難しく、バグが混入しやすくなります。</p>
<p>— Thomas J. McCabe 『A Complexity Measure』</p>
</blockquote>
<p>一般的な目安として：
- <strong>1-7</strong>: シンプルで理解しやすい（推奨）
- <strong>8-10</strong>: やや複雑、注意が必要
- <strong>11以上</strong>: 複雑すぎる、リファクタリング推奨</p>
<p>「なぜ7なの？」と思われるかもしれませんね。これは、人間が一度に理解できる情報の量（マジカルナンバー7±2）に基づいた経験則です。メソッドの循環複雑度を7以下に保つことで、コードの理解しやすさとテストのしやすさを維持できます。</p>
<p>コード分析を実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>build
</code></pre></div>
<p>「ビルドするだけで静的コード解析もしてくれるんですね！」その通りです。そして、もしメソッドが複雑すぎる場合（循環複雑度が7を超える場合）、警告が表示されますよ！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: 静的コード解析の設定&#39;</span>
</code></pre></div>
<h3 id="lint">Lintツール<a class="headerlink" href="#lint" title="Permanent link">&para;</a></h3>
<p><strong>Lintツール</strong>は、コードの品質をさらに高めるための静的解析ツールです。「.editorconfigの設定だけじゃ不十分なの？」と思われるかもしれませんが、Lintツールはより詳細なルールチェックや、C#固有のベストプラクティスを検証してくれます。</p>
<p>C#/.NETでは<strong>StyleCop Analyzers</strong>が人気です。StyleCopはコーディング規約違反をコンパイル時に検出し、警告やエラーとして通知してくれます。</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>PuyoPuyoWPF
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>StyleCop.Analyzers
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>Microsoft.CodeAnalysis.NetAnalyzers
<span class="nb">cd</span><span class="w"> </span>..
</code></pre></div>
<p>「Microsoft.CodeAnalysis.NetAnalyzersって何ですか?」 これは.NETの公式コードアナライザーで、パフォーマンスの問題やセキュリティの懸念、API使用方法の誤りなどを検出してくれます。StyleCopと組み合わせることで、包括的なコード品質チェックが可能になります。</p>
<p>次に、StyleCopの設定ファイル<code>stylecop.json</code>を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/stylecop.json</span>
<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$schema&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/DotNetAnalyzers/StyleCopAnalyzers/master/StyleCop.Analyzers/StyleCop.Analyzers/Settings/stylecop.schema.json&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;documentationRules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;companyName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PuyoPuyo&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;copyrightText&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Copyright (c) {companyName}. All rights reserved.&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;xmlHeader&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;fileNamingConvention&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stylecop&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;namingRules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;allowCommonHungarianPrefixes&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;allowedHungarianPrefixes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;orderingRules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;systemUsingDirectivesFirst&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;usingDirectivesPlacement&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;outsideNamespace&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;blankLinesBetweenUsingGroups&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;require&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;layoutRules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;newlineAtEndOfFile&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;require&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;maintainabilityRules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;topLevelTypes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「これは何を設定しているんですか？」良い質問です！各セクションを見ていきましょう：</p>
<ul>
<li><strong>documentationRules</strong>: XMLドキュメントコメントのルール</li>
<li><code>companyName</code>: 会社名を設定（著作権表示で使用）</li>
<li><code>xmlHeader</code>: ファイルヘッダーのXMLコメントを要求するかどうか</li>
<li><strong>namingRules</strong>: 命名規則</li>
<li><code>allowCommonHungarianPrefixes</code>: ハンガリアン記法を許可するか</li>
<li><strong>orderingRules</strong>: using文の順序に関するルール</li>
<li><code>systemUsingDirectivesFirst</code>: System.*のusing文を最初に配置</li>
<li><code>usingDirectivesPlacement</code>: using文をnamespaceの外側に配置</li>
<li><strong>layoutRules</strong>: レイアウトのルール</li>
<li><code>newlineAtEndOfFile</code>: ファイル末尾に改行を要求</li>
</ul>
<p>さらに、<code>.editorconfig</code>にもStyleCop固有のルールを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="na">// .editorconfig</span>

<span class="c1"># StyleCop Analyzers の設定</span>

<span class="c1"># SA1600: 要素にXMLドキュメントコメントが必要</span>
<span class="na">dotnet_diagnostic.SA1600.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">none</span>

<span class="c1"># SA1633: ファイルヘッダーが必要</span>
<span class="na">dotnet_diagnostic.SA1633.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">none</span>

<span class="c1"># SA1101: 修飾名を使用する必要がある</span>
<span class="na">dotnet_diagnostic.SA1101.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">none</span>

<span class="c1"># SA1309: フィールド名はアンダースコアで始めてはいけない</span>
<span class="na">dotnet_diagnostic.SA1309.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">none</span>

<span class="c1"># SA1200: Using ディレクティブは名前空間内に配置する</span>
<span class="na">dotnet_diagnostic.SA1200.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">none</span>

<span class="c1"># SA1413: 末尾のコンマを使用する</span>
<span class="na">dotnet_diagnostic.SA1413.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">suggestion</span>

<span class="c1"># SA1028: コードの末尾に空白を含めない</span>
<span class="na">dotnet_diagnostic.SA1028.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">warning</span>
</code></pre></div>
<p>「これらのルールは何を意味しているんですか？」順番に説明しましょう：</p>
<ul>
<li><strong>SA1600 (none)</strong>: すべての要素にドキュメントコメントを要求しない（学習用プロジェクトのため緩和）</li>
<li><strong>SA1633 (none)</strong>: ファイルヘッダーのコメントを要求しない</li>
<li><strong>SA1101 (none)</strong>: <code>this.</code>修飾子を強制しない（モダンなC#スタイル）</li>
<li><strong>SA1309 (none)</strong>: プライベートフィールドに<code>_</code>プレフィックスを許可（モダンなC#の慣習）</li>
<li><strong>SA1200 (none)</strong>: using文をnamespaceの外側に配置することを許可（.NET 6+のスタイル）</li>
<li><strong>SA1413 (suggestion)</strong>: 配列やコレクションの末尾にカンマを使うことを推奨</li>
<li><strong>SA1028 (warning)</strong>: 行末の空白を警告</li>
</ul>
<p>これらの設定により、モダンなC#の記述スタイルを維持しつつ、重要なコード品質チェックは有効にしています。</p>
<p>Lintチェックを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ビルド時にLintチェックが自動実行されます</span>
dotnet<span class="w"> </span>build

<span class="c1"># 警告をエラーとして扱う場合</span>
dotnet<span class="w"> </span>build<span class="w"> </span>/p:TreatWarningsAsErrors<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<p>「警告をエラーにするとどうなるの？」良い質問です！通常、警告があってもビルドは成功しますが、<code>TreatWarningsAsErrors=true</code>を指定すると、警告があるとビルドが失敗します。これにより、チーム全体でコード品質基準を厳格に守ることができます。CI/CD環境で特に有効ですよ！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: Lintツールの設定&#39;</span>
</code></pre></div>
<h3 id="_13">コードフォーマッタ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p><strong>コードフォーマッタ</strong>は開発チーム内でのコーディングスタイルを統一するためのツールです。C#/.NETでは<code>dotnet format</code>コマンドが標準で提供されています。「わざわざインストールしなくていいんですか？」はい、最初から使えるんです！</p>
<p>コードのフォーマットを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>format
</code></pre></div>
<p>このコマンドにより、プロジェクト内のすべてのC#ファイルが<code>.editorconfig</code>で定義されたルールに従ってフォーマットされます。「自動で整形してくれるなんて楽ちんですね！」</p>
<p>フォーマットの確認のみを行いたい場合は：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>format<span class="w"> </span>--verify-no-changes
</code></pre></div>
<p>「これって何をチェックしてるんですか？」このコマンドは、コードがフォーマットルールに従っているかを確認だけして、実際には変更しません。CI/CD環境で使うと便利ですよ！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: コードフォーマッタの設定&#39;</span>
</code></pre></div>
<h3 id="_14">コードカバレッジ<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p><strong>コードカバレッジ</strong>はテストがプロダクションコードをどのくらいカバーしているかを測る指標です。「テストを書いたつもりだけど、実は重要な部分がテストされてなかった...」そんなことを防ぐために役立ちます。</p>
<p>C#/.NETでは<code>coverlet</code>がよく使われます：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># カバレッジツールをインストール</span>
<span class="nb">cd</span><span class="w"> </span>PuyoPuyoWPF.Tests
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>coverlet.collector
dotnet<span class="w"> </span>add<span class="w"> </span>package<span class="w"> </span>coverlet.msbuild
<span class="nb">cd</span><span class="w"> </span>..

<span class="c1"># レポート生成ツールをインストール</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>dotnet-reportgenerator-globaltool
</code></pre></div>
<p>「dotnet toolって何ですか？」良い質問です！dotnet toolは、.NET CLI用のグローバルツールを管理する仕組みです。一度インストールすれば、どこからでも使えるようになりますよ。</p>
<p>テストをカバレッジ付きで実行してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># カバレッジを収集しながらテスト実行</span>
dotnet<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--collect:<span class="s2">&quot;XPlat Code Coverage&quot;</span><span class="w"> </span>--results-directory<span class="w"> </span>./TestResults

<span class="c1"># HTML形式のレポートを生成</span>
reportgenerator<span class="w"> </span>-reports:<span class="s2">&quot;./TestResults/**/coverage.cobertura.xml&quot;</span><span class="w"> </span>-targetdir:<span class="s2">&quot;coverage&quot;</span><span class="w"> </span>-reporttypes:Html
</code></pre></div>
<p>「生成された<code>coverage/index.html</code>をブラウザで開くとカバレッジレポートを確認できます！」カラフルなレポートでどこがテストされているか一目瞭然ですよ。</p>
<p>ワンコマンドでカバレッジレポートを生成するスクリプトを作成しましょう：</p>
<div class="highlight"><pre><span></span><code>//<span class="w"> </span>coverage.sh
<span class="c1">#!/bin/bash</span>
<span class="c1"># coverage.sh - コードカバレッジレポート生成スクリプト</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;🧪 テスト実行とカバレッジ収集中...&quot;</span>
dotnet<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--collect:<span class="s2">&quot;XPlat Code Coverage&quot;</span><span class="w"> </span>--results-directory<span class="w"> </span>./TestResults

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;📊 カバレッジレポート生成中...&quot;</span>
reportgenerator<span class="w"> </span>-reports:<span class="s2">&quot;./TestResults/**/coverage.cobertura.xml&quot;</span><span class="w"> </span>-targetdir:<span class="s2">&quot;coverage&quot;</span><span class="w"> </span>-reporttypes:Html

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ カバレッジレポートが coverage/index.html に生成されました&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ブラウザで確認するには以下のコマンドを実行してください:&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  \$BROWSER coverage/index.html&quot;</span>
EOF

chmod<span class="w"> </span>+x<span class="w"> </span>coverage.sh
</code></pre></div>
<p>スクリプトを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>./coverage.sh
</code></pre></div>
<p>「スクリプト化すると、毎回長いコマンドを打たなくて済むから便利ですね！」その通りです！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: コードカバレッジの設定&#39;</span>
</code></pre></div>
<h3 id="_15">タスクランナー<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるために今まで色々なツールを導入してきましたが、毎回個別に実行するのは面倒です。「フォーマットして、ビルドして、テストして、カバレッジも確認して...」うんざりしちゃいますよね？</p>
<p>そこで<strong>タスクランナー</strong>の出番です！C#/.NETプロジェクトでは、<strong>Cake</strong>という強力なビルド自動化システムを使うことができます。</p>
<blockquote>
<p>Cakeとは、C#をDSL（ドメイン特化言語）として使用するクロスプラットフォームのビルドオートメーションシステムです。Make、Rake、PSakeと同様の概念ですが、C#の構文を活用できるため、.NET開発者にとって親しみやすいツールです。</p>
</blockquote>
<p>まず、Cakeをグローバルツールとしてインストールしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cakeツールをインストール</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>Cake.Tool
</code></pre></div>
<p>次に、<code>build.cake</code>ファイルを作成して、よく使うタスクを定義しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// ARGUMENTS</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="kt">var</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argument</span><span class="p">(</span><span class="s">&quot;target&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Default&quot;</span><span class="p">);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argument</span><span class="p">(</span><span class="s">&quot;configuration&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Release&quot;</span><span class="p">);</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// SETUP / TEARDOWN</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">Setup</span><span class="p">(</span><span class="n">ctx</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;Running tasks...&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;Target: {0}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Teardown</span><span class="p">(</span><span class="n">ctx</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;Finished running tasks.&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// TASKS</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;プロジェクトのクリーンアップ&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;クリーンアップを実行中...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">DotNetClean</span><span class="p">(</span><span class="s">&quot;./PuyoPuyoWPF.sln&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectory</span><span class="p">(</span><span class="s">&quot;./coverage&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">CleanDirectory</span><span class="p">(</span><span class="s">&quot;./TestResults&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Restore&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;NuGetパッケージの復元&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Clean&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;パッケージを復元中...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">DotNetRestore</span><span class="p">(</span><span class="s">&quot;./PuyoPuyoWPF.sln&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードフォーマットの実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;コードをフォーマット中...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">DotNetFormat</span><span class="p">(</span><span class="s">&quot;./PuyoPuyoWPF.sln&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;プロジェクトのビルド&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Restore&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;ビルドを実行中...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">DotNetBuild</span><span class="p">(</span><span class="s">&quot;./PuyoPuyoWPF.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetBuildSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードのLintチェック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;Lintチェックを実行中...&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 警告をエラーとして扱ってビルド</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">lintSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetBuildSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">MSBuildSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetMSBuildSettings</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">lintSettings</span><span class="p">.</span><span class="n">MSBuildSettings</span><span class="p">.</span><span class="n">TreatAllWarningsAs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSBuildTreatAllWarningsAs</span><span class="p">.</span><span class="n">Error</span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">DotNetBuild</span><span class="p">(</span><span class="s">&quot;./PuyoPuyoWPF.sln&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lintSettings</span><span class="p">);</span>
<span class="w">        </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;✅ Lintチェックが成功しました&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">catch</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Warning</span><span class="p">(</span><span class="s">&quot;⚠️ Lintチェックで警告またはエラーが見つかりました&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">throw</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;テストの実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;テストを実行中...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">DotNetTest</span><span class="p">(</span><span class="s">&quot;./PuyoPuyoWPF.Tests/PuyoPuyoWPF.Tests.csproj&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetTestSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードカバレッジの測定&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;カバレッジを測定中...&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// カバレッジ付きテスト実行</span>
<span class="w">    </span><span class="n">DotNetTest</span><span class="p">(</span><span class="s">&quot;./PuyoPuyoWPF.Tests/PuyoPuyoWPF.Tests.csproj&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetTestSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">NoRestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">ArgumentCustomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;--collect:\&quot;XPlat Code Coverage\&quot;&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;--results-directory ./TestResults&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// レポート生成</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;カバレッジレポートを生成中...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;reportgenerator&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessArgumentBuilder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;-reports:./TestResults/**/coverage.cobertura.xml&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;-targetdir:./coverage&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;-reporttypes:Html&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;✅ カバレッジレポートが coverage/index.html に生成されました&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Quality&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;すべての品質チェックを実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Format&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Lint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Coverage&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;✅ すべての品質チェックが完了しました！&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Watch&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;ファイル監視と自動ビルド・テスト&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;ファイル監視を開始します...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Information</span><span class="p">(</span><span class="s">&quot;終了するには Ctrl+C を押してください&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DotNetWatchSettings</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;./PuyoPuyoWPF.Tests/PuyoPuyoWPF.Tests.csproj&quot;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">DotNetWatch</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Default&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;デフォルトタスク（Quality）&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Quality&quot;</span><span class="p">);</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// EXECUTION</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">RunTarget</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
</code></pre></div>
<p>「このCakeファイルは何をしてくれるんですか？」良い質問です！このCakeファイルでは、以下のタスクを定義しています：</p>
<ul>
<li><strong>Clean</strong>: ビルド成果物とテスト結果をクリーンアップ</li>
<li><strong>Restore</strong>: NuGetパッケージを復元</li>
<li><strong>Format</strong>: コードをフォーマット</li>
<li><strong>Build</strong>: プロジェクトをビルド</li>
<li><strong>Lint</strong>: コードのLintチェック（警告をエラーとして扱う）</li>
<li><strong>Test</strong>: テストを実行</li>
<li><strong>Coverage</strong>: カバレッジを測定してレポート生成</li>
<li><strong>Quality</strong>: すべての品質チェックを実行（デフォルト）</li>
<li><strong>Watch</strong>: ファイル監視と自動テスト実行</li>
</ul>
<p>タスクを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># デフォルトタスク（Quality）を実行</span>
dotnet<span class="w"> </span>cake

<span class="c1"># 特定のタスクを実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Clean
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Lint
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Coverage

<span class="c1"># すべての品質チェックを実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Quality
</code></pre></div>
<p>「Cakeを使うと、C#の構文でビルドスクリプトが書けるので、.NET開発者にとってとても自然ですね！」その通りです！</p>
<p>Cakeの良いところは：</p>
<ol>
<li><strong>C#で書ける</strong>: .NET開発者にとって親しみやすい</li>
<li><strong>依存関係管理</strong>: タスク間の依存関係を自動で解決</li>
<li><strong>クロスプラットフォーム</strong>: Windows、Linux、macOSで動作</li>
<li><strong>豊富なエコシステム</strong>: 多くのアドインとヘルパーが利用可能</li>
</ol>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: Cakeタスクランナーの設定&#39;</span>
</code></pre></div>
<h3 id="_16">タスクの自動化<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p><strong>Cake</strong>により品質をチェックするタスクは用意されましたが、まだ手動で実行する必要があります。「ファイルを保存するたびに自動でテストが走ったら便利なのにな...」と思いませんか？</p>
<p>実は、Cakeには<strong>Watch</strong>タスクを使って自動実行する機能が既に含まれています！</p>
<h4 id="cakewatch">Cakeの組み込みWatchタスクを使用<a class="headerlink" href="#cakewatch" title="Permanent link">&para;</a></h4>
<p>最もシンプルな方法は、<code>build.cake</code>で定義した<code>Watch</code>タスクを使うことです：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cakeのwatchタスクを実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch
</code></pre></div>
<p>「これだけで自動テストが動くんですね！」そうなんです。.NET CLIの<code>dotnet watch</code>コマンドを利用しているので、ファイルが変更されるたびに自動的にテストが実行されますよ。</p>
<p>別のターミナルを開いて、何かファイルを変更してみてください。変更が検出されて自動的にタスクが実行されることが確認できるはずです。</p>
<p>テストがパスすることが確認できたらコミットしておきましょう。このときターミナルでは<code>Watch</code>が動いているので、別ターミナルを開いてコミットを実施すると良いでしょう。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: タスクの自動化&#39;</span>
</code></pre></div>
<h3 id="_17">動作確認<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>さて、ここまでで環境構築は完了です！「本当に動くんでしょうか？」試してみましょう。</p>
<p>まず、簡単なテストを書いて、すべてが正しく動作することを確認します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/SampleTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SampleTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">基本的なテストが動作する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange（準備）</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act（実行）</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Assert（検証）</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Theory]</span>
<span class="w">    </span><span class="na">[InlineData(1, 2, 3)]</span>
<span class="w">    </span><span class="na">[InlineData(0, 0, 0)]</span>
<span class="w">    </span><span class="na">[InlineData(-1, 1, 0)]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">複数のケ</span><span class="n">ー</span><span class="err">スをテストできる</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストは何をテストしてるんですか？」良い質問です！これは実際のテストではなく、環境が正しく動作することを確認するためのサンプルです。「1+2=3」という簡単な計算をテストしています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
<span class="c1"># または、Cakeを使って</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りましたね！」素晴らしい！では、わざと失敗するテストを書いてみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/SampleTest.cs</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">わざと失敗するテスト</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// わざと間違った期待値を設定</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>もう一度テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
<span class="c1"># または、Cakeを使って</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが失敗しましたね！」そうです。これは期待通りの動作です。テストが失敗することも正しく検出できることが確認できました。</p>
<p>では、失敗するテストを削除して、もう一度確認しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/SampleTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SampleTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">基本的なテストが動作する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange（準備）</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act（実行）</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Assert（検証）</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Theory]</span>
<span class="w">    </span><span class="na">[InlineData(1, 2, 3)]</span>
<span class="w">    </span><span class="na">[InlineData(0, 0, 0)]</span>
<span class="w">    </span><span class="na">[InlineData(-1, 1, 0)]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">複数のケ</span><span class="n">ー</span><span class="err">スをテストできる</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">EOF</span>

<span class="n">dotnet</span><span class="w"> </span><span class="n">test</span>
<span class="err">#</span><span class="w"> </span><span class="err">または、</span><span class="n">Cake</span><span class="err">を使って</span>
<span class="n">dotnet</span><span class="w"> </span><span class="n">cake</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">Test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」完璧です！</p>
<p>最後にカバレッジレポートも確認してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cakeを使ってカバレッジを測定</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Coverage
</code></pre></div>
<p>「coverage/index.htmlができましたね！」ブラウザで開いてみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$BROWSER</span><span class="w"> </span>coverage/index.html
</code></pre></div>
<p>「カバレッジレポートが見れました！」素晴らしい！これで、どのコードがテストされているか視覚的に確認できますね。</p>
<p>Cakeのすべてのタスクを一度に実行することもできます：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># すべての品質チェックを実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Quality
<span class="c1"># または</span>
dotnet<span class="w"> </span>cake<span class="w">  </span><span class="c1"># デフォルトでQualityタスクが実行される</span>
</code></pre></div>
<p>「Format→Build→Test→Coverageが順番に実行されましたね！」その通りです。Cakeのタスク依存関係が自動的に解決されて、必要なタスクが順番に実行されます。</p>
<p>すべての確認が終わったら、コミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: サンプルテストの追加&#39;</span>
</code></pre></div>
<h3 id="0_1">イテレーション0のまとめ<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション0が完了しました。ここまでで、以下のことができるようになりました：</p>
<ol>
<li><strong>プロジェクトの作成</strong>: WPFプロジェクトとテストプロジェクトの作成</li>
<li><strong>バージョン管理</strong>: Gitリポジトリの初期化とコミットメッセージの規約</li>
<li><strong>パッケージ管理</strong>: NuGetを使った依存関係の管理（CommunityToolkit.Mvvm、Moqなど）</li>
<li><strong>静的コード解析</strong>: Microsoft.CodeAnalysis.Analyzersによるコード品質の自動チェック</li>
<li><strong>コードフォーマッタ</strong>: dotnet formatによるコーディングスタイルの統一</li>
<li><strong>コードカバレッジ</strong>: Coverlet + ReportGeneratorによるテストカバレッジの測定と可視化</li>
<li><strong>タスクランナー</strong>: CakeによるC#ベースのビルド自動化</li>
<li><strong>タスクの自動化</strong>: dotnet watchによるファイル監視と自動実行</li>
</ol>
<p>これで<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>が揃いました：</p>
<ul>
<li>✅ <strong>バージョン管理</strong>: Git + Angularルールのコミットメッセージ</li>
<li>✅ <strong>テスティング</strong>: xUnit + Moq + Coverlet</li>
<li>✅ <strong>自動化</strong>: Cake + dotnet watch</li>
</ul>
<p><strong>Cakeを使うメリット</strong>:
- C#で書けるので.NET開発者にとって自然
- タスクの依存関係を宣言的に定義できる
- クロスプラットフォームで動作
- 豊富なアドインとヘルパー機能
- IDE統合とデバッグサポート</p>
<p>「これでテスト駆動開発を始める準備が整いましたね！」その通りです！次のイテレーションからは、実際にぷよぷよゲームの機能を実装していきますよ。</p>
<p>開発を始めるときは、以下のコマンドを実行しておけば、ファイルを保存するたびに自動でテストが実行されるので、テスト駆動開発のリズム（Red-Green-Refactor）に集中できますね！</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cakeの組み込みWatchを使う</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch

<span class="c1"># 別のターミナルでコードを編集</span>
<span class="c1"># ファイルを保存するたびに自動でテストが実行される！</span>
</code></pre></div>
<p><strong>よく使うCakeコマンド</strong>:
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w">                      </span><span class="c1"># すべての品質チェック（デフォルト）</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Clean<span class="w">       </span><span class="c1"># クリーンアップ</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format<span class="w">      </span><span class="c1"># コードフォーマット</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build<span class="w">       </span><span class="c1"># ビルド</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test<span class="w">        </span><span class="c1"># テスト実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Coverage<span class="w">    </span><span class="c1"># カバレッジ測定</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch<span class="w">       </span><span class="c1"># 自動テスト実行</span>
</code></pre></div></p>
<p>それでは、次のイテレーション1で実際のゲーム機能の実装に取り組んでいきましょう！</p>
<h2 id="1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」を実装します。</p>
<blockquote>
<p>イテレーション開発とは、ソフトウェアを小さな機能単位で繰り返し開発していく手法です。各イテレーションで計画、設計、実装、テスト、評価のサイクルを回すことで、リスクを早期に発見し、フィードバックを得ながら開発を進めることができます。</p>
<p>— Craig Larman 『アジャイル開発とスクラム』</p>
</blockquote>
<h3 id="_18">ユーザーストーリー<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>TODOリストは、テスト駆動開発の重要なプラクティスの一つです。実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ゲームの初期化処理を実装する（ゲームの状態や必要なコンポーネントを設定する）</li>
<li>ViewModelを作成する（WPFのMVVMパターンに従ってプレゼンテーション層を実装する）</li>
<li>新しいぷよを生成する（ゲーム開始時に最初のぷよを作成する）</li>
<li>ゲームループを開始する（ゲームの継続的な更新と描画を行う）</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ゲームの初期化処理」から始めましょう！</p>
<h3 id="_19">テスト: ゲームの初期化<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「ゲームの初期化処理を実装する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ゲームの初期化処理をテストするコードを書いてみましょう。何をテストすべきでしょうか？ゲームが初期化されたとき、必要なコンポーネントが正しく作成され、ゲームの状態が適切に設定されていることを確認する必要がありますね。</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>PuyoPuyoWPF.Tests/Models
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/GameTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムを初期化すると必要なコンポ</span><span class="n">ー</span><span class="err">ネントが作成される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Config</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Player</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムを初期化するとゲ</span><span class="n">ー</span><span class="err">ムモ</span><span class="n">ー</span><span class="err">ドが</span><span class="n">Start</span><span class="err">になる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「あれ？コンパイルエラーになりますね」そうです、それが正しい状態です。テスト駆動開発では、まだ存在しないコードのテストを書くことから始めます。これにより、必要なAPIの形が自然と見えてきます。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「当然、コンパイルエラーになりますね」その通りです！今はまだ<code>Game</code>クラスも<code>GameMode</code>列挙型も存在していません。これがTDDの「レッド（失敗）」の段階です。次は、テストが通るように最小限の実装を行う「グリーン（成功）」の段階に進みましょう。</p>
<h3 id="_20">実装: ゲームの初期化<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>それでは、テストを通すための最小限の実装を行いましょう。まずは、必要なモデルクラスとゲームモードの列挙型を作成します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Modelsディレクトリを作成</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>PuyoPuyoWPF/Models
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/GameMode.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">GameMode</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Start</span><span class="p">,</span>
<span class="w">    </span><span class="n">Playing</span><span class="p">,</span>
<span class="w">    </span><span class="n">GameOver</span>
<span class="p">}</span>
</code></pre></div>
<p>「たくさんのクラスができましたね！」そうですね。それぞれのクラスが単一の責任を持っています：</p>
<ul>
<li><strong>GameMode</strong>: ゲームの状態を表現</li>
<li><strong>Config</strong>: ゲーム設定を保持</li>
<li><strong>Stage</strong>: ゲームフィールドを管理</li>
<li><strong>Player</strong>: プレイヤーの位置を管理</li>
<li><strong>Score</strong>: スコアとチェーンを管理</li>
<li><strong>Game</strong>: すべてのコンポーネントを統合</li>
</ul>
<p>これらのクラスは、<a href="https://ja.wikipedia.org/wiki/%E5%8D%98%E4%B8%80%E8%B2%AC%E4%BB%BB%E3%81%AE%E5%8E%9F%E5%89%87">単一責任の原則（SRP）</a>に従って設計されています。</p>
<p>さて、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「テストが通りましたね！」素晴らしい！これがTDDの「グリーン（成功）」の段階です。テストが通ったことで、ゲームの初期化処理が正しく動作していることが保証されました。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームの初期化処理を実装&#39;</span>
</code></pre></div>
<h3 id="viewmodel">ViewModelの作成<a class="headerlink" href="#viewmodel" title="Permanent link">&para;</a></h3>
<p>次に、WPFのMVVMパターンに従って、ViewModelを作成しましょう。ViewModelは、ビューとモデルの間の架け橋となり、プレゼンテーションロジックを担当します。</p>
<p>まず、ViewModelのテストを書きましょう：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>PuyoPuyoWPF.Tests/ViewModels
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/ViewModels/GameViewModelTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.ViewModels</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModelTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">ViewModel</span><span class="err">を初期化するとゲ</span><span class="n">ー</span><span class="err">ムが初期化される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Start</span><span class="err">コマンドを実行するとゲ</span><span class="n">ー</span><span class="err">ムが開始される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">StartCommand</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">プロパティ変更通知が正しく発火する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">propertyChanged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">PropertyChanged</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">PropertyName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">GameViewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">))</span>
<span class="w">                </span><span class="n">propertyChanged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">InitializeGame</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">propertyChanged</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>次に、ViewModelを実装しましょう：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>PuyoPuyoWPF/ViewModels
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/ViewModels/GameViewModel.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ObservableObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[ObservableProperty]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="n">_game</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">GameViewModel</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">InitializeGame</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">InitializeGame</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[RelayCommand]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[RelayCommand]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InitializeGame</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「CommunityToolkit.MvvmのSource Generatorを使っているんですね！」その通りです！<code>[ObservableProperty]</code>属性を使うと、自動的にプロパティ変更通知が生成されます。<code>[RelayCommand]</code>属性は、自動的にICommandの実装を生成してくれます。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「テストが通りましたね！」完璧です！これでViewModelの基本機能が実装できました。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: GameViewModelを実装&#39;</span>
</code></pre></div>
<h3 id="viewviewmodel">ViewとViewModelの統合<a class="headerlink" href="#viewviewmodel" title="Permanent link">&para;</a></h3>
<p>最後に、ViewModelをViewに統合しましょう。MainWindow.xamlを更新します：</p>
<div class="highlight"><pre><span></span><code>//<span class="w"> </span>PuyoPuyoWPF/MainWindow.xaml
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyoWPF.MainWindow&quot;</span>
<span class="w">        </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">xmlns:d=</span><span class="s">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span>
<span class="w">        </span><span class="na">xmlns:mc=</span><span class="s">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span>
<span class="w">        </span><span class="na">xmlns:viewmodels=</span><span class="s">&quot;clr-namespace:PuyoPuyoWPF.ViewModels&quot;</span>
<span class="w">        </span><span class="na">mc:Ignorable=</span><span class="s">&quot;d&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;600&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.DataContext&gt;</span>
<span class="w">        </span><span class="nt">&lt;viewmodels:GameViewModel</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.DataContext&gt;</span>

<span class="w">    </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;Grid.RowDefinitions&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Grid.RowDefinitions&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- スコア表示 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Score.CurrentScore, StringFormat=&#39;スコア: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;20&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Score.ChainCount, StringFormat=&#39;チェーン: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;16&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲームエリア（仮） --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Canvas</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;White&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;200&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;ゲームエリア&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Canvas&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ボタンエリア --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Horizontal&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;スタート&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding StartCommand}&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;リセット&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding ResetCommand}&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>MainWindow.xaml.csも更新しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/MainWindow.xaml.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MainWindow</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Window</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">MainWindow</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InitializeComponent</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「WPFアプリケーションができましたね！」はい、実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>run<span class="w"> </span>--project<span class="w"> </span>PuyoPuyoWPF
</code></pre></div>
<p>「ウィンドウが表示されて、スタートボタンとリセットボタンがありますね！」その通りです。まだゲームエリアは空ですが、基本的な構造はできました。</p>
<p>最後に、すべてのテストとカバレッジを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Quality
</code></pre></div>
<p>「すべてのテストが通って、カバレッジレポートも生成されましたね！」素晴らしい！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ViewとViewModelを統合してゲーム開始画面を作成&#39;</span>
</code></pre></div>
<h3 id="1_1">イテレーション1のまとめ<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション1が完了しました。このイテレーションでは、以下のことを実現しました：</p>
<ol>
<li><strong>ゲームの初期化</strong>: 必要なコンポーネント（Config、Stage、Player、Score）の作成</li>
<li><strong>ゲームモード管理</strong>: ゲームの状態（Start、Playing、GameOver）の管理</li>
<li><strong>MVVMパターン実装</strong>: ViewModelによるプレゼンテーションロジックの分離</li>
<li><strong>WPF UI統合</strong>: XAMLによるデータバインディングとコマンド実装</li>
</ol>
<p><strong>学んだこと</strong>:
- テストファーストの開発プロセス
- 単一責任の原則に基づいたクラス設計
- WPFのMVVMパターン
- CommunityToolkit.MvvmのSource Generator活用
- XAMLデータバインディング</p>
<p>次のイテレーションでは、実際にぷよを画面に表示し、操作できるようにしていきますよ！</p>
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームの基本的な構造ができましたね。「ゲームが始まったけど、ぷよが動かないと面白くないよね？」と思いませんか？そこで次は、ぷよを左右に移動できるようにしていきましょう！</p>
<h3 id="_21">ユーザーストーリー<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「ぷよぷよって、落ちてくるぷよを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「左右の移動」を実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。</p>
<blockquote>
<p>TODOリストは、大きな問題を小さな問題に分割するための強力なツールです。複雑な問題に直面したとき、それを管理可能な小さなタスクに分解することで、一歩一歩確実に前進できます。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ぷよを左右に移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>プレイヤーの入力を検出する（キーボードの左右キーが押されたことを検知する）</li>
<li>ぷよを左右に移動する処理を実装する（実際にぷよの位置を変更する）</li>
<li>移動可能かどうかのチェックを実装する（画面の端や他のぷよにぶつかる場合は移動できないようにする）</li>
<li>移動後の表示を更新する（画面上でぷよの位置が変わったことを表示する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_22">テスト: プレイヤーの入力検出<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、プレイヤーの入力を検出する部分からテストしていきましょう。キーボードの左右キーが押されたときに、それを正しく検知できるかどうかをテストします。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/PlayerTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PlayerTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="n">_config</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">_stage</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="n">_player</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">PlayerTest</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Config</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">_config</span><span class="p">.</span><span class="n">StageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">_config</span><span class="p">.</span><span class="n">StageHeight</span><span class="p">);</span>
<span class="w">        </span><span class="n">_player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Player</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左キ</span><span class="n">ー</span><span class="err">が押されると左向きの移動フラグが立つ</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">InputKeyLeft</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右キ</span><span class="n">ー</span><span class="err">が押されると右向きの移動フラグが立つ</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">SetInputRight</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">InputKeyRight</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">キ</span><span class="n">ー</span><span class="err">が離されると対応する移動フラグが下がる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">InputKeyLeft</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">InputKeyLeft</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストは何をしているんですか？」このテストでは、キーボードの左右キーが押されたときと離されたときに、<code>Player</code>クラスの中の対応するフラグが正しく設定されるかどうかを確認しています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「コンパイルエラーになりますね」そうです、まだ必要なメソッドが実装されていないからです。これがTDDの「レッド（失敗）」の状態です。</p>
<h3 id="_23">実装: プレイヤーの入力検出<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>「失敗するテストができたので、次は実装ですね！」そうです！テストが通るように、最小限のコードを実装していきましょう。</p>
<blockquote>
<p>最小限の実装</p>
<p>テストを通すために、どれだけのコードを書けばよいだろうか——テストが通る最小限のコードだけを書こう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/Player.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Player</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CurrentX</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CurrentY</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">Player</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期位置（中央）</span>
<span class="w">        </span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期位置（上端）</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputLeft</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputRight</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveLeft</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanMove</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveRight</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanMove</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CanMove</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 画面の範囲内かチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Width</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// その位置にすでにぷよがあるかチェック</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「入力フラグの管理に加えて、移動処理も実装したんですね！」その通りです。テストを通すだけでなく、次のテストで必要になる機能も先読みして実装しました。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「テストが通りましたね！」素晴らしい！これで入力検出の機能が完成しました。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: プレイヤーの入力検出を実装&#39;</span>
</code></pre></div>
<h3 id="_24">テスト: ぷよの移動処理<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>次に、実際にぷよを移動させる処理のテストを書きましょう。左右に移動できることと、画面の端では移動できないことをテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/PlayerTest.cs</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左に移動できる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">MoveLeft</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右に移動できる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">MoveRight</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左端では左に移動できない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">MoveLeft</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右端では右に移動できない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_config</span><span class="p">.</span><span class="n">StageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">MoveRight</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">_config</span><span class="p">.</span><span class="n">StageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよがある位置には移動できない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 右にぷよを配置</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">MoveRight</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 移動していない</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストは何をチェックしているんですか？」このテストでは以下のことを確認しています：</p>
<ol>
<li><strong>基本的な移動</strong>: 左右に正しく移動できるか</li>
<li><strong>境界チェック</strong>: 画面の端では移動できないか</li>
<li><strong>衝突判定</strong>: すでにぷよがある場所には移動できないか</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」完璧です！移動処理が正しく実装されていることが確認できました。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよの移動処理のテストを追加&#39;</span>
</code></pre></div>
<h3 id="viewmodel_1">ViewModelへのキー入力処理の統合<a class="headerlink" href="#viewmodel_1" title="Permanent link">&para;</a></h3>
<p>次に、WPFのViewModelにキー入力処理を統合しましょう。WPFでは、キーボードイベントをViewModelで処理します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/ViewModels/GameViewModel.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ObservableObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[ObservableProperty]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="n">_game</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">GameViewModel</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">InitializeGame</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">InitializeGame</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[RelayCommand]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[RelayCommand]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InitializeGame</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveLeft</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRight</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveRight</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleKeyUp</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRight</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「HandleKeyDownとHandleKeyUpメソッドが追加されましたね！」その通りです。これらのメソッドは、View側からキーボードイベントを受け取って、ゲームロジックに反映します。</p>
<h3 id="viewmodel_2">ViewModelのテスト<a class="headerlink" href="#viewmodel_2" title="Permanent link">&para;</a></h3>
<p>ViewModelのキー入力処理もテストしておきましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/ViewModels/GameViewModelTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.ViewModels</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModelTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">ViewModel</span><span class="err">を初期化するとゲ</span><span class="n">ー</span><span class="err">ムが初期化される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Start</span><span class="err">コマンドを実行するとゲ</span><span class="n">ー</span><span class="err">ムが開始される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">StartCommand</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左キ</span><span class="n">ー</span><span class="err">を押すとぷよが左に移動する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右キ</span><span class="n">ー</span><span class="err">を押すとぷよが右に移動する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムが</span><span class="n">Playing</span><span class="err">状態でないときはキ</span><span class="n">ー</span><span class="err">入力を受け付けない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Start状態のまま（Playing状態にしない）</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 移動していない</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ViewModelにキー入力処理を統合&#39;</span>
</code></pre></div>
<h3 id="view">Viewへのキーボードイベント処理の追加<a class="headerlink" href="#view" title="Permanent link">&para;</a></h3>
<p>最後に、MainWindow.xamlにキーボードイベントハンドラーを追加しましょう：</p>
<div class="highlight"><pre><span></span><code>//<span class="w"> </span>PuyoPuyoWPF/MainWindow.xaml
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyoWPF.MainWindow&quot;</span>
<span class="w">        </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">xmlns:d=</span><span class="s">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span>
<span class="w">        </span><span class="na">xmlns:mc=</span><span class="s">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span>
<span class="w">        </span><span class="na">xmlns:viewmodels=</span><span class="s">&quot;clr-namespace:PuyoPuyoWPF.ViewModels&quot;</span>
<span class="w">        </span><span class="na">mc:Ignorable=</span><span class="s">&quot;d&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;600&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span>
<span class="w">        </span><span class="na">KeyDown=</span><span class="s">&quot;Window_KeyDown&quot;</span>
<span class="w">        </span><span class="na">KeyUp=</span><span class="s">&quot;Window_KeyUp&quot;</span>
<span class="w">        </span><span class="na">Focusable=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.DataContext&gt;</span>
<span class="w">        </span><span class="nt">&lt;viewmodels:GameViewModel</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.DataContext&gt;</span>

<span class="w">    </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;Grid.RowDefinitions&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Grid.RowDefinitions&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- スコア表示 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Score.CurrentScore, StringFormat=&#39;スコア: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;20&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Score.ChainCount, StringFormat=&#39;チェーン: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;16&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Mode, StringFormat=&#39;モード: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;14&quot;</span><span class="w"> </span><span class="na">Foreground=</span><span class="s">&quot;Gray&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲームエリア --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Canvas</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;White&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;80&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;200&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;ゲームエリア&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;60&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;240&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;14&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;← → キーで移動できます&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Canvas&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ボタンエリア --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Horizontal&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;スタート&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding StartCommand}&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;リセット&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding ResetCommand}&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>次に、コードビハインドを更新します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/MainWindow.xaml.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MainWindow</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Window</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">MainWindow</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InitializeComponent</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Window_KeyDown</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">KeyEventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DataContext</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">GameViewModel</span><span class="w"> </span><span class="n">viewModel</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Window_KeyUp</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">KeyEventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DataContext</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">GameViewModel</span><span class="w"> </span><span class="n">viewModel</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyUp</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「KeyDownとKeyUpイベントをViewModelに転送しているんですね！」その通りです。WPFでは、View側でイベントを受け取り、ViewModelに処理を委譲するパターンがよく使われます。</p>
<p>すべてのテストを実行して確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Quality
</code></pre></div>
<p>「すべてのテストが通って、カバレッジも良好ですね！」素晴らしい！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: キーボード入力によるぷよの移動を実装&#39;</span>
</code></pre></div>
<h3 id="2_1">イテレーション2のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション2が完了しました。このイテレーションでは、以下のことを実現しました：</p>
<ol>
<li><strong>入力検出</strong>: キーボードの左右キーの入力検出</li>
<li><strong>移動処理</strong>: ぷよを左右に移動する機能</li>
<li><strong>境界チェック</strong>: 画面の端での移動制限</li>
<li><strong>衝突判定</strong>: 他のぷよとの衝突検出</li>
<li><strong>MVVM統合</strong>: ViewModelとViewへのキー入力処理の統合</li>
</ol>
<p><strong>学んだこと</strong>:
- テスト駆動開発による段階的な機能実装
- 境界値のテスト（画面の端の処理）
- WPFでのキーボードイベント処理
- ViewとViewModelの連携パターン</p>
<p><strong>テスト駆動開発のメリット</strong>:
- バグの早期発見：移動ロジックのバグをコーディング中に発見・修正
- 安心してリファクタリング：テストがあるので、後から安全にコード改善可能
- ドキュメント代わり：テストコードが仕様書の役割を果たす</p>
<p>次のイテレーションでは、ぷよの回転機能を実装していきますよ！</p>
<h2 id="3">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_25">ユーザーストーリー<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、この2つのぷよの相対的な位置関係を変えることです。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<blockquote>
<p>TODOリストは、実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ぷよを回転させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの回転処理を実装する（時計回り・反時計回りの回転）</li>
<li>回転可能かどうかのチェックを実装する（他のぷよや壁にぶつかる場合は回転できないようにする）</li>
<li>壁キック処理を実装する（壁際での回転を可能にする特殊処理）</li>
</ul>
<h3 id="_26">テスト: ぷよの回転<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは基本的な回転機能のテストから書いていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/PlayerTest.cs</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">時計回りに回転すると回転状態が</span><span class="mi">1</span><span class="err">増える</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">((</span><span class="n">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">反時計回りに回転すると回転状態が</span><span class="mi">1</span><span class="err">減る</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">RotateLeft</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">回転状態は</span><span class="mi">0</span><span class="err">から</span><span class="mi">3</span><span class="err">の範囲で循環する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">回転状態が</span><span class="mi">0</span><span class="err">から反時計回りに回転すると</span><span class="mi">3</span><span class="err">になる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">RotateLeft</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「回転状態が0から3まであるんですね！」その通りです。ぷよの回転状態は以下の4つです：</p>
<ul>
<li><strong>0</strong>: 上（初期状態）</li>
<li><strong>1</strong>: 右</li>
<li><strong>2</strong>: 下</li>
<li><strong>3</strong>: 左</li>
</ul>
<p>「なるほど、90度ずつ回転するんですね！」そうです。時計回りに回転すると状態が1増え、反時計回りに回転すると1減ります。そして、3から1増えると0に戻り（モジュロ演算）、0から1減ると3になります。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「コンパイルエラーになりますね」そうです、まだ回転のメソッドが実装されていないからです。これがTDDの「レッド（失敗）」の状態です。</p>
<h3 id="_27">実装: ぷよの回転<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>それでは、テストが通るように回転機能を実装しましょう。まず、<code>Player</code>クラスに回転状態と回転メソッドを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/Player.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Player</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CurrentX</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CurrentY</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyRotateLeft</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyRotateRight</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">Player</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期位置（中央）</span>
<span class="w">        </span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期位置（上端）</span>
<span class="w">        </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期回転状態（上）</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyRotateLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyRotateRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputLeft</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputRight</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputRotateLeft</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyRotateLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputRotateRight</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyRotateRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveLeft</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanMove</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveRight</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanMove</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateRight</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanRotate</span><span class="p">(</span><span class="n">CurrentX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">TryWallKick</span><span class="p">(</span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 壁キックが成功した場合、位置と回転が調整される</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateLeft</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Rotation</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanRotate</span><span class="p">(</span><span class="n">CurrentX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">TryWallKick</span><span class="p">(</span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 壁キックが成功した場合、位置と回転が調整される</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CanMove</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 画面の範囲内かチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Width</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// その位置にすでにぷよがあるかチェック</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CanRotate</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rotation</span><span class="p">,</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 軸ぷよの位置をチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CanMove</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 子ぷよの位置をチェック</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="p">,</span><span class="w"> </span><span class="n">childY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetChildPosition</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Width</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">childX</span><span class="p">,</span><span class="w"> </span><span class="n">childY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">TryWallKick</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 壁キック: 左に1マス</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanRotate</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">--</span><span class="p">;</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 壁キック: 右に1マス</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanRotate</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">GetChildPosition</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">parentX</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">parentY</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rotation</span><span class="w"> </span><span class="k">switch</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="p">),</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="c1">// 下</span>
<span class="w">            </span><span class="mi">3</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="p">),</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">GetChildPosition</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">GetChildPosition</span><span class="p">(</span><span class="n">CurrentX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「たくさんのメソッドが追加されましたね！」そうですね。それぞれの役割を説明しましょう：</p>
<ul>
<li><strong>RotateRight/RotateLeft</strong>: 回転を実行するメソッド</li>
<li><strong>CanRotate</strong>: 指定した位置と回転で回転可能かチェック</li>
<li><strong>TryWallKick</strong>: 壁キック処理（壁際での回転補正）</li>
<li><strong>GetChildPosition</strong>: 回転状態に応じた子ぷよの位置を計算</li>
</ul>
<p>「壁キックって何ですか？」良い質問です！壁キックは、壁際でぷよを回転させようとしたときに、少し横にずらすことで回転を可能にする機能です。これがあると、プレイの自由度が大きく向上しますよ！</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「テストが通りましたね！」素晴らしい！回転機能の基本が実装できました。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの回転機能を実装&#39;</span>
</code></pre></div>
<h3 id="_28">テスト: 回転の制約<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>次に、回転に関する制約をテストしましょう。壁や他のぷよがある場合の回転動作を確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/PlayerRotationTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PlayerRotationTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="n">_config</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">_stage</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="n">_player</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">PlayerRotationTest</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Config</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">_config</span><span class="p">.</span><span class="n">StageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">_config</span><span class="p">.</span><span class="n">StageHeight</span><span class="p">);</span>
<span class="w">        </span><span class="n">_player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Player</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">回転先に障害物がある場合は回転できない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 右側にぷよを配置</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span><span class="w"> </span><span class="c1">// 右に回転しようとする</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span><span class="w"> </span><span class="c1">// 回転していない</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左端で回転すると壁キックで右にずれる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 上</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">RotateLeft</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span><span class="w"> </span><span class="c1">// 左に回転（子ぷよが画面外に出る）</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span><span class="w"> </span><span class="c1">// 左向きに回転</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 壁キックで右に1マス移動</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右端で回転すると壁キックで左にずれる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_config</span><span class="p">.</span><span class="n">StageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 上</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span><span class="w"> </span><span class="c1">// 右に回転（子ぷよが画面外に出る）</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span><span class="w"> </span><span class="c1">// 右向きに回転</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">_config</span><span class="p">.</span><span class="n">StageWidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 壁キックで左に1マス移動</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">壁キックもできない場合は回転しない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 右側にぷよを配置（壁キック先をブロック）</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">RotateLeft</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span><span class="w"> </span><span class="c1">// 回転していない</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 移動していない</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">子ぷよの位置が正しく計算される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 各回転状態で子ぷよの位置を確認</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">y0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">GetChildPosition</span><span class="p">();</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">y0</span><span class="p">));</span><span class="w"> </span><span class="c1">// 上</span>

<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">GetChildPosition</span><span class="p">();</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">));</span><span class="w"> </span><span class="c1">// 右</span>

<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">GetChildPosition</span><span class="p">();</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="p">));</span><span class="w"> </span><span class="c1">// 下</span>

<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">y3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">GetChildPosition</span><span class="p">();</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">y3</span><span class="p">));</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「壁キックの動作を細かくテストしているんですね！」そうです。特に重要なのは以下のケースです：</p>
<ol>
<li><strong>障害物がある場合</strong>: 回転できない</li>
<li><strong>左端での回転</strong>: 右にずれて回転（壁キック）</li>
<li><strong>右端での回転</strong>: 左にずれて回転（壁キック）</li>
<li><strong>壁キックもできない場合</strong>: 回転しない</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: 回転の制約と壁キックのテストを追加&#39;</span>
</code></pre></div>
<h3 id="viewmodel_3">ViewModelへの回転処理の統合<a class="headerlink" href="#viewmodel_3" title="Permanent link">&para;</a></h3>
<p>次に、ViewModelに回転処理を統合しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/ViewModels/GameViewModel.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ObservableObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[ObservableProperty]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="n">_game</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">GameViewModel</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">InitializeGame</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">InitializeGame</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[RelayCommand]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[RelayCommand]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InitializeGame</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveLeft</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRight</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveRight</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Up</span><span class="p">:</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Z</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRotateLeft</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">RotateLeft</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">X</span><span class="p">:</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Space</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRotateRight</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">RotateRight</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleKeyUp</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRight</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Up</span><span class="p">:</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Z</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRotateLeft</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">X</span><span class="p">:</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Space</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRotateRight</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「回転のキーが複数ありますね！」そうです。より柔軟な操作を実現するため、以下のキーで回転できるようにしました：</p>
<ul>
<li><strong>反時計回り</strong>: ↑キー または Zキー</li>
<li><strong>時計回り</strong>: Xキー または スペースキー</li>
</ul>
<h3 id="viewmodel_4">ViewModelのテスト更新<a class="headerlink" href="#viewmodel_4" title="Permanent link">&para;</a></h3>
<p>ViewModelのテストも更新しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/ViewModels/GameViewModelTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.ViewModels</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModelTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">ViewModel</span><span class="err">を初期化するとゲ</span><span class="n">ー</span><span class="err">ムが初期化される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Start</span><span class="err">コマンドを実行するとゲ</span><span class="n">ー</span><span class="err">ムが開始される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">StartCommand</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左キ</span><span class="n">ー</span><span class="err">を押すとぷよが左に移動する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右キ</span><span class="n">ー</span><span class="err">を押すとぷよが右に移動する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Z</span><span class="err">キ</span><span class="n">ー</span><span class="err">を押すとぷよが反時計回りに回転する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">X</span><span class="err">キ</span><span class="n">ー</span><span class="err">を押すとぷよが時計回りに回転する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">Rotation</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">((</span><span class="n">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムが</span><span class="n">Playing</span><span class="err">状態でないときはキ</span><span class="n">ー</span><span class="err">入力を受け付けない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Start状態のまま（Playing状態にしない）</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">);</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 移動していない</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialRotation</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span><span class="w"> </span><span class="c1">// 回転していない</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ViewModelに回転処理を統合&#39;</span>
</code></pre></div>
<h3 id="view_1">Viewの更新<a class="headerlink" href="#view_1" title="Permanent link">&para;</a></h3>
<p>最後に、MainWindow.xamlを更新して、操作方法を表示しましょう：</p>
<div class="highlight"><pre><span></span><code>//<span class="w"> </span>PuyoPuyoWPF/MainWindow.xaml
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyoWPF.MainWindow&quot;</span>
<span class="w">        </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">xmlns:d=</span><span class="s">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span>
<span class="w">        </span><span class="na">xmlns:mc=</span><span class="s">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span>
<span class="w">        </span><span class="na">xmlns:viewmodels=</span><span class="s">&quot;clr-namespace:PuyoPuyoWPF.ViewModels&quot;</span>
<span class="w">        </span><span class="na">mc:Ignorable=</span><span class="s">&quot;d&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;650&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span>
<span class="w">        </span><span class="na">KeyDown=</span><span class="s">&quot;Window_KeyDown&quot;</span>
<span class="w">        </span><span class="na">KeyUp=</span><span class="s">&quot;Window_KeyUp&quot;</span>
<span class="w">        </span><span class="na">Focusable=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.DataContext&gt;</span>
<span class="w">        </span><span class="nt">&lt;viewmodels:GameViewModel</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.DataContext&gt;</span>

<span class="w">    </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;Grid.RowDefinitions&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Grid.RowDefinitions&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- スコア表示 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Score.CurrentScore, StringFormat=&#39;スコア: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;20&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Score.ChainCount, StringFormat=&#39;チェーン: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;16&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Mode, StringFormat=&#39;モード: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;14&quot;</span><span class="w"> </span><span class="na">Foreground=</span><span class="s">&quot;Gray&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲームエリア --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Canvas</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;White&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;80&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;180&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;ゲームエリア&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;220&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;← → : 移動&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;240&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;Z / ↑ : 反時計回り回転&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;260&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;X / Space : 時計回り回転&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Canvas&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ボタンエリア --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Horizontal&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;スタート&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding StartCommand}&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;リセット&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding ResetCommand}&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- 操作説明 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;3&quot;</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;LightGray&quot;</span><span class="w"> </span><span class="na">Padding=</span><span class="s">&quot;10&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10,0,10,10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">TextWrapping=</span><span class="s">&quot;Wrap&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;11&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;操作方法: &quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;← → で移動、&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;Z / ↑ で反時計回り回転、&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;X / Space で時計回り回転&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/TextBlock&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>すべてのテストとカバレッジを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Quality
</code></pre></div>
<p>「すべてのテストが通って、カバレッジも良好ですね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 回転機能の操作説明をUIに追加&#39;</span>
</code></pre></div>
<h3 id="3_1">イテレーション3のまとめ<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション3が完了しました。このイテレーションでは、以下のことを実現しました：</p>
<ol>
<li><strong>回転処理</strong>: 時計回り・反時計回りの回転機能</li>
<li><strong>回転制約</strong>: 障害物や壁による回転制限</li>
<li><strong>壁キック</strong>: 壁際での回転補正機能</li>
<li><strong>子ぷよの位置計算</strong>: 回転状態に応じた相対位置の計算</li>
<li><strong>複数キー対応</strong>: より柔軟な操作性の実現</li>
</ol>
<p><strong>学んだこと</strong>:
- 回転の数学的な実装（モジュロ演算）
- 壁キックアルゴリズム
- 境界条件の複雑なテスト
- ゲーム特有のユーザビリティ向上テクニック</p>
<p><strong>壁キックの重要性</strong>:
壁キックは、プレイヤーの意図を汲み取る重要な機能です。「壁際で回転しようとした→できなかった」ではなく、「少しずらせば回転できる→自動的にずらして回転する」という動作により、プレイの快適さが大きく向上します。</p>
<p>次のイテレーションでは、ぷよの落下と高速落下機能を実装していきますよ！</p>
<h2 id="4">イテレーション4: ぷよの高速落下の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよってもっと早く落とせたよね？」そうですね！ぷよぷよでは、プレイヤーが下キーを押すことで、ぷよを素早く落下させることができます。今回は、その「高速落下」と基本的な「自動落下」機能を実装していきましょう！</p>
<h3 id="_29">ユーザーストーリー<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ぷよを素早く落下させることができる</p>
</blockquote>
<p>「早く次のぷよを落としたい！」というときに、下キーを押して素早く落下させる機能は、ゲームのテンポを良くするために重要ですね。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<blockquote>
<p>TODOリストは、実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ぷよを素早く落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>下キー入力の検出を実装する（キーボードの下キーが押されたことを検知する）</li>
<li>高速落下処理を実装する（下キーが押されているときは落下速度を上げる）</li>
<li>落下可能かどうかのチェックを実装する（下に障害物がある場合は落下できないようにする）</li>
<li>自動落下処理を実装する（時間経過で自動的に下に移動する）</li>
</ul>
<h3 id="_30">テスト: 落下処理<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよが下に移動できるかどうか、そして障害物がある場合は移動できないことをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/PlayerTest.cs</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">下キ</span><span class="n">ー</span><span class="err">の入力フラグを設定できる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">SetInputDown</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">InputKeyDown</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">下に移動できる場合下に移動する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">moved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">moved</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">下端では下に移動できない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_config</span><span class="p">.</span><span class="n">StageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">moved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">moved</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">_config</span><span class="p">.</span><span class="n">StageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">下にぷよがある場合下に移動できない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">moved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">_stage</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">moved</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">CurrentY</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">高速落下フラグを取得できる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">SetInputDown</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">normalSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">IsFastDrop</span><span class="p">;</span>

<span class="w">        </span><span class="n">_player</span><span class="p">.</span><span class="n">SetInputDown</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">fastSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_player</span><span class="p">.</span><span class="n">IsFastDrop</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">normalSpeed</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">fastSpeed</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「落下処理を細かくテストしているんですね！」そうです。特に重要なのは以下のケースです：</p>
<ol>
<li><strong>基本的な落下</strong>: 下に移動できる</li>
<li><strong>下端チェック</strong>: 画面の下端では移動できない</li>
<li><strong>衝突判定</strong>: 下にぷよがある場合は移動できない</li>
<li><strong>高速落下フラグ</strong>: 下キーが押されているかを判定</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「コンパイルエラーになりますね」そうです、まだ必要なメソッドが実装されていないからです。</p>
<h3 id="_31">実装: 落下処理<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>それでは、テストが通るように落下機能を実装しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/Player.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Player</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CurrentX</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CurrentY</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Rotation</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyRotateLeft</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyRotateRight</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">InputKeyDown</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsFastDrop</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">InputKeyDown</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">Player</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期位置（中央）</span>
<span class="w">        </span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期位置（上端）</span>
<span class="w">        </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期回転状態（上）</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="n">CurrentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyRotateLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyRotateRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">InputKeyDown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputLeft</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputRight</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputRotateLeft</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyRotateLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputRotateRight</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyRotateRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetInputDown</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">isPressed</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InputKeyDown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPressed</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveLeft</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanMove</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveRight</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanMove</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">MoveDown</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanMove</span><span class="p">(</span><span class="n">CurrentX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentY</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateRight</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanRotate</span><span class="p">(</span><span class="n">CurrentX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">TryWallKick</span><span class="p">(</span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 壁キックが成功した場合、位置と回転が調整される</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateLeft</span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">newRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Rotation</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanRotate</span><span class="p">(</span><span class="n">CurrentX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">TryWallKick</span><span class="p">(</span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 壁キックが成功した場合、位置と回転が調整される</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CanMove</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 画面の範囲内かチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Width</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// その位置にすでにぷよがあるかチェック</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CanRotate</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rotation</span><span class="p">,</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 軸ぷよの位置をチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CanMove</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 子ぷよの位置をチェック</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="p">,</span><span class="w"> </span><span class="n">childY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetChildPosition</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">rotation</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Width</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">childY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">childX</span><span class="p">,</span><span class="w"> </span><span class="n">childY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">TryWallKick</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 壁キック: 左に1マス</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanRotate</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">--</span><span class="p">;</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 壁キック: 右に1マス</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CanRotate</span><span class="p">(</span><span class="n">CurrentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">newRotation</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentX</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newRotation</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">GetChildPosition</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">parentX</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">parentY</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rotation</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rotation</span><span class="w"> </span><span class="k">switch</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="p">),</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="c1">// 下</span>
<span class="w">            </span><span class="mi">3</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="p">),</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">parentX</span><span class="p">,</span><span class="w"> </span><span class="n">parentY</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">GetChildPosition</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">GetChildPosition</span><span class="p">(</span><span class="n">CurrentX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentY</span><span class="p">,</span><span class="w"> </span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>MoveDown</code>メソッドが<code>bool</code>を返すようになりましたね！」そうです。これにより、ぷよが実際に下に移動できたかどうかを判定できます。移動できなかった場合（下端や障害物がある場合）は<code>false</code>を返すので、このタイミングでぷよを固定する処理を実行できます。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「テストが通りましたね！」素晴らしい！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの落下処理を実装&#39;</span>
</code></pre></div>
<h3 id="viewmodel_5">ViewModelへの落下処理の統合<a class="headerlink" href="#viewmodel_5" title="Permanent link">&para;</a></h3>
<p>次に、ViewModelに下キー入力と落下処理を統合しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/ViewModels/GameViewModel.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ObservableObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[ObservableProperty]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="n">_game</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">GameViewModel</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">InitializeGame</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">InitializeGame</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[RelayCommand]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Game</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[RelayCommand]</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InitializeGame</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveLeft</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRight</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveRight</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Up</span><span class="p">:</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Z</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRotateLeft</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">RotateLeft</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">X</span><span class="p">:</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Space</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRotateRight</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">RotateRight</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Down</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputDown</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// 高速落下の場合は連続で落下</span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">true</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 落下できる限り落下し続ける</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">OnPropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Game</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleKeyUp</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputLeft</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRight</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Up</span><span class="p">:</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Z</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRotateLeft</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">X</span><span class="p">:</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Space</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputRotateRight</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Down</span><span class="p">:</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">SetInputDown</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「下キーを押すと一気に落下するんですね！」そうです。<code>while</code>ループを使って、移動できなくなるまで（着地するまで）連続で下に移動させています。これにより、いわゆる「ハードドロップ」の機能が実現できます。</p>
<h3 id="viewmodel_6">ViewModelのテスト更新<a class="headerlink" href="#viewmodel_6" title="Permanent link">&para;</a></h3>
<p>ViewModelのテストも更新しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/ViewModels/GameViewModelTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.ViewModels</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.ViewModels</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModelTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">ViewModel</span><span class="err">を初期化するとゲ</span><span class="n">ー</span><span class="err">ムが初期化される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Start</span><span class="err">コマンドを実行するとゲ</span><span class="n">ー</span><span class="err">ムが開始される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">StartCommand</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左キ</span><span class="n">ー</span><span class="err">を押すとぷよが左に移動する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右キ</span><span class="n">ー</span><span class="err">を押すとぷよが右に移動する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Z</span><span class="err">キ</span><span class="n">ー</span><span class="err">を押すとぷよが反時計回りに回転する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">X</span><span class="err">キ</span><span class="n">ー</span><span class="err">を押すとぷよが時計回りに回転する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">Rotation</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">((</span><span class="n">initialRotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">下キ</span><span class="n">ー</span><span class="err">を押すとぷよが最下端まで落下する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Config</span><span class="o">!</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Down</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="c1">// 最下端（またはそれに近い位置）に到達している</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">StageHeight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムが</span><span class="n">Playing</span><span class="err">状態でないときはキ</span><span class="n">ー</span><span class="err">入力を受け付けない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Start状態のまま（Playing状態にしない）</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentY</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">initialRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">);</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Down</span><span class="p">);</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialX</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 移動していない</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialY</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">CurrentY</span><span class="p">);</span><span class="w"> </span><span class="c1">// 落下していない</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialRotation</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="p">);</span><span class="w"> </span><span class="c1">// 回転していない</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ViewModelに高速落下処理を統合&#39;</span>
</code></pre></div>
<h3 id="view_2">Viewの更新<a class="headerlink" href="#view_2" title="Permanent link">&para;</a></h3>
<p>最後に、MainWindow.xamlを更新して、下キーの操作方法を表示しましょう：</p>
<div class="highlight"><pre><span></span><code>//<span class="w"> </span>PuyoPuyoWPF/MainWindow.xaml
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyoWPF.MainWindow&quot;</span>
<span class="w">        </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">xmlns:d=</span><span class="s">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span>
<span class="w">        </span><span class="na">xmlns:mc=</span><span class="s">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span>
<span class="w">        </span><span class="na">xmlns:viewmodels=</span><span class="s">&quot;clr-namespace:PuyoPuyoWPF.ViewModels&quot;</span>
<span class="w">        </span><span class="na">mc:Ignorable=</span><span class="s">&quot;d&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;650&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span>
<span class="w">        </span><span class="na">KeyDown=</span><span class="s">&quot;Window_KeyDown&quot;</span>
<span class="w">        </span><span class="na">KeyUp=</span><span class="s">&quot;Window_KeyUp&quot;</span>
<span class="w">        </span><span class="na">Focusable=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.DataContext&gt;</span>
<span class="w">        </span><span class="nt">&lt;viewmodels:GameViewModel</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.DataContext&gt;</span>

<span class="w">    </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;Grid.RowDefinitions&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;RowDefinition</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;Auto&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Grid.RowDefinitions&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- スコア表示 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Score.CurrentScore, StringFormat=&#39;スコア: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;20&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Score.ChainCount, StringFormat=&#39;チェーン: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;16&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding Game.Mode, StringFormat=&#39;モード: {0}&#39;}&quot;</span><span class="w"> </span>
<span class="w">                       </span><span class="na">FontSize=</span><span class="s">&quot;14&quot;</span><span class="w"> </span><span class="na">Foreground=</span><span class="s">&quot;Gray&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲームエリア --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Canvas</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;White&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;80&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;160&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;ゲームエリア&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;200&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;← → : 移動&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;220&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;Z / ↑ : 反時計回り回転&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;240&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;X / Space : 時計回り回転&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Canvas.Left=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="na">Canvas.Top=</span><span class="s">&quot;260&quot;</span><span class="w"> </span>
<span class="w">                           </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;↓ : 高速落下&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Canvas&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ボタンエリア --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Orientation=</span><span class="s">&quot;Horizontal&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;スタート&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding StartCommand}&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;リセット&quot;</span><span class="w"> </span><span class="na">Command=</span><span class="s">&quot;{Binding ResetCommand}&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;100&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- 操作説明 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Row=</span><span class="s">&quot;3&quot;</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;LightGray&quot;</span><span class="w"> </span><span class="na">Padding=</span><span class="s">&quot;10&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10,0,10,10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">TextWrapping=</span><span class="s">&quot;Wrap&quot;</span><span class="w"> </span><span class="na">FontSize=</span><span class="s">&quot;11&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;操作方法: &quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;← → で移動、&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;Z / ↑ で反時計回り回転、&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;X / Space で時計回り回転、&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;Run</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;↓ で高速落下&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/TextBlock&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>すべてのテストとカバレッジを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Quality
</code></pre></div>
<p>「すべてのテストが通って、カバレッジも良好ですね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 高速落下機能の操作説明をUIに追加&#39;</span>
</code></pre></div>
<h3 id="4_1">イテレーション4のまとめ<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション4が完了しました。このイテレーションでは、以下のことを実現しました：</p>
<ol>
<li><strong>下キー入力</strong>: 下キーの入力検出</li>
<li><strong>落下処理</strong>: <code>MoveDown</code>メソッドによる1マスの落下</li>
<li><strong>落下可能判定</strong>: 下端や障害物のチェック</li>
<li><strong>高速落下</strong>: 下キーを押すと着地まで一気に落下（ハードドロップ）</li>
<li><strong>戻り値による状態通知</strong>: <code>bool</code>を返すことで移動可否を通知</li>
</ol>
<p><strong>学んだこと</strong>:
- 戻り値を使った状態の伝達方法
- <code>while</code>ループを使った連続処理
- ゲームの「気持ちよさ」を実現する高速落下
- 境界条件の重要性（下端チェック）</p>
<p><strong>高速落下の実装パターン</strong>:
今回実装した高速落下は「ハードドロップ」と呼ばれ、瞬時に着地する方式です。他にも「ソフトドロップ」（下キーを押している間だけ速く落ちる）という方式もあります。ゲームの性質に応じて選択できますが、今回はシンプルで爽快感のあるハードドロップを採用しました。</p>
<p><strong>次のステップ</strong>:
現在、ぷよを操作できるようになりましたが、まだぷよを消す機能がありません。次のイテレーションでは、ぷよぷよの核となる「同じ色のぷよを4つ以上つなげると消える」という機能を実装していきますよ！</p>
<h2 id="5">イテレーション5: ぷよの消去の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを4つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_32">ユーザーストーリー<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを4つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<blockquote>
<p>TODOリストは、実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li>4つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li>ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li>消去後の落下処理を実装する（消去された後の空きスペースにぷよが落ちてくる）</li>
</ul>
<h3 id="_33">テスト: ぷよの接続判定<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが4つ以上つながっているかどうかを判定する機能が必要です。</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>PuyoPuyoWPF.Tests/Models
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/StageTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">StageTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="n">_config</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="n">_stage</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">StageTest</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Config</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">_config</span><span class="p">.</span><span class="n">StageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">_config</span><span class="p">.</span><span class="n">StageHeight</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">同じ色のぷよが</span><span class="mi">4</span><span class="err">つつながっていると消去対象になる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotEmpty</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">EraseList</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">同じ色のぷよが</span><span class="mi">3</span><span class="err">つでは消去対象にならない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Empty</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">EraseList</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">異なる色のぷよは消去対象にならない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Empty</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">EraseList</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">縦に</span><span class="mi">5</span><span class="err">つつながっていても消去できる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">L</span><span class="err">字型につながっていても消去できる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「いろんなパターンをテストしているんですね！」そうです。ぷよの接続は、横、縦、L字など様々な形があり得ます。それらを網羅的にテストすることで、どんな形でも正しく判定できることを保証します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「コンパイルエラーになりますね」そうです、まだ<code>CheckErase</code>メソッドや<code>EraseInfo</code>が実装されていないからです。</p>
<h3 id="_34">実装: ぷよの接続判定<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>それでは、テストが通るように接続判定を実装していきましょう。まず、消去情報を表すレコード型と、<code>Stage</code>クラスの拡張を実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/EraseInfo.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">record</span><span class="w"> </span><span class="nf">EraseInfo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ErasePuyoCount</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Type</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EraseList</span><span class="p">);</span>
</code></pre></div>
<p>次に、<code>Stage</code>クラスに消去判定のメソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/Stage.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Stage</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_width</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_height</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="kt">int</span><span class="p">[,]</span><span class="w"> </span><span class="n">_grid</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">Stage</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">;</span>
<span class="w">        </span><span class="n">_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">;</span>
<span class="w">        </span><span class="n">_grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Width</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_width</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Height</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_height</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">GetCell</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">_width</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">_height</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_grid</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetCell</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="k">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_height</span><span class="p">)</span>
<span class="w">            </span><span class="n">_grid</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Clear</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_height</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_width</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">_grid</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">EraseInfo</span><span class="w"> </span><span class="nf">CheckErase</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Type</span><span class="p">)</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">bool</span><span class="p">[</span><span class="n">_height</span><span class="p">,</span><span class="w"> </span><span class="n">_width</span><span class="p">];</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_height</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_width</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_grid</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">visited</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">])</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="kt">var</span><span class="w"> </span><span class="n">puyoType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_grid</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">];</span>
<span class="w">                    </span><span class="kt">var</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Y</span><span class="p">)</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">                    </span><span class="n">SearchConnectedPuyo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">connected</span><span class="p">);</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connected</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">connX</span><span class="p">,</span><span class="w"> </span><span class="n">connY</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">connected</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                            </span><span class="n">eraseList</span><span class="p">.</span><span class="n">Add</span><span class="p">((</span><span class="n">connX</span><span class="p">,</span><span class="w"> </span><span class="n">connY</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">));</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">EraseInfo</span><span class="p">(</span><span class="n">eraseList</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="n">eraseList</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SearchConnectedPuyo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">startX</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">startY</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="kt">bool</span><span class="p">[,]</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Y</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">visited</span><span class="p">[</span><span class="n">startY</span><span class="p">,</span><span class="w"> </span><span class="n">startX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">connected</span><span class="p">.</span><span class="n">Add</span><span class="p">((</span><span class="n">startX</span><span class="p">,</span><span class="w"> </span><span class="n">startY</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// 4方向（上下左右）を探索</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">directions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>

<span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">directions</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dx</span><span class="p">;</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">nextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nextX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_width</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">nextY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nextY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_height</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">_grid</span><span class="p">[</span><span class="n">nextY</span><span class="p">,</span><span class="w"> </span><span class="n">nextX</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">puyoType</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="o">!</span><span class="n">visited</span><span class="p">[</span><span class="n">nextY</span><span class="p">,</span><span class="w"> </span><span class="n">nextX</span><span class="p">])</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">SearchConnectedPuyo</span><span class="p">(</span><span class="n">nextX</span><span class="p">,</span><span class="w"> </span><span class="n">nextY</span><span class="p">,</span><span class="w"> </span><span class="n">puyoType</span><span class="p">,</span><span class="w"> </span><span class="n">visited</span><span class="p">,</span><span class="w"> </span><span class="n">connected</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">EraseBoards</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Type</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eraseList</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eraseList</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_width</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_height</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">_grid</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Fall</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">--</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_width</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_grid</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">fallY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">                    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_height</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">_grid</span><span class="p">[</span><span class="n">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="n">_grid</span><span class="p">[</span><span class="n">fallY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_grid</span><span class="p">[</span><span class="n">fallY</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">];</span>
<span class="w">                        </span><span class="n">_grid</span><span class="p">[</span><span class="n">fallY</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                        </span><span class="n">fallY</span><span class="o">++</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>SearchConnectedPuyo</code>メソッドは再帰を使っているんですね！」そうです。これは<strong>深さ優先探索（DFS：Depth-First Search）</strong>というアルゴリズムです。あるぷよから始めて、上下左右に隣接する同じ色のぷよを再帰的に探索していきます。</p>
<blockquote>
<p>深さ優先探索（DFS）</p>
<p>グラフや木構造を探索するアルゴリズムの一つ。ある頂点から可能な限り深く探索を進め、それ以上進めなくなったら一つ前の分岐点に戻って探索を続ける。</p>
<p>— Thomas H. Cormen 『アルゴリズムイントロダクション』</p>
</blockquote>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！接続判定が正しく動作しています。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの接続判定と消去処理を実装&#39;</span>
</code></pre></div>
<h3 id="_35">テスト: 消去後の落下処理<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>次に、消去後の落下処理をテストしましょう。ぷよが消えた後、上にあるぷよが重力で落ちてくる必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/StageTest.cs</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよを消去すると上のぷよが落ちてくる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 最下段のぷよ3つを消去</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Type</span><span class="p">)</span><span class="o">&gt;</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">            </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">            </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">EraseBoards</span><span class="p">(</span><span class="n">eraseList</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Fall</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">));</span><span class="w"> </span><span class="c1">// 上にあったぷよが落ちてきた</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span><span class="w"> </span><span class="c1">// 元の位置は空</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">複数列のぷよが同時に落下する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 最下段の4つを消去</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Type</span><span class="p">)</span><span class="o">&gt;</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">            </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">            </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">            </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">EraseBoards</span><span class="p">(</span><span class="n">eraseList</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Fall</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">));</span><span class="w"> </span><span class="c1">// 左上のぷよが落下</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">));</span><span class="w"> </span><span class="c1">// 右上のぷよが落下</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span><span class="w"> </span><span class="c1">// 元の位置は空</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span><span class="w"> </span><span class="c1">// 元の位置は空</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「落下処理のテストも通りましたね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: 消去後の落下処理のテストを追加&#39;</span>
</code></pre></div>
<h3 id="game">Gameクラスへの統合<a class="headerlink" href="#game" title="Permanent link">&para;</a></h3>
<p>次に、消去処理を<code>Game</code>クラスに統合しましょう。ゲームモードを追加して、消去のフローを管理します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/GameMode.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">GameMode</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Start</span><span class="p">,</span>
<span class="w">    </span><span class="n">Playing</span><span class="p">,</span>
<span class="w">    </span><span class="n">CheckErase</span><span class="p">,</span>
<span class="w">    </span><span class="n">Erasing</span><span class="p">,</span>
<span class="w">    </span><span class="n">GameOver</span>
<span class="p">}</span>
</code></pre></div>
<p><code>Game</code>クラスを更新します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/Game.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Config</span><span class="o">?</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Stage</span><span class="o">?</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Player</span><span class="o">?</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Score</span><span class="o">?</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">GameMode</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Initialize</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Config</span><span class="p">();</span>
<span class="w">        </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">Config</span><span class="p">.</span><span class="n">StageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">Config</span><span class="p">.</span><span class="n">StageHeight</span><span class="p">);</span>
<span class="w">        </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Player</span><span class="p">();</span>
<span class="w">        </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">;</span>

<span class="w">        </span><span class="n">Stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">Player</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">        </span><span class="n">Score</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">CheckAndErase</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="p">;</span>
<span class="w">            </span><span class="n">Stage</span><span class="p">.</span><span class="n">EraseBoards</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">EraseList</span><span class="p">);</span>
<span class="w">            </span><span class="n">Score</span><span class="o">?.</span><span class="n">AddScore</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 落下処理</span>
<span class="w">            </span><span class="n">Stage</span><span class="p">.</span><span class="n">Fall</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// 再度消去チェック（連鎖の可能性）</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">GameOver</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>Score</code>クラスも更新します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/Score.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Score</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CurrentScore</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ChainCount</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">ChainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">AddScore</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">erasePuyoCount</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 基本スコア: 消したぷよの数 × 10</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">baseScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">        </span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">baseScore</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">IncrementChain</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ChainCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ResetChain</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ChainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_36">ゲームクラスのテスト<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p><code>Game</code>クラスの消去処理をテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/GameTest.cs</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよを消去するとスコアが加算される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 4つのぷよを配置</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">CheckAndErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">GetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">));</span><span class="w"> </span><span class="c1">// ぷよが消えている</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">消去後にゲ</span><span class="n">ー</span><span class="err">ムモ</span><span class="n">ー</span><span class="err">ドが更新される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">CheckAndErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: Gameクラスに消去処理を統合&#39;</span>
</code></pre></div>
<h3 id="_37">すべてのテストとカバレッジの確認<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>最後に、すべてのテストとカバレッジを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Quality
</code></pre></div>
<p>「すべてのテストが通って、カバレッジも良好ですね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの消去機能を完成&#39;</span>
</code></pre></div>
<h3 id="5_1">イテレーション5のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション5が完了しました。このイテレーションでは、以下のことを実現しました：</p>
<ol>
<li><strong>接続判定</strong>: 深さ優先探索（DFS）による同色ぷよの検出</li>
<li><strong>消去判定</strong>: 4つ以上つながったぷよの検出</li>
<li><strong>消去処理</strong>: <code>EraseBoards</code>メソッドによるぷよの削除</li>
<li><strong>落下処理</strong>: <code>Fall</code>メソッドによる重力シミュレーション</li>
<li><strong>スコア計算</strong>: 消したぷよの数に応じたスコア加算</li>
<li><strong>ゲームフロー</strong>: 消去チェック→消去→落下のサイクル</li>
</ol>
<p><strong>学んだこと</strong>:
- <strong>深さ優先探索（DFS）</strong>: 再帰を使った探索アルゴリズム
- <strong>visited配列</strong>: 同じセルを二重に探索しない工夫
- <strong>レコード型</strong>: 不変データの表現に便利な<code>record</code>
- <strong>複雑な状態遷移</strong>: ゲームモードによる処理の制御</p>
<p><strong>深さ優先探索の重要性</strong>:
ぷよの接続判定には、グラフ探索アルゴリズムの一つである深さ優先探索を使用しました。このアルゴリズムは、迷路の探索、木構造の走査、ネットワーク解析など、様々な場面で活用される基本的かつ強力なアルゴリズムです。</p>
<p><strong>実装のポイント</strong>:
- <code>visited</code>配列で探索済みのセルを管理することで、無限ループを防止
- 4方向（上下左右）の探索により、どんな形でつながっていても検出可能
- 再帰の終了条件を明確にすることで、スタックオーバーフローを回避</p>
<p>次のイテレーションでは、連鎖反応を実装して、より戦略的なゲームプレイを可能にしていきますよ！</p>
<h2 id="6">イテレーション6: 連鎖反応とスコア計算の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装していきましょう！</p>
<h3 id="_38">ユーザーストーリー<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="todo_5">TODOリスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<blockquote>
<p>TODOリストは、実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「連鎖反応を実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>連鎖カウントを実装する（何連鎖目かをカウントする）</li>
<li>連鎖ボーナスの計算を実装する（連鎖数に応じたボーナス点を計算する）</li>
<li>連鎖ループの実装（消去→落下→再チェックのサイクル）</li>
<li>スコア表示の更新（プレイヤーに連鎖数とスコアを表示する）</li>
</ul>
<h3 id="_39">テスト: 連鎖カウント<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、連鎖カウントの機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/ScoreTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Tests.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ScoreTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">スコアを初期化すると</span><span class="mi">0</span><span class="err">になる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">ChainCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよを消去するとスコアが加算される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">AddScore</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4つ消去</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4 × 10 = 40</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖カウントを増やせる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">ChainCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖カウントをリセットできる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">ResetChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">ChainCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖数に応じてボ</span><span class="n">ー</span><span class="err">ナスが加算される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act - 1連鎖目</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">AddScoreWithChain</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">ChainCount</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">score1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 2連鎖目</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">AddScoreWithChain</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">ChainCount</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">score2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="c1">// 2連鎖目の方がボーナスが大きいのでスコア増加量が大きい</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">score2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">score1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">40</span><span class="p">);</span><span class="w"> </span><span class="c1">// 基本スコア40より大きい増加</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Theory]</span>
<span class="w">    </span><span class="na">[InlineData(1, 0)]</span>
<span class="w">    </span><span class="na">[InlineData(2, 8)]</span>
<span class="w">    </span><span class="na">[InlineData(3, 16)]</span>
<span class="w">    </span><span class="na">[InlineData(4, 32)]</span>
<span class="w">    </span><span class="na">[InlineData(5, 64)]</span>
<span class="w">    </span><span class="na">[InlineData(6, 96)]</span>
<span class="w">    </span><span class="na">[InlineData(7, 128)]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖ボ</span><span class="n">ー</span><span class="err">ナステ</span><span class="n">ー</span><span class="err">ブルが正しく機能する</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">chainCount</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">expectedBonus</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">bonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">GetChainBonus</span><span class="p">(</span><span class="n">chainCount</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">expectedBonus</span><span class="p">,</span><span class="w"> </span><span class="n">bonus</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「連鎖ボーナステーブルって何ですか？」良い質問です！連鎖ボーナステーブルは、連鎖数に応じたボーナス倍率を定義したものです。連鎖数が増えるほど、ボーナスが大きくなります。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「コンパイルエラーになりますね」そうです、まだ必要なメソッドが実装されていないからです。</p>
<h3 id="_40">実装: 連鎖カウントとボーナス計算<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>それでは、テストが通るように実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/Score.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Score</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="kt">int</span><span class="p">[]</span><span class="w"> </span><span class="n">_chainBonusTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">96</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">160</span><span class="p">,</span><span class="w"> </span><span class="mi">192</span><span class="p">,</span><span class="w"> </span><span class="mi">224</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">CurrentScore</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ChainCount</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">ChainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">AddScore</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">erasePuyoCount</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 基本スコア: 消したぷよの数 × 10</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">baseScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">        </span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">baseScore</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">AddScoreWithChain</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">erasePuyoCount</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">chainCount</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 基本スコア</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">baseScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erasePuyoCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 連鎖ボーナスを適用</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">chainBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetChainBonus</span><span class="p">(</span><span class="n">chainCount</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">totalScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseScore</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">chainBonus</span><span class="p">);</span>

<span class="w">        </span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">totalScore</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">GetChainBonus</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">chainCount</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chainCount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">chainCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">_chainBonusTable</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">_chainBonusTable</span><span class="p">[</span><span class="o">^</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="c1">// 最大値を返す</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_chainBonusTable</span><span class="p">[</span><span class="n">chainCount</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">IncrementChain</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ChainCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ResetChain</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ChainCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「連鎖ボーナステーブルが配列になっているんですね！」そうです。連鎖数をインデックスとして、対応するボーナス値を取得できます。</p>
<p><strong>連鎖ボーナスの計算式</strong>:
<div class="highlight"><pre><span></span><code>最終スコア = 基本スコア（消去数 × 10）× 連鎖ボーナス
</code></pre></div></p>
<p>例えば、4つのぷよを2連鎖で消した場合：
- 基本スコア: 4 × 10 = 40
- 連鎖ボーナス: 8（2連鎖）
- 最終スコア: 40 × 8 = 320</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」素晴らしい！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 連鎖カウントとボーナス計算を実装&#39;</span>
</code></pre></div>
<h3 id="_41">テスト: 連鎖ループの実装<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>次に、連鎖が実際に発生することをテストしましょう。消去→落下→再消去のサイクルを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/StageTest.cs</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">消去後の落下で連鎖が発生する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange - 連鎖が発生する配置</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 下段: 赤4つ（横並び）</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 上段: 青3つ + 1つ離れた場所に青1つ（落下後に4つになる）</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// これが落ちて4つになる</span>

<span class="w">        </span><span class="c1">// Act - 1回目の消去</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">EraseBoards</span><span class="p">(</span><span class="n">eraseInfo1</span><span class="p">.</span><span class="n">EraseList</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Fall</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 2回目のチェック（連鎖）</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo1</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1回目: 赤4つ消去</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo2</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span><span class="w"> </span><span class="c1">// 2回目: 青4つ消去（連鎖）</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖が発生しない場合は消去されない</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 4つ横並び</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 上に別の色のぷよが2つだけ</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">EraseBoards</span><span class="p">(</span><span class="n">eraseInfo1</span><span class="p">.</span><span class="n">EraseList</span><span class="p">);</span>
<span class="w">        </span><span class="n">_stage</span><span class="p">.</span><span class="n">Fall</span><span class="p">();</span>

<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo1</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1回目: 4つ消去</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">eraseInfo2</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">);</span><span class="w"> </span><span class="c1">// 2回目: 消去なし</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「連鎖のテストは複雑ですね！」そうですね。連鎖が発生するには、正確な配置が必要です。テストでは、消去→落下→再消去のサイクルを確認しています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「テストが通りましたね！」既存の実装で連鎖のロジックが動作していることが確認できました。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: 連鎖ループのテストを追加&#39;</span>
</code></pre></div>
<h3 id="game_1">Gameクラスへの連鎖統合<a class="headerlink" href="#game_1" title="Permanent link">&para;</a></h3>
<p>次に、<code>Game</code>クラスに連鎖のロジックを統合しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF/Models/Game.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoWPF.Models</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Config</span><span class="o">?</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Stage</span><span class="o">?</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Player</span><span class="o">?</span><span class="w"> </span><span class="n">Player</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Score</span><span class="o">?</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">GameMode</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Initialize</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Config</span><span class="p">();</span>
<span class="w">        </span><span class="n">Stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">(</span><span class="n">Config</span><span class="p">.</span><span class="n">StageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">Config</span><span class="p">.</span><span class="n">StageHeight</span><span class="p">);</span>
<span class="w">        </span><span class="n">Player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Player</span><span class="p">();</span>
<span class="w">        </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">;</span>

<span class="w">        </span><span class="n">Stage</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">Player</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">        </span><span class="n">Score</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">CheckAndEraseWithChain</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Stage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="n">Score</span><span class="p">.</span><span class="n">ResetChain</span><span class="p">();</span><span class="w"> </span><span class="c1">// 連鎖カウントをリセット</span>

<span class="w">        </span><span class="c1">// 連鎖ループ</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Erasing</span><span class="p">;</span>
<span class="w">                </span><span class="n">Score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span><span class="w"> </span><span class="c1">// 連鎖カウント増加</span>

<span class="w">                </span><span class="c1">// 消去処理</span>
<span class="w">                </span><span class="n">Stage</span><span class="p">.</span><span class="n">EraseBoards</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">EraseList</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// スコア加算（連鎖ボーナス付き）</span>
<span class="w">                </span><span class="n">Score</span><span class="p">.</span><span class="n">AddScoreWithChain</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">ErasePuyoCount</span><span class="p">,</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="n">ChainCount</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// 落下処理</span>
<span class="w">                </span><span class="n">Stage</span><span class="p">.</span><span class="n">Fall</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// 次のループで再度チェック（連鎖の可能性）</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 消去なし → 連鎖終了</span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">GameOver</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>while</code>ループで連鎖を処理しているんですね！」その通りです。消去可能なぷよがある限り、消去→落下→再チェックのサイクルを繰り返します。これにより、連鎖反応が自動的に処理されます。</p>
<h3 id="game_2">Gameクラスのテスト<a class="headerlink" href="#game_2" title="Permanent link">&para;</a></h3>
<p><code>Game</code>クラスの連鎖処理をテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoWPF.Tests/Models/GameTest.cs</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖が発生するとスコアにボ</span><span class="n">ー</span><span class="err">ナスが加算される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 連鎖が発生する配置</span>
<span class="w">        </span><span class="c1">// 下段: 赤4つ</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 上段: 青4つ（落下後に4つになる）</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">CheckAndEraseWithChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="c1">// 1連鎖: 4 × 10 × 0 = 0（ボーナス0）→ 40（最小値1を使用）</span>
<span class="w">        </span><span class="c1">// 2連鎖: 4 × 10 × 8 = 320</span>
<span class="w">        </span><span class="c1">// 合計: 40 + 320 = 360</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">360</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">ChainCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Fact]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖が発生しない場合は連鎖カウントが</span><span class="mi">1</span><span class="err">になる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 4つ横並び（連鎖なし）</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">SetCell</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">CheckAndEraseWithChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">ChainCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>「すべてのテストが通りましたね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 連鎖処理をGameクラスに統合&#39;</span>
</code></pre></div>
<h3 id="_42">すべてのテストとカバレッジの確認<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>最後に、すべてのテストとカバレッジを確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Quality
</code></pre></div>
<p>「すべてのテストが通って、カバレッジも良好ですね！」完璧です！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 連鎖反応とスコア計算を完成&#39;</span>
</code></pre></div>
<h3 id="6_1">イテレーション6のまとめ<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション6が完了しました。このイテレーションでは、以下のことを実現しました：</p>
<ol>
<li><strong>連鎖カウント</strong>: <code>IncrementChain()</code>と<code>ResetChain()</code>による連鎖数の管理</li>
<li><strong>連鎖ボーナステーブル</strong>: 連鎖数に応じたボーナス倍率の定義</li>
<li><strong>ボーナス計算</strong>: <code>GetChainBonus()</code>による連鎖ボーナスの取得</li>
<li><strong>スコア計算</strong>: <code>AddScoreWithChain()</code>による連鎖ボーナス付きスコア加算</li>
<li><strong>連鎖ループ</strong>: <code>CheckAndEraseWithChain()</code>による連鎖反応の自動処理</li>
</ol>
<p><strong>学んだこと</strong>:
- <strong>連鎖ボーナステーブル</strong>: 配列によるボーナス値の管理
- <strong>whileループによる連鎖処理</strong>: 消去可能な限り繰り返す
- <strong>段階的なスコア計算</strong>: 基本スコア → ボーナス適用 → 加算
- <strong>ゲームバランス</strong>: 連鎖数による報酬の増加</p>
<p><strong>連鎖ボーナスの意義</strong>:
連鎖ボーナスは、プレイヤーに戦略的なプレイを促す重要な要素です。ただぷよを消すのではなく、「次の連鎖を考えて配置する」という深い思考が求められます。これにより、ゲームの面白さと奥深さが大きく向上します。</p>
<blockquote>
<p>ゲームバランス</p>
<p>ゲームの面白さは、挑戦と報酬のバランスから生まれます。困難な目標（連鎖）を達成したときの大きな報酬（ボーナススコア）は、プレイヤーの達成感を高めます。</p>
<p>— Mihaly Csikszentmihalyi 『フロー体験』</p>
</blockquote>
<p><strong>実装のポイント</strong>:
- 連鎖ボーナステーブルを配列で管理することで、柔軟な調整が可能
- <code>while</code>ループで連鎖を自動処理することで、シンプルな実装を実現
- <code>Math.Max(1, chainBonus)</code>で、ボーナスが0でも最低1倍のスコアを保証</p>
<p>これでぷよぷよの基本的なゲームロジックが完成しました！次のステップでは、UIの実装やゲームオーバー判定など、より完成度の高いゲームに仕上げていきます。</p>
<h2 id="7">イテレーション7: 全消しボーナスの実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>イテレーション6で連鎖ボーナスが実装できました。次は、ぷよぷよの隠れた醍醐味である「全消し」を実装しましょう！</p>
<blockquote>
<p>ゲームの隠し要素</p>
<p>プレイヤーが自ら発見する隠れたボーナスは、ゲームに深みを与えます。全消しボーナスは、達成が難しいが大きな報酬を得られる、典型的な隠し要素です。</p>
<p>— Sid Meier 『Game Design』</p>
</blockquote>
<h3 id="_43">ユーザーストーリー<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、盤面上のぷよをすべて消すと、全消しボーナスを獲得できる</p>
</blockquote>
<p>「全消しって何ですか？」良い質問ですね！全消しとは、盤面上にぷよが1つも残っていない状態のことです。これを達成すると、大きなボーナススコアがもらえます。</p>
<h3 id="todo_6">TODOリスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul>
<li>全消し判定を実装する（盤面が空かどうかをチェック）</li>
<li>全消しボーナスを実装する（固定値3600点を加算）</li>
<li>ゲームロジックに全消しチェックを統合する</li>
</ul>
<p>「3600点ってすごいですね！」そうなんです。全消しは難しいですが、達成すると大きなボーナスがもらえます。これがプレイヤーのモチベーションになります。</p>
<h3 id="7-1">ステップ7-1: 全消し判定の実装<a class="headerlink" href="#7-1" title="Permanent link">&para;</a></h3>
<p>まずは、盤面が空かどうかを判定する機能を実装しましょう。</p>
<h4 id="_44">テストの作成<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h4>
<p>テストファーストで進めます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD.Tests/Models/StageTests.cs（追加）</span>
<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">IsAllClear_</span><span class="err">空の盤面</span><span class="n">_True</span><span class="err">を返す</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">();</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="n">InitBoards</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">IsAllClear_</span><span class="err">ぷよが</span><span class="mi">1</span><span class="err">つでもある</span><span class="n">_False</span><span class="err">を返す</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">();</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="n">InitBoards</span><span class="p">();</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// 盤面の真ん中に赤ぷよを配置</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">IsAllClear_</span><span class="err">壁とゴミぷよのみ</span><span class="n">_True</span><span class="err">を返す</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">();</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="n">InitBoards</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 壁(9)とゴミぷよ(99)は全消し判定に影響しない</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">IsAllClear_</span><span class="err">盤面全体にぷよがある</span><span class="n">_False</span><span class="err">を返す</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stage</span><span class="p">();</span>
<span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="n">InitBoards</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 盤面全体にぷよを配置</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「壁やゴミぷよは全消し判定に関係ないんですね！」その通りです。壁（9）やゴミぷよ（99）は固定オブジェクトなので、消えることはありません。全消し判定では無視します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「当然ですが、テストが失敗しますね。」そうです。<code>IsAllClear</code>メソッドがまだ存在しないからです。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: 全消し判定のテストを追加&#39;</span>
</code></pre></div>
<h4 id="_45">実装<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h4>
<p>次に、<code>IsAllClear</code>メソッドを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/Models/Stage.cs（追加）</span>
<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// 盤面が空（全消し）かどうかを判定します</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="c1">/// &lt;returns&gt;盤面上に消せるぷよが存在しない場合はtrue&lt;/returns&gt;</span>
<span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">IsAllClear</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 壁(9)、ゴミぷよ(99)、空(0)以外があればfalse</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Boards</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Boards</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Boards</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">99</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「二重ループで全マスをチェックするんですね！」そうです。盤面全体を走査して、消せるぷよ（1～4）が1つでもあれば<code>false</code>を返します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！全消し判定が正しく動作しています。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 全消し判定を実装&#39;</span>
</code></pre></div>
<h3 id="7-2">ステップ7-2: 全消しボーナスの実装<a class="headerlink" href="#7-2" title="Permanent link">&para;</a></h3>
<p>次に、全消しボーナスをスコアに加算する機能を実装しましょう。</p>
<h4 id="_46">テストの作成<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD.Tests/Models/ScoreTests.cs（追加）</span>
<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">AddZenkeshiBonus_</span><span class="err">全消しボ</span><span class="n">ー</span><span class="err">ナス</span><span class="n">_3600</span><span class="err">点加算される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">InitScore</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">AddZenkeshiBonus</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">3600</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">AddZenkeshiBonus_</span><span class="err">既存スコアに加算</span><span class="n">_</span><span class="err">正しく加算される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">InitScore</span><span class="p">();</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">AddScore</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span><span class="w"> </span><span class="c1">// 既存スコアを設定</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">AddZenkeshiBonus</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">AddZenkeshiBonus_</span><span class="err">複数回呼び出し</span><span class="n">_</span><span class="err">毎回</span><span class="mi">3600</span><span class="err">点加算される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">InitScore</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">AddZenkeshiBonus</span><span class="p">();</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">AddZenkeshiBonus</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">7200</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「全消しボーナスは固定で3600点なんですね！」そうです。連鎖ボーナスと違って、全消しボーナスは固定値です。これはぷよぷよの伝統的な設定です。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが失敗しました。」はい、<code>AddZenkeshiBonus</code>メソッドがまだ存在しないからです。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: 全消しボーナスのテストを追加&#39;</span>
</code></pre></div>
<h4 id="_47">実装<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h4>
<p><code>AddZenkeshiBonus</code>メソッドを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/Models/Score.cs（追加）</span>
<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// 全消しボーナスを加算します</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">AddZenkeshiBonus</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">zenkeshiBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span><span class="p">;</span>
<span class="w">    </span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">zenkeshiBonus</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「とてもシンプルですね！」そうなんです。全消しボーナスは固定値なので、実装もシンプルです。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！全消しボーナスが正しく加算されています。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 全消しボーナスを実装&#39;</span>
</code></pre></div>
<h3 id="7-3">ステップ7-3: ゲームロジックへの統合<a class="headerlink" href="#7-3" title="Permanent link">&para;</a></h3>
<p>最後に、全消しチェックをゲームロジックに統合しましょう。消去処理の後に全消し判定を行い、全消しの場合はボーナスを加算します。</p>
<h4 id="_48">テストの作成<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD.Tests/Models/GameTests.cs（追加）</span>
<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Update_</span><span class="err">全消し</span><span class="n">_</span><span class="err">全消しボ</span><span class="n">ー</span><span class="err">ナスが加算される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 全消しになるように盤面を設定（4つの赤ぷよを縦に並べる）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="c1">// 消去チェックを実行</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 消去アニメーション（30フレーム）をスキップ</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Erase</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// 通常スコア(10 × 4 × 1) + 全消しボーナス(3600) = 3640点</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">3640</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Update_</span><span class="err">一部残る</span><span class="n">_</span><span class="err">全消しボ</span><span class="n">ー</span><span class="err">ナスが加算されない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 一部残るように盤面を設定</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// このぷよは残る</span>

<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Erase</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// 通常スコアのみ(10 × 4 × 1) = 40点</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Update_</span><span class="err">連鎖からの全消し</span><span class="n">_</span><span class="err">連鎖ボ</span><span class="n">ー</span><span class="err">ナスと全消しボ</span><span class="n">ー</span><span class="err">ナスの両方が加算される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 2連鎖で全消しになるように設定</span>
<span class="w">    </span><span class="c1">// 1段目: 赤ぷよ4つ（すぐ消える）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 2段目: 青ぷよ4つ（落ちて消える）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">CheckAndEraseWithChain</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// 1連鎖目: 10 × 4 × 1 = 40点</span>
<span class="w">    </span><span class="c1">// 2連鎖目: 10 × 4 × 8 = 320点</span>
<span class="w">    </span><span class="c1">// 全消しボーナス: 3600点</span>
<span class="w">    </span><span class="c1">// 合計: 3960点</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">3960</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「全消しチェックは消去処理の後に行うんですね！」その通りです。ぷよを消した後、盤面が空になったかどうかをチェックします。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが失敗しました。」はい、まだゲームロジックに全消しチェックを統合していないからです。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: 全消しボーナスの統合テストを追加&#39;</span>
</code></pre></div>
<h4 id="_49">実装<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h4>
<p><code>CheckAndEraseWithChain</code>メソッドに全消しチェックを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/Models/Game.cs（更新）</span>
<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// 消去可能なぷよをチェックし、連鎖が続く限り消去を繰り返します</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">CheckAndEraseWithChain</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去チェック</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">eraseInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">CheckEraseBoards</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">EraseCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// これ以上消せるぷよがない場合</span>
<span class="w">            </span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">ResetChain</span><span class="p">();</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 連鎖カウントを増やす</span>
<span class="w">        </span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ぷよを消去</span>
<span class="w">        </span><span class="n">Stage</span><span class="p">.</span><span class="n">EraseBoards</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">EraseList</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 全消しチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Stage</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Score</span><span class="p">.</span><span class="n">AddZenkeshiBonus</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// スコアを加算</span>
<span class="w">        </span><span class="n">Score</span><span class="p">.</span><span class="n">AddScoreWithChain</span><span class="p">(</span><span class="n">eraseInfo</span><span class="p">.</span><span class="n">EraseCount</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ぷよを落下させる</span>
<span class="w">        </span><span class="n">Stage</span><span class="p">.</span><span class="n">FallBoards</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「消去の後すぐに全消しチェックを行うんですね！」その通りです。<code>Stage.EraseBoards</code>でぷよを消した直後に<code>IsAllClear</code>で盤面が空かどうかをチェックし、全消しの場合は<code>AddZenkeshiBonus</code>でボーナスを加算します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！全消しボーナスがゲームに正しく統合されました。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 全消しボーナスをゲームロジックに統合&#39;</span>
</code></pre></div>
<h3 id="7-4-viewmodel">ステップ7-4: ViewModelの更新<a class="headerlink" href="#7-4-viewmodel" title="Permanent link">&para;</a></h3>
<p>全消し時の演出を追加するため、ViewModelに全消しフラグを追加しましょう。</p>
<h4 id="_50">テストの作成<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h4>
<p>まず、ViewModelのテストを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD.Tests/ViewModels/GameViewModelTests.cs（追加）</span>
<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">ShowZenkeshi_</span><span class="err">全消し発生</span><span class="n">_True</span><span class="err">になる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">StartGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 全消しになるように盤面を設定</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="o">!</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">CheckAndEraseWithChain</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">ShowZenkeshi</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">ShowZenkeshi_</span><span class="err">一部残る</span><span class="n">_False</span><span class="err">のまま</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">StartGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 一部残るように設定</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="o">!</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">CheckAndEraseWithChain</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">ShowZenkeshi</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「ViewModelで全消しフラグを管理するんですね！」そうです。UIバインディングのために、ViewModelに全消し表示用のプロパティを追加します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが失敗しました。」はい、<code>ShowZenkeshi</code>プロパティがまだ存在しないからです。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: 全消しフラグのテストを追加&#39;</span>
</code></pre></div>
<h4 id="_51">実装<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h4>
<p>ViewModelに全消しフラグを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/ViewModels/GameViewModel.cs（追加）</span>
<span class="na">[ObservableProperty]</span>
<span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">showZenkeshi</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// ゲーム状態を更新します</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">GameLoop</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 全消しチェック（消去前の状態を保存）</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">wasAllClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">?.</span><span class="n">IsAllClear</span><span class="p">()</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ゲーム状態を更新</span>
<span class="w">    </span><span class="n">Game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 全消しチェック（消去後に盤面が空になった）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">wasAllClear</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">?.</span><span class="n">IsAllClear</span><span class="p">()</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="k">false</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 2秒後に非表示</span>
<span class="w">        </span><span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">).</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「消去前後の状態を比較して、全消しを検出するんですね！」その通りです。消去前に盤面が空でなく、消去後に空になった場合に全消しと判定します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！ViewModelに全消しフラグが正しく実装されました。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ViewModelに全消しフラグを追加&#39;</span>
</code></pre></div>
<h3 id="7-5-xaml">ステップ7-5: XAMLの更新<a class="headerlink" href="#7-5-xaml" title="Permanent link">&para;</a></h3>
<p>最後に、全消し時の表示をXAMLに追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- PuyoPuyoTDD/MainWindow.xaml（更新） --&gt;</span>
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyoTDD.MainWindow&quot;</span>
<span class="w">        </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">xmlns:d=</span><span class="s">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span>
<span class="w">        </span><span class="na">xmlns:mc=</span><span class="s">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span>
<span class="w">        </span><span class="na">xmlns:local=</span><span class="s">&quot;clr-namespace:PuyoPuyoTDD&quot;</span>
<span class="w">        </span><span class="na">mc:Ignorable=</span><span class="s">&quot;d&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;600&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;800&quot;</span>
<span class="w">        </span><span class="na">KeyDown=</span><span class="s">&quot;Window_KeyDown&quot;</span>
<span class="w">        </span><span class="na">KeyUp=</span><span class="s">&quot;Window_KeyUp&quot;</span>
<span class="w">        </span><span class="na">Focusable=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.Resources&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- 全消しアニメーション --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Storyboard</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;ZenkeshiAnimation&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ZenkeshiPanel&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;Opacity&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ZenkeshiText&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleX)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.2&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.3&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ZenkeshiText&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleY)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.2&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.3&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Storyboard&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- スコアパルスアニメーション --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Storyboard</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;ScorePulseAnimation&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ScoreValue&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleX)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.3&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.15&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ScoreValue&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleY)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.3&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.15&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Storyboard&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.Resources&gt;</span>

<span class="w">    </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;Grid.ColumnDefinitions&gt;</span>
<span class="w">            </span><span class="nt">&lt;ColumnDefinition</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;ColumnDefinition</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Grid.ColumnDefinitions&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲーム領域 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Column=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BorderThickness=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">                </span><span class="nt">&lt;Canvas</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;GameCanvas&quot;</span><span class="w"> </span>
<span class="w">                        </span><span class="na">Width=</span><span class="s">&quot;240&quot;</span><span class="w"> </span>
<span class="w">                        </span><span class="na">Height=</span><span class="s">&quot;520&quot;</span>
<span class="w">                        </span><span class="na">Background=</span><span class="s">&quot;WhiteSmoke&quot;</span>
<span class="w">                        </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                        </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">/&gt;</span>

<span class="w">                </span><span class="cm">&lt;!-- 全消し表示 --&gt;</span>
<span class="w">                </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;ZenkeshiPanel&quot;</span>
<span class="w">                          </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                          </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                          </span><span class="na">Opacity=</span><span class="s">&quot;0&quot;</span>
<span class="w">                          </span><span class="na">Visibility=</span><span class="s">&quot;{Binding ShowZenkeshi, Converter={StaticResource BoolToVisibilityConverter}}&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;ZenkeshiText&quot;</span>
<span class="w">                             </span><span class="na">Text=</span><span class="s">&quot;全消し！&quot;</span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;60&quot;</span>
<span class="w">                             </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                             </span><span class="na">Foreground=</span><span class="s">&quot;Gold&quot;</span>
<span class="w">                             </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                             </span><span class="na">RenderTransformOrigin=</span><span class="s">&quot;0.5,0.5&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;TextBlock.Effect&gt;</span>
<span class="w">                            </span><span class="nt">&lt;DropShadowEffect</span><span class="w"> </span><span class="na">Color=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BlurRadius=</span><span class="s">&quot;10&quot;</span><span class="w"> </span><span class="na">ShadowDepth=</span><span class="s">&quot;3&quot;</span><span class="w"> </span><span class="na">Opacity=</span><span class="s">&quot;0.5&quot;</span><span class="nt">/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock.Effect&gt;</span>
<span class="w">                        </span><span class="nt">&lt;TextBlock.RenderTransform&gt;</span>
<span class="w">                            </span><span class="nt">&lt;ScaleTransform/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock.RenderTransform&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/TextBlock&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;+3600&quot;</span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;40&quot;</span>
<span class="w">                             </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                             </span><span class="na">Foreground=</span><span class="s">&quot;Orange&quot;</span>
<span class="w">                             </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                             </span><span class="na">Margin=</span><span class="s">&quot;0,10,0,0&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;TextBlock.Effect&gt;</span>
<span class="w">                            </span><span class="nt">&lt;DropShadowEffect</span><span class="w"> </span><span class="na">Color=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BlurRadius=</span><span class="s">&quot;5&quot;</span><span class="w"> </span><span class="na">ShadowDepth=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Opacity=</span><span class="s">&quot;0.5&quot;</span><span class="nt">/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock.Effect&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/TextBlock&gt;</span>
<span class="w">                </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- 情報パネル --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Column=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;ゲーム開始&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Command=</span><span class="s">&quot;{Binding StartGameCommand}&quot;</span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;150&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span>
<span class="w">                    </span><span class="na">FontSize=</span><span class="s">&quot;16&quot;</span>
<span class="w">                    </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,20&quot;</span><span class="nt">/&gt;</span>

<span class="w">            </span><span class="cm">&lt;!-- スコア表示 --&gt;</span>
<span class="w">            </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;DarkGray&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">CornerRadius=</span><span class="s">&quot;5&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Padding=</span><span class="s">&quot;15&quot;</span>
<span class="w">                    </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,20&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;StackPanel&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;スコア&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;18&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                             </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">/&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;ScoreValue&quot;</span>
<span class="w">                             </span><span class="na">Text=</span><span class="s">&quot;{Binding CurrentScore}&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;36&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                             </span><span class="na">Foreground=</span><span class="s">&quot;DarkBlue&quot;</span>
<span class="w">                             </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                             </span><span class="na">RenderTransformOrigin=</span><span class="s">&quot;0.5,0.5&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;TextBlock.RenderTransform&gt;</span>
<span class="w">                            </span><span class="nt">&lt;ScaleTransform/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock.RenderTransform&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/TextBlock&gt;</span>
<span class="w">                </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">            </span><span class="cm">&lt;!-- 連鎖表示 --&gt;</span>
<span class="w">            </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;OrangeRed&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">CornerRadius=</span><span class="s">&quot;5&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Padding=</span><span class="s">&quot;10&quot;</span>
<span class="w">                    </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,20&quot;</span>
<span class="w">                    </span><span class="na">Visibility=</span><span class="s">&quot;{Binding ShowChain, Converter={StaticResource BoolToVisibilityConverter}}&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding ChainText}&quot;</span><span class="w"> </span>
<span class="w">                         </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span><span class="w"> </span>
<span class="w">                         </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                         </span><span class="na">Foreground=</span><span class="s">&quot;OrangeRed&quot;</span>
<span class="w">                         </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">            </span><span class="cm">&lt;!-- デバッグ情報 --&gt;</span>
<span class="w">            </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Gray&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">BorderThickness=</span><span class="s">&quot;1&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">CornerRadius=</span><span class="s">&quot;5&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Padding=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;StackPanel&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;デバッグ情報&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,5&quot;</span><span class="nt">/&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding DebugInfo}&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontFamily=</span><span class="s">&quot;Consolas&quot;</span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Border&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>「全消し表示に特別なアニメーションを追加したんですね！」その通りです。金色の「全消し！」テキストがポップアップし、「+3600」ボーナスが表示されます。</p>
<p>コードビハインドも更新して、全消し時にアニメーションを再生するようにします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/MainWindow.xaml.cs（更新）</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Media.Animation</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoTDD.ViewModels</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoTDD</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MainWindow</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Window</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="n">GameViewModel</span><span class="w"> </span><span class="n">ViewModel</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">GameViewModel</span><span class="p">)</span><span class="n">DataContext</span><span class="p">;</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">_lastShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">MainWindow</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">InitializeComponent</span><span class="p">();</span>
<span class="w">            </span><span class="n">DataContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// ViewModelの変更を監視</span>
<span class="w">            </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">PropertyChanged</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">PropertyName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">GameViewModel</span><span class="p">.</span><span class="n">ShowZenkeshi</span><span class="p">))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 全消しフラグがtrueになったらアニメーション再生</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ViewModel</span><span class="p">.</span><span class="n">ShowZenkeshi</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">_lastShowZenkeshi</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">animation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Storyboard</span><span class="p">)</span><span class="n">FindResource</span><span class="p">(</span><span class="s">&quot;ZenkeshiAnimation&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="n">animation</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">_lastShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">ShowZenkeshi</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">PropertyName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">GameViewModel</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// スコアが変化したらパルスアニメーション</span>
<span class="w">                    </span><span class="kt">var</span><span class="w"> </span><span class="n">animation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Storyboard</span><span class="p">)</span><span class="n">FindResource</span><span class="p">(</span><span class="s">&quot;ScorePulseAnimation&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="n">animation</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Window_KeyDown</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">KeyEventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Window_KeyUp</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">KeyEventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">HandleKeyUp</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ViewModelの変更を監視してアニメーションを再生するんですね！」その通りです。<code>PropertyChanged</code>イベントを使って、全消しフラグやスコアの変化を検知し、対応するアニメーションを再生します。</p>
<p>BoolToVisibilityConverterも追加する必要があります：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/Converters/BoolToVisibilityConverter.cs（新規作成）</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Globalization</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Data</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoTDD.Converters</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">BoolToVisibilityConverter</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IValueConverter</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">object</span><span class="w"> </span><span class="nf">Convert</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">targetType</span><span class="p">,</span><span class="w"> </span><span class="kt">object</span><span class="w"> </span><span class="n">parameter</span><span class="p">,</span><span class="w"> </span><span class="n">CultureInfo</span><span class="w"> </span><span class="n">culture</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">value</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">boolValue</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">boolValue</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Visibility</span><span class="p">.</span><span class="n">Visible</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Visibility</span><span class="p">.</span><span class="n">Collapsed</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Visibility</span><span class="p">.</span><span class="n">Collapsed</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">object</span><span class="w"> </span><span class="nf">ConvertBack</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">targetType</span><span class="p">,</span><span class="w"> </span><span class="kt">object</span><span class="w"> </span><span class="n">parameter</span><span class="p">,</span><span class="w"> </span><span class="n">CultureInfo</span><span class="w"> </span><span class="n">culture</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">NotImplementedException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>そして、XAMLでConverterを登録します：</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- PuyoPuyoTDD/MainWindow.xaml（更新） --&gt;</span>
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyoTDD.MainWindow&quot;</span>
<span class="w">        </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">xmlns:d=</span><span class="s">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span>
<span class="w">        </span><span class="na">xmlns:mc=</span><span class="s">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span>
<span class="w">        </span><span class="na">xmlns:local=</span><span class="s">&quot;clr-namespace:PuyoPuyoTDD&quot;</span>
<span class="w">        </span><span class="na">xmlns:converters=</span><span class="s">&quot;clr-namespace:PuyoPuyoTDD.Converters&quot;</span>
<span class="w">        </span><span class="na">mc:Ignorable=</span><span class="s">&quot;d&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;600&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;800&quot;</span>
<span class="w">        </span><span class="na">KeyDown=</span><span class="s">&quot;Window_KeyDown&quot;</span>
<span class="w">        </span><span class="na">KeyUp=</span><span class="s">&quot;Window_KeyUp&quot;</span>
<span class="w">        </span><span class="na">Focusable=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.Resources&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- コンバーター登録 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;converters:BoolToVisibilityConverter</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;BoolToVisibilityConverter&quot;</span><span class="nt">/&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ... その他のリソース ... --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.Resources&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- ... 残りのXAML ... --&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<h3 id="_52">アプリケーションの実行<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>実装した機能を実際に確認してみましょう！</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>PuyoPuyoTDD
dotnet<span class="w"> </span>run
</code></pre></div>
<h4 id="_53">全消しの確認<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h4>
<p>ゲームをプレイして、全消しを実現してみましょう：</p>
<ol>
<li><strong>シンプルな全消し</strong>: 最初の4つのぷよを揃えて消すだけで全消し</li>
<li>盤面が空になる</li>
<li>金色の「全消し！」テキストが表示される</li>
<li>「+3600」ボーナスが表示される</li>
<li>
<p>スコアが大きく増加する（40 + 3600 = 3640点）</p>
</li>
<li>
<p><strong>連鎖からの全消し</strong>: 複数回の連鎖を経て全消し</p>
</li>
<li>連鎖表示の後に全消し表示が出る</li>
<li>連鎖ボーナス + 全消しボーナスで高得点</li>
<li>例: 2連鎖全消しで 40 + 320 + 3600 = 3960点</li>
</ol>
<p>「全消しすると画面が華やかになりますね！」そうなんです。プレイヤーの大きな達成に対して、しっかりとフィードバックを返すことが重要です。</p>
<h3 id="7_1">イテレーション7のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション7が完了しました。このイテレーションでは、以下のことを実現しました：</p>
<ol>
<li><strong>全消し判定</strong>: <code>IsAllClear()</code>による盤面が空かどうかの判定</li>
<li><strong>全消しボーナス</strong>: <code>AddZenkeshiBonus()</code>による固定3600点のボーナス</li>
<li><strong>ゲームへの統合</strong>: 消去後の全消しチェックとボーナス加算</li>
<li><strong>全消し演出</strong>: 金色の「全消し！」表示と「+3600」ボーナス表示</li>
<li><strong>視覚的フィードバック</strong>: ポップアップアニメーションとドロップシャドウエフェクト</li>
</ol>
<p><strong>学んだこと</strong>:
- <strong>全消し判定</strong>: 二重ループで盤面全体をチェック
- <strong>固定ボーナス</strong>: 連鎖ボーナスとは異なる固定値の報酬
- <strong>消去後の処理</strong>: 消去直後に全消し判定を行う
- <strong>アニメーション</strong>: WPFのStoryboardによる演出効果
- <strong>PropertyChanged</strong>: ViewModelの変更を監視してUIを更新</p>
<p><strong>全消しボーナスの意義</strong>:
全消しボーナスは、プレイヤーに「完璧なプレイ」を目指す動機を与えます。連鎖を組むだけでなく、「きれいに全部消す」という新たな目標が生まれることで、ゲームの戦略性がさらに深まります。</p>
<blockquote>
<p>ゲーム設計の妙</p>
<p>困難だが達成可能な目標と、それに見合った報酬を用意することで、プレイヤーは夢中になってゲームをプレイします。全消しボーナスは、まさにその好例です。</p>
<p>— Sid Meier 『Game Design』</p>
</blockquote>
<p><strong>実装のポイント</strong>:
- 全消し判定は消去直後に行い、盤面の状態を正確に把握
- 全消しフラグをViewModelで管理し、UIバインディングを活用
- <code>PropertyChanged</code>イベントでアニメーションをトリガー
- ドロップシャドウとスケールアニメーションで視覚的インパクトを与える</p>
<p>これでぷよぷよの主要なゲーム要素が完成しました！次のイテレーション8では、ゲームオーバー判定とリスタート機能を実装して、ゲームとして完結させます。楽しみにしていてください！</p>
<h2 id="8">イテレーション8: ゲームオーバーとリスタートの実装<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>イテレーション7で全消しボーナスが実装できました。いよいよ最後のイテレーションです！ゲームオーバー判定とリスタート機能を実装して、ぷよぷよゲームを完成させましょう。</p>
<blockquote>
<p>ゲームの終わり</p>
<p>ゲームには明確な始まりと終わりが必要です。終わりがあるからこそ、プレイヤーは次のプレイへの意欲を持ちます。</p>
<p>— Jane McGonigal 『Reality is Broken』</p>
</blockquote>
<h3 id="_54">ユーザーストーリー<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</p>
<p>プレイヤーとして、ゲームオーバー後に新しいゲームを開始できる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かり、また新しく始められるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。</p>
<h3 id="todo_7">TODOリスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>このユーザーストーリーを実現するために、TODOリストを作成してみましょう：</p>
<ul>
<li>ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出）</li>
<li>ゲームオーバー時のモード遷移を実装する</li>
<li>リスタート機能を実装する（ゲームを初期状態に戻す）</li>
<li>ViewModelにゲームオーバー状態を追加する</li>
<li>XAMLにゲームオーバー表示とリスタートボタンを追加する</li>
</ul>
<p>「順番に実装していくんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう。</p>
<h3 id="8-1">ステップ8-1: ゲームオーバー判定の実装<a class="headerlink" href="#8-1" title="Permanent link">&para;</a></h3>
<p>まず、新しいぷよを配置できない状態がゲームオーバーと判定されるかをテストしましょう。</p>
<h4 id="_55">テストの作成<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD.Tests/Models/GameTests.cs（追加）</span>
<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">IsGameOver_</span><span class="err">新しいぷよを配置できない</span><span class="n">_True</span><span class="err">を返す</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 新しいぷよの配置位置（中央上部）にぷよを配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">IsGameOver</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">IsGameOver_</span><span class="err">新しいぷよを配置できる</span><span class="n">_False</span><span class="err">を返す</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">IsGameOver</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">IsGameOver_2</span><span class="err">つ目のぷよの位置も考慮</span><span class="n">_</span><span class="err">正しく判定される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Player</span><span class="o">!</span><span class="p">.</span><span class="n">PuyoX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">PuyoY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Player</span><span class="p">.</span><span class="n">Rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 上向き</span>

<span class="w">    </span><span class="c1">// 2つ目のぷよの位置（上）にぷよを配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">IsGameOver</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li>新しいぷよの配置位置にすでにぷよがある場合、ゲームオーバーと判定される</li>
<li>配置位置が空いている場合、ゲームオーバーではない</li>
<li>2つ目のぷよの位置も考慮される</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「当然ですが、テストが失敗しますね。」そうです。<code>IsGameOver</code>メソッドがまだ存在しないからです。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ゲームオーバー判定のテストを追加&#39;</span>
</code></pre></div>
<h4 id="_56">実装<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h4>
<p>次に、<code>IsGameOver</code>メソッドを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/Models/Game.cs（追加）</span>
<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// ゲームオーバー判定を行います</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="c1">/// &lt;returns&gt;新しいぷよを配置できない場合はtrue&lt;/returns&gt;</span>
<span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">IsGameOver</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Player</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Stage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 新しいぷよの配置位置（中央上部）にすでにぷよがあるかチェック</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">startX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">startY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="n">startX</span><span class="p">,</span><span class="w"> </span><span class="n">startY</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2つ目のぷよの位置もチェック（回転状態を考慮）</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="p">(</span><span class="n">secondX</span><span class="p">,</span><span class="w"> </span><span class="n">secondY</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Player</span><span class="p">.</span><span class="n">GetSecondPuyoPosition</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 2つ目のぷよが画面内で、その位置にすでにぷよがある場合</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">secondX</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="n">secondX</span><span class="p">,</span><span class="w"> </span><span class="n">secondY</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「配置位置にぷよがあるかどうかをチェックしているんですね！」その通りです。1つ目と2つ目のぷよ、両方の配置位置にぷよがないことを確認しています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！ゲームオーバー判定が正しく動作しています。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームオーバー判定を実装&#39;</span>
</code></pre></div>
<h3 id="8-2">ステップ8-2: ゲームモード遷移の実装<a class="headerlink" href="#8-2" title="Permanent link">&para;</a></h3>
<p>次に、ゲームオーバー時のゲームモード遷移をテストしましょう。</p>
<h4 id="_57">テストの作成<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD.Tests/Models/GameTests.cs（追加）</span>
<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Update_</span><span class="err">新しいぷよを配置できない</span><span class="n">_GameOver</span><span class="err">モ</span><span class="n">ー</span><span class="err">ドに遷移</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ステージの上部にぷよを配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Update_GameOver</span><span class="err">モ</span><span class="n">ー</span><span class="err">ド</span><span class="n">_</span><span class="err">処理が停止する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">initialFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Frame</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="c1">// フレームは進むが、ゲーム処理は行われない</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">initialFrame</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Frame</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「GameOverモードでは処理が停止するんですね！」その通りです。ゲームオーバー後は、プレイヤーが何もできないようにします。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが失敗しました。」はい、まだゲームオーバー時のモード遷移を実装していないからです。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ゲームオーバー時のモード遷移テストを追加&#39;</span>
</code></pre></div>
<h4 id="_58">実装<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h4>
<p><code>GameMode</code>列挙型に<code>GameOver</code>を追加し、モード遷移を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/Models/GameMode.cs（更新）</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoTDD.Models</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// ゲームモード</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">GameMode</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">/// &lt;summary&gt;開始&lt;/summary&gt;</span>
<span class="w">        </span><span class="n">Start</span><span class="p">,</span>
<span class="w">        </span><span class="c1">/// &lt;summary&gt;新しいぷよ生成&lt;/summary&gt;</span>
<span class="w">        </span><span class="n">NewPuyo</span><span class="p">,</span>
<span class="w">        </span><span class="c1">/// &lt;summary&gt;プレイ中&lt;/summary&gt;</span>
<span class="w">        </span><span class="n">Playing</span><span class="p">,</span>
<span class="w">        </span><span class="c1">/// &lt;summary&gt;消去チェック&lt;/summary&gt;</span>
<span class="w">        </span><span class="n">CheckErase</span><span class="p">,</span>
<span class="w">        </span><span class="c1">/// &lt;summary&gt;消去中&lt;/summary&gt;</span>
<span class="w">        </span><span class="n">Erase</span><span class="p">,</span>
<span class="w">        </span><span class="c1">/// &lt;summary&gt;落下チェック&lt;/summary&gt;</span>
<span class="w">        </span><span class="n">CheckFall</span><span class="p">,</span>
<span class="w">        </span><span class="c1">/// &lt;summary&gt;落下中&lt;/summary&gt;</span>
<span class="w">        </span><span class="n">Fall</span><span class="p">,</span>
<span class="w">        </span><span class="c1">/// &lt;summary&gt;ゲームオーバー&lt;/summary&gt;</span>
<span class="w">        </span><span class="n">GameOver</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>次に、<code>Update</code>メソッドを更新します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/Models/Game.cs（更新）</span>
<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// ゲーム状態を更新します</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Frame</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">:</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateNewPuyo</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdatePlaying</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateCheckErase</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Erase</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateErase</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">CheckFall</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateCheckFall</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Fall</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateFall</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">:</span>
<span class="w">            </span><span class="c1">// ゲームオーバー時は何もしない</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// 新しいぷよ生成時の処理</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateNewPuyo</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Player</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 連鎖数をリセット</span>
<span class="w">    </span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">ResetChain</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">    </span><span class="n">Player</span><span class="p">.</span><span class="n">CreateNewPuyo</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsGameOver</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Playingモードに遷移</span>
<span class="w">    </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「新しいぷよ生成時にゲームオーバー判定を追加したんですね！」その通りです。新しいぷよを配置できない場合、ゲームオーバーモードに遷移します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！ゲームオーバー時のモード遷移が正しく実装されました。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームオーバー時のモード遷移を実装&#39;</span>
</code></pre></div>
<h3 id="8-3">ステップ8-3: リスタート機能の実装<a class="headerlink" href="#8-3" title="Permanent link">&para;</a></h3>
<p>次に、リスタート機能をテストしましょう。</p>
<h4 id="_59">テストの作成<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD.Tests/Models/GameTests.cs（追加）</span>
<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">RestartGame_</span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムが初期状態に戻る</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ゲームを進める</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">AddScore</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">RestartGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">);</span><span class="w"> </span><span class="c1">// スコアがリセット</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Stage</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">]);</span><span class="w"> </span><span class="c1">// ステージがクリア</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span><span class="w"> </span><span class="c1">// モードがStartに戻る</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Frame</span><span class="p">);</span><span class="w"> </span><span class="c1">// フレームがリセット</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">RestartGame_</span><span class="err">リスタ</span><span class="n">ー</span><span class="err">ト後にゲ</span><span class="n">ー</span><span class="err">ムを開始できる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">RestartGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span><span class="w"> </span><span class="c1">// Start → NewPuyo</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span><span class="w"> </span><span class="c1">// NewPuyo → Playing</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Player</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「リスタートはゲームを初期状態に戻すんですね！」その通りです。スコア、ステージ、モードなど、すべての状態をリセットします。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが失敗しました。」はい、<code>RestartGame</code>メソッドがまだ存在しないからです。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: リスタート機能のテストを追加&#39;</span>
</code></pre></div>
<h4 id="_60">実装<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h4>
<p><code>RestartGame</code>メソッドを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/Models/Game.cs（追加）</span>
<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// ゲームを再開します</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RestartGame</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームを初期化</span>
<span class="w">    </span><span class="n">InitGame</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうです。リスタートは、ゲームを初期状態に戻すだけなので、<code>InitGame()</code>メソッドを呼び出すだけで実現できます。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！リスタート機能が正しく実装されました。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: リスタート機能を実装&#39;</span>
</code></pre></div>
<h3 id="8-4-viewmodel">ステップ8-4: ViewModelの更新<a class="headerlink" href="#8-4-viewmodel" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー状態を管理し、リスタート機能を追加するため、ViewModelを更新しましょう。</p>
<h4 id="_61">テストの作成<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD.Tests/ViewModels/GameViewModelTests.cs（追加）</span>
<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">IsGameOver_</span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムオ</span><span class="n">ー</span><span class="err">バ</span><span class="n">ー</span><span class="err">時</span><span class="n">_True</span><span class="err">になる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">StartGame</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ステージの上部にぷよを配置</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="o">!</span><span class="p">.</span><span class="n">Stage</span><span class="o">!</span><span class="p">.</span><span class="n">Boards</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">NewPuyo</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">True</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">IsGameOver</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Fact]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">RestartGameCommand_</span><span class="err">実行</span><span class="n">_</span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムが再開される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">StartGame</span><span class="p">();</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="o">!</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">viewModel</span><span class="p">.</span><span class="n">RestartGameCommand</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">False</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">IsGameOver</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「ViewModelでゲームオーバー状態を管理するんですね！」そうです。UIバインディングのために、ViewModelにゲームオーバー状態を追加します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが失敗しました。」はい、<code>IsGameOver</code>プロパティと<code>RestartGameCommand</code>がまだ存在しないからです。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ViewModelのゲームオーバー処理テストを追加&#39;</span>
</code></pre></div>
<h4 id="_62">実装<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h4>
<p>ViewModelにゲームオーバー状態とリスタートコマンドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/ViewModels/GameViewModel.cs（更新）</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">CommunityToolkit.Mvvm.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoTDD.Models</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoTDD.ViewModels</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameViewModel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ObservableObject</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="n">Timer</span><span class="o">?</span><span class="w"> </span><span class="n">gameTimer</span><span class="p">;</span>

<span class="w">        </span><span class="na">[ObservableProperty]</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="n">Game</span><span class="o">?</span><span class="w"> </span><span class="n">game</span><span class="p">;</span>

<span class="w">        </span><span class="na">[ObservableProperty]</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">currentScore</span><span class="p">;</span>

<span class="w">        </span><span class="na">[ObservableProperty]</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">showChain</span><span class="p">;</span>

<span class="w">        </span><span class="na">[ObservableProperty]</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">chainText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>

<span class="w">        </span><span class="na">[ObservableProperty]</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">showZenkeshi</span><span class="p">;</span>

<span class="w">        </span><span class="na">[ObservableProperty]</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">isGameOver</span><span class="p">;</span>

<span class="w">        </span><span class="na">[ObservableProperty]</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">debugInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">IRelayCommand</span><span class="w"> </span><span class="n">StartGameCommand</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">IRelayCommand</span><span class="w"> </span><span class="n">RestartGameCommand</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">GameViewModel</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">StartGameCommand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RelayCommand</span><span class="p">(</span><span class="n">StartGame</span><span class="p">);</span>
<span class="w">            </span><span class="n">RestartGameCommand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RelayCommand</span><span class="p">(</span><span class="n">RestartGame</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">        </span><span class="c1">/// ゲームを開始します</span>
<span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">StartGame</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">            </span><span class="n">Game</span><span class="p">.</span><span class="n">InitGame</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// ゲームループを開始</span>
<span class="w">            </span><span class="n">gameTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Timer</span><span class="p">(</span>
<span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">GameLoop</span><span class="p">(),</span>
<span class="w">                </span><span class="k">null</span><span class="p">,</span>
<span class="w">                </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span>
<span class="w">                </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMilliseconds</span><span class="p">(</span><span class="mf">16.6</span><span class="p">));</span><span class="w"> </span><span class="c1">// 約60FPS</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">        </span><span class="c1">/// ゲームを再開します</span>
<span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RestartGame</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">            </span><span class="n">Game</span><span class="p">.</span><span class="n">RestartGame</span><span class="p">();</span>
<span class="w">            </span><span class="n">ShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">            </span><span class="n">ShowChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">            </span><span class="n">IsGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">            </span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">        </span><span class="c1">/// ゲーム状態を更新します</span>
<span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">GameLoop</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 全消しチェック（消去前の状態を保存）</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">wasAllClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">?.</span><span class="n">IsAllClear</span><span class="p">()</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// ゲーム状態を更新</span>
<span class="w">            </span><span class="n">Game</span><span class="p">.</span><span class="n">Update</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// ゲームオーバーチェック</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">IsGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 全消しチェック（消去後に盤面が空になった）</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">wasAllClear</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Stage</span><span class="o">?.</span><span class="n">IsAllClear</span><span class="p">()</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="k">false</span><span class="p">))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">ShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>

<span class="w">                </span><span class="c1">// 2秒後に非表示</span>
<span class="w">                </span><span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">).</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 連鎖表示の更新</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Score</span><span class="o">!</span><span class="p">.</span><span class="n">CombinationCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">ShowChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">ChainText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">$&quot;{Game.Score.CombinationCount} 連鎖！&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">ShowChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// スコアの更新</span>
<span class="w">            </span><span class="n">CurrentScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// デバッグ情報の更新</span>
<span class="w">            </span><span class="n">UpdateDebugInfo</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">        </span><span class="c1">/// デバッグ情報を更新します</span>
<span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateDebugInfo</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">            </span><span class="n">DebugInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">$&quot;フレーム: {Game.Frame}\n&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                       </span><span class="s">$&quot;モード: {Game.Mode}\n&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                       </span><span class="s">$&quot;ぷよ位置: ({Game.Player?.PuyoX}, {Game.Player?.PuyoY})\n&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                       </span><span class="s">$&quot;回転: {Game.Player?.Rotation}\n&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                       </span><span class="s">$&quot;連鎖数: {Game.Score?.CombinationCount}&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">        </span><span class="c1">/// キー押下時の処理</span>
<span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleKeyDown</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="o">?.</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Left</span><span class="p">:</span>
<span class="w">                    </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveLeft</span><span class="p">();</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Right</span><span class="p">:</span>
<span class="w">                    </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">MoveRight</span><span class="p">();</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Up</span><span class="p">:</span>
<span class="w">                    </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">Rotate</span><span class="p">();</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Down</span><span class="p">:</span>
<span class="w">                    </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">StartFastDrop</span><span class="p">();</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">        </span><span class="c1">/// キー解放時の処理</span>
<span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleKeyUp</span><span class="p">(</span><span class="n">Key</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Game</span><span class="o">?.</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Key</span><span class="p">.</span><span class="n">Down</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">Game</span><span class="p">.</span><span class="n">Player</span><span class="o">?.</span><span class="n">StopFastDrop</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームオーバー時にタイマーを停止しないんですか？」良い質問ですね。この実装では、ゲームオーバー時に<code>Update</code>メソッドが早期リターンすることで、実質的に処理を停止しています。タイマーは動き続けますが、ゲームロジックは更新されません。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！ViewModelにゲームオーバー処理が正しく実装されました。</p>
<p>変更をコミットしておきましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ViewModelにゲームオーバー処理を追加&#39;</span>
</code></pre></div>
<h3 id="8-5-xaml">ステップ8-5: XAMLの更新<a class="headerlink" href="#8-5-xaml" title="Permanent link">&para;</a></h3>
<p>最後に、ゲームオーバー表示とリスタートボタンをXAMLに追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- PuyoPuyoTDD/MainWindow.xaml（更新） --&gt;</span>
<span class="nt">&lt;Window</span><span class="w"> </span><span class="na">x:Class=</span><span class="s">&quot;PuyoPuyoTDD.MainWindow&quot;</span>
<span class="w">        </span><span class="na">xmlns=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span>
<span class="w">        </span><span class="na">xmlns:x=</span><span class="s">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>
<span class="w">        </span><span class="na">xmlns:d=</span><span class="s">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span>
<span class="w">        </span><span class="na">xmlns:mc=</span><span class="s">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span>
<span class="w">        </span><span class="na">xmlns:local=</span><span class="s">&quot;clr-namespace:PuyoPuyoTDD&quot;</span>
<span class="w">        </span><span class="na">xmlns:converters=</span><span class="s">&quot;clr-namespace:PuyoPuyoTDD.Converters&quot;</span>
<span class="w">        </span><span class="na">mc:Ignorable=</span><span class="s">&quot;d&quot;</span>
<span class="w">        </span><span class="na">Title=</span><span class="s">&quot;ぷよぷよ TDD&quot;</span><span class="w"> </span><span class="na">Height=</span><span class="s">&quot;600&quot;</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;800&quot;</span>
<span class="w">        </span><span class="na">KeyDown=</span><span class="s">&quot;Window_KeyDown&quot;</span>
<span class="w">        </span><span class="na">KeyUp=</span><span class="s">&quot;Window_KeyUp&quot;</span>
<span class="w">        </span><span class="na">Focusable=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Window.Resources&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- コンバーター登録 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;converters:BoolToVisibilityConverter</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;BoolToVisibilityConverter&quot;</span><span class="nt">/&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲームオーバーアニメーション --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Storyboard</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;GameOverAnimation&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;GameOverOverlay&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;Opacity&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;GameOverText&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleX)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.5&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;False&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;GameOverText&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleY)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.5&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;False&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Storyboard&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲームオーバーパルスアニメーション --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Storyboard</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;GameOverPulseAnimation&quot;</span><span class="w"> </span><span class="na">RepeatBehavior=</span><span class="s">&quot;Forever&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;GameOverText&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleX)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.05&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:1&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;GameOverText&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleY)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.05&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:1&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Storyboard&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- 全消しアニメーション --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Storyboard</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;ZenkeshiAnimation&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ZenkeshiPanel&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;Opacity&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.5&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ZenkeshiText&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleX)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.2&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.3&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ZenkeshiText&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleY)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;0.5&quot;</span><span class="w"> </span><span class="na">to=</span><span class="s">&quot;1.2&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.3&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Storyboard&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- スコアパルスアニメーション --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Storyboard</span><span class="w"> </span><span class="na">x:Key=</span><span class="s">&quot;ScorePulseAnimation&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ScoreValue&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleX)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.3&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.15&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;DoubleAnimation</span><span class="w"> </span><span class="na">Storyboard.TargetName=</span><span class="s">&quot;ScoreValue&quot;</span>
<span class="w">                           </span><span class="na">Storyboard.TargetProperty=</span><span class="s">&quot;RenderTransform.(ScaleTransform.ScaleY)&quot;</span>
<span class="w">                           </span><span class="na">From=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">To=</span><span class="s">&quot;1.3&quot;</span><span class="w"> </span><span class="na">Duration=</span><span class="s">&quot;0:0:0.15&quot;</span>
<span class="w">                           </span><span class="na">AutoReverse=</span><span class="s">&quot;True&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Storyboard&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Window.Resources&gt;</span>

<span class="w">    </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;Grid.ColumnDefinitions&gt;</span>
<span class="w">            </span><span class="nt">&lt;ColumnDefinition</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;400&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;ColumnDefinition</span><span class="w"> </span><span class="na">Width=</span><span class="s">&quot;*&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Grid.ColumnDefinitions&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ゲーム領域 --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Grid.Column=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BorderThickness=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Grid&gt;</span>
<span class="w">                </span><span class="nt">&lt;Canvas</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;GameCanvas&quot;</span><span class="w"> </span>
<span class="w">                        </span><span class="na">Width=</span><span class="s">&quot;240&quot;</span><span class="w"> </span>
<span class="w">                        </span><span class="na">Height=</span><span class="s">&quot;520&quot;</span>
<span class="w">                        </span><span class="na">Background=</span><span class="s">&quot;WhiteSmoke&quot;</span>
<span class="w">                        </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                        </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">/&gt;</span>

<span class="w">                </span><span class="cm">&lt;!-- ゲームオーバーオーバーレイ --&gt;</span>
<span class="w">                </span><span class="nt">&lt;Grid</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;GameOverOverlay&quot;</span>
<span class="w">                      </span><span class="na">Background=</span><span class="s">&quot;#CC000000&quot;</span>
<span class="w">                      </span><span class="na">Visibility=</span><span class="s">&quot;{Binding IsGameOver, Converter={StaticResource BoolToVisibilityConverter}}&quot;</span>
<span class="w">                      </span><span class="na">Opacity=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                              </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                              </span><span class="na">Background=</span><span class="s">&quot;#33FFFFFF&quot;</span>
<span class="w">                              </span><span class="na">Padding=</span><span class="s">&quot;40&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;StackPanel.Effect&gt;</span>
<span class="w">                            </span><span class="nt">&lt;DropShadowEffect</span><span class="w"> </span><span class="na">Color=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BlurRadius=</span><span class="s">&quot;20&quot;</span><span class="w"> </span><span class="na">ShadowDepth=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">Opacity=</span><span class="s">&quot;0.5&quot;</span><span class="nt">/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/StackPanel.Effect&gt;</span>

<span class="w">                        </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;GameOverText&quot;</span>
<span class="w">                                 </span><span class="na">Text=</span><span class="s">&quot;GAME OVER&quot;</span>
<span class="w">                                 </span><span class="na">FontSize=</span><span class="s">&quot;48&quot;</span>
<span class="w">                                 </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                                 </span><span class="na">Foreground=</span><span class="s">&quot;#FF4444&quot;</span>
<span class="w">                                 </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                                 </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,20&quot;</span>
<span class="w">                                 </span><span class="na">RenderTransformOrigin=</span><span class="s">&quot;0.5,0.5&quot;</span><span class="nt">&gt;</span>
<span class="w">                            </span><span class="nt">&lt;TextBlock.Effect&gt;</span>
<span class="w">                                </span><span class="nt">&lt;DropShadowEffect</span><span class="w"> </span><span class="na">Color=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BlurRadius=</span><span class="s">&quot;8&quot;</span><span class="w"> </span><span class="na">ShadowDepth=</span><span class="s">&quot;4&quot;</span><span class="w"> </span><span class="na">Opacity=</span><span class="s">&quot;0.8&quot;</span><span class="nt">/&gt;</span>
<span class="w">                            </span><span class="nt">&lt;/TextBlock.Effect&gt;</span>
<span class="w">                            </span><span class="nt">&lt;TextBlock.RenderTransform&gt;</span>
<span class="w">                                </span><span class="nt">&lt;ScaleTransform/&gt;</span>
<span class="w">                            </span><span class="nt">&lt;/TextBlock.RenderTransform&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock&gt;</span>

<span class="w">                        </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding CurrentScore, StringFormat=&#39;最終スコア: {0}&#39;}&quot;</span>
<span class="w">                                 </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span>
<span class="w">                                 </span><span class="na">Foreground=</span><span class="s">&quot;White&quot;</span>
<span class="w">                                 </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                                 </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,30&quot;</span><span class="nt">/&gt;</span>

<span class="w">                        </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;もう一度プレイ&quot;</span>
<span class="w">                              </span><span class="na">Command=</span><span class="s">&quot;{Binding RestartGameCommand}&quot;</span>
<span class="w">                              </span><span class="na">Width=</span><span class="s">&quot;200&quot;</span>
<span class="w">                              </span><span class="na">Height=</span><span class="s">&quot;50&quot;</span>
<span class="w">                              </span><span class="na">FontSize=</span><span class="s">&quot;18&quot;</span>
<span class="w">                              </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                              </span><span class="na">Background=</span><span class="s">&quot;#4CAF50&quot;</span>
<span class="w">                              </span><span class="na">Foreground=</span><span class="s">&quot;White&quot;</span>
<span class="w">                              </span><span class="na">BorderThickness=</span><span class="s">&quot;0&quot;</span>
<span class="w">                              </span><span class="na">Cursor=</span><span class="s">&quot;Hand&quot;</span><span class="nt">&gt;</span>
<span class="w">                            </span><span class="nt">&lt;Button.Style&gt;</span>
<span class="w">                                </span><span class="nt">&lt;Style</span><span class="w"> </span><span class="na">TargetType=</span><span class="s">&quot;Button&quot;</span><span class="nt">&gt;</span>
<span class="w">                                    </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Template&quot;</span><span class="nt">&gt;</span>
<span class="w">                                        </span><span class="nt">&lt;Setter.Value&gt;</span>
<span class="w">                                            </span><span class="nt">&lt;ControlTemplate</span><span class="w"> </span><span class="na">TargetType=</span><span class="s">&quot;Button&quot;</span><span class="nt">&gt;</span>
<span class="w">                                                </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">Background=</span><span class="s">&quot;{TemplateBinding Background}&quot;</span>
<span class="w">                                                      </span><span class="na">CornerRadius=</span><span class="s">&quot;10&quot;</span>
<span class="w">                                                      </span><span class="na">Padding=</span><span class="s">&quot;{TemplateBinding Padding}&quot;</span><span class="nt">&gt;</span>
<span class="w">                                                    </span><span class="nt">&lt;ContentPresenter</span><span class="w"> </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                                                                    </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">/&gt;</span>
<span class="w">                                                </span><span class="nt">&lt;/Border&gt;</span>
<span class="w">                                            </span><span class="nt">&lt;/ControlTemplate&gt;</span>
<span class="w">                                        </span><span class="nt">&lt;/Setter.Value&gt;</span>
<span class="w">                                    </span><span class="nt">&lt;/Setter&gt;</span>
<span class="w">                                    </span><span class="nt">&lt;Style.Triggers&gt;</span>
<span class="w">                                        </span><span class="nt">&lt;Trigger</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;IsMouseOver&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;True&quot;</span><span class="nt">&gt;</span>
<span class="w">                                            </span><span class="nt">&lt;Setter</span><span class="w"> </span><span class="na">Property=</span><span class="s">&quot;Background&quot;</span><span class="w"> </span><span class="na">Value=</span><span class="s">&quot;#66BB6A&quot;</span><span class="nt">/&gt;</span>
<span class="w">                                        </span><span class="nt">&lt;/Trigger&gt;</span>
<span class="w">                                    </span><span class="nt">&lt;/Style.Triggers&gt;</span>
<span class="w">                                </span><span class="nt">&lt;/Style&gt;</span>
<span class="w">                            </span><span class="nt">&lt;/Button.Style&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/Button&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">                </span><span class="nt">&lt;/Grid&gt;</span>

<span class="w">                </span><span class="cm">&lt;!-- 全消し表示 --&gt;</span>
<span class="w">                </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;ZenkeshiPanel&quot;</span>
<span class="w">                          </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                          </span><span class="na">VerticalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                          </span><span class="na">Opacity=</span><span class="s">&quot;0&quot;</span>
<span class="w">                          </span><span class="na">Visibility=</span><span class="s">&quot;{Binding ShowZenkeshi, Converter={StaticResource BoolToVisibilityConverter}}&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;ZenkeshiText&quot;</span>
<span class="w">                             </span><span class="na">Text=</span><span class="s">&quot;全消し！&quot;</span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;60&quot;</span>
<span class="w">                             </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                             </span><span class="na">Foreground=</span><span class="s">&quot;Gold&quot;</span>
<span class="w">                             </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                             </span><span class="na">RenderTransformOrigin=</span><span class="s">&quot;0.5,0.5&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;TextBlock.Effect&gt;</span>
<span class="w">                            </span><span class="nt">&lt;DropShadowEffect</span><span class="w"> </span><span class="na">Color=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BlurRadius=</span><span class="s">&quot;10&quot;</span><span class="w"> </span><span class="na">ShadowDepth=</span><span class="s">&quot;3&quot;</span><span class="w"> </span><span class="na">Opacity=</span><span class="s">&quot;0.5&quot;</span><span class="nt">/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock.Effect&gt;</span>
<span class="w">                        </span><span class="nt">&lt;TextBlock.RenderTransform&gt;</span>
<span class="w">                            </span><span class="nt">&lt;ScaleTransform/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock.RenderTransform&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/TextBlock&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;+3600&quot;</span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;40&quot;</span>
<span class="w">                             </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                             </span><span class="na">Foreground=</span><span class="s">&quot;Orange&quot;</span>
<span class="w">                             </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                             </span><span class="na">Margin=</span><span class="s">&quot;0,10,0,0&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;TextBlock.Effect&gt;</span>
<span class="w">                            </span><span class="nt">&lt;DropShadowEffect</span><span class="w"> </span><span class="na">Color=</span><span class="s">&quot;Black&quot;</span><span class="w"> </span><span class="na">BlurRadius=</span><span class="s">&quot;5&quot;</span><span class="w"> </span><span class="na">ShadowDepth=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">Opacity=</span><span class="s">&quot;0.5&quot;</span><span class="nt">/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock.Effect&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/TextBlock&gt;</span>
<span class="w">                </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Grid&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- 情報パネル --&gt;</span>
<span class="w">        </span><span class="nt">&lt;StackPanel</span><span class="w"> </span><span class="na">Grid.Column=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;Button</span><span class="w"> </span><span class="na">Content=</span><span class="s">&quot;ゲーム開始&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Command=</span><span class="s">&quot;{Binding StartGameCommand}&quot;</span>
<span class="w">                    </span><span class="na">Width=</span><span class="s">&quot;150&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Height=</span><span class="s">&quot;40&quot;</span>
<span class="w">                    </span><span class="na">FontSize=</span><span class="s">&quot;16&quot;</span>
<span class="w">                    </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,20&quot;</span><span class="nt">/&gt;</span>

<span class="w">            </span><span class="cm">&lt;!-- スコア表示 --&gt;</span>
<span class="w">            </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;DarkGray&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">CornerRadius=</span><span class="s">&quot;5&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Padding=</span><span class="s">&quot;15&quot;</span>
<span class="w">                    </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,20&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;StackPanel&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;スコア&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;18&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                             </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">/&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">x:Name=</span><span class="s">&quot;ScoreValue&quot;</span>
<span class="w">                             </span><span class="na">Text=</span><span class="s">&quot;{Binding CurrentScore}&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;36&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                             </span><span class="na">Foreground=</span><span class="s">&quot;DarkBlue&quot;</span>
<span class="w">                             </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span>
<span class="w">                             </span><span class="na">RenderTransformOrigin=</span><span class="s">&quot;0.5,0.5&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;TextBlock.RenderTransform&gt;</span>
<span class="w">                            </span><span class="nt">&lt;ScaleTransform/&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/TextBlock.RenderTransform&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/TextBlock&gt;</span>
<span class="w">                </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">            </span><span class="cm">&lt;!-- 連鎖表示 --&gt;</span>
<span class="w">            </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;OrangeRed&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">BorderThickness=</span><span class="s">&quot;2&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">CornerRadius=</span><span class="s">&quot;5&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Padding=</span><span class="s">&quot;10&quot;</span>
<span class="w">                    </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,20&quot;</span>
<span class="w">                    </span><span class="na">Visibility=</span><span class="s">&quot;{Binding ShowChain, Converter={StaticResource BoolToVisibilityConverter}}&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding ChainText}&quot;</span><span class="w"> </span>
<span class="w">                         </span><span class="na">FontSize=</span><span class="s">&quot;24&quot;</span><span class="w"> </span>
<span class="w">                         </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span>
<span class="w">                         </span><span class="na">Foreground=</span><span class="s">&quot;OrangeRed&quot;</span>
<span class="w">                         </span><span class="na">HorizontalAlignment=</span><span class="s">&quot;Center&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Border&gt;</span>

<span class="w">            </span><span class="cm">&lt;!-- デバッグ情報 --&gt;</span>
<span class="w">            </span><span class="nt">&lt;Border</span><span class="w"> </span><span class="na">BorderBrush=</span><span class="s">&quot;Gray&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">BorderThickness=</span><span class="s">&quot;1&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">CornerRadius=</span><span class="s">&quot;5&quot;</span><span class="w"> </span>
<span class="w">                    </span><span class="na">Padding=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;StackPanel&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;デバッグ情報&quot;</span><span class="w"> </span><span class="na">FontWeight=</span><span class="s">&quot;Bold&quot;</span><span class="w"> </span><span class="na">Margin=</span><span class="s">&quot;0,0,0,5&quot;</span><span class="nt">/&gt;</span>
<span class="w">                    </span><span class="nt">&lt;TextBlock</span><span class="w"> </span><span class="na">Text=</span><span class="s">&quot;{Binding DebugInfo}&quot;</span><span class="w"> </span>
<span class="w">                             </span><span class="na">FontFamily=</span><span class="s">&quot;Consolas&quot;</span>
<span class="w">                             </span><span class="na">FontSize=</span><span class="s">&quot;12&quot;</span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">            </span><span class="nt">&lt;/Border&gt;</span>
<span class="w">        </span><span class="nt">&lt;/StackPanel&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
<p>「ゲームオーバー時に半透明のオーバーレイが表示されるんですね！」そうです。黒い半透明のオーバーレイの上に、赤い「GAME OVER」テキストと最終スコア、リスタートボタンが表示されます。</p>
<p>コードビハインドも更新して、ゲームオーバー時にアニメーションを再生するようにします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PuyoPuyoTDD/MainWindow.xaml.cs（更新）</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Input</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Windows.Media.Animation</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyoTDD.ViewModels</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyoTDD</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MainWindow</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Window</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="n">GameViewModel</span><span class="w"> </span><span class="n">ViewModel</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">GameViewModel</span><span class="p">)</span><span class="n">DataContext</span><span class="p">;</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">_lastShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">_lastIsGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">MainWindow</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">InitializeComponent</span><span class="p">();</span>
<span class="w">            </span><span class="n">DataContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GameViewModel</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// ViewModelの変更を監視</span>
<span class="w">            </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">PropertyChanged</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">PropertyName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">GameViewModel</span><span class="p">.</span><span class="n">ShowZenkeshi</span><span class="p">))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 全消しフラグがtrueになったらアニメーション再生</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ViewModel</span><span class="p">.</span><span class="n">ShowZenkeshi</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">_lastShowZenkeshi</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">animation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Storyboard</span><span class="p">)</span><span class="n">FindResource</span><span class="p">(</span><span class="s">&quot;ZenkeshiAnimation&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="n">animation</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">_lastShowZenkeshi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">ShowZenkeshi</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">PropertyName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">GameViewModel</span><span class="p">.</span><span class="n">IsGameOver</span><span class="p">))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// ゲームオーバーフラグがtrueになったらアニメーション再生</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ViewModel</span><span class="p">.</span><span class="n">IsGameOver</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">_lastIsGameOver</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">fadeAnimation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Storyboard</span><span class="p">)</span><span class="n">FindResource</span><span class="p">(</span><span class="s">&quot;GameOverAnimation&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">pulseAnimation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Storyboard</span><span class="p">)</span><span class="n">FindResource</span><span class="p">(</span><span class="s">&quot;GameOverPulseAnimation&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="n">fadeAnimation</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
<span class="w">                        </span><span class="n">fadeAnimation</span><span class="p">.</span><span class="n">Completed</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">__</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">pulseAnimation</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">_lastIsGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">IsGameOver</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">PropertyName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">GameViewModel</span><span class="p">.</span><span class="n">CurrentScore</span><span class="p">))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// スコアが変化したらパルスアニメーション</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ViewModel</span><span class="p">.</span><span class="n">IsGameOver</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="kt">var</span><span class="w"> </span><span class="n">animation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Storyboard</span><span class="p">)</span><span class="n">FindResource</span><span class="p">(</span><span class="s">&quot;ScorePulseAnimation&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="n">animation</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Window_KeyDown</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">KeyEventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">HandleKeyDown</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Window_KeyUp</span><span class="p">(</span><span class="kt">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">KeyEventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ViewModel</span><span class="p">.</span><span class="n">HandleKeyUp</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームオーバー時に2つのアニメーションを再生するんですね！」その通りです。まずフェードインアニメーションが再生され、その後、パルスアニメーションが繰り返し再生されます。</p>
<h3 id="_63">アプリケーションの実行<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>実装した機能を実際に確認してみましょう！</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>PuyoPuyoTDD
dotnet<span class="w"> </span>run
</code></pre></div>
<h4 id="_64">ゲームオーバーの確認<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h4>
<p>ゲームオーバーになるまでプレイしてみましょう：</p>
<ol>
<li><strong>自然なゲームオーバー</strong>: ぷよを積み重ねて、上部まで到達させる</li>
<li>新しいぷよを配置できなくなる</li>
<li>画面が暗くなる</li>
<li>赤い「GAME OVER」テキストが表示される</li>
<li>
<p>最終スコアが表示される</p>
</li>
<li>
<p><strong>ゲームオーバー演出</strong>: </p>
</li>
<li>半透明の黒いオーバーレイ</li>
<li>「GAME OVER」テキストが脈動する</li>
<li>「もう一度プレイ」ボタンが表示される</li>
</ol>
<p>「ゲームオーバーの演出がかっこいいですね！」そうなんです。プレイヤーに明確にゲームが終了したことを伝えることが重要です。</p>
<h4 id="_65">リスタート機能の確認<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h4>
<p>「もう一度プレイ」ボタンをクリックしてみましょう：</p>
<ol>
<li><strong>ゲームのリセット</strong>:</li>
<li>スコアが0に戻る</li>
<li>ステージがクリアされる</li>
<li>
<p>新しいぷよが登場する</p>
</li>
<li>
<p><strong>即座にプレイ開始</strong>:</p>
</li>
<li>すぐにキーボード操作ができる</li>
<li>ゲームループが継続している</li>
<li>スムーズに次のゲームが始まる</li>
</ol>
<p>「何度でもプレイできますね！」その通りです！リスタート機能により、プレイヤーは気軽に何度でも挑戦できます。</p>
<h4 id="_66">スコアアタック<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h4>
<p>何度かプレイして、以下を試してみましょう：</p>
<ol>
<li><strong>連鎖を狙う</strong>: 高得点を目指して連鎖を組み立てる</li>
<li><strong>全消しを狙う</strong>: 全消しボーナス3600点を獲得する</li>
<li><strong>高得点を記録</strong>: 自分のベストスコアを更新する</li>
</ol>
<p>「ゲームとして完成していますね！」その通りです！基本的なゲーム機能がすべて揃いました。</p>
<h3 id="8_1">イテレーション8のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>お疲れさまでした！イテレーション8が完了しました。このイテレーションでは、以下のことを実現しました：</p>
<ol>
<li><strong>ゲームオーバー判定</strong>: <code>IsGameOver()</code>による新しいぷよを配置できない状態の検出</li>
<li><strong>ゲームモード遷移</strong>: NewPuyo → GameOver</li>
<li><strong>リスタート機能</strong>: <code>RestartGame()</code>によるゲームの初期化</li>
<li><strong>ゲームオーバー状態管理</strong>: ViewModelでの<code>IsGameOver</code>プロパティ</li>
<li><strong>ゲームオーバー演出</strong>: 半透明オーバーレイと「GAME OVER」表示</li>
<li><strong>最終スコア表示</strong>: プレイ結果のフィードバック</li>
<li><strong>リスタートボタン</strong>: UIからの再プレイ開始</li>
</ol>
<p><strong>学んだこと</strong>:
- <strong>ゲームオーバー判定</strong>: 新しいぷよの配置位置チェック
- <strong>状態遷移</strong>: ゲームモードによる処理の切り替え
- <strong>リスタート実装</strong>: 初期化メソッドの再利用
- <strong>オーバーレイUI</strong>: 半透明背景による演出
- <strong>連続アニメーション</strong>: Storyboard.Completedイベントの活用
- <strong>ホバーエフェクト</strong>: Triggerによるボタンの視覚的フィードバック</p>
<p><strong>ゲームオーバーの意義</strong>:
ゲームオーバーは、単にゲームの終了を知らせるだけでなく、プレイヤーに「もう一度挑戦したい」と思わせる重要な要素です。明確なフィードバック（最終スコア）と簡単なリスタート方法を提供することで、リプレイ性が高まります。</p>
<blockquote>
<p>完成への道</p>
<p>ソフトウェアは決して完成しない。ただ、リリースされるだけだ。しかし、テスト駆動開発により、常に動作するソフトウェアを維持できる。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><strong>実装のポイント</strong>:
- ゲームオーバー判定は新しいぷよ生成時に行い、早期にゲームを終了
- <code>GameMode.GameOver</code>で処理を停止し、プレイヤー操作を無効化
- リスタートは初期化メソッドの再利用でシンプルに実装
- オーバーレイUIで視覚的にゲーム終了を伝える
- 2段階アニメーション（フェードイン → パルス）で印象的な演出</p>
<p>これでぷよぷよゲームが完成しました！Red-Green-Refactorのサイクルを繰り返すことで、完全に動作するゲームを実装できましたね。</p>
<h2 id="_67">ふりかえり<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h2>
<p>ぷよぷよゲームの実装を完了することができたので、これまでのふりかえりをしておきましょう。</p>
<h3 id="keep">Keep（続けること）<a class="headerlink" href="#keep" title="Permanent link">&para;</a></h3>
<p>まず <strong>TODOリスト</strong> を作成して <strong>テストファースト</strong> で１つずつ小さなステップで開発を進めていきました。テスト駆動開発の「Red-Green-Refactor」サイクルに従うことで、コードの品質を保ちながら、段階的に機能を追加していくことができました。</p>
<p>各イテレーションでは、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に進めていきました。この流れは非常に効果的で、実装の方針が明確になり、必要最小限のコードで機能を実現することができました。</p>
<p>特に以下の点は今後も続けていきたいプラクティスです：</p>
<ol>
<li><strong>ユーザーストーリーからTODOリストへの分解</strong>: 大きな機能を小さなタスクに分解することで、実装の見通しが立ちやすくなりました</li>
<li><strong>テストファーストの原則に従った実装</strong>: 先にテストを書くことで、インターフェースの設計が明確になり、実装がスムーズに進みました</li>
<li><strong>小さなステップでの開発</strong>: 一度に多くのことをしようとせず、小さく確実に進めることで、バグの混入を防げました</li>
<li><strong>リファクタリングによるコードの継続的な改善</strong>: 機能追加後にコードを整理することで、保守性の高いコードベースを維持できました</li>
<li><strong>C#の言語機能の活用</strong>: レコード型、パターンマッチング、Null許容参照型、Source Generatorなどを適切に使用できました</li>
<li><strong>WPFの特性を活かした実装</strong>: MVVM、データバインディング、Storyboard、エフェクトを効果的に活用できました</li>
</ol>
<h3 id="problem">Problem（課題）<a class="headerlink" href="#problem" title="Permanent link">&para;</a></h3>
<p>開発を進める中で、いくつかの課題も見えてきました。</p>
<ol>
<li>
<p><strong>テストの粒度</strong>: テストをどの程度細かく書くべきか、判断が難しい場面がありました。細かすぎると冗長になり、粗すぎると問題の特定が難しくなります。</p>
</li>
<li>
<p><strong>UIテストの難しさ</strong>: WPFのUIコンポーネントのテストは、Modelレイヤーのテストと比べて複雑でした。</p>
</li>
<li>
<p><strong>ゲームループの実装</strong>: 60FPSを維持するためのタイマー管理と、UIスレッドとの同期が課題でした。</p>
</li>
<li>
<p><strong>状態管理の複雑さ</strong>: ゲームモードの遷移が複雑になるにつれて、状態管理の難しさを実感しました。</p>
</li>
<li>
<p><strong>パフォーマンスの考慮</strong>: 描画処理の最適化と、メモリ使用量の管理が必要でした。</p>
</li>
</ol>
<h3 id="try">Try（挑戦）<a class="headerlink" href="#try" title="Permanent link">&para;</a></h3>
<p>今後は以下のことに挑戦していきたいと思います：</p>
<ol>
<li><strong>より効率的なテスト戦略の模索</strong>: </li>
<li>ユニットテストとインテグレーションテストのバランス</li>
<li>
<p>UIテストの自動化（FlaUIなど）</p>
</li>
<li>
<p><strong>自動化テストのカバレッジを高める工夫</strong>:</p>
</li>
<li>より多くのエッジケースをカバーする</li>
<li>
<p>Property-based testingの導入</p>
</li>
<li>
<p><strong>より複雑なゲーム機能への挑戦</strong>:</p>
</li>
<li>AIプレイヤーの実装</li>
<li>リプレイ機能</li>
<li>
<p>ランキングシステム</p>
</li>
<li>
<p><strong>パフォーマンス最適化とそのテスト手法の習得</strong>:</p>
</li>
<li>プロファイリングツールの活用</li>
<li>
<p>メモリ使用量の最適化</p>
</li>
<li>
<p><strong>アクセシビリティの向上</strong>:</p>
</li>
<li>キーボードナビゲーションの改善</li>
<li>
<p>スクリーンリーダー対応</p>
</li>
<li>
<p><strong>CI/CDパイプラインの構築</strong>:</p>
</li>
<li>GitHub Actionsでの自動テスト</li>
<li>自動デプロイの実現</li>
</ol>
<p>これらの知識と経験は、他のプロジェクトにも応用できるものです。テスト駆動開発は、コードの品質を高め、保守性を向上させるための強力な手法です。ぜひ、自分のプロジェクトにも取り入れてみてください。</p>
<h2 id="_68">おわりに<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h2>
<p>お疲れさまでした！C# WPFを使ったぷよぷよゲームの実装を、テスト駆動開発で完成させることができました。</p>
<p>このチュートリアルを通じて、以下のことを学びました：</p>
<ul>
<li><strong>テスト駆動開発の基本サイクル</strong>: Red-Green-Refactor</li>
<li><strong>C# 12.0の言語機能</strong>: Null許容参照型、レコード型、パターンマッチング、Source Generator</li>
<li><strong>WPF</strong>: MVVM、データバインディング、Storyboard、エフェクト、カスタムコントロール</li>
<li><strong>CommunityToolkit.Mvvm</strong>: ObservableProperty、RelayCommand、Source Generator</li>
<li><strong>ゲームプログラミング</strong>: ゲームループ、状態遷移、衝突判定、アルゴリズム（DFS）</li>
<li><strong>品質管理</strong>: 静的解析、Linter、コードカバレッジ、自動化（Cake）</li>
</ul>
<blockquote>
<p>テスト駆動開発の真価</p>
<p>テスト駆動開発は、単にバグを減らすための技術ではありません。設計を改善し、自信を持ってコードを変更できるようにする、開発者の強力な味方なのです。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このチュートリアルで学んだテスト駆動開発の手法は、ゲーム開発だけでなく、あらゆるソフトウェア開発に応用できます。小さなステップで確実に進み、常に動作するコードを維持する——この原則を忘れずに、これからも素晴らしいソフトウェアを作り続けてください。</p>
<p>Happy Coding! 🎮✨</p>
<h2 id="_69">参考資料<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h2>
<h3 id="_70">書籍<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<ul>
<li>Kent Beck『テスト駆動開発』（オーム社）</li>
<li>Robert C. Martin『Clean Code アジャイルソフトウェア達人の技』（KADOKAWA）</li>
<li>Martin Fowler『リファクタリング 既存のコードを安全に改善する』（オーム社）</li>
<li>Andrew Hunt, David Thomas『達人プログラマー』（オーム社）</li>
</ul>
<h3 id="_71">オンラインリソース<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.microsoft.com/dotnet/">Microsoft .NET Documentation</a></li>
<li><a href="https://docs.microsoft.com/dotnet/desktop/wpf/">WPF Documentation</a></li>
<li><a href="https://learn.microsoft.com/windows/communitytoolkit/mvvm/introduction">CommunityToolkit.Mvvm Documentation</a></li>
<li><a href="https://xunit.net/">xUnit Documentation</a></li>
<li><a href="https://github.com/moq/moq4">Moq Documentation</a></li>
<li><a href="https://cakebuild.net/">Cake Build Documentation</a></li>
</ul>
<h3 id="_72">ゲーム開発リソース<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://puyo.sega.jp/program/">ぷよぷよプログラミング</a></li>
<li><a href="https://gameprogrammingpatterns.com/">Game Programming Patterns</a></li>
</ul>
<h3 id="_73">コミュニティ<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://dotnet.microsoft.com/platform/community">.NET Community</a></li>
<li><a href="https://github.com/dotnet/wpf">WPF Community</a></li>
</ul>
<p>ありがとうございました！</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>