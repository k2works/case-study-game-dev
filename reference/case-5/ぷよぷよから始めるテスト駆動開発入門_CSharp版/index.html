
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門（C#/Unity 版） - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cunity" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門（C#/Unity 版）
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="cunity">ぷよぷよから始めるテスト駆動開発入門（C#/Unity 版）<a class="headerlink" href="#cunity" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、C# と Unity でぷよぷよゲームを作っていきましょう。さて、プログラミングの旅に出る前に、皆さんは「テスト駆動開発」について聞いたことがありますか？もしかしたら「テストって、コードを書いた後にするものじゃないの？」と思われるかもしれませんね。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、私たちが一緒にぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。まるでモブプログラミングのセッションのように、あなたと私が一緒に考え、コードを書き、改善していく過程を体験しましょう。「でも、ぷよぷよって結構複雑なゲームじゃないの？」と思われるかもしれませんが、心配いりません。各章では、ユーザーストーリーに基づいた機能を、テスト、実装、解説の順に少しずつ進めていきますよ。一歩一歩、着実に進んでいきましょう！</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>さて、テスト駆動開発では、どのように進めていけばいいのでしょうか？「テストを書いてから実装する」というのは分かりましたが、具体的にはどんな手順で進めるのでしょうか？</p>
<p>私がいつも実践しているのは、以下の 3 つのステップを繰り返すサイクルです。皆さんも一緒にやってみましょう：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます。「え？わざと失敗するテストを？」と思われるかもしれませんが、これには重要な意味があるんです。これから実装する機能が何をすべきかを明確にするためなんですよ。</li>
<li><strong>Green（緑）</strong>: 次に、テストが通るように、最小限のコードを実装します。この段階では、きれいなコードよりも「とにかく動くこと」を優先します。「最小限」というのがポイントです。必要以上のことはしないようにしましょう。</li>
<li><strong>Refactor（リファクタリング）</strong>: 最後に、コードの品質を改善します。テストが通ることを確認しながら、重複を取り除いたり、わかりやすい名前をつけたりします。「動くけど汚いコード」から「動いてきれいなコード」へと進化させるんです。</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それが TDD のマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。「赤・緑・リファクタリング」のリズムを刻むように、このサイクルを繰り返していくんです。これによって、少しずつ機能を追加し、コードの品質を高めていきましょう。皆さんも一緒にこのリズムを体感してみてください！</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>さて、実際にコードを書く前に、私たちが使用する開発環境について少しお話ししておきましょう。皆さんは「道具選びは仕事の半分」という言葉を聞いたことがありますか？プログラミングでも同じことが言えるんです。</p>
<blockquote>
<p>道具はあなたの能力を増幅します。道具のできが優れており、簡単に使いこなせるようになっていれば、より生産的になれるのです。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第 2 版）</p>
</blockquote>
<p>「どんなツールを使えばいいの？」と思われるかもしれませんね。今回のプロジェクトでは、以下のツールを使用していきます：</p>
<ul>
<li><strong>言語</strong>: C# — Unity の標準言語で、静的型付けにより安全なコードが書けます。</li>
<li><strong>ゲームエンジン</strong>: Unity — 2D/3D ゲーム開発に広く使われている強力なエンジンです。</li>
<li><strong>テストフレームワーク</strong>: Unity Test Framework (NUnit ベース) — Unity に組み込まれたテストフレームワークです。</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を追跡し、「あれ？昨日までちゃんと動いてたのに...」というときに過去の状態に戻れる魔法のツールです。</li>
<li><strong>エディタ</strong>: Visual Studio または Rider — C# 開発に最適化された IDE です。</li>
</ul>
<p>これらのツールを使って、テスト駆動開発の流れに沿ってぷよぷよゲームを実装していきましょう。「環境構築って難しそう...」と心配される方もいるかもしれませんが手順に従って進めればそんなに難しいことではありません。詳細はイテレーション 0: 環境の構築で解説します。</p>
<h2 id="_4">リリース計画<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>さて、「いきなり全部の機能を作るのは大変そう...」と思われますよね？その通りです！アジャイル開発では、大きな目標を小さな反復（イテレーション）に分割して、少しずつ進めていきます。</p>
<p>私たちのぷよぷよゲーム開発も、以下のようなイテレーションに分けて進めていきましょう：</p>
<h3 id="0">イテレーション 0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h3>
<p>「まず何から始めればいいの？」そう、最初は開発環境を整えることからですね。Unity プロジェクトの作成、テストフレームワークのセットアップ、そして開発の三種の神器（バージョン管理・テスティング・自動化）を準備します。</p>
<h3 id="1">イテレーション 1: ボードの実装<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>ぷよぷよゲームの基盤となるボード（フィールド）を作ります。「どんな大きさがいいかな？」標準的な 6 列×12 行のボードを実装し、ぷよを配置できるようにしましょう。</p>
<h3 id="2">イテレーション 2: ぷよペアの実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>「ぷよって 2 つペアで落ちてくるよね？」そうです！軸ぷよと子ぷよからなるペアを実装し、回転機能も追加します。</p>
<h3 id="3">イテレーション 3: 移動と回転<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p>プレイヤーがぷよペアを操作できるようにします。左右移動、回転、そして壁キック（壁際でも回転できる機能）を実装しましょう。</p>
<h3 id="4">イテレーション 4: 落下処理<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<p>ぷよが自動的に落下する仕組みを作ります。「重力があるゲームだもんね！」そうです、自然な落下を実現しましょう。</p>
<h3 id="5">イテレーション 5: 消去判定<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<p>同じ色のぷよが 4 つ以上つながったら消える仕組みを実装します。深さ優先探索（DFS）アルゴリズムを使いますよ。</p>
<h3 id="6">イテレーション 6: 連鎖システム<a class="headerlink" href="#6" title="Permanent link">&para;</a></h3>
<p>「れ〜んさ〜ん！」ぷよぷよの醍醐味、連鎖反応を実装します。連鎖ボーナスでスコアがどんどん上がる楽しさを実現しましょう。</p>
<h3 id="7">イテレーション 7: スコアと連鎖数の表示<a class="headerlink" href="#7" title="Permanent link">&para;</a></h3>
<p>プレイヤーが現在のスコアと連鎖数を確認できるようにします。「今何点取れてるかな？」という疑問に答えます。</p>
<h3 id="8">イテレーション 8: ゲームオーバー判定<a class="headerlink" href="#8" title="Permanent link">&para;</a></h3>
<p>ぷよが画面上部まで積み上がったらゲームオーバー。リスタート機能も実装しましょう。</p>
<h3 id="9">イテレーション 9: 全消しボーナスと最終調整<a class="headerlink" href="#9" title="Permanent link">&para;</a></h3>
<p>「全部消えた！」という気持ちよさを味わえる全消しボーナスを実装し、ゲームを完成させます。</p>
<p>それでは、イテレーション 0 から始めていきましょう！</p>
<hr />
<h2 id="0_1">イテレーション 0: 環境の構築<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h2>
<p>さて、いよいよコードを書き始める準備をしましょう！「環境構築って面倒くさそう...」と思うかもしれませんが、一度しっかりセットアップしておけば、この後の開発がとても楽になりますよ。</p>
<p>このイテレーションでは、先ほど触れた「ソフトウェア開発の三種の神器」を準備します。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない 3 つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の 3 つです。</p>
<p>— https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<h3 id="unity">Unity プロジェクトの作成<a class="headerlink" href="#unity" title="Permanent link">&para;</a></h3>
<p>まずは Unity プロジェクトを作成しましょう。「Unity って初めてだけど大丈夫かな？」心配いりません、一緒に進めていきましょう。</p>
<ol>
<li><strong>Unity Hub のインストール</strong></li>
</ol>
<p>Unity Hub は Unity のバージョン管理やプロジェクト管理を行うツールです。<a href="https://unity.com/download">Unity Hub ダウンロードページ</a>からインストールしましょう。</p>
<ol>
<li><strong>Unity エディタのインストール</strong></li>
</ol>
<p>Unity Hub を開き、「Installs」タブから Unity エディタをインストールします。今回は Unity 2022.3 LTS（Long Term Support）を使用します。「LTS って何？」長期サポート版のことで、安定性が保証されているバージョンです。</p>
<ol>
<li><strong>新しいプロジェクトの作成</strong></li>
</ol>
<p>Unity Hub の「Projects」タブから「New project」をクリックします。</p>
<ul>
<li>テンプレート: <strong>2D (Built-in Render Pipeline)</strong> を選択</li>
<li>プロジェクト名: <code>PuyoPuyoTDD</code></li>
<li>保存場所: お好きな場所を選択</li>
</ul>
<p>「Create project」をクリックしてプロジェクトを作成します。</p>
<ol>
<li><strong>プロジェクト構造の確認</strong></li>
</ol>
<p>Unity エディタが開いたら、プロジェクト構造を確認しましょう。Project ウィンドウに <code>Assets</code> フォルダが見えますね。ここに私たちのコードやリソースを配置していきます。</p>
<h3 id="git">Git によるバージョン管理<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>「コードを書く前にバージョン管理？」そうです！最初から Git を使うことで、変更履歴を追跡し、いつでも過去の状態に戻れるようにします。</p>
<ol>
<li><strong>Git リポジトリの初期化</strong></li>
</ol>
<p>プロジェクトのルートディレクトリ（<code>PuyoPuyoTDD</code> フォルダ）で以下のコマンドを実行します：</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>PuyoPuyoTDD
git<span class="w"> </span>init
</code></pre></div>
<ol>
<li><strong>.gitignore の作成</strong></li>
</ol>
<p>Unity プロジェクトでは、いくつかのファイルやフォルダをバージョン管理から除外する必要があります。「なんで全部管理しないの？」と思うかもしれませんが、自動生成されるファイルや個人設定ファイルは除外した方が良いんです。</p>
<p><code>.gitignore</code> ファイルを作成して、以下の内容を記述します：</p>
<div class="highlight"><pre><span></span><code># Unity generated
[Ll]ibrary/
[Tt]emp/
[Oo]bj/
[Bb]uild/
[Bb]uilds/
[Ll]ogs/
[Uu]ser[Ss]ettings/

# Visual Studio cache/options
.vs/
*.csproj
*.unityproj
*.sln
*.suo
*.tmp
*.user
*.userprefs
*.pidb
*.booproj
*.svd
*.pdb
*.mdb
*.opendb
*.VC.db

# Rider
.idea/

# OS generated
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db
</code></pre></div>
<ol>
<li><strong>初回コミット</strong></li>
</ol>
<p>さて、最初のコミットをしましょう！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: Unity プロジェクトの初期化&#39;</span>
</code></pre></div>
<p>「<code>chore</code> って何？」良い質問ですね！これは Conventional Commits という規約に従ったコミットメッセージのプリフィックスです。<code>chore</code> は「雑務・設定変更」を意味します。</p>
<h3 id="_5">コミットメッセージの規約<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>コミットメッセージには、以下のような規約があります。これに従うと、後で変更履歴を追いやすくなるんです。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
</code></pre></div>
<p>主なタイプ：</p>
<ul>
<li><code>feat</code>: 新機能の追加</li>
<li><code>fix</code>: バグ修正</li>
<li><code>docs</code>: ドキュメントのみの変更</li>
<li><code>style</code>: コードの意味に影響しない変更（空白、フォーマットなど）</li>
<li><code>refactor</code>: バグ修正や機能追加を伴わないコード変更</li>
<li><code>test</code>: テストの追加や修正</li>
<li><code>chore</code>: ビルドプロセスや補助ツールの変更</li>
</ul>
<h3 id="unity-test-framework">Unity Test Framework のセットアップ<a class="headerlink" href="#unity-test-framework" title="Permanent link">&para;</a></h3>
<p>次は「テスティング」の準備です。Unity には Unity Test Framework という公式のテストフレームワークが組み込まれています。</p>
<ol>
<li><strong>Test Runner ウィンドウを開く</strong></li>
</ol>
<p>Unity エディタのメニューから <code>Window &gt; General &gt; Test Runner</code> を選択します。</p>
<ol>
<li><strong>テストアセンブリの作成</strong></li>
</ol>
<p>Test Runner ウィンドウで「Create EditMode Test Assembly Folder」をクリックします。これにより、<code>Assets/Tests</code> フォルダが作成されます。</p>
<p>「EditMode と PlayMode って何が違うの？」良い質問ですね：</p>
<ul>
<li><strong>EditMode</strong>: Unity エディタ上で実行されるテスト。ゲームロジックの単体テストに使用。</li>
<li><strong>PlayMode</strong>: Unity のゲームモードで実行されるテスト。実際のゲーム動作を統合テスト。</li>
</ul>
<p>今回は主に EditMode テストを使用します。</p>
<ol>
<li><strong>プロダクションコード用のフォルダ構成</strong></li>
</ol>
<p>テストとプロダクションコードを分けて管理しましょう。<code>Assets</code> フォルダ内に以下の構造を作ります：</p>
<div class="highlight"><pre><span></span><code>Assets/
├── Scripts/
│   ├── Core/          # コアゲームロジック
│   ├── UI/            # ユーザーインターフェース
│   └── Utilities/     # ユーティリティクラス
└── Tests/             # テストコード
    └── EditMode/
</code></pre></div>
<ol>
<li><strong>アセンブリ定義の作成</strong></li>
</ol>
<p>Unity では、アセンブリ定義を使ってコードをモジュール化します。「アセンブリって何？」コードのまとまりのことで、これを分けることでビルド時間が短縮されます。</p>
<p><code>Assets/Scripts</code> フォルダ内で右クリック → <code>Create &gt; Assembly Definition</code> を選択し、<code>PuyoPuyo.asmdef</code> という名前で作成します。</p>
<p><code>Assets/Tests/EditMode</code> フォルダにも同様に <code>PuyoPuyo.Tests.asmdef</code> を作成し、Inspector で以下のように設定します：</p>
<ul>
<li>Platform: <code>Editor</code> のみチェック</li>
<li>Assembly Definition References: <code>PuyoPuyo</code> を追加</li>
<li><code>Test Assemblies</code> にチェック</li>
</ul>
<h3 id="_6">最初のテストを書いてみる<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>環境が整ったので、本当にテストが動くか確認してみましょう！</p>
<p><code>Assets/Tests/EditMode</code> フォルダに <code>SampleTest.cs</code> というファイルを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">NUnit.Framework</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SampleTest</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="na">[Test]</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">TestExample</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Arrange（準備）</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// Act（実行）</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// Assert（検証）</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="n">actual</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「Arrange-Act-Assert って何？」テストコードの基本パターンです：</p>
<ul>
<li><strong>Arrange</strong>: テストに必要な準備をする</li>
<li><strong>Act</strong>: 実際にテスト対象を実行する</li>
<li><strong>Assert</strong>: 結果が期待通りか検証する</li>
</ul>
<p>Test Runner ウィンドウで「Run All」をクリックしてテストを実行してみましょう。緑色のチェックマークが表示されれば成功です！</p>
<p>「やった！テストが通った！」素晴らしいですね。これで TDD の準備が整いました。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: テストフレームワークのセットアップ&#39;</span>
</code></pre></div>
<h3 id="_7">静的コード解析の設定<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質をチェックする仕組みが必要です。C# には Roslyn Analyzers という強力な静的コード解析ツールがあります。</p>
<ol>
<li><strong>EditorConfig の作成</strong></li>
</ol>
<p>プロジェクトのルートディレクトリに <code>.editorconfig</code> ファイルを作成します：</p>
<div class="highlight"><pre><span></span><code><span class="na">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>

<span class="k">[*]</span>
<span class="na">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">utf-8</span>
<span class="na">indent_style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">space</span>
<span class="na">indent_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">4</span>
<span class="na">insert_final_newline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">trim_trailing_whitespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>

<span class="k">[*.cs]</span>
<span class="c1"># C# のコーディング規約</span>
<span class="na">dotnet_sort_system_directives_first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">csharp_new_line_before_open_brace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">all</span>
<span class="na">csharp_prefer_braces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true:warning</span>

<span class="c1"># 命名規則</span>
<span class="na">dotnet_naming_rule.interface_should_be_begins_with_i.severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">warning</span>
<span class="na">dotnet_naming_rule.interface_should_be_begins_with_i.symbols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">interface</span>
<span class="na">dotnet_naming_rule.interface_should_be_begins_with_i.style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">begins_with_i</span>

<span class="na">dotnet_naming_symbols.interface.applicable_kinds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">interface</span>
<span class="na">dotnet_naming_symbols.interface.applicable_accessibilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">public, internal, private, protected, protected_internal</span>

<span class="na">dotnet_naming_style.begins_with_i.required_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">I</span>
<span class="na">dotnet_naming_style.begins_with_i.capitalization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pascal_case</span>
</code></pre></div>
<p>「なんだか長い設定だな...」でも、これでコーディングスタイルが統一されるんです。</p>
<ol>
<li><strong>Roslyn Analyzers の有効化</strong></li>
</ol>
<p>Unity 2020.2 以降、Roslyn Analyzers がデフォルトで有効になっています。コードを書くと、Visual Studio や Rider がリアルタイムで警告を表示してくれます。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: 静的コード解析の設定&#39;</span>
</code></pre></div>
<h3 id="_8">コマンドライン開発環境の整備<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>最後に「自動化」です。Unity をコマンドラインから操作できるようにして、テスト、ビルド、フォーマットなどをターミナルから実行できる環境を整えましょう。</p>
<h4 id="unity_1">Unity のパスを設定<a class="headerlink" href="#unity_1" title="Permanent link">&para;</a></h4>
<p>まず、Unity のパスを環境変数として設定しておくと便利です。プロジェクトルートに <code>unity-config.sh</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># Unity 設定ファイル</span>

<span class="c1"># Unity のパス（OS とバージョンに応じて変更してください）</span>
<span class="c1"># macOS の場合</span>
<span class="nv">UNITY_PATH</span><span class="o">=</span><span class="s2">&quot;/Applications/Unity/Hub/Editor/2022.3.0f1/Unity.app/Contents/MacOS/Unity&quot;</span>

<span class="c1"># Linux の場合（例）</span>
<span class="c1"># UNITY_PATH=&quot;/usr/bin/unity-editor&quot;</span>

<span class="c1"># Windows の場合（Git Bash）</span>
<span class="c1"># UNITY_PATH=&quot;/c/Program Files/Unity/Hub/Editor/2022.3.0f1/Editor/Unity.exe&quot;</span>

<span class="nb">export</span><span class="w"> </span>UNITY_PATH
<span class="nb">export</span><span class="w"> </span><span class="nv">PROJECT_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h4 id="_9">テスト実行スクリプト<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p><code>scripts/test.sh</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># Unity テスト実行スクリプト</span>

<span class="nb">source</span><span class="w"> </span>./unity-config.sh

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;🧪 Unity テスト実行中...&quot;</span>
<span class="s2">&quot;</span><span class="nv">$UNITY_PATH</span><span class="s2">&quot;</span><span class="w"> </span>-batchmode<span class="w"> </span>-nographics<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-projectPath<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJECT_PATH</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-runTests<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-testPlatform<span class="w"> </span>EditMode<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-testResults<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJECT_PATH</span><span class="s2">/TestResults.xml&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-logFile<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJECT_PATH</span><span class="s2">/test.log&quot;</span>

<span class="nv">EXIT_CODE</span><span class="o">=</span><span class="nv">$?</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$EXIT_CODE</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ すべてのテストが成功しました&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;❌ テストが失敗しました&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;詳細: test.log を確認してください&quot;</span>
<span class="k">fi</span>

<span class="nb">exit</span><span class="w"> </span><span class="nv">$EXIT_CODE</span>
</code></pre></div>
<h4 id="_10">ビルドスクリプト<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p><code>scripts/build.sh</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># Unity ビルドスクリプト</span>

<span class="nb">source</span><span class="w"> </span>./unity-config.sh

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;🔨 Unity プロジェクトをビルド中...&quot;</span>
<span class="s2">&quot;</span><span class="nv">$UNITY_PATH</span><span class="s2">&quot;</span><span class="w"> </span>-batchmode<span class="w"> </span>-nographics<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-projectPath<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJECT_PATH</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-buildTarget<span class="w"> </span>StandaloneLinux64<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-quit<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-logFile<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJECT_PATH</span><span class="s2">/build.log&quot;</span>

<span class="nv">EXIT_CODE</span><span class="o">=</span><span class="nv">$?</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$EXIT_CODE</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ ビルドが成功しました&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;❌ ビルドが失敗しました&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;詳細: build.log を確認してください&quot;</span>
<span class="k">fi</span>

<span class="nb">exit</span><span class="w"> </span><span class="nv">$EXIT_CODE</span>
</code></pre></div>
<h4 id="_11">コードフォーマットスクリプト<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>C# のコードフォーマットには <code>dotnet format</code> を使用します。<code>scripts/format.sh</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># C# コードフォーマットスクリプト</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✨ コードフォーマット実行中...&quot;</span>

<span class="c1"># .csproj ファイルを探す</span>
<span class="nv">CSPROJ_FILE</span><span class="o">=</span><span class="k">$(</span>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.csproj&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CSPROJ_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;❌ .csproj ファイルが見つかりません&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

dotnet<span class="w"> </span>format<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CSPROJ_FILE</span><span class="s2">&quot;</span><span class="w"> </span>--verify-no-changes

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ コードフォーマットOK&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;🔄 コードフォーマット適用中...&quot;</span>
<span class="w">    </span>dotnet<span class="w"> </span>format<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CSPROJ_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ コードフォーマット完了&quot;</span>
<span class="k">fi</span>
</code></pre></div>
<h4 id="_12">統合チェックスクリプト<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>すべてのチェックを一括で実行する <code>scripts/check.sh</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># 統合品質チェックスクリプト</span>

<span class="nb">set</span><span class="w"> </span>-e<span class="w">  </span><span class="c1"># エラーで停止</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== 品質チェック開始 ===&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="c1"># フォーマットチェック</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;1. コードフォーマットチェック&quot;</span>
./scripts/format.sh
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="c1"># テスト実行</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;2. テスト実行&quot;</span>
./scripts/test.sh
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== ✅ すべてのチェックが完了しました ===&quot;</span>
</code></pre></div>
<h4 id="_13">ファイル監視と自動実行スクリプト<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>ファイル変更を検知して自動的にチェックを実行する <code>scripts/watch.sh</code> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># Unity テストの監視と自動実行スクリプト</span>

<span class="nb">source</span><span class="w"> </span>./unity-config.sh

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== Unity Test Watcher ===&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ファイル変更を監視中...&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;終了するには Ctrl+C を押してください&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="c1"># 初回実行</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;🔄 初回チェック実行...&quot;</span>
./scripts/check.sh<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="c1"># ファイル監視</span>
<span class="k">if</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>fswatch<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># macOS</span>
<span class="w">    </span>fswatch<span class="w"> </span>-o<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.*&quot;</span><span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;\\.cs</span>$<span class="s2">&quot;</span><span class="w"> </span>Assets/<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span>read<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;📝 変更検出: </span><span class="k">$(</span>date<span class="w"> </span><span class="s1">&#39;+%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">        </span>./scripts/check.sh<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="k">done</span>
<span class="k">elif</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>inotifywait<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># Linux</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span>inotifywait<span class="w"> </span>-r<span class="w"> </span>-e<span class="w"> </span>modify,create,delete<span class="w"> </span>--include<span class="w"> </span><span class="s1">&#39;\.cs$&#39;</span><span class="w"> </span>Assets/
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;📝 変更検出: </span><span class="k">$(</span>date<span class="w"> </span><span class="s1">&#39;+%H:%M:%S&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">        </span>./scripts/check.sh<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="k">done</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;❌ ファイル監視ツールがインストールされていません&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;macOS: brew install fswatch&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Linux: sudo apt-get install inotify-tools&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>
</code></pre></div>
<h4 id="cake">Cake によるビルド自動化<a class="headerlink" href="#cake" title="Permanent link">&para;</a></h4>
<p>「ビルド自動化ツールは何を使えばいいですか？」.NET エコシステムでは Cake がよく使われます。Cake は C# で書けるクロスプラットフォームなビルド自動化ツールです。</p>
<h5 id="cake_1">Cakeとは<a class="headerlink" href="#cake_1" title="Permanent link">&para;</a></h5>
<p>Cake（C# Make）は、.NET 開発者向けのビルド自動化システムです：</p>
<p><strong>特徴</strong>
- C# で書けるビルドスクリプト（型安全、IntelliSense 対応）
- クロスプラットフォーム（Windows、macOS、Linux）
- 豊富なアドインとヘルパー
- .NET ツールとの統合</p>
<h5 id="cake_2">Cakeのセットアップ<a class="headerlink" href="#cake_2" title="Permanent link">&para;</a></h5>
<p>まず、Cake をローカルツールとしてインストールします：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .NET ローカルツールマニフェストを作成</span>
dotnet<span class="w"> </span>new<span class="w"> </span>tool-manifest

<span class="c1"># Cake をインストール</span>
dotnet<span class="w"> </span>tool<span class="w"> </span>install<span class="w"> </span>Cake.Tool
</code></pre></div>
<p>次に、ビルドスクリプト <code>build.cake</code> をプロジェクトルートに作成します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// build.cake</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// 引数</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="kt">var</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argument</span><span class="p">(</span><span class="s">&quot;target&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Default&quot;</span><span class="p">);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argument</span><span class="p">(</span><span class="s">&quot;configuration&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Release&quot;</span><span class="p">);</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// タスク定義</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;Unity テストを実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;./scripts/test.sh&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;テストが失敗しました&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;Unity プロジェクトをビルド&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">exitCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;./scripts/build.sh&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exitCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;ビルドが失敗しました&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Format&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;コードを自動フォーマット&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;./scripts/format.sh&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;すべての品質チェックを実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Format&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">);</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Watch&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;ファイル監視モードで自動テスト実行&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Does</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StartProcess</span><span class="p">(</span><span class="s">&quot;./scripts/watch.sh&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// ターゲット</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;Default&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Check&quot;</span><span class="p">);</span>

<span class="n">Task</span><span class="p">(</span><span class="s">&quot;CI&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">Description</span><span class="p">(</span><span class="s">&quot;CI環境での完全なビルドとテスト&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Check&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">IsDependentOn</span><span class="p">(</span><span class="s">&quot;Build&quot;</span><span class="p">);</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">// 実行</span>
<span class="c1">///////////////////////////////////////////////////////////////////////////////</span>

<span class="n">RunTarget</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
</code></pre></div>
<h5 id="cake_3">Cakeの実行<a class="headerlink" href="#cake_3" title="Permanent link">&para;</a></h5>
<p>Cake スクリプトを実行するには、以下のコマンドを使用します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># デフォルトタスク（Check）を実行</span>
dotnet<span class="w"> </span>cake

<span class="c1"># 特定のタスクを実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch

<span class="c1"># CI環境でのビルド</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>CI
</code></pre></div>
<h5 id="cake_4">Cakeの利点<a class="headerlink" href="#cake_4" title="Permanent link">&para;</a></h5>
<p>「なぜ Cake を使うのですか？」Cake を使う利点は以下の通りです：</p>
<ol>
<li><strong>型安全性</strong>：C# で書くのでコンパイル時に型チェックされる</li>
<li><strong>IntelliSense</strong>：Visual Studio Code や Rider で補完が効く</li>
<li><strong>再利用性</strong>：NuGet パッケージとしてビルドロジックを共有できる</li>
<li><strong>統合性</strong>：.NET ツールとシームレスに統合</li>
<li><strong>可読性</strong>：複雑なビルドロジックも構造化して書ける</li>
<li><strong>クロスプラットフォーム</strong>：Windows、macOS、Linux で同じスクリプトが動く</li>
</ol>
<h4 id="_14">スクリプトの実行権限付与<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>すべてのスクリプトに実行権限を付与します：</p>
<div class="highlight"><pre><span></span><code>chmod<span class="w"> </span>+x<span class="w"> </span>unity-config.sh
chmod<span class="w"> </span>+x<span class="w"> </span>scripts/*.sh
</code></pre></div>
<h4 id="_15">使い方<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>これで、以下のようにコマンドラインから開発できます：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># テスト実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
<span class="c1"># または直接スクリプトを実行</span>
./scripts/test.sh

<span class="c1"># ビルド</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build

<span class="c1"># コードフォーマット</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format

<span class="c1"># すべてのチェック</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Check

<span class="c1"># ファイル監視モード（開発中はこれを起動）</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch
</code></pre></div>
<p>「すごい！Unity がコマンドラインで使えるようになった！」そうです。これで VS Code やターミナルだけで開発できるようになりました。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: コマンドライン開発環境の整備&#39;</span>
</code></pre></div>
<h3 id="0_2">イテレーション 0 のまとめ<a class="headerlink" href="#0_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！これで開発環境の準備が整いました。振り返ってみましょう：</p>
<ol>
<li><strong>バージョン管理</strong>: Git リポジトリを初期化し、<code>.gitignore</code> を設定</li>
<li><strong>テスティング</strong>: Unity Test Framework をセットアップし、最初のテストを実行</li>
<li><strong>自動化</strong>: Cake によるビルド自動化とファイル監視スクリプトで自動テスト実行を実現</li>
</ol>
<p>「ソフトウェア開発の三種の神器」がすべて揃いましたね！これで次のイテレーションから、安心してテスト駆動開発を進めることができます。</p>
<p>次のイテレーションでは、いよいよぷよぷよの基盤となるボードを実装していきますよ。楽しみですね！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;docs: イテレーション 0 完了&#39;</span>
</code></pre></div>
<hr />
<h2 id="1_1">イテレーション 1: ボードの実装<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、ぷよぷよの基盤となるボード（フィールド）を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_16">ユーザーストーリー<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとして、6 列×12 行のボードを持つ</p>
</blockquote>
<p>「システムとして」というのは、プレイヤーには直接見えない内部的な機能という意味です。このボードが、これから実装するすべての機能の土台となります。</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずは TODO リストを作成しましょう。TODO リストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>ボードの実装に必要なタスクを考えてみましょう：</p>
<ul>
<li>ボードを作成できる（6 列×12 行のサイズで初期化）</li>
<li>ボードの特定の位置にぷよを配置できる</li>
<li>ボードの特定の位置のぷよを取得できる</li>
<li>ボードの範囲外のチェックができる（壁判定）</li>
<li>ボードをクリアできる（すべてのぷよを削除）</li>
</ul>
<p>これらのタスクを一つずつテスト駆動開発のサイクルで実装していきましょう！</p>
<h3 id="_17">テスト: ボードの作成<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><code>Assets/Tests/EditMode</code> フォルダに <code>BoardTest.cs</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">NUnit.Framework</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">BoardTest</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="na">[Test]</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ボ</span><span class="n">ー</span><span class="err">ドを作成すると</span><span class="mi">6</span><span class="err">列</span><span class="mi">12</span><span class="err">行で初期化される</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">            </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// Assert</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Cols</span><span class="p">);</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Rows</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="na">[Test]</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">新規作成したボ</span><span class="n">ー</span><span class="err">ドはすべての位置が空である</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Arrange</span>
<span class="w">            </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// Act &amp; Assert</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Rows</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Cols</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">));</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「Arrange-Act-Assert って何？」良い質問ですね！これはテストコードの基本パターンです：</p>
<ul>
<li><strong>Arrange（準備）</strong>: テストに必要な準備をする</li>
<li><strong>Act（実行）</strong>: 実際にテスト対象を実行する</li>
<li><strong>Assert（検証）</strong>: 結果が期待通りか検証する</li>
</ul>
<p>このテストでは、<code>Board</code> クラスが正しく初期化され、すべての位置が空（<code>PuyoColor.None</code>）であることを確認しています。</p>
<h3 id="_18">実装: ボードの作成<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<p>Test Runner で「Run All」をクリックすると...</p>
<div class="highlight"><pre><span></span><code>error CS0246: The type or namespace name &#39;Board&#39; could not be found
error CS0246: The type or namespace name &#39;PuyoColor&#39; could not be found
</code></pre></div>
<p>おっと！まだ <code>Board</code> クラスも <code>PuyoColor</code> も実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<blockquote>
<p>明白な実装</p>
<p>シンプルな操作をどう実装すればいいだろうか。ただ実装すればいいのだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストが通るように最小限のコードを実装していきましょう。</p>
<p>まず、<code>Assets/Scripts/Core</code> フォルダに <code>PuyoColor.cs</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">PuyoColor</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">None</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">   </span><span class="c1">// 空</span>
<span class="w">        </span><span class="n">Red</span><span class="p">,</span><span class="w">        </span><span class="c1">// 赤</span>
<span class="w">        </span><span class="n">Blue</span><span class="p">,</span><span class="w">       </span><span class="c1">// 青</span>
<span class="w">        </span><span class="n">Green</span><span class="p">,</span><span class="w">      </span><span class="c1">// 緑</span>
<span class="w">        </span><span class="n">Yellow</span><span class="w">      </span><span class="c1">// 黄</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なんで enum なの？」良い質問ですね！enum（列挙型）を使うことで、ぷよの色を型安全に扱えるんです。<code>int</code> で <code>1, 2, 3...</code> と管理するよりも、<code>PuyoColor.Red</code> のように意味が明確になりますよね。</p>
<p>次に、<code>Assets/Scripts/Core</code> フォルダに <code>Board.cs</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Board</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">COLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ROWS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">[,]</span><span class="w"> </span><span class="n">cells</span><span class="p">;</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Cols</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">COLS</span><span class="p">;</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Rows</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ROWS</span><span class="p">;</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">Board</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">[</span><span class="n">ROWS</span><span class="p">,</span><span class="w"> </span><span class="n">COLS</span><span class="p">];</span>
<span class="w">            </span><span class="n">Clear</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="nf">Get</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Clear</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ROWS</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COLS</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>✅ ボードを作成すると6列12行で初期化される
✅ 新規作成したボードはすべての位置が空である
</code></pre></div>
<p>やった！テストが通りました。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<h3 id="_19">解説: ボードの実装<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>実装したボードについて、少し解説しておきましょう：</p>
<ol>
<li>
<p><strong>定数の使用</strong>: <code>COLS</code> と <code>ROWS</code> を定数として定義しています。「なぜ？」というと、マジックナンバー（突然現れる数字）を避けるためです。</p>
</li>
<li>
<p><strong>2 次元配列</strong>: <code>PuyoColor[,] cells</code> で 2 次元配列を使っています。C# では <code>[row, col]</code> の順序でアクセスします。</p>
</li>
<li>
<p><strong>プロパティ</strong>: <code>public int Cols =&gt; COLS;</code> は読み取り専用プロパティです。外部からは値を読めますが、変更できません。</p>
</li>
<li>
<p><strong>Clear メソッド</strong>: すべての位置を <code>PuyoColor.None</code> で埋める処理です。コンストラクタからも呼び出しています。</p>
</li>
</ol>
<h3 id="_20">テスト: ぷよの配置と取得<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>次に、ボードにぷよを配置し、取得できることをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// BoardTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよを配置して取得できる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">異なる位置に異なる色のぷよを配置できる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行すると、<code>Set</code> メソッドが未定義なのでエラーになります。これが「Red」の状態ですね。</p>
<h3 id="_21">実装: ぷよの配置<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p><code>Board.cs</code> に <code>Set</code> メソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Set</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプル！」そうです、最小限の実装を心がけます。テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>✅ ぷよを配置して取得できる
✅ 異なる位置に異なる色のぷよを配置できる
</code></pre></div>
<p>素晴らしい！Green になりました。</p>
<h3 id="_22">テスト: 範囲外チェック<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>ボードの外にぷよを配置しようとしたらどうなるでしょうか？壁や天井にぶつかる判定が必要ですね。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// BoardTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">範囲内の座標は</span><span class="n">IsInBounds</span><span class="err">が</span><span class="n">true</span><span class="err">を返す</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act &amp; Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">範囲外の座標は</span><span class="n">IsInBounds</span><span class="err">が</span><span class="n">false</span><span class="err">を返す</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act &amp; Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// 上に出る</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// 下に出る</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="c1">// 左に出る</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">));</span><span class="w">  </span><span class="c1">// 右に出る</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_23">実装: 範囲外チェック<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p><code>Board.cs</code> に <code>IsInBounds</code> メソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">IsInBounds</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ROWS</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COLS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>✅ 範囲内の座標はIsInBoundsがtrueを返す
✅ 範囲外の座標はIsInBoundsがfalseを返す
</code></pre></div>
<p>完璧です！</p>
<h3 id="_24">リファクタリング: ボードのクリア<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>現在のコードを見てみましょう。<code>Clear</code> メソッドは正しく動作していますが、テストがまだありませんね。「テストのないコードは動いていないコードと同じ」という考え方もあります。</p>
<p>テストを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// BoardTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Clear</span><span class="err">を呼ぶとすべての位置が空になる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Rows</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Cols</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行すると、既存の実装で通ります。これで安心してリファクタリングできますね。</p>
<h3 id="1_2">イテレーション 1 のまとめ<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！イテレーション 1 で実装した内容を振り返ってみましょう：</p>
<ol>
<li><strong>PuyoColor 列挙型</strong>: ぷよの色を型安全に管理</li>
<li><strong>Board クラス</strong>: 6 列×12 行のボードを実装</li>
<li><code>Get(row, col)</code>: ぷよの取得</li>
<li><code>Set(row, col, color)</code>: ぷよの配置</li>
<li><code>IsInBounds(row, col)</code>: 範囲チェック</li>
<li><code>Clear()</code>: ボードのクリア</li>
</ol>
<p>すべての機能にテストがあり、安心してコードを変更できる状態になりました。これがテスト駆動開発の大きなメリットです！</p>
<blockquote>
<p>テストは開発者を解放する。テストのおかげで、恐れることなくコードをリファクタリングできる。</p>
<p>— Robert C. Martin 『Clean Code』</p>
</blockquote>
<p>次のイテレーションでは、ぷよペアを実装していきます。楽しみですね！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ボードの基本機能を実装&#39;</span>
</code></pre></div>
<hr />
<h2 id="2_1">イテレーション 2: ぷよペアの実装<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h2>
<p>前回のイテレーションでボードができましたね。「でも、ぷよぷよって 2 つのぷよがペアで落ちてくるゲームじゃないの？」そうです！今回は、軸ぷよと子ぷよからなる「ぷよペア」を実装していきましょう。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_25">ユーザーストーリー<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとして、軸ぷよと子ぷよからなるペアを持つ</p>
</blockquote>
<p>「軸ぷよと子ぷよ？」良い質問ですね！ぷよぷよでは、2 つのぷよがペアで落ちてきます。中心となる「軸ぷよ」と、その周りを回転する「子ぷよ」です。このペアを回転させることで、戦略的にぷよを配置できるんです。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>ぷよペアを実装するために必要なタスクを考えてみましょう：</p>
<ul>
<li>ぷよペアを作成できる（軸ぷよと子ぷよの位置と色を持つ）</li>
<li>ぷよペアを回転できる（右回転・左回転）</li>
<li>ぷよペアの衝突判定ができる（ボードや他のぷよとの重なりをチェック）</li>
<li>ぷよペアをボードに配置できる（着地時にボードに固定する）</li>
</ul>
<p>これらのタスクを一つずつテスト駆動開発で実装していきましょう！</p>
<h3 id="_26">テスト: ぷよペアの作成<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><code>Assets/Tests/EditMode</code> フォルダに <code>PairTest.cs</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">NUnit.Framework</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.Tests</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PairTest</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="na">[Test]</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよペアを作成すると軸ぷよと子ぷよが設定される</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">            </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Assert</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisColor</span><span class="p">);</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildColor</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="na">[Test]</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">初期状態では子ぷよは軸ぷよの上にある</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Arrange &amp; Act</span>
<span class="w">            </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Assert</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">);</span>
<span class="w">            </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildY</span><span class="p">);</span><span class="w"> </span><span class="c1">// 軸ぷよの上（Y座標が1小さい）</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なぜ子ぷよが上にあるの？」良い質問ですね！ぷよぷよでは、画面の上から落ちてくるので、最初は子ぷよが軸ぷよの上にあります。Y 座標は上が小さく、下が大きいので、子ぷよの Y 座標は軸ぷよより 1 小さくなります。</p>
<h3 id="_27">実装: ぷよペアの作成<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>テストを実行すると、<code>Pair</code> クラスが未定義なのでエラーになります。これが「Red」の状態ですね。</p>
<blockquote>
<p>明白な実装</p>
<p>シンプルな操作をどう実装すればいいだろうか。ただ実装すればいいのだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p><code>Assets/Scripts/Core</code> フォルダに <code>Pair.cs</code> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Pair</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 軸ぷよの位置と色</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">AxisX</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">AxisY</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">AxisColor</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 子ぷよの位置と色</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ChildX</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ChildY</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">ChildColor</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 回転状態（0: 上, 1: 右, 2: 下, 3: 左）</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rotation</span><span class="p">;</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">Pair</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">axisX</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">axisY</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">axisColor</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">childColor</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">AxisX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">axisX</span><span class="p">;</span>
<span class="w">            </span><span class="n">AxisY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">axisY</span><span class="p">;</span>
<span class="w">            </span><span class="n">AxisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">axisColor</span><span class="p">;</span>
<span class="w">            </span><span class="n">ChildColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">childColor</span><span class="p">;</span>
<span class="w">            </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 初期状態は子ぷよが上</span>

<span class="w">            </span><span class="c1">// 初期位置を計算</span>
<span class="w">            </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateChildPosition</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 回転状態に応じて子ぷよの位置を計算</span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">                    </span><span class="n">ChildX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisX</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ChildY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">                    </span><span class="n">ChildX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ChildY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisY</span><span class="p">;</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="c1">// 下</span>
<span class="w">                    </span><span class="n">ChildX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisX</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ChildY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">                    </span><span class="n">ChildX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ChildY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisY</span><span class="p">;</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ ぷよペアを作成すると軸ぷよと子ぷよが設定される
✅ 初期状態では子ぷよは軸ぷよの上にある
</code></pre></div>
<p>やった！Green になりました。</p>
<h3 id="_28">解説: ぷよペアの実装<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>実装したぷよペアについて解説しておきましょう：</p>
<ol>
<li>
<p><strong>プロパティ</strong>: 軸ぷよと子ぷよの位置（X, Y）と色を持ちます。<code>private set</code> で外部から変更できないようにしています。</p>
</li>
<li>
<p><strong>回転状態</strong>: <code>rotation</code> フィールドで回転状態を管理します。0〜3 の値で、上→右→下→左の順に回転します。</p>
</li>
<li>
<p><strong>子ぷよの位置計算</strong>: <code>UpdateChildPosition</code> メソッドで、回転状態に応じて子ぷよの位置を計算します。</p>
</li>
</ol>
<h3 id="_29">テスト: ぷよペアの回転<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>次に、ぷよペアを回転させる機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PairTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右回転すると子ぷよが時計回りに</span><span class="mi">90</span><span class="err">度回転する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 初期状態: 子ぷよは上 (2, 0)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 右に移動</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildY</span><span class="p">);</span><span class="w"> </span><span class="c1">// 同じ高さ</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右回転を</span><span class="mi">4</span><span class="err">回すると元の位置に戻る</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">();</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">();</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">();</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildY</span><span class="p">);</span><span class="w"> </span><span class="c1">// 元の位置</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左回転すると子ぷよが反時計回りに</span><span class="mi">90</span><span class="err">度回転する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 初期状態: 子ぷよは上 (2, 0)</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">RotateLeft</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 左に移動</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildY</span><span class="p">);</span><span class="w"> </span><span class="c1">// 同じ高さ</span>
<span class="p">}</span>
</code></pre></div>
<p>「回転を 4 回すると元に戻る？」そうです！360 度回転すると元の位置に戻りますからね。このテストで、回転の計算が正しいことを確認できます。</p>
<h3 id="_30">実装: ぷよペアの回転<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p><code>Pair.cs</code> に回転メソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateRight</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateLeft</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="c1">// -1 と同じ（モジュロ演算）</span>
<span class="w">    </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>rotation + 3</code> で左回転？」良い質問ですね！<code>-1 % 4</code> は C# では負の値になることがあるので、<code>+3</code> を使います。これは <code>-1</code> と同じ効果があります（0→3、1→0、2→1、3→2）。</p>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>✅ 右回転すると子ぷよが時計回りに90度回転する
✅ 右回転を4回すると元の位置に戻る
✅ 左回転すると子ぷよが反時計回りに90度回転する
</code></pre></div>
<p>完璧です！</p>
<h3 id="_31">テスト: 衝突判定<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>ぷよペアがボードや他のぷよと重ならないようにチェックする機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// PairTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ボ</span><span class="n">ー</span><span class="err">ド範囲内にある場合は衝突しない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">collision</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">軸ぷよがボ</span><span class="n">ー</span><span class="err">ド範囲外の場合は衝突する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// 軸ぷよが左端外</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">collision</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">子ぷよがボ</span><span class="n">ー</span><span class="err">ド範囲外の場合は衝突する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 子ぷよが左端外</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">collision</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">軸ぷよの位置にぷよがある場合は衝突する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1, 2) に配置</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// 軸ぷよが (2, 1) に配置されようとする</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">collision</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2, 1) は空なので衝突しない</span>

<span class="w">    </span><span class="c1">// 軸ぷよを既存のぷよと同じ位置に</span>
<span class="w">    </span><span class="n">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">collision</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 軸ぷよを (1, 2) に配置しようとする</span>
<span class="w">    </span><span class="n">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">collision</span><span class="p">);</span><span class="w"> </span><span class="c1">// 衝突する</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">子ぷよの位置にぷよがある場合は衝突する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span><span class="w"> </span><span class="c1">// (0, 2) に配置</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 子ぷよが (0, 2)</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">collision</span><span class="p">);</span><span class="w"> </span><span class="c1">// 衝突する</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_32">実装: 衝突判定<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p><code>Pair.cs</code> に衝突判定メソッドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">IsCollision</span><span class="p">(</span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">axisX</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">axisY</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">childX</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">childY</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 軸ぷよの範囲チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="n">axisY</span><span class="p">,</span><span class="w"> </span><span class="n">axisX</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよの範囲チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">board</span><span class="p">.</span><span class="n">IsInBounds</span><span class="p">(</span><span class="n">childY</span><span class="p">,</span><span class="w"> </span><span class="n">childX</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 軸ぷよの位置にぷよがあるかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">axisY</span><span class="p">,</span><span class="w"> </span><span class="n">axisX</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよの位置にぷよがあるかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">childY</span><span class="p">,</span><span class="w"> </span><span class="n">childX</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// 衝突なし</span>
<span class="p">}</span>
</code></pre></div>
<p>「引数で位置を渡すんですね？」そうです！回転後の位置でチェックしたい場合もあるので、引数で位置を指定できるようにしています。</p>
<p>テストを実行：</p>
<div class="highlight"><pre><span></span><code>✅ ボード範囲内にある場合は衝突しない
✅ 軸ぷよがボード範囲外の場合は衝突する
✅ 子ぷよがボード範囲外の場合は衝突する
✅ 軸ぷよの位置にぷよがある場合は衝突する
✅ 子ぷよの位置にぷよがある場合は衝突する
</code></pre></div>
<p>素晴らしい！すべて Green です。</p>
<h3 id="_33">リファクタリング<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>現在のコードを見てみましょう。衝突判定で少し重複がありますね。リファクタリングしてみましょう。</p>
<blockquote>
<p>リファクタリングのタイミング</p>
<p>いつリファクタリングすべきだろうか。テストがグリーンになったときだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>実は、現在のコードは既に十分シンプルで、大きな改善の余地はありません。強いて言えば、衝突チェックを小さなメソッドに分けることもできますが、現時点では可読性が十分なのでそのままにしておきましょう。</p>
<h3 id="2_2">イテレーション 2 のまとめ<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！イテレーション 2 で実装した内容を振り返ってみましょう：</p>
<ol>
<li><strong>Pair クラス</strong>: ぷよペアの実装</li>
<li>軸ぷよと子ぷよの位置と色</li>
<li>回転状態の管理</li>
<li><code>RotateRight()</code>, <code>RotateLeft()</code>: 回転機能</li>
<li><code>IsCollision()</code>: 衝突判定</li>
<li>
<p><code>UpdateChildPosition()</code>: 子ぷよの位置計算</p>
</li>
<li>
<p><strong>テスト</strong>: すべての機能にテストがあり、安心してコードを変更できる状態</p>
</li>
</ol>
<p>ぷよペアができたので、次のイテレーションでは、このペアを実際に動かす機能を実装していきます！</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよペアの実装&#39;</span>
</code></pre></div>
<hr />
<h2 id="3_1">イテレーション 3: 移動と回転<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h2>
<p>「ぷよペアができたので、次はこれを実際に動かしていきたいですね！」そうですね！このイテレーションでは、ぷよペアを左右に移動させたり、下に落としたり、回転させたりする機能を実装していきます。</p>
<h3 id="_34">ユーザーストーリー<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよペアを左右に移動できる</p>
<p>プレイヤーとして、落ちてくるぷよペアを下に移動できる</p>
<p>プレイヤーとして、落ちてくるぷよペアを回転できる</p>
</blockquote>
<p>「移動と回転って、ゲームの基本操作ですよね！」そうです！これらの操作ができるようになると、ぷよぷよらしくなってきます。</p>
<h3 id="todo_2">TODO リスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>左に移動する機能を実装する</li>
<li>右に移動する機能を実装する</li>
<li>下に移動する機能を実装する</li>
<li>移動時の衝突判定を実装する</li>
<li>回転時の壁キック機能を実装する</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_35">テスト: 左右への移動<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよペアが左右に移動できることをテストしていきましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/PairTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよペアは左に移動できる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">MoveLeft</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよペアは右に移動できる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">MoveRight</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左端では左に移動できない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">MoveLeft</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert - 位置が変わっていないことを確認</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右端では右に移動できない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">MoveRight</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert - 位置が変わっていないことを確認</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の4つのケースを確認しています：</p>
<ol>
<li>ぷよペアが左に移動できるか</li>
<li>ぷよペアが右に移動できるか</li>
<li>左端では左に移動できないか（境界チェック）</li>
<li>右端では右に移動できないか（境界チェック）</li>
</ol>
<p>「境界チェックって重要なんですね！」そうです！ゲームでは、プレイヤーが画面の外に行かないようにする必要があります。これを怠ると、バグの原因になってしまうんですよ。</p>
<h3 id="_36">実装: 左右への移動<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実装しましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>undefined: Pair.MoveLeft
undefined: Pair.MoveRight
</code></pre></div>
<p>おっと！<code>MoveLeft</code>と<code>MoveRight</code>がまだ定義されていませんね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<blockquote>
<p>明白な実装</p>
<p>シンプルな操作をどう実装すればいいだろうか。ただ実装すればいいのだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストを通すための実装を書いていきましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Pair.cs に追加</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveLeft</span><span class="p">(</span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 左に移動できるかチェック</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newChildX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChildX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">newAxisX</span><span class="p">,</span><span class="w"> </span><span class="n">AxisY</span><span class="p">,</span><span class="w"> </span><span class="n">newChildX</span><span class="p">,</span><span class="w"> </span><span class="n">ChildY</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisX</span><span class="p">;</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveRight</span><span class="p">(</span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 右に移動できるかチェック</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newAxisX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newChildX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChildX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">newAxisX</span><span class="p">,</span><span class="w"> </span><span class="n">AxisY</span><span class="p">,</span><span class="w"> </span><span class="n">newChildX</span><span class="p">,</span><span class="w"> </span><span class="n">ChildY</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisX</span><span class="p">;</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、<code>IsCollision</code>を使って移動できるかチェックするんですね！」そうです。移動先の座標で衝突判定を行い、衝突しない場合のみ移動します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ ぷよペアは左に移動できる
✅ ぷよペアは右に移動できる
✅ 左端では左に移動できない
✅ 右端では右に移動できない
</code></pre></div>
<p>やった！テストが通りました。これが「Green（緑）」の状態です。</p>
<h3 id="_37">テスト: 下への移動<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>次は、下に移動する機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/PairTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよペアは下に移動できる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">下にぷよがある場合は下に移動できない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span><span class="w"> </span><span class="c1">// 下にぷよを配置</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert - 位置が変わっていないことを確認</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">下に移動できるかチェックできる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">canMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">canMove</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">下にぷよがある場合は移動できないと判定される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">canMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">canMove</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>CanMoveDown</code>メソッドも追加したんですね！」そうです。後でゲームロジックを実装するときに、「下に移動できるか」を確認する必要があるので、そのためのメソッドを用意しておきます。</p>
<h3 id="_38">実装: 下への移動<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Pair.cs に追加</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">MoveDown</span><span class="p">(</span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newAxisY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newChildY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChildY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">AxisX</span><span class="p">,</span><span class="w"> </span><span class="n">newAxisY</span><span class="p">,</span><span class="w"> </span><span class="n">ChildX</span><span class="p">,</span><span class="w"> </span><span class="n">newChildY</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newAxisY</span><span class="p">;</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CanMoveDown</span><span class="p">(</span><span class="n">Board</span><span class="w"> </span><span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 下に移動できるかチェック</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newAxisY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AxisY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newChildY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChildY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">board</span><span class="p">,</span><span class="w"> </span><span class="n">AxisX</span><span class="p">,</span><span class="w"> </span><span class="n">newAxisY</span><span class="p">,</span><span class="w"> </span><span class="n">ChildX</span><span class="p">,</span><span class="w"> </span><span class="n">newChildY</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ ぷよペアは下に移動できる
✅ 下にぷよがある場合は下に移動できない
✅ 下に移動できるかチェックできる
✅ 下にぷよがある場合は移動できないと判定される
</code></pre></div>
<p>素晴らしい！すべてのテストが通りました。</p>
<h3 id="_39">テスト: 壁キック機能<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>「壁キック機能って何ですか？」良い質問ですね！壁キックとは、壁際でぷよペアを回転させたとき、壁にめり込んでしまう場合に、自動的に少し位置をずらして回転を可能にする機能です。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/PairTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">右端で右回転すると壁キックで左に移動する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// rotation = 0（子ぷよが上）</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">RotateRight</span><span class="p">();</span><span class="w"> </span><span class="c1">// rotation = 1（子ぷよが右）になるはず</span>

<span class="w">    </span><span class="c1">// Assert - 壁キックで左に移動している</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 子ぷよは右隣</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">左端で左回転すると壁キックで右に移動する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// rotation = 0（子ぷよが上）</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">pair</span><span class="p">.</span><span class="n">RotateLeft</span><span class="p">();</span><span class="w"> </span><span class="c1">// rotation = 3（子ぷよが左）になるはず</span>

<span class="w">    </span><span class="c1">// Assert - 壁キックで右に移動している</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">);</span><span class="w"> </span><span class="c1">// 子ぷよは左隣</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>右端で時計回りに回転すると、壁キックで左に1マス移動して回転するか</li>
<li>左端で反時計回りに回転すると、壁キックで右に1マス移動して回転するか</li>
</ol>
<h3 id="_40">実装: 壁キック機能<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>現在の<code>RotateRight</code>と<code>RotateLeft</code>メソッドを壁キック機能に対応させましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Pair.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateRight</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">UpdateChildPosition</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 壁キックのチェック</span>
<span class="w">    </span><span class="c1">// 回転後、子ぷよが画面外に出る場合は軸ぷよを調整</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">ChildX</span><span class="p">;</span><span class="w"> </span><span class="c1">// 右に移動</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">COLS</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">COLS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 左に移動</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateLeft</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="c1">// -1 と同じ（モジュロ演算）</span>
<span class="w">    </span><span class="n">UpdateChildPosition</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 壁キックのチェック</span>
<span class="w">    </span><span class="c1">// 回転後、子ぷよが画面外に出る場合は軸ぷよを調整</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">ChildX</span><span class="p">;</span><span class="w"> </span><span class="c1">// 右に移動</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">COLS</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">COLS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 左に移動</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、回転後に子ぷよの位置をチェックして、画面外に出ていたら軸ぷよを移動させるんですね！」そうです。これにより、プレイヤーが壁際でも回転できるようになり、操作性が向上します。</p>
<p>しかし、ここで問題があります。<code>Board.COLS</code>という定数にアクセスしていますが、これは外部から参照できるようにする必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Board.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Board</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">COLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ROWS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">[,]</span><span class="w"> </span><span class="n">cells</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Cols</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">COLS</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Rows</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ROWS</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 以下省略...</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>const</code>を<code>public</code>にしたんですね！」そうです。これで<code>Pair</code>クラスから<code>Board.COLS</code>にアクセスできるようになります。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ 右端で右回転すると壁キックで左に移動する
✅ 左端で左回転すると壁キックで右に移動する
</code></pre></div>
<p>やった！壁キック機能が実装できました！</p>
<h3 id="_41">リファクタリング<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>テストが通ったので、リファクタリングの機会を探しましょう。<code>RotateRight</code>と<code>RotateLeft</code>で壁キックのロジックが重複していますね。これを共通化してみましょう。</p>
<blockquote>
<p>リファクタリングのタイミング</p>
<p>いつリファクタリングすべきだろうか。テストがグリーンになったときだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Pair.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateRight</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="n">ApplyWallKick</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RotateLeft</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rotation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="c1">// -1 と同じ（モジュロ演算）</span>
<span class="w">    </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="n">ApplyWallKick</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ApplyWallKick</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 壁キックのチェック</span>
<span class="w">    </span><span class="c1">// 回転後、子ぷよが画面外に出る場合は軸ぷよを調整</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">ChildX</span><span class="p">;</span><span class="w"> </span><span class="c1">// 右に移動</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">COLS</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AxisX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">(</span><span class="n">ChildX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">COLS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 左に移動</span>
<span class="w">        </span><span class="n">UpdateChildPosition</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「重複が排除されてスッキリしましたね！」そうですね。<code>ApplyWallKick</code>という名前のメソッドにすることで、何をしているのかも明確になりました。</p>
<p>テストを実行して、リファクタリングが正しく行われたか確認しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>All tests passed!
</code></pre></div>
<p>素晴らしい！すべてのテストが通りました。</p>
<h3 id="3_2">イテレーション 3 のまとめ<a class="headerlink" href="#3_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！イテレーション 3 で実装した内容を振り返ってみましょう：</p>
<ol>
<li><strong>左右への移動機能</strong></li>
<li><code>MoveLeft()</code>: 左に移動</li>
<li><code>MoveRight()</code>: 右に移動</li>
<li>
<p>衝突判定により、画面外や他のぷよにぶつかる場合は移動しない</p>
</li>
<li>
<p><strong>下への移動機能</strong></p>
</li>
<li><code>MoveDown()</code>: 下に移動</li>
<li><code>CanMoveDown()</code>: 下に移動できるかチェック</li>
<li>
<p>着地判定に使用</p>
</li>
<li>
<p><strong>壁キック機能</strong></p>
</li>
<li><code>ApplyWallKick()</code>: 回転後に壁にめり込む場合は自動で位置を調整</li>
<li>
<p>操作性の向上</p>
</li>
<li>
<p><strong>Board クラスの改善</strong></p>
</li>
<li>
<p><code>COLS</code>と<code>ROWS</code>を<code>public const</code>にして外部から参照可能に</p>
</li>
<li>
<p><strong>テスト</strong>: 11 個の新しいテストを追加</p>
</li>
<li>左右移動のテスト（4 テスト）</li>
<li>下移動のテスト（4 テスト）</li>
<li>
<p>壁キックのテスト（2 テスト）</p>
</li>
<li>
<p><strong>リファクタリング</strong>: 壁キックロジックの共通化</p>
</li>
</ol>
<p>これで、ぷよペアを自由に操作できるようになりました！次のイテレーションでは、ぷよペアを自動的に落下させる機能を実装していきます。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 移動と回転機能を実装</span>

<span class="s1">- 左右への移動機能</span>
<span class="s1">- 下への移動機能とCanMoveDownチェック</span>
<span class="s1">- 壁キック機能の実装</span>
<span class="s1">- 11個のテストケースを追加&#39;</span>
</code></pre></div>
<hr />
<h2 id="4_1">イテレーション 4: ぷよの自動落下<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h2>
<p>「移動と回転ができるようになりましたが、ぷよぷよって自動で落ちてきますよね？」そうですね！ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきます。今回は、その「自動落下」機能を実装していきましょう！</p>
<h3 id="_42">ユーザーストーリー<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとして、ぷよペアを自動的に落下させることができる</p>
</blockquote>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_3">TODO リスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>Game クラスを作成する</li>
<li>落下タイマーの実装（一定時間ごとに落下処理を実行する仕組み）</li>
<li>自動落下処理の実装（タイマーが発火したときにぷよペアを1マス下に移動する）</li>
<li>着地処理の実装（ぷよペアが着地したときにボードに固定する）</li>
<li>重力処理の実装（着地後、浮いているぷよが落下する）</li>
</ul>
<p>「順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="game">テスト: Game クラスの基本<a class="headerlink" href="#game" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲーム全体を管理する <code>Game</code> クラスを作成し、基本的な機能をテストしましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/GameTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">NUnit.Framework</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GameTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="n">game</span><span class="p">;</span>

<span class="w">    </span><span class="na">[SetUp]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetUp</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Test]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ゲ</span><span class="n">ー</span><span class="err">ムが初期化される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Test]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">初期状態では現在のぷよペアが存在する</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="game_1">実装: Game クラスの基本<a class="headerlink" href="#game_1" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">Pair</span><span class="w"> </span><span class="n">CurrentPair</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="p">;</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SPAWN_X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 出現位置 X</span>
<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SPAWN_Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 出現位置 Y</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">Game</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">            </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<span class="w">            </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SpawnNewPair</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">axisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetRandomColor</span><span class="p">();</span>
<span class="w">            </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">childColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetRandomColor</span><span class="p">();</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">SPAWN_X</span><span class="p">,</span><span class="w"> </span><span class="n">SPAWN_Y</span><span class="p">,</span><span class="w"> </span><span class="n">axisColor</span><span class="p">,</span><span class="w"> </span><span class="n">childColor</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="n">PuyoColor</span><span class="w"> </span><span class="nf">GetRandomColor</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 1〜4 のランダムな色を返す（None を除く）</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">colorIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">)</span><span class="n">colorIndex</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ ゲームが初期化される
✅ 初期状態では現在のぷよペアが存在する
</code></pre></div>
<p>やった！テストが通りました。</p>
<h3 id="_43">テスト: 自動落下タイマー<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>次は、一定時間ごとに落下処理が実行される仕組みをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/GameTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">一定時間経過するとぷよペアが下に移動する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">fallInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1秒</span>

<span class="w">    </span><span class="c1">// Act - 1秒分の更新を実行</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">fallInterval</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">時間が経過していないとぷよペアは移動しない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">halfInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0.5秒</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">halfInterval</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">initialY</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_44">実装: 自動落下タイマー<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs に追加</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0f</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">FALL_INTERVAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1秒ごとに落下</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fallTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">FALL_INTERVAL</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ぷよペアを1マス下に移動</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">Board</span><span class="p">);</span>
<span class="w">            </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0f</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、<code>deltaTime</code>で経過時間を蓄積して、一定間隔を超えたら落下させるんですね！」そうです。この実装では、以下のことを行っています：</p>
<ol>
<li><code>fallTimer</code> でタイマーを管理</li>
<li><code>Update()</code> メソッドで経過時間を加算</li>
<li>一定間隔（<code>FALL_INTERVAL</code>）を超えたら <code>MoveDown()</code> を実行</li>
<li>タイマーをリセット</li>
</ol>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ 一定時間経過するとぷよペアが下に移動する
✅ 時間が経過していないとぷよペアは移動しない
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="_45">テスト: 着地処理<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>「ぷよペアが下に移動できなくなったらどうなりますか？」良い質問ですね！ぷよペアが着地したら、ボードに固定する必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/GameTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよペアが着地するとボ</span><span class="n">ー</span><span class="err">ドに固定される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange - ぷよペアを下端の1つ上に配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">ROWS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act - 落下させる</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">1.0f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert - ボードにぷよが配置されている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">Board</span><span class="p">.</span><span class="n">ROWS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよペアが着地すると新しいぷよペアが生成される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange - ぷよペアを下端の1つ上に配置</span>
<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">oldPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">ROWS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act - 落下させる</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">1.0f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert - 新しいぷよペアが生成されている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreNotSame</span><span class="p">(</span><span class="n">oldPair</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_46">実装: 着地処理<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fallTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">FALL_INTERVAL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ぷよペアが下に移動できるかチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">Board</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">Board</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 着地したのでボードに固定</span>
<span class="w">            </span><span class="n">FixPairToBoard</span><span class="p">();</span>
<span class="w">            </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">            </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">FixPairToBoard</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 軸ぷよをボードに配置</span>
<span class="w">    </span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisColor</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 子ぷよをボードに配置</span>
<span class="w">    </span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">ChildY</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">,</span><span class="w"> </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">ChildColor</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ ぷよペアが着地するとボードに固定される
✅ ぷよペアが着地すると新しいぷよペアが生成される
</code></pre></div>
<p>やった！着地処理が実装できました！</p>
<h3 id="_47">テスト: 重力処理<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>「着地したぷよの上にぷよがあったらどうなりますか？」良い質問ですね！着地後、浮いているぷよは重力で下に落ちる必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/BoardTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">浮いているぷよが重力で落ちる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span><span class="w"> </span><span class="c1">// 最下段にぷよ</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span><span class="w">  </span><span class="c1">// 浮いているぷよ</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">ApplyGravity</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert - 浮いているぷよが1マス落ちている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">複数の浮いているぷよが重力で落ちる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span><span class="w">   </span><span class="c1">// 最下段</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span><span class="w">   </span><span class="c1">// 浮いているぷよ</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span><span class="w"> </span><span class="c1">// 最下段</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="p">);</span><span class="w"> </span><span class="c1">// 浮いているぷよ</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">ApplyGravity</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Yellow</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">浮いているぷよがない場合は何も変化しない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasFloating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">ApplyGravity</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">hasFloating</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_48">実装: 重力処理<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Board.cs に追加</span>
<span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ApplyGravity</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// フィールドのコピーを作成（移動前の状態を保存）</span>
<span class="w">    </span><span class="n">PuyoColor</span><span class="p">[,]</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">[</span><span class="n">ROWS</span><span class="p">,</span><span class="w"> </span><span class="n">COLS</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ROWS</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COLS</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">original</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasFloating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 下から上に向かって各列をスキャン（列ごとに処理）</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COLS</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROWS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">--</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 元のフィールドで下に空きがあるかチェック</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">original</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 1マス下に移動</span>
<span class="w">                    </span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">;</span>
<span class="w">                    </span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
<span class="w">                    </span><span class="n">hasFloating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">hasFloating</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、フィールドのコピーを作って、元の状態を参照しながら1マスずつ落とすんですね！」そうです。コピーを作ることで、複数のぷよが同時に落ちるときに正しく処理できます。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ 浮いているぷよが重力で落ちる
✅ 複数の浮いているぷよが重力で落ちる
✅ 浮いているぷよがない場合は何も変化しない
</code></pre></div>
<p>素晴らしい！重力処理が実装できました。</p>
<h3 id="_49">ゲームモードの導入<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>「着地した後、重力処理を繰り返して浮いているぷよがなくなるまで処理する必要がありますね？」鋭い指摘です！ゲームの状態を管理するために、ゲームモードを導入しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">GameMode</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Playing</span><span class="p">,</span><span class="w">    </span><span class="c1">// ぷよペア操作中</span>
<span class="w">    </span><span class="n">Falling</span><span class="p">,</span><span class="w">    </span><span class="c1">// 重力処理中</span>
<span class="w">    </span><span class="n">Checking</span><span class="w">    </span><span class="c1">// 消去チェック中（後で実装）</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">GameMode</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">Game</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">        </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">:</span>
<span class="w">                </span><span class="n">UpdatePlaying</span><span class="p">(</span><span class="n">deltaTime</span><span class="p">);</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>

<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">:</span>
<span class="w">                </span><span class="n">UpdateFalling</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdatePlaying</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fallTimer</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">FALL_INTERVAL</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">Board</span><span class="p">))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">(</span><span class="n">Board</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 着地したのでボードに固定</span>
<span class="w">                </span><span class="n">FixPairToBoard</span><span class="p">();</span>
<span class="w">                </span><span class="c1">// 重力処理モードに移行</span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0f</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateFalling</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 重力を適用</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasFloating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">ApplyGravity</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasFloating</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 浮いているぷよがなくなったら新しいぷよペアを生成</span>
<span class="w">            </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームモードで状態を管理することで、処理の流れが明確になりますね！」そうです。<code>Playing</code> → 着地 → <code>Falling</code> → 重力処理完了 → <code>Playing</code> というサイクルが実現できました。</p>
<h3 id="4_2">イテレーション 4 のまとめ<a class="headerlink" href="#4_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！イテレーション 4 で実装した内容を振り返ってみましょう：</p>
<ol>
<li><strong>Game クラスの作成</strong></li>
<li>ゲーム全体を管理するクラス</li>
<li><code>Board</code> と <code>CurrentPair</code> を保持</li>
<li>
<p>ランダムな色のぷよペアを生成</p>
</li>
<li>
<p><strong>自動落下タイマー</strong></p>
</li>
<li><code>fallTimer</code> と <code>FALL_INTERVAL</code> でタイミング管理</li>
<li><code>Update()</code> メソッドで経過時間を加算</li>
<li>
<p>1 秒間隔で 1 マスずつ落下</p>
</li>
<li>
<p><strong>着地処理</strong></p>
</li>
<li><code>FixPairToBoard()</code>: ぷよペアをボードに固定</li>
<li>軸ぷよと子ぷよを両方配置</li>
<li>
<p>着地後は新しいぷよペアを生成</p>
</li>
<li>
<p><strong>重力処理</strong></p>
</li>
<li><code>Board.ApplyGravity()</code>: 浮いているぷよを 1 マスずつ落とす</li>
<li>フィールドのコピーを作成して安全に処理</li>
<li>
<p>落下したぷよがあるかどうかを返す</p>
</li>
<li>
<p><strong>ゲームモードの導入</strong></p>
</li>
<li><code>GameMode</code> enum: <code>Playing</code>, <code>Falling</code>, <code>Checking</code></li>
<li>状態に応じた処理の切り替え</li>
<li>
<p><code>Playing</code> → 着地 → <code>Falling</code> → <code>Playing</code> のサイクル</p>
</li>
<li>
<p><strong>テスト</strong>: 10 個の新しいテストを追加</p>
</li>
<li>Game クラスの初期化テスト（2 テスト）</li>
<li>自動落下タイマーのテスト（2 テスト）</li>
<li>着地処理のテスト（2 テスト）</li>
<li>重力処理のテスト（3 テスト）</li>
</ol>
<p>これで、ぷよペアが自動的に落下し、着地後に浮いているぷよも落ちてくるようになりました！次のイテレーションでは、ぷよの消去判定を実装していきます。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの自動落下を実装</span>

<span class="s1">- Game クラスの作成とぷよペア生成</span>
<span class="s1">- 自動落下タイマーの実装</span>
<span class="s1">- 着地処理とボードへの固定</span>
<span class="s1">- 重力処理の実装</span>
<span class="s1">- ゲームモードによる状態管理</span>
<span class="s1">- 10個のテストケースを追加&#39;</span>
</code></pre></div>
<hr />
<h2 id="5_1">イテレーション 5: ぷよの消去判定<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを 4 つ以上つなげると消去できる機能です。今回は、その「ぷよの消去判定」機能を実装していきましょう！</p>
<h3 id="_50">ユーザーストーリー<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを 4 つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを 4 つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。</p>
<h3 id="todo_4">TODO リスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li>4 つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li>ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li>消去後の重力処理と統合する</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_51">テスト: ぷよの接続判定<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、同じ色のぷよが 4 つ以上つながっているかどうかを判定する機能をテストしましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/BoardTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">同じ色のぷよが</span><span class="mi">4</span><span class="err">つ縦につながっていると消去対象になる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 縦に4つ赤ぷよを配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert - 4つのぷよが消去対象になっている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">同じ色のぷよが</span><span class="mi">4</span><span class="err">つ横につながっていると消去対象になる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 横に4つ青ぷよを配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert - 4つのぷよが消去対象になっている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">同じ色のぷよが</span><span class="mi">3</span><span class="err">つ以下だと消去対象にならない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 縦に3つ赤ぷよを配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert - 消去対象がない</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">異なる色のぷよは消去対象にならない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert - 消去対象がない</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">L</span><span class="err">字型につながった</span><span class="mi">4</span><span class="err">つのぷよも消去対象になる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// L字型に配置</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Green</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert - 4つのぷよが消去対象になっている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の 5 つのケースを確認しています：</p>
<ol>
<li>縦に 4 つつながっている場合は消去対象になるか</li>
<li>横に 4 つつながっている場合は消去対象になるか</li>
<li>3 つ以下の場合は消去対象にならないか</li>
<li>異なる色が混ざっている場合は消去対象にならないか</li>
<li>L 字型のような形でも 4 つつながっていれば消去対象になるか</li>
</ol>
<p>「なるほど、いろいろなパターンをテストするんですね！」そうです。では、このテストが通るように実装していきましょう。</p>
<h3 id="_52">実装: ぷよの接続判定<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実装しましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>undefined: Board.CheckErase
</code></pre></div>
<p>おっと！<code>CheckErase</code> がまだ定義されていませんね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<p>接続判定には「深さ優先探索（DFS: Depth-First Search）」アルゴリズムを使用します。</p>
<blockquote>
<p>明白な実装</p>
<p>シンプルな操作をどう実装すればいいだろうか。ただ実装すればいいのだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Board.cs に追加</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Board</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CheckErase</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">erasePositions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="kt">bool</span><span class="p">[,]</span><span class="w"> </span><span class="k">checked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">bool</span><span class="p">[</span><span class="n">ROWS</span><span class="p">,</span><span class="w"> </span><span class="n">COLS</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// 全マスをチェック</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ROWS</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COLS</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// ぷよがあり、まだチェックしていない場合</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="k">checked</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">])</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 接続しているぷよを探索</span>
<span class="w">                    </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
<span class="w">                    </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">                    </span><span class="n">SearchConnectedPuyo</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="k">checked</span><span class="p">,</span><span class="w"> </span><span class="n">connected</span><span class="p">);</span>

<span class="w">                    </span><span class="c1">// 4つ以上つながっている場合は消去対象</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connected</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="n">erasePositions</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="n">connected</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">erasePositions</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SearchConnectedPuyo</span><span class="p">(</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span>
<span class="w">        </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">color</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="p">[,]</span><span class="w"> </span><span class="k">checked</span><span class="p">,</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">connected</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 探索済みにする</span>
<span class="w">        </span><span class="k">checked</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">connected</span><span class="p">.</span><span class="n">Add</span><span class="p">((</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// 4方向を探索（上下左右）</span>
<span class="w">        </span><span class="kt">int</span><span class="p">[]</span><span class="w"> </span><span class="n">dRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kt">int</span><span class="p">[]</span><span class="w"> </span><span class="n">dCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">};</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">nextRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dRow</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">nextCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dCol</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">            </span><span class="c1">// ボード内かつ同じ色のぷよがあり、まだチェックしていない場合</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsInBounds</span><span class="p">(</span><span class="n">nextRow</span><span class="p">,</span><span class="w"> </span><span class="n">nextCol</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">cells</span><span class="p">[</span><span class="n">nextRow</span><span class="p">,</span><span class="w"> </span><span class="n">nextCol</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="o">!</span><span class="k">checked</span><span class="p">[</span><span class="n">nextRow</span><span class="p">,</span><span class="w"> </span><span class="n">nextCol</span><span class="p">])</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 再帰的に探索</span>
<span class="w">                </span><span class="n">SearchConnectedPuyo</span><span class="p">(</span><span class="n">nextRow</span><span class="p">,</span><span class="w"> </span><span class="n">nextCol</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="k">checked</span><span class="p">,</span><span class="w"> </span><span class="n">connected</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「深さ優先探索って何ですか？」良い質問ですね！深さ優先探索（DFS）は、グラフや木構造を探索するアルゴリズムです。あるノードから始めて、可能な限り深く進み、行き止まりになったら戻って別の道を探索します。</p>
<p>この実装では、以下のことを行っています：</p>
<ol>
<li>ボード上の全マスを順番にチェック</li>
<li>まだチェックしていないぷよがある場合、そのぷよと同じ色で接続しているぷよを <code>SearchConnectedPuyo</code> で探索</li>
<li>接続しているぷよが 4 つ以上ある場合、それらを消去対象として記録</li>
</ol>
<p><code>SearchConnectedPuyo</code> メソッドでは、再帰的に隣接する同じ色のぷよを探索していきます。探索済みのぷよは <code>checked</code> 配列でマークし、重複してカウントしないようにしています。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ 同じ色のぷよが4つ縦につながっていると消去対象になる
✅ 同じ色のぷよが4つ横につながっていると消去対象になる
✅ 同じ色のぷよが3つ以下だと消去対象にならない
✅ 異なる色のぷよは消去対象にならない
✅ L字型につながった4つのぷよも消去対象になる
</code></pre></div>
<p>やった！テストが通りました。これが「Green（緑）」の状態です。</p>
<h3 id="_53">テスト: ぷよの消去<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>次は、消去対象のぷよを実際に消す機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/BoardTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">消去対象のぷよを消去できる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Erase</span><span class="p">(</span><span class="n">positions</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert - ぷよが消去されている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_54">実装: ぷよの消去<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Board.cs に追加</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Erase</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">positions</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">positions</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">cells</span><span class="p">[</span><span class="n">pos</span><span class="p">.</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。消去処理自体は、指定された位置のぷよを <code>None</code> にするだけです。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ 消去対象のぷよを消去できる
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="_55">ゲームモードへの統合<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>「消去判定ができたので、ゲームに組み込みましょう！」そうですね。<code>Game</code> クラスに消去チェックのモードを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">GameMode</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Playing</span><span class="p">,</span><span class="w">    </span><span class="c1">// ぷよペア操作中</span>
<span class="w">    </span><span class="n">Falling</span><span class="p">,</span><span class="w">    </span><span class="c1">// 重力処理中</span>
<span class="w">    </span><span class="n">Checking</span><span class="w">    </span><span class="c1">// 消去チェック中</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdatePlaying</span><span class="p">(</span><span class="n">deltaTime</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateFalling</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateChecking</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateFalling</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 重力を適用</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasFloating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">ApplyGravity</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasFloating</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 浮いているぷよがなくなったら消去チェックへ</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateChecking</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がある場合、消去して重力処理へ</span>
<span class="w">        </span><span class="n">Board</span><span class="p">.</span><span class="n">Erase</span><span class="p">(</span><span class="n">positions</span><span class="p">);</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、新しいぷよペアを生成</span>
<span class="w">        </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームの流れがどう変わったんですか？」良い質問ですね！ゲームフローは以下のように拡張されました：</p>
<p><strong>新しいゲームフロー</strong>:
<div class="highlight"><pre><span></span><code>Playing → 着地 → Falling → 重力適用 →
  ├─ 浮いているぷよあり → Falling（繰り返し）
  └─ 浮いているぷよなし → Checking → 消去判定 →
      ├─ 消去あり → 消去実行 → Falling（重力適用）
      └─ 消去なし → Playing（新しいぷよペア生成）
</code></pre></div></p>
<p>このフローにより、以下が実現されます：</p>
<ol>
<li><strong>着地後の重力適用</strong>: ぷよペアが着地したら、まず重力を適用して浮いているぷよを落とす</li>
<li><strong>消去判定</strong>: 重力適用後、落下するぷよがなくなったら消去判定</li>
<li><strong>消去処理</strong>: 4 つ以上つながったぷよがあれば消去</li>
<li><strong>消去後の重力適用</strong>: 消去後、再び重力を適用（これが連鎖の基礎になる）</li>
</ol>
<h3 id="5_2">イテレーション 5 のまとめ<a class="headerlink" href="#5_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！イテレーション 5 で実装した内容を振り返ってみましょう：</p>
<ol>
<li><strong>接続判定機能</strong></li>
<li><code>CheckErase()</code>: 4 つ以上つながったぷよを検出</li>
<li><code>SearchConnectedPuyo()</code>: 深さ優先探索で接続ぷよを探索</li>
<li>
<p>再帰的な探索処理</p>
</li>
<li>
<p><strong>消去処理機能</strong></p>
</li>
<li>
<p><code>Erase()</code>: 消去対象のぷよを削除</p>
</li>
<li>
<p><strong>ゲームモードの拡張</strong></p>
</li>
<li><code>GameMode.Checking</code>: 消去判定を実行</li>
<li>
<p>ゲームフローの拡張：着地 → 重力 → 消去 → 重力 → 次のぷよ</p>
</li>
<li>
<p><strong>テスト</strong>: 6 個の新しいテストを追加</p>
</li>
<li>縦に 4 つつながったぷよの消去判定</li>
<li>横に 4 つつながったぷよの消去判定</li>
<li>3 つ以下のぷよは消去されない</li>
<li>異なる色のぷよは消去されない</li>
<li>L 字型につながったぷよの消去判定</li>
<li>
<p>消去処理の実行</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>深さ優先探索（DFS）アルゴリズム</li>
<li>再帰的な探索処理</li>
<li>ゲームモードによる状態管理</li>
<li>消去と重力の連携処理</li>
</ol>
<p>これで、同じ色のぷよを 4 つ以上つなげると消去できるようになりました！次のイテレーションでは、連鎖反応とスコア機能を実装していきます。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの消去判定を実装</span>

<span class="s1">- 深さ優先探索による接続判定</span>
<span class="s1">- 4つ以上つながったぷよの検出</span>
<span class="s1">- 消去処理の実装</span>
<span class="s1">- ゲームモードへの統合（Checking モード）</span>
<span class="s1">- 6個のテストケースを追加&#39;</span>
</code></pre></div>
<hr />
<h2 id="6_1">イテレーション 6: 連鎖反応とスコア<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」と、それに応じた「スコア」を実装していきましょう！</p>
<h3 id="_56">ユーザーストーリー<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="todo_5">TODO リスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>スコアクラスを作成する</li>
<li>連鎖カウントを実装する（何連鎖目かをカウントする）</li>
<li>連鎖ボーナスの計算を実装する（連鎖数に応じたボーナス点を計算する）</li>
<li>消去時のスコア加算を実装する</li>
<li>連鎖が終了したときの処理を実装する</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_57">テスト: スコアクラス<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、スコアを管理する <code>Score</code> クラスを作成し、基本的な機能をテストしましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/ScoreTest.cs</span>
<span class="k">using</span><span class="w"> </span><span class="nn">NUnit.Framework</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ScoreTest</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="n">score</span><span class="p">;</span>

<span class="w">    </span><span class="na">[SetUp]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SetUp</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Test]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">スコアが初期化される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Total</span><span class="p">);</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Test]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖数をインクリメントできる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Test]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖数をリセットできる</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">ResetChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Assert</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Test]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよ消去時にスコアが加算される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">puyoCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">puyoCount</span><span class="p">,</span><span class="w"> </span><span class="n">chain</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert - 基本スコア = 消した数 × 10</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Total</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="na">[Test]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">連鎖数に応じてボ</span><span class="n">ー</span><span class="err">ナスが加算される</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Arrange</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">puyoCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Act - 1連鎖目</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">puyoCount</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">score1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Total</span><span class="p">;</span><span class="w"> </span><span class="c1">// 4 × 10 × 1 = 40</span>

<span class="w">        </span><span class="c1">// 2連鎖目</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>
<span class="w">        </span><span class="n">score</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">puyoCount</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Assert - 2連鎖目のボーナス倍率は2倍</span>
<span class="w">        </span><span class="c1">// 1連鎖: 4 × 10 × 1 = 40</span>
<span class="w">        </span><span class="c1">// 2連鎖: 4 × 10 × 2 = 80</span>
<span class="w">        </span><span class="c1">// 合計: 120</span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Total</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_58">実装: スコアクラス<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Score.cs</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">PuyoPuyo.Core</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Score</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Chain</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">Score</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">IncrementChain</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Chain</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ResetChain</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Add</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">puyoCount</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 基本スコア = 消した数 × 10</span>
<span class="w">            </span><span class="c1">// 連鎖ボーナス = 連鎖数</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">baseScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">puyoCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">chainBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">;</span>

<span class="w">            </span><span class="n">Total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">baseScore</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chainBonus</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ スコアが初期化される
✅ 連鎖数をインクリメントできる
✅ 連鎖数をリセットできる
✅ ぷよ消去時にスコアが加算される
✅ 連鎖数に応じてボーナスが加算される
</code></pre></div>
<p>やった！テストが通りました。</p>
<h3 id="_59">ゲームへの統合<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>「スコアクラスができたので、ゲームに組み込みましょう！」そうですね。<code>Game</code> クラスにスコア管理機能を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="n">Board</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Pair</span><span class="w"> </span><span class="n">CurrentPair</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">GameMode</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="n">Score</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">Game</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">        </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>
<span class="w">        </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateChecking</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 連鎖数をインクリメント</span>
<span class="w">            </span><span class="n">Score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// スコアを加算</span>
<span class="w">            </span><span class="n">Score</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 消去対象がある場合、消去して重力処理へ</span>
<span class="w">            </span><span class="n">Board</span><span class="p">.</span><span class="n">Erase</span><span class="p">(</span><span class="n">positions</span><span class="p">);</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 消去対象がない場合、連鎖終了</span>
<span class="w">            </span><span class="n">Score</span><span class="p">.</span><span class="n">ResetChain</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">            </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、消去判定で消去対象が見つかったときに連鎖数をインクリメントして、スコアを加算するんですね！」そうです。この実装では、以下のことを行っています：</p>
<ol>
<li>消去対象が見つかったら連鎖数をインクリメント</li>
<li>消去したぷよの数と連鎖数に応じてスコアを加算</li>
<li>消去後、重力処理モードへ移行（ここで連鎖が発生する可能性がある）</li>
<li>消去対象がない場合は連鎖終了、連鎖数をリセット</li>
</ol>
<h3 id="_60">テスト: 連鎖反応<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>「連鎖が本当に動作するかテストしたいです！」いいですね！連鎖反応をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/GameTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ぷよの消去と落下後に新たな消去パタ</span><span class="n">ー</span><span class="err">ンがあれば連鎖が発生する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange - 連鎖するパターンを配置</span>
<span class="w">    </span><span class="c1">// 下に赤ぷよ4つ（横一列）</span>
<span class="w">    </span><span class="c1">// その上に青ぷよが縦に3つ</span>
<span class="w">    </span><span class="c1">// 青ぷよの隣に青ぷよ1つ</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Blue</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act - ゲームの更新処理を実行（消去→重力→消去）</span>
<span class="w">    </span><span class="c1">// 1. 赤ぷよが消去される（1連鎖）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">0f</span><span class="p">);</span><span class="w"> </span><span class="c1">// Checking -&gt; Falling</span>

<span class="w">    </span><span class="c1">// 2. 重力適用（青ぷよが落下）</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">0f</span><span class="p">);</span><span class="w"> </span><span class="c1">// Falling -&gt; Checking</span>

<span class="w">    </span><span class="c1">// 3. 青ぷよが消去される（2連鎖）</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">chainBefore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">Chain</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">0f</span><span class="p">);</span><span class="w"> </span><span class="c1">// Checking -&gt; Falling</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">chainBefore</span><span class="p">);</span><span class="w"> </span><span class="c1">// 2連鎖まで到達</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">Greater</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">Total</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">);</span><span class="w"> </span><span class="c1">// スコアが加算されている</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ ぷよの消去と落下後に新たな消去パターンがあれば連鎖が発生する
</code></pre></div>
<p>素晴らしい！連鎖が正しく動作しています！</p>
<h3 id="6_2">イテレーション 6 のまとめ<a class="headerlink" href="#6_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！イテレーション 6 で実装した内容を振り返ってみましょう：</p>
<ol>
<li><strong>Score クラスの作成</strong></li>
<li><code>Total</code>: 合計スコア</li>
<li><code>Chain</code>: 現在の連鎖数</li>
<li><code>IncrementChain()</code>: 連鎖数をインクリメント</li>
<li><code>ResetChain()</code>: 連鎖数をリセット</li>
<li>
<p><code>Add()</code>: スコアを加算</p>
</li>
<li>
<p><strong>スコア計算ロジック</strong></p>
</li>
<li>基本スコア = 消した数 × 10</li>
<li>連鎖ボーナス = 連鎖数</li>
<li>
<p>最終スコア = 基本スコア × 連鎖ボーナス</p>
</li>
<li>
<p><strong>連鎖反応の実装</strong></p>
</li>
<li>消去判定で消去対象が見つかったら連鎖数をインクリメント</li>
<li>消去後、重力処理へ移行</li>
<li>重力処理後、再度消去判定（ここで連鎖が発生）</li>
<li>
<p>消去対象がない場合、連鎖終了</p>
</li>
<li>
<p><strong>ゲームへの統合</strong></p>
</li>
<li><code>Game</code> クラスに <code>Score</code> プロパティを追加</li>
<li>
<p><code>UpdateChecking()</code> で連鎖数管理とスコア加算</p>
</li>
<li>
<p><strong>テスト</strong>: 6 個の新しいテストを追加</p>
</li>
<li>スコアの初期化</li>
<li>連鎖数のインクリメント</li>
<li>連鎖数のリセット</li>
<li>基本スコアの加算</li>
<li>連鎖ボーナスの加算</li>
<li>
<p>連鎖反応の動作確認</p>
</li>
<li>
<p><strong>学んだ重要な概念</strong></p>
</li>
<li>連鎖反応のメカニズム（消去 → 重力 → 消去 → 重力...）</li>
<li>スコア計算式の設計</li>
<li>ゲーム状態の管理</li>
</ol>
<p>これで、連鎖反応が動作するようになり、連鎖数に応じたボーナススコアが加算されるようになりました！次のイテレーションでは、スコアの表示機能を実装していきます。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 連鎖反応とスコア機能を実装</span>

<span class="s1">- Score クラスの作成</span>
<span class="s1">- 連鎖数のカウント機能</span>
<span class="s1">- 連鎖ボーナスの計算</span>
<span class="s1">- 消去時のスコア加算</span>
<span class="s1">- 連鎖反応の動作確認</span>
<span class="s1">- 6個のテストケースを追加&#39;</span>
</code></pre></div>
<hr />
<h2 id="7_1">イテレーション 7: ゲームオーバー判定<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h2>
<p>「連鎖とスコアができましたが、ぷよが積み重なって画面の上まで行ったらどうなるんですか？」それがゲームオーバーです！今回は、ゲームオーバーの判定と表示、そしてリスタート機能を実装していきましょう。</p>
<h3 id="_61">ユーザーストーリー<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとして、ぷよが画面上端に到達したらゲームオーバーになる</p>
<p>プレイヤーとして、ゲームオーバー後にリスタートできる</p>
</blockquote>
<p>「ゲームオーバーになったら、もう一度遊べないと困りますよね？」そうです！だから、ゲームオーバーの判定だけでなく、リスタート機能も一緒に実装しますよ。</p>
<h3 id="todo_6">TODO リスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>ゲームオーバーのゲームモードを追加する</li>
<li>新しいぷよペアを生成できない場合にゲームオーバーと判定する</li>
<li>リスタート機能を実装する</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_62">テスト: ゲームオーバー判定<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバーの判定ロジックからテストしていきましょう。新しいぷよペアが配置できない場合にゲームオーバーになることを確認します。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/GameTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">出現位置が埋まっているとゲ</span><span class="n">ー</span><span class="err">ムオ</span><span class="n">ー</span><span class="err">バ</span><span class="n">ー</span><span class="err">になる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="c1">// 出現位置 (2, 0) にぷよを配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act - 新しいぷよペアを生成しようとする</span>
<span class="w">    </span><span class="c1">// 内部的に SpawnNewPair が呼ばれる</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">0f</span><span class="p">);</span><span class="w"> </span><span class="c1">// Checking -&gt; Playing (SpawnNewPairが呼ばれる)</span>

<span class="w">    </span><span class="c1">// Assert - ゲームオーバーモードになっている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">出現位置が空いているとゲ</span><span class="n">ー</span><span class="err">ムオ</span><span class="n">ー</span><span class="err">バ</span><span class="n">ー</span><span class="err">にならない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange - 出現位置を空けておく（何も配置しない）</span>

<span class="w">    </span><span class="c1">// Act - 新しいぷよペアを生成</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">0f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert - プレイモードのままである</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreNotEqual</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の 2 つのケースを確認しています：</p>
<ol>
<li>出現位置にぷよがある場合、ゲームオーバーになるか</li>
<li>出現位置が空いている場合、ゲームオーバーにならないか</li>
</ol>
<p>「出現位置って、どこですか？」良い質問ですね！ぷよペアは画面上部の中央（X 座標 2、Y 座標 0）に出現します。そこに既にぷよがあると、新しいぷよペアを配置できないのでゲームオーバーになるんです。</p>
<h3 id="_63">実装: ゲームオーバー判定<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実装しましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>undefined: GameMode.GameOver
</code></pre></div>
<p>おっと！<code>GameMode.GameOver</code> がまだ定義されていませんね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<blockquote>
<p>明白な実装</p>
<p>シンプルな操作をどう実装すればいいだろうか。ただ実装すればいいのだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストを通すための実装を書いていきましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">GameMode</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Playing</span><span class="p">,</span><span class="w">    </span><span class="c1">// ぷよペア操作中</span>
<span class="w">    </span><span class="n">Falling</span><span class="p">,</span><span class="w">    </span><span class="c1">// 重力処理中</span>
<span class="w">    </span><span class="n">Checking</span><span class="p">,</span><span class="w">   </span><span class="c1">// 消去チェック中</span>
<span class="w">    </span><span class="n">GameOver</span><span class="w">    </span><span class="c1">// ゲームオーバー</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SpawnNewPair</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">axisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetRandomColor</span><span class="p">();</span>
<span class="w">    </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">childColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetRandomColor</span><span class="p">();</span>

<span class="w">    </span><span class="n">Pair</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">SPAWN_X</span><span class="p">,</span><span class="w"> </span><span class="n">SPAWN_Y</span><span class="p">,</span><span class="w"> </span><span class="n">axisColor</span><span class="p">,</span><span class="w"> </span><span class="n">childColor</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ゲームオーバー判定：新しいぷよペアが配置できるかチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newPair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">Board</span><span class="p">,</span><span class="w"> </span><span class="n">newPair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">,</span><span class="w"> </span><span class="n">newPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">,</span>
<span class="w">        </span><span class="n">newPair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">,</span><span class="w"> </span><span class="n">newPair</span><span class="p">.</span><span class="n">ChildY</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 配置できない場合はゲームオーバー</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>
<span class="w">        </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 配置できる場合は通常通りセット</span>
<span class="w">    </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newPair</span><span class="p">;</span>
<span class="w">    </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0f</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、<code>SpawnNewPair</code> で衝突判定をして、配置できない場合はゲームオーバーにするんですね！」そうです。新しいぷよペアを作成してから、実際に配置する前に衝突判定を行います。配置できなければゲームオーバー、配置できれば通常通りゲームを続けます。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ 出現位置が埋まっているとゲームオーバーになる
✅ 出現位置が空いているとゲームオーバーにならない
</code></pre></div>
<p>やった！テストが通りました。これが「Green（緑）」の状態です。</p>
<h3 id="_64">テスト: リスタート機能<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>次は、リスタート機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/GameTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">リスタ</span><span class="n">ー</span><span class="err">トするとゲ</span><span class="n">ー</span><span class="err">ムが初期状態に戻る</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange - ゲームオーバー状態にする</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">0f</span><span class="p">);</span><span class="w"> </span><span class="c1">// ゲームオーバーになる</span>

<span class="w">    </span><span class="c1">// スコアも加算しておく</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act - リスタート</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Restart</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">Total</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ボードがクリアされている</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_65">実装: リスタート機能<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs に追加</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Restart</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ボードをクリア</span>
<span class="w">    </span><span class="n">Board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// スコアをリセット</span>
<span class="w">    </span><span class="n">Score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Score</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// モードをプレイモードに</span>
<span class="w">    </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">    </span><span class="n">SpawnNewPair</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// タイマーをリセット</span>
<span class="w">    </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0f</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ リスタートするとゲームが初期状態に戻る
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="_66">ゲームオーバー時の更新処理<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>「ゲームオーバー時は、通常の更新処理をスキップする必要がありますね？」そうです。<code>Update</code> メソッドを修正しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs を修正</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームオーバー中は何もしない</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdatePlaying</span><span class="p">(</span><span class="n">deltaTime</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateFalling</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateChecking</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="7_2">イテレーション 7 のまとめ<a class="headerlink" href="#7_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！イテレーション 7 で実装した内容を振り返ってみましょう：</p>
<ol>
<li><strong>ゲームオーバー判定</strong></li>
<li>新しいぷよペアが配置できない場合にゲームオーバー</li>
<li><code>GameMode.GameOver</code> の追加</li>
<li>
<p><code>SpawnNewPair</code> での衝突チェック</p>
</li>
<li>
<p><strong>リスタート機能</strong></p>
</li>
<li><code>Restart()</code> メソッドによるゲーム初期化</li>
<li>
<p>ボード、スコア、モード、タイマーのリセット</p>
</li>
<li>
<p><strong>ゲームオーバー時の更新処理</strong></p>
</li>
<li>
<p>ゲームオーバー中は通常の更新処理をスキップ</p>
</li>
<li>
<p><strong>テスト</strong>: 3 個の新しいテストを追加</p>
</li>
<li>出現位置が埋まっているとゲームオーバーになる</li>
<li>出現位置が空いているとゲームオーバーにならない</li>
<li>リスタートするとゲームが初期状態に戻る</li>
</ol>
<p>これで、ゲームオーバーの判定とリスタート機能が実装できました！次のイテレーションでは、全消しボーナスを実装していきます。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームオーバー判定とリスタート機能を実装</span>

<span class="s1">- 配置不可能時のゲームオーバー判定</span>
<span class="s1">- Restart メソッドの実装</span>
<span class="s1">- ゲームオーバー時の更新処理スキップ</span>
<span class="s1">- 3個のテストケースを追加&#39;</span>
</code></pre></div>
<hr />
<h2 id="8_1">イテレーション 8: 全消しボーナス<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h2>
<p>「ゲームオーバーが実装できましたね！次は何をしますか？」次は、プレイヤーの腕前を褒める「全消しボーナス」を実装しましょう！すべてのぷよを消したときに特別なボーナス点を与える機能です。</p>
<h3 id="_67">ユーザーストーリー<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、すべてのぷよを消したときに全消しボーナスを得られる</p>
</blockquote>
<p>「全部消したときって、すごい達成感がありますよね！」そうですね！それに見合ったボーナスを与えることで、プレイヤーのモチベーションを高めます。</p>
<h3 id="todo_7">TODO リスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう：</p>
<ul>
<li>ボードが空かどうか判定する機能を実装する</li>
<li>全消しボーナスをスコアに加算する機能を実装する</li>
<li>消去後に全消しチェックを行う</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです。テスト駆動開発の流れに沿って、まずはテストから書いていきましょう！</p>
<h3 id="_68">テスト: ボードの全消し判定<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ボードが空かどうかを判定する機能をテストしましょう。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/BoardTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ボ</span><span class="n">ー</span><span class="err">ドが空の場合は全消しと判定される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 何も配置しない</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isAllClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">isAllClear</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">ボ</span><span class="n">ー</span><span class="err">ドにぷよがある場合は全消しと判定されない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Board</span><span class="p">();</span>
<span class="w">    </span><span class="n">board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isAllClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">isAllClear</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_69">実装: ボードの全消し判定<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Board.cs に追加</span>
<span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">IsAllClear</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ROWS</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COLS</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>「シンプルですね！」そうですね。全マスを走査して、1 つでもぷよがあれば <code>false</code> を返します。</p>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ ボードが空の場合は全消しと判定される
✅ ボードにぷよがある場合は全消しと判定されない
</code></pre></div>
<p>やった！テストが通りました。</p>
<h3 id="_70">テスト: 全消しボーナスの加算<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<p>次は、全消しボーナスをスコアに加算する機能をテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/ScoreTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">全消しボ</span><span class="n">ー</span><span class="err">ナスを加算できる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">initialScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Total</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="n">score</span><span class="p">.</span><span class="n">AddAllClearBonus</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Assert - 5000点のボーナスが加算される</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">initialScore</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">.</span><span class="n">Total</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_71">実装: 全消しボーナスの加算<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>テストを通すための実装を書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Score.cs に追加</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">AddAllClearBonus</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ 全消しボーナスを加算できる
</code></pre></div>
<p>素晴らしい！テストが通りました。</p>
<h3 id="_72">ゲームへの統合<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>「全消し判定とボーナス加算ができたので、ゲームに組み込みましょう！」そうですね。<code>Game</code> クラスの消去処理に全消しチェックを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs を修正</span>
<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateChecking</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 連鎖数をインクリメント</span>
<span class="w">        </span><span class="n">Score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// スコアを加算</span>
<span class="w">        </span><span class="n">Score</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 消去対象がある場合、消去して重力処理へ</span>
<span class="w">        </span><span class="n">Board</span><span class="p">.</span><span class="n">Erase</span><span class="p">(</span><span class="n">positions</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 全消しチェック</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Board</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Score</span><span class="p">.</span><span class="n">AddAllClearBonus</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去対象がない場合、連鎖終了</span>
<span class="w">        </span><span class="n">Score</span><span class="p">.</span><span class="n">ResetChain</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 新しいぷよペアを生成</span>
<span class="w">        </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「なるほど、ぷよを消去した後に全消しチェックを行って、全消しの場合はボーナスを加算するんですね！」そうです。この実装では、以下のことを行っています：</p>
<ol>
<li>ぷよを消去</li>
<li>ボードが空になっているかチェック</li>
<li>全消しの場合、5000 点のボーナスを加算</li>
</ol>
<h3 id="_73">テスト: 全消しボーナスの動作確認<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>「全消しボーナスが本当に動作するかテストしたいです！」いいですね！全消しボーナスをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Tests/EditMode/GameTest.cs に追加</span>
<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="err">すべてのぷよを消したときに全消しボ</span><span class="n">ー</span><span class="err">ナスが加算される</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange - ボードにぷよを4つだけ配置</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">PuyoColor</span><span class="p">.</span><span class="n">Red</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Act - 消去処理を実行</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">;</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">0f</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert - 基本スコア + 全消しボーナス</span>
<span class="w">    </span><span class="c1">// 基本スコア: 4 × 10 × 1 = 40</span>
<span class="w">    </span><span class="c1">// 全消しボーナス: 5000</span>
<span class="w">    </span><span class="c1">// 合計: 5040</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="mi">5040</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Score</span><span class="p">.</span><span class="n">Total</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<div class="highlight"><pre><span></span><code>✅ すべてのぷよを消したときに全消しボーナスが加算される
</code></pre></div>
<p>素晴らしい！全消しボーナスが正しく動作しています！</p>
<h3 id="8_2">イテレーション 8 のまとめ<a class="headerlink" href="#8_2" title="Permanent link">&para;</a></h3>
<p>お疲れ様でした！イテレーション 8 で実装した内容を振り返ってみましょう：</p>
<ol>
<li><strong>ボードの全消し判定</strong></li>
<li><code>IsAllClear()</code>: ボードが空かどうか判定</li>
<li>
<p>全マスを走査してぷよの有無をチェック</p>
</li>
<li>
<p><strong>全消しボーナスの加算</strong></p>
</li>
<li><code>AddAllClearBonus()</code>: 5000 点のボーナスを加算</li>
<li>
<p><code>Score</code> クラスに追加</p>
</li>
<li>
<p><strong>ゲームへの統合</strong></p>
</li>
<li><code>UpdateChecking()</code> で消去後に全消しチェック</li>
<li>
<p>全消しの場合はボーナスを加算</p>
</li>
<li>
<p><strong>テスト</strong>: 3 個の新しいテストを追加</p>
</li>
<li>ボードが空の場合は全消しと判定される</li>
<li>ボードにぷよがある場合は全消しと判定されない</li>
<li>全消しボーナスを加算できる</li>
<li>すべてのぷよを消したときに全消しボーナスが加算される</li>
</ol>
<p>これで、全消しボーナス機能が実装できました！次のイテレーションでは、最終調整を行います。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 全消しボーナスを実装</span>

<span class="s1">- ボードの全消し判定機能</span>
<span class="s1">- 全消しボーナス（5000点）の加算</span>
<span class="s1">- 消去後の全消しチェック</span>
<span class="s1">- 4個のテストケースを追加&#39;</span>
</code></pre></div>
<hr />
<h2 id="9_1">イテレーション 9: 最終調整と完成<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h2>
<p>さて、ゲームオーバー判定と全消しボーナスも実装できましたね！「これでぷよぷよゲームが完成したんですか？」基本的な機能は揃いましたが、もう少し使いやすさを向上させる調整をしましょう。このイテレーションでは、高速落下機能の追加、エラーハンドリングの改善、そして最終的な仕上げを行います。</p>
<h3 id="_74">ユーザーストーリー<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>最後のイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、下キーを押してぷよを高速落下させたい</p>
<p>開発者として、エラーが発生した場合に適切に処理したい</p>
</blockquote>
<p>「高速落下って何ですか？」良い質問ですね！通常、ぷよは自動的に1秒に1マス落下しますが、下キーを押している間はもっと速く落下させることができます。プレイヤーの操作性が大幅に向上しますよ。</p>
<h3 id="todo_8">TODOリスト<a class="headerlink" href="#todo_8" title="Permanent link">&para;</a></h3>
<p>このイテレーションで行うタスクを整理しましょう：</p>
<ul>
<li>高速落下機能を追加する（下キーで即座に1マス落下）</li>
<li>エラーハンドリングを追加する</li>
<li>ログ出力を追加する（デバッグ用）</li>
<li>コード全体のリファクタリング</li>
<li>最終的なテスト実行とビルド確認</li>
</ul>
<p>「最後のイテレーションなので、丁寧に仕上げていきましょう！」そうですね。テスト駆動開発のサイクルに従って、最後まで品質を保ちながら進めます。</p>
<h3 id="_75">テスト: 高速落下機能<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>まずは高速落下機能のテストから書きましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Tests/EditMode/GameTest.cs に追加</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">HandleInput_</span><span class="err">下キ</span><span class="n">ー</span><span class="err">でぷよが即座に落下する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Game</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act - Updateを呼ぶと高速落下が処理される</span>
<span class="w">    </span><span class="c1">// 注: 実際のキー入力はUnityInputSystemのテストで扱うため、</span>
<span class="w">    </span><span class="c1">// ここではHandleFastFallメソッドを直接テストする</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">initialY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">HandleInput_</span><span class="err">高速落下で着地する</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Game</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 下から2番目まで移動</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">finalY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act - これ以上下に移動できない</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">canMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">canMove</span><span class="p">);</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">finalY</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>「実際のキー入力のテストはどうするんですか？」良い質問ですね！Unity の Input System は統合テストで検証するのが一般的です。単体テストでは、キー入力を受け取った後の<strong>ロジック</strong>だけをテストします。</p>
<blockquote>
<p>単純な設計</p>
<p>今うまく動くもっとも単純なものは何だろうか。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h4 id="_76">実装: 高速落下機能<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h4>
<p>テストを書いたら、実装しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs の Update メソッドを修正</span>

<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">deltaTime</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームオーバー中の処理は別途 UI で扱う</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">:</span>
<span class="w">            </span><span class="n">HandleInput</span><span class="p">();</span>
<span class="w">            </span><span class="n">UpdateFall</span><span class="p">(</span><span class="n">deltaTime</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">:</span>
<span class="w">            </span><span class="n">Board</span><span class="p">.</span><span class="n">ApplyGravity</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">HasFloatingPuyo</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Checking</span><span class="p">:</span>
<span class="w">            </span><span class="n">UpdateChecking</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 高速落下処理を追加</span>
<span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleInput</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 左右移動</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">LeftArrow</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveLeft</span><span class="p">(</span><span class="n">Board</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveLeft</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">RightArrow</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveRight</span><span class="p">(</span><span class="n">Board</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveRight</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 回転</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">UpArrow</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">Rotate</span><span class="p">(</span><span class="n">Board</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 高速落下（下キーを押している間、連続で落下）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">DownArrow</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">Board</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>GetKeyDown</code>と<code>GetKey</code>の違いは何ですか？」重要な違いがあります：</p>
<ul>
<li><code>GetKeyDown</code>: キーが<strong>押された瞬間</strong>だけtrueを返す（1フレームだけ）</li>
<li><code>GetKey</code>: キーが<strong>押されている間</strong>ずっとtrueを返す</li>
</ul>
<p>高速落下は押している間ずっと処理したいので、<code>GetKey</code>を使います。左右移動や回転は1回だけ処理したいので、<code>GetKeyDown</code>を使います。</p>
<h4 id="_77">テスト: エラーハンドリング<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h4>
<p>次に、エラーハンドリングのテストを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Tests/EditMode/GameTest.cs に追加</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">Update_Null</span><span class="err">の</span><span class="n">CurrentPair</span><span class="err">でもエラ</span><span class="n">ー</span><span class="err">にならない</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Game</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act &amp; Assert - 例外が発生しないことを確認</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">DoesNotThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">1.0f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60.0f</span><span class="p">));</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">FixPairToBoard_</span><span class="err">着地時に</span><span class="n">CurrentPair</span><span class="err">が</span><span class="n">null</span><span class="err">になる</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="n">Game</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Game</span><span class="p">();</span>
<span class="w">    </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">axisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisColor</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ぷよを下まで移動</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">CanMoveDown</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">MoveDown</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">finalY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">finalX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Act - 着地処理</span>
<span class="w">    </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// fallTimer = FALL_INTERVALになるように複数回呼ぶ代わりに</span>
<span class="w">    </span><span class="c1">// 直接着地処理を呼ぶ（privateメソッドなので本来はUpdateを通す）</span>
<span class="w">    </span><span class="c1">// ここでは簡易的にUpdateを何度も呼ぶ</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">120</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">game</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="mf">1.0f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">60.0f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Assert - ボードにぷよが固定され、新しいペアが生成される</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">axisColor</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">.</span><span class="n">Board</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">finalY</span><span class="p">,</span><span class="w"> </span><span class="n">finalX</span><span class="p">));</span>
<span class="w">    </span><span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentPair</span><span class="p">);</span><span class="w"> </span><span class="c1">// 新しいペアが生成されている</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_78">実装: エラーハンドリングとログ<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h4>
<p>エラーハンドリングとデバッグ用のログを追加しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs にログ追加</span>

<span class="k">using</span><span class="w"> </span><span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">UpdateChecking</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Board</span><span class="p">.</span><span class="n">CheckErase</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Score</span><span class="p">.</span><span class="n">IncrementChain</span><span class="p">();</span>
<span class="w">            </span><span class="n">Score</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">positions</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="n">Score</span><span class="p">.</span><span class="n">Chain</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// ログ出力（デバッグ用）</span>
<span class="w">            </span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">$&quot;消去: {positions.Count}個のぷよ, 連鎖: {Score.Chain}&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="n">Board</span><span class="p">.</span><span class="n">Erase</span><span class="p">(</span><span class="n">positions</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 全消しチェック</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Board</span><span class="p">.</span><span class="n">IsAllClear</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">Score</span><span class="p">.</span><span class="n">AddAllClearBonus</span><span class="p">();</span>
<span class="w">                </span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;全消しボーナス! +5000点&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Falling</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Score</span><span class="p">.</span><span class="n">ResetChain</span><span class="p">();</span>
<span class="w">            </span><span class="n">SpawnNewPair</span><span class="p">();</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">Playing</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SpawnNewPair</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">axisColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetRandomColor</span><span class="p">();</span>
<span class="w">        </span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">childColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetRandomColor</span><span class="p">();</span>

<span class="w">        </span><span class="n">Pair</span><span class="w"> </span><span class="n">newPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Pair</span><span class="p">(</span><span class="n">SPAWN_X</span><span class="p">,</span><span class="w"> </span><span class="n">SPAWN_Y</span><span class="p">,</span><span class="w"> </span><span class="n">axisColor</span><span class="p">,</span><span class="w"> </span><span class="n">childColor</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newPair</span><span class="p">.</span><span class="n">IsCollision</span><span class="p">(</span><span class="n">Board</span><span class="p">,</span><span class="w"> </span><span class="n">newPair</span><span class="p">.</span><span class="n">AxisX</span><span class="p">,</span><span class="w"> </span><span class="n">newPair</span><span class="p">.</span><span class="n">AxisY</span><span class="p">,</span>
<span class="w">            </span><span class="n">newPair</span><span class="p">.</span><span class="n">ChildX</span><span class="p">,</span><span class="w"> </span><span class="n">newPair</span><span class="p">.</span><span class="n">ChildY</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameMode</span><span class="p">.</span><span class="n">GameOver</span><span class="p">;</span>
<span class="w">            </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<span class="w">            </span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;ゲームオーバー!&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newPair</span><span class="p">;</span>
<span class="w">        </span><span class="n">fallTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">HandleInput</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// CurrentPairがnullの場合は早期リターン（エラーハンドリング）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ... 既存の入力処理 ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「<code>Debug.Log</code>って何ですか？」Unity のログ出力機能です。開発中にゲームの動作を確認するのに便利ですよ。コンソールウィンドウに表示されます。</p>
<h3 id="_79">リファクタリング: 定数の整理<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p>コード全体を見直して、定数を整理しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Assets/Scripts/Core/Game.cs の定数を整理</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ボード関連の定数</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SPAWN_X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SPAWN_Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ゲームバランス調整用の定数</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">FALL_INTERVAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span><span class="w"> </span><span class="c1">// 落下間隔（秒）</span>

<span class="w">    </span><span class="c1">// ... 既存のコード ...</span>
<span class="p">}</span>
</code></pre></div>
<p>「定数を使うメリットは何ですか？」良い質問ですね！定数を使うと：</p>
<ol>
<li><strong>値の意味が明確になる</strong>: <code>2</code>より<code>SPAWN_X</code>の方が意図が分かりやすい</li>
<li><strong>変更が容易</strong>: 1箇所変えれば全体に反映される</li>
<li><strong>タイプミス防止</strong>: マジックナンバーの重複入力を避けられる</li>
</ol>
<blockquote>
<p>意図を表現しよう</p>
<p>システムの主なコストは長期的なメンテナンスにある。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_80">テストの実行と確認<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したら、テストを実行しましょう：</p>
<div class="highlight"><pre><span></span><code>dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
</code></pre></div>
<p>すべてのテストがパスすることを確認してください。もしテストが失敗する場合は、エラーメッセージを確認して修正しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># コードフォーマットも確認</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format

<span class="c1"># ビルドも確認</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
</code></pre></div>
<p>「全部通りました！」素晴らしい！これでぷよぷよゲームの実装が完成しました！</p>
<h3 id="9_2">イテレーション 9 のまとめ<a class="headerlink" href="#9_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>高速落下機能</strong></li>
<li><code>GetKey(KeyCode.DownArrow)</code>で押している間落下</li>
<li><code>CanMoveDown</code>で着地判定</li>
<li>
<p>プレイヤー体験の向上</p>
</li>
<li>
<p><strong>エラーハンドリング</strong></p>
</li>
<li><code>CurrentPair</code>のnullチェック</li>
<li>
<p>早期リターンによる安全性向上</p>
</li>
<li>
<p><strong>ログ出力</strong></p>
</li>
<li><code>Debug.Log</code>による消去情報の表示</li>
<li>全消しボーナスの通知</li>
<li>
<p>ゲームオーバーの通知</p>
</li>
<li>
<p><strong>定数の整理</strong></p>
</li>
<li><code>SPAWN_X</code>、<code>SPAWN_Y</code>、<code>FALL_INTERVAL</code>の定義</li>
<li>
<p>マジックナンバーの排除</p>
</li>
<li>
<p><strong>最終確認</strong></p>
</li>
<li>すべてのテストがパス</li>
<li>コードフォーマットの適用</li>
<li>ビルドの成功確認</li>
</ol>
<h2 id="_81">完成したゲームの全機能<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h2>
<p>ここまでのチュートリアルで実装した機能をまとめましょう：</p>
<p><strong>基本操作</strong>
- ぷよペアの左右移動（←→キー）
- ぷよペアの回転（↑キー、壁キック付き）
- 高速落下（↓キー）</p>
<p><strong>ゲームロジック</strong>
- 自動落下とタイマー処理
- 着地判定とボード固定
- 消去判定（DFSによる4つ以上の検出）
- 重力処理（浮いているぷよの落下）
- 連鎖システム</p>
<p><strong>スコアシステム</strong>
- 基本スコア（消した数 × 10）
- 連鎖ボーナス（2^(連鎖数-1)倍）
- 全消しボーナス（5000点）</p>
<p><strong>ゲーム管理</strong>
- ゲームオーバー判定
- リスタート機能
- ゲームモード状態遷移（Playing → Falling → Checking）</p>
<h3 id="_82">テスト駆動開発で学んだこと<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>このチュートリアルを通じて、多くの重要な概念を学びましたね：</p>
<p><strong>1. Red-Green-Refactor サイクル</strong></p>
<blockquote>
<p>テスト駆動開発のマントラ</p>
<p>動作しない失敗するテストを書くまでは、決してプロダクションコードを書いてはならない。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<ul>
<li><strong>Red（赤）</strong>: まず失敗するテストを書く</li>
<li><strong>Green（緑）</strong>: テストを通す最小限のコードを書く</li>
<li><strong>Refactor（リファクタリング）</strong>: コードを改善する</li>
</ul>
<p>このサイクルを繰り返すことで、品質の高いコードを書くことができました。</p>
<p><strong>2. C# の重要な概念</strong></p>
<ul>
<li><strong>プロパティ</strong>: <code>public int Total { get; private set; }</code></li>
<li><strong>Enum</strong>: 型安全な定数（<code>PuyoColor</code>、<code>GameMode</code>）</li>
<li><strong>タプル</strong>: <code>List&lt;(int row, int col)&gt;</code>で複数の値を返す</li>
<li><strong>2次元配列</strong>: <code>PuyoColor[,] cells</code>でボード表現</li>
<li><strong>Null安全性</strong>: nullチェックと早期リターン</li>
</ul>
<p><strong>3. アルゴリズム</strong></p>
<ul>
<li><strong>深さ優先探索（DFS）</strong>: 再帰による連結ぷよの検出</li>
<li><strong>衝突判定</strong>: 移動可能性のチェック</li>
<li><strong>回転計算</strong>: 剰余演算<code>(rotation + 3) % 4</code>による循環</li>
<li><strong>重力処理</strong>: 下から順に処理してぷよを落とす</li>
</ul>
<p><strong>4. ゲーム開発パターン</strong></p>
<ul>
<li><strong>ゲームループ</strong>: <code>Update(deltaTime)</code>による毎フレーム更新</li>
<li><strong>状態遷移</strong>: GameModeによる明確な状態管理</li>
<li><strong>タイマー管理</strong>: deltaTimeによるフレーム独立な時間処理</li>
<li><strong>入力処理</strong>: <code>GetKeyDown</code> vs <code>GetKey</code>の使い分け</li>
</ul>
<h3 id="unity-c">Unity と C# の特徴を活かした実装<a class="headerlink" href="#unity-c" title="Permanent link">&para;</a></h3>
<p>このチュートリアルで、Unity と C# の特徴を活かした実装を行いました：</p>
<p><strong>C# の強み</strong>
- <strong>型安全性</strong>: Enumとプロパティによる堅牢なコード
- <strong>明示性</strong>: アクセス修飾子とプロパティによる意図の明確化
- <strong>パフォーマンス</strong>: コンパイル型言語の高速性
- <strong>開発効率</strong>: IDEサポートとインテリセンス</p>
<p><strong>Unity の強み</strong>
- <strong>クロスプラットフォーム</strong>: Windows、Mac、Linux、モバイル対応
- <strong>テストフレームワーク</strong>: NUnit統合による充実したテスト環境
- <strong>バッチモード</strong>: CI/CDに適したコマンドライン実行
- <strong>拡張性</strong>: 将来的にビジュアルやサウンドを簡単に追加可能</p>
<h3 id="_83">次のステップ<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p>「完成したゲームをさらに発展させるには、どうすればいいですか？」素晴らしい質問ですね！ここからさらに機能を追加するアイデアを紹介します：</p>
<p><strong>1. ビジュアルの改善</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Spriteを使った描画</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">PuyoRenderer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Sprite</span><span class="w"> </span><span class="n">redPuyoSprite</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Sprite</span><span class="w"> </span><span class="n">bluePuyoSprite</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">RenderPuyo</span><span class="p">(</span><span class="n">PuyoColor</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="n">Vector2</span><span class="w"> </span><span class="n">position</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Sprite</span><span class="w"> </span><span class="n">sprite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetSpriteForColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// SpriteRendererで描画</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>画像アセットの使用（かわいいぷよの絵）</li>
<li>アニメーション効果（消えるときのエフェクト）</li>
<li>パーティクルシステム（連鎖の演出）</li>
</ul>
<p><strong>2. サウンドの追加</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// AudioSourceを使った音声再生</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SoundManager</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">AudioClip</span><span class="w"> </span><span class="n">rotateSound</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">AudioClip</span><span class="w"> </span><span class="n">eraseSound</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">AudioClip</span><span class="w"> </span><span class="n">chainSound</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">PlayRotateSound</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AudioSource</span><span class="p">.</span><span class="n">PlayClipAtPoint</span><span class="p">(</span><span class="n">rotateSound</span><span class="p">,</span><span class="w"> </span><span class="n">Camera</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>BGM再生</li>
<li>効果音（回転、消去、連鎖）</li>
<li>音量調整機能</li>
</ul>
<p><strong>3. 追加機能</strong></p>
<ul>
<li><strong>ネクストぷよの表示</strong>: 次に来るぷよペアを表示</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Game</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Pair</span><span class="w"> </span><span class="n">NextPair</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SpawnNewPair</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">CurrentPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NextPair</span><span class="p">;</span>
<span class="w">        </span><span class="n">NextPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerateRandomPair</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><strong>ハイスコア記録</strong>: JsonUtilityでファイル保存</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="na">[System.Serializable]</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">SaveData</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">highScore</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SaveHighScore</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">score</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">SaveData</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SaveData</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">highScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="n">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JsonUtility</span><span class="p">.</span><span class="n">ToJson</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">File</span><span class="p">.</span><span class="n">WriteAllText</span><span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="n">persistentDataPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/save.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><strong>難易度調整</strong>: 落下速度の変更</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">Difficulty</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Easy</span><span class="p">,</span>
<span class="w">    </span><span class="n">Normal</span><span class="p">,</span>
<span class="w">    </span><span class="n">Hard</span>
<span class="p">}</span>

<span class="k">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">GetFallInterval</span><span class="p">(</span><span class="n">Difficulty</span><span class="w"> </span><span class="n">difficulty</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">difficulty</span><span class="w"> </span><span class="k">switch</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Difficulty</span><span class="p">.</span><span class="n">Easy</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mf">1.5f</span><span class="p">,</span>
<span class="w">        </span><span class="n">Difficulty</span><span class="p">.</span><span class="n">Normal</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">,</span>
<span class="w">        </span><span class="n">Difficulty</span><span class="p">.</span><span class="n">Hard</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">,</span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mf">1.0f</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><strong>おじゃまぷよ</strong>: 対戦時のギミック</li>
</ul>
<p><strong>4. マルチプレイ</strong></p>
<ul>
<li><strong>2Pモード</strong>: 同一画面で対戦</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TwoPlayerGame</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="n">player1Game</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Game</span><span class="w"> </span><span class="n">player2Game</span><span class="p">;</span>

<span class="w">    </span><span class="k">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Player 1: WASD</span>
<span class="w">        </span><span class="c1">// Player 2: Arrow Keys</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><strong>ネットワーク対戦</strong>: Unity Netcodeを使用</li>
</ul>
<h3 id="_84">最終コミット<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>すべての実装が完了したので、最終的なコミットを行いましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: ゲーム完成！高速落下とエラーハンドリングを実装</span>

<span class="s2">- 下キーでの高速落下機能</span>
<span class="s2">- エラーハンドリング（nullチェック）</span>
<span class="s2">- Debug.Logによるログ出力</span>
<span class="s2">- 定数の整理とリファクタリング</span>
<span class="s2">- ゲーム完成！&quot;</span>

<span class="c1"># バージョンタグを付ける</span>
git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span>v1.0.0<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;ぷよぷよゲーム v1.0.0 完成&quot;</span>
</code></pre></div>
<p>「タグって何ですか？」Gitのタグは、特定のコミットに名前を付ける機能です。<code>v1.0.0</code>のようにバージョン番号を付けることで、後から「このバージョンのコードはどれだったかな？」と簡単に見つけられます。</p>
<p>リモートリポジトリにプッシュする場合は：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>main
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>v1.0.0
</code></pre></div>
<h3 id="_85">終わりに<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>「テスト駆動開発でゲームを作るのは、とても楽しかったです！」そうですね！TDDは最初は面倒に感じるかもしれませんが、確実に品質の高いコードを書くことができます。</p>
<p>「C# と Unity はシンプルで強力ですね！」はい、C# の型安全性と Unity のクロスプラットフォーム対応は、保守しやすく移植性の高いゲームを作るのに最適です。</p>
<blockquote>
<p>Simple made easy.</p>
<p>— Rich Hickey（Clojure開発者）</p>
</blockquote>
<p>この言葉は、「シンプルさは簡単ではないが、簡単さをもたらす」という意味です。テスト駆動開発も同じです。最初は手間がかかりますが、その規律に従うことで、後の開発が楽になります。</p>
<p>「次は何を作りましょうか？」良い質問ですね！学んだTDDの技術を使って、自分のオリジナルなゲームやアプリケーションを作ってみてください。C# のシンプルさとテストの力を借りれば、安全で高品質なソフトウェアを作ることができます。</p>
<p>ぷよぷよを通じてテスト駆動開発と C#/Unity の基礎を学べたことを願っています。Happy Coding!</p>
<div class="highlight"><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Completion</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">void</span><span class="w"> </span><span class="nf">Start</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;ぷよぷよゲーム、完成！🎉&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Simple made easy.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="_86">付録: コマンドリファレンス<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h2>
<p>このチュートリアルで使用したコマンドの一覧です：</p>
<h3 id="_87">開発コマンド<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># テストの実行</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Test
<span class="c1"># または</span>
./scripts/test.sh

<span class="c1"># コードフォーマット</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Format
<span class="c1"># または</span>
./scripts/format.sh

<span class="c1"># コードチェック（フォーマット確認のみ）</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Check
<span class="c1"># または</span>
./scripts/check.sh

<span class="c1"># ファイル監視と自動テスト</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Watch
<span class="c1"># または</span>
./scripts/watch.sh

<span class="c1"># ビルド</span>
dotnet<span class="w"> </span>cake<span class="w"> </span>--target<span class="o">=</span>Build
<span class="c1"># または</span>
./scripts/build.sh
</code></pre></div>
<h3 id="git_1">Git コマンド<a class="headerlink" href="#git_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 変更をステージング</span>
git<span class="w"> </span>add<span class="w"> </span>.

<span class="c1"># コミット</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: 新機能の説明&quot;</span>

<span class="c1"># ログ確認</span>
git<span class="w"> </span>log<span class="w"> </span>--oneline

<span class="c1"># タグ作成</span>
git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span>v1.0.0<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;バージョン1.0.0&quot;</span>

<span class="c1"># リモートにプッシュ</span>
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>main
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>v1.0.0
</code></pre></div>
<h3 id="unity-cli">Unity CLI コマンド<a class="headerlink" href="#unity-cli" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># テスト実行（直接）</span>
/Applications/Unity/Hub/Editor/2022.3.27f1/Unity.app/Contents/MacOS/Unity<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-batchmode<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-nographics<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-projectPath<span class="w"> </span>.<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-runTests<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-testPlatform<span class="w"> </span>EditMode<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-testResults<span class="w"> </span>results.xml

<span class="c1"># ビルド（直接）</span>
/Applications/Unity/Hub/Editor/2022.3.27f1/Unity.app/Contents/MacOS/Unity<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-batchmode<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-nographics<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-projectPath<span class="w"> </span>.<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-buildTarget<span class="w"> </span>StandaloneOSX<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-quit
</code></pre></div>
<hr />
<h2 id="_88">付録: プロジェクト構成<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h2>
<p>最終的なプロジェクト構成：</p>
<div class="highlight"><pre><span></span><code>puyo-puyo-unity/
├── Assets/
│   ├── Scripts/
│   │   └── Core/
│   │       ├── Board.cs          # ボード（6×12グリッド）
│   │       ├── Pair.cs           # ぷよペア（回転、移動、衝突判定）
│   │       ├── PuyoColor.cs      # ぷよの色（Enum）
│   │       ├── Game.cs           # ゲーム制御（状態遷移、入力）
│   │       └── Score.cs          # スコア管理（連鎖、全消し）
│   └── Tests/
│       └── EditMode/
│           ├── BoardTest.cs      # ボードのテスト
│           ├── PairTest.cs       # ぷよペアのテスト
│           ├── GameTest.cs       # ゲームのテスト
│           └── ScoreTest.cs      # スコアのテスト
├── scripts/
│   ├── test.sh                   # テスト実行スクリプト
│   ├── build.sh                  # ビルドスクリプト
│   ├── format.sh                 # フォーマットスクリプト
│   ├── check.sh                  # チェックスクリプト
│   └── watch.sh                  # ファイル監視スクリプト
├── unity-config.sh               # Unity パス設定
├── build.cake                    # Cake ビルド自動化スクリプト
├── .config/
│   └── dotnet-tools.json         # .NET ローカルツール設定
├── .editorconfig                 # エディタ設定
└── .gitignore                    # Git除外設定
</code></pre></div>
<hr />
<h2 id="_89">付録: 参考資料<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h2>
<p>このチュートリアルを作成するにあたって参考にした資料：</p>
<p><strong>書籍</strong>
- 『テスト駆動開発』Kent Beck 著、和田卓人 訳（オーム社）
- 『Clean Craftsmanship 規律、基準、倫理』Robert C. Martin 著（アスキードワンゴ）
- 『エクストリームプログラミング』Kent Beck 著（オーム社）</p>
<p><strong>公式ドキュメント</strong>
- <a href="https://docs.unity3d.com/">Unity Documentation</a>
- <a href="https://docs.unity3d.com/Packages/com.unity.test-framework@latest/">Unity Test Framework</a>
- <a href="https://docs.microsoft.com/dotnet/csharp/">C# Programming Guide</a></p>
<p><strong>関連技術</strong>
- <a href="https://nunit.org/">NUnit</a> - テストフレームワーク
- <a href="https://git-scm.com/">Git</a> - バージョン管理
- <a href="https://editorconfig.org/">EditorConfig</a> - コーディング規約</p>
<hr />
<p>これでぷよぷよゲームのチュートリアルは完結です。テスト駆動開発の旅を楽しんでいただけたら幸いです！</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>