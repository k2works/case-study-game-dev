
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="React Native でのテスト駆動開発の手法を用いてぷよぷよゲームを実装する過程を解説">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発 (React Native 版) - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#react-native" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発 (React Native 版)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="react-native">ぷよぷよから始めるテスト駆動開発 (React Native 版)<a class="headerlink" href="#react-native" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、React Native でぷよぷよゲームを作っていきましょう。この記事は「ぷよぷよから始めるテスト駆動開発」の React Native 版です。</p>
<blockquote>
<p>テスト駆動開発とは、プログラミングの手法の一種で、「テストファースト」の原則に従い、実装前にテストを書くことで、コードの品質を高め、設計を改善していく開発手法です。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>React Native を使うことで、iOS と Android の両方で動作するネイティブアプリケーションを一つのコードベースから開発できます。モバイルゲームならではの特徴として、タッチ操作やスマートフォンの画面サイズに最適化されたUIを実装していきます。</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>テスト駆動開発では、以下の3つのステップを繰り返すサイクルで開発を進めます：</p>
<ol>
<li><strong>Red（赤）</strong>: まず失敗するテストを書きます</li>
<li><strong>Green（緑）</strong>: テストが通るように、最小限のコードを実装します</li>
<li><strong>Refactor（リファクタリング）</strong>: コードの品質を改善します</li>
</ol>
<blockquote>
<p>テスト駆動開発のリズム：赤、緑、リファクタリング。まず失敗するテストを書き（赤）、次にテストが通るようにする（緑）、そして重複を除去する（リファクタリング）。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>このサイクルを「Red-Green-Refactor」サイクルと呼びます。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNUQVRFIiBoZWlnaHQ9IjY1MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM3cHg7aGVpZ2h0OjY1MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczNyA2NTEiIHdpZHRoPSI3MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzOTkiIGN5PSIxNiIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MTsiLz48ZyBpZD0iLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzE5IiB5PSI4NyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMxOSIgeDI9IjQ3OC45OTk0IiB5MT0iMTEzLjI5NjkiIHkyPSIxMTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzMjkiIHk9IjEwNC45OTUxIj4mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OzwvdGV4dD48L2c+PGcgaWQ9IlRPRE8iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTAiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjEuMzcxMSIgeD0iMjg5LjMyIiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIyODkuMzIiIHgyPSIzNTAuNjkxMSIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MS4zNzExIiB4PSIyOTkuMzIiIHk9IjIzMS45OTUxIj5UT0RPPC90ZXh0PjwvZz48ZyBpZD0iUmVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iOTIuMDAwNSIgeD0iMTk1IiB5PSIzNDEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxOTUiIHgyPSIyODcuMDAwNSIgeTE9IjM2Ny4yOTY5IiB5Mj0iMzY3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNy4yMjc1IiB4PSIyMjcuMzg2NSIgeT0iMzU4Ljk5NTEiPlJlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4wMDA1IiB4PSIyMDAiIHk9IjM4My40MzU1Ij4mIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjI4MzM7JiMyNTk0Mzs8L3RleHQ+PC9nPjxnIGlkPSJHcmVlbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MC4yNjU2IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE2NC4wMDExIiB4PSI3IiB5PSI0NjguMjciLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI3IiB4Mj0iMTcxLjAwMTEiIHkxPSI0OTQuNTY2OSIgeTI9IjQ5NC41NjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIuNzA0MSIgeD0iNjcuNjQ4NSIgeT0iNDg2LjI2NTEiPkdyZWVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NC4wMDExIiB4PSIxMiIgeT0iNTEwLjcwNTUiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTIzOTU7JiMzNjg5MDsmIzEyNDI3OyYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PGcgaWQ9IlJlZmFjdG9yIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUwLjI2NTYiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjQ4LjAwMTciIHg9IjExNyIgeT0iNTk1LjUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTE3IiB4Mj0iMzY1LjAwMTciIHkxPSI2MjEuODI2OSIgeTI9IjYyMS44MjY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuMzU2NCIgeD0iMjExLjMyMjYiIHk9IjYxMy41MjUxIj5SZWZhY3RvcjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguMDAxNyIgeD0iMTIyIiB5PSI2MzcuOTY1NSI+JiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODk7JiMxMjM5ODsmIzM3MzI1OyYjMzUwNzk7JiMxMjQzNDsmIzM4NTAwOyYjMjE0MzU7JiMxMjM3NTsmIzEyMzkwOyYjMTI1MjI7JiMxMjUwMTsmIzEyNDQ5OyYjMTI0NjM7JiMxMjQ3OTsmIzEyNTIyOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjxnIGlkPSIuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI1MCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNzMuOTk5MyIgeD0iNTU3IiB5PSIyMTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NTciIHgyPSI3MzAuOTk5MyIgeTE9IjI0MC4yOTY5IiB5Mj0iMjQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTY3IiB5PSIyMzEuOTk1MSI+JiMxMjQ1MjsmIzEyNDg2OyYjMTI1MjQ7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzEyNTI0OyYjMTI0OTk7JiMxMjUxNzsmIzEyNTQwOzwvdGV4dD48L2c+PCEtLWxpbmsgKnN0YXJ0KiB0byA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ii5zdGFydC4iIGRhdGEtZW50aXR5LTI9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEiIGRhdGEtdWlkPSJsbms0IiBpZD0ibGlua18uc3RhcnQuXy4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik0zOTksMjYuMzYgQzM5OSw0MC4yOSAzOTksNjAuOTYgMzk5LDgwLjY1IiBmaWxsPSJub25lIiBpZD0iKnN0YXJ0Ki10by0mIzEyNDY3OyYjMTI1NDA7JiMxMjQ4NzsmIzEyNDUxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyMzkyOyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk5LDg2LjY1LDQwMyw3Ny42NSwzOTksODEuNjUsMzk1LDc3LjY1LDM5OSw4Ni42NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayA/Pz8/Pz8/Pz8/IHRvIFRPRE8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMiIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rXy4uLi4uLi4uLi5fVE9ETyI+PHBhdGggZD0iTTMxOC44NSwxMjAuMjYgQzI4OC40NSwxMjcuMzggMjU2LjY4LDE0MS4wNCAyMzgsMTY3IEMyMTkuOTcsMTkyLjA3IDI1My4xNTYzLDIxMS44NDA4IDI4My4zMTYzLDIyNC40ODA4IiBmaWxsPSJub25lIiBpZD0iJiMxMjQ2NzsmIzEyNTQwOyYjMTI0ODc7JiMxMjQ1MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjM5MjsmIzEyNDg2OyYjMTI0NzM7JiMxMjQ4ODstdG8tVE9ETyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjg4Ljg1LDIyNi44LDI4Mi4wOTU2LDIxOS42MzIyLDI4NC4yMzg2LDIyNC44Njc0LDI3OS4wMDM0LDIyNy4wMTA0LDI4OC44NSwyMjYuOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi40MTYxIiB4PSIyMzkiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjQzNDsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayBUT0RPIHRvID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9ImxpbmtfVE9ET18uLi4uLi4uLi4uIj48cGF0aCBkPSJNMzM5LjA0LDIxMy43NyBDMzQ1LjkzLDIwNC42MyAzNTMuNTgsMTk0LjAyIDM2MCwxODQgQzM2OS42NCwxNjguOTcgMzc2LjUyMTgsMTU2LjY4MjggMzgzLjgyMTgsMTQyLjc3MjgiIGZpbGw9Im5vbmUiIGlkPSJUT0RPLXRvLSYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzODYuNjEsMTM3LjQ2LDM3OC44ODU5LDE0My41NzA0LDM4NC4yODY1LDE0MS44ODczLDM4NS45Njk2LDE0Ny4yODgsMzg2LjYxLDEzNy40NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyMC40MTYyIiB4PSIzNzAuMjYiIHk9IjE4MC4wNjY5Ij5UT0RPJiMxMjUyMjsmIzEyNDczOyYjMTI0ODg7JiMxMjM2NDsmIzMxMzU0OyYjMTIzOTU7JiMxMjM5NDsmIzEyNDI3OyYjMTI0MTQ7JiMxMjM5MTsmIzMyMzY4OyYjMTI0MjY7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWxpbmsgVE9ETyB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iVE9ETyIgZGF0YS1lbnRpdHktMj0iUmVkIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfVE9ET19SZWQiPjxwYXRoIGQ9Ik0zMDQuNTgsMjY0LjQzIEMyOTAuNjYsMjg2LjQ4IDI3My40OTM0LDMxMy42NjY3IDI1OS41ODM0LDMzNS42OTY3IiBmaWxsPSJub25lIiBpZD0iVE9ETy10by1SZWQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1Ni4zOCwzNDAuNzcsMjY0LjU2NzIsMzM1LjI5NTYsMjU5LjA0OTUsMzM2LjU0MjIsMjU3LjgwMjgsMzMxLjAyNDUsMjU2LjM4LDM0MC43NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjI4Ni4yMyIgeT0iMzA3LjA2NjkiPiYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVkIHRvIEdyZWVuLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IlJlZCIgZGF0YS1lbnRpdHktMj0iR3JlZW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJsbmsxMCIgaWQ9ImxpbmtfUmVkX0dyZWVuIj48cGF0aCBkPSJNMTk0LjY4LDM4NC40MSBDMTc0LjgxLDM5My4zNSAxNTIuMjUsNDA1LjY5IDEzNSw0MjEuMjcgQzEyMC40OCw0MzQuMzggMTExLjQ3MjEsNDQ3Ljc4NTggMTAzLjQ0MjEsNDYyLjcxNTgiIGZpbGw9Im5vbmUiIGlkPSJSZWQtdG8tR3JlZW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwMC42LDQ2OCwxMDguMzg1OSw0NjEuOTY4NCwxMDIuOTY4NCw0NjMuNTk2NSwxMDEuMzQwMyw0NTguMTc5LDEwMC42LDQ2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjEzNiIgeT0iNDM0LjMzNjkiPiYjMjYzNjg7JiMyMzU2NzsmIzM4NDgwOyYjMTIzOTg7JiMyMzQ1NTsmIzM1MDEzOzwvdGV4dD48L2c+PCEtLWxpbmsgR3JlZW4gdG8gUmVmYWN0b3ItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iR3JlZW4iIGRhdGEtZW50aXR5LTI9IlJlZmFjdG9yIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0ibG5rMTIiIGlkPSJsaW5rX0dyZWVuX1JlZmFjdG9yIj48cGF0aCBkPSJNOTAuNTEsNTE4LjcyIEM5Mi42Miw1MzMuODEgOTcuNTYsNTUyLjcgMTA5LDU2NS41MyBDMTIwLjEyLDU3OC4wMiAxMjkuMTcyNCw1ODUuMDM5MyAxNDQuMzkyNCw1OTIuNDk5MyIgZmlsbD0ibm9uZSIgaWQ9IkdyZWVuLXRvLVJlZmFjdG9yIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNDkuNzgsNTk1LjE0LDE0My40NTksNTg3LjU4NzIsMTQ1LjI5MDMsNTkyLjkzOTQsMTM5LjkzODEsNTk0Ljc3MDcsMTQ5Ljc4LDU5NS4xNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIxMTAiIHk9IjU2MS41OTY5Ij4mIzEyNTIyOyYjMTI1MDE7JiMxMjQ0OTsmIzEyNDYzOyYjMTI0Nzk7JiMxMjUyMjsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tbGluayBSZWZhY3RvciB0byBSZWQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iUmVmYWN0b3IiIGRhdGEtZW50aXR5LTI9IlJlZCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19SZWZhY3Rvcl9SZWQiPjxwYXRoIGQ9Ik0yNDEsNTk1LjE2IEMyNDEsNTQ2Ljc3IDI0MSw0NDUuNSAyNDEsMzk3LjM1IiBmaWxsPSJub25lIiBpZD0iUmVmYWN0b3ItdG8tUmVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNDEsMzkxLjM1LDIzNyw0MDAuMzUsMjQxLDM5Ni4zNSwyNDUsNDAwLjM1LDI0MSwzOTEuMzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjQyIiB5PSI0OTcuOTY2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI0ODY7JiMxMjQ3MzsmIzEyNDg4OyYjMTI0MzQ7JiMyNjM2MDsmIzEyMzY3OzwvdGV4dD48L2c+PCEtLWxpbmsgUmVmYWN0b3IgdG8gVE9ETy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJSZWZhY3RvciIgZGF0YS1lbnRpdHktMj0iVE9ETyIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfUmVmYWN0b3JfVE9ETyI+PHBhdGggZD0iTTI4MS43Myw1OTUuMjIgQzMwNy40NSw1NzcuNDEgMzM4Ljc4LDU1MC44IDM1NSw1MTguNTMgQzU5NS43LDM5Ljc0IDM5NC42NiwzNDYuOTggMzczLDI5NCBDMzY4LjI4LDI4Mi40NSAzNjQuMDc3NywyNzYuMjA2MyAzNTUuMjM3NywyNjcuNjc2MyIgZmlsbD0ibm9uZSIgaWQ9IlJlZmFjdG9yLXRvLVRPRE8iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC45MiwyNjMuNTEsMzU0LjYxOSwyNzIuNjM3OCwzNTQuNTE4MSwyNjYuOTgxOSwzNjAuMTc0LDI2Ni44ODA5LDM1MC45MiwyNjMuNTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTguNDE2MyIgeD0iNDAzLjk5IiB5PSI0MzQuMzM2OSI+JiMxMjUyMjsmIzEyNTAxOyYjMTI0NDk7JiMxMjQ2MzsmIzEyNDc5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OyYjMTIzNjQ7JiMyMzQzNjsmIzIwMTAyOyYjMTIzNzU7JiMxMjM4MzsmIzEyNDI1O1RPRE8mIzEyNTIyOyYjMTI0NzM7JiMxMjQ4ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rID8/Pz8/Pz8/Pz8gdG8gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iLi4uLi4uLi4uLiIgZGF0YS1lbnRpdHktMj0iLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0ibG5rMTciIGlkPSJsaW5rXy4uLi4uLi4uLi5fLi4uLi4uLi4uLi4iPjxwYXRoIGQ9Ik00NzkuNDMsMTIwLjk1IEM1MTguNTIsMTI4LjA2IDU2NC4zOSwxNDEuNTIgNTk5LDE2NyBDNjE0Ljk4LDE3OC43NyA2MjQuMDc5MywxOTIuNjcyOSA2MzEuNTM5MywyMDguMTgyOSIgZmlsbD0ibm9uZSIgaWQ9IiYjMTI0Njc7JiMxMjU0MDsmIzEyNDg3OyYjMTI0NTE7JiMxMjUzMTsmIzEyNDY0OyYjMTIzOTI7JiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7LXRvLSYjMTI0NTI7JiMxMjQ4NjsmIzEyNTI0OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7JiMxMjUyNDsmIzEyNDk5OyYjMTI1MTc7JiMxMjU0MDsiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYzNC4xNCwyMTMuNTksNjMzLjg0MzcsMjAzLjc0NTYsNjMxLjk3MjgsMjA5LjA4NDEsNjI2LjYzNDIsMjA3LjIxMzIsNjM0LjE0LDIxMy41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtaUEJGSWE5MTZDTnR5bklrMHItV0hRa1dmSDNqZWFNS0JHa2ExXzN4WGxvSmJjQTl0MTk0bDZNZmNFNllyQ2c3RVR4bnRoVGVQWklybzc4cnA3VC1TLVBtUGRSTnphQlh5NE84dDhMeVdxbzJRdjFUUzBWcTA5YTB6bzFKdWNfUEVrbjREWUVYVFJqMERZTzJrMzF3QndqS05iWkxPRGxIR3F0RFpjZjJ0UncyU2k4ODFqWUFIUUY3NmI3YmtEVjkxS3VVckZSUTVSenM5WVJJbkVMZV8tM3E5NlFqNmYxNVMxTnkxMXhRaEdhZVBpcHlNak1nUWhTYmJvLWNlZ1JkRmdqWUlOb2JNUEkyLTBxdXlxay1uTEpKbWo5UTNQOE5sZ2tSQW1JRXdycUVHMk5HX01nbmZ3S2tXcTVQaHZxVHpIRk1pbTlFVnctVmNZZXJxNWRkelZfcGEzX1ZaeEJabnh3czBVYjkxbEcxZ2V6eDdWMnZGeG02RVFqeTNCMWgxaDliRzd3MWgxbEdSQXlXeF9KbTRtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>React Native プロジェクトでは、以下のツールを使用します：</p>
<ul>
<li><strong>言語</strong>: TypeScript — 型安全性によりバグを減らし、開発効率を向上させます</li>
<li><strong>フレームワーク</strong>: React Native — iOS/Android のネイティブアプリを開発できます</li>
<li><strong>開発環境</strong>: Expo — React Native の開発を簡単に始められるツールセットです</li>
<li><strong>テストフレームワーク</strong>: Jest — React Native のデフォルトテストランナーです</li>
<li><strong>テストライブラリ</strong>: React Native Testing Library — コンポーネントのテストに使います</li>
<li><strong>静的解析</strong>: ESLint — コードの品質を保ちます</li>
<li><strong>フォーマッター</strong>: Prettier — コードを自動整形します</li>
<li><strong>バージョン管理</strong>: Git — コードの変更履歴を管理します</li>
</ul>
<h2 id="0">イテレーション 0: 開発環境のセットアップ<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<h3 id="_4">初めに<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、React Native での開発に必要な環境をセットアップします。良いコードを書き続けるためには、適切な開発環境が不可欠です。</p>
<p>エピソード1（TypeScript版）では、テスト駆動開発のゴールが <strong>動作するきれいなコード</strong> であることを学びました。では、良いコードを書き続けるためには何が必要になるでしょうか？それが<a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a>です。</p>
<blockquote>
<p>今日のソフトウェア開発の世界において絶対になければならない3つの技術的な柱があります。
三本柱と言ったり、三種の神器と言ったりしていますが、それらは</p>
<ul>
<li>バージョン管理</li>
<li>テスティング</li>
<li>自動化</li>
</ul>
<p>の3つです。</p>
<p>—  https://t-wada.hatenablog.jp/entry/clean-code-that-works</p>
</blockquote>
<p>本イテレーションでは、React Native プロジェクトでこれらの三種の神器を準備していきます。</p>
<h3 id="react-native_1">React Native プロジェクトの作成<a class="headerlink" href="#react-native_1" title="Permanent link">&para;</a></h3>
<p>まず、Expo を使って新しい React Native プロジェクトを作成します。Expo は React Native の開発を簡単に始められる優れたツールセットです。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npx<span class="w"> </span>create-expo-app<span class="w"> </span>puyo-puyo-game<span class="w"> </span>--template<span class="w"> </span>expo-template-blank-typescript
</code></pre></div>
<p>プロジェクトディレクトリに移動します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>puyo-puyo-game
</code></pre></div>
<p>作成されたプロジェクトの構造を確認しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>-la
</code></pre></div>
<p>以下のようなファイルとディレクトリが作成されています：</p>
<ul>
<li><code>App.tsx</code> — アプリケーションのエントリーポイント</li>
<li><code>package.json</code> — プロジェクトの依存関係と設定</li>
<li><code>tsconfig.json</code> — TypeScript の設定</li>
<li><code>app.json</code> — Expo の設定</li>
<li><code>node_modules/</code> — インストールされたパッケージ</li>
</ul>
<h3 id="_5">コミットメッセージ<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>バージョン管理の準備の前に、コミットメッセージの書き方について確認しておきましょう。</p>
<p>この書式は <a href="https://www.conventionalcommits.org/ja/">Conventional Commits</a>に従っています。具体的には、それぞれのコミットメッセージはヘッダ、ボディ、フッタで構成されています。ヘッダはタイプ、スコープ、タイトルというフォーマットで構成されています。</p>
<div class="highlight"><pre><span></span><code>&lt;タイプ&gt;(&lt;スコープ&gt;): &lt;タイトル&gt;
&lt;空行&gt;
&lt;ボディ&gt;
&lt;空行&gt;
&lt;フッタ&gt;
</code></pre></div>
<p>ヘッダは必須です。ヘッダのスコープは任意です。コミットメッセージの長さは50文字までにしてください。</p>
<p>コミットのタイプは次を用いて下さい。</p>
<ul>
<li>feat: A new feature (新しい機能)</li>
<li>fix: A bug fix (バグ修正)</li>
<li>docs: Documentation only changes (ドキュメント変更のみ)</li>
<li>style: Changes that do not affect the meaning of the code (コードに影響を与えない変更)</li>
<li>refactor: A code change that neither fixes a bug nor adds a feature (機能追加でもバグ修正でもないコード変更)</li>
<li>perf: A code change that improves performance (パフォーマンスを改善するコード変更)</li>
<li>test: Adding missing or correcting existing tests (存在しないテストの追加、または既存のテストの修正)</li>
<li>chore: Changes to the build process or auxiliary tools and libraries (ドキュメント生成のような、補助ツールやライブラリやビルドプロセスの変更)</li>
</ul>
<h3 id="git">Git リポジトリの初期化<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>バージョン管理のために Git リポジトリを初期化します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>init
$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: 初期プロジェクト作成&#39;</span>
</code></pre></div>
<p>これで最初のコミットが完了しました。</p>
<h3 id="_6">パッケージマネージャ<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>React Native プロジェクトでは、npm または yarn を使用してパッケージを管理します。Expo で作成したプロジェクトには、すでに <code>package.json</code> が含まれています。</p>
<p><code>package.json</code> を確認しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>package.json
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;puyo-puyo-game&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo/AppEntry.js&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;expo&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~51.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;expo-status-bar&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~1.12.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;18.2.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;react-native&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.74.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;@babel/core&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^7.20.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;@types/react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~18.2.45&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;typescript&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.1.3&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>これから開発に必要なスクリプトを追加していきます。</p>
<h3 id="_7">テスティングのセットアップ<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>React Native プロジェクトでは、Jest と React Native Testing Library を使ってテストを書きます。</p>
<p>必要なパッケージをインストールします。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>-D<span class="w"> </span>jest<span class="w"> </span>@testing-library/react-native<span class="w"> </span>@testing-library/jest-native<span class="w"> </span>@types/jest
</code></pre></div>
<p>Jest の設定ファイルを作成します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npx<span class="w"> </span>jest<span class="w"> </span>--init
</code></pre></div>
<p>以下の質問に答えます：</p>
<ul>
<li>Would you like to use Jest when running "test" script in "package.json"? › (Y/n) → <strong>Y</strong></li>
<li>Would you like to use Typescript for the configuration file? › (y/N) → <strong>Y</strong></li>
<li>Choose the test environment that will be used for testing › <strong>node</strong></li>
<li>Do you want Jest to add coverage reports? › (y/N) → <strong>Y</strong></li>
<li>Which provider should be used to instrument code for coverage? › <strong>v8</strong></li>
<li>Automatically clear mock calls, instances, contexts and results before every test? › (y/N) → <strong>Y</strong></li>
</ul>
<p><code>jest.config.ts</code> が作成されます。以下のように編集します。</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;jest&#39;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">preset</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">setupFilesAfterEnv</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;@testing-library/jest-native/extend-expect&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="nx">transformIgnorePatterns</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;node_modules/(?!((jest-)?react-native|@react-native(-community)?)|expo(nent)?|@expo(nent)?/.*|@expo-google-fonts/.*|react-navigation|@react-navigation/.*|@unimodules/.*|unimodules|sentry-expo|native-base|react-native-svg)&#39;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="kr">module</span><span class="nx">FileExtensions</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tsx&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;js&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jsx&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="nx">collectCoverageFrom</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;src/**/*.{ts,tsx}&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;!src/**/*.test.{ts,tsx}&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;!src/**/__tests__/**&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">coverageThreshold</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">global</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">branches</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">      </span><span class="nx">functions</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">      </span><span class="nx">lines</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">      </span><span class="nx">statements</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">config</span>
</code></pre></div>
<p><code>package.json</code> の <code>scripts</code> セクションにテストコマンドを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>シンプルなテストを作成して、セットアップが正しく動作することを確認します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>src/__tests__
$<span class="w"> </span>touch<span class="w"> </span>src/__tests__/example.test.ts
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/__tests__/example.test.ts</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should pass&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>テストが成功することを確認できたら、コミットします。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: テスティングフレームワークのセットアップ&#39;</span>
</code></pre></div>
<h3 id="_8">静的コード解析<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>良いコードを書き続けるためには、コードの品質を維持していく必要があります。TypeScript用の静的コード解析ツール ESLint を使って確認していきましょう。</p>
<p>ESLint と必要なプラグインをインストールします。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>-D<span class="w"> </span>eslint<span class="w"> </span>@typescript-eslint/parser<span class="w"> </span>@typescript-eslint/eslint-plugin<span class="w"> </span>eslint-plugin-react<span class="w"> </span>eslint-plugin-react-native
</code></pre></div>
<p>ESLint の設定ファイルを作成します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>.eslintrc.js
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">root</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parser</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;@typescript-eslint/parser&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parserOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ecmaVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">2021</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">ecmaFeatures</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jsx</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;react-native/react-native&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">es6</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">jest</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="k">extends</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;eslint:recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:@typescript-eslint/recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:react/recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:react-native/all&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">plugins</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;@typescript-eslint&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;react/react-in-jsx-scope&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// React 17+ では不要</span>
<span class="w">    </span><span class="s1">&#39;@typescript-eslint/no-unused-vars&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;complexity&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="p">}],</span><span class="w"> </span><span class="c1">// 循環的複雑度の制限</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">react</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;detect&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">}</span>
</code></pre></div>
<p>循環的複雑度（Cyclomatic complexity）は7で設定しておきます。</p>
<blockquote>
<p>循環的複雑度 (Cyclomatic complexity)
循環的複雑度(サイクロマティック複雑度)とは、ソフトウェア測定法の一つであり、コードがどれぐらい複雑であるかをメソッド単位で数値にして表す指標。</p>
</blockquote>
<p><code>package.json</code> にlintスクリプトを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint:fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx --fix&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ESLintを実行して確認します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>lint
</code></pre></div>
<p>自動修正できる部分は修正しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>lint:fix
</code></pre></div>
<p>セットアップができたのでコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: 静的コード解析セットアップ&#39;</span>
</code></pre></div>
<h3 id="_9">コードフォーマッタ<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>良いコードであるためにはフォーマットも大切な要素です。</p>
<blockquote>
<p>優れたソースコードは「目に優しい」ものでなければいけない。</p>
<p>— リーダブルコード</p>
</blockquote>
<p>Prettier を使ってコードフォーマットを統一します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>-D<span class="w"> </span>prettier<span class="w"> </span>eslint-config-prettier<span class="w"> </span>eslint-plugin-prettier
</code></pre></div>
<p>Prettier の設定ファイルを作成します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>.prettierrc.js
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">arrowParens</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;always&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">bracketSameLine</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nx">bracketSpacing</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">singleQuote</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">trailingComma</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;es5&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">semi</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nx">printWidth</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">  </span><span class="nx">tabWidth</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">  </span><span class="nx">useTabs</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p><code>.eslintrc.js</code> を更新して Prettier を統合します。</p>
<div class="highlight"><pre><span></span><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">root</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parser</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;@typescript-eslint/parser&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parserOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ecmaVersion</span><span class="o">:</span><span class="w"> </span><span class="mf">2021</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">ecmaFeatures</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jsx</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;react-native/react-native&#39;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">es6</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">jest</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="k">extends</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;eslint:recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:@typescript-eslint/recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:react/recommended&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:react-native/all&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;plugin:prettier/recommended&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Prettier を追加</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">plugins</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;@typescript-eslint&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;react/react-in-jsx-scope&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;@typescript-eslint/no-unused-vars&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;complexity&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="p">}],</span>
<span class="w">    </span><span class="s1">&#39;prettier/prettier&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Prettier のエラーを表示</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">react</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;detect&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">}</span>
</code></pre></div>
<p><code>package.json</code> にフォーマットスクリプトを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint:fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx --fix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --write .&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format:check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --check .&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>フォーマットを実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>format
</code></pre></div>
<p>フォーマットチェックを実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>format:check
</code></pre></div>
<p>セットアップができたのでコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: コードフォーマッタセットアップ&#39;</span>
</code></pre></div>
<h3 id="_10">コードカバレッジ<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>コードカバレッジは、テストがどれだけのコードをカバーしているかを示す指標です。Jest には標準でコードカバレッジ機能が含まれています。</p>
<p><code>jest.config.ts</code> にカバレッジの設定を追加します（すでに追加済み）。</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ... 他の設定 ...</span>
<span class="w">  </span><span class="nx">collectCoverageFrom</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;src/**/*.{ts,tsx}&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;!src/**/*.test.{ts,tsx}&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;!src/**/__tests__/**&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">coverageThreshold</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">global</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">branches</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">      </span><span class="nx">functions</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">      </span><span class="nx">lines</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">      </span><span class="nx">statements</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">}</span>
</code></pre></div>
<p>カバレッジレポートを生成します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>test:coverage
</code></pre></div>
<p>実行後に <code>coverage</code> ディレクトリが作成されます。<code>coverage/lcov-report/index.html</code> を開くとカバレッジ状況を確認できます。</p>
<p><code>.gitignore</code> にカバレッジディレクトリを追加します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;coverage/&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>.gitignore
</code></pre></div>
<p>セットアップが完了したらコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: コードカバレッジ設定&#39;</span>
</code></pre></div>
<h3 id="_11">タスクの自動化<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>良いコードを書くためのタスクをまとめて実行できるようにしましょう。React Native プロジェクトでは、npm scripts を使ってタスクを自動化できます。</p>
<p><code>package.json</code> に統合スクリプトを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;android&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --android&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --ios&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;web&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expo start --web&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;test:coverage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest --coverage&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lint:fix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint . --ext .ts,.tsx --fix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --write .&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;format:check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prettier --check .&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;check&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm run lint:fix &amp;&amp; npm run format &amp;&amp; npm run test&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;setup&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm install &amp;&amp; npm run check&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>check</code> スクリプトを実行すると、lint、format、testが順番に実行されます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>check
</code></pre></div>
<p>すべてのチェックが通ることを確認できたら、コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: タスクの自動化&#39;</span>
</code></pre></div>
<h3 id="_12">ファイル監視の設定<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>開発中はファイルの変更を監視して、自動的にテストを実行できると便利です。Jest にはwatch モードが標準で用意されています。</p>
<p>テストをwatch モードで実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>test:watch
</code></pre></div>
<p>これでファイルを編集するたびに、関連するテストが自動的に実行されます。</p>
<p>さらに自動化を進めたい場合は、<code>husky</code> と <code>lint-staged</code> を使って、Git コミット前に自動的にチェックを実行できます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>-D<span class="w"> </span>husky<span class="w"> </span>lint-staged
$<span class="w"> </span>npx<span class="w"> </span>husky<span class="w"> </span>init
</code></pre></div>
<p><code>.husky/pre-commit</code> ファイルを作成します。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env sh</span>
.<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">/_/husky.sh&quot;</span>

npx<span class="w"> </span>lint-staged
</code></pre></div>
<p><code>package.json</code> に lint-staged の設定を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;lint-staged&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;*.{ts,tsx}&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;eslint --fix&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prettier --write&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;jest --bail --findRelatedTests&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>これで、コミット前に自動的にlint、format、テストが実行されるようになります。</p>
<p>セットアップが完了したらコミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;chore: Git フックとファイル監視の設定&#39;</span>
</code></pre></div>
<h3 id="_13">まとめ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>これで <a href="https://t-wada.hatenablog.jp/entry/clean-code-that-works">ソフトウェア開発の三種の神器</a> の準備ができました：</p>
<ul>
<li>✅ <strong>バージョン管理</strong>: Git</li>
<li>✅ <strong>テスティング</strong>: Jest + React Native Testing Library</li>
<li>✅ <strong>自動化</strong>: npm scripts + husky + lint-staged</li>
</ul>
<p>次のイテレーションからは、この環境を使ってぷよぷよゲームの実装を進めていきます。開発を始める前に以下のコマンドを実行すれば、良いコードを書くための準備が整います：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>test:watch<span class="w">  </span><span class="c1"># テストを自動実行</span>
</code></pre></div>
<p>別のターミナルで開発サーバーを起動します：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>start<span class="w">  </span><span class="c1"># Expo 開発サーバーを起動</span>
</code></pre></div>
<p>では、次のイテレーションに進むとしましょう！</p>
<h2 id="1">イテレーション 1: ゲーム画面の表示<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲーム画面の表示」を実装します。</p>
<blockquote>
<p>イテレーション開発とは、ソフトウェアを小さな機能単位で繰り返し開発していく手法です。各イテレーションで計画、設計、実装、テスト、評価のサイクルを回すことで、リスクを早期に発見し、フィードバックを得ながら開発を進めることができます。</p>
<p>— Craig Larman 『アジャイル開発とスクラム』</p>
</blockquote>
<h3 id="_14">ユーザーストーリー<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲーム画面を表示できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、React Native でのゲーム表示の基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>TODOリストは、テスト駆動開発の重要なプラクティスの一つです。実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「ゲーム画面を表示できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ゲームの設定を管理するConfigクラスを実装する（画面サイズ、ぷよの大きさなど）</li>
<li>ゲーム画面コンポーネントを作成する（プレイヤーが視覚的にゲームを認識できるようにする）</li>
<li>ゲームステージを表示する（ぷよが配置される盤面を表示する）</li>
<li>ゲーム状態を管理するHookを作成する（ゲームの状態を保持・更新する）</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「Configクラス」から始めましょう！</p>
<h3 id="_15">テスト: ゲーム設定の管理<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>さて、TODOリストの最初のタスク「ゲームの設定を管理するConfigクラスを実装する」に取り掛かりましょう。テスト駆動開発では、まずテストを書くことから始めます。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、ゲームの設定を管理するConfigクラスをテストするコードを書いてみましょう。何をテストすべきでしょうか？ゲームの基本設定（画面サイズ、ぷよのサイズ、列数、行数など）が正しく設定されていることを確認する必要がありますね。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/__tests__/Config.test.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Config&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Config&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ゲームの基本設定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ステージの列数が6であること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">6</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ステージの行数が13であること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ぷよのサイズが40であること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">40</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ステージの幅が列数×ぷよサイズであること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageWidth</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ステージの高さが行数×ぷよサイズであること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageHeight</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>このテストでは、<code>Config</code>クラスが正しく設定値を保持していることを確認しています。具体的には、ステージの列数、行数、ぷよのサイズ、およびそれらから計算される幅と高さを検証しています。</p>
<h3 id="_16">実装: ゲーム設定の管理<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/models/__tests__/Config.test.ts
  ● Test suite failed to run

    Cannot find module &#39;../Config&#39; from &#39;src/models/__tests__/Config.test.ts&#39;
</code></pre></div>
<p>おっと！まだ<code>Config</code>クラスを実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<blockquote>
<p>失敗するテスト</p>
<p>テストが失敗することを確認してから実装に取り掛かろう。そうすれば、テストが正しく機能していることがわかる。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>では、テストが通るように最小限のコードを実装していきましょう。「最小限」というのがポイントです。この段階では、テストが通ることだけを目指して、必要最低限のコードを書きます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>src/models
$<span class="w"> </span>touch<span class="w"> </span>src/models/Config.ts
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/Config.ts</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">stageColumns</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">stageRows</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">13</span>
<span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">puyoSize</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">40</span>

<span class="w">  </span><span class="nx">get</span><span class="w"> </span><span class="nx">stageWidth</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoSize</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">get</span><span class="w"> </span><span class="nx">stageHeight</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puyoSize</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/models/__tests__/Config.test.ts
  Config
    ゲームの基本設定
      ✓ ステージの列数が6であること (2 ms)
      ✓ ステージの行数が13であること
      ✓ ぷよのサイズが40であること (1 ms)
      ✓ ステージの幅が列数×ぷよサイズであること
      ✓ ステージの高さが行数×ぷよサイズであること

Test Suites: 1 passed, 1 total
Tests:       5 passed, 5 total
</code></pre></div>
<p>テストが通りましたね！おめでとうございます。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム設定を管理するConfigクラスを実装&#39;</span>
</code></pre></div>
<h3 id="_17">解説: ゲーム設定の管理<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<blockquote>
<p>テストが通ったら、次はリファクタリングだ。でも、その前に少し立ち止まって、今書いたコードについて考えてみよう。</p>
<p>— Martin Fowler 『リファクタリング』</p>
</blockquote>
<p>実装したConfigクラスについて、少し解説しておきましょう。この処理では、主に以下のことを行っています：</p>
<ol>
<li>ゲームの基本設定値を定数として保持</li>
<li>計算プロパティ（getter）を使って、派生的な値を提供</li>
</ol>
<p>これにより、ゲームの設定が一元管理され、変更が容易になります。各設定値の意味を理解しておくと、今後の実装がスムーズになりますよ：</p>
<ul>
<li><strong>stageColumns</strong>: ステージの列数（横方向のぷよの配置数）</li>
<li><strong>stageRows</strong>: ステージの行数（縦方向のぷよの配置数）</li>
<li><strong>puyoSize</strong>: 1つのぷよの表示サイズ（ピクセル）</li>
<li><strong>stageWidth</strong>: ステージ全体の幅（計算プロパティ）</li>
<li><strong>stageHeight</strong>: ステージ全体の高さ（計算プロパティ）</li>
</ul>
<p>このように、設定を一箇所にまとめることで、後で調整が必要になったときも簡単に変更できます。</p>
<blockquote>
<p>単一責任の原則（SRP）：クラスを変更する理由は1つだけであるべき。</p>
<p>— Robert C. Martin 『Clean Architecture』</p>
</blockquote>
<h3 id="_18">テスト: ゲーム画面コンポーネント<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>次に、ゲーム画面を表示するコンポーネントのテストを書きます。React Native では、コンポーネントのテストに React Native Testing Library を使用します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/__tests__/GameScreen.test.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">render</span><span class="p">,</span><span class="w"> </span><span class="nx">screen</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameScreen</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../GameScreen&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;GameScreen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ゲーム画面が正しくレンダリングされること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">GameScreen</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getByTestId</span><span class="p">(</span><span class="s1">&#39;game-screen&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ゲームタイトルが表示されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">GameScreen</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;ぷよぷよゲーム&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ゲームステージが表示されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">GameScreen</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getByTestId</span><span class="p">(</span><span class="s1">&#39;game-stage&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>このテストでは、<code>GameScreen</code>コンポーネントが正しくレンダリングされることを確認しています。</p>
<h3 id="_19">実装: ゲーム画面コンポーネント<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>src/components
$<span class="w"> </span>touch<span class="w"> </span>src/components/GameScreen.tsx
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameScreen</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="w"> </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;game-screen&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span>
<span class="w">        </span><span class="nx">style</span><span class="o">=</span><span class="p">{[</span>
<span class="w">          </span><span class="nx">styles</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">config.stageWidth</span><span class="p">,</span>
<span class="w">            </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">config.stageHeight</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">        </span><span class="p">]}</span>
<span class="w">        </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;game-stage&quot;</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#f0f0f0&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#333&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/components/__tests__/GameScreen.test.tsx
  GameScreen
    ✓ ゲーム画面が正しくレンダリングされること (25 ms)
    ✓ ゲームタイトルが表示されること (8 ms)
    ✓ ゲームステージが表示されること (6 ms)

PASS  src/models/__tests__/Config.test.ts
</code></pre></div>
<p>テストが通りましたね！</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム画面コンポーネントを実装&#39;</span>
</code></pre></div>
<h3 id="_20">解説: ゲーム画面コンポーネント<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>さて、今回実装した「ゲーム画面コンポーネント」について少し詳しく解説しましょう。</p>
<p>React Native では、Web 版の HTML タグの代わりに、React Native 固有のコンポーネントを使用します：</p>
<ul>
<li><strong>View</strong>: HTML の <code>div</code> に相当するコンテナコンポーネント</li>
<li><strong>Text</strong>: HTML の <code>span</code> や <code>p</code> に相当するテキスト表示コンポーネント</li>
<li><strong>StyleSheet</strong>: CSS の代わりにスタイルを定義するAPI</li>
</ul>
<p><code>testID</code> プロパティは、テストでコンポーネントを識別するために使用します。これにより、テストコードから特定の要素を見つけることができます。</p>
<p>このコンポーネントが基盤となって、これから様々な機能を追加していきますよ！</p>
<h3 id="apptsx">App.tsxの更新<a class="headerlink" href="#apptsx" title="Permanent link">&para;</a></h3>
<p>最後に、作成した GameScreen コンポーネントを App.tsx から表示できるようにしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// App.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameScreen</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./src/components/GameScreen&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">GameScreen</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="p">}</span>
</code></pre></div>
<p>これで、アプリを起動すると、ゲーム画面が表示されるようになります。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>start
</code></pre></div>
<p>Expo Go アプリや、エミュレータ/シミュレータでアプリを起動して、ゲーム画面が表示されることを確認しましょう。</p>
<p>確認できたら、コミットしておきます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: App.tsxでGameScreenを表示&#39;</span>
</code></pre></div>
<h3 id="_21">まとめ<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下のことを実現しました：</p>
<ul>
<li>✅ ゲームの設定を管理するConfigクラスの実装</li>
<li>✅ ゲーム画面を表示するGameScreenコンポーネントの実装</li>
<li>✅ React Native Testing Library を使用したコンポーネントテスト</li>
<li>✅ テスト駆動開発のサイクル（Red-Green-Refactor）の実践</li>
</ul>
<p>次のイテレーションでは、ゲームステージにぷよを表示する機能を実装していきます。楽しみですね！</p>
<h2 id="2">イテレーション 2: ぷよの表示<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲーム画面の基本構造ができましたね。「ゲーム画面はできたけど、肝心のぷよが表示されないと始まらないですよね？」そうです！今回は、ぷよを画面に表示する機能を実装していきましょう！</p>
<blockquote>
<p>複雑なシステムは小さな部品の組み合わせから生まれます。一つ一つの部品を丁寧に作り、テストし、組み合わせていくことで、確実に動作するシステムを構築できます。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_22">ユーザーストーリー<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームステージにぷよを表示できる</p>
</blockquote>
<p>「ぷよってどんな見た目なんですか？」ぷよぷよゲームでは、カラフルな丸いキャラクター（ぷよ）が画面に表示されます。今回は、異なる色のぷよを React Native のコンポーネントとして実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。</p>
<blockquote>
<p>TODOリストは、大きな問題を小さな問題に分割するための強力なツールです。複雑な問題に直面したとき、それを管理可能な小さなタスクに分解することで、一歩一歩確実に前進できます。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ぷよを表示する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの色を定義する（赤、青、緑、黄色など）</li>
<li>ぷよモデルクラスを作成する（ぷよの色、位置などの情報を保持する）</li>
<li>ぷよコンポーネントを作成する（ぷよを画面に描画する）</li>
<li>ステージコンポーネントを更新する（ぷよを配置・表示する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_23">テスト: ぷよの色定義<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの色を定義する部分からテストしていきましょう。ぷよには異なる色があり、それぞれを識別できる必要がありますね。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/__tests__/PuyoColor.test.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">,</span><span class="w"> </span><span class="nx">getPuyoColorStyle</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../PuyoColor&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;PuyoColor&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの色定義&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;EMPTYは0であること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;REDは1であること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;BLUEは2であること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;GREENは3であること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">GREEN</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;YELLOWは4であること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">YELLOW</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの色スタイル&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;REDの場合、赤色のスタイルが返されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPuyoColorStyle</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;#ff4444&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;BLUEの場合、青色のスタイルが返されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPuyoColorStyle</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;#4444ff&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;EMPTYの場合、透明なスタイルが返されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPuyoColorStyle</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;transparent&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>このテストでは、ぷよの色の定義と、各色に対応するスタイルが正しく取得できることを確認しています。</p>
<h3 id="_24">実装: ぷよの色定義<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/models/__tests__/PuyoColor.test.ts
  ● Test suite failed to run

    Cannot find module &#39;../PuyoColor&#39; from &#39;src/models/__tests__/PuyoColor.test.ts&#39;
</code></pre></div>
<p>おっと！まだ<code>PuyoColor</code>を実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。テストが失敗することを確認できました。</p>
<p>では、テストが通るように最小限のコードを実装していきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>src/models/PuyoColor.ts
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/models/PuyoColor.ts</span>
<span class="k">export</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">EMPTY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">  </span><span class="nx">RED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">  </span><span class="nx">BLUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">  </span><span class="nx">GREEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">  </span><span class="nx">YELLOW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">ColorStyle</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">getPuyoColorStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">ColorStyle</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">PuyoColor.RED</span><span class="o">:</span>
<span class="w">      </span><span class="kt">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ff4444&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">PuyoColor.BLUE</span><span class="o">:</span>
<span class="w">      </span><span class="kt">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#4444ff&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">PuyoColor.GREEN</span><span class="o">:</span>
<span class="w">      </span><span class="kt">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#44ff44&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">PuyoColor.YELLOW</span><span class="o">:</span>
<span class="w">      </span><span class="kt">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ffff44&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">PuyoColor.EMPTY</span><span class="o">:</span>
<span class="w">    </span><span class="kt">default</span><span class="o">:</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transparent&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/models/__tests__/PuyoColor.test.ts
  PuyoColor
    ぷよの色定義
      ✓ EMPTYは0であること (2 ms)
      ✓ REDは1であること
      ✓ BLUEは2であること (1 ms)
      ✓ GREENは3であること
      ✓ YELLOWは4であること
    ぷよの色スタイル
      ✓ REDの場合、赤色のスタイルが返されること (1 ms)
      ✓ BLUEの場合、青色のスタイルが返されること
      ✓ EMPTYの場合、透明なスタイルが返されること
</code></pre></div>
<p>テストが通りましたね！</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの色定義を実装&#39;</span>
</code></pre></div>
<h3 id="_25">解説: ぷよの色定義<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>今回実装した「ぷよの色定義」について少し詳しく解説しましょう。</p>
<p>TypeScript の <code>enum</code>（列挙型）を使って、ぷよの色を定義しています。これにより、コード内で「1」「2」のような数値ではなく、<code>PuyoColor.RED</code>、<code>PuyoColor.BLUE</code> のような意味のある名前で色を扱えます。</p>
<p>また、<code>getPuyoColorStyle</code> 関数では、ぷよの色に対応する React Native のスタイルオブジェクトを返しています。これにより、後でぷよを描画する際に、適切な色を簡単に適用できます。</p>
<blockquote>
<p>マジックナンバーを避ける</p>
<p>コード内に直接数値を書くのではなく、意味のある名前をつけた定数や列挙型を使いましょう。これにより、コードの可読性が向上し、変更も容易になります。</p>
<p>— Robert C. Martin 『Clean Code』</p>
</blockquote>
<h3 id="_26">テスト: ぷよコンポーネント<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>次に、ぷよを画面に描画するコンポーネントのテストを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/__tests__/Puyo.test.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">render</span><span class="p">,</span><span class="w"> </span><span class="nx">screen</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Puyo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Puyo&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/PuyoColor&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/Config&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Puyo&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ぷよが正しくレンダリングされること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">Puyo</span><span class="w"> </span><span class="nx">color</span><span class="o">=</span><span class="p">{</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">}</span><span class="w"> </span><span class="nx">size</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getByTestId</span><span class="p">(</span><span class="s1">&#39;puyo&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;赤いぷよの背景色が正しく設定されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getByTestId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Puyo</span><span class="w"> </span><span class="nx">color</span><span class="o">=</span><span class="p">{</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">}</span><span class="w"> </span><span class="nx">size</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getByTestId</span><span class="p">(</span><span class="s1">&#39;puyo&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">style</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">(</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">.</span><span class="nx">objectContaining</span><span class="p">({</span>
<span class="w">        </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ff4444&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;指定されたサイズでぷよが表示されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getByTestId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Puyo</span><span class="w"> </span><span class="nx">color</span><span class="o">=</span><span class="p">{</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">}</span><span class="w"> </span><span class="nx">size</span><span class="o">=</span><span class="p">{</span><span class="mf">40</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getByTestId</span><span class="p">(</span><span class="s1">&#39;puyo&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">style</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">(</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">.</span><span class="nx">objectContaining</span><span class="p">({</span>
<span class="w">        </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">40</span><span class="p">,</span>
<span class="w">        </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">40</span><span class="p">,</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;EMPTYの場合、透明なぷよが表示されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getByTestId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Puyo</span><span class="w"> </span><span class="nx">color</span><span class="o">=</span><span class="p">{</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">}</span><span class="w"> </span><span class="nx">size</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getByTestId</span><span class="p">(</span><span class="s1">&#39;puyo&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">style</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">(</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">.</span><span class="nx">objectContaining</span><span class="p">({</span>
<span class="w">        </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transparent&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>このテストでは、<code>Puyo</code>コンポーネントが正しくレンダリングされ、適切な色とサイズが適用されることを確認しています。</p>
<h3 id="_27">実装: ぷよコンポーネント<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、テストが通るように最小限のコードを実装します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>src/components/Puyo.tsx
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/Puyo.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">,</span><span class="w"> </span><span class="nx">getPuyoColorStyle</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">PuyoProps</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">Puyo</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="o">&lt;</span><span class="nx">PuyoProps</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">colorStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPuyoColorStyle</span><span class="p">(</span><span class="nx">color</span><span class="p">)</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span>
<span class="w">      </span><span class="nx">style</span><span class="o">=</span><span class="p">{[</span>
<span class="w">        </span><span class="nx">styles</span><span class="p">.</span><span class="nx">puyo</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">size</span><span class="p">,</span>
<span class="w">          </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">size</span><span class="p">,</span>
<span class="w">          </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">colorStyle</span><span class="p">,</span>
<span class="w">      </span><span class="p">]}</span>
<span class="w">      </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;puyo&quot;</span>
<span class="w">    </span><span class="o">/&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">puyo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">borderWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#333&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/components/__tests__/Puyo.test.tsx
  Puyo
    ✓ ぷよが正しくレンダリングされること (20 ms)
    ✓ 赤いぷよの背景色が正しく設定されること (5 ms)
    ✓ 指定されたサイズでぷよが表示されること (4 ms)
    ✓ EMPTYの場合、透明なぷよが表示されること (3 ms)
</code></pre></div>
<p>テストが通りましたね！</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよコンポーネントを実装&#39;</span>
</code></pre></div>
<h3 id="_28">解説: ぷよコンポーネント<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>今回実装した「ぷよコンポーネント」について解説しましょう。</p>
<p>ぷよコンポーネントは、<code>View</code>コンポーネントを使って円形のぷよを描画しています。<code>borderRadius</code>を<code>size / 2</code>に設定することで、正方形のViewを円形に表示しています。</p>
<p>また、<code>StyleSheet.create</code>で定義した基本スタイルと、プロパティから渡された色やサイズを組み合わせることで、柔軟にぷよの見た目を変更できるようになっています。</p>
<h3 id="_29">テスト: ステージコンポーネントの更新<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>最後に、ステージにぷよを配置・表示する機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/__tests__/Stage.test.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">render</span><span class="p">,</span><span class="w"> </span><span class="nx">screen</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/PuyoColor&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/Config&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Stage&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ステージが正しくレンダリングされること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">    </span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">Stage</span><span class="w"> </span><span class="nx">grid</span><span class="o">=</span><span class="p">{</span><span class="nx">grid</span><span class="p">}</span><span class="w"> </span><span class="nx">config</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getByTestId</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;グリッドの各セルにぷよが配置されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">[</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">],</span>
<span class="w">      </span><span class="p">[</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">GREEN</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">YELLOW</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">],</span>
<span class="w">    </span><span class="p">]</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAllByTestId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Stage</span><span class="w"> </span><span class="nx">grid</span><span class="o">=</span><span class="p">{</span><span class="nx">grid</span><span class="p">}</span><span class="w"> </span><span class="nx">config</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAllByTestId</span><span class="p">(</span><span class="s1">&#39;puyo&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// 2行 × 3列 = 6個のぷよがレンダリングされる</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">puyos</span><span class="p">).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mf">6</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_30">実装: ステージコンポーネントの更新<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、実装していきます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>src/components/Stage.tsx
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/Stage.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Puyo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Puyo&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">StageProps</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span>
<span class="w">  </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">Stage</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="o">&lt;</span><span class="nx">StageProps</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span>
<span class="w">      </span><span class="nx">style</span><span class="o">=</span><span class="p">{[</span>
<span class="w">        </span><span class="nx">styles</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">config.stageWidth</span><span class="p">,</span>
<span class="w">          </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">config.stageHeight</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">]}</span>
<span class="w">      </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;stage&quot;</span>
<span class="w">    </span><span class="o">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">rowIndex</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">rowIndex</span><span class="p">}</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">row</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">row</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="nx">colIndex</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="o">&lt;</span><span class="nx">Puyo</span>
<span class="w">              </span><span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="sb">`</span><span class="si">${</span><span class="nx">rowIndex</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">colIndex</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span>
<span class="w">              </span><span class="nx">color</span><span class="o">=</span><span class="p">{</span><span class="nx">color</span><span class="p">}</span>
<span class="w">              </span><span class="nx">size</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">.</span><span class="nx">puyoSize</span><span class="p">}</span>
<span class="w">            </span><span class="o">/&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">      </span><span class="p">))}</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">borderWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#333&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#f0f0f0&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">row</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flexDirection</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;row&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/components/__tests__/Stage.test.tsx
  Stage
    ✓ ステージが正しくレンダリングされること (18 ms)
    ✓ グリッドの各セルにぷよが配置されること (12 ms)
</code></pre></div>
<p>テストが通りましたね！</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ステージコンポーネントにぷよ表示機能を追加&#39;</span>
</code></pre></div>
<h3 id="gamescreen">GameScreenコンポーネントの更新<a class="headerlink" href="#gamescreen" title="Permanent link">&para;</a></h3>
<p>最後に、GameScreenコンポーネントを更新して、実際にぷよが表示されるようにしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameScreen</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>

<span class="w">  </span><span class="c1">// サンプルのグリッドデータ（実際のゲームでは状態管理が必要）</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sampleGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">rowIndex</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">      </span><span class="nb">Array</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">colIndex</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// 下の方にいくつかぷよを配置</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rowIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">GREEN</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">YELLOW</span><span class="p">][</span>
<span class="w">              </span><span class="p">(</span><span class="nx">rowIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">colIndex</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">4</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="w"> </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;game-screen&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Stage</span><span class="w"> </span><span class="nx">grid</span><span class="o">=</span><span class="p">{</span><span class="nx">sampleGrid</span><span class="p">}</span><span class="w"> </span><span class="nx">config</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>アプリを起動して確認しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>start
</code></pre></div>
<p>Expo Go アプリや、エミュレータ/シミュレータでアプリを起動して、ステージ下部にカラフルなぷよが表示されることを確認しましょう。</p>
<p>確認できたら、コミットしておきます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: GameScreenにぷよを表示&#39;</span>
</code></pre></div>
<h3 id="_31">まとめ<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下のことを実現しました：</p>
<ul>
<li>✅ ぷよの色定義（PuyoColor enum）の実装</li>
<li>✅ ぷよコンポーネントの作成（円形のぷよを描画）</li>
<li>✅ ステージコンポーネントの更新（グリッドにぷよを配置）</li>
<li>✅ GameScreenでのぷよ表示</li>
<li>✅ テスト駆動開発のサイクル（Red-Green-Refactor）の実践</li>
</ul>
<p>次のイテレーションでは、タッチ操作でぷよを移動できる機能を実装していきます。モバイルゲームらしい操作性を追加していきましょう！</p>
<h2 id="3">イテレーション 3: タッチ操作でのぷよの移動<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでぷよを表示できるようになりましたね。「見えるようになったけど、動かせないとゲームになりませんよね？」そうです！今回は、タッチ操作でぷよを移動できるようにしていきましょう！</p>
<blockquote>
<p>インタラクティブなシステムを作るときは、ユーザーの入力を受け取り、システムの状態を更新し、その結果を表示するというサイクルを実装します。このサイクルを正しく実装することで、ユーザーに快適な操作感を提供できます。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_32">ユーザーストーリー<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、タッチ操作で落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「モバイルゲームだから、タッチで操作できるようにするんですね！」そうです！React Native では、ボタンやジェスチャーを使って直感的な操作を実現できます。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。</p>
<blockquote>
<p>TODOリストは、大きな問題を小さな問題に分割するための強力なツールです。複雑な問題に直面したとき、それを管理可能な小さなタスクに分解することで、一歩一歩確実に前進できます。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「タッチ操作でぷよを移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲーム状態を管理する Hook を作成する（落下中のぷよの位置、グリッドの状態など）</li>
<li>操作ボタンコンポーネントを作成する（左移動、右移動、回転、落下ボタン）</li>
<li>ボタン押下時の移動処理を実装する（ぷよの位置を更新する）</li>
<li>移動可能かどうかのチェックを実装する（画面の端や他のぷよとの衝突判定）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_33">テスト: ゲーム状態管理<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームの状態を管理する部分からテストしていきましょう。React では、Custom Hook を使って状態管理を行うのが一般的です。</p>
<blockquote>
<p>テストファースト</p>
<p>いつテストを書くべきだろうか——それはテスト対象のコードを書く前だ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/__tests__/useGameState.test.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">,</span><span class="w"> </span><span class="nx">act</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react-hooks&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../useGameState&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/PuyoColor&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/Config&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;useGameState&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;初期状態で空のグリッドが作成されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">grid</span><span class="p">).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="mf">0</span><span class="p">]).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="mf">0</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;初期状態で落下中のぷよが作成されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBeGreaterThanOrEqual</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBeLessThan</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">color</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの移動&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;moveLeftを呼ぶと、ぷよが左に移動すること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span>

<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;moveRightを呼ぶと、ぷよが右に移動すること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span>

<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialX</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左端にいる場合、左に移動できないこと&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">      </span><span class="c1">// 左端まで移動</span>
<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// さらに左に移動しようとする</span>
<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveLeft</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右端にいる場合、右に移動できないこと&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">      </span><span class="c1">// 右端まで移動</span>
<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// さらに右に移動しようとする</span>
<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">moveRight</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>このテストでは、<code>useGameState</code> Hook が正しくゲーム状態を管理し、ぷよの移動処理が適切に動作することを確認しています。</p>
<h3 id="_34">実装: ゲーム状態管理<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、次に実行してみましょう。どうなるでしょうか？</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/hooks/__tests__/useGameState.test.ts
  ● Test suite failed to run

    Cannot find module &#39;../useGameState&#39; from &#39;src/hooks/__tests__/useGameState.test.ts&#39;
</code></pre></div>
<p>おっと！まだ<code>useGameState</code> Hook を実装していないので、当然エラーになりますね。これがテスト駆動開発の「Red（赤）」の状態です。</p>
<p>では、テストが通るように最小限のコードを実装していきましょう。</p>
<p>まず、必要なパッケージをインストールします。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>-D<span class="w"> </span>@testing-library/react-hooks
</code></pre></div>
<p>次に、Hook を実装します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>src/hooks
$<span class="w"> </span>touch<span class="w"> </span>src/hooks/useGameState.ts
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/useGameState.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useCallback</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">FallingPuyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span>
<span class="w">  </span><span class="nx">fallingPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">FallingPuyo</span>
<span class="w">  </span><span class="nx">moveLeft</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">moveRight</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">createEmptyGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">columns</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">columns</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">createRandomPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">columns</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">FallingPuyo</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">GREEN</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">YELLOW</span><span class="p">]</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">randomColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.floor</span><span class="p">(</span><span class="nx">columns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span>
<span class="w">    </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">randomColor</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">setGrid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createEmptyGrid</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">setFallingPuyo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">FallingPuyo</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">prev.x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">prev.x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fallingPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveLeft</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveRight</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/hooks/__tests__/useGameState.test.ts
  useGameState
    ✓ 初期状態で空のグリッドが作成されること (15 ms)
    ✓ 初期状態で落下中のぷよが作成されること (3 ms)
    ぷよの移動
      ✓ moveLeftを呼ぶと、ぷよが左に移動すること (5 ms)
      ✓ moveRightを呼ぶと、ぷよが右に移動すること (4 ms)
      ✓ 左端にいる場合、左に移動できないこと (3 ms)
      ✓ 右端にいる場合、右に移動できないこと (4 ms)
</code></pre></div>
<p>テストが通りましたね！</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲーム状態管理Hookを実装&#39;</span>
</code></pre></div>
<h3 id="_35">解説: ゲーム状態管理<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>今回実装した「ゲーム状態管理 Hook」について解説しましょう。</p>
<p>React の Custom Hook を使うことで、コンポーネントから状態管理のロジックを分離できます。これにより、以下のメリットがあります：</p>
<ul>
<li><strong>テストの容易性</strong>: Hook 単体でテストできる</li>
<li><strong>再利用性</strong>: 複数のコンポーネントから同じロジックを使える</li>
<li><strong>関心の分離</strong>: UI とロジックを分離できる</li>
</ul>
<p><code>useCallback</code> を使って関数をメモ化することで、不要な再レンダリングを防いでいます。</p>
<blockquote>
<p>Custom Hooks</p>
<p>Custom Hooks は、コンポーネント間でロジックを共有する強力な方法です。useState や useEffect などの組み込み Hook を組み合わせて、独自の Hook を作成できます。</p>
<p>— React 公式ドキュメント</p>
</blockquote>
<h3 id="_36">テスト: 操作ボタンコンポーネント<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>次に、タッチ操作用のボタンコンポーネントのテストを書きます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/__tests__/GameControls.test.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">render</span><span class="p">,</span><span class="w"> </span><span class="nx">fireEvent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameControls</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../GameControls&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;GameControls&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;操作ボタンが正しくレンダリングされること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getByText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameControls</span>
<span class="w">        </span><span class="nx">onMoveLeft</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">        </span><span class="nx">onMoveRight</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">        </span><span class="nx">onRotate</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">        </span><span class="nx">onDrop</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;←&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;→&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;↻&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;↓&#39;</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;左ボタンを押すとonMoveLeftが呼ばれること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">onMoveLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getByText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameControls</span>
<span class="w">        </span><span class="nx">onMoveLeft</span><span class="o">=</span><span class="p">{</span><span class="nx">onMoveLeft</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onMoveRight</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">        </span><span class="nx">onRotate</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">        </span><span class="nx">onDrop</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nx">fireEvent</span><span class="p">.</span><span class="nx">press</span><span class="p">(</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;←&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">onMoveLeft</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;右ボタンを押すとonMoveRightが呼ばれること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">onMoveRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getByText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">render</span><span class="p">(</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameControls</span>
<span class="w">        </span><span class="nx">onMoveLeft</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">        </span><span class="nx">onMoveRight</span><span class="o">=</span><span class="p">{</span><span class="nx">onMoveRight</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onRotate</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">        </span><span class="nx">onDrop</span><span class="o">=</span><span class="p">{</span><span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nx">fireEvent</span><span class="p">.</span><span class="nx">press</span><span class="p">(</span><span class="nx">getByText</span><span class="p">(</span><span class="s1">&#39;→&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">onMoveRight</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_37">実装: 操作ボタンコンポーネント<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>テストが失敗することを確認したら、実装していきます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>src/components/GameControls.tsx
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameControls.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">TouchableOpacity</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">GameControlsProps</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">onMoveLeft</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">onMoveRight</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">onRotate</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">onDrop</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameControls</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="o">&lt;</span><span class="nx">GameControlsProps</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="nx">onMoveLeft</span><span class="p">,</span>
<span class="w">  </span><span class="nx">onMoveRight</span><span class="p">,</span>
<span class="w">  </span><span class="nx">onRotate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">onDrop</span><span class="p">,</span>
<span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">row</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">onMoveLeft</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">←</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">onMoveRight</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">→</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">row</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">onRotate</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">↻</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">onDrop</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">↓</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">row</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flexDirection</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;row&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginVertical</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">button</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#4CAF50&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">paddingHorizontal</span><span class="o">:</span><span class="w"> </span><span class="kt">30</span><span class="p">,</span>
<span class="w">    </span><span class="nx">paddingVertical</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginHorizontal</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">minWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">buttonText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/components/__tests__/GameControls.test.tsx
  GameControls
    ✓ 操作ボタンが正しくレンダリングされること (22 ms)
    ✓ 左ボタンを押すとonMoveLeftが呼ばれること (8 ms)
    ✓ 右ボタンを押すとonMoveRightが呼ばれること (6 ms)
</code></pre></div>
<p>テストが通りましたね！</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 操作ボタンコンポーネントを実装&#39;</span>
</code></pre></div>
<h3 id="gamescreen_1">GameScreenコンポーネントの更新<a class="headerlink" href="#gamescreen_1" title="Permanent link">&para;</a></h3>
<p>最後に、GameScreenコンポーネントを更新して、ゲーム状態と操作ボタンを統合しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useMemo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameControls</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./GameControls&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../hooks/useGameState&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameScreen</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">moveLeft</span><span class="p">,</span><span class="w"> </span><span class="nx">moveRight</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// グリッドに落下中のぷよを合成</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">displayGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useMemo</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">color</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleRotate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TODO: 回転機能は次のイテレーションで実装</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Rotate&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleDrop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TODO: 落下機能は次のイテレーションで実装</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Drop&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="w"> </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;game-screen&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Stage</span><span class="w"> </span><span class="nx">grid</span><span class="o">=</span><span class="p">{</span><span class="nx">displayGrid</span><span class="p">}</span><span class="w"> </span><span class="nx">config</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameControls</span>
<span class="w">        </span><span class="nx">onMoveLeft</span><span class="o">=</span><span class="p">{</span><span class="nx">moveLeft</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onMoveRight</span><span class="o">=</span><span class="p">{</span><span class="nx">moveRight</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onRotate</span><span class="o">=</span><span class="p">{</span><span class="nx">handleRotate</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onDrop</span><span class="o">=</span><span class="p">{</span><span class="nx">handleDrop</span><span class="p">}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>アプリを起動して確認しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>start
</code></pre></div>
<p>Expo Go アプリや、エミュレータ/シミュレータでアプリを起動して、左右のボタンをタップするとぷよが移動することを確認しましょう。</p>
<p>確認できたら、コミットしておきます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: タッチ操作でぷよを移動できるように統合&#39;</span>
</code></pre></div>
<h3 id="_38">まとめ<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下のことを実現しました：</p>
<ul>
<li>✅ ゲーム状態管理 Hook（useGameState）の実装</li>
<li>✅ タッチ操作用のボタンコンポーネント（GameControls）の作成</li>
<li>✅ ぷよの左右移動ロジックの実装</li>
<li>✅ 画面端での移動制限</li>
<li>✅ GameScreen での状態管理とUI の統合</li>
<li>✅ テスト駆動開発のサイクル（Red-Green-Refactor）の実践</li>
</ul>
<p>次のイテレーションでは、ぷよの回転機能と自動落下機能を実装していきます。ゲームらしさが増していきますよ！</p>
<h2 id="4">イテレーション 4: ぷよの回転と自動落下<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでぷよを左右に移動できるようになりましたね。「移動できるようになったけど、まだゲームとして物足りないですよね？」そうです！今回は、ぷよの回転機能と自動落下機能を実装して、よりゲームらしくしていきましょう！</p>
<blockquote>
<p>ゲーム開発では、基本的な操作を一つずつ追加していくことで、複雑なゲームプレイを実現します。各機能を独立してテストできるように設計することで、バグを減らし、保守性を高めることができます。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_39">ユーザーストーリー<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる
プレイヤーとして、ぷよが自動的に落下するのを見ることができる</p>
</blockquote>
<p>「2つのストーリーを一度に実装するんですか？」今回は関連性の高い機能なので、一緒に実装していきます。回転と落下は、ぷよぷよゲームの核となる動きですからね。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。</p>
<blockquote>
<p>TODOリストは、大きな問題を小さな問題に分割するための強力なツールです。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ぷよの回転と自動落下」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの回転処理を実装する（90度時計回りに回転）</li>
<li>2つのぷよを管理する構造に変更する（軸ぷよと子ぷよ）</li>
<li>自動落下タイマーを実装する（一定時間ごとに下に移動）</li>
<li>着地判定を実装する（他のぷよや床に接触したら停止）</li>
<li>次のぷよを生成する処理を実装する</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。</p>
<h3 id="2_1">テスト: 2つのぷよの管理<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよぷよゲームの特徴である「2つのぷよが連なって落ちてくる」という仕組みをテストしていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/__tests__/useGameState.test.ts（追加）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;2つのぷよの管理&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;fallingPuyoが軸ぷよと子ぷよの2つを持つこと&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">main</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">()</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">color</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">color</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;子ぷよは軸ぷよの上に配置されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ぷよの回転&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;rotateを呼ぶと、子ぷよが時計回りに90度回転すること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">    </span><span class="c1">// 初期状態: 子ぷよは上 (dx=0, dy=-1)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 1回回転: 子ぷよは右 (dx=1, dy=0)</span>
<span class="w">    </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">rotate</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 2回回転: 子ぷよは下 (dx=0, dy=1)</span>
<span class="w">    </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">rotate</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 3回回転: 子ぷよは左 (dx=-1, dy=0)</span>
<span class="w">    </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">rotate</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 4回回転: 子ぷよは上に戻る (dx=0, dy=-1)</span>
<span class="w">    </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">rotate</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="2_2">実装: 2つのぷよの管理と回転<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<p>テストを書いたら、実装していきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/useGameState.ts（更新）</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">PuyoUnit</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">  </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 相対X座標</span>
<span class="w">  </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 相対Y座標</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">FallingPuyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 軸ぷよのX座標</span>
<span class="w">  </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 軸ぷよのY座標</span>
<span class="w">  </span><span class="nx">main</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoUnit</span><span class="w"> </span><span class="c1">// 軸ぷよ</span>
<span class="w">  </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoUnit</span><span class="w"> </span><span class="c1">// 子ぷよ</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span>
<span class="w">  </span><span class="nx">fallingPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">FallingPuyo</span>
<span class="w">  </span><span class="nx">moveLeft</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">moveRight</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">rotate</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">drop</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">createEmptyGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">columns</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">columns</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">getRandomColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">GREEN</span><span class="p">,</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">YELLOW</span><span class="p">]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">createRandomPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">columns</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">FallingPuyo</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.floor</span><span class="p">(</span><span class="nx">columns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span>
<span class="w">    </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">main</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">getRandomColor</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">getRandomColor</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// 子ぷよは初期状態で上に配置</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">setGrid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createEmptyGrid</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">setFallingPuyo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">FallingPuyo</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 軸ぷよと子ぷよの両方が移動可能かチェック</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">canMove</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">newX</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 軸ぷよと子ぷよの両方が移動可能かチェック</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">canMove</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">newX</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rotate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 時計回りに90度回転: (dx, dy) → (-dy, dx)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newDx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>

<span class="w">      </span><span class="c1">// 回転後の位置が範囲内かチェック</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newSubX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">newDx</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newSubX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">newSubX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">          </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">...</span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">,</span>
<span class="w">            </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">newDx</span><span class="p">,</span>
<span class="w">            </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">newDy</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">drop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TODO: 高速落下処理</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Drop&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fallingPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveLeft</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveRight</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rotate</span><span class="p">,</span>
<span class="w">    </span><span class="nx">drop</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>テストを実行して確認します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 2つのぷよの管理と回転機能を実装&#39;</span>
</code></pre></div>
<h3 id="_40">テスト: 自動落下<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>次に、ぷよが自動的に落下する機能をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/__tests__/useGameState.test.ts（追加）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;自動落下&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">jest</span><span class="p">.</span><span class="nx">useFakeTimers</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">afterEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">jest</span><span class="p">.</span><span class="nx">useRealTimers</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;一定時間ごとにぷよが下に移動すること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">initialY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span>

<span class="w">    </span><span class="c1">// 1秒経過</span>
<span class="w">    </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jest</span><span class="p">.</span><span class="nx">advanceTimersByTime</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="nx">initialY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;床に到達したらぷよが固定されること&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">    </span><span class="c1">// ぷよを床の直前まで移動</span>
<span class="w">    </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jest</span><span class="p">.</span><span class="nx">advanceTimersByTime</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">beforeY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span>

<span class="w">    </span><span class="c1">// さらに1秒経過させて床に到達</span>
<span class="w">    </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jest</span><span class="p">.</span><span class="nx">advanceTimersByTime</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="c1">// 新しいぷよが生成されているはず</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">toBeLessThan</span><span class="p">(</span><span class="nx">beforeY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="_41">実装: 自動落下<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<p>自動落下機能を実装します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/useGameState.ts（更新）</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">setGrid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createEmptyGrid</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">setFallingPuyo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">FallingPuyo</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 自動落下処理</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fallInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>

<span class="w">        </span><span class="c1">// 床または既存のぷよに到達したかチェック</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">isMainAtBottom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">isSubAtBottom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isMainAtBottom</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">isSubAtBottom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// ぷよをグリッドに固定</span>
<span class="w">          </span><span class="nx">setGrid</span><span class="p">((</span><span class="nx">currentGrid</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentGrid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">color</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">subY</span><span class="p">][</span><span class="nx">subX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">color</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="w">          </span><span class="p">})</span>

<span class="w">          </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">newY</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="c1">// 1秒ごとに落下</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">fallInterval</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">canMove</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">newX</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">canMove</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">newX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">newX</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rotate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newDx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newSubX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">newDx</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newSubX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">newSubX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">          </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">...</span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">,</span>
<span class="w">            </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">newDx</span><span class="p">,</span>
<span class="w">            </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">newDy</span><span class="p">,</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">drop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 一番下まで即座に移動</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">newY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nextY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextY</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">newY</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fallingPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveLeft</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveRight</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rotate</span><span class="p">,</span>
<span class="w">    </span><span class="nx">drop</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 自動落下と着地処理を実装&#39;</span>
</code></pre></div>
<h3 id="gamescreen_2">GameScreenコンポーネントの更新<a class="headerlink" href="#gamescreen_2" title="Permanent link">&para;</a></h3>
<p>最後に、GameScreenコンポーネントを更新して、2つのぷよを表示し、回転ボタンと落下ボタンを有効にします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx（更新）</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useMemo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameControls</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./GameControls&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../hooks/useGameState&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameScreen</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">moveLeft</span><span class="p">,</span><span class="w"> </span><span class="nx">moveRight</span><span class="p">,</span><span class="w"> </span><span class="nx">rotate</span><span class="p">,</span><span class="w"> </span><span class="nx">drop</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// グリッドに落下中のぷよ（軸ぷよと子ぷよの両方）を合成</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">displayGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useMemo</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>

<span class="w">    </span><span class="c1">// 軸ぷよを配置</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">color</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよを配置</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">subY</span><span class="p">][</span><span class="nx">subX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">color</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="w"> </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;game-screen&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Stage</span><span class="w"> </span><span class="nx">grid</span><span class="o">=</span><span class="p">{</span><span class="nx">displayGrid</span><span class="p">}</span><span class="w"> </span><span class="nx">config</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameControls</span>
<span class="w">        </span><span class="nx">onMoveLeft</span><span class="o">=</span><span class="p">{</span><span class="nx">moveLeft</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onMoveRight</span><span class="o">=</span><span class="p">{</span><span class="nx">moveRight</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onRotate</span><span class="o">=</span><span class="p">{</span><span class="nx">rotate</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onDrop</span><span class="o">=</span><span class="p">{</span><span class="nx">drop</span><span class="p">}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>アプリを起動して確認しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>start
</code></pre></div>
<p>Expo Go アプリや、エミュレータ/シミュレータでアプリを起動して、以下のことを確認しましょう：</p>
<ul>
<li>2つのぷよが連なって表示されること</li>
<li>ぷよが自動的に落下すること</li>
<li>回転ボタンで子ぷよが回転すること</li>
<li>落下ボタンでぷよが一気に落ちること</li>
<li>床に到達したら新しいぷよが生成されること</li>
</ul>
<p>確認できたら、コミットしておきます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 2つのぷよの表示と回転・落下ボタンを有効化&#39;</span>
</code></pre></div>
<h3 id="_42">解説: 回転と自動落下<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>今回実装した「回転と自動落下」について解説しましょう。</p>
<p><strong>回転ロジック</strong></p>
<p>時計回りに90度回転する場合、座標変換は以下のようになります：
- (dx, dy) → (-dy, dx)</p>
<p>例えば：
- 上 (0, -1) → 右 (1, 0)
- 右 (1, 0) → 下 (0, 1)
- 下 (0, 1) → 左 (-1, 0)
- 左 (-1, 0) → 上 (0, -1)</p>
<p><strong>自動落下</strong></p>
<p><code>useEffect</code> と <code>setInterval</code> を使って、一定時間ごとにぷよを下に移動させています。床や既存のぷよに到達したら、グリッドに固定して新しいぷよを生成します。</p>
<blockquote>
<p>タイマーを使った処理</p>
<p>React では、useEffect と setInterval を組み合わせてタイマー処理を実装できます。クリーンアップ関数で clearInterval を呼ぶことで、コンポーネントのアンマウント時にタイマーを停止できます。</p>
<p>— React 公式ドキュメント</p>
</blockquote>
<h3 id="_43">まとめ<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下のことを実現しました：</p>
<ul>
<li>✅ 2つのぷよの管理構造（軸ぷよと子ぷよ）</li>
<li>✅ ぷよの回転機能（時計回りに90度回転）</li>
<li>✅ 自動落下機能（1秒ごとに下に移動）</li>
<li>✅ 着地判定とグリッドへの固定</li>
<li>✅ 新しいぷよの自動生成</li>
<li>✅ 落下ボタンによる高速落下</li>
<li>✅ テスト駆動開発のサイクル（Red-Green-Refactor）の実践</li>
</ul>
<p>次のイテレーションでは、ぷよの消去判定と連鎖機能を実装していきます。ぷよぷよゲームの醍醐味である「連鎖」を実現しましょう！</p>
<h2 id="5">イテレーション5: ぷよの消去判定と連鎖<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを4つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能と「連鎖」機能を実装していきましょう！</p>
<h3 id="_44">ユーザーストーリー<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去でき、連鎖反応を起こしてスコアを獲得できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを4つ以上つなげると消去できる、そして連鎖反応でさらに高いスコアを獲得できるというのが、ぷよぷよの基本的なルールです。これを実装することで、ゲームとしての面白さが大きく向上しますね。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<blockquote>
<p>TODOリストは、実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの接続判定を実装する（隣接する同じ色のぷよを検出する）</li>
<li>4つ以上つながったぷよの検出を実装する（消去対象となるぷよのグループを特定する）</li>
<li>ぷよの消去処理を実装する（消去対象のぷよを実際に消す）</li>
<li>消去後の落下処理を実装する（消去された後の空きスペースにぷよが落ちてくる）</li>
<li>連鎖判定を実装する（落下後に再び消去判定を行う）</li>
<li>スコアシステムを実装する（消去したぷよの数と連鎖数に応じてスコアを加算する）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_45">テスト: ぷよの接続判定<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ぷよの接続判定をテストしましょう。同じ色のぷよが4つ以上つながっているかどうかを判定する機能が必要です。</p>
<p>テストファイルを作成します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>src/utils/__tests__/erasePuyo.test.ts
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/utils/__tests__/erasePuyo.test.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">findConnectedPuyo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../erasePuyo&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/PuyoColor&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;erasePuyo&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;findConnectedPuyo&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;同じ色のぷよが4つつながっていると、接続されたぷよのリストが返される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ステージにぷよを配置（REDは赤ぷよ）</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 R R 0 0 0  (y=10)</span>
<span class="w">      </span><span class="c1">// 0 R R 0 0 0  (y=11)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">6</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>

<span class="w">      </span><span class="c1">// 接続判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findConnectedPuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 4つのぷよが接続されていることを確認</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">connected</span><span class="p">).</span><span class="nx">toContainEqual</span><span class="p">({</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">connected</span><span class="p">).</span><span class="nx">toContainEqual</span><span class="p">({</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">connected</span><span class="p">).</span><span class="nx">toContainEqual</span><span class="p">({</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">11</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">connected</span><span class="p">).</span><span class="nx">toContainEqual</span><span class="p">({</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">11</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;異なる色のぷよは接続されない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ステージにぷよを配置（REDは赤ぷよ、BLUEは青ぷよ）</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">      </span><span class="c1">// 0 R B 0 0 0  (y=10)</span>
<span class="w">      </span><span class="c1">// 0 B R 0 0 0  (y=11)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">6</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>

<span class="w">      </span><span class="c1">// 接続判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findConnectedPuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 同じ色のぷよ1つだけが返される</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">connected</span><span class="p">).</span><span class="nx">toContainEqual</span><span class="p">({</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;checkErasePuyo&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;4つ以上つながったぷよのグループが消去対象として返される&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">6</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>

<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 1つのグループが消去対象になる</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseGroups</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;3つ以下のつながりは消去対象にならない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">6</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>

<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 消去対象なし</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;複数のグループが消去対象になる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">6</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">      </span><span class="c1">// 赤ぷよのグループ（4つ）</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>

<span class="w">      </span><span class="c1">// 青ぷよのグループ（4つ）</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>
<span class="w">      </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>

<span class="w">      </span><span class="c1">// 消去判定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span>

<span class="w">      </span><span class="c1">// 2つのグループが消去対象になる</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li>同じ色のぷよが4つつながっている場合、それらが接続されたリストとして返されるか</li>
<li>異なる色のぷよが隣接している場合、それらは接続されないか</li>
<li>4つ以上つながったぷよが消去対象になるか</li>
<li>3つ以下のつながりは消去対象にならないか</li>
<li>複数のグループが同時に消去対象になるか</li>
</ol>
<p>「ステージにぷよを配置しているのはわかりますが、その図はどういう意味ですか？」良い質問ですね！コメントの図は、ステージ上のぷよの配置を視覚的に表現しています。0は空きマス、Rは赤ぷよ、Bは青ぷよを表しています。最初のテストでは2×2の正方形に赤ぷよを配置し、2つ目のテストでは市松模様に赤と青のぷよを配置しています。</p>
<p>「なるほど、視覚的に確認できるのは便利ですね！」そうですね。では、このテストが通るように実装していきましょう。</p>
<p>テストを実行して、失敗することを確認します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/utils/__tests__/erasePuyo.test.ts
  erasePuyo
    findConnectedPuyo
      ✕ 同じ色のぷよが4つつながっていると、接続されたぷよのリストが返される
      ✕ 異なる色のぷよは接続されない
    checkErasePuyo
      ✕ 4つ以上つながったぷよのグループが消去対象として返される
      ✕ 3つ以下のつながりは消去対象にならない
      ✕ 複数のグループが消去対象になる

Cannot find module &#39;../erasePuyo&#39;
</code></pre></div>
<p>期待通り失敗しましたね。では、実装に進みましょう。</p>
<h3 id="_46">実装: ぷよの接続判定<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ぷよの接続判定を実装していきましょう。</p>
<blockquote>
<p>最小限の実装</p>
<p>テストを通すために、どれだけのコードを書けばよいだろうか——テストが通る最小限のコードだけを書こう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>ユーティリティファイルを作成します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>src/utils/erasePuyo.ts
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/utils/erasePuyo.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">Position</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 指定位置から同じ色で接続されているぷよを探索する（深さ優先探索）</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">findConnectedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][],</span>
<span class="w">  </span><span class="nx">startX</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">  </span><span class="nx">startY</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">Position</span><span class="p">[]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">length</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">length</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">puyoColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">[</span><span class="nx">startY</span><span class="p">][</span><span class="nx">startX</span><span class="p">]</span>

<span class="w">  </span><span class="c1">// 空マスの場合は空配列を返す</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puyoColor</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">connected</span><span class="o">:</span><span class="w"> </span><span class="kt">Position</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">visited</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">cols</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>

<span class="w">  </span><span class="c1">// 深さ優先探索</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dfs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 範囲外チェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">cols</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">rows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 訪問済みチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">visited</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 色が異なるか空マスの場合</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">puyoColor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 訪問済みにして、接続リストに追加</span>
<span class="w">    </span><span class="nx">visited</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="nx">connected</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="c1">// 4方向を探索（右、左、下、上）</span>
<span class="w">    </span><span class="nx">dfs</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="c1">// 右</span>
<span class="w">    </span><span class="nx">dfs</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="c1">// 左</span>
<span class="w">    </span><span class="nx">dfs</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 下</span>
<span class="w">    </span><span class="nx">dfs</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 上</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">dfs</span><span class="p">(</span><span class="nx">startX</span><span class="p">,</span><span class="w"> </span><span class="nx">startY</span><span class="p">)</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">connected</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * グリッド全体をスキャンして消去対象のぷよグループを検出する</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][])</span><span class="o">:</span><span class="w"> </span><span class="nx">Position</span><span class="p">[][]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">length</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">length</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">checked</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">cols</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="o">:</span><span class="w"> </span><span class="kt">Position</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">  </span><span class="c1">// 全マスをチェック</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">rows</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ぷよがあり、まだチェックしていない場合</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">checked</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 接続しているぷよを探索</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findConnectedPuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// チェック済みにする</span>
<span class="w">        </span><span class="nx">connected</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">pos</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">checked</span><span class="p">[</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">})</span>

<span class="w">        </span><span class="c1">// 4つ以上つながっている場合は消去対象</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">connected</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">eraseGroups</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 指定されたぷよグループをグリッドから消去する</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">erasePuyoFromGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][],</span>
<span class="w">  </span><span class="nx">eraseGroups</span><span class="o">:</span><span class="w"> </span><span class="kt">Position</span><span class="p">[][]</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>

<span class="w">  </span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">group</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">group</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">pos</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 消去後にぷよを落下させる</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">fallPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][])</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">length</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">length</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 下から上に向かって各列を処理</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">cols</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">writeY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="c1">// 書き込み位置（下から）</span>

<span class="w">    </span><span class="c1">// 下から上にスキャンして、ぷよを詰める</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">y</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">y</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">writeY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">writeY</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span>
<span class="w">          </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">writeY</span><span class="o">--</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="p">}</span>
</code></pre></div>
<p>「深さ優先探索って何ですか？」良い質問ですね！深さ優先探索（DFS: Depth-First Search）は、グラフや木構造を探索するアルゴリズムの一つです。あるノードから始めて、行けるところまで深く進んでから、戻って別の経路を探索します。</p>
<p>ぷよの接続判定では、あるぷよから始めて、上下左右の隣接するマスを再帰的に探索していきます。同じ色のぷよがあれば、そこからさらに上下左右を探索します。これを繰り返すことで、接続されているすべてのぷよを見つけることができます。</p>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/utils/__tests__/erasePuyo.test.ts
  erasePuyo
    findConnectedPuyo
      ✓ 同じ色のぷよが4つつながっていると、接続されたぷよのリストが返される (3 ms)
      ✓ 異なる色のぷよは接続されない (1 ms)
    checkErasePuyo
      ✓ 4つ以上つながったぷよのグループが消去対象として返される (2 ms)
      ✓ 3つ以下のつながりは消去対象にならない (1 ms)
      ✓ 複数のグループが消去対象になる (2 ms)
</code></pre></div>
<p>テストが通りましたね！</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ぷよの接続判定と消去処理を実装&#39;</span>
</code></pre></div>
<h3 id="_47">テスト: ぷよの消去と落下<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>次に、ぷよの消去と落下処理をテストします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/utils/__tests__/erasePuyo.test.ts（続き）</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;erasePuyoFromGrid&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;消去対象のぷよを消去する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">6</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>

<span class="w">    </span><span class="c1">// 消去判定</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 消去実行</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">erasePuyoFromGrid</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// ぷよが消去されていることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">newGrid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">1</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">newGrid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">newGrid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">1</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">newGrid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;fallPuyo&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;消去後、上にあるぷよが落下する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">6</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">    </span><span class="c1">// ステージにぷよを配置</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 0 0 0 0</span>
<span class="w">    </span><span class="c1">// 0 0 B 0 0 0  (y=8)</span>
<span class="w">    </span><span class="c1">// 0 0 B 0 0 0  (y=9)</span>
<span class="w">    </span><span class="c1">// 0 R R 0 0 0  (y=10)</span>
<span class="w">    </span><span class="c1">// 0 R R 0 0 0  (y=11)</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">8</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">9</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>

<span class="w">    </span><span class="c1">// 消去判定と実行</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">erasedGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">erasePuyoFromGrid</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 落下処理</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fallenGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallPuyo</span><span class="p">(</span><span class="nx">erasedGrid</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 上にあったぷよが落下していることを確認</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fallenGrid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fallenGrid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// 元の位置は空になっている</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fallenGrid</span><span class="p">[</span><span class="mf">8</span><span class="p">][</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fallenGrid</span><span class="p">[</span><span class="mf">9</span><span class="p">][</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;複数の列で独立して落下する&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="mf">6</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>

<span class="w">    </span><span class="c1">// 列0にぷよ</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">8</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>

<span class="w">    </span><span class="c1">// 列2にぷよ</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">7</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fallenGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallPuyo</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 列0のぷよが落下</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fallenGrid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">0</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fallenGrid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">0</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 列2のぷよが落下</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fallenGrid</span><span class="p">[</span><span class="mf">10</span><span class="p">][</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">)</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">fallenGrid</span><span class="p">[</span><span class="mf">11</span><span class="p">][</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/utils/__tests__/erasePuyo.test.ts
  erasePuyo
    findConnectedPuyo
      ✓ 同じ色のぷよが4つつながっていると、接続されたぷよのリストが返される (3 ms)
      ✓ 異なる色のぷよは接続されない (1 ms)
    checkErasePuyo
      ✓ 4つ以上つながったぷよのグループが消去対象として返される (2 ms)
      ✓ 3つ以下のつながりは消去対象にならない (1 ms)
      ✓ 複数のグループが消去対象になる (2 ms)
    erasePuyoFromGrid
      ✓ 消去対象のぷよを消去する (2 ms)
    fallPuyo
      ✓ 消去後、上にあるぷよが落下する (2 ms)
      ✓ 複数の列で独立して落下する (1 ms)
</code></pre></div>
<p>すべてのテストが通りましたね！消去と落下処理が正しく実装されました。</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;test: ぷよの消去と落下処理のテストを追加&#39;</span>
</code></pre></div>
<h3 id="_48">ゲーム状態に統合<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>「消去判定の実装ができたので、これをゲームに統合しましょう！」ぷよが着地したときに消去判定を行い、連鎖が発生する場合は繰り返し処理を行います。また、スコアも計算しましょう。</p>
<p>まず、useGameState フックを更新します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/useGameState.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useMemo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">checkErasePuyo</span><span class="p">,</span>
<span class="w">  </span><span class="nx">erasePuyoFromGrid</span><span class="p">,</span>
<span class="w">  </span><span class="nx">fallPuyo</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../utils/erasePuyo&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">PuyoUnit</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">  </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 相対X座標</span>
<span class="w">  </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 相対Y座標</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">FallingPuyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 軸ぷよのX座標</span>
<span class="w">  </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 軸ぷよのY座標</span>
<span class="w">  </span><span class="nx">main</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoUnit</span><span class="w"> </span><span class="c1">// 軸ぷよ</span>
<span class="w">  </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoUnit</span><span class="w"> </span><span class="c1">// 子ぷよ</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span>
<span class="w">  </span><span class="nx">fallingPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">FallingPuyo</span>
<span class="w">  </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">chainCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">moveLeft</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">moveRight</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">rotate</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">drop</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="p">}</span>

<span class="c1">// 空のグリッドを作成</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">createEmptyGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">cols</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">cols</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// ランダムな色を取得</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getRandomColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span>
<span class="w">    </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">,</span>
<span class="w">    </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">GREEN</span><span class="p">,</span>
<span class="w">    </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">YELLOW</span><span class="p">,</span>
<span class="w">  </span><span class="p">]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>
<span class="p">}</span>

<span class="c1">// ランダムなぷよを生成</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">createRandomPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">stageColumns</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">FallingPuyo</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.floor</span><span class="p">(</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span>
<span class="w">    </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">main</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">getRandomColor</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">getRandomColor</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// 上に配置</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">setGrid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createEmptyGrid</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">setFallingPuyo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">FallingPuyo</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">setScore</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">chainCount</span><span class="p">,</span><span class="w"> </span><span class="nx">setChainCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ぷよが指定位置に配置可能かチェック</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canPlacePuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="o">:</span><span class="w"> </span><span class="kt">FallingPuyo</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 軸ぷよのチェック</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 子ぷよのチェック</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">subY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">grid</span><span class="p">[</span><span class="nx">subY</span><span class="p">][</span><span class="nx">subX</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">grid</span><span class="p">]</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ぷよをグリッドに固定して消去判定と連鎖処理</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixPuyoAndProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">puyo</span><span class="o">:</span><span class="w"> </span><span class="kt">FallingPuyo</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// グリッドにぷよを固定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">color</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">subY</span><span class="p">][</span><span class="nx">subX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">color</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 連鎖処理</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">      </span><span class="c1">// 連鎖ループ</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 消去対象がなければ終了</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">currentChain</span><span class="o">++</span>

<span class="w">        </span><span class="c1">// スコア計算（消去したぷよの数 × 連鎖倍率）</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
<span class="w">          </span><span class="p">(</span><span class="nx">sum</span><span class="p">,</span><span class="w"> </span><span class="nx">group</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="w">          </span><span class="mf">0</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">chainBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentChain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10</span>
<span class="w">        </span><span class="nx">totalScore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">erasedCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">chainBonus</span>

<span class="w">        </span><span class="c1">// 消去実行</span>
<span class="w">        </span><span class="nx">currentGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">erasePuyoFromGrid</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">,</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 落下処理</span>
<span class="w">        </span><span class="nx">currentGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallPuyo</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 状態更新</span>
<span class="w">      </span><span class="nx">setGrid</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">currentChain</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setScore</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">totalScore</span><span class="p">)</span>
<span class="w">        </span><span class="nx">setChainCount</span><span class="p">(</span><span class="nx">currentChain</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">      </span><span class="nx">setFallingPuyo</span><span class="p">(</span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">))</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">,</span><span class="w"> </span><span class="nx">grid</span><span class="p">]</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 自動落下</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fallInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>

<span class="w">        </span><span class="c1">// 着地判定</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">nextY</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// ぷよを固定して消去判定・連鎖処理</span>
<span class="w">          </span><span class="nx">fixPuyoAndProcess</span><span class="p">(</span><span class="nx">prev</span><span class="p">)</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="c1">// この値は使われない（fixPuyoAndProcessで新しいぷよが生成される）</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">          </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">nextY</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">fallInterval</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">fixPuyoAndProcess</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 左移動</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">nextX</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">          </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">nextX</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 右移動</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">nextX</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">          </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">nextX</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 回転</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rotate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 時計回りに90度回転: (dx, dy) → (-dy, dx)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newDx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rotatedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">,</span>
<span class="w">          </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">newDx</span><span class="p">,</span>
<span class="w">          </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">newDy</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 回転後の位置が有効かチェック</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">rotatedPuyo</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">rotatedPuyo</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 壁キックを試みる（左右にずらして回転可能か試す）</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">kickedX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">offset</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">kickedX</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">rotatedPuyo</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">...</span><span class="nx">rotatedPuyo</span><span class="p">,</span>
<span class="w">            </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">kickedX</span><span class="p">,</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 落下（一気に下まで）</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">drop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span>

<span class="w">      </span><span class="c1">// 着地するまで下に移動</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">newY</span><span class="o">++</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// ぷよを固定して消去判定・連鎖処理</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">droppedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">        </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">newY</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">fixPuyoAndProcess</span><span class="p">(</span><span class="nx">droppedPuyo</span><span class="p">)</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">droppedPuyo</span><span class="w"> </span><span class="c1">// この値は使われない</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">fixPuyoAndProcess</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fallingPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">score</span><span class="p">,</span>
<span class="w">    </span><span class="nx">chainCount</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveLeft</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveRight</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rotate</span><span class="p">,</span>
<span class="w">    </span><span class="nx">drop</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「壁キックって何ですか？」良い質問ですね！壁キックは、ぷよを回転させたときに壁や他のぷよに当たってしまう場合、少し横にずらすことで回転を成立させる機能です。これにより、プレイヤーが意図した操作を可能な限り実現できるようになり、ゲームの操作性が向上します。</p>
<h3 id="gamescreen_3">GameScreenコンポーネントの更新<a class="headerlink" href="#gamescreen_3" title="Permanent link">&para;</a></h3>
<p>スコアと連鎖数を表示できるようにGameScreenコンポーネントを更新します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useMemo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameControls</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./GameControls&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../hooks/useGameState&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameScreen</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fallingPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">score</span><span class="p">,</span>
<span class="w">    </span><span class="nx">chainCount</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveLeft</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveRight</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rotate</span><span class="p">,</span>
<span class="w">    </span><span class="nx">drop</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// グリッドに落下中のぷよ（軸ぷよと子ぷよの両方）を合成</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">displayGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useMemo</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>

<span class="w">    </span><span class="c1">// 軸ぷよを配置</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">color</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよを配置</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">subY</span><span class="p">][</span><span class="nx">subX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">color</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="w"> </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;game-screen&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreBoard</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreText</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">スコア</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">score</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">chainCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">chainText</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">chainCount</span><span class="p">}</span><span class="nx">連鎖</span><span class="err">！</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Stage</span><span class="w"> </span><span class="nx">grid</span><span class="o">=</span><span class="p">{</span><span class="nx">displayGrid</span><span class="p">}</span><span class="w"> </span><span class="nx">config</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameControls</span>
<span class="w">        </span><span class="nx">onMoveLeft</span><span class="o">=</span><span class="p">{</span><span class="nx">moveLeft</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onMoveRight</span><span class="o">=</span><span class="p">{</span><span class="nx">moveRight</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onRotate</span><span class="o">=</span><span class="p">{</span><span class="nx">rotate</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onDrop</span><span class="o">=</span><span class="p">{</span><span class="nx">drop</span><span class="p">}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">scoreBoard</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">scoreText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">18</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">chainText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">16</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ff4444&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>アプリを起動して確認しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>start
</code></pre></div>
<p>Expo Go アプリや、エミュレータ/シミュレータでアプリを起動して、以下のことを確認しましょう：</p>
<ul>
<li>同じ色のぷよが4つ以上つながると消えること</li>
<li>消去後にぷよが落下すること</li>
<li>連鎖が発生すること</li>
<li>スコアが加算されること</li>
<li>連鎖数が表示されること</li>
</ul>
<p>確認できたら、コミットしておきます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: 消去判定・連鎖・スコアシステムをゲームに統合&#39;</span>
</code></pre></div>
<h3 id="_49">解説: 消去判定と連鎖<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>今回実装した「消去判定と連鎖」について解説しましょう。</p>
<p><strong>深さ優先探索（DFS）</strong></p>
<p>同じ色で接続されているぷよを見つけるために、深さ優先探索アルゴリズムを使用しています。このアルゴリズムは：</p>
<ol>
<li>開始位置のぷよから探索を開始</li>
<li>上下左右の隣接マスをチェック</li>
<li>同じ色のぷよがあれば、そこから再帰的に探索</li>
<li>すべての接続されたぷよを見つけるまで繰り返す</li>
</ol>
<p><strong>連鎖処理</strong></p>
<p>連鎖は以下の流れで実装されています：</p>
<ol>
<li>ぷよが着地したらグリッドに固定</li>
<li>消去判定を行う</li>
<li>消去対象があれば消去してスコアを加算</li>
<li>落下処理を実行</li>
<li>再び消去判定を行う（2に戻る）</li>
<li>消去対象がなくなったら終了</li>
</ol>
<p><strong>スコア計算</strong></p>
<p>スコアは以下の式で計算されます：</p>
<div class="highlight"><pre><span></span><code>スコア = 消去したぷよの数 × 連鎖数 × 10
</code></pre></div>
<p>連鎖するほど高いスコアが得られる仕組みになっています。</p>
<blockquote>
<p>段階的な機能追加</p>
<p>最初から完璧なシステムを目指すのではなく、動作する最小限の機能から始めて、段階的に機能を追加していく。これがテスト駆動開発の基本的なアプローチです。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_50">まとめ<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下のことを実現しました：</p>
<ul>
<li>✅ ぷよの接続判定アルゴリズム（深さ優先探索）</li>
<li>✅ 4つ以上つながったぷよの消去機能</li>
<li>✅ 消去後の落下処理</li>
<li>✅ 連鎖判定と連鎖処理</li>
<li>✅ スコアシステム（消去数と連鎖数に応じたスコア計算）</li>
<li>✅ スコア表示と連鎖数表示</li>
<li>✅ 壁キック機能（回転時の配慮）</li>
<li>✅ テスト駆動開発のサイクル（Red-Green-Refactor）の実践</li>
</ul>
<p>次のイテレーションでは、ゲームオーバー判定やUI/UXの改善を実装していきます。ゲームとしての完成度を高めていきましょう！</p>
<h2 id="6-uiux">イテレーション6: ゲームオーバーとUI/UX改善<a class="headerlink" href="#6-uiux" title="Permanent link">&para;</a></h2>
<p>「連鎖まで実装できましたが、ゲームが終わる条件も必要ですよね？」そうですね！どんなゲームにも終わりがあります。ぷよぷよでは、新しいぷよを配置できなくなったときにゲームオーバーとなります。今回は、そのゲームオーバー判定と演出、そしてUI/UXの改善を実装していきましょう！</p>
<h3 id="_51">ユーザーストーリー<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができ、すぐに再プレイできる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。ゲームオーバーになったことを明確に伝え、リスタート機能を提供することで、プレイヤーに次回への意欲を持ってもらうことができます。</p>
<h3 id="todo_5">TODOリスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<blockquote>
<p>TODOリストは、実装前に必要なタスクを明確にすることで、開発の方向性を保ち、何も見落とさないようにします。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>「ゲームオーバーを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出する）</li>
<li>ゲームオーバー状態を管理する（ゲーム状態のフラグ）</li>
<li>ゲームオーバー画面を実装する（ゲームオーバー時の UI 表示）</li>
<li>リスタート機能を実装する（ゲームを初期状態に戻す）</li>
<li>UI/UXの改善（アニメーション、視覚的フィードバック）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_52">テスト: ゲームオーバー判定<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、ゲームオーバー判定をテストしましょう。新しいぷよを配置できない状態を検出する機能が必要です。</p>
<p>テストファイルを更新します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/__tests__/useGameState.test.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">,</span><span class="w"> </span><span class="nx">act</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../useGameState&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../models/PuyoColor&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;useGameState&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span>

<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;ゲームオーバー判定&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;新しいぷよを配置できない場合、ゲームオーバーになる&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">      </span><span class="c1">// グリッドの上部（新しいぷよが生成される位置）を埋める</span>
<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 直接gridを操作するためのヘルパー関数を使用</span>
<span class="w">        </span><span class="c1">// ここでは、新しいぷよの生成位置にぷよを配置</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">spawnX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">        </span><span class="nx">newGrid</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="nx">spawnX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">        </span><span class="nx">newGrid</span><span class="p">[</span><span class="mf">1</span><span class="p">][</span><span class="nx">spawnX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span>
<span class="w">        </span><span class="c1">// この状態でゲームを更新</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="c1">// ゲームオーバー状態を確認</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">isGameOver</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;ゲーム開始時はゲームオーバーではない&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">isGameOver</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;リスタート機能&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;リスタートすると、ゲームが初期状態に戻る&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderHook</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span>

<span class="w">      </span><span class="c1">// ゲームを進行させる</span>
<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">drop</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">scoreAfterDrop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">score</span>

<span class="w">      </span><span class="c1">// リスタート</span>
<span class="w">      </span><span class="nx">act</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">restart</span><span class="p">()</span>
<span class="w">      </span><span class="p">})</span>

<span class="w">      </span><span class="c1">// 初期状態に戻っていることを確認</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">score</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">chainCount</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">isGameOver</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>テストを実行して、失敗することを確認します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FAIL  src/hooks/__tests__/useGameState.test.ts
  useGameState
    ゲームオーバー判定
      ✕ 新しいぷよを配置できない場合、ゲームオーバーになる
      ✕ ゲーム開始時はゲームオーバーではない
    リスタート機能
      ✕ リスタートすると、ゲームが初期状態に戻る

Property &#39;isGameOver&#39; does not exist on type &#39;GameState&#39;
Property &#39;restart&#39; does not exist on type &#39;GameState&#39;
</code></pre></div>
<p>期待通り失敗しましたね。では、実装に進みましょう。</p>
<h3 id="_53">実装: ゲームオーバー判定とリスタート機能<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>「テストが失敗することを確認したら、実装に進みましょう！」そうですね。では、ゲームオーバー判定とリスタート機能を実装していきましょう。</p>
<blockquote>
<p>最小限の実装</p>
<p>テストを通すために、どれだけのコードを書けばよいだろうか——テストが通る最小限のコードだけを書こう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>useGameState フックを更新します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/hooks/useGameState.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useMemo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/PuyoColor&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">checkErasePuyo</span><span class="p">,</span>
<span class="w">  </span><span class="nx">erasePuyoFromGrid</span><span class="p">,</span>
<span class="w">  </span><span class="nx">fallPuyo</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../utils/erasePuyo&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">PuyoUnit</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">  </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 相対X座標</span>
<span class="w">  </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 相対Y座標</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">FallingPuyo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 軸ぷよのX座標</span>
<span class="w">  </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="c1">// 軸ぷよのY座標</span>
<span class="w">  </span><span class="nx">main</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoUnit</span><span class="w"> </span><span class="c1">// 軸ぷよ</span>
<span class="w">  </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoUnit</span><span class="w"> </span><span class="c1">// 子ぷよ</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">grid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][]</span>
<span class="w">  </span><span class="nx">fallingPuyo</span><span class="o">:</span><span class="w"> </span><span class="kt">FallingPuyo</span>
<span class="w">  </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">chainCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">isGameOver</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span>
<span class="w">  </span><span class="nx">moveLeft</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">moveRight</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">rotate</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">drop</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">restart</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="p">}</span>

<span class="c1">// 空のグリッドを作成</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">createEmptyGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">cols</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">cols</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// ランダムな色を取得</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getRandomColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span>
<span class="w">    </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">BLUE</span><span class="p">,</span>
<span class="w">    </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">GREEN</span><span class="p">,</span>
<span class="w">    </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">YELLOW</span><span class="p">,</span>
<span class="w">  </span><span class="p">]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">colors</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>
<span class="p">}</span>

<span class="c1">// ランダムなぷよを生成</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">createRandomPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">stageColumns</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">FallingPuyo</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.floor</span><span class="p">(</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span>
<span class="w">    </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">main</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">getRandomColor</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">getRandomColor</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// 上に配置</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="kt">Config</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">GameState</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">setGrid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">PuyoColor</span><span class="p">[][]</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createEmptyGrid</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">setFallingPuyo</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">FallingPuyo</span><span class="o">&gt;</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">setScore</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">chainCount</span><span class="p">,</span><span class="w"> </span><span class="nx">setChainCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isGameOver</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsGameOver</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ゲームオーバー判定（新しいぷよを配置できるかチェック）</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">checkGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">currentGrid</span><span class="o">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="p">[][])</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">spawnX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">spawnY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">      </span><span class="c1">// 生成位置（軸ぷよと上の子ぷよ）にぷよがあるかチェック</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">currentGrid</span><span class="p">[</span><span class="nx">spawnY</span><span class="p">][</span><span class="nx">spawnX</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">(</span><span class="nx">spawnY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">currentGrid</span><span class="p">[</span><span class="nx">spawnY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">][</span><span class="nx">spawnX</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">]</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ぷよが指定位置に配置可能かチェック</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canPlacePuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">puyo</span><span class="o">:</span><span class="w"> </span><span class="kt">FallingPuyo</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ゲームオーバー時は移動不可</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 軸ぷよのチェック</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">grid</span><span class="p">[</span><span class="nx">y</span><span class="p">][</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 子ぷよのチェック</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">subY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="nx">grid</span><span class="p">[</span><span class="nx">subY</span><span class="p">][</span><span class="nx">subX</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">PuyoColor</span><span class="p">.</span><span class="nx">EMPTY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">]</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c1">// ぷよをグリッドに固定して消去判定と連鎖処理</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixPuyoAndProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nx">puyo</span><span class="o">:</span><span class="w"> </span><span class="kt">FallingPuyo</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// グリッドにぷよを固定</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">color</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">subY</span><span class="p">][</span><span class="nx">subX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">color</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 連鎖処理</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">      </span><span class="c1">// 連鎖ループ</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 消去判定</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkErasePuyo</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 消去対象がなければ終了</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">currentChain</span><span class="o">++</span>

<span class="w">        </span><span class="c1">// スコア計算（消去したぷよの数 × 連鎖倍率）</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">erasedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
<span class="w">          </span><span class="p">(</span><span class="nx">sum</span><span class="p">,</span><span class="w"> </span><span class="nx">group</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="w">          </span><span class="mf">0</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">chainBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentChain</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10</span>
<span class="w">        </span><span class="nx">totalScore</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">erasedCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">chainBonus</span>

<span class="w">        </span><span class="c1">// 消去実行</span>
<span class="w">        </span><span class="nx">currentGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">erasePuyoFromGrid</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">,</span><span class="w"> </span><span class="nx">eraseGroups</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 落下処理</span>
<span class="w">        </span><span class="nx">currentGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallPuyo</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 状態更新</span>
<span class="w">      </span><span class="nx">setGrid</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">currentChain</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setScore</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">totalScore</span><span class="p">)</span>
<span class="w">        </span><span class="nx">setChainCount</span><span class="p">(</span><span class="nx">currentChain</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// ゲームオーバー判定</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">checkGameOver</span><span class="p">(</span><span class="nx">currentGrid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setIsGameOver</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 新しいぷよを生成</span>
<span class="w">      </span><span class="nx">setFallingPuyo</span><span class="p">(</span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">))</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">,</span><span class="w"> </span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">checkGameOver</span><span class="p">]</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 自動落下</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ゲームオーバー時は自動落下を停止</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fallInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>

<span class="w">        </span><span class="c1">// 着地判定</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">nextY</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// ぷよを固定して消去判定・連鎖処理</span>
<span class="w">          </span><span class="nx">fixPuyoAndProcess</span><span class="p">(</span><span class="nx">prev</span><span class="p">)</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="c1">// この値は使われない（fixPuyoAndProcessで新しいぷよが生成される）</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">          </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">nextY</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">fallInterval</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">fixPuyoAndProcess</span><span class="p">,</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 左移動</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">nextX</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">          </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">nextX</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 右移動</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">moveRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">nextX</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">          </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">nextX</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 回転</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rotate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 時計回りに90度回転: (dx, dy) → (-dy, dx)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newDx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rotatedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">...</span><span class="nx">prev</span><span class="p">.</span><span class="nx">sub</span><span class="p">,</span>
<span class="w">          </span><span class="nx">dx</span><span class="o">:</span><span class="w"> </span><span class="kt">newDx</span><span class="p">,</span>
<span class="w">          </span><span class="nx">dy</span><span class="o">:</span><span class="w"> </span><span class="kt">newDy</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 回転後の位置が有効かチェック</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">rotatedPuyo</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">rotatedPuyo</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 壁キックを試みる（左右にずらして回転可能か試す）</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">kickedX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">offset</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">kickedX</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">rotatedPuyo</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">...</span><span class="nx">rotatedPuyo</span><span class="p">,</span>
<span class="w">            </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">kickedX</span><span class="p">,</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">prev</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// 落下（一気に下まで）</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">drop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">((</span><span class="nx">prev</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span>

<span class="w">      </span><span class="c1">// 着地するまで下に移動</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">canPlacePuyo</span><span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">newY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">newY</span><span class="o">++</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// ぷよを固定して消去判定・連鎖処理</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">droppedPuyo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">prev</span><span class="p">,</span>
<span class="w">        </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">newY</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">fixPuyoAndProcess</span><span class="p">(</span><span class="nx">droppedPuyo</span><span class="p">)</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">droppedPuyo</span><span class="w"> </span><span class="c1">// この値は使われない</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">canPlacePuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">fixPuyoAndProcess</span><span class="p">,</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// リスタート</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">restart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setGrid</span><span class="p">(</span><span class="nx">createEmptyGrid</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">))</span>
<span class="w">    </span><span class="nx">setFallingPuyo</span><span class="p">(</span><span class="nx">createRandomPuyo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">))</span>
<span class="w">    </span><span class="nx">setScore</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">setChainCount</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">setIsGameOver</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fallingPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">score</span><span class="p">,</span>
<span class="w">    </span><span class="nx">chainCount</span><span class="p">,</span>
<span class="w">    </span><span class="nx">isGameOver</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveLeft</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveRight</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rotate</span><span class="p">,</span>
<span class="w">    </span><span class="nx">drop</span><span class="p">,</span>
<span class="w">    </span><span class="nx">restart</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>「ゲームオーバー判定はどのように行われるんですか？」良い質問ですね！ゲームオーバー判定は、ぷよが着地して新しいぷよを生成する前に、生成位置（ステージの中央上部）にすでにぷよがあるかをチェックしています。もしその位置にぷよがあれば、新しいぷよを配置できないため、ゲームオーバーとなります。</p>
<p>テストを再実行します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span><span class="nb">test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>PASS  src/hooks/__tests__/useGameState.test.ts
  useGameState
    ゲームオーバー判定
      ✓ 新しいぷよを配置できない場合、ゲームオーバーになる (50 ms)
      ✓ ゲーム開始時はゲームオーバーではない (5 ms)
    リスタート機能
      ✓ リスタートすると、ゲームが初期状態に戻る (30 ms)
</code></pre></div>
<p>テストが通りましたね！</p>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームオーバー判定とリスタート機能を実装&#39;</span>
</code></pre></div>
<h3 id="_54">実装: ゲームオーバー画面<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<p>「ゲームオーバー判定ができたので、次はゲームオーバー画面を作りましょう！」ゲームオーバーになったことを明確に伝え、リスタートできるようにUIを実装します。</p>
<p>ゲームオーバー画面のコンポーネントを作成します。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span>src/components/GameOverModal.tsx
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameOverModal.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">View</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Text</span><span class="p">,</span>
<span class="w">  </span><span class="nx">TouchableOpacity</span><span class="p">,</span>
<span class="w">  </span><span class="nx">StyleSheet</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Modal</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">GameOverModalProps</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">visible</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span>
<span class="w">  </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">onRestart</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameOverModal</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="o">&lt;</span><span class="nx">GameOverModalProps</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="nx">visible</span><span class="p">,</span>
<span class="w">  </span><span class="nx">score</span><span class="p">,</span>
<span class="w">  </span><span class="nx">onRestart</span><span class="p">,</span>
<span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">Modal</span>
<span class="w">      </span><span class="nx">visible</span><span class="o">=</span><span class="p">{</span><span class="nx">visible</span><span class="p">}</span>
<span class="w">      </span><span class="nx">transparent</span>
<span class="w">      </span><span class="nx">animationType</span><span class="o">=</span><span class="s2">&quot;fade&quot;</span>
<span class="w">      </span><span class="nx">onRequestClose</span><span class="o">=</span><span class="p">{</span><span class="nx">onRestart</span><span class="p">}</span>
<span class="w">    </span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">overlay</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">modal</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">ゲームオーバー</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreContainer</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreLabel</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">最終スコア</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">            </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreValue</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">score</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">restartButton</span><span class="p">}</span><span class="w"> </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{</span><span class="nx">onRestart</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">restartButtonText</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">もう一度プレイ</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/Modal&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">overlay</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rgba(0, 0, 0, 0.7)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">modal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">    </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="kt">30</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowOffset</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">shadowOpacity</span><span class="o">:</span><span class="w"> </span><span class="kt">0.25</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="nx">elevation</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">    </span><span class="nx">minWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">300</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ff4444&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">scoreContainer</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">30</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">scoreLabel</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">16</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#666&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">scoreValue</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">48</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#333&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">restartButton</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#4CAF50&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">paddingHorizontal</span><span class="o">:</span><span class="w"> </span><span class="kt">40</span><span class="p">,</span>
<span class="w">    </span><span class="nx">paddingVertical</span><span class="o">:</span><span class="w"> </span><span class="kt">15</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowOffset</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">shadowOpacity</span><span class="o">:</span><span class="w"> </span><span class="kt">0.25</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="nx">elevation</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">restartButtonText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">18</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>「Modalコンポーネントを使っているんですね！」そうです！React Nativeの<code>Modal</code>コンポーネントを使うことで、ゲームオーバー時にオーバーレイ表示ができます。<code>transparent</code>と<code>animationType="fade"</code>を指定することで、フェードイン/アウトのアニメーションも実現できます。</p>
<h3 id="gamescreen_4">GameScreenコンポーネントの更新<a class="headerlink" href="#gamescreen_4" title="Permanent link">&para;</a></h3>
<p>ゲームオーバーモーダルを表示できるようにGameScreenコンポーネントを更新します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useMemo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">View</span><span class="p">,</span><span class="w"> </span><span class="nx">Text</span><span class="p">,</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../models/Config&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Stage&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameControls</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./GameControls&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GameOverModal</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./GameOverModal&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useGameState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../hooks/useGameState&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameScreen</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fallingPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">score</span><span class="p">,</span>
<span class="w">    </span><span class="nx">chainCount</span><span class="p">,</span>
<span class="w">    </span><span class="nx">isGameOver</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveLeft</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveRight</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rotate</span><span class="p">,</span>
<span class="w">    </span><span class="nx">drop</span><span class="p">,</span>
<span class="w">    </span><span class="nx">restart</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// グリッドに落下中のぷよ（軸ぷよと子ぷよの両方）を合成</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">displayGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useMemo</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">grid</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">row</span><span class="p">])</span>

<span class="w">    </span><span class="c1">// ゲームオーバー時は落下中のぷよを表示しない</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isGameOver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 軸ぷよを配置</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="p">][</span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">color</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 子ぷよを配置</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dx</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">subY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">dy</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="nx">subY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageRows</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="nx">subX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">stageColumns</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newGrid</span><span class="p">[</span><span class="nx">subY</span><span class="p">][</span><span class="nx">subX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">color</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">newGrid</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">grid</span><span class="p">,</span><span class="w"> </span><span class="nx">fallingPuyo</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">isGameOver</span><span class="p">])</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="w"> </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;game-screen&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreBoard</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreText</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">スコア</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">score</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">chainCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isGameOver</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">chainText</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">chainCount</span><span class="p">}</span><span class="nx">連鎖</span><span class="err">！</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Stage</span><span class="w"> </span><span class="nx">grid</span><span class="o">=</span><span class="p">{</span><span class="nx">displayGrid</span><span class="p">}</span><span class="w"> </span><span class="nx">config</span><span class="o">=</span><span class="p">{</span><span class="nx">config</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameControls</span>
<span class="w">        </span><span class="nx">onMoveLeft</span><span class="o">=</span><span class="p">{</span><span class="nx">moveLeft</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onMoveRight</span><span class="o">=</span><span class="p">{</span><span class="nx">moveRight</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onRotate</span><span class="o">=</span><span class="p">{</span><span class="nx">rotate</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onDrop</span><span class="o">=</span><span class="p">{</span><span class="nx">drop</span><span class="p">}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">GameOverModal</span>
<span class="w">        </span><span class="nx">visible</span><span class="o">=</span><span class="p">{</span><span class="nx">isGameOver</span><span class="p">}</span>
<span class="w">        </span><span class="nx">score</span><span class="o">=</span><span class="p">{</span><span class="nx">score</span><span class="p">}</span>
<span class="w">        </span><span class="nx">onRestart</span><span class="o">=</span><span class="p">{</span><span class="nx">restart</span><span class="p">}</span>
<span class="w">      </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">scoreBoard</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">scoreText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">18</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">chainText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">16</span><span class="p">,</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ff4444&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>アプリを起動して確認しましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>start
</code></pre></div>
<p>Expo Go アプリや、エミュレータ/シミュレータでアプリを起動して、以下のことを確認しましょう：</p>
<ul>
<li>ぷよを上まで積み上げるとゲームオーバーになること</li>
<li>ゲームオーバーモーダルが表示されること</li>
<li>最終スコアが表示されること</li>
<li>「もう一度プレイ」ボタンでゲームがリスタートすること</li>
</ul>
<p>確認できたら、コミットしておきます。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: ゲームオーバー画面とリスタート機能を実装&#39;</span>
</code></pre></div>
<h3 id="uiux">UI/UXの改善<a class="headerlink" href="#uiux" title="Permanent link">&para;</a></h3>
<p>「基本的な機能は完成しましたね！」そうですね。最後に、ユーザー体験を向上させるためのUI/UX改善を行いましょう。</p>
<h4 id="1_1">1. 連鎖時のアニメーション効果<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h4>
<p>連鎖が発生したときに、視覚的なフィードバックを追加しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameScreen.tsx（スタイルに追加）</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Animated</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameScreen</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Config</span><span class="p">()</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">grid</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fallingPuyo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">score</span><span class="p">,</span>
<span class="w">    </span><span class="nx">chainCount</span><span class="p">,</span>
<span class="w">    </span><span class="nx">isGameOver</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveLeft</span><span class="p">,</span>
<span class="w">    </span><span class="nx">moveRight</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rotate</span><span class="p">,</span>
<span class="w">    </span><span class="nx">drop</span><span class="p">,</span>
<span class="w">    </span><span class="nx">restart</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useGameState</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// アニメーション用の値</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chainScale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">Animated</span><span class="p">.</span><span class="nx">Value</span><span class="p">(</span><span class="mf">1</span><span class="p">)).</span><span class="nx">current</span>

<span class="w">  </span><span class="c1">// 連鎖時のアニメーション</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chainCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">Animated</span><span class="p">.</span><span class="nx">sequence</span><span class="p">([</span>
<span class="w">        </span><span class="nx">Animated</span><span class="p">.</span><span class="nx">spring</span><span class="p">(</span><span class="nx">chainScale</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">toValue</span><span class="o">:</span><span class="w"> </span><span class="kt">1.5</span><span class="p">,</span>
<span class="w">          </span><span class="nx">useNativeDriver</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">          </span><span class="nx">speed</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="p">,</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">        </span><span class="nx">Animated</span><span class="p">.</span><span class="nx">spring</span><span class="p">(</span><span class="nx">chainScale</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">toValue</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">          </span><span class="nx">useNativeDriver</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">          </span><span class="nx">speed</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="p">,</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">      </span><span class="p">]).</span><span class="nx">start</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">chainCount</span><span class="p">,</span><span class="w"> </span><span class="nx">chainScale</span><span class="p">])</span>

<span class="w">  </span><span class="c1">// ... 既存のコード</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="w"> </span><span class="nx">testID</span><span class="o">=</span><span class="s2">&quot;game-screen&quot;</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">ぷよぷよゲーム</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreBoard</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">scoreText</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">スコア</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">score</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">chainCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isGameOver</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Animated</span><span class="p">.</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">transform</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">scale</span><span class="o">:</span><span class="w"> </span><span class="kt">chainScale</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">}}</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">chainText</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">chainCount</span><span class="p">}</span><span class="nx">連鎖</span><span class="err">！</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="err">/Animated.View&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="2_3">2. タッチフィードバックの改善<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h4>
<p>ボタンを押したときの触覚フィードバックを追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// src/components/GameControls.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">View</span><span class="p">,</span>
<span class="w">  </span><span class="nx">TouchableOpacity</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Text</span><span class="p">,</span>
<span class="w">  </span><span class="nx">StyleSheet</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Platform</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Vibration</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-native&#39;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">GameControlsProps</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">onMoveLeft</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">onMoveRight</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">onRotate</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="nx">onDrop</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GameControls</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="o">&lt;</span><span class="nx">GameControlsProps</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="nx">onMoveLeft</span><span class="p">,</span>
<span class="w">  </span><span class="nx">onMoveRight</span><span class="p">,</span>
<span class="w">  </span><span class="nx">onRotate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">onDrop</span><span class="p">,</span>
<span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// タッチ時の触覚フィードバック</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handlePress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">callback</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">Platform</span><span class="p">.</span><span class="nx">OS</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ios&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">Platform</span><span class="p">.</span><span class="nx">OS</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;android&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">Vibration</span><span class="p">.</span><span class="nx">vibrate</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">callback</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">row</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span>
<span class="w">          </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">handlePress</span><span class="p">(</span><span class="nx">onMoveLeft</span><span class="p">)}</span>
<span class="w">          </span><span class="nx">activeOpacity</span><span class="o">=</span><span class="p">{</span><span class="mf">0.7</span><span class="p">}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">←</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span>
<span class="w">          </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">handlePress</span><span class="p">(</span><span class="nx">onMoveRight</span><span class="p">)}</span>
<span class="w">          </span><span class="nx">activeOpacity</span><span class="o">=</span><span class="p">{</span><span class="mf">0.7</span><span class="p">}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">→</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">View</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">row</span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">}</span>
<span class="w">          </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">handlePress</span><span class="p">(</span><span class="nx">onRotate</span><span class="p">)}</span>
<span class="w">          </span><span class="nx">activeOpacity</span><span class="o">=</span><span class="p">{</span><span class="mf">0.7</span><span class="p">}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">↻</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="nx">TouchableOpacity</span>
<span class="w">          </span><span class="nx">style</span><span class="o">=</span><span class="p">{[</span><span class="nx">styles</span><span class="p">.</span><span class="nx">button</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">.</span><span class="nx">dropButton</span><span class="p">]}</span>
<span class="w">          </span><span class="nx">onPress</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">handlePress</span><span class="p">(</span><span class="nx">onDrop</span><span class="p">)}</span>
<span class="w">          </span><span class="nx">activeOpacity</span><span class="o">=</span><span class="p">{</span><span class="mf">0.7</span><span class="p">}</span>
<span class="w">        </span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="nx">Text</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">}</span><span class="o">&gt;</span><span class="err">↓</span><span class="o">&lt;</span><span class="err">/Text&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="err">/TouchableOpacity&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/View&gt;</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">container</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">row</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flexDirection</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;row&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginVertical</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">button</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#4CAF50&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">paddingHorizontal</span><span class="o">:</span><span class="w"> </span><span class="kt">30</span><span class="p">,</span>
<span class="w">    </span><span class="nx">paddingVertical</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="p">,</span>
<span class="w">    </span><span class="nx">marginHorizontal</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span>
<span class="w">    </span><span class="nx">minWidth</span><span class="o">:</span><span class="w"> </span><span class="kt">80</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#000&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowOffset</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">shadowOpacity</span><span class="o">:</span><span class="w"> </span><span class="kt">0.25</span><span class="p">,</span>
<span class="w">    </span><span class="nx">shadowRadius</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">    </span><span class="nx">elevation</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">dropButton</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#ff9800&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">buttonText</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fff&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fontWeight</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<p>コミットしておきましょう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: UI/UX改善（アニメーションと触覚フィードバック）&#39;</span>
</code></pre></div>
<h3 id="uiux_1">解説: ゲームオーバーとUI/UX<a class="headerlink" href="#uiux_1" title="Permanent link">&para;</a></h3>
<p>今回実装した「ゲームオーバーとUI/UX改善」について解説しましょう。</p>
<p><strong>ゲームオーバー判定</strong></p>
<p>ゲームオーバー判定は、新しいぷよを生成する位置にすでにぷよがあるかをチェックしています。この判定は <code>fixPuyoAndProcess</code> 関数内で、ぷよが着地して固定された後に行われます。</p>
<p><strong>Modal コンポーネント</strong></p>
<p>React Nativeの<code>Modal</code>コンポーネントを使用することで、ゲームオーバー時にオーバーレイ表示を実現しています。<code>transparent</code>プロパティで背景を透明にし、<code>animationType</code>でフェードアニメーションを追加しています。</p>
<p><strong>アニメーション</strong></p>
<p><code>Animated</code> APIを使用して、連鎖時にテキストがバウンドするアニメーションを実装しています。<code>Animated.spring</code>を使うことで、物理的な動きを模したスムーズなアニメーションが実現できます。</p>
<p><strong>触覚フィードバック</strong></p>
<p><code>Vibration</code> APIを使用して、ボタンを押したときに短い振動を発生させています。これにより、ユーザーに操作が受け付けられたことを伝えることができます。</p>
<blockquote>
<p>ユーザー体験の重要性</p>
<p>機能が正しく動作することは重要ですが、ユーザーがその機能を快適に使えることも同じくらい重要です。適切なフィードバック、アニメーション、視覚効果により、ユーザー体験は大きく向上します。</p>
<p>— Apple Human Interface Guidelines</p>
</blockquote>
<h3 id="_55">まとめ<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下のことを実現しました：</p>
<ul>
<li>✅ ゲームオーバー判定（新しいぷよを配置できない状態の検出）</li>
<li>✅ ゲームオーバー状態の管理（isGameOverフラグ）</li>
<li>✅ ゲームオーバーモーダルの実装（Modal コンポーネント）</li>
<li>✅ リスタート機能（ゲームの初期化）</li>
<li>✅ 連鎖時のアニメーション効果（Animated API）</li>
<li>✅ 触覚フィードバック（Vibration API）</li>
<li>✅ テスト駆動開発のサイクル（Red-Green-Refactor）の実践</li>
</ul>
<p>これで、React Native版のぷよぷよゲームの基本的な機能がすべて完成しました！ゲームとして十分に遊べる状態になりましたね。</p>
<h3 id="_56">今後の拡張案<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>さらにゲームを充実させたい場合は、以下のような機能を追加することができます：</p>
<ul>
<li><strong>全消しボーナス</strong>: すべてのぷよを消したときの特別なボーナス</li>
<li><strong>ハイスコア管理</strong>: AsyncStorageを使用したローカルストレージへの保存</li>
<li><strong>サウンドエフェクト</strong>: Expo AVを使用した効果音とBGM</li>
<li><strong>難易度設定</strong>: 落下速度の調整</li>
<li><strong>ネクストぷよ表示</strong>: 次に来るぷよの予告表示</li>
<li><strong>パーティクルエフェクト</strong>: ぷよが消えるときの演出強化</li>
</ul>
<p>テスト駆動開発の原則に従い、これらの機能も一つずつテストを書いてから実装することで、品質の高いコードを維持できます。</p>
<p>おめでとうございます！React Native版のぷよぷよゲームチュートリアルが完成しました！🎉</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>