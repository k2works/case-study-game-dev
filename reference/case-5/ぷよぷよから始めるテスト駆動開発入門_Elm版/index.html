
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Site Description">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>ぷよぷよから始めるテスト駆動開発入門 - Elm 版 - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#-elm" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ぷよぷよから始めるテスト駆動開発入門 - Elm 版
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="-elm">ぷよぷよから始めるテスト駆動開発入門 - Elm 版<a class="headerlink" href="#-elm" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>みなさん、こんにちは！今日は私と一緒にテスト駆動開発（TDD）を使って、Elm でぷよぷよゲームを作っていきましょう。</p>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>この記事では、Elm を使ってぷよぷよゲームを実装しながら、テスト駆動開発の基本的な流れと考え方を学んでいきます。</p>
<h3 id="elm">Elm とは？<a class="headerlink" href="#elm" title="Permanent link">&para;</a></h3>
<p>「Elm って何？」と思われるかもしれませんね。Elm は、Web フロントエンド開発のための関数型プログラミング言語です。</p>
<p><strong>Elm の特徴</strong>：
- <strong>実行時エラーなし</strong>: Elm のコンパイラが型チェックで多くのバグを防ぐ
- <strong>親切なコンパイラ</strong>: エラーメッセージが分かりやすく、問題解決のヒントを提示
- <strong>The Elm Architecture</strong>: シンプルで予測可能なアーキテクチャパターン
- <strong>純粋関数型</strong>: 副作用が制御され、テストしやすいコード</p>
<h3 id="_2">テスト駆動開発のサイクル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>Elm でも、テスト駆動開発の基本は同じです：</p>
<ol>
<li><strong>Red（赤）</strong>: 失敗するテストを書く</li>
<li><strong>Green（緑）</strong>: テストが通る最小限の実装</li>
<li><strong>Refactor（リファクタリング）</strong>: コードの品質を改善</li>
</ol>
<blockquote>
<p>レッド・グリーン・リファクタリング。それがTDDのマントラだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_3">開発環境<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>Elm プロジェクトでは、以下のツールを使用します：</p>
<ul>
<li><strong>言語</strong>: Elm — 型安全な関数型言語</li>
<li><strong>ビルドツール</strong>: elm make — Elm 公式のコンパイラ</li>
<li><strong>開発サーバー</strong>: elm reactor — 開発用の簡易サーバー</li>
<li><strong>テストフレームワーク</strong>: elm-test — Elm 公式のテストフレームワーク</li>
<li><strong>パッケージ管理</strong>: elm install — Elm 公式のパッケージマネージャー</li>
<li><strong>バージョン管理</strong>: Git — コード管理</li>
</ul>
<h2 id="0">イテレーション0: 環境の構築<a class="headerlink" href="#0" title="Permanent link">&para;</a></h2>
<p>「環境構築って難しそう...」と思われるかもしれませんが、Elm の環境構築は驚くほどシンプルです！</p>
<h3 id="_4">ユーザーストーリー<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<blockquote>
<p>開発者として、Elm 開発環境をセットアップして、テスト駆動開発を始められるようにしたい</p>
</blockquote>
<h3 id="_5">必要なツールのインストール<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<h4 id="1-nodejs">1. Node.js のインストール<a class="headerlink" href="#1-nodejs" title="Permanent link">&para;</a></h4>
<p>Elm は Node.js を必要とします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Node.js のバージョン確認</span>
node<span class="w"> </span>--version
npm<span class="w"> </span>--version
</code></pre></div>
<p>まだインストールされていない場合は、https://nodejs.org/ からインストールしてください。</p>
<h4 id="2-elm">2. Elm のインストール<a class="headerlink" href="#2-elm" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Elm をグローバルにインストール</span>
npm<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>elm

<span class="c1"># Elm のバージョン確認</span>
elm<span class="w"> </span>--version
</code></pre></div>
<h4 id="3-elm-test">3. elm-test のインストール<a class="headerlink" href="#3-elm-test" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># elm-test をグローバルにインストール</span>
npm<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>elm-test

<span class="c1"># elm-test のバージョン確認</span>
elm-test<span class="w"> </span>--version
</code></pre></div>
<h3 id="_6">プロジェクトの初期化<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<h4 id="1">1. プロジェクトディレクトリの作成<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># プロジェクトディレクトリを作成</span>
mkdir<span class="w"> </span>puyo-puyo-elm
<span class="nb">cd</span><span class="w"> </span>puyo-puyo-elm

<span class="c1"># Git リポジトリを初期化</span>
git<span class="w"> </span>init
</code></pre></div>
<h4 id="2-elm_1">2. Elm プロジェクトの初期化<a class="headerlink" href="#2-elm_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># elm.json を作成</span>
elm<span class="w"> </span>init
</code></pre></div>
<p><code>elm.json</code> が作成されます：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;application&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;source-directories&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;src&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;elm-version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.19.1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;direct&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;elm/browser&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;elm/core&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.5&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;elm/html&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;indirect&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;elm/json&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.1.3&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;elm/time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;elm/url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;elm/virtual-dom&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.3&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;test-dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;direct&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">        </span><span class="nt">&quot;indirect&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="3">3. テスト環境の初期化<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># テストディレクトリとサンプルテストを作成</span>
elm-test<span class="w"> </span>init
</code></pre></div>
<p>これにより、<code>tests/</code> ディレクトリと <code>tests/Example.elm</code> が作成されます。</p>
<h4 id="4">4. 必要なパッケージのインストール<a class="headerlink" href="#4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Time モジュールをインストール（ゲームループ用）</span>
elm<span class="w"> </span>install<span class="w"> </span>elm/time

<span class="c1"># Random モジュールをインストール（ランダムなぷよ生成用）</span>
elm<span class="w"> </span>install<span class="w"> </span>elm/random

<span class="c1"># テスト用パッケージ</span>
elm-test<span class="w"> </span>install<span class="w"> </span>elm-explorations/test
</code></pre></div>
<h3 id="_7">タスクランナーの設定<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>プロジェクトの管理を簡単にするため、npm scripts をタスクランナーとして使用します。</p>
<h4 id="packagejson">package.json の作成<a class="headerlink" href="#packagejson" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># package.json を作成</span>
npm<span class="w"> </span>init<span class="w"> </span>-y
</code></pre></div>
<p><code>package.json</code> を以下のように編集します：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;puyo-puyo-elm&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Elm version of Puyo Puyo TDD tutorial&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;elm-test&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;elm reactor&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;elm make src/Main.elm --output=dist/main.js --optimize&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build:dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;elm make src/Main.elm --output=dist/main.js&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;watch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;elm-test --watch&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;clean&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rimraf dist elm-stuff&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;release&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm test &amp;&amp; npm run build &amp;&amp; echo Release build completed successfully!&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;serve&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npx http-server dist -p 8080 -o&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;elm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^0.19.1-5&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;elm-test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^0.19.1-revision12&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="npm-scripts">npm scripts の説明<a class="headerlink" href="#npm-scripts" title="Permanent link">&para;</a></h4>
<p>各スクリプトの役割は以下の通りです：</p>
<ul>
<li><strong><code>npm test</code></strong>: すべてのテストを実行</li>
<li><strong><code>npm run dev</code></strong>: elm reactor で開発サーバーを起動（http://localhost:8000）</li>
<li><strong><code>npm run build</code></strong>: 本番用ビルド（最適化あり）</li>
<li><strong><code>npm run build:dev</code></strong>: 開発用ビルド（デバッグ用）</li>
<li><strong><code>npm run watch</code></strong>: テストの監視モード（ファイル変更時に自動実行）</li>
<li><strong><code>npm run clean</code></strong>: ビルド成果物とキャッシュを削除</li>
<li><strong><code>npm run release</code></strong>: リリースタスク（テスト→本番ビルド）</li>
<li><strong><code>npm run serve</code></strong>: ビルドしたアプリをブラウザで実行（http://localhost:8080）</li>
</ul>
<h4 id="html">リリース用 HTML ファイルの準備<a class="headerlink" href="#html" title="Permanent link">&para;</a></h4>
<p>ビルドしたアプリケーションを実行するための HTML ファイルを用意します：</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- dist/index.html --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;ja&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>ぷよぷよ - Elm 版<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">        </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#1a1a1a</span><span class="p">;</span>
<span class="w">            </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#ffffff</span><span class="p">;</span>
<span class="w">            </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">            </span><span class="k">justify-content</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">            </span><span class="k">align-items</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">            </span><span class="k">min-height</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">vh</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">#</span><span class="nn">app</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#2a2a2a</span><span class="p">;</span>
<span class="w">            </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">box-shadow</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="kt">px</span><span class="w"> </span><span class="mi">6</span><span class="kt">px</span><span class="w"> </span><span class="nb">rgba</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;app&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;main.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Elm</span><span class="p">.</span><span class="nx">Main</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
<span class="w">            </span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<h4 id="gitignore">.gitignore の更新<a class="headerlink" href="#gitignore" title="Permanent link">&para;</a></h4>
<p>npm 関連のファイルとビルド成果物を除外します：</p>
<div class="highlight"><pre><span></span><code># Elm
elm-stuff/

# elm-test
tests/VerifyExamples/

# npm
node_modules/

# ビルド成果物
dist/*.js
dist/*.js.map

# エディタ
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db
</code></pre></div>
<p><strong>注意</strong>: <code>dist/index.html</code> は配布物として必要なため、git の管理対象に含めます。</p>
<h3 id="_8">プロジェクト構成<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>puyo-puyo-elm/
├── elm.json              # Elm プロジェクト設定
├── package.json          # npm scripts 定義
├── package-lock.json     # npm 依存関係ロック
├── src/                  # ソースコード
│   ├── Main.elm          # エントリーポイント
│   ├── Board.elm         # ボード管理
│   ├── Cell.elm          # セル定義
│   ├── PuyoColor.elm     # ぷよの色
│   ├── PuyoPair.elm      # ぷよペア
│   └── GameLogic.elm     # ゲームロジック
├── tests/                # テストコード
│   ├── BoardTests.elm
│   ├── PuyoPairTests.elm
│   ├── GameLogicTests.elm
│   └── MainTests.elm
├── dist/                 # ビルド成果物
│   ├── index.html        # エントリーHTML（配布用）
│   ├── main.js           # ビルドされた JavaScript（.gitignore）
│   └── main.js.map       # ソースマップ（.gitignore）
├── .gitignore            # Git 除外設定
└── README.md             # プロジェクト説明
</code></pre></div>
<h3 id="the-elm-architecture">The Elm Architecture の基本<a class="headerlink" href="#the-elm-architecture" title="Permanent link">&para;</a></h3>
<p>Elm では、すべてのアプリケーションが <strong>The Elm Architecture (TEA)</strong> というパターンに従います。</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Model: アプリケーションの状態</span>
<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">-- Message: 状態を変更するイベント</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Msg</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Increment</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Decrement</span>

<span class="c1">-- init: 初期状態</span>
<span class="nv">init</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">init</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">-- update: メッセージに応じて状態を更新</span>
<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Increment</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">count</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="kt">Decrement</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">count</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>

<span class="c1">-- view: 状態を HTML に変換</span>
<span class="nv">view</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">view</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">button</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">onClick</span><span class="w"> </span><span class="kt">Decrement</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">count</span><span class="p">)</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">button</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">onClick</span><span class="w"> </span><span class="kt">Increment</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;+&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「シンプルですね！」そうなんです。Elm のアーキテクチャは、以下の 3 つの関数で構成されます：</p>
<ol>
<li><strong>Model</strong>: アプリケーションの状態を定義</li>
<li><strong>Update</strong>: メッセージを受け取り、新しい状態を返す</li>
<li><strong>View</strong>: 状態を受け取り、HTML を返す</li>
</ol>
<h3 id="_9">最小限のアプリケーション<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>まず、動作確認のために最小限のアプリケーションを作成しましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">main</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Browser</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Html</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Html</span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="p">,</span><span class="w"> </span><span class="nv">h1</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>


<span class="c1">-- MODEL</span>

<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{}</span>


<span class="nv">init</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">init</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{}</span>


<span class="c1">-- UPDATE</span>

<span class="kr">type</span><span class="w"> </span><span class="kt">Msg</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">NoOp</span>


<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">NoOp</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">model</span>


<span class="c1">-- VIEW</span>

<span class="nv">view</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">view</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">h1</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ - Elm 版&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>


<span class="c1">-- MAIN</span>

<span class="kr">main </span><span class="nf">:</span><span class="w"> </span><span class="kt">Program</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="kt">Msg</span>
<span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">Browser</span><span class="nf">.</span><span class="nv">sandbox</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">init</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">update</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">view</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<h3 id="_10">アプリケーションの実行<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>npm scripts を使って開発サーバーを起動します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 開発サーバーを起動</span>
npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>
<p>ブラウザで http://localhost:8000 を開き、<code>src/Main.elm</code> をクリックすると、アプリケーションが表示されます。</p>
<h3 id="_11">テストの実行<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>npm scripts を使ってテストを実行します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># すべてのテストを実行</span>
npm<span class="w"> </span><span class="nb">test</span>

<span class="c1"># または、ファイル変更時に自動実行（監視モード）</span>
npm<span class="w"> </span>run<span class="w"> </span>watch
</code></pre></div>
<h3 id="_12">リリースビルドとアプリケーションの実行<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>開発が進んだら、最適化されたビルドを作成して実行できます：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># リリースビルド（テスト→最適化ビルド）</span>
npm<span class="w"> </span>run<span class="w"> </span>release

<span class="c1"># ビルドしたアプリケーションをブラウザで実行</span>
npm<span class="w"> </span>run<span class="w"> </span>serve
</code></pre></div>
<p>これにより、http://localhost:8080 でアプリケーションが起動します。</p>
<h3 id="_13">最初のコミット<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>環境構築が完了したら、コミットしましょう：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">chore: initialize Elm project</span>

<span class="s">- Install Elm and elm-test</span>
<span class="s">- Create elm.json with basic dependencies</span>
<span class="s">- Set up project structure (src/ and tests/)</span>
<span class="s">- Add minimal Main.elm application</span>
<span class="s">- Add package.json with npm scripts (test, dev, build, release, serve)</span>
<span class="s">- Add dist/index.html for running built application</span>
<span class="s">- Add .gitignore for Elm and npm projects</span>
<span class="s">- Verify npm test and npm run dev work</span>

<span class="s">🤖 Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;</span>
<span class="s">EOF</span>
<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="elm_1">Elm の型システム<a class="headerlink" href="#elm_1" title="Permanent link">&para;</a></h3>
<p>Elm の強力な型システムについて少し説明しましょう。</p>
<h4 id="custom-types">カスタム型（Custom Types）<a class="headerlink" href="#custom-types" title="Permanent link">&para;</a></h4>
<p>Elm では、独自の型を定義できます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- セルの状態を表す型</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Cell</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Empty</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Filled</span><span class="w"> </span><span class="kt">PuyoColor</span>

<span class="c1">-- ぷよの色を表す型</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Red</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Green</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Yellow</span>
</code></pre></div>
<p>「判別共用体みたいなものですね！」そうです。Elm のカスタム型は、F# の判別共用体や TypeScript の Union 型に似ています。</p>
<h4 id="_14">パターンマッチング<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>カスタム型を使う場合は、パターンマッチングで分岐します：</p>
<div class="highlight"><pre><span></span><code><span class="nv">cellToColor</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Cell</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="nv">cellToColor</span><span class="w"> </span><span class="nv">cell</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">cell</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Empty</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;white&quot;</span>

<span class="w">        </span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;red&quot;</span>

<span class="w">        </span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Green</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;green&quot;</span>

<span class="w">        </span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;blue&quot;</span>

<span class="w">        </span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Yellow</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;yellow&quot;</span>
</code></pre></div>
<p>「網羅性チェックがあるんですね！」そうです。コンパイラがすべてのパターンをチェックしてくれるので、漏れがありません。</p>
<h4 id="maybe">Maybe 型<a class="headerlink" href="#maybe" title="Permanent link">&para;</a></h4>
<p>Elm には <code>null</code> がありません。代わりに <code>Maybe</code> 型を使います：</p>
<div class="highlight"><pre><span></span><code><span class="kr">type</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="nv">a</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">a</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Nothing</span>

<span class="c1">-- 配列から要素を取得（失敗する可能性がある）</span>
<span class="kt">Array</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Array</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="nv">a</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">-- Maybe 型の使用例</span>
<span class="nv">getCell</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">Cell</span>
<span class="nv">getCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&lt;</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cols</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">&lt;</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">rows</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kt">Array</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cells</span>
<span class="w">            </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="nf">.</span><span class="nv">andThen</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>
<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="kt">Nothing</span>
</code></pre></div>
<h4 id="_15">レコード型<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>Elm のレコードは、名前付きフィールドを持つ構造体です：</p>
<div class="highlight"><pre><span></span><code><span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">cols</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">cells</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Array</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="w"> </span><span class="kt">Cell</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">-- レコードの作成</span>
<span class="nv">initialBoard</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span>
<span class="nv">initialBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">cols</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">cells</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Array</span><span class="nf">.</span><span class="nv">repeat</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="nf">.</span><span class="nv">repeat</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">-- レコードの更新（イミュータブル）</span>
<span class="nv">updateBoard</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span>
<span class="nv">updateBoard</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">cols</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1">-- cols のみ更新した新しいレコードを返す</span>
</code></pre></div>
<h3 id="elm_2">Elm の関数型プログラミング<a class="headerlink" href="#elm_2" title="Permanent link">&para;</a></h3>
<h4 id="_16">不変性<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>Elm では、すべての値が不変（イミュータブル）です：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 元のリストは変更されず、新しいリストが返される</span>
<span class="nv">numbers</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">Int</span>
<span class="nv">numbers</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">]</span>

<span class="c1">-- 新しいリストを作成</span>
<span class="nv">newNumbers</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">Int</span>
<span class="nv">newNumbers</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">n</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nf">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="nv">numbers</span>
<span class="w">    </span><span class="c1">-- [ 2, 4, 6 ]</span>

<span class="c1">-- numbers は変更されていない</span>
<span class="c1">-- [ 1, 2, 3 ]</span>
</code></pre></div>
<h4 id="_17">パイプライン演算子<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>Elm のパイプライン演算子 <code>|&gt;</code> は、関数を左から右へ適用します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- パイプラインなし</span>
<span class="nv">result</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">String</span><span class="nf">.</span><span class="nv">toUpper</span><span class="w"> </span><span class="p">(</span><span class="kt">String</span><span class="nf">.</span><span class="nv">trim</span><span class="w"> </span><span class="s">&quot;  hello  &quot;</span><span class="p">)</span>

<span class="c1">-- パイプラインあり</span>
<span class="nv">result</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="s">&quot;  hello  &quot;</span>
<span class="w">        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">trim</span>
<span class="w">        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">toUpper</span>
</code></pre></div>
<p>「処理の流れが読みやすいですね！」そうです。データの変換過程が明確になります。</p>
<h3 id="0_1">イテレーション０のまとめ<a class="headerlink" href="#0_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションでは、以下を学びました：</p>
<ol>
<li><strong>Elm のインストール</strong>: elm と elm-test のセットアップ</li>
<li><strong>プロジェクト構成</strong>: src/ と tests/ の構造、package.json と dist/ の配置</li>
<li><strong>タスクランナー</strong>: npm scripts を使った開発ワークフロー（test, dev, build, release, serve）</li>
<li><strong>The Elm Architecture</strong>: Model-Update-View パターン</li>
<li><strong>型システムの基本</strong>: カスタム型、Maybe 型、レコード型</li>
<li><strong>関数型プログラミング</strong>: 不変性、パターンマッチング、パイプライン演算子</li>
<li><strong>開発ツール</strong>: npm run dev（elm reactor）と npm test（elm-test）の使い方</li>
<li><strong>リリースビルド</strong>: 最適化ビルドとブラウザでの実行方法</li>
</ol>
<p><strong>開発ワークフロー</strong>：
- 開発時: <code>npm run dev</code> で elm reactor を起動
- テスト: <code>npm test</code> でテスト実行、<code>npm run watch</code> で監視モード
- リリース: <code>npm run release</code> でテスト→ビルド、<code>npm run serve</code> でアプリ起動</p>
<p>次のイテレーションでは、実際にぷよぷよゲームのドメインモデルを作成していきます！</p>
<h2 id="1_1">イテレーション1: ゲーム開始の実装<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよコードを書き始めましょう！テスト駆動開発では、小さなイテレーション（反復）で機能を少しずつ追加していきます。最初のイテレーションでは、最も基本的な機能である「ゲームの開始」を実装します。</p>
<blockquote>
<p>システム構築はどこから始めるべきだろうか。システム構築が終わったらこうなる、というストーリーを語るところからだ。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<h3 id="_18">ユーザーストーリー<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、新しいゲームを開始できる</p>
</blockquote>
<p>このシンプルなストーリーから始めることで、ゲームの基本的な構造を作り、後続の機能追加の土台を築くことができます。では、テスト駆動開発のサイクルに従って、まずはテストから書いていきましょう！</p>
<h3 id="todo">TODOリスト<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h3>
<p>さて、ユーザーストーリーを実装するために、まずはTODOリストを作成しましょう。TODOリストは、大きな機能を小さなタスクに分解するのに役立ちます。</p>
<blockquote>
<p>何をテストすべきだろうか - 着手する前に、必要になりそうなテストをリストに書き出しておこう。</p>
<p>— Kent Beck 『テスト駆動開発』</p>
</blockquote>
<p>私たちの「新しいゲームを開始できる」というユーザーストーリーを実現するためには、どのようなタスクが必要でしょうか？考えてみましょう：</p>
<ul>
<li>ドメインモデルの定義（Cell、PuyoColor、Board、PuyoPair 型）</li>
<li>ボードの初期化処理（空のボードを作成）</li>
<li>ボードの操作関数（セルの取得、セルの設定）</li>
<li>ぷよペアの作成と配置</li>
<li>The Elm Architecture の実装（Model、Msg、update、view）</li>
<li>ゲームの初期化処理</li>
</ul>
<p>これらのタスクを一つずつ実装していきましょう。テスト駆動開発では、各タスクに対してテスト→実装→リファクタリングのサイクルを回します。まずは「ドメインモデルの定義」から始めましょう！</p>
<h3 id="_19">ドメインモデルの設計<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>Elm では型を使ってドメインモデルを明確に表現できます。まずは、ぷよぷよゲームの基本的な概念を型として定義しましょう。</p>
<h4 id="_20">セルの状態を表す型<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<p>ボードの各セルは、「空」か「ぷよで埋まっている」のどちらかの状態です。これを Elm のカスタム型で表現します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Cell.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="p">)</span>


<span class="kr">type</span><span class="w"> </span><span class="kt">Cell</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Empty</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Filled</span><span class="w"> </span><span class="kt">PuyoColor</span>
</code></pre></div>
<p>「シンプルですね！」そうなんです。Elm のカスタム型は、TypeScript の Union 型や F# の判別共用体に似ていますが、コンパイラによる網羅性チェックが強力なのが特徴です。</p>
<h4 id="_21">ぷよの色を表す型<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h4>
<p>ぷよには4つの色があります：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/PuyoColor.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="nf">(..)</span><span class="p">)</span>


<span class="kr">type</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Red</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Green</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Yellow</span>
</code></pre></div>
<p>「この型定義、とても読みやすいですね！」そうなんです。Elm の型システムは、コードを自己文書化してくれます。</p>
<h4 id="_22">ボードを表す型<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>次に、ゲームのボード（盤面）を表す型を定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Board.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="nv">exposing</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="kt">Cols</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="kt">Rows</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">create</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">getCell</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">setCell</span>
<span class="w">    </span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Array</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Cols</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">Int</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Rows</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">Int</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">cols</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Cols</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Rows</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">cells</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Array</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="w"> </span><span class="kt">Cell</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- ボードを作成する</span>
<span class="nv">create</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Cols</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Rows</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span>
<span class="nv">create</span><span class="w"> </span><span class="nv">cols</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">cols</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">cols</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">rows</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">cells</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Array</span><span class="nf">.</span><span class="nv">repeat</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="nf">.</span><span class="nv">repeat</span><span class="w"> </span><span class="nv">cols</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- セルを取得する</span>
<span class="nv">getCell</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">Cell</span>
<span class="nv">getCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&lt;</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cols</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">&lt;</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">rows</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kt">Array</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cells</span>
<span class="w">            </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="nf">.</span><span class="nv">andThen</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>

<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="kt">Nothing</span>


<span class="c1">-- セルを設定する</span>
<span class="nv">setCell</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Cell</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span>
<span class="nv">setCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">cell</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&lt;</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cols</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">&lt;</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">rows</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">let</span>
<span class="w">            </span><span class="nv">newRow</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                </span><span class="kt">Array</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cells</span>
<span class="w">                    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">row</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Array</span><span class="nf">.</span><span class="nv">set</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">cell</span><span class="w"> </span><span class="nv">row</span><span class="p">)</span>
<span class="w">                    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="nf">.</span><span class="nv">withDefault</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="nf">.</span><span class="nv">repeat</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cols</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>

<span class="w">            </span><span class="nv">newCells</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                </span><span class="kt">Array</span><span class="nf">.</span><span class="nv">set</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">newRow</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cells</span>
<span class="w">        </span><span class="kr">in</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">cells</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newCells</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="nv">board</span>
</code></pre></div>
<p>「<code>Maybe</code> 型を使っているんですね！」そうです。Elm には <code>null</code> がないので、失敗する可能性のある操作は <code>Maybe</code> 型で表現します。これにより、<code>null</code> 参照エラーが起こらない安全なコードが書けるんです。</p>
<h4 id="_23">ぷよペアを表す型<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>ぷよぷよでは、2つのぷよが一組になって落ちてきます。これを「ぷよペア」として定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/PuyoPair.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="nv">exposing</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">create</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">getPositions</span>
<span class="w">    </span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="p">)</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Position</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">}</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- ぷよペアを作成する</span>
<span class="nv">create</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">create</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axisColor</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">childColor</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- ぷよペアの位置を取得する</span>
<span class="nv">getPositions</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Position</span><span class="p">,</span><span class="w"> </span><span class="kt">Position</span><span class="w"> </span><span class="p">)</span>
<span class="nv">getPositions</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="p">,</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>「レコード型を使っているんですね！」そうです。Elm のレコード型は、名前付きフィールドを持つ構造体です。型エイリアス（<code>type alias</code>）を使うことで、複雑な型に意味のある名前を付けられます。</p>
<h3 id="_24">テスト: ボードの操作<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>では、定義したドメインモデルが正しく動作することをテストしましょう。Elm では <code>elm-test</code> を使ってテストを書きます。</p>
<h4 id="_25">ボードのテスト<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/BoardTests.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">BoardTests</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">suite</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Array</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Expect</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Test</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Test</span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="p">)</span>


<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;Board&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;create&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;指定したサイズの空のボードを作成できる&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">all</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="nv">b</span><span class="nf">.</span><span class="nv">cols</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="nv">b</span><span class="nf">.</span><span class="nv">rows</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="p">(</span><span class="kt">Array</span><span class="nf">.</span><span class="nv">length</span><span class="w"> </span><span class="nv">b</span><span class="nf">.</span><span class="nv">cells</span><span class="p">)</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="nv">board</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;getCell&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;範囲内のセルを取得できる&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;範囲外のセルは Nothing を返す&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;setCell&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;セルに値を設定できる&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="nv">updatedBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">updatedBoard</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">))</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;範囲外のセルへの設定は無視される&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="nv">updatedBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">updatedBoard</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「テストコードも読みやすいですね！」そうです。Elm のテストは、<code>describe</code> でグループ化し、<code>test</code> で個別のテストケースを定義します。<code>\_ -&gt;</code> はラムダ式（無名関数）で、引数を無視しています。</p>
<h3 id="_26">テストの実行<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm-test
</code></pre></div>
<p>すべてのテストが通れば成功です！</p>
<div class="highlight"><pre><span></span><code>TEST RUN PASSED

Duration: 123 ms
Passed:   7
Failed:   0
</code></pre></div>
<p>「おお、すべてのテストが通りました！」素晴らしいですね。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<h3 id="the-elm-architecture_1">The Elm Architecture の実装<a class="headerlink" href="#the-elm-architecture_1" title="Permanent link">&para;</a></h3>
<p>次に、The Elm Architecture (TEA) を使ってゲームのメイン構造を実装します。</p>
<h4 id="model">Model の定義<a class="headerlink" href="#model" title="Permanent link">&para;</a></h4>
<p>まず、アプリケーションの状態を表す Model を定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">main</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Browser</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Html</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Html</span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="p">,</span><span class="w"> </span><span class="nv">h1</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Html.Attributes</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">style</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="p">)</span>


<span class="c1">-- MODEL</span>


<span class="kr">type</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">GameOver</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="p">}</span>


<span class="nv">init</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">init</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>「<code>GameMode</code> というカスタム型を定義しているんですね！」そうです。ゲームの状態を明確に型で表現することで、どの状態でどの操作が可能かをコンパイラがチェックしてくれます。</p>
<h4 id="msg">Msg の定義<a class="headerlink" href="#msg" title="Permanent link">&para;</a></h4>
<p>次に、アプリケーションで発生するイベントを表す Msg を定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- UPDATE</span>


<span class="kr">type</span><span class="w"> </span><span class="kt">Msg</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">StartGame</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Tick</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">NoOp</span>


<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">StartGame</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="c1">-- 後で実装</span>
<span class="w">            </span><span class="nv">model</span>

<span class="w">        </span><span class="kt">NoOp</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">model</span>
</code></pre></div>
<p>「<code>StartGame</code> メッセージでゲームを開始するんですね！」そうです。メッセージを受け取ると、新しい Model を返します。Elm では、すべてのデータが不変（イミュータブル）なので、元の Model を変更せず、新しい Model を作成して返します。</p>
<h4 id="view">View の実装<a class="headerlink" href="#view" title="Permanent link">&para;</a></h4>
<p>最後に、Model を HTML に変換する View を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- VIEW</span>


<span class="nv">view</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">view</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;padding&quot;</span><span class="w"> </span><span class="s">&quot;20px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-family&quot;</span><span class="w"> </span><span class="s">&quot;Arial, sans-serif&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">h1</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ - Elm 版&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ゲームモード: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="nv">gameModeToString</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">)</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">viewBoard</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">viewCurrentPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span>
<span class="w">        </span><span class="p">]</span>


<span class="nv">gameModeToString</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">GameMode</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="nv">gameModeToString</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Start</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;スタート&quot;</span>

<span class="w">        </span><span class="kt">Playing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;プレイ中&quot;</span>

<span class="w">        </span><span class="kt">GameOver</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;ゲームオーバー&quot;</span>


<span class="nv">viewBoard</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewBoard</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin-top&quot;</span><span class="w"> </span><span class="s">&quot;20px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;padding&quot;</span><span class="w"> </span><span class="s">&quot;10px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;background-color&quot;</span><span class="w"> </span><span class="s">&quot;#f0f0f0&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;display&quot;</span><span class="w"> </span><span class="s">&quot;inline-block&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ボード: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cols</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">board</span><span class="nf">.</span><span class="nv">rows</span><span class="p">)</span><span class="w"> </span><span class="p">]</span>


<span class="nv">viewCurrentPair</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewCurrentPair</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">div</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin-top&quot;</span><span class="w"> </span><span class="s">&quot;10px&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span>
<span class="w">                    </span><span class="p">(</span><span class="s">&quot;現在のぷよペア: (&quot;</span>
<span class="w">                        </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">                        </span><span class="nf">++</span><span class="w"> </span><span class="s">&quot;, &quot;</span>
<span class="w">                        </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span>
<span class="w">                        </span><span class="nf">++</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">]</span>

<span class="w">        </span><span class="kt">Nothing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[]</span>
</code></pre></div>
<p>「<code>Maybe</code> 型のパターンマッチングを使っているんですね！」そうです。<code>currentPair</code> が <code>Just pair</code> の場合はぷよペアを表示し、<code>Nothing</code> の場合は何も表示しません。コンパイラが両方のケースをチェックしてくれるので、安全です。</p>
<h4 id="main">Main 関数<a class="headerlink" href="#main" title="Permanent link">&para;</a></h4>
<p>最後に、アプリケーションのエントリーポイントを定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- MAIN</span>


<span class="kr">main </span><span class="nf">:</span><span class="w"> </span><span class="kt">Program</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="kt">Msg</span>
<span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">Browser</span><span class="nf">.</span><span class="nv">sandbox</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="p">()</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">update</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">view</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<p>「<code>Browser.sandbox</code> を使っているんですね！」そうです。<code>Browser.sandbox</code> は、コマンドやサブスクリプション（外部との通信）が不要な、シンプルなアプリケーションに最適です。</p>
<h3 id="_27">アプリケーションの実行<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>では、アプリケーションを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm<span class="w"> </span>reactor
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開き、<code>src/Main.elm</code> をクリックすると、ぷよぷよゲームの初期画面が表示されます。</p>
<p>「ゲームが表示されました！」おめでとうございます！リリースに向けて最初の第一歩を踏み出すことができました。</p>
<blockquote>
<p>トップダウンでもボトムアップでもなく、エンドツーエンドで構築していく</p>
<p>エンドツーエンドで小さな機能を構築し、そこから作業を進めながら問題について学習していく。</p>
<p>— 達人プログラマー 熟達に向けたあなたの旅（第2版）</p>
</blockquote>
<h3 id="1_2">イテレーション1のまとめ<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ドメインモデルの定義</strong></li>
<li><code>Cell</code> 型: セルの状態（Empty または Filled）</li>
<li><code>PuyoColor</code> 型: ぷよの色（Red, Green, Blue, Yellow）</li>
<li><code>Board</code> 型: ゲームボード（cols, rows, cells）</li>
<li>
<p><code>PuyoPair</code> 型: ぷよペア（axis, child, colors）</p>
</li>
<li>
<p><strong>ボード操作関数</strong></p>
</li>
<li><code>create</code>: 空のボードを作成</li>
<li><code>getCell</code>: セルを取得（Maybe 型を返す）</li>
<li>
<p><code>setCell</code>: セルを設定（範囲外は無視）</p>
</li>
<li>
<p><strong>The Elm Architecture の実装</strong></p>
</li>
<li><code>Model</code>: アプリケーションの状態（board, currentPair, mode）</li>
<li><code>Msg</code>: イベント（StartGame, Tick, NoOp）</li>
<li><code>update</code>: メッセージに応じた状態更新</li>
<li>
<p><code>view</code>: 状態を HTML に変換</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>ボード操作関数のテスト（範囲チェック含む）</li>
<li>elm-test による自動テスト</li>
</ol>
<h3 id="_28">学んだこと<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>型安全性</strong>: Elm のカスタム型で、不正な状態を型レベルで防ぐ</li>
<li><strong>Maybe 型</strong>: null を排除し、失敗する可能性を明示的に扱う</li>
<li><strong>不変性</strong>: すべてのデータがイミュータブルで、副作用がない</li>
<li><strong>パターンマッチング</strong>: コンパイラによる網羅性チェック</li>
<li><strong>The Elm Architecture</strong>: シンプルで予測可能な状態管理</li>
</ul>
<p>次のイテレーションでは、キーボード入力でぷよを移動できるようにします！</p>
<h2 id="2">イテレーション2: ぷよの移動の実装<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さて、前回のイテレーションでゲームの基本的な構造ができましたね。「ゲームが始まったけど、ぷよが動かないと面白くないよね？」と思いませんか？そこで次は、ぷよを左右に移動できるようにしていきましょう！</p>
<h3 id="_29">ユーザーストーリー<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを左右に移動できる</p>
</blockquote>
<p>「ぷよぷよって、落ちてくるぷよを左右に動かして、うまく積み上げるゲームですよね？」そうです！今回はその基本操作である「左右の移動」を実装していきます。</p>
<h3 id="todo_1">TODOリスト<a class="headerlink" href="#todo_1" title="Permanent link">&para;</a></h3>
<p>さて、このユーザーストーリーを実現するために、どんなタスクが必要でしょうか？一緒に考えてみましょう。
「ぷよを左右に移動する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>キーボード入力を検出する（Browser.Events でキーボードイベントを購読）</li>
<li>ぷよペアの移動処理を実装する（左右への移動）</li>
<li>移動可能かどうかのチェック（ボードの端や既存のぷよとの衝突判定）</li>
<li>The Elm Architecture への統合（Msg、update、subscriptions）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_30">キーボード入力の設計<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>Elm では、キーボード入力を扱うために <code>Browser.Events</code> モジュールの <code>onKeyDown</code> を使います。TypeScript 版とは異なり、Elm では副作用（イベントリスナーの登録など）はすべて The Elm Architecture の枠組みの中で管理されます。</p>
<p>まず、必要なパッケージをインストールします：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Browser.Events モジュールを含むパッケージは既に elm/browser に含まれている</span>
<span class="c1"># JSON デコーダを使うために elm/json が必要（既にインストール済み）</span>
</code></pre></div>
<h3 id="_31">テスト: ぷよペアの移動<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>まずは、ぷよペアの移動ロジックをテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/PuyoPairTests.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">PuyoPairTests</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">suite</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Expect</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoPair</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Test</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Test</span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="p">)</span>


<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;PuyoPair&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;moveLeft&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;左に移動できる場合、左に移動する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveLeft</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">movedPair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;左端にいる場合でも移動する（衝突判定は別で行う）&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveLeft</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="nf">-</span><span class="mi">1</span><span class="w"> </span><span class="nv">movedPair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;moveRight&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;右に移動できる場合、右に移動する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveRight</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">movedPair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;canMove&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;移動先にぷよがなければ移動可能&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">True</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;軸ぷよがボード範囲外なら移動不可&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="nf">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;子ぷよがボード範囲外なら移動不可&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nf">-</span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;移動先にぷよがあれば移動不可&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「Elm のテストは型安全ですね！」そうなんです。Elm では、コンパイラが型チェックをしてくれるので、テストを書く段階で多くのバグを防げます。</p>
<h3 id="_32">実装: ぷよペアの移動<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>では、テストが通るように PuyoPair モジュールを拡張しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/PuyoPair.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="nv">exposing</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">canMove</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">create</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">getPositions</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">moveLeft</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">moveRight</span>
<span class="w">    </span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="p">)</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Position</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">}</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- ぷよペアを作成する</span>
<span class="nv">create</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">create</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axisColor</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">childColor</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- ぷよペアの位置を取得する</span>
<span class="nv">getPositions</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Position</span><span class="p">,</span><span class="w"> </span><span class="kt">Position</span><span class="w"> </span><span class="p">)</span>
<span class="nv">getPositions</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="p">,</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="w"> </span><span class="p">)</span>


<span class="c1">-- 左に移動する</span>
<span class="nv">moveLeft</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">moveLeft</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">        </span><span class="nf">|</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- 右に移動する</span>
<span class="nv">moveRight</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">moveRight</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">        </span><span class="nf">|</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- 移動可能かチェックする</span>
<span class="nv">canMove</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Bool</span>
<span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">axisCell</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="nv">childCell</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">axisCell</span><span class="p">,</span><span class="w"> </span><span class="nv">childCell</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">True</span>

<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">False</span>
</code></pre></div>
<p>「不変性を保ちながら移動しているんですね！」そうです。Elm では、すべてのデータが不変（イミュータブル）なので、元のぷよペアを変更せず、新しいぷよペアを作成して返します。レコード更新構文（<code>{ pair | ... }</code>）を使うことで、一部のフィールドだけを更新した新しいレコードを簡潔に作れます。</p>
<h3 id="_33">テストの実行<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm-test
</code></pre></div>
<p>すべてのテストが通れば成功です！</p>
<div class="highlight"><pre><span></span><code>TEST RUN PASSED

Duration: 145 ms
Passed:   13
Failed:   0
</code></pre></div>
<p>「おお、すべてのテストが通りました！」素晴らしいですね。これがテスト駆動開発の「Green（緑）」の状態です。</p>
<h3 id="the-elm-architecture_2">The Elm Architecture への統合<a class="headerlink" href="#the-elm-architecture_2" title="Permanent link">&para;</a></h3>
<p>次に、キーボード入力を The Elm Architecture に統合します。Elm では、キーボードイベントは「サブスクリプション（Subscriptions）」として扱います。</p>
<p>まず、Main.elm を更新して、キーボード入力を処理できるようにします：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">main</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Browser</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Browser.Events</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Html</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Html</span><span class="p">,</span><span class="w"> </span><span class="nv">button</span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="p">,</span><span class="w"> </span><span class="nv">h1</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Html.Attributes</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">style</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Html.Events</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">onClick</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Json.Decode</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">Decode</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="p">)</span>


<span class="c1">-- MODEL</span>


<span class="kr">type</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">GameOver</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="p">}</span>


<span class="nv">init</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">init</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">    </span><span class="p">)</span>


<span class="c1">-- UPDATE</span>


<span class="kr">type</span><span class="w"> </span><span class="kt">Msg</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">StartGame</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="kt">String</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Tick</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">NoOp</span>


<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">StartGame</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">,</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="p">(</span><span class="w"> </span><span class="kt">Playing</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">newPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kr">case</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                                </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveLeft</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                        </span><span class="nv">movedPair</span>

<span class="w">                                    </span><span class="kr">else</span>
<span class="w">                                        </span><span class="nv">pair</span>

<span class="w">                                </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveRight</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                        </span><span class="nv">movedPair</span>

<span class="w">                                    </span><span class="kr">else</span>
<span class="w">                                        </span><span class="nv">pair</span>

<span class="w">                                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="nv">pair</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="c1">-- 後で実装</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="kt">NoOp</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>


<span class="c1">-- SUBSCRIPTIONS</span>


<span class="nv">subscriptions</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Sub</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">subscriptions</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Playing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Browser</span><span class="nf">.</span><span class="kt">Events</span><span class="nf">.</span><span class="nv">onKeyDown</span><span class="w"> </span><span class="p">(</span><span class="kt">Decode</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="nv">keyDecoder</span><span class="p">)</span>

<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Sub</span><span class="nf">.</span><span class="nv">none</span>


<span class="nv">keyDecoder</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Decode</span><span class="nf">.</span><span class="kt">Decoder</span><span class="w"> </span><span class="kt">String</span>
<span class="nv">keyDecoder</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">Decode</span><span class="nf">.</span><span class="nv">field</span><span class="w"> </span><span class="s">&quot;key&quot;</span><span class="w"> </span><span class="kt">Decode</span><span class="nf">.</span><span class="nv">string</span>


<span class="c1">-- VIEW</span>


<span class="nv">view</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">view</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;padding&quot;</span><span class="w"> </span><span class="s">&quot;20px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-family&quot;</span><span class="w"> </span><span class="s">&quot;Arial, sans-serif&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">h1</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ - Elm 版&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ゲームモード: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="nv">gameModeToString</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">)</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">viewGameControls</span><span class="w"> </span><span class="nv">model</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">viewBoard</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span>
<span class="w">        </span><span class="p">]</span>


<span class="nv">viewGameControls</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewGameControls</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Start</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">button</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">onClick</span><span class="w"> </span><span class="kt">StartGame</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ゲーム開始&quot;</span><span class="w"> </span><span class="p">]</span>

<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[]</span>


<span class="nv">gameModeToString</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">GameMode</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="nv">gameModeToString</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Start</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;スタート&quot;</span>

<span class="w">        </span><span class="kt">Playing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;プレイ中&quot;</span>

<span class="w">        </span><span class="kt">GameOver</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;ゲームオーバー&quot;</span>


<span class="nv">viewBoard</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewBoard</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin-top&quot;</span><span class="w"> </span><span class="s">&quot;20px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;display&quot;</span><span class="w"> </span><span class="s">&quot;inline-block&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;border&quot;</span><span class="w"> </span><span class="s">&quot;2px solid #444&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;background-color&quot;</span><span class="w"> </span><span class="s">&quot;#2a2a2a&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nv">board</span><span class="nf">.</span><span class="nv">rows</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">y</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">viewRow</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>


<span class="nv">viewRow</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewRow</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;display&quot;</span><span class="w"> </span><span class="s">&quot;flex&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nv">board</span><span class="nf">.</span><span class="nv">cols</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">x</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">viewCell</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>


<span class="nv">viewCell</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewCell</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">cellContent</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="kt">Just</span><span class="w"> </span><span class="nv">cell</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="nv">cell</span>

<span class="w">                </span><span class="kt">Nothing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kt">Empty</span>

<span class="w">        </span><span class="nv">isPairPosition</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span>
<span class="w">                        </span><span class="nf">||</span><span class="w"> </span><span class="p">(</span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span>

<span class="w">                </span><span class="kt">Nothing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kt">False</span>

<span class="w">        </span><span class="nv">color</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">isPairPosition</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="kr">case</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                    </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                        </span><span class="kr">if</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">&amp;&amp;</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                            </span><span class="nv">puyoColorToString</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axisColor</span>

<span class="w">                        </span><span class="kr">else</span>
<span class="w">                            </span><span class="nv">puyoColorToString</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">childColor</span>

<span class="w">                    </span><span class="kt">Nothing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                        </span><span class="s">&quot;#888&quot;</span>

<span class="w">            </span><span class="kr">else</span>
<span class="w">                </span><span class="kr">case</span><span class="w"> </span><span class="nv">cellContent</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                    </span><span class="kt">Empty</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                        </span><span class="s">&quot;#888&quot;</span>

<span class="w">                    </span><span class="kt">Filled</span><span class="w"> </span><span class="nv">puyoColor</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                        </span><span class="nv">puyoColorToString</span><span class="w"> </span><span class="nv">puyoColor</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="nv">div</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;width&quot;</span><span class="w"> </span><span class="s">&quot;32px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;height&quot;</span><span class="w"> </span><span class="s">&quot;32px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin&quot;</span><span class="w"> </span><span class="s">&quot;2px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;border-radius&quot;</span><span class="w"> </span><span class="s">&quot;50%&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;background-color&quot;</span><span class="w"> </span><span class="nv">color</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;border&quot;</span><span class="w"> </span><span class="s">&quot;2px solid #000&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="p">[]</span>


<span class="nv">puyoColorToString</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="nv">puyoColorToString</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Red</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;#ff0000&quot;</span>

<span class="w">        </span><span class="kt">Green</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;#00ff00&quot;</span>

<span class="w">        </span><span class="kt">Blue</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;#0000ff&quot;</span>

<span class="w">        </span><span class="kt">Yellow</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="s">&quot;#ffff00&quot;</span>


<span class="c1">-- MAIN</span>


<span class="kr">main </span><span class="nf">:</span><span class="w"> </span><span class="kt">Program</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="kt">Msg</span>
<span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">Browser</span><span class="nf">.</span><span class="nv">element</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nv">init</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">init</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">update</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">view</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">view</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">subscriptions</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">subscriptions</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<p>「<code>Browser.element</code> に変わったんですね！」そうです。<code>Browser.sandbox</code> は、コマンドやサブスクリプションが使えないシンプルなアプリケーション用です。今回はキーボードイベントを購読する必要があるので、<code>Browser.element</code> を使います。</p>
<p>「サブスクリプションって何ですか？」良い質問です！サブスクリプションは、外部からのイベント（キーボード入力、タイマー、WebSocket など）を Elm アプリケーションに通知する仕組みです。Elm では、すべての副作用が The Elm Architecture の枠組みの中で管理されるので、イベントリスナーの登録もサブスクリプションとして宣言的に記述します。</p>
<h3 id="_34">アプリケーションの実行<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p>では、アプリケーションを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm<span class="w"> </span>reactor
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開き、<code>src/Main.elm</code> をクリックします。「ゲーム開始」ボタンをクリックすると、ぷよペアが表示されます。キーボードの左右矢印キーを押すと、ぷよが左右に移動します！</p>
<p>「本当だ！ぷよが動きました！」おめでとうございます！キーボード入力でぷよを操作できるようになりましたね。</p>
<h3 id="2_1">イテレーション2のまとめ<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ぷよペアの移動機能</strong></li>
<li><code>moveLeft</code>: 左に移動</li>
<li><code>moveRight</code>: 右に移動</li>
<li>
<p><code>canMove</code>: 移動可能かチェック（ボード範囲と衝突判定）</p>
</li>
<li>
<p><strong>キーボード入力の統合</strong></p>
</li>
<li><code>Browser.Events.onKeyDown</code>: キーボードイベントの購読</li>
<li><code>keyDecoder</code>: JSON デコーダでキー名を取得</li>
<li>
<p><code>subscriptions</code>: ゲームモードに応じたサブスクリプション</p>
</li>
<li>
<p><strong>The Elm Architecture の拡張</strong></p>
</li>
<li><code>Browser.element</code>: コマンドとサブスクリプションをサポート</li>
<li><code>init</code>: タプル（Model, Cmd）を返すように変更</li>
<li><code>update</code>: タプル（Model, Cmd）を返すように変更</li>
<li>
<p><code>KeyPressed</code>: キー入力メッセージの追加</p>
</li>
<li>
<p><strong>ビューの改善</strong></p>
</li>
<li>ボードとぷよペアの視覚的な表示</li>
<li>CSS スタイルで円形のぷよを表現</li>
<li>ゲーム開始ボタンの追加</li>
</ol>
<h3 id="_35">学んだこと<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>サブスクリプション</strong>: 外部イベントを宣言的に購読する仕組み</li>
<li><strong>JSON デコーダ</strong>: 外部データ（キーボードイベント）を Elm の型に変換</li>
<li><strong>不変性</strong>: レコード更新構文で一部のフィールドを更新</li>
<li><strong>パターンマッチング</strong>: Maybe 型とタプルの組み合わせでロジックを表現</li>
<li><strong>Browser.element</strong>: コマンドとサブスクリプションが必要な場合に使用</li>
</ul>
<p>次のイテレーションでは、ぷよを回転させる機能を実装します！</p>
<h2 id="3_1">イテレーション3: ぷよの回転の実装<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h2>
<p>「左右に移動できるようになったけど、ぷよぷよって回転もできますよね？」そうですね！ぷよぷよの醍醐味の一つは、ぷよを回転させて思い通りの場所に配置することです。今回は、ぷよを回転させる機能を実装していきましょう！</p>
<h3 id="_36">ユーザーストーリー<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、落ちてくるぷよを回転できる</p>
</blockquote>
<p>「回転って具体的にどういう動きですか？」良い質問ですね！ぷよぷよでは、2つのぷよが連なった状態で落ちてきます。回転とは、この2つのぷよの相対的な位置関係を変えることです。例えば、縦に並んでいるぷよを横に並ぶように変えたりできるんですよ。</p>
<h3 id="todo_2">TODOリスト<a class="headerlink" href="#todo_2" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを回転させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ぷよの回転状態を管理する（0: 上、1: 右、2: 下、3: 左）</li>
<li>ぷよペアの回転処理を実装する（時計回り・反時計回り）</li>
<li>回転可能かどうかのチェックを実装する（壁や既存のぷよとの衝突判定）</li>
<li>壁キック処理を実装する（壁際での回転を可能にする特殊処理）</li>
<li>The Elm Architecture への統合（回転メッセージの追加）</li>
</ul>
<p>「壁キックって何ですか？」壁キックとは、ぷよが壁際にあるときに回転すると壁にめり込んでしまうので、自動的に少し位置をずらして回転を可能にする処理のことです。プレイヤーの操作性を向上させるための工夫なんですよ。</p>
<h3 id="_37">テスト: ぷよペアの回転<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>「まずは何からテストしますか？」テスト駆動開発の流れに沿って、まずは基本的な回転機能のテストから書いていきましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/PuyoPairTests.elm（続き）</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;PuyoPair&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="c1">-- 既存のテスト...</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;rotate&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;時計回りに回転すると、子ぷよが軸ぷよの右に移動する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="c1">-- 子ぷよが上にある状態（rotation = 0）</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                        </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotate</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">all</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="nv">rotatedPair</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;4回回転すると元の位置に戻る&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                        </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">pair</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotate</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotate</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotate</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotate</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">all</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">axis</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">child</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="nv">rotatedPair</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;rotateWithKick&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;壁際で回転時、壁キックが発生する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="c1">-- 右端に配置（x = 5）</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                        </span><span class="c1">-- 回転すると子ぷよが壁外（x = 6）になるので壁キック</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="nv">movedPair</span><span class="p">,</span><span class="w"> </span><span class="nv">kicked</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotateWithKick</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">all</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">True</span><span class="w"> </span><span class="nv">kicked</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nv">movedPair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="p">()</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;壁キックが不要な場合、位置は変わらない&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="c1">-- 中央に配置</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="p">,</span><span class="w"> </span><span class="nv">kicked</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotateWithKick</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">all</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span><span class="w"> </span><span class="nv">kicked</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="p">()</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li>時計回りに回転すると、子ぷよの位置が正しく変わるか</li>
<li>4回回転すると元の位置に戻るか（循環するか）</li>
<li>壁際で回転時、壁キックが正しく発生するか</li>
<li>壁キックが不要な場合、位置が変わらないか</li>
</ol>
<h3 id="_38">実装: ぷよペアの回転<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>では、テストが通るように PuyoPair モジュールを拡張しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/PuyoPair.elm（拡張版）</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="nv">exposing</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">canMove</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">create</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">getPositions</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">moveLeft</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">moveRight</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rotate</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rotateWithKick</span>
<span class="w">    </span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="p">)</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Position</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">}</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoColor</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rotation</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- ぷよペアを作成する</span>
<span class="nv">create</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">create</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axisColor</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">childColor</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rotation</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- ぷよペアの位置を取得する</span>
<span class="nv">getPositions</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Position</span><span class="p">,</span><span class="w"> </span><span class="kt">Position</span><span class="w"> </span><span class="p">)</span>
<span class="nv">getPositions</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="p">,</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="w"> </span><span class="p">)</span>


<span class="c1">-- 左に移動する</span>
<span class="nv">moveLeft</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">moveLeft</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">        </span><span class="nf">|</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- 右に移動する</span>
<span class="nv">moveRight</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">moveRight</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">        </span><span class="nf">|</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- 時計回りに回転する（90度）</span>
<span class="nv">rotate</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">rotate</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">newRotation</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">modBy</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="nv">pair</span><span class="nf">.</span><span class="nv">rotation</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">        </span><span class="nv">childPos</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">getChildPosition</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="w"> </span><span class="nv">newRotation</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">        </span><span class="nf">|</span><span class="w"> </span><span class="nv">rotation</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newRotation</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">childPos</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- 回転状態に応じた子ぷよの位置を計算</span>
<span class="nv">getChildPosition</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Position</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Position</span>
<span class="nv">getChildPosition</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nv">rotation</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">rotation</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="c1">-- 上</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="c1">-- 右</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="mi">2</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="c1">-- 下</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="c1">-- 左（3）</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span>


<span class="c1">-- 壁キック付き回転</span>
<span class="nv">rotateWithKick</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="p">,</span><span class="w"> </span><span class="kt">Bool</span><span class="w"> </span><span class="p">)</span>
<span class="nv">rotateWithKick</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">rotate</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">canMove</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="c1">-- 回転可能、壁キック不要</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="p">,</span><span class="w"> </span><span class="kt">False</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="c1">-- 壁キックを試みる</span>
<span class="w">        </span><span class="nv">tryWallKick</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="w"> </span><span class="nv">board</span>


<span class="c1">-- 壁キックを試みる</span>
<span class="nv">tryWallKick</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="p">,</span><span class="w"> </span><span class="kt">Bool</span><span class="w"> </span><span class="p">)</span>
<span class="nv">tryWallKick</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="c1">-- 左に1マス移動</span>
<span class="w">        </span><span class="nv">leftKick</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">getChildPosition</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">axis</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">rotation</span><span class="w"> </span><span class="p">})</span>

<span class="w">        </span><span class="c1">-- 右に1マス移動</span>
<span class="w">        </span><span class="nv">rightKick</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">getChildPosition</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">axis</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">rotation</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">canMove</span><span class="w"> </span><span class="nv">leftKick</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="nv">leftKick</span><span class="p">,</span><span class="w"> </span><span class="kt">True</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nv">canMove</span><span class="w"> </span><span class="nv">rightKick</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="nv">rightKick</span><span class="p">,</span><span class="w"> </span><span class="kt">True</span><span class="w"> </span><span class="p">)</span>

<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="c1">-- 壁キックも失敗、回転前の状態に戻す</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">rotation</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">modBy</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="nv">pair</span><span class="nf">.</span><span class="nv">rotation</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="nf">|&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">getChildPosition</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">axis</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">rotation</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="kt">False</span>
<span class="w">        </span><span class="p">)</span>


<span class="c1">-- 移動可能かチェックする</span>
<span class="nv">canMove</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Bool</span>
<span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">axisCell</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="nv">childCell</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">axisCell</span><span class="p">,</span><span class="w"> </span><span class="nv">childCell</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">True</span>

<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">False</span>
</code></pre></div>
<p>「不変性を保ちながら回転しているんですね！」そうです。<code>rotate</code> 関数では、回転状態を更新し、新しい子ぷよの位置を計算して、新しいぷよペアを返します。</p>
<p>「<code>rotateWithKick</code> 関数は何をしているんですか？」この関数は、まず通常の回転を試み、失敗した場合は壁キック（左または右に1マス移動）を試みます。それでも失敗した場合は、回転を中止して元の状態を返します。戻り値はタプルで、<code>(新しいぷよペア, 壁キックが発生したか)</code> という情報を返します。</p>
<h3 id="_39">テストの実行<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm-test
</code></pre></div>
<p>すべてのテストが通れば成功です！</p>
<h3 id="the-elm-architecture_3">The Elm Architecture への統合<a class="headerlink" href="#the-elm-architecture_3" title="Permanent link">&para;</a></h3>
<p>次に、回転機能を Main.elm に統合します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（更新部分のみ）</span>

<span class="kr">type</span><span class="w"> </span><span class="kt">Msg</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">StartGame</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="kt">String</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Tick</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">NoOp</span>


<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">StartGame</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">,</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="p">(</span><span class="w"> </span><span class="kt">Playing</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">newPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kr">case</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                                </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveLeft</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                        </span><span class="nv">movedPair</span>

<span class="w">                                    </span><span class="kr">else</span>
<span class="w">                                        </span><span class="nv">pair</span>

<span class="w">                                </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveRight</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                        </span><span class="nv">movedPair</span>

<span class="w">                                    </span><span class="kr">else</span>
<span class="w">                                        </span><span class="nv">pair</span>

<span class="w">                                </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="c1">-- 回転（壁キック付き）</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="p">(</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotateWithKick</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="nv">rotatedPair</span>

<span class="w">                                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="nv">pair</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="c1">-- 後で実装</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="kt">NoOp</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>「上矢印キーで回転するんですね！」そうです。<code>ArrowUp</code> が押されると、<code>rotateWithKick</code> 関数を呼び出して回転します。壁キックが必要な場合は自動的に処理されます。</p>
<h3 id="_40">アプリケーションの実行<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>では、アプリケーションを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm<span class="w"> </span>reactor
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開き、<code>src/Main.elm</code> をクリックします。「ゲーム開始」ボタンをクリックし、上矢印キーを押すと、ぷよが回転します！</p>
<p>「本当だ！ぷよが回転しました！」おめでとうございます！キーボード入力でぷよを回転できるようになりましたね。</p>
<h3 id="3_2">イテレーション3のまとめ<a class="headerlink" href="#3_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容:</p>
<ol>
<li><strong>回転状態の管理</strong></li>
<li><code>rotation</code> フィールド: 0（上）、1（右）、2（下）、3（左）の4状態</li>
<li>
<p><code>getChildPosition</code>: 回転状態に応じた子ぷよの位置計算</p>
</li>
<li>
<p><strong>回転機能</strong></p>
</li>
<li><code>rotate</code>: 時計回りに90度回転</li>
<li>パターンマッチングで回転状態に応じた位置を計算</li>
<li>
<p>不変性を保ちながら新しいぷよペアを返す</p>
</li>
<li>
<p><strong>壁キック処理</strong></p>
</li>
<li><code>rotateWithKick</code>: 回転と壁キックを統合</li>
<li><code>tryWallKick</code>: 左右への移動を試みる</li>
<li>
<p>タプル型で回転結果と壁キック発生フラグを返す</p>
</li>
<li>
<p><strong>The Elm Architecture の拡張</strong></p>
</li>
<li><code>KeyPressed "ArrowUp"</code>: 上矢印キーで回転</li>
<li>
<p><code>update</code> 関数での回転処理の統合</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>回転機能のテスト（2テスト）</li>
<li>壁キック処理のテスト（2テスト）</li>
</ol>
<h3 id="_41">学んだこと<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>回転状態の管理</strong>: カスタム型とパターンマッチングで安全に管理</li>
<li><strong>タプル型</strong>: 複数の値を返す場合に便利（回転結果と壁キックフラグ）</li>
<li><strong>パイプライン演算子</strong>: 複数の回転を連鎖させてテスト</li>
<li><strong>不変性</strong>: 回転前の状態を保ちながら新しい状態を作成</li>
<li><strong>型安全性</strong>: コンパイラが回転状態のすべてのケースをチェック</li>
</ul>
<p>次のイテレーションでは、ぷよの自由落下機能を実装します！</p>
<h2 id="4_1">イテレーション4: ぷよの自由落下の実装<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h2>
<p>「回転ができるようになったけど、ぷよぷよって自動で落ちていくよね？」そうですね！ぷよぷよでは、ぷよが一定間隔で自動的に下に落ちていきます。今回は、その「自由落下」機能を実装していきましょう！</p>
<h3 id="_42">ユーザーストーリー<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>システムとしてぷよを自由落下させることができる</p>
</blockquote>
<p>「ぷよが自動的に落ちていく」という機能は、ぷよぷよの基本中の基本ですね。プレイヤーが何も操作しなくても、時間とともにぷよが下に落ちていく仕組みを作りましょう。</p>
<h3 id="todo_3">TODOリスト<a class="headerlink" href="#todo_3" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを自由落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>時間の経過を管理する（Time サブスクリプションの追加）</li>
<li>自動落下処理の実装（一定時間ごとにぷよを1マス下に移動）</li>
<li>落下可能判定の実装（下に移動できるかチェック）</li>
<li>着地処理の実装（ぷよが着地したときにボードに固定）</li>
<li>The Elm Architecture への統合（Tick メッセージの処理）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_43">テスト: ぷよペアの落下<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h3>
<p>まずは、ぷよペアが下に移動する機能をテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/PuyoPairTests.elm（続き）</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;PuyoPair&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="c1">-- 既存のテスト...</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;moveDown&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;下に移動できる&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveDown</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">all</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">p</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">p</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="nv">movedPair</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;canMoveDown&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;下にスペースがあれば移動可能&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">True</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;軸ぷよが下端なら移動不可&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;子ぷよが下端なら移動不可&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="c1">-- rotation = 2（子ぷよが下）の状態</span>
<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="p">{</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">axisColor</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Red</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">childColor</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">rotation</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;下にぷよがあれば移動不可&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「このテストは何を確認しているんですか？」このテストでは、以下のケースを確認しています：</p>
<ol>
<li>ぷよペアが下に移動できるか</li>
<li>下にスペースがあれば移動可能</li>
<li>軸ぷよが下端なら移動不可</li>
<li>子ぷよが下端なら移動不可</li>
<li>下にぷよがあれば移動不可</li>
</ol>
<h3 id="_44">実装: ぷよペアの落下<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>では、テストが通るように PuyoPair モジュールを拡張しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/PuyoPair.elm（拡張版）</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">PuyoPair</span><span class="w"> </span><span class="nv">exposing</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="kt">Position</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">canMove</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">canMoveDown</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">create</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">getPositions</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">moveDown</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">moveLeft</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">moveRight</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rotate</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">rotateWithKick</span>
<span class="w">    </span><span class="p">)</span>

<span class="c1">-- 省略...</span>


<span class="c1">-- 下に移動する</span>
<span class="nv">moveDown</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="nv">moveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">        </span><span class="nf">|</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- 下に移動可能かチェックする</span>
<span class="nv">canMoveDown</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Bool</span>
<span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">nextAxisY</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="nv">nextChildY</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="c1">-- ボードの高さ</span>
<span class="w">        </span><span class="nv">boardRows</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">board</span><span class="nf">.</span><span class="nv">rows</span>

<span class="w">        </span><span class="c1">-- 下端チェック</span>
<span class="w">        </span><span class="nv">isAxisOutOfBounds</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">nextAxisY</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="nv">boardRows</span>

<span class="w">        </span><span class="nv">isChildOutOfBounds</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">nextChildY</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="nv">boardRows</span>

<span class="w">        </span><span class="c1">-- 移動先のセルチェック</span>
<span class="w">        </span><span class="nv">axisCell</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">isAxisOutOfBounds</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="kt">Nothing</span>

<span class="w">            </span><span class="kr">else</span>
<span class="w">                </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">nextAxisY</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="nv">childCell</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">isChildOutOfBounds</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="kt">Nothing</span>

<span class="w">            </span><span class="kr">else</span>
<span class="w">                </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">nextChildY</span><span class="w"> </span><span class="nv">board</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">axisCell</span><span class="p">,</span><span class="w"> </span><span class="nv">childCell</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">True</span>

<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">False</span>
</code></pre></div>
<p>「不変性を保ちながら下に移動しているんですね！」そうです。<code>moveDown</code> 関数では、軸ぷよと子ぷよの両方の Y 座標を 1 増やした新しいぷよペアを返します。</p>
<p>「<code>canMoveDown</code> 関数は <code>canMove</code> と似ていますね」そうですね。主な違いは、下方向への移動可能性を専用にチェックしている点です。下端チェックを先に行うことで、範囲外アクセスを防いでいます。</p>
<h3 id="time">Time サブスクリプションの追加<a class="headerlink" href="#time" title="Permanent link">&para;</a></h3>
<p>次に、一定時間ごとに Tick メッセージを発行するサブスクリプションを追加します。Elm では、<code>Browser.Events.onAnimationFrame</code> を使って、ブラウザの描画タイミングに合わせた更新を行えます。</p>
<p>まず、必要な型を定義します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（更新部分）</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Browser.Events</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Time</span>


<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="p">}</span>


<span class="nv">init</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">init</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">    </span><span class="p">)</span>


<span class="kr">type</span><span class="w"> </span><span class="kt">Msg</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">StartGame</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="kt">String</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Tick</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">NoOp</span>


<span class="nv">subscriptions</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Sub</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">subscriptions</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Playing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Sub</span><span class="nf">.</span><span class="nv">batch</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="kt">Browser</span><span class="nf">.</span><span class="kt">Events</span><span class="nf">.</span><span class="nv">onKeyDown</span><span class="w"> </span><span class="p">(</span><span class="kt">Decode</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="nv">keyDecoder</span><span class="p">)</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="kt">Browser</span><span class="nf">.</span><span class="kt">Events</span><span class="nf">.</span><span class="nv">onAnimationFrame</span><span class="w"> </span><span class="kt">Tick</span>
<span class="w">                </span><span class="p">]</span>

<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Sub</span><span class="nf">.</span><span class="nv">none</span>
</code></pre></div>
<p>「<code>onAnimationFrame</code> は何ですか？」良い質問です！<code>onAnimationFrame</code> は、ブラウザの描画タイミング（通常は60FPSで約16.67ms）ごとに呼ばれるサブスクリプションです。引数として現在のタイムスタンプ（ミリ秒）を受け取ります。</p>
<h3 id="update">update 関数の拡張<a class="headerlink" href="#update" title="Permanent link">&para;</a></h3>
<p>次に、Tick メッセージを処理して、一定時間ごとにぷよを落下させます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">StartGame</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">,</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="p">(</span><span class="w"> </span><span class="kt">Playing</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">newPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kr">case</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                                </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveLeft</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                        </span><span class="nv">movedPair</span>

<span class="w">                                    </span><span class="kr">else</span>
<span class="w">                                        </span><span class="nv">pair</span>

<span class="w">                                </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveRight</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                        </span><span class="nv">movedPair</span>

<span class="w">                                    </span><span class="kr">else</span>
<span class="w">                                        </span><span class="nv">pair</span>

<span class="w">                                </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="p">(</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotateWithKick</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="nv">rotatedPair</span>

<span class="w">                                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                    </span><span class="nv">pair</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nv">deltaTime</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">,</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="p">(</span><span class="w"> </span><span class="kt">Playing</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">newTimer</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">deltaTime</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropInterval</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="c1">-- 落下タイマーが間隔を超えたら落下処理</span>
<span class="w">                        </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                            </span><span class="c1">-- 下に移動可能</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveDown</span><span class="w"> </span><span class="nv">pair</span><span class="p">)</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                            </span><span class="p">)</span>

<span class="w">                        </span><span class="kr">else</span>
<span class="w">                            </span><span class="c1">-- 着地した：ボードに固定して新しいぷよを生成</span>
<span class="w">                            </span><span class="kr">let</span>
<span class="w">                                </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                    </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axisColor</span><span class="p">)</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">childColor</span><span class="p">)</span>
<span class="w">                            </span><span class="kr">in</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                            </span><span class="p">)</span>

<span class="w">                    </span><span class="kr">else</span>
<span class="w">                        </span><span class="c1">-- まだ落下タイマーが間隔に達していない</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="kt">NoOp</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>「落下タイマーで一定時間ごとに落下処理を実行しているんですね！」そうです。<code>Tick</code> メッセージが来るたびにタイマーを更新し、<code>dropInterval</code>（1000ms = 1秒）を超えたら、ぷよを1マス下に移動させます。</p>
<p>「着地したらボードに固定して新しいぷよを生成するんですね」その通りです！<code>canMoveDown</code> が <code>False</code> を返した場合、現在のぷよペアをボードに固定（<code>setCell</code>）し、新しいぷよペアを生成します。</p>
<h3 id="_45">テストの実行<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm-test
</code></pre></div>
<p>すべてのテストが通れば成功です！</p>
<h3 id="_46">アプリケーションの実行<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<p>では、アプリケーションを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm<span class="w"> </span>reactor
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開き、<code>src/Main.elm</code> をクリックします。「ゲーム開始」ボタンをクリックすると、ぷよが1秒ごとに自動的に下に落ちていきます！</p>
<p>「本当だ！ぷよが自動で落ちて、着地したら新しいぷよが出てきました！」おめでとうございます！自由落下機能が実装できましたね。</p>
<h3 id="4_2">イテレーション4のまとめ<a class="headerlink" href="#4_2" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ぷよペアの落下機能</strong></li>
<li><code>moveDown</code>: 下に移動</li>
<li>
<p><code>canMoveDown</code>: 下に移動可能かチェック（下端と衝突判定）</p>
</li>
<li>
<p><strong>時間管理</strong></p>
</li>
<li><code>dropTimer</code>: 落下タイマー</li>
<li><code>dropInterval</code>: 落下間隔（1000ms）</li>
<li>
<p><code>Browser.Events.onAnimationFrame</code>: フレームごとの時間更新</p>
</li>
<li>
<p><strong>自動落下処理</strong></p>
</li>
<li><code>Tick</code> メッセージでタイマーを更新</li>
<li>タイマーが間隔を超えたらぷよを1マス下に移動</li>
<li>
<p>着地したらボードに固定して新しいぷよを生成</p>
</li>
<li>
<p><strong>着地処理</strong></p>
</li>
<li><code>canMoveDown</code> が <code>False</code> の場合に着地と判定</li>
<li>軸ぷよと子ぷよをボードに <code>setCell</code> で固定</li>
<li>
<p>新しいぷよペアを生成</p>
</li>
<li>
<p><strong>サブスクリプションの拡張</strong></p>
</li>
<li><code>Sub.batch</code>: 複数のサブスクリプションを組み合わせ</li>
<li>
<p>キーボード入力とアニメーションフレームの両方を購読</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>落下機能のテスト（1テスト）</li>
<li>落下可能判定のテスト（4テスト）</li>
</ol>
<h3 id="_47">学んだこと<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Browser.Events.onAnimationFrame</strong>: ブラウザの描画タイミングに合わせた更新</li>
<li><strong>Sub.batch</strong>: 複数のサブスクリプションを組み合わせる</li>
<li><strong>タイマー管理</strong>: 経過時間を積算して一定間隔で処理を実行</li>
<li><strong>着地判定</strong>: <code>canMoveDown</code> で下方向の移動可能性をチェック</li>
<li><strong>パイプライン演算子</strong>: 複数の <code>setCell</code> を連鎖させてボードを更新</li>
</ul>
<p>次のイテレーションでは、ぷよの高速落下機能（下矢印キーで素早く落とす）を実装します！</p>
<h2 id="5">イテレーション5: ぷよの高速落下の実装<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>「ぷよが自動で落ちるようになったけど、もっと早く落としたいときはどうするんですか？」良い質問ですね！ぷよぷよでは、下矢印キーを押すことでぷよを素早く落とすことができます。今回は、その「高速落下」機能を実装していきましょう！</p>
<h3 id="_48">ユーザーストーリー<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、下矢印キーを押してぷよを素早く落とせる</p>
</blockquote>
<p>「早く次のぷよを出したい！」というときに、下キーを押して素早く落下させる機能は、ゲームのテンポを良くするために重要ですね。</p>
<h3 id="todo_4">TODOリスト<a class="headerlink" href="#todo_4" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを素早く落下させる」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>高速落下フラグを Model に追加する</li>
<li>下キー入力の検出を実装する（下矢印キーが押されたことを検知する）</li>
<li>高速落下処理を実装する（下キーが押されている間は落下速度を上げる）</li>
<li>キーが離されたときの処理を実装する（元の速度に戻す）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_49">テスト: 高速落下フラグ<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、高速落下のフラグを管理できることをテストしましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/MainTests.elm（新規作成）</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">MainTests</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">suite</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Expect</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Main</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="nf">(..)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoPair</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Test</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="nf">(..)</span>


<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;Main&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;高速落下&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;下矢印キーで高速落下フラグが立つ&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">initialModel</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">False</span>
<span class="w">                            </span><span class="p">}</span>

<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="nv">newModel</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">update</span><span class="w"> </span><span class="p">(</span><span class="kt">KeyPressed</span><span class="w"> </span><span class="s">&quot;ArrowDown&quot;</span><span class="p">)</span><span class="w"> </span><span class="nv">initialModel</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="nv">newModel</span><span class="nf">.</span><span class="nv">fastDropActive</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">True</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;下矢印キー以外では高速落下フラグが立たない&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">initialModel</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">False</span>
<span class="w">                            </span><span class="p">}</span>

<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="nv">newModel</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">update</span><span class="w"> </span><span class="p">(</span><span class="kt">KeyPressed</span><span class="w"> </span><span class="s">&quot;ArrowLeft&quot;</span><span class="p">)</span><span class="w"> </span><span class="nv">initialModel</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="nv">newModel</span><span class="nf">.</span><span class="nv">fastDropActive</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>下矢印キーが押されたときに <code>fastDropActive</code> フラグが <code>True</code> になるか</li>
<li>他のキーが押されたときには <code>fastDropActive</code> フラグが変わらないか</li>
</ol>
<p>「なるほど、高速落下の状態を管理できることを確認するんですね！」そうです！では、このテストが失敗することを確認してから、実装に進みましょう。</p>
<h3 id="model-fastdropactive">実装: Model への fastDropActive フィールド追加<a class="headerlink" href="#model-fastdropactive" title="Permanent link">&para;</a></h3>
<p>まず、Model に <code>fastDropActive</code> フィールドを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm</span>
<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Bool</span><span class="w">  </span><span class="c1">-- 追加</span>
<span class="w">    </span><span class="p">}</span>


<span class="nv">init</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">init</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">False</span><span class="w">  </span><span class="c1">-- 追加</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h3 id="_50">実装: 下矢印キーの処理<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>次に、下矢印キーが押されたときに <code>fastDropActive</code> フラグを立てる処理を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（update 関数の修正）</span>
<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">StartGame</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="s">&quot;ArrowDown&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="c1">-- 高速落下フラグを立てる</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">True</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="c1">-- その他のキー処理</span>
<span class="w">                    </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">,</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="kt">Playing</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                            </span><span class="kr">let</span>
<span class="w">                                </span><span class="nv">newPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                    </span><span class="kr">case</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                                        </span><span class="s">&quot;ArrowLeft&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                            </span><span class="kr">let</span>
<span class="w">                                                </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveLeft</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                                            </span><span class="kr">in</span>
<span class="w">                                            </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                                </span><span class="nv">movedPair</span>

<span class="w">                                            </span><span class="kr">else</span>
<span class="w">                                                </span><span class="nv">pair</span>

<span class="w">                                        </span><span class="s">&quot;ArrowRight&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                            </span><span class="kr">let</span>
<span class="w">                                                </span><span class="nv">movedPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveRight</span><span class="w"> </span><span class="nv">pair</span>
<span class="w">                                            </span><span class="kr">in</span>
<span class="w">                                            </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">movedPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                                </span><span class="nv">movedPair</span>

<span class="w">                                            </span><span class="kr">else</span>
<span class="w">                                                </span><span class="nv">pair</span>

<span class="w">                                        </span><span class="s">&quot;ArrowUp&quot;</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                            </span><span class="kr">let</span>
<span class="w">                                                </span><span class="p">(</span><span class="w"> </span><span class="nv">rotatedPair</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">rotateWithKick</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                                            </span><span class="kr">in</span>
<span class="w">                                            </span><span class="nv">rotatedPair</span>

<span class="w">                                        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                            </span><span class="nv">pair</span>
<span class="w">                            </span><span class="kr">in</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="c1">-- 既存の Tick 処理...</span>
<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nv">deltaTime</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">,</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="p">(</span><span class="w"> </span><span class="kt">Playing</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">newTimer</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">deltaTime</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropInterval</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveDown</span><span class="w"> </span><span class="nv">pair</span><span class="p">)</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                            </span><span class="p">)</span>

<span class="w">                        </span><span class="kr">else</span>
<span class="w">                            </span><span class="kr">let</span>
<span class="w">                                </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                    </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axisColor</span><span class="p">)</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">childColor</span><span class="p">)</span>
<span class="w">                            </span><span class="kr">in</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                            </span><span class="p">)</span>

<span class="w">                    </span><span class="kr">else</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="kt">NoOp</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>「テストを実行してみましょう！」そうですね。テストを実行します：</p>
<div class="highlight"><pre><span></span><code>elm-test
</code></pre></div>
<p>「やった！テストが通りました！」おめでとうございます！下矢印キーで高速落下フラグが立つようになりました。</p>
<h3 id="_51">テスト: 高速落下時の落下速度<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h3>
<p>次に、高速落下フラグが立っているときに実際に落下速度が上がることをテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/MainTests.elm（続き）</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;Main&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;高速落下&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="c1">-- 既存のテスト...</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;高速落下時は落下間隔が短くなる&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">True</span>
<span class="w">                            </span><span class="p">}</span>

<span class="w">                        </span><span class="nv">effectiveInterval</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kr">if</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">fastDropActive</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                </span><span class="mi">50</span>

<span class="w">                            </span><span class="kr">else</span>
<span class="w">                                </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropInterval</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="nv">effectiveInterval</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">50</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、<code>fastDropActive</code> が <code>True</code> のときに、実効的な落下間隔が短く（50ms）なることを確認しています。</p>
<h3 id="_52">実装: 高速落下時の落下速度変更<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>では、Tick メッセージの処理で、高速落下フラグに応じて落下速度を変更しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（update 関数の Tick 処理を修正）</span>
<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="c1">-- 既存の処理...</span>

<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nv">deltaTime</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="p">,</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="p">(</span><span class="w"> </span><span class="kt">Playing</span><span class="p">,</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="c1">-- 高速落下時は落下間隔を短くする</span>
<span class="w">                        </span><span class="nv">effectiveInterval</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kr">if</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">fastDropActive</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                </span><span class="mi">50</span>

<span class="w">                            </span><span class="kr">else</span>
<span class="w">                                </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropInterval</span>

<span class="w">                        </span><span class="nv">newTimer</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">deltaTime</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="nv">effectiveInterval</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveDown</span><span class="w"> </span><span class="nv">pair</span><span class="p">)</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                            </span><span class="p">)</span>

<span class="w">                        </span><span class="kr">else</span>
<span class="w">                            </span><span class="kr">let</span>
<span class="w">                                </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                    </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axisColor</span><span class="p">)</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">childColor</span><span class="p">)</span>
<span class="w">                            </span><span class="kr">in</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                                </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">False</span><span class="w">  </span><span class="c1">-- 着地時に高速落下をリセット</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                            </span><span class="p">)</span>

<span class="w">                    </span><span class="kr">else</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="kt">NoOp</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>「effectiveInterval を使って落下速度を変えているんですね！」そうです！<code>fastDropActive</code> が <code>True</code> の場合は 50ms、そうでない場合は通常の 1000ms を使います。また、ぷよが着地したときに <code>fastDropActive</code> を <code>False</code> にリセットすることで、次のぷよは通常速度で落下します。</p>
<h3 id="_53">アプリケーションの実行<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>では、アプリケーションを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm<span class="w"> </span>reactor
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開き、<code>src/Main.elm</code> をクリックします。「ゲーム開始」ボタンをクリックし、下矢印キーを押してみましょう！</p>
<p>「本当だ！下矢印キーを押すとぷよがすごく速く落ちます！」おめでとうございます！高速落下機能が実装できましたね。</p>
<h3 id="5_1">イテレーション5のまとめ<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>高速落下フラグの追加</strong></li>
<li><code>fastDropActive : Bool</code> フィールドを Model に追加</li>
<li>
<p>下矢印キーで <code>True</code> に設定</p>
</li>
<li>
<p><strong>高速落下の実装</strong></p>
</li>
<li><code>effectiveInterval</code>: 高速落下時は 50ms、通常時は 1000ms</li>
<li>Tick メッセージで <code>effectiveInterval</code> を使って落下判定</li>
<li>
<p>着地時に <code>fastDropActive</code> をリセット</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>高速落下フラグのテスト（2テスト）</li>
<li>高速落下時の落下間隔のテスト（1テスト）</li>
</ol>
<h3 id="_54">学んだこと<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>条件分岐による速度変更</strong>: <code>if</code> 式で状態に応じた値を選択</li>
<li><strong>フラグのリセット</strong>: 着地時に高速落下フラグをリセットして次のぷよに影響しないようにする</li>
<li><strong>let 式での局所変数</strong>: <code>effectiveInterval</code> のような計算結果を一時的に保持</li>
</ul>
<p>次のイテレーションでは、ぷよの消去機能（同じ色のぷよが4つ以上つながったら消える）を実装します！</p>
<h2 id="6">イテレーション6: ぷよの消去の実装<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>「ぷよが落ちてくるようになったけど、ぷよぷよの醍醐味はぷよを消すことですよね？」そうですね！ぷよぷよの最も重要な要素の一つは、同じ色のぷよを4つ以上つなげると消去できる機能です。今回は、その「ぷよの消去」機能を実装していきましょう！</p>
<h3 id="_55">ユーザーストーリー<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、同じ色のぷよを4つ以上つなげると消去できる</p>
</blockquote>
<p>「これがぷよぷよの基本ルールですね！」そうです！同じ色のぷよを4つ以上つなげると消去できるというのが、ぷよぷよの基本的なルールです。これを実装することで、ゲームとしての面白さが大きく向上しますね。</p>
<h3 id="todo_5">TODOリスト<a class="headerlink" href="#todo_5" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ぷよを消去する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>連結したぷよを探索する機能を実装する（深さ優先探索）</li>
<li>4つ以上つながったぷよを検出する機能を実装する</li>
<li>ぷよを消去する機能を実装する</li>
<li>消去後に上のぷよを落下させる機能を実装する</li>
<li>着地後に消去判定を行う</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_56">テスト: 連結したぷよの探索<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>「最初に何をテストすればいいんでしょうか？」まずは、連結したぷよを探索する機能をテストしましょう。</p>
<p>新しいモジュール <code>GameLogic</code> を作成して、そこに連結判定のロジックを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/GameLogicTests.elm（新規作成）</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">GameLogicTests</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">suite</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Expect</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">GameLogic</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Set</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Test</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="nf">(..)</span>


<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;GameLogic&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;findConnectedPuyos&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;同じ色のぷよが4つつながっている場合、4つすべてを検出する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">connected</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">findConnectedPuyos</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">size</span><span class="w"> </span><span class="nv">connected</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">4</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;異なる色のぷよは接続されない&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">connected</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">findConnectedPuyos</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">size</span><span class="w"> </span><span class="nv">connected</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">3</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;3つ以下のつながりも正しく検出する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">connected</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">findConnectedPuyos</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">size</span><span class="w"> </span><span class="nv">connected</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">3</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の3つのケースを確認しています：</p>
<ol>
<li>同じ色のぷよが4つつながっている場合、すべて検出できるか</li>
<li>異なる色のぷよは接続されないか</li>
<li>3つ以下のつながりも正しく検出できるか</li>
</ol>
<p>「テストを実行すると失敗しますよね？」そうです！まだ <code>GameLogic</code> モジュールを作っていないので、テストは失敗します。これから実装していきましょう。</p>
<h3 id="_57">実装: 深さ優先探索<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>では、連結したぷよを探索する機能を実装しましょう。深さ優先探索（DFS: Depth-First Search）というアルゴリズムを使います：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/GameLogic.elm（新規作成）</span>
<span class="kn">module</span><span class="w"> </span><span class="nc">GameLogic</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="nv">findConnectedPuyos</span><span class="p">,</span><span class="w"> </span><span class="nv">erasePuyos</span><span class="p">,</span><span class="w"> </span><span class="nv">applyGravity</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">Board</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Cell</span><span class="nf">(..)</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">PuyoColor</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoColor</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">Set</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">(</span><span class="kt">Set</span><span class="p">)</span>


<span class="cm">{-| 指定位置から連結している同色のぷよを探索する</span>
<span class="cm">-}</span>
<span class="nv">findConnectedPuyos</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Set</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">)</span>
<span class="nv">findConnectedPuyos</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">findConnectedHelper</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">empty</span>


<span class="cm">{-| 再帰的に連結ぷよを探索するヘルパー関数</span>
<span class="cm">-}</span>
<span class="nv">findConnectedHelper</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">PuyoColor</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Set</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Set</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">)</span>
<span class="nv">findConnectedHelper</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="c1">-- すでに訪問済みの場合は何もしない</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">member</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">visited</span>

<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="kr">case</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kr">of</span>
<span class="w">            </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">cellColor</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">cellColor</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="c1">-- 現在位置を訪問済みに追加</span>
<span class="w">                        </span><span class="nv">newVisited</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">insert</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nv">visited</span>

<span class="w">                        </span><span class="c1">-- 4方向（上下左右）を探索</span>
<span class="w">                        </span><span class="nv">directions</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="p">[</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">-</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c1">-- 上</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c1">-- 下</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nf">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c1">-- 左</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c1">-- 右</span>
<span class="w">                            </span><span class="p">]</span>

<span class="w">                        </span><span class="c1">-- 各方向を再帰的に探索</span>
<span class="w">                        </span><span class="nv">searchNeighbor</span><span class="w"> </span><span class="nv">visited2</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">dx</span><span class="p">,</span><span class="w"> </span><span class="nv">dy</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">findConnectedHelper</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">dx</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">y</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">dy</span><span class="p">)</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">visited2</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">foldl</span><span class="w"> </span><span class="nv">searchNeighbor</span><span class="w"> </span><span class="nv">newVisited</span><span class="w"> </span><span class="nv">directions</span>

<span class="w">                </span><span class="kr">else</span>
<span class="w">                    </span><span class="c1">-- 色が違う場合は探索しない</span>
<span class="w">                    </span><span class="nv">visited</span>

<span class="w">            </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="c1">-- セルが空か範囲外の場合は探索しない</span>
<span class="w">                </span><span class="nv">visited</span>
</code></pre></div>
<p>「再帰的な関数ですね！」そうです。深さ優先探索は再帰を使って実装するのが自然です。このアルゴリズムの仕組みを見てみましょう：</p>
<ol>
<li><strong>訪問済みチェック</strong>: すでに訪問した位置は再度探索しない（無限ループ防止）</li>
<li><strong>色のチェック</strong>: 同じ色のぷよだけを探索対象にする</li>
<li><strong>4方向探索</strong>: 上下左右の4方向を再帰的に探索</li>
<li><strong>Set で管理</strong>: 訪問済み位置を Set で管理することで、重複を自動的に排除</li>
</ol>
<p>「<code>foldl</code> で4方向を順番に探索しているんですね！」そうです！<code>foldl</code> を使うことで、各方向の探索結果を累積していきます。</p>
<h3 id="_58">テストの実行<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>では、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm-test
</code></pre></div>
<p>「やった！テストが通りました！」おめでとうございます！連結したぷよを探索する機能が実装できましたね。</p>
<h3 id="_59">テスト: ぷよの消去<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p>次に、4つ以上つながったぷよを消去する機能をテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/GameLogicTests.elm（続き）</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;GameLogic&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="c1">-- 既存のテスト...</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;erasePuyos&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;指定した位置のぷよを消去する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">positions</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">fromList</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">]</span>

<span class="w">                        </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">erasePuyos</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">all</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="nv">newBoard</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「このテストでは、指定した位置のぷよが空になることを確認しているんですね！」そうです！<code>Expect.all</code> を使って、4つの位置すべてが <code>Empty</code> になることを確認しています。</p>
<h3 id="_60">実装: ぷよの消去<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>では、ぷよを消去する機能を実装しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/GameLogic.elm（続き）</span>
<span class="cm">{-| 指定した位置のぷよを消去する</span>
<span class="cm">-}</span>
<span class="nv">erasePuyos</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Set</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span>
<span class="nv">erasePuyos</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">foldl</span>
<span class="w">        </span><span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span>
<span class="w">        </span><span class="nv">board</span>
<span class="w">        </span><span class="nv">positions</span>
</code></pre></div>
<p>「シンプルですね！」そうです。<code>Set.foldl</code> を使って、各位置のセルを <code>Empty</code> に設定していきます。</p>
<h3 id="_61">テスト: 重力の適用<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>ぷよを消去した後、上にあるぷよが落下する必要があります。これを「重力の適用」と呼びます：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/GameLogicTests.elm（続き）</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;GameLogic&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="c1">-- 既存のテスト...</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;applyGravity&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;浮いているぷよが落下する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">applyGravity</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">all</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="p">)</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">))</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nf">\</span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">))</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="nv">newBoard</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;浮いていないぷよは動かない&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">applyGravity</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">))</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「これは、ぷよが下に落ちていくことを確認するテストですね！」そうです！ぷよ消去後に空いたスペースに、上のぷよが落ちてくる機能をテストしています。</p>
<h3 id="_62">実装: 重力の適用<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p>では、重力を適用する機能を実装しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/GameLogic.elm（続き）</span>
<span class="cm">{-| 重力を適用して浮いているぷよを落下させる</span>
<span class="cm">-}</span>
<span class="nv">applyGravity</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span>
<span class="nv">applyGravity</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">cols</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCols</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="nv">rows</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getRows</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="c1">-- 各列に対して重力を適用</span>
<span class="w">        </span><span class="nv">applyGravityToColumn</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">        </span><span class="nv">applyGravityToColumn</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="c1">-- 下から上に向かって処理</span>
<span class="w">            </span><span class="kr">let</span>
<span class="w">                </span><span class="nv">applyToRow</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">                </span><span class="nv">applyToRow</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">currentBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nf">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">currentBoard</span>

<span class="w">                    </span><span class="kr">else</span>
<span class="w">                        </span><span class="kr">case</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">currentBoard</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                            </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">color</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                </span><span class="c1">-- 下に落とせるだけ落とす</span>
<span class="w">                                </span><span class="kr">let</span>
<span class="w">                                    </span><span class="nv">finalRow</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                        </span><span class="nv">findBottomRow</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">currentBoard</span>
<span class="w">                                </span><span class="kr">in</span>
<span class="w">                                </span><span class="kr">if</span><span class="w"> </span><span class="nv">finalRow</span><span class="w"> </span><span class="nf">/=</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                    </span><span class="nv">currentBoard</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="kt">Empty</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="nv">finalRow</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">color</span><span class="p">)</span>
<span class="w">                                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="nv">applyToRow</span><span class="w"> </span><span class="p">(</span><span class="nv">row</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">                                </span><span class="kr">else</span>
<span class="w">                                    </span><span class="nv">applyToRow</span><span class="w"> </span><span class="p">(</span><span class="nv">row</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">currentBoard</span>

<span class="w">                            </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                </span><span class="nv">applyToRow</span><span class="w"> </span><span class="p">(</span><span class="nv">row</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">currentBoard</span>
<span class="w">            </span><span class="kr">in</span>
<span class="w">            </span><span class="nv">applyToRow</span><span class="w"> </span><span class="p">(</span><span class="nv">rows</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">b</span>

<span class="w">        </span><span class="c1">-- 下に落とせる最終行を見つける</span>
<span class="w">        </span><span class="nv">findBottomRow</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">        </span><span class="nv">findBottomRow</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">currentBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="nv">row</span>

<span class="w">            </span><span class="kr">else</span>
<span class="w">                </span><span class="kr">case</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="p">(</span><span class="nv">row</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">currentBoard</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                    </span><span class="kt">Just</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                        </span><span class="nv">findBottomRow</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="p">(</span><span class="nv">row</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">currentBoard</span>

<span class="w">                    </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                        </span><span class="nv">row</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">foldl</span><span class="w"> </span><span class="nv">applyGravityToColumn</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nv">cols</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<p>「少し複雑ですね...」そうですね。重力の適用は少し複雑です。処理の流れを見てみましょう：</p>
<ol>
<li><strong>列ごとに処理</strong>: 各列に対して独立に重力を適用</li>
<li><strong>下から上へ</strong>: 各列を下から上に向かって処理</li>
<li><strong>落下先を探索</strong>: 各ぷよについて、どこまで落とせるかを探す</li>
<li><strong>移動</strong>: 元の位置を <code>Empty</code> にして、落下先に ぷよを配置</li>
</ol>
<p>「Board モジュールに <code>getCols</code> と <code>getRows</code> 関数が必要ですね！」その通りです！Board モジュールに追加しましょう。</p>
<h3 id="board">Board モジュールの拡張<a class="headerlink" href="#board" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Board.elm（追加）</span>
<span class="nv">getCols</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span>
<span class="nv">getCols</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">board</span><span class="nf">.</span><span class="nv">cols</span>


<span class="nv">getRows</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span>
<span class="nv">getRows</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">board</span><span class="nf">.</span><span class="nv">rows</span>
</code></pre></div>
<p>これで、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm-test
</code></pre></div>
<p>「テストが通りました！」素晴らしい！重力の適用機能が実装できましたね。</p>
<h3 id="_63"><a class="headerlink" href="#_63" title="Permanent link">&para;</a></h3>
<p>イテレーション6のまとめ</p>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>連結ぷよの探索</strong></li>
<li><code>findConnectedPuyos</code>: 深さ優先探索（DFS）で連結ぷよを検出</li>
<li><code>Set</code> 型で訪問済み位置を管理</li>
<li>
<p>再帰的な探索で上下左右を走査</p>
</li>
<li>
<p><strong>ぷよの消去</strong></p>
</li>
<li><code>erasePuyos</code>: 指定位置のぷよを <code>Empty</code> に設定</li>
<li>
<p><code>Set.foldl</code> で複数位置を一括処理</p>
</li>
<li>
<p><strong>重力の適用</strong></p>
</li>
<li><code>applyGravity</code>: 浮いているぷよを落下させる</li>
<li>列ごとに独立して処理</li>
<li>
<p>下から上に向かってスキャン</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>連結判定のテスト（3テスト）</li>
<li>消去機能のテスト（1テスト）</li>
<li>重力適用のテスト（2テスト）</li>
</ol>
<h3 id="_64">学んだこと<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>深さ優先探索（DFS）</strong>: 再帰を使った探索アルゴリズム</li>
<li><strong>Set 型の活用</strong>: 重複のない位置管理に便利</li>
<li><strong>foldl による集約</strong>: 複数の操作を順次適用</li>
<li><strong>ヘルパー関数</strong>: 複雑なロジックを小さな関数に分割</li>
</ul>
<p>次のイテレーションでは、連鎖反応の実装に進みます！</p>
<h2 id="7">イテレーション7: 連鎖反応の実装<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>「ぷよを消せるようになったけど、ぷよぷよの醍醐味は連鎖じゃないですか？」そうですね！ぷよぷよの最も魅力的な要素の一つは、連鎖反応です。ぷよが消えて落下した結果、新たな消去パターンが生まれ、連続して消去が発生する「連鎖」を実装していきましょう！</p>
<h3 id="_65">ユーザーストーリー<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、連鎖反応を起こしてより高いスコアを獲得できる</p>
</blockquote>
<p>「れ〜んさ〜ん！」と叫びたくなるような連鎖反応を実装して、プレイヤーがより高いスコアを目指せるようにしましょう。</p>
<h3 id="todo_6">TODOリスト<a class="headerlink" href="#todo_6" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「連鎖反応を実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームモードに消去判定・消去中・落下中の状態を追加する</li>
<li>着地後に消去判定モードに遷移する</li>
<li>消去後に重力を適用して再度消去判定を行う</li>
<li>連鎖数をカウントする</li>
<li>連鎖が終了したら次のぷよを出す</li>
</ul>
<p>「なるほど、ゲームモードで状態を管理するんですね！」そうです！Elmのカスタム型を使って、ゲームの状態遷移を明確に表現します。</p>
<h3 id="_66">テスト: ゲームモードの追加<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>まず、新しいゲームモードを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（GameMode の拡張）</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Checking</span><span class="w">      </span><span class="c1">-- 消去判定中</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Erasing</span><span class="w">       </span><span class="c1">-- 消去中</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Falling</span><span class="w">       </span><span class="c1">-- 落下中</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">GameOver</span>
</code></pre></div>
<p>「Playing だけじゃなくて、細かくモードを分けるんですね！」そうです。各モードで異なる処理を行うことで、ゲームの流れを明確に制御できます。</p>
<h3 id="_67">テスト: 連鎖判定<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>連鎖が発生するケースをテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/MainTests.elm（続き）</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;Main&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="c1">-- 既存のテスト...</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;連鎖反応&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;ぷよ消去後、上のぷよが落ちて再び4つつながれば連鎖する&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="c1">-- 初期配置:</span>
<span class="w">                        </span><span class="c1">-- 赤ぷよ4つ（2×2）の上に青ぷよが縦に3つ、横に1つ</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>

<span class="w">                        </span><span class="c1">-- 1. 赤ぷよを探索</span>
<span class="w">                        </span><span class="nv">redConnected</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">findConnectedPuyos</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="nv">board</span>

<span class="w">                        </span><span class="c1">-- 2. 赤ぷよを消去</span>
<span class="w">                        </span><span class="nv">boardAfterErase</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">erasePuyos</span><span class="w"> </span><span class="nv">redConnected</span><span class="w"> </span><span class="nv">board</span>

<span class="w">                        </span><span class="c1">-- 3. 重力を適用</span>
<span class="w">                        </span><span class="nv">boardAfterGravity</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">applyGravity</span><span class="w"> </span><span class="nv">boardAfterErase</span>

<span class="w">                        </span><span class="c1">-- 4. 青ぷよの連鎖判定</span>
<span class="w">                        </span><span class="nv">blueConnected</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">findConnectedPuyos</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="kt">Blue</span><span class="w"> </span><span class="nv">boardAfterGravity</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">size</span><span class="w"> </span><span class="nv">blueConnected</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="mi">4</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「このテストでは、赤ぷよが消えた後に青ぷよが落ちて4つつながることを確認しているんですね！」そうです！これが連鎖の基本パターンです。</p>
<h3 id="model_1">実装: Model の拡張<a class="headerlink" href="#model_1" title="Permanent link">&para;</a></h3>
<p>連鎖数とスコアを管理するために Model を拡張します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（Model の拡張）</span>
<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Bool</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w">      </span><span class="c1">-- 追加</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span><span class="w">           </span><span class="c1">-- 追加</span>
<span class="w">    </span><span class="p">}</span>


<span class="nv">init</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">init</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">False</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span><span class="w">        </span><span class="c1">-- 追加</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span><span class="w">             </span><span class="c1">-- 追加</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h3 id="_68">実装: 消去判定と連鎖のフロー<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>次に、着地後の処理を変更して、消去判定→消去→重力→消去判定のサイクルを実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（update 関数の Tick 処理を大幅に変更）</span>
<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="c1">-- 既存の処理...</span>

<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nv">deltaTime</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="kt">Playing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="c1">-- プレイ中の自動落下処理</span>
<span class="w">                    </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                        </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                            </span><span class="kr">let</span>
<span class="w">                                </span><span class="nv">effectiveInterval</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">fastDropActive</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                        </span><span class="mi">50</span>

<span class="w">                                    </span><span class="kr">else</span>
<span class="w">                                        </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropInterval</span>

<span class="w">                                </span><span class="nv">newTimer</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                    </span><span class="nv">model</span><span class="nf">.</span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">deltaTime</span>
<span class="w">                            </span><span class="kr">in</span>
<span class="w">                            </span><span class="kr">if</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="nv">effectiveInterval</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                </span><span class="kr">if</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMoveDown</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                        </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">moveDown</span><span class="w"> </span><span class="nv">pair</span><span class="p">)</span>
<span class="w">                                        </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                                      </span><span class="p">}</span>
<span class="w">                                    </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                                    </span><span class="p">)</span>

<span class="w">                                </span><span class="kr">else</span>
<span class="w">                                    </span><span class="c1">-- 着地！ボードに固定して消去判定モードへ</span>
<span class="w">                                    </span><span class="kr">let</span>
<span class="w">                                        </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                            </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axis</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">axisColor</span><span class="p">)</span>
<span class="w">                                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">x</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">child</span><span class="nf">.</span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">pair</span><span class="nf">.</span><span class="nv">childColor</span><span class="p">)</span>
<span class="w">                                    </span><span class="kr">in</span>
<span class="w">                                    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                        </span><span class="nf">|</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                                        </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">                                        </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Checking</span>
<span class="w">                                        </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                                        </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">False</span>
<span class="w">                                        </span><span class="p">,</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">-- 連鎖カウントをリセット</span>
<span class="w">                                      </span><span class="p">}</span>
<span class="w">                                    </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                                    </span><span class="p">)</span>

<span class="w">                            </span><span class="kr">else</span>
<span class="w">                                </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newTimer</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                        </span><span class="kt">Nothing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="kt">Checking</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="c1">-- 消去判定モード</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">erasableGroups</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">findAllErasableGroups</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">erasableGroups</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="c1">-- 消去なし → 次のぷよを出す</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                          </span><span class="p">}</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                        </span><span class="p">)</span>

<span class="w">                    </span><span class="kr">else</span>
<span class="w">                        </span><span class="c1">-- 消去あり → 消去モードへ</span>
<span class="w">                        </span><span class="kr">let</span>
<span class="w">                            </span><span class="nv">newChainCount</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="nv">model</span><span class="nf">.</span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">                            </span><span class="c1">-- 消去するぷよの数</span>
<span class="w">                            </span><span class="nv">erasedCount</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">List</span><span class="nf">.</span><span class="nv">sum</span><span class="w"> </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">size</span><span class="w"> </span><span class="nv">erasableGroups</span><span class="p">)</span>

<span class="w">                            </span><span class="c1">-- スコア計算: 消去数 × 連鎖ボーナス</span>
<span class="w">                            </span><span class="nv">chainBonus</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kr">case</span><span class="w"> </span><span class="nv">newChainCount</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                                    </span><span class="mi">1</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                                    </span><span class="mi">2</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">8</span>
<span class="w">                                    </span><span class="mi">3</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">16</span>
<span class="w">                                    </span><span class="mi">4</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">32</span>
<span class="w">                                    </span><span class="mi">5</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">64</span>
<span class="w">                                    </span><span class="mi">6</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">96</span>
<span class="w">                                    </span><span class="mi">7</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">128</span>
<span class="w">                                    </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">160</span>

<span class="w">                            </span><span class="nv">points</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="nv">erasedCount</span><span class="w"> </span><span class="nf">*</span><span class="w"> </span><span class="nv">chainBonus</span>

<span class="w">                            </span><span class="c1">-- すべてのグループを消去</span>
<span class="w">                            </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">List</span><span class="nf">.</span><span class="nv">foldl</span><span class="w"> </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">erasePuyos</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="nv">erasableGroups</span>
<span class="w">                        </span><span class="kr">in</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Erasing</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newChainCount</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">points</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                          </span><span class="p">}</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                        </span><span class="p">)</span>

<span class="w">                </span><span class="kt">Erasing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="c1">-- 消去アニメーション（簡略化のためすぐに落下モードへ）</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Falling</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="kt">Falling</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="c1">-- 重力適用後、再度消去判定へ</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">applyGravity</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                        </span><span class="nf">|</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Checking</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                    </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="c1">-- その他のメッセージ処理...</span>
<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>


<span class="cm">{-| ボード全体から消去可能なグループを探す</span>
<span class="cm">-}</span>
<span class="nv">findAllErasableGroups</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="p">(</span><span class="kt">Set</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">))</span>
<span class="nv">findAllErasableGroups</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">cols</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCols</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="nv">rows</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getRows</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="c1">-- すべてのセルをチェック</span>
<span class="w">        </span><span class="nv">allPositions</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">List</span><span class="nf">.</span><span class="nv">concatMap</span>
<span class="w">                </span><span class="p">(</span><span class="nf">\</span><span class="nv">y</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">x</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nv">cols</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nv">rows</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>

<span class="w">        </span><span class="c1">-- 訪問済み位置を管理</span>
<span class="w">        </span><span class="nv">findGroups</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Set</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="p">(</span><span class="kt">Set</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="p">(</span><span class="kt">Set</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">))</span>
<span class="w">        </span><span class="nv">findGroups</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="p">[]</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="nv">groups</span>

<span class="w">                </span><span class="p">(</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">::</span><span class="w"> </span><span class="nv">rest</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">member</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">findGroups</span><span class="w"> </span><span class="nv">rest</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="nv">groups</span>

<span class="w">                    </span><span class="kr">else</span>
<span class="w">                        </span><span class="kr">case</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                            </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">color</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                </span><span class="kr">let</span>
<span class="w">                                    </span><span class="nv">connected</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                        </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">findConnectedPuyos</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="nv">board</span>

<span class="w">                                    </span><span class="nv">newVisited</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                        </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">union</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="nv">connected</span>
<span class="w">                                </span><span class="kr">in</span>
<span class="w">                                </span><span class="kr">if</span><span class="w"> </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">size</span><span class="w"> </span><span class="nv">connected</span><span class="w"> </span><span class="nf">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                    </span><span class="nv">findGroups</span><span class="w"> </span><span class="nv">rest</span><span class="w"> </span><span class="nv">newVisited</span><span class="w"> </span><span class="p">(</span><span class="nv">connected</span><span class="w"> </span><span class="nf">::</span><span class="w"> </span><span class="nv">groups</span><span class="p">)</span>

<span class="w">                                </span><span class="kr">else</span>
<span class="w">                                    </span><span class="nv">findGroups</span><span class="w"> </span><span class="nv">rest</span><span class="w"> </span><span class="nv">newVisited</span><span class="w"> </span><span class="nv">groups</span>

<span class="w">                            </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                                </span><span class="nv">findGroups</span><span class="w"> </span><span class="nv">rest</span><span class="w"> </span><span class="nv">visited</span><span class="w"> </span><span class="nv">groups</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="nv">findGroups</span><span class="w"> </span><span class="nv">allPositions</span><span class="w"> </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">empty</span><span class="w"> </span><span class="p">[]</span>
</code></pre></div>
<p>「すごく長くなりましたね！」そうですね。でも、各モードでやることは明確です：</p>
<ol>
<li><strong>Playing</strong>: 自動落下、着地したら <code>Checking</code> へ</li>
<li><strong>Checking</strong>: 消去判定、消すものがあれば <code>Erasing</code> へ、なければ次のぷよ</li>
<li><strong>Erasing</strong>: 消去実行、<code>Falling</code> へ</li>
<li><strong>Falling</strong>: 重力適用、<code>Checking</code> へ（ここで連鎖ループ）</li>
</ol>
<p>「<code>Checking → Erasing → Falling → Checking</code> のループが連鎖を作っているんですね！」その通りです！消去→重力→消去判定のサイクルが、消すものがなくなるまで繰り返されます。</p>
<h3 id="view_1">View の更新<a class="headerlink" href="#view_1" title="Permanent link">&para;</a></h3>
<p>スコアと連鎖数を表示しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（view 関数の更新）</span>
<span class="nv">view</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">view</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">h1</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ - Elm 版&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;スコア: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="p">)</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot; | &quot;</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;連鎖数: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">chainCount</span><span class="p">)</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">            </span><span class="kt">Start</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">button</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">onClick</span><span class="w"> </span><span class="kt">StartGame</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ゲーム開始&quot;</span><span class="w"> </span><span class="p">]</span>

<span class="w">            </span><span class="kt">GameOver</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">                    </span><span class="p">[</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ゲームオーバー！&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;最終スコア: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="p">)</span><span class="w"> </span><span class="p">]</span>
<span class="w">                    </span><span class="p">]</span>

<span class="w">            </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">                    </span><span class="p">[</span><span class="w"> </span><span class="nv">viewBoard</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="nv">viewCurrentPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>


<span class="nv">viewBoard</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewBoard</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;display&quot;</span><span class="w"> </span><span class="s">&quot;grid&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;grid-template-columns&quot;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;repeat(&quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCols</span><span class="w"> </span><span class="nv">board</span><span class="p">)</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="s">&quot;, 30px)&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;gap&quot;</span><span class="w"> </span><span class="s">&quot;2px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;background-color&quot;</span><span class="w"> </span><span class="s">&quot;#333&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;padding&quot;</span><span class="w"> </span><span class="s">&quot;10px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;border-radius&quot;</span><span class="w"> </span><span class="s">&quot;5px&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">concatMap</span><span class="w"> </span><span class="p">(</span><span class="nv">viewRow</span><span class="w"> </span><span class="nv">board</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getRows</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>


<span class="nv">viewRow</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="p">(</span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span><span class="p">)</span>
<span class="nv">viewRow</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="p">(</span><span class="nv">viewCell</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCols</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>


<span class="nv">viewCell</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewCell</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">cellColor</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="s">&quot;#ff4444&quot;</span>

<span class="w">                </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="s">&quot;#4444ff&quot;</span>

<span class="w">                </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Green</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="s">&quot;#44ff44&quot;</span>

<span class="w">                </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Yellow</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="s">&quot;#ffff44&quot;</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="s">&quot;#222&quot;</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="nv">div</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;width&quot;</span><span class="w"> </span><span class="s">&quot;30px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;height&quot;</span><span class="w"> </span><span class="s">&quot;30px&quot;</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;background-color&quot;</span><span class="w"> </span><span class="nv">cellColor</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;border-radius&quot;</span><span class="w"> </span><span class="s">&quot;50%&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="p">[]</span>


<span class="nv">viewCurrentPair</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">viewCurrentPair</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">maybePair</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="kt">Just</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">div</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;position&quot;</span><span class="w"> </span><span class="s">&quot;absolute&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;top&quot;</span><span class="w"> </span><span class="s">&quot;50px&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;left&quot;</span><span class="w"> </span><span class="s">&quot;50px&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;Current Pair (実装中)&quot;</span><span class="w"> </span><span class="p">]</span>

<span class="w">        </span><span class="kt">Nothing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</code></pre></div>
<h3 id="_69">アプリケーションの実行<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>では、アプリケーションを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm<span class="w"> </span>reactor
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開き、<code>src/Main.elm</code> をクリックします。「ゲーム開始」ボタンをクリックして、ぷよを落としてみましょう！</p>
<p>「本当だ！連鎖が起きるとスコアが増えていきます！」おめでとうございます！連鎖反応が実装できましたね。</p>
<h3 id="7_1">イテレーション7のまとめ<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ゲームモードの拡張</strong></li>
<li><code>Checking</code>: 消去判定モード</li>
<li><code>Erasing</code>: 消去実行モード</li>
<li><code>Falling</code>: 重力適用モード</li>
<li>
<p>モード遷移による明確な状態管理</p>
</li>
<li>
<p><strong>連鎖の仕組み</strong></p>
</li>
<li><code>Checking → Erasing → Falling → Checking</code> のループ</li>
<li>消去対象がなくなるまで繰り返し</li>
<li>
<p>連鎖数のカウント</p>
</li>
<li>
<p><strong>スコア計算</strong></p>
</li>
<li>消去数 × 連鎖ボーナス</li>
<li>
<p>連鎖数に応じたボーナス倍率（1, 8, 16, 32, ...）</p>
</li>
<li>
<p><strong>全体探索</strong></p>
</li>
<li><code>findAllErasableGroups</code>: ボード全体から消去可能なグループを探索</li>
<li>
<p>訪問済み管理で重複チェックを回避</p>
</li>
<li>
<p><strong>View の更新</strong></p>
</li>
<li>スコアと連鎖数の表示</li>
<li>ボードの描画</li>
<li>ゲームオーバー画面</li>
</ol>
<h3 id="_70">学んだこと<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>状態遷移パターン</strong>: カスタム型とパターンマッチングで状態管理</li>
<li><strong>連鎖の自然な実現</strong>: 消去→重力→消去のサイクルで自動的に連鎖</li>
<li><strong>訪問済み管理</strong>: Set を使った探索の最適化</li>
<li><strong>スコア計算</strong>: 連鎖数に応じた指数的なボーナス</li>
</ul>
<p>次のイテレーションでは、全消しボーナスの実装に進みます！</p>
<h2 id="8">イテレーション8: 全消しボーナスの実装<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>「連鎖ができるようになったけど、ぷよぷよには全消しボーナスもありますよね？」そうですね！ぷよぷよには、盤面上のぷよをすべて消すと得られる「全消し（ぜんけし）ボーナス」という特別な報酬があります。今回は、その全消しボーナスを実装していきましょう！</p>
<h3 id="_71">ユーザーストーリー<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、盤面上のぷよをすべて消したときに全消しボーナスを獲得できる</p>
</blockquote>
<p>「やった！全部消えた！」という達成感と共に、特別なボーナスポイントを獲得できる機能を実装します。これにより、プレイヤーは全消しを狙った戦略を考えるようになりますね。</p>
<h3 id="todo_7">TODOリスト<a class="headerlink" href="#todo_7" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「全消しボーナスを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>全消し判定を実装する（盤面上のぷよがすべて空になったかを判定する）</li>
<li>全消しボーナスの計算を実装する（全消し時に加算するボーナス点を計算する）</li>
<li>Checking モードで全消し判定を行う</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。テスト駆動開発の流れに沿って、まずはテストから書いていきますよ。</p>
<h3 id="_72">テスト: 全消し判定<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p>まず、全消し判定の機能をテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/GameLogicTests.elm（続き）</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;GameLogic&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="c1">-- 既存のテスト...</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;isEmpty&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;盤面がすべて空なら True を返す&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">True</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;盤面にぷよがあれば False を返す&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Red</span><span class="p">)</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「このテストでは何を確認しているんですか？」このテストでは、以下の2つのケースを確認しています：</p>
<ol>
<li>盤面がすべて空の場合、<code>True</code> を返すか</li>
<li>盤面にぷよが1つでもあれば、<code>False</code> を返すか</li>
</ol>
<p>「シンプルですね！」そうです。全消し判定はシンプルな条件です。では実装しましょう。</p>
<h3 id="_73">実装: 全消し判定<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>全消し判定の機能を <code>GameLogic</code> モジュールに追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/GameLogic.elm（続き）</span>
<span class="cm">{-| 盤面がすべて空かどうかを判定する（全消し判定）</span>
<span class="cm">-}</span>
<span class="nv">isEmpty</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Bool</span>
<span class="nv">isEmpty</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">cols</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCols</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="nv">rows</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getRows</span><span class="w"> </span><span class="nv">board</span>

<span class="w">        </span><span class="c1">-- すべてのセルをチェック</span>
<span class="w">        </span><span class="nv">allPositions</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">List</span><span class="nf">.</span><span class="nv">concatMap</span>
<span class="w">                </span><span class="p">(</span><span class="nf">\</span><span class="nv">y</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">x</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nv">cols</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nv">rows</span><span class="w"> </span><span class="nf">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>

<span class="w">        </span><span class="c1">-- 1つでもFilled があれば False</span>
<span class="w">        </span><span class="nv">hasAnyPuyo</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">List</span><span class="nf">.</span><span class="nv">any</span>
<span class="w">                </span><span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">case</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">getCell</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                        </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="nv">_</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                            </span><span class="kt">True</span>

<span class="w">                        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                            </span><span class="kt">False</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">                </span><span class="nv">allPositions</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="nv">not</span><span class="w"> </span><span class="nv">hasAnyPuyo</span>
</code></pre></div>
<p>「<code>List.any</code> を使っているんですね！」そうです。<code>List.any</code> は、リストの中に条件を満たす要素が1つでもあれば <code>True</code> を返します。ここでは「Filled セルがあるか」をチェックしています。</p>
<h3 id="_74">テストの実行<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p>では、テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm-test
</code></pre></div>
<p>「やった！テストが通りました！」おめでとうございます！全消し判定が実装できましたね。</p>
<h3 id="_75">実装: 全消しボーナスの統合<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>次に、<code>Checking</code> モードで全消し判定を行い、全消しの場合はボーナスを加算するように実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（update 関数の Checking モード部分を修正）</span>
<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="c1">-- 既存の処理...</span>

<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nv">deltaTime</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="c1">-- 既存の Playing, Erasing, Falling モード...</span>

<span class="w">                </span><span class="kt">Checking</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="c1">-- 消去判定モード</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">erasableGroups</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">findAllErasableGroups</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">erasableGroups</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="c1">-- 消去なし → 全消しチェック</span>
<span class="w">                        </span><span class="kr">let</span>
<span class="w">                            </span><span class="nv">isAllClear</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>

<span class="w">                            </span><span class="nv">zenkeshiBonus</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kr">if</span><span class="w"> </span><span class="nv">isAllClear</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                    </span><span class="mi">3600</span><span class="w">  </span><span class="c1">-- 全消しボーナス</span>

<span class="w">                                </span><span class="kr">else</span>
<span class="w">                                    </span><span class="mi">0</span>
<span class="w">                        </span><span class="kr">in</span>
<span class="w">                        </span><span class="c1">-- 次のぷよを出す</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">zenkeshiBonus</span>
<span class="w">                          </span><span class="p">}</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                        </span><span class="p">)</span>

<span class="w">                    </span><span class="kr">else</span>
<span class="w">                        </span><span class="c1">-- 消去あり → 消去モードへ</span>
<span class="w">                        </span><span class="kr">let</span>
<span class="w">                            </span><span class="nv">newChainCount</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="nv">model</span><span class="nf">.</span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">                            </span><span class="nv">erasedCount</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">List</span><span class="nf">.</span><span class="nv">sum</span><span class="w"> </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">size</span><span class="w"> </span><span class="nv">erasableGroups</span><span class="p">)</span>

<span class="w">                            </span><span class="nv">chainBonus</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kr">case</span><span class="w"> </span><span class="nv">newChainCount</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                                    </span><span class="mi">1</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                                    </span><span class="mi">2</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">8</span>
<span class="w">                                    </span><span class="mi">3</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">16</span>
<span class="w">                                    </span><span class="mi">4</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">32</span>
<span class="w">                                    </span><span class="mi">5</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">64</span>
<span class="w">                                    </span><span class="mi">6</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">96</span>
<span class="w">                                    </span><span class="mi">7</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">128</span>
<span class="w">                                    </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">160</span>

<span class="w">                            </span><span class="nv">points</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="nv">erasedCount</span><span class="w"> </span><span class="nf">*</span><span class="w"> </span><span class="nv">chainBonus</span>

<span class="w">                            </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">List</span><span class="nf">.</span><span class="nv">foldl</span><span class="w"> </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">erasePuyos</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="nv">erasableGroups</span>
<span class="w">                        </span><span class="kr">in</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Erasing</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newChainCount</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">points</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                          </span><span class="p">}</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                        </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="c1">-- その他のメッセージ処理...</span>
<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>「<code>Checking</code> モードで全消しをチェックして、該当すればボーナスを加算しているんですね！」そうです！処理の流れを見てみましょう：</p>
<ol>
<li><strong>消去対象なし</strong>の場合：</li>
<li>全消し判定を行う（<code>GameLogic.isEmpty</code>）</li>
<li>全消しなら 3600 点のボーナスを加算</li>
<li>
<p>次のぷよを出して <code>Playing</code> モードへ</p>
</li>
<li>
<p><strong>消去対象あり</strong>の場合：</p>
</li>
<li>連鎖カウントを増やす</li>
<li>スコアを計算して加算</li>
<li><code>Erasing</code> モードへ</li>
</ol>
<h3 id="view_2">View の更新<a class="headerlink" href="#view_2" title="Permanent link">&para;</a></h3>
<p>全消しが発生したことを視覚的に分かりやすくするため、メッセージを表示しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（Model の拡張）</span>
<span class="kr">type</span><span class="w"> </span><span class="kr">alias</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Board</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">PuyoPair</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">GameMode</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Bool</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">message</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">String</span><span class="w">      </span><span class="c1">-- 追加: メッセージ表示用</span>
<span class="w">    </span><span class="p">}</span>


<span class="nv">init</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span>
<span class="nv">init</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Nothing</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Start</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropTimer</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">dropInterval</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">fastDropActive</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">False</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="nv">message</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w">          </span><span class="c1">-- 追加</span>
<span class="w">    </span><span class="p">}</span>


<span class="c1">-- update 関数の Checking モード部分を修正</span>
<span class="kt">Checking</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="kr">let</span>
<span class="w">        </span><span class="nv">erasableGroups</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">findAllErasableGroups</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">    </span><span class="kr">in</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">erasableGroups</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">let</span>
<span class="w">            </span><span class="nv">isAllClear</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>

<span class="w">            </span><span class="nv">zenkeshiBonus</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">isAllClear</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="mi">3600</span>

<span class="w">                </span><span class="kr">else</span>
<span class="w">                    </span><span class="mi">0</span>

<span class="w">            </span><span class="nv">message</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">isAllClear</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="s">&quot;全消し！+3600&quot;</span>

<span class="w">                </span><span class="kr">else</span>
<span class="w">                    </span><span class="s">&quot;&quot;</span>
<span class="w">        </span><span class="kr">in</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">            </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">            </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>
<span class="w">            </span><span class="nf">|</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">zenkeshiBonus</span>
<span class="w">            </span><span class="nf">|</span><span class="w"> </span><span class="nv">message</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">message</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="c1">-- 既存の処理...</span>


<span class="c1">-- view 関数でメッセージを表示</span>
<span class="nv">view</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">view</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">h1</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ - Elm 版&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;スコア: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="p">)</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot; | &quot;</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;連鎖数: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">chainCount</span><span class="p">)</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">message</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;&quot;</span>

<span class="w">          </span><span class="kr">else</span>
<span class="w">            </span><span class="nv">div</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="w"> </span><span class="s">&quot;gold&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-weight&quot;</span><span class="w"> </span><span class="s">&quot;bold&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-size&quot;</span><span class="w"> </span><span class="s">&quot;24px&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin&quot;</span><span class="w"> </span><span class="s">&quot;10px 0&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">message</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">            </span><span class="kt">Start</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">button</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">onClick</span><span class="w"> </span><span class="kt">StartGame</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ゲーム開始&quot;</span><span class="w"> </span><span class="p">]</span>

<span class="w">            </span><span class="kt">GameOver</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">                    </span><span class="p">[</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ゲームオーバー！&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;最終スコア: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="p">)</span><span class="w"> </span><span class="p">]</span>
<span class="w">                    </span><span class="p">]</span>

<span class="w">            </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">                    </span><span class="p">[</span><span class="w"> </span><span class="nv">viewBoard</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="nv">viewCurrentPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「全消しメッセージが金色で表示されるんですね！」そうです！<code>style</code> 属性で色やサイズを指定して、目立つようにしています。</p>
<h3 id="_76">アプリケーションの実行<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>では、アプリケーションを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm<span class="w"> </span>reactor
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開き、<code>src/Main.elm</code> をクリックします。盤面のぷよをすべて消してみましょう！</p>
<p>「本当だ！全消しすると『全消し！+3600』って表示されます！」おめでとうございます！全消しボーナスが実装できましたね。</p>
<h3 id="8_1">イテレーション8のまとめ<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>全消し判定</strong></li>
<li><code>GameLogic.isEmpty</code>: 盤面がすべて空かを判定</li>
<li>
<p><code>List.any</code> で Filled セルの存在をチェック</p>
</li>
<li>
<p><strong>全消しボーナス</strong></p>
</li>
<li>消去対象がない時に全消し判定</li>
<li>全消しの場合は 3600 点のボーナス</li>
<li>
<p>メッセージで全消しを通知</p>
</li>
<li>
<p><strong>View の拡張</strong></p>
</li>
<li><code>message</code> フィールドでメッセージ表示</li>
<li>
<p>全消し時は金色で目立つ表示</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>全消し判定のテスト（2テスト）</li>
</ol>
<h3 id="_77">学んだこと<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>List.any の活用</strong>: リストの中に条件を満たす要素があるかを簡潔にチェック</li>
<li><strong>条件分岐によるボーナス</strong>: if 式でボーナスの有無を切り替え</li>
<li><strong>視覚的フィードバック</strong>: style 属性で動的にスタイルを変更</li>
<li><strong>一時的なメッセージ</strong>: Model にメッセージフィールドを追加</li>
</ul>
<p>次のイテレーションでは、ゲームオーバー判定の実装に進みます！</p>
<h2 id="9">イテレーション9: ゲームオーバーの実装<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>「ゲームが終わる条件も必要ですよね？」そうですね！どんなゲームにも終わりがあります。ぷよぷよでは、新しいぷよを配置できなくなったときにゲームオーバーとなります。今回は、そのゲームオーバー判定と演出を実装していきましょう！</p>
<h3 id="_78">ユーザーストーリー<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>まずは、このイテレーションで実装するユーザーストーリーを確認しましょう：</p>
<blockquote>
<p>プレイヤーとして、ゲームオーバーになるとゲーム終了の演出を見ることができる</p>
</blockquote>
<p>「ゲームが終わったことが明確に分かるといいですね！」そうですね。ゲームの終わりが明確でないと、プレイヤーはモヤモヤした気持ちになってしまいます。</p>
<h3 id="todo_8">TODOリスト<a class="headerlink" href="#todo_8" title="Permanent link">&para;</a></h3>
<p>「どんな作業が必要になりますか？」このユーザーストーリーを実現するために、TODOリストを作成してみましょう。</p>
<p>「ゲームオーバーを実装する」という機能を実現するためには、以下のようなタスクが必要そうですね：</p>
<ul>
<li>ゲームオーバー判定を実装する（新しいぷよを配置できない状態を検出する）</li>
<li>ゲームオーバー演出を実装する（GameOver モードへの遷移）</li>
<li>リスタート機能を実装する（ゲームオーバー後に新しいゲームを始められるようにする）</li>
</ul>
<p>「なるほど、順番に実装していけばいいんですね！」そうです、一つずつ進めていきましょう。</p>
<h3 id="_79">テスト: ゲームオーバー判定<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h3>
<p>まず、新しいぷよが配置できるかどうかを判定する機能をテストしましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- tests/PuyoPairTests.elm（続き）</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Test</span>
<span class="nv">suite</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;PuyoPair&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="c1">-- 既存のテスト...</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">describe</span><span class="w"> </span><span class="s">&quot;canSpawn&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;配置位置が空なら生成可能&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">True</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;軸ぷよの位置が埋まっていたら生成不可&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="s">&quot;子ぷよの位置が埋まっていたら生成不可&quot;</span><span class="w"> </span><span class="nf">&lt;|</span>
<span class="w">                </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span>
<span class="w">                                </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Board</span><span class="nf">.</span><span class="nv">setCell</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="kt">Filled</span><span class="w"> </span><span class="kt">Blue</span><span class="p">)</span>

<span class="w">                        </span><span class="nv">pair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">pair</span><span class="w"> </span><span class="nv">board</span>
<span class="w">                        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Expect</span><span class="nf">.</span><span class="nv">equal</span><span class="w"> </span><span class="kt">False</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「既存の <code>canMove</code> 関数が使えるんですね！」そうです！新しいぷよが配置できるかどうかも、既存の <code>canMove</code> 関数で判定できます。</p>
<h3 id="_80">実装: ゲームオーバー判定<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p>次に、新しいぷよを生成しようとしたときにゲームオーバーかどうかを判定する処理を実装します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（update 関数の Checking モードを修正）</span>
<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="c1">-- 既存の処理...</span>

<span class="w">        </span><span class="kt">Tick</span><span class="w"> </span><span class="nv">deltaTime</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                </span><span class="c1">-- 既存の Playing, Erasing, Falling モード...</span>

<span class="w">                </span><span class="kt">Checking</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kr">let</span>
<span class="w">                        </span><span class="nv">erasableGroups</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                            </span><span class="nv">findAllErasableGroups</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                    </span><span class="kr">in</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">erasableGroups</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="c1">-- 消去なし → 全消しチェックして次のぷよを出す</span>
<span class="w">                        </span><span class="kr">let</span>
<span class="w">                            </span><span class="nv">isAllClear</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>

<span class="w">                            </span><span class="nv">zenkeshiBonus</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kr">if</span><span class="w"> </span><span class="nv">isAllClear</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                    </span><span class="mi">3600</span>

<span class="w">                                </span><span class="kr">else</span>
<span class="w">                                    </span><span class="mi">0</span>

<span class="w">                            </span><span class="nv">message</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kr">if</span><span class="w"> </span><span class="nv">isAllClear</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                    </span><span class="s">&quot;全消し！+3600&quot;</span>

<span class="w">                                </span><span class="kr">else</span>
<span class="w">                                    </span><span class="s">&quot;&quot;</span>

<span class="w">                            </span><span class="c1">-- 新しいぷよを生成</span>
<span class="w">                            </span><span class="nv">newPair</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">create</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kt">Red</span><span class="w"> </span><span class="kt">Blue</span>

<span class="w">                            </span><span class="c1">-- 配置可能かチェック</span>
<span class="w">                            </span><span class="nv">canSpawn</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">PuyoPair</span><span class="nf">.</span><span class="nv">canMove</span><span class="w"> </span><span class="nv">newPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                        </span><span class="kr">in</span>
<span class="w">                        </span><span class="kr">if</span><span class="w"> </span><span class="nv">canSpawn</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                            </span><span class="c1">-- 配置可能 → 通常のゲーム続行</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Playing</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">currentPair</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="nv">newPair</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">zenkeshiBonus</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">message</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">message</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                            </span><span class="p">)</span>

<span class="w">                        </span><span class="kr">else</span>
<span class="w">                            </span><span class="c1">-- 配置不可 → ゲームオーバー</span>
<span class="w">                            </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">GameOver</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">zenkeshiBonus</span>
<span class="w">                                </span><span class="nf">|</span><span class="w"> </span><span class="nv">message</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="s">&quot;ゲームオーバー！&quot;</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                            </span><span class="p">)</span>

<span class="w">                    </span><span class="kr">else</span>
<span class="w">                        </span><span class="c1">-- 既存の消去処理...</span>
<span class="w">                        </span><span class="kr">let</span>
<span class="w">                            </span><span class="nv">newChainCount</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="nv">model</span><span class="nf">.</span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">                            </span><span class="nv">erasedCount</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">List</span><span class="nf">.</span><span class="nv">sum</span><span class="w"> </span><span class="p">(</span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="kt">Set</span><span class="nf">.</span><span class="nv">size</span><span class="w"> </span><span class="nv">erasableGroups</span><span class="p">)</span>

<span class="w">                            </span><span class="nv">chainBonus</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kr">case</span><span class="w"> </span><span class="nv">newChainCount</span><span class="w"> </span><span class="kr">of</span>
<span class="w">                                    </span><span class="mi">1</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                                    </span><span class="mi">2</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">8</span>
<span class="w">                                    </span><span class="mi">3</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">16</span>
<span class="w">                                    </span><span class="mi">4</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">32</span>
<span class="w">                                    </span><span class="mi">5</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">64</span>
<span class="w">                                    </span><span class="mi">6</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">96</span>
<span class="w">                                    </span><span class="mi">7</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">128</span>
<span class="w">                                    </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="mi">160</span>

<span class="w">                            </span><span class="nv">points</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="nv">erasedCount</span><span class="w"> </span><span class="nf">*</span><span class="w"> </span><span class="nv">chainBonus</span>

<span class="w">                            </span><span class="nv">newBoard</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                                </span><span class="kt">List</span><span class="nf">.</span><span class="nv">foldl</span><span class="w"> </span><span class="kt">GameLogic</span><span class="nf">.</span><span class="nv">erasePuyos</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span><span class="w"> </span><span class="nv">erasableGroups</span>
<span class="w">                        </span><span class="kr">in</span>
<span class="w">                        </span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">model</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Erasing</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">chainCount</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newChainCount</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">points</span>
<span class="w">                            </span><span class="nf">|</span><span class="w"> </span><span class="nv">board</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">newBoard</span>
<span class="w">                          </span><span class="p">}</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span>
<span class="w">                        </span><span class="p">)</span>

<span class="w">                </span><span class="kt">GameOver</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="c1">-- ゲームオーバー時は何もしない</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">                </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="c1">-- その他のメッセージ処理...</span>
<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>「新しいぷよを生成する前に <code>canMove</code> でチェックして、配置できなければゲームオーバーになるんですね！」その通りです！</p>
<h3 id="_81">実装: リスタート機能<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー後に新しいゲームを始められるようにリスタート機能を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（Msg と update の拡張）</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Msg</span>
<span class="w">    </span><span class="nf">=</span><span class="w"> </span><span class="kt">StartGame</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">KeyPressed</span><span class="w"> </span><span class="kt">String</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Tick</span><span class="w"> </span><span class="kt">Float</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">Restart</span><span class="w">      </span><span class="c1">-- 追加</span>
<span class="w">    </span><span class="nf">|</span><span class="w"> </span><span class="kt">NoOp</span>


<span class="nv">update</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="w"> </span><span class="p">)</span>
<span class="nv">update</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">of</span>
<span class="w">        </span><span class="c1">-- 既存の処理...</span>

<span class="w">        </span><span class="kt">Restart</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="c1">-- ゲームを初期状態にリセット</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">init</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="nv">model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="nf">.</span><span class="nv">none</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<h3 id="view_3">View の更新<a class="headerlink" href="#view_3" title="Permanent link">&para;</a></h3>
<p>ゲームオーバー画面を表示し、リスタートボタンを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- src/Main.elm（view 関数の GameOver 部分を更新）</span>
<span class="nv">view</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Model</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="kt">Msg</span>
<span class="nv">view</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="nv">h1</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ぷよぷよ - Elm 版&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;スコア: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="p">)</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot; | &quot;</span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;連鎖数: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">chainCount</span><span class="p">)</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">message</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;&quot;</span>

<span class="w">          </span><span class="kr">else</span>
<span class="w">            </span><span class="nv">div</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="w"> </span><span class="s">&quot;gold&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-weight&quot;</span><span class="w"> </span><span class="s">&quot;bold&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-size&quot;</span><span class="w"> </span><span class="s">&quot;24px&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin&quot;</span><span class="w"> </span><span class="s">&quot;10px 0&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">message</span><span class="w"> </span><span class="p">]</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">mode</span><span class="w"> </span><span class="kr">of</span>
<span class="w">            </span><span class="kt">Start</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">button</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">onClick</span><span class="w"> </span><span class="kt">StartGame</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ゲーム開始&quot;</span><span class="w"> </span><span class="p">]</span>

<span class="w">            </span><span class="kt">GameOver</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">                    </span><span class="p">[</span><span class="w"> </span><span class="nv">div</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-weight&quot;</span><span class="w"> </span><span class="s">&quot;bold&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-size&quot;</span><span class="w"> </span><span class="s">&quot;32px&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin&quot;</span><span class="w"> </span><span class="s">&quot;20px 0&quot;</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;ゲームオーバー！&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="nv">div</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-size&quot;</span><span class="w"> </span><span class="s">&quot;24px&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin&quot;</span><span class="w"> </span><span class="s">&quot;10px 0&quot;</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;最終スコア: &quot;</span><span class="w"> </span><span class="nf">++</span><span class="w"> </span><span class="kt">String</span><span class="nf">.</span><span class="nv">fromInt</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">score</span><span class="p">)</span><span class="w"> </span><span class="p">]</span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="nv">button</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nv">onClick</span><span class="w"> </span><span class="kt">Restart</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;font-size&quot;</span><span class="w"> </span><span class="s">&quot;18px&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;padding&quot;</span><span class="w"> </span><span class="s">&quot;10px 20px&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;margin-top&quot;</span><span class="w"> </span><span class="s">&quot;20px&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="nv">style</span><span class="w"> </span><span class="s">&quot;cursor&quot;</span><span class="w"> </span><span class="s">&quot;pointer&quot;</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                        </span><span class="p">[</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="s">&quot;もう一度遊ぶ&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">                    </span><span class="p">]</span>

<span class="w">            </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">div</span><span class="w"> </span><span class="p">[]</span>
<span class="w">                    </span><span class="p">[</span><span class="w"> </span><span class="nv">viewBoard</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">board</span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="nv">viewCurrentPair</span><span class="w"> </span><span class="nv">model</span><span class="nf">.</span><span class="nv">currentPair</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
</code></pre></div>
<p>「ゲームオーバー画面に『もう一度遊ぶ』ボタンが表示されるんですね！」そうです！ボタンをクリックすると、<code>Restart</code> メッセージが送られて、ゲームが初期状態にリセットされます。</p>
<h3 id="_82">アプリケーションの実行<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>では、アプリケーションを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>elm<span class="w"> </span>reactor
</code></pre></div>
<p>ブラウザで <code>http://localhost:8000</code> を開き、<code>src/Main.elm</code> をクリックします。わざとぷよを積み上げてゲームオーバーにしてみましょう！</p>
<p>「本当だ！新しいぷよが出せなくなるとゲームオーバーになります！」おめでとうございます！ゲームオーバー機能が実装できましたね。</p>
<h3 id="9_1">イテレーション9のまとめ<a class="headerlink" href="#9_1" title="Permanent link">&para;</a></h3>
<p>このイテレーションで実装した内容：</p>
<ol>
<li><strong>ゲームオーバー判定</strong></li>
<li>新しいぷよの配置位置に既にぷよがあるかチェック</li>
<li><code>canMove</code> 関数を再利用</li>
<li>
<p>配置不可なら GameOver モードへ遷移</p>
</li>
<li>
<p><strong>ゲームオーバー演出</strong></p>
</li>
<li>GameOver モード時の専用画面</li>
<li>最終スコアの表示</li>
<li>
<p>赤字で目立つメッセージ</p>
</li>
<li>
<p><strong>リスタート機能</strong></p>
</li>
<li><code>Restart</code> メッセージで初期状態に戻す</li>
<li>「もう一度遊ぶ」ボタン</li>
<li>
<p>init 関数を再利用</p>
</li>
<li>
<p><strong>テストの作成</strong></p>
</li>
<li>配置可能判定のテスト（3テスト）</li>
</ol>
<h3 id="_83">学んだこと<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>既存関数の再利用</strong>: <code>canMove</code> を生成判定にも活用</li>
<li><strong>状態遷移の完成</strong>: Start → Playing → Checking → Erasing → Falling → GameOver</li>
<li><strong>init の再利用</strong>: リスタート時に init を呼び出すだけでリセット完了</li>
<li><strong>視覚的な差別化</strong>: ゲームオーバー時は赤字、全消しは金色など状態ごとに色を変える</li>
</ul>
<h2 id="_84">まとめ<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h2>
<p>このチュートリアルでは、Elm でぷよぷよゲームを作りながら、テスト駆動開発（TDD）の実践方法を学びました。</p>
<h3 id="elm_3">Elm で学んだこと<a class="headerlink" href="#elm_3" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>型システムの力</strong></li>
<li>カスタム型による明確な状態表現（GameMode, Cell, PuyoColor）</li>
<li>Maybe 型で null エラーを完全に回避</li>
<li>
<p>コンパイラによる網羅性チェック（パターンマッチング）</p>
</li>
<li>
<p><strong>The Elm Architecture</strong></p>
</li>
<li>Model - Update - View の明確な分離</li>
<li>単方向データフロー</li>
<li>
<p>Subscription による宣言的な副作用管理（キーボード、タイマー）</p>
</li>
<li>
<p><strong>関数型プログラミング</strong></p>
</li>
<li>不変性によるバグの削減</li>
<li>パターンマッチングによる分岐の明確化</li>
<li>パイプライン演算子 <code>|&gt;</code> による処理の連鎖</li>
<li>
<p>再帰による深さ優先探索（DFS）</p>
</li>
<li>
<p><strong>テスト駆動開発</strong></p>
</li>
<li>Red-Green-Refactor サイクル</li>
<li>小さなステップでの着実な進歩</li>
<li>テストによる安全なリファクタリング</li>
<li>elm-test による型安全なテスト</li>
</ol>
<h3 id="elm_4">Elm の利点<a class="headerlink" href="#elm_4" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ランタイムエラーがない</strong>: Elm の型システムは、null、undefined、型エラーを完全に排除します</li>
<li><strong>親切なコンパイラ</strong>: エラーメッセージが非常に親切で、初心者でも理解しやすい</li>
<li><strong>保守しやすいコード</strong>: 不変性と型システムにより、コードが予測可能で理解しやすい</li>
<li><strong>予測可能な振る舞い</strong>: 副作用が制御されているため、デバッグが容易</li>
<li><strong>小さなバンドルサイズ</strong>: 最適化されたJavaScriptコードを生成</li>
</ul>
<h3 id="typescriptf">TypeScript/F# との比較<a class="headerlink" href="#typescriptf" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>特徴</th>
<th>TypeScript</th>
<th>F# (Bolero)</th>
<th>Elm</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>型安全性</strong></td>
<td>任意（strict モード推奨）</td>
<td>強力</td>
<td>最強（ランタイムエラーなし）</td>
</tr>
<tr>
<td><strong>学習曲線</strong></td>
<td>緩やか（JS 経験者）</td>
<td>中程度</td>
<td>緩やか</td>
</tr>
<tr>
<td><strong>エコシステム</strong></td>
<td>非常に豊富</td>
<td>.NET エコシステム</td>
<td>限定的だが高品質</td>
</tr>
<tr>
<td><strong>バンドルサイズ</strong></td>
<td>中程度</td>
<td>大きい</td>
<td>非常に小さい</td>
</tr>
<tr>
<td><strong>開発体験</strong></td>
<td>良好</td>
<td>良好</td>
<td>優れている</td>
</tr>
<tr>
<td><strong>エラーメッセージ</strong></td>
<td>良好</td>
<td>良好</td>
<td>非常に親切</td>
</tr>
<tr>
<td><strong>副作用管理</strong></td>
<td>開発者任せ</td>
<td>Elmish で管理</td>
<td>完全に制御</td>
</tr>
</tbody>
</table>
<h3 id="_85">実装したイテレーション一覧<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>イテレーション0</strong>: 環境構築と The Elm Architecture の基礎</li>
<li><strong>イテレーション1</strong>: ゲーム開始とドメインモデルの実装</li>
<li><strong>イテレーション2</strong>: キーボード入力とぷよの移動</li>
<li><strong>イテレーション3</strong>: 回転と壁キック</li>
<li><strong>イテレーション4</strong>: 自由落下と着地判定</li>
<li><strong>イテレーション5</strong>: 高速落下（下矢印キー）</li>
<li><strong>イテレーション6</strong>: ぷよの消去（深さ優先探索）</li>
<li><strong>イテレーション7</strong>: 連鎖反応とスコア計算</li>
<li><strong>イテレーション8</strong>: 全消しボーナス</li>
<li><strong>イテレーション9</strong>: ゲームオーバーとリスタート</li>
</ul>
<h3 id="_86">次のステップ<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>このチュートリアルで基礎を学んだ後、以下のような拡張を試してみましょう：</p>
<ol>
<li><strong>難易度調整</strong></li>
<li>落下速度の段階的な増加</li>
<li>色数の増加（5色、6色）</li>
<li>
<p>レベルシステムの導入</p>
</li>
<li>
<p><strong>アニメーション</strong></p>
</li>
<li>ぷよの消去アニメーション（CSS Transitions/Animations）</li>
<li>連鎖時のエフェクト</li>
<li>
<p>ぷよの落下時のスムーズな移動</p>
</li>
<li>
<p><strong>サウンド</strong></p>
</li>
<li>効果音の追加（Web Audio API）</li>
<li>BGM の実装</li>
<li>
<p>連鎖数に応じた効果音の変化</p>
</li>
<li>
<p><strong>AI 対戦</strong></p>
</li>
<li>シンプルな AI の実装</li>
<li>ミニマックス法などの探索アルゴリズム</li>
<li>
<p>難易度調整</p>
</li>
<li>
<p><strong>データ永続化</strong></p>
</li>
<li>ハイスコアの保存（LocalStorage, Ports）</li>
<li>ゲーム途中のセーブ機能</li>
<li>リプレイ機能</li>
</ol>
<h3 id="_87">テスト駆動開発の価値<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h3>
<blockquote>
<p>テストを書きながら開発することによって、設計が良い方向に変わり、コードが改善され続け、それによって自分自身が開発に前向きになること、それがテスト駆動開発の目指すゴールです。</p>
<p>— Kent Beck 『テスト駆動開発』 付録C　訳者解説：テスト駆動開発の現在</p>
</blockquote>
<p>このチュートリアルを通じて、以下を体験できたはずです：</p>
<ul>
<li><strong>小さなステップ</strong>: TODOリストで作業を分解し、一つずつ確実に進める</li>
<li><strong>安全なリファクタリング</strong>: テストがあるから、自信を持ってコードを改善できる</li>
<li><strong>設計の改善</strong>: テストしやすいコードは、自然と良い設計になる</li>
<li><strong>開発の楽しさ</strong>: テストが通る瞬間の達成感</li>
</ul>
<h3 id="elm-tdd">Elm と TDD の相乗効果<a class="headerlink" href="#elm-tdd" title="Permanent link">&para;</a></h3>
<p>Elm とテスト駆動開発の組み合わせは、初心者にも優しく、それでいて強力です：</p>
<ul>
<li><strong>型システムがテストの一部を担う</strong>: null チェックや型エラーのテストは不要</li>
<li><strong>コンパイラが最初の品質保証</strong>: コンパイルが通れば、多くのバグが既に排除されている</li>
<li><strong>重要なロジックに集中</strong>: ビジネスロジックのテストに集中できる</li>
<li><strong>リファクタリングが安全</strong>: 型とテストの二重保護</li>
</ul>
<h3 id="_88">結びに<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h3>
<p>Elm は、「ランタイムエラーのない」という大胆な約束を守る、数少ない言語の一つです。型システムと The Elm Architecture の組み合わせにより、堅牢で保守しやすいフロントエンドアプリケーションを構築できます。</p>
<p>テスト駆動開発と組み合わせることで、さらに高い品質のソフトウェアを、自信を持って開発できるようになります。</p>
<p>ぜひ、学んだ知識を活かして、自分だけのアプリケーションを作ってみてください。Elm の世界へようこそ！</p>
<h2 id="_89">参考資料<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h2>
<h3 id="elm_5">Elm 公式リソース<a class="headerlink" href="#elm_5" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Elm 公式ガイド</strong>: https://guide.elm-lang.org/</li>
<li><strong>Elm パッケージ</strong>: https://package.elm-lang.org/</li>
<li><strong>elm-test ドキュメント</strong>: https://package.elm-lang.org/packages/elm-explorations/test/latest/</li>
<li><strong>Elm Discourse</strong>: https://discourse.elm-lang.org/</li>
</ul>
<h3 id="_90">テスト駆動開発<a class="headerlink" href="#_90" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>テスト駆動開発</strong>: Kent Beck 著</li>
<li><strong>リーダブルコード</strong>: Dustin Boswell, Trevor Foucher 著</li>
<li><strong>Clean Code</strong>: Robert C. Martin 著</li>
</ul>
<h3 id="_91">ゲーム開発<a class="headerlink" href="#_91" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ゲームプログラミングパターン</strong>: Robert Nystrom 著</li>
<li><strong>Game Programming Patterns</strong>: https://gameprogrammingpatterns.com/</li>
</ul>
<p>Happy Coding! 🎉</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>